This file is a merged representation of the entire codebase, combined into a single document by Repomix.
The content has been processed where security check has been disabled.

# File Summary

## Purpose
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Multiple file entries, each consisting of:
  a. A header with the file path (## File: path/to/file)
  b. The full contents of the file in a code block

## Usage Guidelines
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Security check has been disabled - content may contain sensitive information
- Files are sorted by Git change count (files with more changes are at the bottom)

## Additional Info

# Directory Structure
```
.cursor/
  rules/
    workflow-rule.mdc
memory_bank/
  long_term.md
  wf_bhyt_bien_lai_dien_tu.md
  wf_bien_lai_dien_tu.md
  wf_chinh_so_bien_lai.md
  wf_filter_lich_su_ke_khai.md
  wf_fix_auto_dien_tu_receipt.md
  wf_remove_nguoi_thu_field.md
  wf_update_electronic_receipt.md
WebApp.Client/
  .vscode/
    extensions.json
    launch.json
    tasks.json
  src/
    app/
      bien-lai/
        bang-ke-bien-lai/
          bang-ke-bien-lai.component.html
          bang-ke-bien-lai.component.scss
          bang-ke-bien-lai.component.ts
        bao-cao-bien-lai/
          bao-cao-bien-lai.component.html
          bao-cao-bien-lai.component.scss
          bao-cao-bien-lai.component.ts
        bien-lai-dien-tu/
          quan-ly-bien-lai-dien-tu/
            quan-ly-bien-lai-dien-tu.component.html
            quan-ly-bien-lai-dien-tu.component.scss
            quan-ly-bien-lai-dien-tu.component.ts
          bien-lai-dien-tu.module.ts
        cap-phat-bien-lai/
          cap-phat-bien-lai.component.ts
        danh-sach-bien-lai/
          danh-sach-bien-lai.component.ts
        models/
          bien-lai-dien-tu.model.ts
          quyen-bien-lai.model.ts
        quyen-bien-lai/
          chi-tiet-quyen-bien-lai/
            chi-tiet-quyen-bien-lai.component.html
            chi-tiet-quyen-bien-lai.component.scss
            chi-tiet-quyen-bien-lai.component.ts
          quyen-bien-lai.component.html
          quyen-bien-lai.component.scss
          quyen-bien-lai.component.ts
        quyen-bien-lai-dien-tu/
          quyen-bien-lai-dien-tu.component.html
          quyen-bien-lai-dien-tu.component.scss
          quyen-bien-lai-dien-tu.component.ts
        thong-ke-bien-lai/
          thong-ke-bien-lai.component.ts
      dai-ly/
        dai-ly.component.ts
      dashboard/
        dashboard.component.html
        dashboard.component.scss
        dashboard.component.spec.ts
        dashboard.component.ts
      guards/
        admin.guard.ts
      interceptors/
        api-token.interceptor.ts
        auth.interceptor.ts
      ke-khai/
        admin-danh-sach-ke-khai/
          admin-danh-sach-ke-khai.component.html
          admin-danh-sach-ke-khai.component.scss
          admin-danh-sach-ke-khai.component.ts
        don-vi/
          don-vi.component.html
          don-vi.component.scss
          don-vi.component.ts
        dot-ke-khai/
          thanh-toan-modal/
            thanh-toan-modal.component.scss
            thanh-toan-modal.component.ts
          upload-bill-modal/
            upload-bill-modal.component.ts
          dot-ke-khai.component.html
          dot-ke-khai.component.scss
          dot-ke-khai.component.ts
        ke-khai-bhxh/
          ke-khai-bhxh.component.html
          ke-khai-bhxh.component.scss
          ke-khai-bhxh.component.ts
        ke-khai-bhyt/
          ke-khai-bhyt.component.html
          ke-khai-bhyt.component.scss
          ke-khai-bhyt.component.ts
        lich-su-ke-khai/
          lich-su-ke-khai.component.html
          lich-su-ke-khai.component.scss
          lich-su-ke-khai.component.ts
        quet-cccd/
          quet-cccd.component.html
          quet-cccd.component.scss
          quet-cccd.component.ts
      layout/
        main-layout/
          main-layout.component.html
          main-layout.component.scss
          main-layout.component.spec.ts
          main-layout.component.ts
      login/
        login.component.html
        login.component.scss
        login.component.ts
      services/
        auth.service.ts
        bien-lai-dien-tu.service.ts
        bien-lai.service.ts
        cccd.service.ts
        cloudinary.service.ts
        dai-ly-don-vi.service.ts
        dai-ly.service.ts
        dia-chi.service.ts
        don-vi.service.ts
        dot-ke-khai.service.ts
        export-vnpt.service.ts
        hoa-don-thanh-toan.service.ts
        ip.service.ts
        ke-khai-bhxh.service.ts
        ke-khai-bhyt.service.ts
        lich-su-ke-khai.service.ts
        location.service.ts
        quyen-bien-lai.service.ts
        ssmv2.service.ts
        tra-cuu-ma-so-bhxh.service.ts
        tra-cuu-thong-tin-bhyt.service.ts
        user.service.ts
        users.service.ts
        viet-qr.service.ts
      shared/
        components/
          xem-hoa-don-modal/
            xem-hoa-don-modal.component.html
            xem-hoa-don-modal.component.scss
            xem-hoa-don-modal.component.ts
      statistics/
        statistics.component.html
        statistics.component.scss
        statistics.component.spec.ts
        statistics.component.ts
      tra-cuu/
        tra-cuu-ho-gia-dinh/
          tra-cuu-ho-gia-dinh.component.html
          tra-cuu-ho-gia-dinh.component.spec.ts
          tra-cuu-ho-gia-dinh.component.ts
        tra-cuu-ma-so-bhxh/
          tra-cuu-ma-so-bhxh.component.html
          tra-cuu-ma-so-bhxh.component.scss
          tra-cuu-ma-so-bhxh.component.ts
        tra-cuu-thong-tin-bhxh/
          tra-cuu-thong-tin-bhxh.component.html
          tra-cuu-thong-tin-bhxh.component.scss
          tra-cuu-thong-tin-bhxh.component.ts
        tra-cuu-thong-tin-bhyt/
          tra-cuu-thong-tin-bhyt.component.html
          tra-cuu-thong-tin-bhyt.component.scss
          tra-cuu-thong-tin-bhyt.component.ts
        tra-cuu.routes.ts
      users/
        users.component.html
        users.component.scss
        users.component.spec.ts
        users.component.ts
      app.component.html
      app.component.spec.ts
      app.component.ts
      app.config.ts
      app.module.ts
      app.routes.ts
      icons-provider.ts
    environments/
      environment.prod.ts
      environment.ts
    styles/
      README.md
      variables.scss
    index.html
    main.ts
    styles.scss
  .editorconfig
  .gitignore
  .vercelignore
  README.md
WebApp.Server/
  Controllers/
    AuthController.cs
    BangKeBienLaiController.cs
    BienLaiDienTuController.cs
    DaiLyController.cs
    DaiLyDonViController.cs
    DanhMucCSKCBController.cs
    DanhMucHuyenController.cs
    DanhMucXaController.cs
    DmTinhController.cs
    DonViController.cs
    DotKeKhaiController.cs
    HoaDonThanhToanController.cs
    IpController.cs
    KeKhaiBHXHController.cs
    KeKhaiBHYTController.cs
    LichSuKeKhaiController.cs
    LocationsController.cs
    NguoiDungController.cs
    ProvinceController.cs
    QuyenBienLaiController.cs
    QuyenBienLaiDienTuController.cs
    TestController.cs
    ThongTinTheController.cs
    UsersController.cs
  Data/
    ApplicationDbContext.cs
  DTOs/
    LoginDto.cs
  Migrations/
    [Timestamp]_AddDaiLyIdToDonVi.cs
    [Timestamp]_AddTrangThaiToDonVi.cs
  Models/
    BienlaiDienTu/
      BienLaiDienTu.cs
      QuyenBienLaiDienTu.cs
    BienLai.cs
    DaiLy.cs
    DaiLyDonVi.cs
    DanhMucCSKCB.cs
    DanhMucHuyen.cs
    DanhMucTinh.cs
    DanhMucXa.cs
    DonVi.cs
    DotKeKhai.cs
    HoaDonThanhToan.cs
    KeKhaiBHXH.cs
    KeKhaiBHYT.cs
    LoginModel.cs
    NguoiDung.cs
    PaymentBill.cs
    QuyenBienLai.cs
    ThongTinThe.cs
    User.cs
  Program.cs
  WebApp.API.csproj
  WebApp.API.http
.gitignore
.windsurfrules
build.bat
dot-ke-khai.md
ke-khai-bhxh-flow.md
setup-and-run.bat
WebApp.sln
```

# Files

## File: .cursor/rules/workflow-rule.mdc
````
---
description: 
globs: 
alwaysApply: true
---
- When user starts a new conversation:
  1. Read [long_term.md](mdc:memory_bank/long_term.md) to get the context of the project.
  2. Generate a workflow name (under 10 words, snake case).
  3. Then, create file `memory_bank/wf_{workflow_name}`. The content must have the following sections:
   - Current tasks from user prompt.
   - Plan (simple): your plan & thoughts to solve task(s).
   - Steps: break your plan into small steps.
   - Things done
   - Things not done yet
- In a cycle of current conversation:
  1. Read current `memory_bank/wf_{workflow_name}` file. Don't be lazy, don't omit any content.
  2. Update plan and steps if needed, based on the current state.
  3. After you finish a task, update `Things done` and `Things not done yet` to track your work.
````

## File: memory_bank/long_term.md
````markdown
# Long Term Memory - Dự án BHXH

## Mục tiêu dự án
- Xây dựng ứng dụng quản lý bảo hiểm xã hội với các chức năng như kê khai BHXH, quản lý đợt kê khai, thanh toán và quản lý người dùng.
- Hỗ trợ các đại lý thu BHXH quản lý hồ sơ và theo dõi thanh toán.
- Cung cấp giao diện trực quan và dễ sử dụng cho người dùng.

## Công nghệ sử dụng

### Frontend
- Angular 19.1.0
- ng-zorro-antd 19.0.2 (UI framework)
- RxJS 7.8.0
- TypeScript 5.7.2
- Các thư viện bổ sung:
  - @auth0/angular-jwt: Xử lý JWT
  - file-saver: Xuất và tải file
  - xlsx: Xử lý file Excel
  - jspdf & jspdf-autotable: Xuất PDF
  - docxtemplater, pizzip, jszip: Xử lý file Word và nén

### Backend
- ASP.NET Core 9.0 (API)
- Entity Framework Core với Npgsql (PostgreSQL)
- JWT Authentication
- EPPlus: Xử lý Excel
- BCrypt.Net: Mã hóa mật khẩu

### Database
- PostgreSQL (thông qua Npgsql)

## Kiến trúc dự án

### Cấu trúc thư mục
- WebApp.Client: Chứa ứng dụng Angular
- WebApp.Server: Chứa API ASP.NET Core
- database: Chứa scripts và cấu hình database
- memory_bank: Lưu trữ thông tin dự án
- Sreenshots: Ảnh chụp màn hình

### WebApp.Server
- Controllers: Xử lý API endpoints
- Data: ApplicationDbContext và cấu hình
- DTOs: Data Transfer Objects
- Models: Mô hình dữ liệu
- Repositories: Truy xuất dữ liệu
- Services: Logic nghiệp vụ
- Migrations: Quản lý cập nhật database
- Program.cs: Cấu hình ứng dụng

### WebApp.Client (Angular)
- Cấu trúc chuẩn Angular với components, services, models

## Các module chính

### 1. Quản lý đợt kê khai
- Hiển thị danh sách đợt kê khai với thông tin chi tiết
- Lọc theo trạng thái: Chưa gửi, Chờ thanh toán, Hoàn thành, Từ chối
- Thống kê số liệu tổng quan
- Quản lý quy trình xử lý đợt kê khai (từ tạo đến hoàn thành)
- Thanh toán và quản lý hóa đơn

### 2. Kê khai BHXH/BHYT
- Tìm kiếm thông tin BHXH từ hệ thống SSMV2
- Quản lý thông tin cá nhân (họ tên, CCCD, ngày sinh, địa chỉ...)
- Tính toán số tiền phải đóng
- Quản lý biên lai thu tiền
- Xử lý thông tin địa chỉ (tỉnh, huyện, xã)

## Mô hình dữ liệu chính

### Đợt kê khai (DotKeKhai)
- Thông tin cơ bản: id, tên, số đợt, tháng, năm
- Thông tin trạng thái: trạng thái, ghi chú
- Thông tin tham chiếu: đơn vị, đại lý, người tạo
- Thông tin thanh toán: tổng số thẻ, tổng số tiền, URL hóa đơn

### Kê khai BHYT
- Thông tin cá nhân: họ tên, CCCD, ngày sinh, giới tính, địa chỉ
- Thông tin BHXH: số thẻ BHYT, mã số BHXH, phương án đóng
- Thông tin tài chính: số tiền, ngày biên lai, số biên lai
- Thông tin địa chỉ: mã tỉnh, huyện, xã

### Quyển biên lai
- Thông tin biên lai: quyển số, từ số, đến số, số hiện tại
- Thông tin quản lý: nhân viên thu, người cấp, ngày cấp, trạng thái

## Quy trình làm việc

### Quy trình đợt kê khai
1. Tạo đợt kê khai mới
2. Gửi đợt kê khai để xử lý
3. Thanh toán (tạo mã QR, upload hóa đơn)
4. Hoàn thành hoặc từ chối

### Quy trình kê khai BHXH
1. Tìm kiếm thông tin BHXH (có thể yêu cầu đăng nhập SSMV2)
2. Điền thông tin cá nhân và BHXH
3. Tính toán số tiền phải đóng
4. Lưu thông tin kê khai

## Công nghệ thanh toán
- Tạo mã QR thanh toán liên kết với ngân hàng (VietQR API)
- Lưu trữ hình ảnh hóa đơn (Cloudinary)

## Conventions
- Sử dụng chuẩn đặt tên snake_case cho các trường trong database
- Sử dụng camelCase cho các biến và thuộc tính trong code
- Sử dụng PascalCase cho các lớp và components
- Sử dụng JWT cho xác thực API
- Sử dụng ng-zorro-antd cho UI components

## Các điểm cần cải thiện
1. Tối ưu hiệu suất khi tải danh sách địa chỉ lớn
2. Cải thiện UX khi tìm kiếm và điền thông tin BHXH
3. Tăng cường xác thực dữ liệu nhập
4. Thêm tính năng xuất báo cáo
````

## File: memory_bank/wf_bhyt_bien_lai_dien_tu.md
````markdown
## Current tasks from user prompt
- Tìm hiểu cách xác định đợt kê khai BHYT có sử dụng biên lai điện tử hay không khi bấm nút gửi
- Chỉnh sửa để chỉ kiểm tra thuộc tính is_bien_lai_dien_tu thay vì cả is_bien_lai_dien_tu và bien_lai_dien_tu
- Tạo SQL xóa cột bien_lai_dien_tu khỏi bảng dot_ke_khai
- Cập nhật chức năng thêm mới đợt kê khai để sử dụng is_bien_lai_dien_tu

## Plan (simple)
1. Nghiên cứu component kê khai BHYT để hiểu quy trình gửi kê khai
2. Tìm hiểu về cấu trúc dữ liệu của đợt kê khai và biên lai
3. Xác định cách hệ thống quyết định sử dụng biên lai điện tử
4. Tìm kiếm các thông số hoặc cờ đánh dấu liên quan đến biên lai điện tử
5. Chỉnh sửa code để chỉ kiểm tra thuộc tính is_bien_lai_dien_tu
6. Triển khai thay đổi vào code thực tế
7. Tạo SQL để xóa cột bien_lai_dien_tu không cần thiết
8. Cập nhật chức năng thêm mới đợt kê khai để sử dụng is_bien_lai_dien_tu

## Steps
1. Kiểm tra file ke-khai-bhyt.component.ts để hiểu quy trình gửi kê khai
2. Tìm kiếm các phương thức liên quan đến việc gửi kê khai và xử lý biên lai
3. Kiểm tra các model và service liên quan đến biên lai và đợt kê khai
4. Xác định logic xử lý biên lai điện tử trong hệ thống
5. Hướng dẫn chỉnh sửa phương thức loadDotKeKhai() để chỉ kiểm tra is_bien_lai_dien_tu
6. Triển khai thay đổi bằng cách sử dụng PowerShell để chỉnh sửa file
7. Tìm kiếm thông tin về bảng dot_ke_khai và cột bien_lai_dien_tu
8. Tạo SQL để xóa cột bien_lai_dien_tu
9. Tìm kiếm và cập nhật interface CreateDotKeKhai để sử dụng is_bien_lai_dien_tu
10. Cập nhật component DotKeKhaiComponent để sử dụng is_bien_lai_dien_tu trong form và phương thức submitForm

## Things done
- Đọc file long_term.md để hiểu về dự án
- Phân tích component kê khai BHYT
- Tìm hiểu về cách xác định biên lai điện tử
- Tìm ra cách kiểm tra đợt kê khai có sử dụng biên lai điện tử hay không
- Hướng dẫn chỉnh sửa code để chỉ kiểm tra thuộc tính is_bien_lai_dien_tu
- Triển khai thay đổi vào code thực tế bằng PowerShell
- Kiểm tra lại để đảm bảo thay đổi đã được áp dụng đúng
- Tìm kiếm thông tin về bảng dot_ke_khai trong model DotKeKhai.cs
- Tạo file SQL (database/remove_bien_lai_dien_tu.sql) để xóa cột bien_lai_dien_tu
- Cập nhật interface CreateDotKeKhai để sử dụng is_bien_lai_dien_tu
- Cập nhật component DotKeKhaiComponent để sử dụng is_bien_lai_dien_tu trong form và phương thức submitForm

## Things not done yet
- Không còn tác vụ nào chưa hoàn thành
````

## File: memory_bank/wf_bien_lai_dien_tu.md
````markdown
# Workflow: Tích hợp biên lai điện tử

## Current tasks
- Tích hợp biên lai điện tử với ký hiệu BH25-AG/08907/E
- Số biên lai gồm 7 chữ số, bắt đầu từ 0000001 và tăng dần
- Thêm trường mã cơ quan bhxh khi thêm quyển biên lai điện tử
- Tự động lấy thông tin người cấp từ tài khoản đăng nhập hiện tại

## Plan (simple)
1. Phân tích yêu cầu và hiểu cấu trúc dữ liệu hiện tại
2. Mở rộng model để hỗ trợ biên lai điện tử
3. Cập nhật backend API để quản lý biên lai điện tử
4. Cập nhật giao diện người dùng để sử dụng biên lai điện tử

## Steps
1. Phân tích cấu trúc dữ liệu hiện tại liên quan đến biên lai
2. Tìm hiểu model Quyển biên lai hiện tại
3. Mở rộng model để thêm thuộc tính cho biên lai điện tử (ký hiệu, loại biên lai)
4. Cập nhật API để quản lý biên lai điện tử
5. Cập nhật giao diện để hiển thị và quản lý biên lai điện tử
6. Kiểm tra chức năng tăng số biên lai tự động
7. Thêm trường mã cơ quan BHXH vào quyển biên lai điện tử
8. Tự động lấy thông tin người cấp từ tài khoản đăng nhập

## Things done
- Tạo file workflow cho tích hợp biên lai điện tử
- Phân tích cấu trúc dữ liệu hiện tại liên quan đến biên lai
- Tạo model QuyenBienLaiDienTu với ký hiệu BH25-AG/08907/E và số biên lai bắt đầu từ 0000001
- Tạo model BienLaiDienTu
- Cập nhật ApplicationDbContext để thêm DbSet cho biên lai điện tử
- Tạo API Controller QuyenBienLaiDienTuController để quản lý quyển biên lai điện tử
- Tạo API Controller BienLaiDienTuController để quản lý biên lai điện tử với số biên lai tự động tăng
- Đảm bảo ký hiệu biên lai luôn là BH25-AG/08907/E
- Đảm bảo số biên lai có 7 chữ số, bắt đầu từ 0000001 và tăng dần
- Tạo script SQL để thêm bảng biên lai điện tử vào database
- Tạo migration để cập nhật database
- Tạo model TypeScript cho biên lai điện tử trong Angular
- Tạo service để tương tác với API biên lai điện tử
- Tạo component QuyenBienLaiDienTuComponent để quản lý quyển biên lai điện tử
- Tạo component QuanLyBienLaiDienTuComponent để quản lý biên lai điện tử
- Sửa lỗi nzOkType trong component QuyenBienLaiDienTuComponent
- Tạo module BienLaiDienTuModule khai báo các component liên quan
- Cập nhật hệ thống routing để thêm các component vào router
- Cập nhật menu sidebar để thêm liên kết đến chức năng biên lai điện tử
- Tạo service để lấy danh sách người dùng cho dropdown người thu
- Kết nối component với service người dùng
- Sửa lỗi BienLaiDienTuModule - chuyển các component thành standalone
- Sửa lỗi kiểu dữ liệu trong các component để hỗ trợ TypeScript nghiêm ngặt
- Thêm imports cần thiết cho các component standalone
- Di chuyển hàm formatterVND từ thẻ script HTML sang component class
- Sửa lỗi TypeScript cho kiểu dữ liệu undefined trong các phương thức xử lý trạng thái
- Sửa lỗi URL API bị trùng `/api/` trong service BienLaiDienTuService
- Sửa lỗi URL API bị trùng `/api/` trong service UsersService
- Khảo sát và xác định lỗi 500 từ backend do chưa có bảng biên lai điện tử trên database
- Cập nhật CSS để sửa lỗi hiển thị modal không hiển thị đúng các trường nhập liệu
- Sửa lỗi hiển thị modal bằng cách thêm thuộc tính nzBodyStyle và cấu trúc nzModalContent
- Cải thiện xử lý lỗi với catchError và nâng cao trải nghiệm người dùng trong trường hợp có lỗi
- Xóa dữ liệu mẫu tạm thời để sử dụng API thực tế sau khi database được cập nhật
- Sửa tên bảng tham chiếu trong FOREIGN KEY từ 'users' sang 'nguoi_dung' trong script SQL
- Sửa API endpoint trong UsersService từ '/users' sang '/nguoi-dung' để tương thích với API thực tế
- Sửa lỗi hiển thị danh sách người thu bằng cách cập nhật interface NguoiDung và sửa cách dùng thuộc tính từ API
- Thêm trường ma_co_quan_bhxh vào model QuyenBienLaiDienTu trong C#
- Tạo migration cho việc thêm trường ma_co_quan_bhxh
- Tạo script SQL để cập nhật database với trường ma_co_quan_bhxh
- Cập nhật QuyenBienLaiDienTuController để xử lý trường ma_co_quan_bhxh khi tạo và cập nhật quyển biên lai điện tử
- Cập nhật model TypeScript cho QuyenBienLaiDienTu để thêm trường ma_co_quan_bhxh
- Cập nhật giao diện form thêm mới và chỉnh sửa quyển biên lai điện tử để thêm trường nhập mã cơ quan BHXH
- Cập nhật bảng hiển thị để hiển thị trường ma_co_quan_bhxh
- Cập nhật QuyenBienLaiDienTuController để tự động lấy thông tin người cấp từ người dùng đăng nhập hiện tại
- Cập nhật form trong QuyenBienLaiDienTuComponent để ẩn trường người cấp và hiển thị thông báo về việc tự động lấy từ người đăng nhập
- Cập nhật xử lý dữ liệu trong TypeScript để gửi giá trị rỗng cho trường người cấp
- Hiển thị người cấp trong bảng danh sách và trong form chỉnh sửa (chỉ đọc)

## Things not done yet
- Cập nhật database trên máy chủ với các bảng mới bằng cách chạy script SQL trong thư mục Migrations/Scripts
- Chạy script AddMaCoQuanBHXHToQuyenBienLaiDienTu.sql để thêm trường ma_co_quan_bhxh vào bảng quyen_bien_lai_dien_tu
- Thêm chức năng xuất biên lai điện tử ra PDF/Word
- Tích hợp chức năng biên lai điện tử vào quy trình kê khai BHXH/BHYT hiện tại
- Kiểm thử chức năng biên lai điện tử
````

## File: memory_bank/wf_chinh_so_bien_lai.md
````markdown
# Workflow: Chỉnh số hiện tại và trạng thái của quyển biên lai điện tử

## Current tasks from user prompt
- Tìm hiểu cách chỉnh số hiện tại của quyển biên lai điện tử
- Triển khai chức năng chỉnh sửa số hiện tại của quyển biên lai điện tử
- Sửa lỗi network khi gửi request chỉnh sửa quyển biên lai
- Thêm chức năng chỉnh sửa trạng thái quyển biên lai
- Tối ưu trạng thái của quyển biên lai
- Kiểm tra và sửa lỗi console

## Plan (simple)
1. Tìm kiếm và phân tích mã nguồn liên quan đến quyển biên lai điện tử
2. Xác định model, controller và service liên quan
3. Tìm các hàm xử lý việc cập nhật số hiện tại
4. Tìm UI liên quan đến chỉnh sửa quyển biên lai
5. Cập nhật UI để có thể chỉnh sửa số hiện tại
6. Cập nhật controller để cho phép giảm số hiện tại xuống thấp hơn trong trường hợp cần thiết
7. Hướng dẫn quy trình chỉnh sửa số hiện tại của quyển biên lai
8. Kiểm tra và sửa lỗi network khi gửi request
9. Thêm chức năng chỉnh sửa trạng thái quyển biên lai
10. Tối ưu trạng thái quyển biên lai với các cải tiến giao diện và logic
11. Kiểm tra và sửa lỗi console trong component

## Steps
1. Tìm kiếm mã nguồn liên quan đến "quyển biên lai"
2. Kiểm tra model Quyển biên lai trong WebApp.Server
3. Tìm controller và service xử lý quyển biên lai
4. Kiểm tra UI component trong WebApp.Client
5. Phân tích code xử lý cập nhật số hiện tại
6. Cập nhật UI để có thể chỉnh sửa số hiện tại
7. Cập nhật controller để xử lý trường hợp giảm số hiện tại
8. Tổng hợp hướng dẫn cách chỉnh số hiện tại
9. Kiểm tra các lỗi network
10. Sửa lỗi trong component gửi request
11. Sửa lỗi LINQ không thể chuyển đổi trong controller
12. Thêm trường chọn trạng thái vào form chỉnh sửa
13. Cập nhật component để xử lý thay đổi trạng thái
14. Thêm xác nhận khi thay đổi thành trạng thái đã sử dụng hết
15. Cập nhật giao diện hiển thị trạng thái với màu sắc phù hợp
16. Chuẩn hóa mã trạng thái với hằng số
17. Thêm cảnh báo khi số biên lai còn lại ít
18. Thêm cột hiển thị số biên lai còn lại
19. Cải thiện UX với cảnh báo trực quan
20. Kiểm tra lỗi console và sửa các biểu thức phức tạp trong template
21. Thêm các hàm helper để thay thế biểu thức phức tạp trong template
22. Thêm module NzAlertModule vào imports của component

## Things done
- Tạo workflow mới để theo dõi task
- Tìm kiếm và phân tích mã nguồn liên quan
- Xác định các thành phần liên quan 
- Cập nhật UI để thêm chức năng chỉnh sửa số hiện tại
- Cập nhật logic kiểm tra số hiện tại hợp lệ
- Cập nhật controller QuyenBienLaiDienTuController để hỗ trợ việc giảm số hiện tại
- Thêm kiểm tra tính khả thi khi giảm số hiện tại (kiểm tra xem đã có biên lai nào được cấp cho số này chưa)
- Bổ sung thông báo lỗi chi tiết và log để dễ theo dõi
- Phát hiện và sửa lỗi trong component khi gửi request chỉnh sửa
- Sửa lỗi Entity Framework không thể dịch int.Parse trong biểu thức LINQ
- Thêm trường chọn trạng thái vào form chỉnh sửa quyển biên lai điện tử
- Thêm cảnh báo khi chọn trạng thái "đã sử dụng hết"
- Thêm hộp thoại xác nhận khi thay đổi sang trạng thái "đã sử dụng hết"
- Cập nhật hiển thị tag trạng thái với màu sắc tương ứng
- Tối ưu hóa quản lý trạng thái với hằng số
- Thêm cảnh báo khi số biên lai còn lại ít
- Thêm hộp thoại xác nhận khi chuyển từ trạng thái inactive sang active
- Bổ sung cột hiển thị số biên lai còn lại trong bảng
- Thêm highlight cho các quyển biên lai sắp hết số
- Thêm thông báo cảnh báo trên đầu trang khi có quyển biên lai sắp hết số
- Bổ sung nút làm mới dữ liệu
- Kiểm tra và sửa lỗi console do sử dụng biểu thức phức tạp trong template
- Tạo các hàm helper để thay thế biểu thức phức tạp trong HTML
- Thêm NzAlertModule vào imports của component

## Things not done yet
- Kiểm tra xem cách cập nhật số hiện tại và trạng thái có hoạt động đúng sau khi triển khai và sửa lỗi

## Kết quả triển khai

### Thay đổi đã thực hiện:

1. **Cập nhật UI**:
   - Đã thêm trường "số hiện tại" vào form chỉnh sửa quyển biên lai điện tử
   - Thêm trường "trạng thái" với các tùy chọn: Chưa sử dụng, Đang active, Không active, Đã sử dụng hết
   - Thêm validation để đảm bảo số hiện tại nằm trong khoảng từ số đến số
   - Hiển thị cảnh báo khi chọn trạng thái "đã sử dụng hết"
   - Cập nhật hiển thị tag trạng thái trong bảng với màu sắc tương ứng
   - Thêm cột hiển thị số biên lai còn lại
   - Highlight hàng trong bảng khi số biên lai sắp hết
   - Thêm thông báo cảnh báo khi có quyển biên lai sắp hết số
   - Bổ sung cảnh báo trong form khi số biên lai còn lại ít

2. **Cập nhật controller**:
   - Cho phép giảm số hiện tại xuống thấp hơn giá trị hiện có
   - Kiểm tra xem có biên lai nào đã được cấp với số trong khoảng giảm không
   - Thêm log chi tiết về quá trình cập nhật
   - Trả về thông báo lỗi rõ ràng hơn
   - Sửa lỗi LINQ không thể chuyển đổi bằng cách thay đổi cách kiểm tra biên lai xung đột

3. **Cập nhật component**:
   - Xác nhận trước khi thay đổi sang trạng thái "đã sử dụng hết"
   - Khởi tạo và xử lý giá trị trạng thái trong form
   - Cải thiện UX bằng cách hiển thị trạng thái với màu sắc phù hợp
   - Thêm hằng số quản lý trạng thái để dễ bảo trì
   - Tự động kiểm tra và cảnh báo khi số hiện tại gần đến số cuối
   - Thêm xác nhận khi chuyển từ inactive sang active
   - Tối ưu logic hiển thị số còn lại
   - Tạo các hàm helper để xử lý việc tính toán và kiểm tra
   - Thêm NzAlertModule vào imports của component

4. **Sửa lỗi network**:
   - Sửa lỗi "ID không khớp với dữ liệu cập nhật" khi gửi request PUT bằng cách thêm trường id vào dữ liệu form
   - Sửa lỗi 500 Internal Server Error do Entity Framework không thể chuyển đổi int.Parse trong biểu thức LINQ

5. **Sửa lỗi console**:
   - Loại bỏ các biểu thức phức tạp trong template HTML
   - Tạo các hàm helper để thay thế việc tính toán trực tiếp trong template
   - Thêm các hàm kiểm tra trạng thái và tính số biên lai còn lại
   - Thêm NzAlertModule vào imports để sử dụng component alert

### Cải tiến liên quan đến trạng thái:

1. **Quản lý trạng thái bằng hằng số**:
   - Định nghĩa các trạng thái qua hằng số TRANG_THAI trong component
   - Đảm bảo thống nhất giữa các phần của ứng dụng
   - Giúp code dễ đọc và bảo trì hơn

2. **Cảnh báo cho quyển sắp hết số**:
   - Tự động kiểm tra và cảnh báo khi số hiện tại thay đổi
   - Hiển thị cảnh báo toàn trang khi có quyển biên lai sắp hết
   - Highlight dòng tương ứng trong bảng
   - Đề xuất chuyển sang trạng thái "Đã sử dụng hết" khi cần

3. **Cải thiện UX**:
   - Thêm thông tin mô tả cho mỗi trạng thái
   - Hiển thị số biên lai còn lại rõ ràng
   - Thêm nút làm mới dữ liệu
   - Cảnh báo trực quan với màu sắc và icon

### Vấn đề đã phát hiện và sửa chữa:
1. Lỗi ID không khớp: Object formData gửi đi không có trường id, dẫn đến việc so sánh id trên server không khớp. Giải pháp là thêm trường id vào formData trước khi gửi request.
2. Lỗi Entity Framework: Expression LINQ sử dụng int.Parse không thể được dịch thành SQL. Giải pháp là lấy toàn bộ danh sách biên lai từ database, sau đó thực hiện lọc biên lai xung đột ở phía ứng dụng thay vì database.
3. Lỗi console: Angular không cho phép sử dụng các biểu thức phức tạp trong template HTML, đặc biệt là việc filter và parseInt. Giải pháp là tạo các hàm helper trong component để thay thế việc xử lý logic trong template.

### Hướng dẫn cách chỉnh số hiện tại và trạng thái của quyển biên lai điện tử

#### 1. Cách chỉnh số hiện tại và trạng thái:
1. Đăng nhập vào hệ thống với tài khoản có quyền quản lý quyển biên lai điện tử
2. Vào phần quản lý quyển biên lai điện tử (Mục "Biên lai" -> "Quyển biên lai điện tử")
3. Tìm quyển biên lai cần điều chỉnh 
4. Nhấn nút "Chỉnh sửa" (biểu tượng bút chì) bên cạnh quyển biên lai
5. Trong form chỉnh sửa:
   - Nhập giá trị mới vào trường "Số hiện tại"
   - Chọn trạng thái phù hợp từ dropdown "Trạng thái"
6. Nhấn nút "Cập nhật" để lưu thay đổi
7. Nếu chọn trạng thái "Đã sử dụng hết", sẽ có hộp thoại xác nhận hiện lên

#### 2. Lưu ý khi chỉnh sửa:
- Số hiện tại phải nằm trong khoảng giữa "Từ số" và "Đến số" của quyển biên lai
- Không thể giảm số hiện tại xuống số đã có biên lai được cấp
- Chỉ nên đặt trạng thái "Đã sử dụng hết" khi không còn sử dụng quyển biên lai nữa
- Trạng thái "Đang active" cho phép sử dụng quyển biên lai để cấp biên lai mới
- Trạng thái "Không active" tạm thời ngừng sử dụng quyển biên lai
- Khi tạo biên lai mới, hệ thống sẽ sử dụng quyển có trạng thái "active" và lấy số hiện tại của quyển đó
- Hệ thống sẽ cảnh báo khi quyển biên lai gần hết số (còn dưới 20 số)

#### 3. Các trường hợp cần điều chỉnh số hiện tại và trạng thái:
- Khi phát hiện lỗi trong việc cấp số biên lai
- Khi muốn bỏ qua một số biên lai do lỗi kỹ thuật
- Khi cần đồng bộ số biên lai với hệ thống khác
- Khi cần điều chỉnh số biên lai theo yêu cầu từ cơ quan BHXH
- Khi cần chuyển đổi giữa các quyển biên lai (active/inactive)
- Khi quyển biên lai đã hết số và cần đánh dấu "Đã sử dụng hết"
- Khi cần chuẩn bị quyển biên lai mới do quyển hiện tại sắp hết
````

## File: memory_bank/wf_filter_lich_su_ke_khai.md
````markdown
# Workflow: Filter lịch sử kê khai

## Nhiệm vụ hiện tại
- Cập nhật hệ thống sao cho lịch sử kê khai chỉ hiển thị các kê khai mà tài khoản đó tạo

## Kế hoạch
Kiểm tra và cập nhật các controller liên quan đến lịch sử kê khai để đảm bảo rằng dữ liệu được lọc theo người dùng đang đăng nhập, trừ khi người dùng có quyền admin.

## Các bước
1. Xác định controller xử lý lịch sử kê khai
2. Xem xét cách dữ liệu được truy xuất hiện tại
3. Thêm điều kiện lọc theo người tạo (nguoi_tao)
4. Đảm bảo admin vẫn có thể xem tất cả dữ liệu
5. Kiểm tra việc xuất dữ liệu ra file Excel

## Đã hoàn thành
- Đã xác định controller xử lý lịch sử kê khai (LichSuKeKhaiController)
- Đã thêm logic để lấy thông tin người dùng hiện tại
- Đã thêm điều kiện kiểm tra vai trò người dùng
- Đã thêm điều kiện lọc dữ liệu theo người tạo nếu không phải admin/super_admin
- Đã cập nhật cả 4 phương thức trong controller:
  - GetLichSuKeKhai: Lấy lịch sử kê khai BHYT
  - ExportLichSuKeKhai: Xuất file Excel lịch sử kê khai BHYT
  - GetLichSuKeKhaiBHXH: Lấy lịch sử kê khai BHXH
  - ExportLichSuKeKhaiBHXH: Xuất file Excel lịch sử kê khai BHXH

## Chưa hoàn thành
- Kiểm tra và xác nhận chức năng trên môi trường thực tế
````

## File: memory_bank/wf_fix_auto_dien_tu_receipt.md
````markdown
# Sửa lỗi tự động sử dụng biên lai điện tử

## Current tasks from user prompt
- Sửa lỗi chức năng "khi gửi đợt kê khai nếu is_bien_lai_dien_tu bằng true thì tự động sử dụng biên lai điện tử" chưa hoạt động đúng

## Plan (simple)
1. Tìm hiểu lý do tại sao chức năng cũ không hoạt động
2. Thêm logs để kiểm tra giá trị của dotKeKhai.is_bien_lai_dien_tu và dotKeKhai.bien_lai_dien_tu
3. Sửa đổi component để kiểm tra cả hai thuộc tính
4. Sử dụng cờ boolean để theo dõi việc sử dụng biên lai điện tử
5. Hiển thị thông báo cho người dùng khi đợt kê khai sẽ sử dụng biên lai điện tử

## Steps
1. Thêm logs vào phương thức loadDotKeKhai để kiểm tra giá trị của is_bien_lai_dien_tu và bien_lai_dien_tu
2. Thêm biến willUseBienLaiDienTu để lưu giá trị
3. Cập nhật phương thức guiDotKeKhai trong KeKhaiBHYTComponent để sử dụng biến này
4. Thêm logs vào DotKeKhaiService để theo dõi dữ liệu gửi đi
5. Cập nhật DotKeKhaiComponent để kiểm tra cả hai thuộc tính
6. Thêm thông báo vào giao diện để người dùng biết đợt kê khai sẽ sử dụng biên lai điện tử
7. Thêm logs vào DotKeKhaiController để theo dõi quá trình xử lý biên lai điện tử

## Things done
1. Đã thêm logs vào phương thức loadDotKeKhai để kiểm tra các giá trị
2. Đã thêm biến willUseBienLaiDienTu và cập nhật giá trị trong loadDotKeKhai
3. Đã cập nhật phương thức guiDotKeKhai trong KeKhaiBHYTComponent để hiển thị thông báo về biên lai điện tử
4. Đã thêm logs vào DotKeKhaiService để theo dõi dữ liệu request/response
5. Đã cập nhật DotKeKhaiComponent để kiểm tra cả is_bien_lai_dien_tu và bien_lai_dien_tu
6. Đã thêm thông báo nz-alert vào giao diện khi willUseBienLaiDienTu là true
7. Đã thêm logs vào DotKeKhaiController để theo dõi quá trình xử lý biên lai điện tử

## Things not done yet
- Chưa có giải pháp dài hạn để đồng bộ hóa giá trị giữa is_bien_lai_dien_tu và bien_lai_dien_tu
- Chưa thêm tùy chọn cho người dùng để tắt/bật tạm thời chức năng biên lai điện tử khi gửi đợt kê khai
- Chưa thêm unit tests để đảm bảo chức năng hoạt động chính xác
````

## File: memory_bank/wf_remove_nguoi_thu_field.md
````markdown
# Loại bỏ trường người thu khi Thêm quyển biên lai điện tử

## Nhiệm vụ
- Chỉnh sửa model để trường người thu (nhan_vien_thu) không còn bắt buộc
- Cập nhật giao diện để không yêu cầu chọn người thu khi thêm quyển biên lai điện tử
- Đảm bảo các phần còn lại của ứng dụng vẫn hoạt động đúng

## Kế hoạch
1. Sửa đổi model QuyenBienLaiDienTu để trường nhan_vien_thu nullable
2. Cập nhật giao diện form thêm/sửa quyển biên lai để loại bỏ trường người thu
3. Cập nhật controller để không yêu cầu trường người thu
4. Cập nhật phương thức hiển thị để xử lý giá trị null
5. Kiểm tra logic nghiệp vụ liên quan đến việc sử dụng quyển biên lai

## Các bước
1. Sửa model QuyenBienLaiDienTu.cs để trường nhan_vien_thu nullable
2. Cập nhật giao diện HTML để loại bỏ trường người thu
3. Cập nhật component TypeScript để loại bỏ validation và xử lý form
4. Cập nhật interface trong TypeScript để nhan_vien_thu có thể nhận giá trị null
5. Chỉnh sửa phương thức getUserName để xử lý giá trị null
6. Chỉnh sửa QuyenBienLaiDienTuController để không kiểm tra người thu
7. Đảm bảo rằng khi lưu quyển biên lai, trường nhan_vien_thu luôn được gán giá trị null

## Đã hoàn thành
1. Đã sửa model QuyenBienLaiDienTu.cs để trường nhan_vien_thu nullable (loại bỏ [Required])
2. Đã loại bỏ trường người thu khỏi form trong quyen-bien-lai-dien-tu.component.html
3. Đã cập nhật form validation trong .ts component (loại bỏ nhan_vien_thu khỏi form validation)
4. Đã sửa interface TypeScript để nhan_vien_thu có thể null
5. Đã cập nhật phương thức getUserName để xử lý giá trị null
6. Đã cập nhật controller để bỏ kiểm tra người thu
7. Đã thêm code gán nhan_vien_thu = null khi submit form

## Chưa hoàn thành
Tất cả các nhiệm vụ đã hoàn thành.
````

## File: memory_bank/wf_update_electronic_receipt.md
````markdown
# Workflow: update_electronic_receipt

## Current tasks from user prompt
- Sửa lỗi khi người dùng muốn cập nhật đợt kê khai để sử dụng biên lai điện tử
- Hiện tại, khi người dùng ban đầu không chọn "Sử dụng biên lai điện tử" và gửi đợt kê khai, sau đó mở modal "Cập nhật đợt kê khai" và chọn "Sử dụng biên lai điện tử" rồi bấm gửi, hệ thống không cập nhật số biên lai của biên lai điện tử

## Plan (simple)
1. Tìm hiểu luồng xử lý cập nhật đợt kê khai và biên lai điện tử
2. Xác định các component và service liên quan đến việc cập nhật đợt kê khai
3. Tìm hiểu cách hệ thống xử lý biên lai điện tử và cập nhật số biên lai
4. Sửa lỗi không cập nhật số biên lai khi chuyển từ không sử dụng sang sử dụng biên lai điện tử
5. Kiểm tra và đảm bảo các trường hợp khác vẫn hoạt động bình thường

## Steps
1. Tìm kiếm các file liên quan đến đợt kê khai và biên lai điện tử
2. Xem mã nguồn của component cập nhật đợt kê khai
3. Xem mã nguồn xử lý biên lai điện tử
4. Xác định vấn đề trong luồng cập nhật
5. Sửa lỗi không cập nhật số biên lai điện tử
6. Kiểm tra lại luồng hoạt động

## Things done
- Đã đọc file long_term.md để hiểu về dự án
- Đã tạo workflow file để theo dõi tiến độ
- Đã tìm kiếm các file liên quan đến đợt kê khai và biên lai điện tử
- Đã xem mã nguồn của component cập nhật đợt kê khai
- Đã xem mã nguồn xử lý biên lai điện tử
- Đã xác định vấn đề trong luồng cập nhật
- Đã sửa lỗi không cập nhật số biên lai khi chuyển từ không sử dụng sang sử dụng biên lai điện tử

## Things not done yet
- Kiểm tra lại luồng hoạt động
````

## File: WebApp.Client/.vscode/extensions.json
````json
{
  // For more information, visit: https://go.microsoft.com/fwlink/?linkid=827846
  "recommendations": ["angular.ng-template"]
}
````

## File: WebApp.Client/.vscode/launch.json
````json
{
  // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
  "version": "0.2.0",
  "configurations": [
    {
      "name": "ng serve",
      "type": "chrome",
      "request": "launch",
      "preLaunchTask": "npm: start",
      "url": "http://localhost:4200/"
    },
    {
      "name": "ng test",
      "type": "chrome",
      "request": "launch",
      "preLaunchTask": "npm: test",
      "url": "http://localhost:9876/debug.html"
    }
  ]
}
````

## File: WebApp.Client/.vscode/tasks.json
````json
{
  // For more information, visit: https://go.microsoft.com/fwlink/?LinkId=733558
  "version": "2.0.0",
  "tasks": [
    {
      "type": "npm",
      "script": "start",
      "isBackground": true,
      "problemMatcher": {
        "owner": "typescript",
        "pattern": "$tsc",
        "background": {
          "activeOnStart": true,
          "beginsPattern": {
            "regexp": "(.*?)"
          },
          "endsPattern": {
            "regexp": "bundle generation complete"
          }
        }
      }
    },
    {
      "type": "npm",
      "script": "test",
      "isBackground": true,
      "problemMatcher": {
        "owner": "typescript",
        "pattern": "$tsc",
        "background": {
          "activeOnStart": true,
          "beginsPattern": {
            "regexp": "(.*?)"
          },
          "endsPattern": {
            "regexp": "bundle generation complete"
          }
        }
      }
    }
  ]
}
````

## File: WebApp.Client/src/app/bien-lai/bang-ke-bien-lai/bang-ke-bien-lai.component.html
````html
<div class="container">
  <div class="header">
    <h2>
      <i nz-icon nzType="file-text" nzTheme="outline"></i>
      Bảng kê biên lai
    </h2>
    <div class="button-group">
      <button nz-button nzType="primary" (click)="onSearch()">
        <i nz-icon nzType="search"></i>
        Tìm kiếm
      </button>
      <button nz-button (click)="resetForm()">
        <i nz-icon nzType="reload"></i>
        Làm mới
      </button>
      <button nz-button (click)="exportToExcel()">
        <i nz-icon nzType="download"></i>
        Xuất Excel
      </button>
    </div>
  </div>

  <!-- Form tìm kiếm -->
  <div class="search-section">
    <div class="search-form">
      <nz-row [nzGutter]="16">
        <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6">
          <nz-form-item>
            <nz-form-label>Thời gian:</nz-form-label>
            <nz-form-control>
              <nz-range-picker
                [(ngModel)]="dateRange"
                (ngModelChange)="onDateRangeChange($event)"
                [nzFormat]="'dd/MM/yyyy'"
                name="dateRange"
                nzPlaceHolder="['Từ ngày', 'Đến ngày']">
              </nz-range-picker>
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6">
          <nz-form-item>
            <nz-form-label>Quyển số:</nz-form-label>
            <nz-form-control>
              <input nz-input placeholder="Nhập quyển số" [(ngModel)]="searchForm.quyenSo" name="quyenSo">
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6">
          <nz-form-item>
            <nz-form-label>Mã nhân viên:</nz-form-label>
            <nz-form-control>
              <input nz-input placeholder="Nhập mã nhân viên" [(ngModel)]="searchForm.maNhanVien" name="maNhanVien">
            </nz-form-control>
          </nz-form-item>
        </nz-col>
      </nz-row>
    </div>
  </div>

  <!-- Bảng dữ liệu -->
  <div class="table-container">
    <nz-table
      #basicTable
      [nzData]="bienLais"
      [nzLoading]="loading"
      [nzShowSizeChanger]="true"
      [nzPageSizeOptions]="[10, 20, 30, 40, 50]"
      [nzShowTotal]="totalTemplate"
      [nzShowPagination]="true"
      [nzScroll]="{ x: '1200px' }"
      class="mt-4">
      <thead>
        <tr>
          <th nzWidth="100px">Quyển số</th>
          <th nzWidth="100px">Số biên lai</th>
          <th nzWidth="150px">Người đóng</th>
          <th nzWidth="100px">Mã số BHXH</th>
          <th nzWidth="120px" nzAlign="right">Số tiền</th>
          <th nzWidth="150px">Ngày biên lai</th>
          <th nzWidth="80px">Mã NV</th>
          <th nzWidth="150px">Tên nhân viên</th>
          <th nzWidth="150px">Đơn vị</th>
          <th nzWidth="120px">Mã hồ sơ</th>
          <th nzWidth="80px" nzAlign="center">Số tháng</th>
          <th nzWidth="100px">Người thứ</th>
          <th nzWidth="100px">Trạng thái</th>
          <th nzWidth="100px">Tính chất</th>
          <th nzWidth="200px">Ghi chú</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of basicTable.data">
          <td>{{ item.quyen_so }}</td>
          <td>{{ item.so_bien_lai }}</td>
          <td>{{ item.ten_nguoi_dong }}</td>
          <td>{{ item.ma_so_bhxh }}</td>
          <td nzAlign="right">{{ item.so_tien | number }}</td>
          <td>{{ item.ngay_bien_lai | date:'dd/MM/yyyy HH:mm' }}</td>
          <td>{{ item.ma_nhan_vien }}</td>
          <td>{{ item.ten_nhan_vien }}</td>
          <td>{{ item.don_vi }}</td>
          <td>{{ item.ma_ho_so }}</td>
          <td nzAlign="center">{{ item.so_thang_dong }}</td>
          <td>{{ getNguoiThuText(item.nguoi_thu) }}</td>
          <td>{{ item.trang_thai }}</td>
          <td>{{ item.tinh_chat }}</td>
          <td>{{ item.ghi_chu }}</td>
        </tr>
      </tbody>
    </nz-table>

    <ng-template #totalTemplate let-total>
      Tổng số {{ total }} bản ghi
    </ng-template>
  </div>
</div>
````

## File: WebApp.Client/src/app/bien-lai/bang-ke-bien-lai/bang-ke-bien-lai.component.scss
````scss
.container {
  padding: 24px;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;

  h2 {
    margin: 0;
    i {
      margin-right: 8px;
    }
  }

  .button-group {
    button {
      margin-left: 8px;
    }
  }
}

.search-section {
  background: #fff;
  padding: 24px;
  border-radius: 4px;
  margin-bottom: 24px;
}

.table-container {
  background: #fff;
  padding: 24px;
  border-radius: 4px;
}

:host ::ng-deep {
  .ant-table-thead > tr > th {
    background: #f0f2f5;
  }
}
````

## File: WebApp.Client/src/app/bien-lai/bang-ke-bien-lai/bang-ke-bien-lai.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzDatePickerModule } from 'ng-zorro-antd/date-picker';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzFormModule } from 'ng-zorro-antd/form';
import { BienLaiService, BangKeBienLai } from '../../services/bien-lai.service';

@Component({
  selector: 'app-bang-ke-bien-lai',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    NzTableModule,
    NzButtonModule,
    NzIconModule,
    NzDatePickerModule,
    NzInputModule,
    NzGridModule,
    NzFormModule
  ],
  templateUrl: './bang-ke-bien-lai.component.html',
  styleUrls: ['./bang-ke-bien-lai.component.scss']
})
export class BangKeBienLaiComponent implements OnInit {
  loading = false;
  bienLais: BangKeBienLai[] = [];
  dateRange: Date[] = [];
  searchForm = {
    tuNgay: null as Date | null,
    denNgay: null as Date | null,
    quyenSo: null as string | null,
    maNhanVien: null as string | null
  };

  constructor(
    private bienLaiService: BienLaiService,
    private message: NzMessageService
  ) {}

  ngOnInit(): void {
    this.loadData();
  }

  onDateRangeChange(dates: Date[]): void {
    if (dates && dates.length === 2) {
      this.searchForm.tuNgay = dates[0];
      this.searchForm.denNgay = dates[1];
    } else {
      this.searchForm.tuNgay = null;
      this.searchForm.denNgay = null;
    }
  }

  loadData(): void {
    this.loading = true;
    const params = {
      ...this.searchForm,
      quyenSo: this.searchForm.quyenSo || undefined,
      maNhanVien: this.searchForm.maNhanVien || undefined
    };

    this.bienLaiService.getBangKeBienLai(params).subscribe({
      next: (data) => {
        this.bienLais = data;
        this.loading = false;
      },
      error: (error) => {
        console.error('Lỗi khi tải dữ liệu:', error);
        this.message.error('Có lỗi xảy ra khi tải dữ liệu');
        this.loading = false;
      }
    });
  }

  resetForm(): void {
    this.searchForm = {
      tuNgay: null,
      denNgay: null,
      quyenSo: null,
      maNhanVien: null
    };
    this.dateRange = [];
    this.loadData();
  }

  onSearch(): void {
    this.loadData();
  }

  exportToExcel(): void {
    this.loading = true;
    const params = {
      ...this.searchForm,
      quyenSo: this.searchForm.quyenSo || undefined,
      maNhanVien: this.searchForm.maNhanVien || undefined
    };

    this.bienLaiService.exportBangKeBienLai(params).subscribe({
      next: (data: Blob) => {
        const url = window.URL.createObjectURL(data);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bang-ke-bien-lai-${new Date().getTime()}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        this.loading = false;
      },
      error: (error) => {
        console.error('Lỗi khi xuất Excel:', error);
        this.message.error('Có lỗi xảy ra khi xuất Excel');
        this.loading = false;
      }
    });
  }

  // Hàm chuyển đổi số người thứ sang text
  getNguoiThuText(nguoiThu: number | undefined): string {
    if (!nguoiThu) return '';
    
    switch (nguoiThu) {
      case 1:
        return 'Người thứ 1';
      case 2:
        return 'Người thứ 2';
      case 3:
        return 'Người thứ 3';
      case 4:
        return 'Người thứ 4';
      case 5:
        return 'Người thứ 5 trở đi';
      default:
        return '';
    }
  }
}
````

## File: WebApp.Client/src/app/bien-lai/bao-cao-bien-lai/bao-cao-bien-lai.component.html
````html
<div class="page-header">
  <div class="header-content">
    <h2>Báo cáo biên lai</h2>
    <div class="header-actions">
      <nz-radio-group [(ngModel)]="viewMode" nzButtonStyle="solid">
        <label nz-radio-button nzValue="table" nz-tooltip nzTooltipTitle="Xem dạng bảng">
          <i nz-icon nzType="table"></i>
        </label>
        <label nz-radio-button nzValue="card" nz-tooltip nzTooltipTitle="Xem dạng thẻ">
          <i nz-icon nzType="appstore"></i>
        </label>
        <label nz-radio-button nzValue="compact" nz-tooltip nzTooltipTitle="Xem dạng thu gọn">
          <i nz-icon nzType="unordered-list"></i>
        </label>
      </nz-radio-group>
    </div>
  </div>
</div>

<div class="page-content">
  <nz-tabset [(nzSelectedIndex)]="activeTab" (nzSelectedIndexChange)="changeTab($event)">
    <nz-tab nzTitle="Báo cáo tổng hợp">
      <!-- Form tìm kiếm -->
      <form nz-form [nzLayout]="'inline'" class="search-form">
        <div nz-row [nzGutter]="16">
          <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="8">
            <nz-form-item>
              <nz-form-label>Thời gian</nz-form-label>
              <nz-form-control>
                <nz-range-picker 
                  [(ngModel)]="dateRange" 
                  name="dateRange"
                  (ngModelChange)="onDateRangeChange($event)"
                  nzFormat="dd/MM/yyyy"
                  [nzAllowClear]="true">
                </nz-range-picker>
              </nz-form-control>
            </nz-form-item>
          </div>
          
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4">
            <nz-form-item>
              <nz-form-label>Quyển số</nz-form-label>
              <nz-form-control>
                <input nz-input [(ngModel)]="searchForm.quyenSo" name="quyenSo" placeholder="Nhập quyển số" />
              </nz-form-control>
            </nz-form-item>
          </div>
          
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4">
            <nz-form-item>
              <nz-form-label>Mã nhân viên</nz-form-label>
              <nz-form-control>
                <input nz-input [(ngModel)]="searchForm.maNhanVien" name="maNhanVien" placeholder="Nhập mã nhân viên" />
              </nz-form-control>
            </nz-form-item>
          </div>
          
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4">
            <nz-form-item>
              <nz-form-label>Trạng thái</nz-form-label>
              <nz-form-control>
                <nz-select [(ngModel)]="searchForm.trangThai" name="trangThai" [nzPlaceHolder]="'Chọn trạng thái'" [nzAllowClear]="true">
                  <nz-option *ngFor="let option of trangThaiOptions" [nzValue]="option.value" [nzLabel]="option.label"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>
          
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4" *ngIf="showAdvancedFilter">
            <nz-form-item>
              <nz-form-label>Tính chất</nz-form-label>
              <nz-form-control>
                <nz-select [(ngModel)]="searchForm.tinhChat" name="tinhChat" [nzPlaceHolder]="'Chọn tính chất'" [nzAllowClear]="true">
                  <nz-option *ngFor="let option of tinhChatOptions" [nzValue]="option.value" [nzLabel]="option.label"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>
          
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4" *ngIf="showAdvancedFilter">
            <nz-form-item>
              <nz-form-label>Đơn vị</nz-form-label>
              <nz-form-control>
                <input nz-input [(ngModel)]="searchForm.donVi" name="donVi" placeholder="Nhập đơn vị" />
              </nz-form-control>
            </nz-form-item>
          </div>
          
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4" *ngIf="showAdvancedFilter">
            <nz-form-item>
              <nz-form-label>Mã hồ sơ</nz-form-label>
              <nz-form-control>
                <input nz-input [(ngModel)]="searchForm.maHoSo" name="maHoSo" placeholder="Nhập mã hồ sơ" />
              </nz-form-control>
            </nz-form-item>
          </div>
          
          <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="24" [nzLg]="24" class="button-group">
            <button nz-button [nzType]="'primary'" (click)="onSearch()">
              <i nz-icon nzType="search"></i>Tìm kiếm
            </button>
            <button nz-button (click)="resetForm()">
              <i nz-icon nzType="clear"></i>Xóa bộ lọc
            </button>
            <button nz-button (click)="toggleAdvancedFilter()">
              <i nz-icon [nzType]="showAdvancedFilter ? 'up' : 'down'"></i>
              {{ showAdvancedFilter ? 'Thu gọn' : 'Mở rộng' }}
            </button>
            <nz-divider nzType="vertical"></nz-divider>
            <button nz-button [nzType]="'primary'" (click)="exportToExcel()" [nzLoading]="loading">
              <i nz-icon nzType="file-excel"></i>Excel
            </button>
            <button nz-button [nzType]="'primary'" nz-tooltip nzTooltipTitle="Xuất báo cáo BC01/QTAC" (click)="exportBC01()" [nzLoading]="loading">
              <i nz-icon nzType="file-text"></i>BC01
            </button>
            <button nz-button [nzType]="'primary'" (click)="exportToPdf()">
              <i nz-icon nzType="file-pdf"></i>PDF
            </button>
            <button nz-button [nzType]="'default'" (click)="printReport()">
              <i nz-icon nzType="printer"></i>In
            </button>
          </div>
        </div>
      </form>

      <!-- Thống kê tổng hợp -->
      <div class="statistics-section">
        <div nz-row [nzGutter]="16">
          <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="24" [nzLg]="24" [nzXl]="24">
            <nz-card class="progress-card">
              <div class="progress-header">
                <div class="progress-title">Tỷ lệ thu tiền</div>
                <div class="progress-value">{{ getProgressPercent() }}%</div>
              </div>
              <nz-progress [nzPercent]="getProgressPercent()" [nzStatus]="getProgressPercent() >= 80 ? 'success' : 'active'" [nzStrokeColor]="getProgressPercent() >= 80 ? '#52c41a' : '#1890ff'"></nz-progress>
              <div class="progress-footer">
                <div>Đã thu: {{ formatCurrency(thongKe.tien_da_thu) }}</div>
                <div>Tổng tiền: {{ formatCurrency(thongKe.tong_so_tien) }}</div>
              </div>
            </nz-card>
          </div>
        </div>
        
        <div nz-row [nzGutter]="16">
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6">
            <nz-card class="stat-card total-card">
              <div class="stat-icon">
                <i nz-icon nzType="file-text" nzTheme="outline"></i>
              </div>
              <div class="stat-content">
                <div class="stat-title">Tổng số biên lai</div>
                <div class="stat-value">{{ thongKe.tong_so_bien_lai }}</div>
                <div class="stat-subtitle">{{ formatCurrency(thongKe.tong_so_tien) }}</div>
              </div>
            </nz-card>
          </div>
          
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6">
            <nz-card class="stat-card success-card">
              <div class="stat-icon">
                <i nz-icon nzType="check-circle" nzTheme="outline"></i>
              </div>
              <div class="stat-content">
                <div class="stat-title">Đã thu</div>
                <div class="stat-value">{{ thongKe.bien_lai_da_thu }}</div>
                <div class="stat-subtitle">{{ formatCurrency(thongKe.tien_da_thu) }}</div>
              </div>
            </nz-card>
          </div>
          
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6">
            <nz-card class="stat-card warning-card">
              <div class="stat-icon">
                <i nz-icon nzType="clock-circle" nzTheme="outline"></i>
              </div>
              <div class="stat-content">
                <div class="stat-title">Chưa thu</div>
                <div class="stat-value">{{ thongKe.bien_lai_chua_thu }}</div>
                <div class="stat-subtitle">{{ formatCurrency(thongKe.tien_chua_thu) }}</div>
              </div>
            </nz-card>
          </div>
          
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6">
            <nz-card class="stat-card danger-card">
              <div class="stat-icon">
                <i nz-icon nzType="close-circle" nzTheme="outline"></i>
              </div>
              <div class="stat-content">
                <div class="stat-title">Đã hủy</div>
                <div class="stat-value">{{ thongKe.bien_lai_huy }}</div>
                <div class="stat-subtitle">{{ formatCurrency(thongKe.tien_huy) }}</div>
              </div>
            </nz-card>
          </div>
        </div>
      </div>

      <!-- Bảng dữ liệu -->
      <div class="data-section" *ngIf="viewMode === 'table'">
        <nz-table
          #basicTable
          [nzData]="bienLais"
          [nzLoading]="loading"
          [nzShowSizeChanger]="true"
          [nzPageSizeOptions]="[10, 20, 50, 100]"
          [nzShowTotal]="totalTemplate"
          nzBordered>
          <thead>
            <tr>
              <th>STT</th>
              <th>Quyển số</th>
              <th>Số biên lai</th>
              <th>Người đóng</th>
              <th>Mã số BHXH</th>
              <th>Số tiền</th>
              <th>Ngày biên lai</th>
              <th>Mã nhân viên</th>
              <th>Trạng thái</th>
              <th>Tính chất</th>
              <th>Đơn vị</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let data of basicTable.data; let i = index" (click)="showBienLaiDetails(data)" class="clickable-row">
              <td>{{ i + 1 }}</td>
              <td>{{ data.quyen_so }}</td>
              <td>{{ data.so_bien_lai }}</td>
              <td>{{ data.ten_nguoi_dong }}</td>
              <td>{{ data.ma_so_bhxh }}</td>
              <td class="text-right">{{ formatCurrency(data.so_tien) }}</td>
              <td>{{ data.ngay_bien_lai | date:'dd/MM/yyyy' }}</td>
              <td>{{ data.ma_nhan_vien }}</td>
              <td>
                <nz-tag [nzColor]="getTrangThaiColor(data.trang_thai)">
                  {{ getTrangThaiText(data.trang_thai) }}
                </nz-tag>
              </td>
              <td>{{ getTinhChatText(data.tinh_chat) }}</td>
              <td>{{ data.don_vi }}</td>
              <td>
                <a nz-tooltip nzTooltipTitle="Xem chi tiết" (click)="showBienLaiDetails(data); $event.stopPropagation()">
                  <i nz-icon nzType="eye"></i>
                </a>
              </td>
            </tr>
          </tbody>
        </nz-table>
      </div>

      <!-- Hiển thị dạng thẻ -->
      <div class="card-view" *ngIf="viewMode === 'card'">
        <div nz-row [nzGutter]="16">
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6" *ngFor="let data of bienLais">
            <nz-card class="bien-lai-card" [nzActions]="[actionView]" (click)="showBienLaiDetails(data)">
              <nz-card-meta
                [nzTitle]="cardTitle"
                [nzDescription]="cardDescription"
                [nzAvatar]="cardAvatar"
              ></nz-card-meta>
              <ng-template #cardTitle>
                <div class="card-title">
                  <span>{{ data.quyen_so }}-{{ data.so_bien_lai }}</span>
                  <nz-tag [nzColor]="getTrangThaiColor(data.trang_thai)">
                    {{ getTrangThaiText(data.trang_thai) }}
                  </nz-tag>
                </div>
              </ng-template>
              <ng-template #cardDescription>
                <div class="card-description">
                  <p><strong>Người đóng:</strong> {{ data.ten_nguoi_dong }}</p>
                  <p><strong>Mã số BHXH:</strong> {{ data.ma_so_bhxh }}</p>
                  <p><strong>Số tiền:</strong> {{ formatCurrency(data.so_tien) }}</p>
                  <p><strong>Ngày:</strong> {{ data.ngay_bien_lai | date:'dd/MM/yyyy' }}</p>
                </div>
              </ng-template>
              <ng-template #cardAvatar>
                <nz-avatar [nzShape]="'square'" [nzSize]="'large'" [nzIcon]="'file-text'" [style]="{ backgroundColor: getRandomColor() }"></nz-avatar>
              </ng-template>
              <ng-template #actionView>
                <i nz-icon nzType="eye" nzTheme="outline"></i>
              </ng-template>
            </nz-card>
          </div>
        </div>
        <div class="pagination-container">
          <nz-pagination 
            [nzPageIndex]="1" 
            [nzTotal]="bienLais.length" 
            [nzPageSize]="12"
            [nzShowSizeChanger]="true"
            [nzPageSizeOptions]="[12, 24, 48, 96]"
            [nzShowTotal]="totalTemplate">
          </nz-pagination>
        </div>
      </div>

      <!-- Hiển thị dạng thu gọn -->
      <div class="compact-view" *ngIf="viewMode === 'compact'">
        <nz-list [nzDataSource]="bienLais" [nzRenderItem]="item" [nzItemLayout]="'horizontal'" [nzLoading]="loading">
          <ng-template #item let-item>
            <nz-list-item [nzActions]="[viewAction]">
              <ng-template #viewAction>
                <a (click)="showBienLaiDetails(item)"><i nz-icon nzType="eye"></i></a>
              </ng-template>
              <nz-list-item-meta
                [nzAvatar]="avatarTemplate"
                [nzTitle]="titleTemplate"
                [nzDescription]="descriptionTemplate"
              >
                <ng-template #avatarTemplate>
                  <nz-avatar [nzIcon]="'file-text'" [style]="{ backgroundColor: getRandomColor() }"></nz-avatar>
                </ng-template>
                <ng-template #titleTemplate>
                  <div class="compact-title">
                    <span>{{ item.quyen_so }}-{{ item.so_bien_lai }}</span>
                    <nz-tag [nzColor]="getTrangThaiColor(item.trang_thai)">
                      {{ getTrangThaiText(item.trang_thai) }}
                    </nz-tag>
                  </div>
                </ng-template>
                <ng-template #descriptionTemplate>
                  <div class="compact-description">
                    <span>{{ item.ten_nguoi_dong }} | {{ item.ma_so_bhxh }}</span>
                    <span>{{ formatCurrency(item.so_tien) }} | {{ item.ngay_bien_lai | date:'dd/MM/yyyy' }}</span>
                  </div>
                </ng-template>
              </nz-list-item-meta>
            </nz-list-item>
          </ng-template>
        </nz-list>
        <div class="pagination-container">
          <nz-pagination 
            [nzPageIndex]="1" 
            [nzTotal]="bienLais.length" 
            [nzPageSize]="10"
            [nzShowSizeChanger]="true"
            [nzPageSizeOptions]="[10, 20, 50, 100]"
            [nzShowTotal]="totalTemplate">
          </nz-pagination>
        </div>
      </div>

      <ng-template #totalTemplate let-total>
        Tổng cộng {{ total }} bản ghi
      </ng-template>
    </nz-tab>

    <nz-tab nzTitle="Thống kê chi tiết">
      <div class="statistics-detail-section">
        <div nz-row [nzGutter]="16">
          <!-- Thống kê theo nhân viên -->
          <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12">
            <nz-card nzTitle="Thống kê theo nhân viên" [nzExtra]="extraTemplate">
              <nz-table #nhanVienTable [nzData]="thongKeNhanVien" [nzSize]="'small'" [nzShowPagination]="false">
                <thead>
                  <tr>
                    <th>Mã NV</th>
                    <th>Tên nhân viên</th>
                    <th>Số biên lai</th>
                    <th>Tổng tiền</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let data of nhanVienTable.data">
                    <td>{{ data.ma_nhan_vien }}</td>
                    <td>{{ data.ten_nhan_vien }}</td>
                    <td>{{ data.so_bien_lai }}</td>
                    <td class="text-right">{{ formatCurrency(data.tong_tien) }}</td>
                  </tr>
                </tbody>
              </nz-table>
            </nz-card>
          </div>

          <!-- Thống kê theo đơn vị -->
          <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12">
            <nz-card nzTitle="Thống kê theo đơn vị" [nzExtra]="extraTemplate">
              <nz-table #donViTable [nzData]="thongKeDonVi" [nzSize]="'small'" [nzShowPagination]="false">
                <thead>
                  <tr>
                    <th>Đơn vị</th>
                    <th>Số biên lai</th>
                    <th>Tổng tiền</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let data of donViTable.data">
                    <td>{{ data.don_vi }}</td>
                    <td>{{ data.so_bien_lai }}</td>
                    <td class="text-right">{{ formatCurrency(data.tong_tien) }}</td>
                  </tr>
                </tbody>
              </nz-table>
            </nz-card>
          </div>

          <ng-template #extraTemplate>
            <button nz-button nzType="link" nzSize="small">
              <i nz-icon nzType="download"></i>
            </button>
          </ng-template>
        </div>

        <!-- Biểu đồ -->
        <div nz-row [nzGutter]="16" class="chart-section">
          <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12">
            <nz-card nzTitle="Phân bố theo trạng thái">
              <div class="chart-placeholder">
                <div class="chart-legend">
                  <div class="legend-item">
                    <div class="legend-color" style="background-color: #52c41a;"></div>
                    <div class="legend-text">Đã thu: {{ formatCurrency(thongKe.tien_da_thu) }}</div>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color" style="background-color: #faad14;"></div>
                    <div class="legend-text">Chưa thu: {{ formatCurrency(thongKe.tien_chua_thu) }}</div>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color" style="background-color: #f5222d;"></div>
                    <div class="legend-text">Đã hủy: {{ formatCurrency(thongKe.tien_huy) }}</div>
                  </div>
                </div>
                <div class="chart-container">
                  <div class="pie-chart-placeholder">
                    <div class="pie-segment" style="--percentage: {{ getProgressPercent() }}; --color: #52c41a;"></div>
                    <div class="pie-segment" style="--percentage: {{ 100 - getProgressPercent() }}; --color: #faad14;"></div>
                  </div>
                </div>
              </div>
            </nz-card>
          </div>
          <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12">
            <nz-card nzTitle="Xu hướng theo thời gian">
              <div class="chart-placeholder">
                <div class="bar-chart-placeholder">
                  <div *ngFor="let item of bieuDoTheoNgay.slice(0, 10)" class="bar-item">
                    <div class="bar-value" [style.height.%]="item.value / (bieuDoTheoNgay[0].value || 1) * 100"></div>
                    <div class="bar-label">{{ item.name | date:'dd/MM' }}</div>
                  </div>
                </div>
              </div>
            </nz-card>
          </div>
        </div>
      </div>
    </nz-tab>
  </nz-tabset>
</div>

<!-- Drawer chi tiết biên lai -->
<nz-drawer
  [nzVisible]="showBienLaiDetail"
  [nzWidth]="500"
  [nzClosable]="true"
  [nzMaskClosable]="true"
  nzTitle="Chi tiết biên lai"
  (nzOnClose)="closeBienLaiDetail()">
  <ng-container *nzDrawerContent>
    <nz-descriptions *ngIf="selectedBienLai" [nzBordered]="true" [nzColumn]="1">
      <nz-descriptions-item nzTitle="Quyển số">{{ selectedBienLai.quyen_so }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Số biên lai">{{ selectedBienLai.so_bien_lai }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Người đóng">{{ selectedBienLai.ten_nguoi_dong }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Mã số BHXH">{{ selectedBienLai.ma_so_bhxh }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Số tiền">{{ formatCurrency(selectedBienLai.so_tien) }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Ngày biên lai">{{ selectedBienLai.ngay_bien_lai | date:'dd/MM/yyyy' }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Mã nhân viên">{{ selectedBienLai.ma_nhan_vien }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Tên nhân viên">{{ selectedBienLai.ten_nhan_vien }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Trạng thái">
        <nz-tag [nzColor]="getTrangThaiColor(selectedBienLai.trang_thai)">
          {{ getTrangThaiText(selectedBienLai.trang_thai) }}
        </nz-tag>
      </nz-descriptions-item>
      <nz-descriptions-item nzTitle="Tính chất">{{ getTinhChatText(selectedBienLai.tinh_chat) }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Đơn vị">{{ selectedBienLai.don_vi }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Mã hồ sơ">{{ selectedBienLai.ma_ho_so }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Ghi chú">{{ selectedBienLai.ghi_chu }}</nz-descriptions-item>
    </nz-descriptions>

    <div class="drawer-footer">
      <button nz-button nzType="primary" (click)="closeBienLaiDetail()">Đóng</button>
    </div>
  </ng-container>
</nz-drawer>
````

## File: WebApp.Client/src/app/bien-lai/bao-cao-bien-lai/bao-cao-bien-lai.component.scss
````scss
.page-header {
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #f0f0f0;
  
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    
    h2 {
      margin-bottom: 0;
      font-weight: 500;
      font-size: 20px;
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
    }
  }
}

.page-content {
  background-color: #fff;
  padding: 24px;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.09);
  
  ::ng-deep .ant-tabs-nav {
    margin-bottom: 24px;
    
    .ant-tabs-tab {
      padding: 12px 16px;
      transition: all 0.3s;
      
      &:hover {
        color: #1890ff;
      }
      
      &.ant-tabs-tab-active .ant-tabs-tab-btn {
        font-weight: 500;
      }
    }
  }
}

.search-form {
  margin-bottom: 24px;
  
  nz-form-item {
    margin-bottom: 16px;
    width: 100%;
    
    nz-form-label {
      font-weight: 500;
    }
    
    nz-form-control {
      width: 100%;
    }
  }
  
  nz-range-picker, nz-select, input {
    width: 100%;
  }
}

.button-group {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 8px;
  
  button {
    display: flex;
    align-items: center;
    
    i {
      margin-right: 8px;
    }
  }
}

.statistics-section {
  margin-bottom: 24px;
  
  .progress-card {
    margin-bottom: 16px;
    
    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      
      .progress-title {
        font-weight: 500;
      }
      
      .progress-value {
        font-weight: 500;
        color: #1890ff;
      }
    }
    
    .progress-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      color: rgba(0, 0, 0, 0.45);
      font-size: 12px;
    }
  }
  
  .stat-card {
    display: flex;
    flex-direction: row;
    align-items: center;
    margin-bottom: 16px;
    transition: all 0.3s;
    
    &:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .stat-icon {
      font-size: 36px;
      padding: 0 16px 0 0;
      
      i {
        color: rgba(0, 0, 0, 0.45);
      }
    }
    
    .stat-content {
      flex: 1;
      
      .stat-title {
        color: rgba(0, 0, 0, 0.45);
        font-size: 14px;
      }
      
      .stat-value {
        font-size: 24px;
        font-weight: 500;
        line-height: 32px;
      }
      
      .stat-subtitle {
        color: rgba(0, 0, 0, 0.65);
        font-size: 14px;
      }
    }
    
    &.total-card {
      border-top: 3px solid #1890ff;
      
      .stat-icon i {
        color: #1890ff;
      }
    }
    
    &.success-card {
      border-top: 3px solid #52c41a;
      
      .stat-icon i {
        color: #52c41a;
      }
    }
    
    &.warning-card {
      border-top: 3px solid #faad14;
      
      .stat-icon i {
        color: #faad14;
      }
    }
    
    &.danger-card {
      border-top: 3px solid #f5222d;
      
      .stat-icon i {
        color: #f5222d;
      }
    }
  }
}

.data-section {
  .clickable-row {
    cursor: pointer;
    transition: background-color 0.3s;
    
    &:hover {
      background-color: #f5f5f5;
    }
  }
}

.card-view {
  .bien-lai-card {
    margin-bottom: 16px;
    cursor: pointer;
    transition: all 0.3s;
    
    &:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .card-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      
      span {
        font-weight: 500;
      }
    }
    
    .card-description {
      p {
        margin-bottom: 4px;
        
        &:last-child {
          margin-bottom: 0;
        }
      }
    }
  }
  
  .pagination-container {
    margin-top: 16px;
    display: flex;
    justify-content: flex-end;
  }
}

.compact-view {
  .compact-title {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .compact-description {
    display: flex;
    flex-direction: column;
  }
  
  .pagination-container {
    margin-top: 16px;
    display: flex;
    justify-content: flex-end;
  }
  
  ::ng-deep .ant-list-item {
    cursor: pointer;
    transition: background-color 0.3s;
    
    &:hover {
      background-color: #f5f5f5;
    }
  }
}

.statistics-detail-section {
  margin-top: 16px;
  
  nz-card {
    margin-bottom: 16px;
  }
  
  .chart-section {
    margin-top: 16px;
  }
  
  .chart-placeholder {
    height: 300px;
    display: flex;
    flex-direction: column;
    
    .chart-legend {
      display: flex;
      justify-content: space-around;
      margin-bottom: 16px;
      
      .legend-item {
        display: flex;
        align-items: center;
        
        .legend-color {
          width: 16px;
          height: 16px;
          border-radius: 4px;
          margin-right: 8px;
        }
      }
    }
    
    .chart-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .pie-chart-placeholder {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background-color: #f0f0f0;
      position: relative;
      overflow: hidden;
      
      .pie-segment {
        position: absolute;
        width: 100%;
        height: 100%;
        transform-origin: 50% 50%;
        background: conic-gradient(var(--color) calc(var(--percentage) * 1%), transparent 0);
      }
    }
    
    .bar-chart-placeholder {
      width: 100%;
      height: 200px;
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      
      .bar-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 8%;
        
        .bar-value {
          width: 100%;
          background-color: #1890ff;
          border-radius: 4px 4px 0 0;
          transition: height 0.5s ease-in-out;
        }
        
        .bar-label {
          margin-top: 8px;
          font-size: 12px;
          color: rgba(0, 0, 0, 0.45);
        }
      }
    }
  }
}

.drawer-footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  border-top: 1px solid #f0f0f0;
  padding: 10px 16px;
  text-align: right;
  left: 0;
  background: #fff;
}

.text-right {
  text-align: right;
}

nz-table {
  ::ng-deep .ant-table-thead > tr > th {
    background-color: #fafafa;
    font-weight: 500;
  }
}
````

## File: WebApp.Client/src/app/bien-lai/bao-cao-bien-lai/bao-cao-bien-lai.component.ts
````typescript
import { Component, OnInit, AfterViewInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzDatePickerModule } from 'ng-zorro-antd/date-picker';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { NzCardModule } from 'ng-zorro-antd/card';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzTabsModule } from 'ng-zorro-antd/tabs';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzProgressModule } from 'ng-zorro-antd/progress';
import { NzEmptyModule } from 'ng-zorro-antd/empty';
import { NzDrawerModule } from 'ng-zorro-antd/drawer';
import { NzDescriptionsModule } from 'ng-zorro-antd/descriptions';
import { NzToolTipModule } from 'ng-zorro-antd/tooltip';
import { NzRadioModule } from 'ng-zorro-antd/radio';
import { NzAvatarModule } from 'ng-zorro-antd/avatar';
import { NzBadgeModule } from 'ng-zorro-antd/badge';
import { NzSpinModule } from 'ng-zorro-antd/spin';
import { NzAlertModule } from 'ng-zorro-antd/alert';
import { NzPopoverModule } from 'ng-zorro-antd/popover';
import { NzListModule } from 'ng-zorro-antd/list';
import { NzPaginationModule } from 'ng-zorro-antd/pagination';
import { BienLaiService, BangKeBienLai } from '../../services/bien-lai.service';

interface BaoCaoBienLai {
  quyen_so: string;
  so_bien_lai: string;
  ten_nguoi_dong: string;
  ma_so_bhxh: string;
  so_tien: number;
  ngay_bien_lai: Date;
  ma_nhan_vien: string;
  ten_nhan_vien?: string;
  ghi_chu?: string;
  trang_thai: string;
  tinh_chat: string;
  don_vi?: string;
  ma_ho_so?: string;
}

interface ThongKeBienLai {
  tong_so_bien_lai: number;
  tong_so_tien: number;
  bien_lai_da_thu: number;
  tien_da_thu: number;
  bien_lai_chua_thu: number;
  tien_chua_thu: number;
  bien_lai_huy: number;
  tien_huy: number;
}

interface ThongKeNhanVien {
  ma_nhan_vien: string;
  ten_nhan_vien: string;
  so_bien_lai: number;
  tong_tien: number;
}

interface ThongKeDonVi {
  don_vi: string;
  so_bien_lai: number;
  tong_tien: number;
}

interface BieuDoData {
  name: string;
  value: number;
}

@Component({
  selector: 'app-bao-cao-bien-lai',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    NzTableModule,
    NzButtonModule,
    NzIconModule,
    NzDatePickerModule,
    NzInputModule,
    NzGridModule,
    NzFormModule,
    NzSelectModule,
    NzCardModule,
    NzTagModule,
    NzTabsModule,
    NzDividerModule,
    NzProgressModule,
    NzEmptyModule,
    NzDrawerModule,
    NzDescriptionsModule,
    NzToolTipModule,
    NzRadioModule,
    NzAvatarModule,
    NzBadgeModule,
    NzSpinModule,
    NzAlertModule,
    NzPopoverModule,
    NzListModule,
    NzPaginationModule
  ],
  templateUrl: './bao-cao-bien-lai.component.html',
  styleUrls: ['./bao-cao-bien-lai.component.scss']
})
export class BaoCaoBienLaiComponent implements OnInit, AfterViewInit {
  loading = false;
  bienLais: BaoCaoBienLai[] = [];
  thongKe: ThongKeBienLai = {
    tong_so_bien_lai: 0,
    tong_so_tien: 0,
    bien_lai_da_thu: 0,
    tien_da_thu: 0,
    bien_lai_chua_thu: 0,
    tien_chua_thu: 0,
    bien_lai_huy: 0,
    tien_huy: 0
  };
  
  dateRange: Date[] = [];
  searchForm = {
    tuNgay: null as Date | null,
    denNgay: null as Date | null,
    quyenSo: null as string | null,
    maNhanVien: null as string | null,
    trangThai: null as string | null,
    donVi: null as string | null,
    tinhChat: null as string | null,
    maHoSo: null as string | null
  };

  trangThaiOptions = [
    { value: 'all', label: 'Tất cả' },
    { value: 'da_thu', label: 'Đã thu' },
    { value: 'chua_thu', label: 'Chưa thu' },
    { value: 'huy', label: 'Đã hủy' }
  ];

  tinhChatOptions = [
    { value: 'all', label: 'Tất cả' },
    { value: 'bhyt', label: 'BHYT' },
    { value: 'bhxh', label: 'BHXH' },
    { value: 'bhtn', label: 'BHTN' }
  ];

  bieuDoTrangThai: BieuDoData[] = [];
  bieuDoTheoNgay: BieuDoData[] = [];

  // Thống kê theo nhân viên và đơn vị
  thongKeNhanVien: ThongKeNhanVien[] = [];
  thongKeDonVi: ThongKeDonVi[] = [];

  // Hiển thị bộ lọc nâng cao
  showAdvancedFilter = false;

  // Tab hiện tại
  activeTab = 0;

  // Chế độ xem
  viewMode = 'table'; // 'table', 'card', 'compact'

  // Chi tiết biên lai
  selectedBienLai: BaoCaoBienLai | null = null;
  showBienLaiDetail = false;

  constructor(
    private bienLaiService: BienLaiService,
    private message: NzMessageService
  ) {}

  ngOnInit(): void {
    // Khởi tạo ngày mặc định (30 ngày gần nhất)
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    this.dateRange = [thirtyDaysAgo, today];
    this.searchForm.tuNgay = thirtyDaysAgo;
    this.searchForm.denNgay = today;
    
    this.loadData();
  }

  ngAfterViewInit(): void {
    // Khởi tạo biểu đồ sau khi view đã được tạo
    setTimeout(() => {
      this.initCharts();
    }, 500);
  }

  onDateRangeChange(dates: Date[]): void {
    if (dates && dates.length === 2) {
      this.searchForm.tuNgay = dates[0];
      this.searchForm.denNgay = dates[1];
    } else {
      this.searchForm.tuNgay = null;
      this.searchForm.denNgay = null;
    }
  }

  loadData(): void {
    this.loading = true;
    const params = {
      ...this.searchForm,
      quyenSo: this.searchForm.quyenSo || undefined,
      maNhanVien: this.searchForm.maNhanVien || undefined,
      trangThai: this.searchForm.trangThai === 'all' ? undefined : this.searchForm.trangThai,
      donVi: this.searchForm.donVi || undefined,
      tinhChat: this.searchForm.tinhChat === 'all' ? undefined : this.searchForm.tinhChat,
      maHoSo: this.searchForm.maHoSo || undefined
    };

    this.bienLaiService.getBangKeBienLai(params).subscribe({
      next: (data) => {
        this.bienLais = data;
        this.tinhThongKe(data);
        this.tinhThongKeNhanVien(data);
        this.tinhThongKeDonVi(data);
        this.taoDataBieuDo(data);
        this.updateCharts();
        this.loading = false;
      },
      error: (error) => {
        console.error('Lỗi khi tải dữ liệu:', error);
        this.message.error('Có lỗi xảy ra khi tải dữ liệu');
        this.loading = false;
      }
    });
  }

  tinhThongKe(data: BangKeBienLai[]): void {
    this.thongKe = {
      tong_so_bien_lai: data.length,
      tong_so_tien: data.reduce((sum, item) => sum + item.so_tien, 0),
      bien_lai_da_thu: data.filter(item => item.trang_thai === 'da_thu').length,
      tien_da_thu: data.filter(item => item.trang_thai === 'da_thu')
                       .reduce((sum, item) => sum + item.so_tien, 0),
      bien_lai_chua_thu: data.filter(item => item.trang_thai === 'chua_thu').length,
      tien_chua_thu: data.filter(item => item.trang_thai === 'chua_thu')
                         .reduce((sum, item) => sum + item.so_tien, 0),
      bien_lai_huy: data.filter(item => item.trang_thai === 'huy').length,
      tien_huy: data.filter(item => item.trang_thai === 'huy')
                    .reduce((sum, item) => sum + item.so_tien, 0)
    };
  }

  tinhThongKeNhanVien(data: BangKeBienLai[]): void {
    // Nhóm dữ liệu theo mã nhân viên
    const nhanVienMap = new Map<string, ThongKeNhanVien>();
    
    data.forEach(item => {
      if (!item.ma_nhan_vien) return;
      
      if (nhanVienMap.has(item.ma_nhan_vien)) {
        const nv = nhanVienMap.get(item.ma_nhan_vien)!;
        nv.so_bien_lai += 1;
        nv.tong_tien += item.so_tien;
      } else {
        nhanVienMap.set(item.ma_nhan_vien, {
          ma_nhan_vien: item.ma_nhan_vien,
          ten_nhan_vien: item.ten_nhan_vien || 'Không xác định',
          so_bien_lai: 1,
          tong_tien: item.so_tien
        });
      }
    });
    
    // Chuyển Map thành mảng và sắp xếp theo tổng tiền giảm dần
    this.thongKeNhanVien = Array.from(nhanVienMap.values())
      .sort((a, b) => b.tong_tien - a.tong_tien);
  }

  tinhThongKeDonVi(data: BangKeBienLai[]): void {
    // Nhóm dữ liệu theo đơn vị
    const donViMap = new Map<string, ThongKeDonVi>();
    
    data.forEach(item => {
      const donVi = item.don_vi || 'Không xác định';
      
      if (donViMap.has(donVi)) {
        const dv = donViMap.get(donVi)!;
        dv.so_bien_lai += 1;
        dv.tong_tien += item.so_tien;
      } else {
        donViMap.set(donVi, {
          don_vi: donVi,
          so_bien_lai: 1,
          tong_tien: item.so_tien
        });
      }
    });
    
    // Chuyển Map thành mảng và sắp xếp theo tổng tiền giảm dần
    this.thongKeDonVi = Array.from(donViMap.values())
      .sort((a, b) => b.tong_tien - a.tong_tien);
  }

  taoDataBieuDo(data: BangKeBienLai[]): void {
    // Dữ liệu cho biểu đồ trạng thái
    this.bieuDoTrangThai = [
      { name: 'Đã thu', value: this.thongKe.tien_da_thu },
      { name: 'Chưa thu', value: this.thongKe.tien_chua_thu },
      { name: 'Đã hủy', value: this.thongKe.tien_huy }
    ];
    
    // Dữ liệu cho biểu đồ theo ngày
    const ngayMap = new Map<string, number>();
    
    data.forEach(item => {
      const ngay = new Date(item.ngay_bien_lai).toISOString().split('T')[0];
      
      if (ngayMap.has(ngay)) {
        ngayMap.set(ngay, ngayMap.get(ngay)! + item.so_tien);
      } else {
        ngayMap.set(ngay, item.so_tien);
      }
    });
    
    // Chuyển Map thành mảng và sắp xếp theo ngày
    this.bieuDoTheoNgay = Array.from(ngayMap.entries())
      .map(([name, value]) => ({ name, value }))
      .sort((a, b) => a.name.localeCompare(b.name));
  }

  initCharts(): void {
    // Khởi tạo biểu đồ (sẽ được triển khai bằng thư viện biểu đồ)
    console.log('Khởi tạo biểu đồ');
  }

  updateCharts(): void {
    // Cập nhật dữ liệu biểu đồ
    console.log('Cập nhật biểu đồ');
  }

  resetForm(): void {
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    this.searchForm = {
      tuNgay: thirtyDaysAgo,
      denNgay: today,
      quyenSo: null,
      maNhanVien: null,
      trangThai: null,
      donVi: null,
      tinhChat: null,
      maHoSo: null
    };
    this.dateRange = [thirtyDaysAgo, today];
    this.loadData();
  }

  onSearch(): void {
    this.loadData();
  }

  exportToExcel(): void {
    this.loading = true;
    const params = {
      ...this.searchForm,
      quyenSo: this.searchForm.quyenSo || undefined,
      maNhanVien: this.searchForm.maNhanVien || undefined,
      trangThai: this.searchForm.trangThai === 'all' ? undefined : this.searchForm.trangThai,
      donVi: this.searchForm.donVi || undefined,
      tinhChat: this.searchForm.tinhChat === 'all' ? undefined : this.searchForm.tinhChat,
      maHoSo: this.searchForm.maHoSo || undefined
    };

    this.bienLaiService.exportBangKeBienLai(params).subscribe({
      next: (data: Blob) => {
        const url = window.URL.createObjectURL(data);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bao-cao-bien-lai-${new Date().getTime()}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        this.loading = false;
        this.message.success('Xuất Excel thành công');
      },
      error: (error) => {
        console.error('Lỗi khi xuất Excel:', error);
        this.message.error('Có lỗi xảy ra khi xuất Excel');
        this.loading = false;
      }
    });
  }

  exportBC01(): void {
    this.loading = true;
    const params = {
      ...this.searchForm,
      quyenSo: this.searchForm.quyenSo || undefined,
      maNhanVien: this.searchForm.maNhanVien || undefined,
      trangThai: this.searchForm.trangThai === 'all' ? undefined : this.searchForm.trangThai,
      donVi: this.searchForm.donVi || undefined,
      tinhChat: this.searchForm.tinhChat === 'all' ? undefined : this.searchForm.tinhChat,
      maHoSo: this.searchForm.maHoSo || undefined,
      mauBaoCao: 'BC01'
    };

    this.bienLaiService.exportBaoCaoBC01(params).subscribe({
      next: (data: Blob) => {
        const url = window.URL.createObjectURL(data);
        const a = document.createElement('a');
        a.href = url;
        const monthYear = this.getMonthYearString();
        a.download = `BC01-Bang-Ke-BHYT-BHXH-${monthYear}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        this.loading = false;
        this.message.success('Xuất báo cáo BC01 thành công');
      },
      error: (error: any) => {
        console.error('Lỗi khi xuất báo cáo BC01:', error);
        this.message.error('Có lỗi xảy ra khi xuất báo cáo BC01. Tính năng này đang được phát triển.');
        this.loading = false;
      }
    });
  }

  private getMonthYearString(): string {
    const now = this.dateRange.length > 0 && this.dateRange[0] 
      ? new Date(this.dateRange[0]) 
      : new Date();
    
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const year = now.getFullYear();
    
    return `${month}-${year}`;
  }

  exportToPdf(): void {
    this.message.info('Tính năng đang được phát triển');
    // Triển khai xuất PDF
  }

  printReport(): void {
    this.message.info('Tính năng đang được phát triển');
    // Triển khai in báo cáo
  }

  toggleAdvancedFilter(): void {
    this.showAdvancedFilter = !this.showAdvancedFilter;
  }

  changeViewMode(mode: string): void {
    this.viewMode = mode;
  }

  showBienLaiDetails(bienLai: BaoCaoBienLai): void {
    this.selectedBienLai = bienLai;
    this.showBienLaiDetail = true;
  }

  closeBienLaiDetail(): void {
    this.showBienLaiDetail = false;
    this.selectedBienLai = null;
  }

  changeTab(tabIndex: number): void {
    this.activeTab = tabIndex;
    
    // Cập nhật biểu đồ khi chuyển tab
    if (tabIndex === 1) {
      setTimeout(() => this.updateCharts(), 100);
    }
  }

  formatCurrency(value: number): string {
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
  }

  getTrangThaiText(trangThai: string): string {
    switch (trangThai) {
      case 'da_thu':
        return 'Đã thu';
      case 'chua_thu':
        return 'Chưa thu';
      case 'huy':
        return 'Đã hủy';
      default:
        return trangThai;
    }
  }

  getTinhChatText(tinhChat: string): string {
    switch (tinhChat) {
      case 'bhyt':
        return 'BHYT';
      case 'bhxh':
        return 'BHXH';
      case 'bhtn':
        return 'BHTN';
      default:
        return tinhChat;
    }
  }

  getTrangThaiColor(trangThai: string): string {
    switch (trangThai) {
      case 'da_thu':
        return 'success';
      case 'chua_thu':
        return 'warning';
      case 'huy':
        return 'error';
      default:
        return 'default';
    }
  }
  
  getRandomColor(): string {
    const colors = ['#1890ff', '#52c41a', '#faad14', '#f5222d', '#722ed1', '#13c2c2', '#eb2f96'];
    return colors[Math.floor(Math.random() * colors.length)];
  }
  
  getProgressPercent(): number {
    if (this.thongKe.tong_so_tien === 0) return 0;
    return Math.round((this.thongKe.tien_da_thu / this.thongKe.tong_so_tien) * 100);
  }
}
````

## File: WebApp.Client/src/app/bien-lai/bien-lai-dien-tu/quan-ly-bien-lai-dien-tu/quan-ly-bien-lai-dien-tu.component.html
````html
<div class="container">
  <div class="page-header">
    <h2>Quản lý biên lai điện tử</h2>
    <button nz-button nzType="primary" (click)="showAddModal()">
      <i nz-icon nzType="plus"></i> Thêm biên lai điện tử
    </button>
  </div>

  <nz-table #basicTable [nzData]="bienLais" [nzLoading]="isLoading" [nzBordered]="true">
    <thead>
      <tr>
        <th>STT</th>
        <th>Ký hiệu</th>
        <th>Số biên lai</th>
        <th>Người đóng</th>
        <th>Mã số BHXH</th>
        <th>Số tiền</th>
        <th>Ngày tạo</th>
        <th>Tính chất</th>
        <th>Thao tác</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of basicTable.data; let i = index">
        <td>{{ i + 1 }}</td>
        <td>{{ item.ky_hieu }}</td>
        <td>{{ item.so_bien_lai }}</td>
        <td>{{ item.ten_nguoi_dong }}</td>
        <td>{{ item.ma_so_bhxh }}</td>
        <td>{{ item.so_tien | number:'1.0-0' }} đ</td>
        <td>{{ item.ngay_tao | date:'dd/MM/yyyy' }}</td>
        <td>
          <nz-tag [nzColor]="item.tinh_chat === 'bien_lai_goc' ? 'green' : 'red'">
            {{ getTinhChatText(item.tinh_chat) }}
          </nz-tag>
        </td>
        <td>
          <button nz-button nzType="primary" nzSize="small" (click)="showEditModal(item.id!)">
            <i nz-icon nzType="edit"></i>
          </button>
          <nz-divider nzType="vertical"></nz-divider>
          <button nz-button nzType="primary" nzDanger nzSize="small" (click)="deleteBienLai(item.id!)">
            <i nz-icon nzType="delete"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </nz-table>

  <nz-modal
    [(nzVisible)]="isVisible"
    [nzTitle]="editingId ? 'Chỉnh sửa biên lai điện tử' : 'Thêm biên lai điện tử'"
    [nzOkText]="editingId ? 'Cập nhật' : 'Thêm'"
    nzCancelText="Hủy"
    (nzOnCancel)="handleCancel()"
    (nzOnOk)="handleSubmit()"
    [nzOkLoading]="isSubmitting"
    [nzBodyStyle]="{ maxHeight: '400px', overflow: 'auto' }"
  >
    <div *nzModalContent>
      <form nz-form [formGroup]="form">
        <nz-form-item *ngIf="!editingId">
          <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Quyển biên lai</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui lòng chọn quyển biên lai">
            <nz-select formControlName="quyen_bien_lai_dien_tu_id" nzPlaceHolder="Chọn quyển biên lai">
              <nz-option 
                *ngFor="let quyen of quyenBienLais" 
                [nzValue]="quyen.id" 
                [nzLabel]="quyen.ky_hieu + ' (' + quyen.so_hien_tai + ')'">
              </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Người đóng</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui lòng nhập tên người đóng">
            <input nz-input formControlName="ten_nguoi_dong" />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Số tiền</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui lòng nhập số tiền">
            <nz-input-number formControlName="so_tien" [nzMin]="0" [nzStep]="1000" [nzFormatter]="formatterVND" style="width: 100%;"></nz-input-number>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24">Ghi chú</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24">
            <textarea nz-input formControlName="ghi_chu" rows="4"></textarea>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Mã số BHXH</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui lòng nhập mã số BHXH">
            <input nz-input formControlName="ma_so_bhxh" />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Mã nhân viên</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui lòng nhập mã nhân viên">
            <input nz-input formControlName="ma_nhan_vien" />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Mã cơ quan BHXH</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui lòng nhập mã cơ quan BHXH">
            <input nz-input formControlName="ma_co_quan_bhxh" />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Mã số BHXH đơn vị</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui lòng nhập mã số BHXH đơn vị">
            <input nz-input formControlName="ma_so_bhxh_don_vi" />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24">Loại</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24">
            <nz-checkbox-group>
              <label nz-checkbox formControlName="is_bhyt">BHYT</label>
              <label nz-checkbox formControlName="is_bhxh">BHXH</label>
            </nz-checkbox-group>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24">Tính chất</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24">
            <nz-radio-group formControlName="tinh_chat">
              <label nz-radio value="bien_lai_goc">Biên lai gốc</label>
              <label nz-radio value="bien_lai_huy_bo">Biên lai hủy bỏ</label>
            </nz-radio-group>
          </nz-form-control>
        </nz-form-item>
      </form>
    </div>
  </nz-modal>
</div>
````

## File: WebApp.Client/src/app/bien-lai/bien-lai-dien-tu/quan-ly-bien-lai-dien-tu/quan-ly-bien-lai-dien-tu.component.scss
````scss
.container {
  padding: 20px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.status-pending {
  background-color: #faad14;
  color: white;
}

.status-active {
  background-color: #52c41a;
  color: white;
}

.status-completed {
  background-color: #1890ff;
  color: white;
}

nz-input-number {
  width: 100%;
}

.checkbox-group {
  display: flex;
  gap: 20px;
}
````

## File: WebApp.Client/src/app/bien-lai/bien-lai-dien-tu/quan-ly-bien-lai-dien-tu/quan-ly-bien-lai-dien-tu.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzModalService } from 'ng-zorro-antd/modal';
import { BienLaiDienTuService } from '../../../services/bien-lai-dien-tu.service';
import { BienLaiDienTu, QuyenBienLaiDienTu } from '../../models/bien-lai-dien-tu.model';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzInputNumberModule } from 'ng-zorro-antd/input-number';
import { NzCheckboxModule } from 'ng-zorro-antd/checkbox';
import { NzRadioModule } from 'ng-zorro-antd/radio';
import { catchError, of } from 'rxjs';

@Component({
  selector: 'app-quan-ly-bien-lai-dien-tu',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule, 
    ReactiveFormsModule,
    NzTableModule,
    NzButtonModule,
    NzFormModule,
    NzInputModule,
    NzSelectModule,
    NzModalModule,
    NzTagModule,
    NzIconModule,
    NzDividerModule,
    NzInputNumberModule,
    NzCheckboxModule,
    NzRadioModule
  ],
  templateUrl: './quan-ly-bien-lai-dien-tu.component.html',
  styleUrls: ['./quan-ly-bien-lai-dien-tu.component.scss']
})
export class QuanLyBienLaiDienTuComponent implements OnInit {
  bienLais: BienLaiDienTu[] = [];
  quyenBienLais: QuyenBienLaiDienTu[] = [];
  isLoading = false;
  isVisible = false;
  isSubmitting = false;
  form!: FormGroup;
  editingId: number | null = null;
  currentBienLai: BienLaiDienTu | null = null;

  constructor(
    private bienLaiDienTuService: BienLaiDienTuService,
    private fb: FormBuilder,
    private message: NzMessageService,
    private modal: NzModalService
  ) { }

  ngOnInit(): void {
    this.initForm();
    this.loadBienLais();
    this.loadQuyenBienLais();
  }

  // Hàm định dạng tiền VND
  formatterVND = (value: number): string => {
    return `${value} đ`;
  }

  initForm(): void {
    this.form = this.fb.group({
      quyen_bien_lai_dien_tu_id: [null, [Validators.required]],
      ten_nguoi_dong: ['', [Validators.required]],
      so_tien: [0, [Validators.required, Validators.min(0)]],
      ghi_chu: [''],
      ma_so_bhxh: ['', [Validators.required]],
      ma_nhan_vien: ['', [Validators.required]],
      ma_co_quan_bhxh: ['', [Validators.required]],
      ma_so_bhxh_don_vi: ['', [Validators.required]],
      is_bhyt: [true],
      is_bhxh: [false],
      tinh_chat: ['bien_lai_goc']
    });
  }

  loadBienLais(): void {
    this.isLoading = true;
    this.bienLaiDienTuService.getBienLais()
      .pipe(
        catchError(error => {
          console.error('Lỗi khi tải danh sách biên lai điện tử:', error);
          this.message.error('Có lỗi khi tải danh sách biên lai điện tử');
          this.isLoading = false;
          return of([]);
        })
      )
      .subscribe({
        next: (data: BienLaiDienTu[]) => {
          this.bienLais = data;
          this.isLoading = false;
        }
      });
  }

  loadQuyenBienLais(): void {
    this.bienLaiDienTuService.getQuyenBienLais()
      .pipe(
        catchError(error => {
          console.error('Lỗi khi tải danh sách quyển biên lai điện tử:', error);
          this.message.error('Có lỗi khi tải danh sách quyển biên lai điện tử');
          return of([]);
        })
      )
      .subscribe({
        next: (data: QuyenBienLaiDienTu[]) => {
          // Lọc chỉ lấy các quyển biên lai có thể sử dụng
          this.quyenBienLais = data.filter((q: QuyenBienLaiDienTu) => q.trang_thai !== 'da_su_dung_het');
        }
      });
  }

  showAddModal(): void {
    this.editingId = null;
    this.form.reset();
    this.form.patchValue({
      tinh_chat: 'bien_lai_goc',
      is_bhyt: true,
      is_bhxh: false,
      so_tien: 0
    });
    this.isVisible = true;
  }

  showEditModal(id: number): void {
    this.isLoading = true;
    this.bienLaiDienTuService.getBienLaiById(id)
      .pipe(
        catchError(error => {
          console.error('Lỗi khi tải thông tin biên lai điện tử:', error);
          this.message.error('Có lỗi khi tải thông tin biên lai điện tử');
          this.isLoading = false;
          return of(null);
        })
      )
      .subscribe({
        next: (data: BienLaiDienTu | null) => {
          if (data) {
            this.currentBienLai = data;
            this.editingId = id;
            this.form.patchValue({
              quyen_bien_lai_dien_tu_id: data.quyen_bien_lai_dien_tu_id,
              ten_nguoi_dong: data.ten_nguoi_dong,
              so_tien: data.so_tien,
              ghi_chu: data.ghi_chu,
              ma_so_bhxh: data.ma_so_bhxh,
              ma_nhan_vien: data.ma_nhan_vien,
              ma_co_quan_bhxh: data.ma_co_quan_bhxh,
              ma_so_bhxh_don_vi: data.ma_so_bhxh_don_vi,
              is_bhyt: data.is_bhyt,
              is_bhxh: data.is_bhxh,
              tinh_chat: data.tinh_chat
            });
            this.isVisible = true;
          }
          this.isLoading = false;
        }
      });
  }

  handleCancel(): void {
    this.isVisible = false;
  }

  handleSubmit(): void {
    if (this.form.invalid) {
      Object.values(this.form.controls).forEach(control => {
        if (control.invalid) {
          control.markAsDirty();
          control.updateValueAndValidity();
        }
      });
      return;
    }

    this.isSubmitting = true;
    const formData = this.form.value;

    if (this.editingId) {
      // Cập nhật biên lai
      this.bienLaiDienTuService.updateBienLai(this.editingId, formData).subscribe({
        next: () => {
          this.message.success('Cập nhật biên lai điện tử thành công');
          this.isVisible = false;
          this.isSubmitting = false;
          this.loadBienLais();
        },
        error: (error: any) => {
          console.error('Lỗi khi cập nhật biên lai điện tử:', error);
          this.message.error('Có lỗi khi cập nhật biên lai điện tử');
          this.isSubmitting = false;
        }
      });
    } else {
      // Thêm biên lai mới
      this.bienLaiDienTuService.createBienLai(formData).subscribe({
        next: (response: any) => {
          this.message.success('Thêm biên lai điện tử thành công');
          this.isVisible = false;
          this.isSubmitting = false;
          this.loadBienLais();
          this.loadQuyenBienLais(); // Cập nhật lại danh sách quyển biên lai
        },
        error: (error: any) => {
          console.error('Lỗi khi thêm biên lai điện tử:', error);
          this.message.error(error.error?.message || 'Có lỗi khi thêm biên lai điện tử');
          this.isSubmitting = false;
        }
      });
    }
  }

  deleteBienLai(id: number): void {
    this.modal.confirm({
      nzTitle: 'Xác nhận xóa',
      nzContent: 'Bạn có chắc chắn muốn xóa biên lai điện tử này?',
      nzOkText: 'Xóa',
      nzOkType: 'primary',
      nzOkDanger: true,
      nzOnOk: () => {
        this.isLoading = true;
        this.bienLaiDienTuService.deleteBienLai(id).subscribe({
          next: () => {
            this.message.success('Xóa biên lai điện tử thành công');
            this.loadBienLais();
          },
          error: (error: any) => {
            console.error('Lỗi khi xóa biên lai điện tử:', error);
            this.message.error('Có lỗi khi xóa biên lai điện tử');
            this.isLoading = false;
          }
        });
      }
    });
  }

  // Trạng thái sang văn bản có thể đọc
  getTinhChatText(tinhChat: string | undefined): string {
    switch (tinhChat) {
      case 'bien_lai_goc':
        return 'Biên lai gốc';
      case 'bien_lai_huy_bo':
        return 'Biên lai hủy bỏ';
      default:
        return tinhChat || 'Không xác định';
    }
  }
}
````

## File: WebApp.Client/src/app/bien-lai/bien-lai-dien-tu/bien-lai-dien-tu.module.ts
````typescript
import { NgModule } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { RouterModule, Routes } from '@angular/router';

import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { NzDatePickerModule } from 'ng-zorro-antd/date-picker';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzMessageModule } from 'ng-zorro-antd/message';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzInputNumberModule } from 'ng-zorro-antd/input-number';
import { NzCheckboxModule } from 'ng-zorro-antd/checkbox';
import { NzRadioModule } from 'ng-zorro-antd/radio';
import { NzSpaceModule } from 'ng-zorro-antd/space';

import { QuyenBienLaiDienTuComponent } from '../quyen-bien-lai-dien-tu/quyen-bien-lai-dien-tu.component';
import { QuanLyBienLaiDienTuComponent } from './quan-ly-bien-lai-dien-tu/quan-ly-bien-lai-dien-tu.component';

const routes: Routes = [
  { path: 'quan-ly', component: QuanLyBienLaiDienTuComponent },
  { path: 'quyen-bien-lai', component: QuyenBienLaiDienTuComponent },
  { path: '', redirectTo: 'quan-ly', pathMatch: 'full' }
];

@NgModule({
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    RouterModule.forChild(routes),
    NzTableModule,
    NzButtonModule,
    NzFormModule,
    NzInputModule,
    NzSelectModule,
    NzDatePickerModule,
    NzModalModule,
    NzMessageModule,
    NzTagModule,
    NzIconModule,
    NzDividerModule,
    NzInputNumberModule,
    NzCheckboxModule,
    NzRadioModule,
    NzSpaceModule,
    QuyenBienLaiDienTuComponent,
    QuanLyBienLaiDienTuComponent
  ]
})
export class BienLaiDienTuModule { }
````

## File: WebApp.Client/src/app/bien-lai/cap-phat-bien-lai/cap-phat-bien-lai.component.ts
````typescript
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzSelectModule } from 'ng-zorro-antd/select';

@Component({
  selector: 'app-cap-phat-bien-lai',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    NzFormModule,
    NzInputModule,
    NzButtonModule,
    NzSelectModule
  ],
  template: `
    <div class="page-header">
      <h2>Cấp phát biên lai</h2>
    </div>
    <div class="page-content">
      <!-- Content here -->
    </div>
  `
})
export class CapPhatBienLaiComponent {
  // Component logic
}
````

## File: WebApp.Client/src/app/bien-lai/danh-sach-bien-lai/danh-sach-bien-lai.component.ts
````typescript
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';

@Component({
  selector: 'app-danh-sach-bien-lai',
  standalone: true,
  imports: [CommonModule, NzTableModule, NzButtonModule],
  template: `
    <div class="page-header">
      <h2>Danh sách biên lai</h2>
    </div>
    <div class="page-content">
      <!-- Content here -->
    </div>
  `
})
export class DanhSachBienLaiComponent {
  // Component logic
}
````

## File: WebApp.Client/src/app/bien-lai/models/bien-lai-dien-tu.model.ts
````typescript
export interface QuyenBienLaiDienTu {
  id?: number;
  ky_hieu: string;
  tu_so: string;
  den_so: string;
  so_hien_tai?: string;
  nguoi_cap: string;
  ngay_cap?: string;
  ngay_tao?: string;
  trang_thai?: string;
  ma_co_quan_bhxh: string;
}

export interface QuyenBienLaiDienTuResponse {
  id: number;
  ky_hieu: string;
  tu_so: string;
  den_so: string;
  so_hien_tai: string;
  nguoi_cap: string;
  ngay_cap: string;
  ngay_tao: string;
  trang_thai: string;
  ma_co_quan_bhxh: string;
}

export interface BienLaiDienTu {
  id?: number;
  quyen_bien_lai_dien_tu_id: number;
  ky_hieu?: string;
  so_bien_lai?: string;
  ten_nguoi_dong: string;
  so_tien: number;
  ghi_chu?: string;
  ma_so_bhxh: string;
  ma_nhan_vien: string;
  ma_co_quan_bhxh: string;
  ma_so_bhxh_don_vi: string;
  is_bhyt: boolean;
  is_bhxh: boolean;
  tinh_chat: string;
  ngay_tao?: string;
  nguoi_tao_id?: number;
}

export interface BienLaiDienTuResponse {
  id: number;
  quyen_bien_lai_dien_tu_id: number;
  ky_hieu: string;
  so_bien_lai: string;
  ten_nguoi_dong: string;
  so_tien: number;
  ghi_chu: string;
  ma_so_bhxh: string;
  ma_nhan_vien: string;
  ma_co_quan_bhxh: string;
  ma_so_bhxh_don_vi: string;
  is_bhyt: boolean;
  is_bhxh: boolean;
  tinh_chat: string;
  ngay_tao: string;
  nguoi_tao_id: number;
}
````

## File: WebApp.Client/src/app/bien-lai/models/quyen-bien-lai.model.ts
````typescript
export interface QuyenBienLai {
  quyenSo: string;
  trangThai: 'Đang sử dụng' | 'Đã hết' | 'Đã hủy';
  tuSo: string;
  denSo: string;
  soHienTai: string;
  soLuongBienLai: number;
  nguoiThu: string;
  nguoiCap: string;
  ngayCap: Date | string;
  tienDoSuDung: number; // Phần trăm đã sử dụng
  soLuongDaSuDung?: number; // Số lượng biên lai đã sử dụng
}
````

## File: WebApp.Client/src/app/bien-lai/quyen-bien-lai/chi-tiet-quyen-bien-lai/chi-tiet-quyen-bien-lai.component.html
````html
<nz-modal
  [nzVisible]="isVisible"
  [nzTitle]="'Chi tiết quyền biên lai'"
  [nzFooter]="null"
  (nzOnCancel)="handleCancel()"
  [nzWidth]="700"
>
  <ng-container *nzModalContent>
    <div class="chi-tiet-quyen-bien-lai">
      <!-- Thông tin chính -->
      <div nz-row [nzGutter]="16">
        <!-- Cột trái -->
        <div nz-col [nzSpan]="12">
          <div class="thong-tin-item">
            <div class="label">Quyền số</div>
            <div class="value">{{ quyenBienLai?.quyenSo }}</div>
          </div>
          
          <div class="thong-tin-item">
            <div class="label">Từ số</div>
            <div class="value">{{ quyenBienLai?.tuSo }}</div>
          </div>
          
          <div class="thong-tin-item">
            <div class="label">Số hiện tại</div>
            <div class="value">{{ quyenBienLai?.soHienTai }}</div>
          </div>
          
          <div class="thong-tin-item">
            <div class="label">Người thu</div>
            <div class="value">
              <nz-avatar nzIcon="user" [nzSize]="24"></nz-avatar>
              <span class="ml-2">{{ quyenBienLai?.nguoiThu }}</span>
            </div>
          </div>
          
          <div class="thong-tin-item">
            <div class="label">Ngày cấp</div>
            <div class="value">{{ quyenBienLai?.ngayCap | date:'dd/MM/yyyy HH:mm' }}</div>
          </div>
        </div>
        
        <!-- Cột phải -->
        <div nz-col [nzSpan]="12">
          <div class="thong-tin-item">
            <div class="label">Trạng thái</div>
            <div class="value">
              <nz-tag [nzColor]="'success'" *ngIf="quyenBienLai?.trangThai === 'Đang sử dụng'">
                <span nz-icon nzType="check-circle" nzTheme="outline"></span> {{ quyenBienLai?.trangThai }}
              </nz-tag>
              <nz-tag [nzColor]="'default'" *ngIf="quyenBienLai?.trangThai === 'Đã hết'">
                {{ quyenBienLai?.trangThai }}
              </nz-tag>
              <nz-tag [nzColor]="'error'" *ngIf="quyenBienLai?.trangThai === 'Đã hủy'">
                {{ quyenBienLai?.trangThai }}
              </nz-tag>
            </div>
          </div>
          
          <div class="thong-tin-item">
            <div class="label">Đến số</div>
            <div class="value">{{ quyenBienLai?.denSo }}</div>
          </div>
          
          <div class="thong-tin-item">
            <div class="label">Số lượng biên lai</div>
            <div class="value">{{ quyenBienLai?.soLuongBienLai }}</div>
          </div>
          
          <div class="thong-tin-item">
            <div class="label">Người cấp</div>
            <div class="value">{{ quyenBienLai?.nguoiCap }}</div>
          </div>
        </div>
      </div>
      
      <!-- Tiến độ sử dụng -->
      <div class="tien-do-container">
        <h3 class="tien-do-title">Tiến độ sử dụng</h3>
        <nz-progress 
          [nzPercent]="quyenBienLai?.tienDoSuDung || 0" 
          [nzStatus]="'active'"
          [nzStrokeColor]="'#52c41a'"
        ></nz-progress>
        <div class="tien-do-info">
          {{ quyenBienLai?.tienDoSuDung || 0 }}% ({{ getSoLuongDaSuDung() }})
        </div>
      </div>
    </div>
  </ng-container>
</nz-modal>
````

## File: WebApp.Client/src/app/bien-lai/quyen-bien-lai/chi-tiet-quyen-bien-lai/chi-tiet-quyen-bien-lai.component.scss
````scss
.chi-tiet-quyen-bien-lai {
  padding: 16px 0;
  
  .thong-tin-item {
    display: flex;
    margin-bottom: 16px;
    border-bottom: 1px solid #f0f0f0;
    padding-bottom: 8px;
    
    .label {
      width: 140px;
      color: #8c8c8c;
      font-size: 14px;
    }
    
    .value {
      flex: 1;
      font-weight: 500;
      display: flex;
      align-items: center;
      
      .ml-2 {
        margin-left: 8px;
      }
    }
  }
  
  .tien-do-container {
    margin-top: 24px;
    
    .tien-do-title {
      font-size: 16px;
      margin-bottom: 16px;
      color: #262626;
    }
    
    .tien-do-info {
      text-align: right;
      margin-top: 8px;
      color: #595959;
      font-size: 14px;
    }
  }
}
````

## File: WebApp.Client/src/app/bien-lai/quyen-bien-lai/chi-tiet-quyen-bien-lai/chi-tiet-quyen-bien-lai.component.ts
````typescript
import { Component, Input, OnInit, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzProgressModule } from 'ng-zorro-antd/progress';
import { NzAvatarModule } from 'ng-zorro-antd/avatar';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { QuyenBienLai } from '../../models/quyen-bien-lai.model';

@Component({
  selector: 'app-chi-tiet-quyen-bien-lai',
  templateUrl: './chi-tiet-quyen-bien-lai.component.html',
  styleUrls: ['./chi-tiet-quyen-bien-lai.component.scss'],
  standalone: true,
  imports: [
    CommonModule,
    NzModalModule,
    NzGridModule,
    NzTagModule,
    NzProgressModule,
    NzAvatarModule,
    NzIconModule
  ]
})
export class ChiTietQuyenBienLaiComponent implements OnInit {
  @Input() isVisible = false;
  @Input() quyenBienLai: QuyenBienLai | null = null;
  @Output() closeModal = new EventEmitter<void>();

  constructor() { }

  ngOnInit(): void {
  }

  handleCancel(): void {
    this.isVisible = false;
    this.closeModal.emit();
  }

  // Tính số lượng biên lai đã sử dụng
  getSoLuongDaSuDung(): number {
    if (!this.quyenBienLai) return 0;
    
    return Math.round(this.quyenBienLai.tienDoSuDung * this.quyenBienLai.soLuongBienLai / 100);
  }
}
````

## File: WebApp.Client/src/app/bien-lai/quyen-bien-lai/quyen-bien-lai.component.html
````html
<div class="page-header">
  <div class="header-content">
    <div class="title-section">
      <h2 class="page-title">Quản lý quyển biên lai</h2>
    </div>
    <div class="actions">
      <button nz-button nzType="primary" (click)="showModal()" nzShape="round">
        <span nz-icon nzType="plus"></span>
        Thêm quyển biên lai
      </button>
    </div>
  </div>
</div>

<div class="dashboard-stats">
  <div class="stat-card">
    <div class="stat-icon">
      <span nz-icon nzType="book" nzTheme="outline"></span>
    </div>
    <div class="stat-content">
      <div class="stat-title">Tổng số quyển</div>
      <div class="stat-number">{{ listQuyenBienLai.length }}</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon green">
      <span nz-icon nzType="check-circle" nzTheme="outline"></span>
    </div>
    <div class="stat-content">
      <div class="stat-title">Đang sử dụng</div>
      <div class="stat-number">{{ getQuyenCount('dang_su_dung') }}</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon blue">
      <span nz-icon nzType="inbox" nzTheme="outline"></span>
    </div>
    <div class="stat-content">
      <div class="stat-title">Chưa sử dụng</div>
      <div class="stat-number">{{ getQuyenCount('chua_su_dung') }}</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon red">
      <span nz-icon nzType="file-done" nzTheme="outline"></span>
    </div>
    <div class="stat-content">
      <div class="stat-title">Đã sử dụng</div>
      <div class="stat-number">{{ getQuyenCount('da_su_dung') }}</div>
    </div>
  </div>
</div>

<div class="filter-section">
  <div class="filter-header">
    <h3><span nz-icon nzType="filter" nzTheme="outline"></span> Bộ lọc</h3>
    <div class="filter-actions">
      <nz-input-group [nzSuffix]="suffixIconSearch" class="search-box">
        <input type="text" nz-input placeholder="Tìm kiếm quyển biên lai..." [(ngModel)]="searchText" (ngModelChange)="onFilterChange()" name="search" />
      </nz-input-group>
      <ng-template #suffixIconSearch>
        <span nz-icon nzType="search"></span>
      </ng-template>
      <button nz-button nzType="default" (click)="resetFilter()" nzShape="round">
        <span nz-icon nzType="clear"></span> Xóa bộ lọc
      </button>
    </div>
  </div>
  <nz-divider></nz-divider>
  <form nz-form [nzLayout]="'inline'">
    <nz-form-item>
      <nz-form-label><span nz-icon nzType="user"></span> Người thu</nz-form-label>
      <nz-form-control>
        <nz-select [(ngModel)]="selectedNguoiThu" name="nguoiThu" nzPlaceHolder="Chọn người thu" nzAllowClear (ngModelChange)="onFilterChange()">
          <nz-option nzValue="all" nzLabel="Tất cả"></nz-option>
          <nz-option *ngFor="let user of users" [nzValue]="user.id" [nzLabel]="getDisplayName(user)"></nz-option>
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    
    <nz-form-item>
      <nz-form-label><span nz-icon nzType="tag"></span> Trạng thái</nz-form-label>
      <nz-form-control>
        <nz-select [(ngModel)]="selectedTrangThai" name="trangThai" nzPlaceHolder="Chọn trạng thái" nzAllowClear (ngModelChange)="onFilterChange()">
          <nz-option nzValue="all" nzLabel="Tất cả"></nz-option>
          <nz-option nzValue="chua_su_dung" nzLabel="Chưa sử dụng"></nz-option>
          <nz-option nzValue="dang_su_dung" nzLabel="Đang sử dụng"></nz-option>
          <nz-option nzValue="da_su_dung" nzLabel="Đã sử dụng"></nz-option>
        </nz-select>
      </nz-form-control>
    </nz-form-item>
  </form>
</div>

<div class="page-content">
  <nz-table 
    #basicTable 
    [nzData]="filteredQuyenBienLai" 
    [nzLoading]="loading"
    [nzShowSizeChanger]="true"
    [nzPageSizeOptions]="[10, 20, 50, 100]"
    nzBordered
    [nzScroll]="{ x: '1250px' }"
    [nzNoResult]="noResultTemplate">
    <thead>
      <tr>
        <th nzWidth="60px" [nzChecked]="checked"
            [nzIndeterminate]="indeterminate"
            (nzCheckedChange)="onAllChecked($event)">
        </th>
        <th nzWidth="100px">Quyển số</th>
        <th nzWidth="100px">Từ số</th>
        <th nzWidth="100px">Đến số</th>
        <th nzWidth="100px">Số hiện tại</th>
        <th nzWidth="150px">Người thu</th>
        <th nzWidth="150px">Người cấp</th>
        <th nzWidth="150px">Ngày cấp</th>
        <th nzWidth="120px">Trạng thái</th>
        <th nzWidth="150px">Tiến độ sử dụng</th>
        <th nzWidth="100px" nzRight>Thao tác</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of basicTable.data" [class.highlight-row]="setOfCheckedId.has(item.id!)">
        <td [nzChecked]="setOfCheckedId.has(item.id!)"
            [nzDisabled]="item.trang_thai !== 'chua_su_dung'"
            (nzCheckedChange)="onItemChecked(item.id!, $event)">
        </td>
        <td><span class="quyen-so">{{ item.quyen_so }}</span></td>
        <td>{{ item.tu_so }}</td>
        <td>{{ item.den_so }}</td>
        <td>{{ item.so_hien_tai }}</td>
        <td>
          <nz-avatar nzIcon="user" nzSize="small"></nz-avatar>
          {{ getNguoiThuName(item.nhan_vien_thu) }}
        </td>
        <td>{{ item.nguoi_cap }}</td>
        <td>{{ item.ngay_cap | date:'dd/MM/yyyy HH:mm' }}</td>
        <td>
          <nz-tag [nzColor]="getStatusColor(item.trang_thai)">
            <span nz-icon [nzType]="getStatusIcon(item.trang_thai)"></span>
            {{ getStatusText(item.trang_thai) }}
          </nz-tag>
        </td>
        <td>
          <div class="tien-do-wrapper">
            <nz-progress 
              [nzPercent]="calculateProgress(item)" 
              nzSize="small"
              [nzStrokeColor]="getProgressColor(calculateProgress(item))"
              [nzFormat]="progressFormatFn"
              nz-tooltip
              [nzTooltipTitle]="'Đã sử dụng: ' + getUsedCount(item) + '/' + calculateTotalReceipts(item)"
            ></nz-progress>
          </div>
        </td>
        <td>
          <nz-button-group>
            <button nz-button nzType="primary" nzGhost (click)="edit(item)" 
               *ngIf="item.trang_thai === 'chua_su_dung' || item.trang_thai === 'dang_su_dung'"
               nz-tooltip nzTooltipTitle="Chỉnh sửa">
              <span nz-icon nzType="edit"></span>
            </button>
            <button nz-button nzType="primary" nzDanger nzGhost (click)="delete(item)" 
               *ngIf="item.trang_thai === 'chua_su_dung'"
               nz-tooltip nzTooltipTitle="Xóa">
              <span nz-icon nzType="delete"></span>
            </button>
            <button nz-button nzType="default" (click)="viewDetails(item)" 
               nz-tooltip nzTooltipTitle="Xem chi tiết">
              <span nz-icon nzType="eye"></span>
            </button>
          </nz-button-group>
        </td>
      </tr>
    </tbody>
  </nz-table>
  
  <ng-template #noResultTemplate>
    <nz-empty 
      nzNotFoundImage="https://gw.alipayobjects.com/zos/antfincdn/ZHrcdLPrvN/empty.svg"
      [nzNotFoundContent]="emptyContent">
    </nz-empty>
    <ng-template #emptyContent>
      <span>Không tìm thấy quyển biên lai nào</span>
    </ng-template>
  </ng-template>
</div>

<nz-modal
  [(nzVisible)]="isVisible"
  [nzTitle]="modalTitle"
  (nzOnCancel)="handleCancel()"
  (nzOnOk)="handleOk()"
  [nzOkLoading]="isOkLoading"
  nzWidth="800px"
  [nzClassName]="'receipt-book-modal'">
  <ng-container *nzModalContent>
    <nz-alert *ngIf="form.get('trang_thai')?.value === 'da_su_dung'"
      nzType="warning"
      nzMessage="Cảnh báo: Trạng thái Đã sử dụng"
      nzDescription="Khi chọn trạng thái này, quyển biên lai sẽ không thể chỉnh sửa sau khi lưu."
      class="status-warning">
    </nz-alert>
    
    <form nz-form [formGroup]="form" nzLayout="vertical">
      <div nz-row [nzGutter]="16">
        <div nz-col [nzSpan]="12">
          <!-- Quyển số -->
          <nz-form-item>
            <nz-form-label nzRequired>Quyển số</nz-form-label>
            <nz-form-control [nzErrorTip]="quyenSoErrorTpl" [nzValidateStatus]="quyenSoStatus">
              <nz-input-group [nzPrefix]="quyenSoPrefix" [nzSuffix]="quyenSoSuffix">
                <input nz-input 
                  formControlName="quyen_so" 
                  placeholder="Nhập quyển số (cho phép ký tự, số, -, /)" 
                  (input)="onQuyenSoInput($event)"
                  (blur)="checkDuplicateQuyenSo()" />
              </nz-input-group>
              <ng-template #quyenSoPrefix>
                <span nz-icon nzType="book"></span>
              </ng-template>
              <ng-template #quyenSoSuffix>
                <span *ngIf="suggestedQuyenSo && !form.get('quyen_so')?.value" 
                  class="suggested-value" 
                  (click)="applySuggestedQuyenSo()">
                  <span nz-icon nzType="bulb"></span> Gợi ý: {{ suggestedQuyenSo }}
                </span>
              </ng-template>
            </nz-form-control>
            <ng-template #quyenSoErrorTpl let-control>
              <ng-container *ngIf="control.hasError('required')">
                <span nz-icon nzType="exclamation-circle"></span> Vui lòng nhập quyển số!
              </ng-container>
              <ng-container *ngIf="control.hasError('pattern')">
                <span nz-icon nzType="warning"></span> Quyển số không hợp lệ!
              </ng-container>
              <ng-container *ngIf="control.hasError('duplicate')">
                <span nz-icon nzType="stop"></span> Quyển số đã tồn tại! Vui lòng chọn quyển số khác.
              </ng-container>
            </ng-template>
          </nz-form-item>

          <!-- Từ số -->
          <nz-form-item>
            <nz-form-label nzRequired>Từ số</nz-form-label>
            <nz-form-control [nzErrorTip]="tuSoErrorTpl">
              <nz-input-group [nzPrefix]="tuSoPrefix">
                <input nz-input 
                  formControlName="tu_so" 
                  placeholder="Nhập số bắt đầu (tối đa 7 số)"
                  maxlength="7"
                  (input)="onNumberInput($event, 7)" />
              </nz-input-group>
              <ng-template #tuSoPrefix>
                <span nz-icon nzType="number"></span>
              </ng-template>
            </nz-form-control>
            <ng-template #tuSoErrorTpl let-control>
              <ng-container *ngIf="control.hasError('required')">
                <span nz-icon nzType="exclamation-circle"></span> Vui lòng nhập số bắt đầu!
              </ng-container>
              <ng-container *ngIf="control.hasError('pattern')">
                <span nz-icon nzType="warning"></span> Chỉ được nhập số và tối đa 7 chữ số!
              </ng-container>
            </ng-template>
          </nz-form-item>
        </div>

        <div nz-col [nzSpan]="12">
          <!-- Đến số -->
          <nz-form-item>
            <nz-form-label nzRequired>Đến số</nz-form-label>
            <nz-form-control [nzErrorTip]="denSoErrorTpl">
              <nz-input-group [nzPrefix]="denSoPrefix">
                <input nz-input 
                  formControlName="den_so" 
                  placeholder="Nhập số kết thúc (tối đa 7 số)"
                  maxlength="7"
                  (input)="onNumberInput($event, 7)" />
              </nz-input-group>
              <ng-template #denSoPrefix>
                <span nz-icon nzType="number"></span>
              </ng-template>
            </nz-form-control>
            <ng-template #denSoErrorTpl let-control>
              <ng-container *ngIf="control.hasError('required')">
                <span nz-icon nzType="exclamation-circle"></span> Vui lòng nhập số kết thúc!
              </ng-container>
              <ng-container *ngIf="control.hasError('pattern')">
                <span nz-icon nzType="warning"></span> Chỉ được nhập số và tối đa 7 chữ số!
              </ng-container>
            </ng-template>
          </nz-form-item>

          <!-- Số hiện tại -->
          <nz-form-item>
            <nz-form-label>Số hiện tại</nz-form-label>
            <nz-form-control [nzErrorTip]="soHienTaiErrorTpl">
              <nz-input-group [nzPrefix]="soHienTaiPrefix">
                <input nz-input 
                  formControlName="so_hien_tai" 
                  placeholder="Nhập số hiện tại (tối đa 7 số)"
                  maxlength="7"
                  (input)="onNumberInput($event, 7)" />
              </nz-input-group>
              <ng-template #soHienTaiPrefix>
                <span nz-icon nzType="arrow-right"></span>
              </ng-template>
            </nz-form-control>
            <ng-template #soHienTaiErrorTpl let-control>
              <ng-container *ngIf="control.hasError('soHienTaiKhongHopLe')">
                <span nz-icon nzType="warning"></span> Số hiện tại phải nằm trong khoảng Từ số đến Đến số!
              </ng-container>
              <ng-container *ngIf="control.hasError('pattern')">
                <span nz-icon nzType="warning"></span> Chỉ được nhập số và tối đa 7 chữ số!
              </ng-container>
            </ng-template>
          </nz-form-item>

          <!-- Người thu -->
          <nz-form-item>
            <nz-form-label nzRequired>Người thu</nz-form-label>
            <nz-form-control [nzErrorTip]="'Vui lòng chọn người thu!'">
              <nz-select formControlName="nhan_vien_thu" nzShowSearch nzAllowClear nzPlaceHolder="Chọn người thu">
                <nz-option *ngFor="let user of users" [nzValue]="user.id" [nzLabel]="getDisplayName(user)">
                  <nz-avatar nzIcon="user" nzSize="small"></nz-avatar>
                  {{ getDisplayName(user) }}
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <!-- Trạng thái -->
      <nz-form-item>
        <nz-form-label nzRequired>Trạng thái</nz-form-label>
        <nz-form-control>
          <nz-radio-group formControlName="trang_thai" (ngModelChange)="onTrangThaiChange($event)">
            <label nz-radio-button [nzValue]="'chua_su_dung'">
              <span nz-icon nzType="inbox"></span> Chưa sử dụng
            </label>
            <label nz-radio-button [nzValue]="'dang_su_dung'">
              <span nz-icon nzType="check-circle"></span> Đang sử dụng
            </label>
            <label nz-radio-button [nzValue]="'da_su_dung'">
              <span nz-icon nzType="file-done"></span> Đã sử dụng
            </label>
          </nz-radio-group>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<!-- Component chi tiết quyền biên lai -->
<app-chi-tiet-quyen-bien-lai 
  [isVisible]="isDetailVisible" 
  [quyenBienLai]="mapToQuyenBienLaiModel(selectedQuyenBienLai)"
  (closeModal)="closeDetailModal()"
></app-chi-tiet-quyen-bien-lai>
````

## File: WebApp.Client/src/app/bien-lai/quyen-bien-lai/quyen-bien-lai.component.scss
````scss
.page-header {
  padding: 16px 24px;
  border-bottom: 1px solid #f0f0f0;

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;

    .title-section {
      .page-title {
        margin: 0;
        color: rgba(0, 0, 0, 0.85);
        font-weight: 600;
        font-size: 20px;
        line-height: 32px;
      }
    }

    .actions {
      button {
        transition: all 0.3s;
        
        &:hover {
          transform: translateY(-2px);
          box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);
        }
      }
    }
  }
}

.page-content {
  padding: 24px;
  background: #fff;
  margin: 24px;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  
  nz-progress {
    margin: 0;
    
    ::ng-deep {
      .ant-progress-text {
        font-size: 12px;
      }
      
      .ant-progress-inner {
        border-radius: 4px;
      }
    }
  }
  
  .tien-do-wrapper {
    display: flex;
    
    nz-progress {
      width: 100%;
      margin: 0;
      
      ::ng-deep {
        .ant-progress-text {
          font-size: 12px;
          font-weight: 500;
        }
        
        .ant-progress-inner {
          border-radius: 4px;
        }
      }
    }
    
    .tien-do-info {
      font-size: 12px;
      color: #595959;
      margin-top: 4px;
      text-align: right;
    }
  }
}

:host ::ng-deep {
  .ant-table-thead > tr > th {
    background: #fafafa;
    font-weight: 500;
  }
  
  .ant-tag {
    display: inline-flex;
    align-items: center;
    
    span[nz-icon] {
      margin-right: 4px;
    }
  }
  
  .ant-btn {
    transition: all 0.3s;
  }
  
  .ant-table-row {
    transition: all 0.3s;
    
    &:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      z-index: 1;
    }
  }
  
  .ant-modal-content {
    border-radius: 8px;
    overflow: hidden;
  }
  
  .ant-descriptions-item-label {
    font-weight: 500;
  }
}

.dashboard-stats {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  margin: 16px 24px;
  
  .stat-card {
    flex: 1;
    min-width: 200px;
    background: #fff;
    border-radius: 4px;
    padding: 16px;
    display: flex;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s;
    
    &:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: #1890ff;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      
      span {
        font-size: 24px;
        color: #fff;
      }
      
      &.green {
        background-color: #52c41a;
      }
      
      &.blue {
        background-color: #1890ff;
      }
      
      &.red {
        background-color: #f5222d;
      }
    }
    
    .stat-content {
      .stat-title {
        color: rgba(0, 0, 0, 0.45);
        font-size: 14px;
        line-height: 22px;
      }
      
      .stat-number {
        color: rgba(0, 0, 0, 0.85);
        font-size: 24px;
        line-height: 32px;
        font-weight: 600;
      }
    }
  }
}

.filter-section {
  margin: 16px 24px;
  padding: 16px;
  background-color: #fff;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.filter-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;

  h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 500;
    color: rgba(0, 0, 0, 0.85);

    span {
      margin-right: 8px;
    }
  }
  
  .filter-actions {
    display: flex;
    align-items: center;
    gap: 12px;
    
    .search-box {
      width: 250px;
    }
    
    button {
      transition: all 0.3s;
      
      &:hover {
        transform: translateY(-2px);
      }
    }
  }
}

nz-form-item {
  margin-right: 16px;
  margin-bottom: 8px;
}

nz-select {
  min-width: 200px;
}

nz-divider {
  margin: 12px 0;
}

.highlight-row {
  background-color: #e6f7ff;
}

.quyen-so {
  font-weight: 600;
  color: #1890ff;
  padding: 2px 8px;
  background: rgba(24, 144, 255, 0.1);
  border-radius: 4px;
}

nz-avatar {
  margin-right: 8px;
}

nz-button-group {
  button {
    margin: 0 2px;
  }
}

.detail-container {
  .progress-section {
    margin-top: 24px;
    
    h4 {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 16px;
    }
    
    .progress-text {
      margin-left: 8px;
      color: rgba(0, 0, 0, 0.45);
    }
  }
}

@media (max-width: 768px) {
  .dashboard-stats {
    flex-direction: column;
    
    .stat-card {
      width: 100%;
    }
  }
  
  .filter-header {
    flex-direction: column;
    align-items: flex-start;
    
    .filter-actions {
      margin-top: 12px;
      width: 100%;
      
      .search-box {
        width: 100%;
      }
    }
  }
}

.copy-section {
  margin-bottom: 16px;
  text-align: right;
  
  button {
    transition: all 0.3s;
    
    &:hover {
      transform: translateY(-2px);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }
  }
}

.suggested-value {
  color: #1890ff;
  cursor: pointer;
  transition: all 0.3s;
  
  &:hover {
    color: #40a9ff;
    text-decoration: underline;
  }
}

.status-warning {
  margin-top: 8px;
}

.receipt-book-modal {
  .ant-form-item {
    margin-bottom: 24px;
  }

  .ant-form-item-label {
    label {
      font-weight: 500;
      color: #262626;
    }
  }

  .ant-input-group {
    .ant-input {
      height: 40px;
      font-size: 14px;
    }

    .ant-input-group-addon {
      background-color: #fafafa;
    }
  }

  .suggested-value {
    color: #1890ff;
    cursor: pointer;
    transition: all 0.3s;

    &:hover {
      color: #40a9ff;
      text-decoration: underline;
    }

    .anticon {
      margin-right: 4px;
    }
  }

  .ant-radio-group {
    display: flex;
    gap: 8px;

    .ant-radio-button-wrapper {
      height: 40px;
      line-height: 38px;
      padding: 0 16px;
      
      .anticon {
        margin-right: 4px;
      }

      &-checked {
        &:not(.ant-radio-button-wrapper-disabled) {
          &[value="chua_su_dung"] {
            border-color: #52c41a;
            color: #52c41a;
          }
          &[value="dang_su_dung"] {
            border-color: #1890ff;
            color: #1890ff;
          }
          &[value="da_su_dung"] {
            border-color: #f5222d;
            color: #f5222d;
          }
        }
      }
    }
  }

  .status-warning {
    margin: 16px 0;
  }

  .ant-select {
    width: 100%;
    
    .ant-select-selection-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
  }

  .ant-form-item-explain-error {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 4px;
    font-size: 13px;

    .anticon {
      font-size: 14px;
    }
  }

  nz-alert {
    margin-bottom: 24px;
  }
}
````

## File: WebApp.Client/src/app/bien-lai/quyen-bien-lai/quyen-bien-lai.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule, FormBuilder, FormGroup, Validators, AbstractControl } from '@angular/forms';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzModalModule, NzModalService } from 'ng-zorro-antd/modal';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzEmptyModule } from 'ng-zorro-antd/empty';
import { NzAvatarModule } from 'ng-zorro-antd/avatar';
import { NzRadioModule } from 'ng-zorro-antd/radio';
import { NzDescriptionsModule } from 'ng-zorro-antd/descriptions';
import { NzProgressModule } from 'ng-zorro-antd/progress';
import { NzToolTipModule } from 'ng-zorro-antd/tooltip';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzLayoutModule } from 'ng-zorro-antd/layout';
import { NzAlertModule } from 'ng-zorro-antd/alert';
import { NzCheckboxModule } from 'ng-zorro-antd/checkbox';
import { UserService, NguoiDung } from '../../services/user.service';
import { QuyenBienLaiService, QuyenBienLai } from '../../services/quyen-bien-lai.service';
import { NzBreadCrumbModule } from 'ng-zorro-antd/breadcrumb';
import { AuthService } from '../../services/auth.service';
import { 
  HomeOutline,
  PlusOutline,
  EditOutline,
  DeleteOutline,
  FilterOutline,
  ClearOutline,
  BookOutline,
  CheckCircleOutline,
  InboxOutline,
  FileDoneOutline,
  UserOutline,
  TagOutline,
  SearchOutline,
  EyeOutline,
  NumberOutline
} from '@ant-design/icons-angular/icons';
import { IconDefinition } from '@ant-design/icons-angular';
import { ChiTietQuyenBienLaiComponent } from './chi-tiet-quyen-bien-lai/chi-tiet-quyen-bien-lai.component';
import { QuyenBienLai as QuyenBienLaiModel } from '../models/quyen-bien-lai.model';
// Import other needed modules

interface NguoiThuOption {
  value: number;
  label: string;
}

// Thêm interface cho token payload
interface TokenPayload {
  hoTen?: string;
  userName?: string;
  [key: string]: any; // Cho phép các trường động
}

const icons: IconDefinition[] = [
  HomeOutline,
  PlusOutline,
  EditOutline,
  DeleteOutline,
  FilterOutline,
  ClearOutline,
  BookOutline,
  CheckCircleOutline,
  InboxOutline,
  FileDoneOutline,
  UserOutline,
  TagOutline,
  SearchOutline,
  EyeOutline,
  NumberOutline
];

@Component({
  selector: 'app-quyen-bien-lai',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    NzTableModule,
    NzButtonModule,
    NzModalModule,
    NzFormModule,
    NzInputModule,
    NzSelectModule,
    NzIconModule,
    NzTagModule,
    NzBreadCrumbModule,
    NzDividerModule,
    NzEmptyModule,
    NzAvatarModule,
    NzRadioModule,
    NzDescriptionsModule,
    NzProgressModule,
    NzToolTipModule,
    NzGridModule,
    NzLayoutModule,
    NzAlertModule,
    NzCheckboxModule,
    ChiTietQuyenBienLaiComponent
  ],
  templateUrl: './quyen-bien-lai.component.html',
  styleUrls: ['./quyen-bien-lai.component.scss']
})
export class QuyenBienLaiComponent implements OnInit {
  listQuyenBienLai: QuyenBienLai[] = [];
  filteredQuyenBienLai: QuyenBienLai[] = [];
  users: NguoiDung[] = [];
  userMap = new Map<number, NguoiDung>();
  loading = false;
  isVisible = false;
  isOkLoading = false;
  modalTitle = 'Thêm quyển biên lai';
  form: FormGroup;
  nguoiThus: NguoiThuOption[] = [];
  checked = false;
  indeterminate = false;
  setOfCheckedId = new Set<number>();
  editingQuyenBienLai: QuyenBienLai | null = null;
  selectedNguoiThu: any = 'all';
  selectedTrangThai: string = 'all';
  searchText: string = '';
  isDetailVisible: boolean = false;
  selectedQuyenBienLai: QuyenBienLai | null = null;
  suggestedQuyenSo: string = '';
  quyenSoStatus: string = '';
  private debounceTimer: any;

  constructor(
    private fb: FormBuilder,
    private message: NzMessageService,
    private modal: NzModalService,
    private userService: UserService,
    private quyenBienLaiService: QuyenBienLaiService,
    private authService: AuthService
  ) {
    this.form = this.fb.group({
      quyen_so: ['', [Validators.required]],
      tu_so: ['', [Validators.required]],
      den_so: ['', [Validators.required]],
      nhan_vien_thu: [null, [Validators.required]],
      trang_thai: ['dang_su_dung'],
      so_hien_tai: ['']
    });

    // Giảm tần suất xử lý khi nhập liệu bằng cách gom nhóm các subscription
    // và thêm debounce time
    this.form.valueChanges.subscribe(() => {
      this.debounce(() => {
        this.validateSoHienTai();
      }, 300);
    });

    // Thêm subscription để theo dõi thay đổi của tu_so và tính toán den_so
    this.form.get('tu_so')?.valueChanges.subscribe(value => {
      if (value) {
        const tuSo = parseInt(value);
        if (!isNaN(tuSo)) {
          this.debounce(() => {
            const denSo = (tuSo + 49).toString().padStart(value.length, '0');
            if (!this.editingQuyenBienLai && !this.form.get('so_hien_tai')?.value) {
              this.form.patchValue({
                den_so: denSo,
                so_hien_tai: value
              }, { emitEvent: false });
            } else {
              this.form.patchValue({
                den_so: denSo
              }, { emitEvent: false });
            }
          }, 300);
        }
      }
    });

    // Bỏ các subscription không cần thiết vì đã được gom vào form.valueChanges
  }

  ngOnInit(): void {
    this.loadUsers();
    this.loadData();
    this.calculateSuggestedQuyenSo();
  }

  loadData(): void {
    this.loading = true;
    this.quyenBienLaiService.getQuyenBienLais().subscribe({
      next: (data: QuyenBienLai[]) => {
        console.log('Loaded quyen bien lai:', data);
        this.listQuyenBienLai = data;
        this.filteredQuyenBienLai = data;
        this.loading = false;
        this.setOfCheckedId.clear();
        this.refreshCheckedStatus();
      },
      error: (err: any) => {
        this.message.error('Lỗi khi tải danh sách quyển biên lai');
        console.error(err);
        this.loading = false;
      }
    });
  }

  loadUsers(): void {
    this.userService.getUsers().subscribe({
      next: (users: NguoiDung[]) => {
        console.log('Loaded users:', users);
        this.users = users;
        this.userMap = new Map(users.map(user => [user.id, user]));
        this.nguoiThus = users.map((user: NguoiDung) => ({
          value: user.id,
          label: this.getDisplayName(user)
        }));
      },
      error: (err: any) => {
        this.message.error('Lỗi khi tải danh sách người thu');
        console.error(err);
      }
    });
  }

  getNguoiThuName(nguoiThuId: number): string {
    const nguoiThu = this.userMap.get(nguoiThuId);
    return nguoiThu ? this.getDisplayName(nguoiThu) : '';
  }

  showModal(): void {
    this.editingQuyenBienLai = null;
    this.form.reset({
      trang_thai: 'dang_su_dung',
      so_hien_tai: '' // Số hiện tại sẽ được thiết lập tự động khi nhập từ số
    });
    this.modalTitle = 'Thêm quyển biên lai';
    this.isVisible = true;
    this.calculateSuggestedQuyenSo();
    
    // Một mẹo nhỏ để đảm bảo số hiện tại sẽ tự động được cập nhật 
    // với giá trị từ số khi người dùng nhập từ số
    setTimeout(() => {
      const tuSoValue = this.form.get('tu_so')?.value;
      if (tuSoValue) {
        this.form.patchValue({
          so_hien_tai: tuSoValue
        }, { emitEvent: false });
      }
    }, 500);
  }

  handleOk(): void {
    this.checkDuplicateQuyenSo();
    
    if (this.form.valid) {
      this.isOkLoading = true;
      
      const currentUser = this.authService.getCurrentUser();
      
      const formValue = this.form.value;
      
      // Đảm bảo có số hiện tại
      let soHienTai = formValue.so_hien_tai;
      if (!soHienTai) {
        // Nếu không có số hiện tại, đặt dựa trên trạng thái
        if (formValue.trang_thai === 'chua_su_dung' || formValue.trang_thai === 'dang_su_dung') {
          soHienTai = formValue.tu_so;
        } else if (formValue.trang_thai === 'da_su_dung') {
          soHienTai = formValue.den_so;
        }
      }
      
      const data = {
        id: this.editingQuyenBienLai?.id,
        quyen_so: formValue.quyen_so,
        tu_so: formValue.tu_so,
        den_so: formValue.den_so,
        so_hien_tai: soHienTai,
        nhan_vien_thu: formValue.nhan_vien_thu,
        nguoi_cap: currentUser?.hoTen || currentUser?.userName,
        ngay_cap: new Date(),
        trang_thai: formValue.trang_thai
      };
      
      if (formValue.trang_thai === 'da_su_dung' && (!this.editingQuyenBienLai || this.editingQuyenBienLai.trang_thai !== 'da_su_dung')) {
        this.modal.confirm({
          nzTitle: 'Xác nhận trạng thái',
          nzContent: 'Bạn đang đặt trạng thái quyển biên lai là "Đã sử dụng". Sau khi lưu, bạn sẽ không thể chỉnh sửa quyển biên lai này nữa. Bạn có chắc chắn muốn tiếp tục?',
          nzOkText: 'Đồng ý',
          nzOkType: 'primary',
          nzOkDanger: true,
          nzOnOk: () => this.saveQuyenBienLai(data),
          nzCancelText: 'Hủy',
          nzOnCancel: () => {
            this.isOkLoading = false;
          }
        });
      } else {
        this.saveQuyenBienLai(data);
      }
    } else {
      Object.values(this.form.controls).forEach(control => {
        if (control.invalid) {
          control.markAsTouched();
          control.updateValueAndValidity({ onlySelf: true });
        }
      });
    }
  }

  handleCancel(): void {
    this.isVisible = false;
    this.editingQuyenBienLai = null;
  }

  edit(item: QuyenBienLai): void {
    this.modalTitle = 'Sửa quyển biên lai';
    this.editingQuyenBienLai = item;
    this.form.patchValue({
      quyen_so: item.quyen_so,
      tu_so: item.tu_so,
      den_so: item.den_so,
      nhan_vien_thu: item.nhan_vien_thu,
      trang_thai: item.trang_thai,
      so_hien_tai: item.so_hien_tai
    });
    this.isVisible = true;
  }

  delete(item: QuyenBienLai): void {
    if (!item.id) {
      this.message.error('Không tìm thấy ID quyển biên lai');
      return;
    }

    // Hiển thị modal xác nhận trước khi xóa
    this.modal.confirm({
      nzTitle: 'Xác nhận xóa',
      nzContent: `Bạn có chắc chắn muốn xóa quyển biên lai ${item.quyen_so}?`,
      nzOkText: 'Xóa',
      nzOkType: 'primary',
      nzOkDanger: true,
      nzOnOk: () => {
        // Gọi API xóa
        this.quyenBienLaiService.deleteQuyenBienLai(item.id!).subscribe({
          next: () => {
            this.message.success('Xóa quyển biên lai thành công');
            this.loadData(); // Tải lại dữ liệu
          },
          error: (err) => {
            this.message.error('Lỗi khi xóa quyển biên lai: ' + (err.error?.message || 'Đã có lỗi xảy ra'));
            console.error(err);
          }
        });
      },
      nzCancelText: 'Hủy'
    });
  }

  getStatusColor(status: string): string {
    switch (status) {
      case 'chua_su_dung':
        return 'blue';
      case 'dang_su_dung':
        return 'green';
      case 'da_su_dung':
        return 'red';
      default:
        return 'default';
    }
  }

  getStatusText(status: string): string {
    switch (status) {
      case 'chua_su_dung':
        return 'Chưa sử dụng';
      case 'dang_su_dung':
        return 'Đang sử dụng';
      case 'da_su_dung':
        return 'Đã sử dụng';
      default:
        return status;
    }
  }

  // Thêm custom validator
  validateSoThuTu(control: AbstractControl) {
    const form = control.parent as FormGroup;
    if (!form) return null;

    const tuSo = form.get('tu_so')?.value;
    const denSo = form.get('den_so')?.value;

    if (tuSo && denSo) {
      const tuSoNum = parseInt(tuSo);
      const denSoNum = parseInt(denSo);
      
      if (tuSoNum >= denSoNum) {
        return { soThuTuKhongHopLe: true };
      }
    }
    return null;
  }

  onNumberInput(event: Event, maxLength: number) {
    const input = event.target as HTMLInputElement;
    let value = input.value;
    
    // Loại bỏ các ký tự không phải số
    value = value.replace(/[^0-9]/g, '');
    
    // Giới hạn độ dài
    if (value.length > maxLength) {
      value = value.slice(0, maxLength);
    }
    
    // Cập nhật giá trị vào input và form control
    input.value = value;
    const controlName = input.getAttribute('formControlName');
    if (controlName) {
      const control = this.form.get(controlName);
      if (control) {
        // Không gọi emitEvent để tránh trigger các validators liên tục
        control.setValue(value, { emitEvent: false });
        
        // Nếu đang nhập tu_so, tự động cập nhật den_so và so_hien_tai
        if (controlName === 'tu_so' && value) {
          const tuSo = parseInt(value);
          if (!isNaN(tuSo)) {
            // Tạo một timeout để giảm lag khi nhập liệu
            setTimeout(() => {
              const denSo = (tuSo + 49).toString().padStart(value.length, '0');
              
              // Luôn thiết lập số hiện tại = từ số khi thay đổi từ số (trừ khi đang chỉnh sửa)
              // Nếu đang ở trạng thái "đã sử dụng" thì số hiện tại = đến số
              const trangThai = this.form.get('trang_thai')?.value;
              if (trangThai === 'da_su_dung') {
                this.form.patchValue({
                  den_so: denSo,
                  so_hien_tai: denSo
                }, { emitEvent: false });
              } else {
                this.form.patchValue({
                  den_so: denSo,
                  so_hien_tai: value
                }, { emitEvent: false });
              }
            }, 100);
          }
        }
      }
    }
  }

  // Phương thức mới để xử lý nhập quyển số (cho phép nhập chữ và ký tự đặc biệt)
  onQuyenSoInput(event: Event) {
    const input = event.target as HTMLInputElement;
    const value = input.value;
    
    // Cập nhật giá trị vào form control mà không gọi sự kiện phức tạp
    const controlName = input.getAttribute('formControlName');
    if (controlName) {
      const control = this.form.get(controlName);
      if (control) {
        control.setValue(value, { emitEvent: false });
        // Chỉ kích hoạt valueChanges khi người dùng ngừng nhập
        // Không gọi checkDuplicateQuyenSo ở đây nữa - sẽ gọi khi blur
      }
    }
  }

  updateCheckedSet(id: number, checked: boolean): void {
    if (checked) {
      this.setOfCheckedId.add(id);
    } else {
      this.setOfCheckedId.delete(id);
    }
  }

  onItemChecked(id: number, checked: boolean): void {
    this.updateCheckedSet(id, checked);
    this.refreshCheckedStatus();
  }

  onAllChecked(checked: boolean): void {
    // Chỉ cho phép chọn những quyển chưa sử dụng
    this.filteredQuyenBienLai
      .filter(item => item.trang_thai === 'chua_su_dung')
      .forEach(({ id }) => this.updateCheckedSet(id!, checked));
    this.refreshCheckedStatus();
  }

  refreshCheckedStatus(): void {
    // Chỉ tính toán trạng thái checked dựa trên những quyển chưa sử dụng
    const listChuaSuDung = this.filteredQuyenBienLai.filter(item => item.trang_thai === 'chua_su_dung');
    
    // Nếu không có quyển nào chưa sử dụng, set checked và indeterminate về false
    if (listChuaSuDung.length === 0) {
      this.checked = false;
      this.indeterminate = false;
      return;
    }

    // Kiểm tra xem tất cả các quyển chưa sử dụng có được chọn không
    this.checked = listChuaSuDung.every(({ id }) => this.setOfCheckedId.has(id!));
    
    // Kiểm tra xem có ít nhất một quyển được chọn nhưng không phải tất cả
    this.indeterminate = listChuaSuDung.some(({ id }) => this.setOfCheckedId.has(id!)) && !this.checked;
  }

  getDisplayName(user: NguoiDung): string {
    return user.ho_ten || 
           user.hoTen || 
           user.user_name || 
           user.userName || 
           user.username || 
           'Không có tên';
  }

  // Thêm phương thức validate số hiện tại
  validateSoHienTai(): void {
    const soHienTaiControl = this.form.get('so_hien_tai');
    const tuSoControl = this.form.get('tu_so');
    const denSoControl = this.form.get('den_so');

    if (!soHienTaiControl?.value || !tuSoControl?.value || !denSoControl?.value) {
      return; // Không validate nếu thiếu giá trị
    }

    try {
      // Thêm validator pattern
      soHienTaiControl.setValidators([Validators.required, Validators.pattern(/^\d+$/)]);
      
      const soHienTai = parseInt(soHienTaiControl.value);
      const tuSo = parseInt(tuSoControl.value);
      const denSo = parseInt(denSoControl.value);

      // Kiểm tra số hiện tại nằm trong khoảng từ số đến đến số
      if (soHienTai < tuSo || soHienTai > denSo) {
        soHienTaiControl.setErrors({ soHienTaiKhongHopLe: true });
      } else {
        // Xóa lỗi soHienTaiKhongHopLe nếu có
        const errors = soHienTaiControl.errors;
        if (errors) {
          delete errors['soHienTaiKhongHopLe'];
          soHienTaiControl.setErrors(Object.keys(errors).length ? errors : null);
        }
      }
    } catch (error) {
      console.error('Lỗi khi validate số hiện tại:', error);
    }
  }

  // Phương thức xử lý khi thay đổi bộ lọc
  onFilterChange(): void {
    this.applyFilter();
  }

  // Phương thức đặt lại bộ lọc
  resetFilter(): void {
    this.selectedNguoiThu = 'all';
    this.selectedTrangThai = 'all';
    this.searchText = '';
    this.applyFilter();
  }

  // Phương thức áp dụng bộ lọc
  applyFilter(): void {
    let filtered = [...this.listQuyenBienLai];
    
    // Lọc theo người thu
    if (this.selectedNguoiThu !== 'all') {
      filtered = filtered.filter(item => item.nhan_vien_thu === this.selectedNguoiThu);
    }
    
    // Lọc theo trạng thái
    if (this.selectedTrangThai !== 'all') {
      filtered = filtered.filter(item => item.trang_thai === this.selectedTrangThai);
    }
    
    // Lọc theo từ khóa tìm kiếm
    if (this.searchText && this.searchText.trim() !== '') {
      const searchLower = this.searchText.toLowerCase().trim();
      filtered = filtered.filter(item => 
        item.quyen_so.toString().includes(searchLower) ||
        item.tu_so.toString().includes(searchLower) ||
        item.den_so.toString().includes(searchLower) ||
        (item.so_hien_tai && item.so_hien_tai.toString().includes(searchLower)) ||
        this.getNguoiThuName(item.nhan_vien_thu).toLowerCase().includes(searchLower) ||
        (item.nguoi_cap && item.nguoi_cap.toLowerCase().includes(searchLower))
      );
    }
    
    this.filteredQuyenBienLai = filtered;
    this.setOfCheckedId.clear();
    this.refreshCheckedStatus();
  }

  // Lấy icon cho trạng thái
  getStatusIcon(status: string): string {
    switch (status) {
      case 'chua_su_dung':
        return 'inbox';
      case 'dang_su_dung':
        return 'check-circle';
      case 'da_su_dung':
        return 'file-done';
      default:
        return 'question-circle';
    }
  }

  // Đếm số quyển theo trạng thái
  getQuyenCount(status: string): number {
    return this.listQuyenBienLai.filter(item => item.trang_thai === status).length;
  }

  // Xem chi tiết quyển biên lai
  viewDetails(item: QuyenBienLai): void {
    this.selectedQuyenBienLai = item;
    this.isDetailVisible = true;
  }

  // Đóng modal chi tiết
  closeDetailModal(): void {
    this.isDetailVisible = false;
    this.selectedQuyenBienLai = null;
  }

  // Chuyển đổi dữ liệu từ selectedQuyenBienLai sang model QuyenBienLai
  mapToQuyenBienLaiModel(item: any): QuyenBienLaiModel | null {
    if (!item) return null;
    
    return {
      quyenSo: item.quyen_so,
      trangThai: this.getStatusText(item.trang_thai) as any,
      tuSo: item.tu_so,
      denSo: item.den_so,
      soHienTai: item.so_hien_tai,
      soLuongBienLai: this.calculateTotalReceipts(item),
      nguoiThu: this.getNguoiThuName(item.nhan_vien_thu),
      nguoiCap: item.nguoi_cap,
      ngayCap: item.ngay_cap,
      tienDoSuDung: this.calculateProgress(item),
      soLuongDaSuDung: this.getUsedCount(item)
    };
  }

  // Tính tổng số biên lai trong quyển
  calculateTotalReceipts(item: QuyenBienLai): number {
    const tuSo = parseInt(item.tu_so);
    const denSo = parseInt(item.den_so);
    return denSo - tuSo + 1;
  }

  // Tính số biên lai đã sử dụng
  getUsedCount(item: QuyenBienLai): number {
    if (item.trang_thai === 'chua_su_dung') {
      return 0;
    }
    
    const tuSo = parseInt(item.tu_so);
    const soHienTai = item.so_hien_tai ? parseInt(item.so_hien_tai) : tuSo;
    
    return soHienTai - tuSo;
  }

  // Tính phần trăm tiến độ sử dụng
  calculateProgress(item: QuyenBienLai): number {
    const total = this.calculateTotalReceipts(item);
    const used = this.getUsedCount(item);
    
    return Math.round((used / total) * 100);
  }

  // Lấy màu cho thanh tiến độ
  getProgressColor(percent: number): string {
    if (percent >= 90) {
      return '#ff4d4f'; // Đỏ - sắp hết
    } else if (percent >= 70) {
      return '#faad14'; // Vàng - đã sử dụng nhiều
    } else {
      return '#52c41a'; // Xanh lá - còn nhiều
    }
  }

  // Định dạng hiển thị tiến độ
  progressFormatFn = (percent: number): string => {
    return `${percent}%`;
  }

  // Kiểm tra quyển số có phải là dạng số không
  isNumericQuyenSo(quyenSo: string): boolean {
    return /^\d+$/.test(quyenSo);
  }

  // Tính toán giá trị gợi ý cho quyển số
  calculateSuggestedQuyenSo(): void {
    // Tìm quyển số lớn nhất trong danh sách
    const numericQuyenSo = this.listQuyenBienLai
      .map(q => q.quyen_so)
      .filter(qs => /^\d+$/.test(qs.toString())) // Chỉ lấy quyển số dạng số
      .map(qs => parseInt(qs.toString()));
      
    if (numericQuyenSo.length > 0) {
      const maxQuyenSo = Math.max(...numericQuyenSo);
      this.suggestedQuyenSo = (maxQuyenSo + 1).toString();
    } else {
      this.suggestedQuyenSo = '1';
    }
  }

  // Áp dụng gợi ý quyển số
  applySuggestedQuyenSo(): void {
    this.form.get('quyen_so')?.setValue(this.suggestedQuyenSo);
    this.checkDuplicateQuyenSo();
  }

  // Kiểm tra trùng lặp quyển số
  checkDuplicateQuyenSo(): void {
    const quyenSoControl = this.form.get('quyen_so');
    const quyenSoValue = quyenSoControl?.value;
    
    if (!quyenSoValue) {
      this.quyenSoStatus = '';
      return;
    }

    try {
      // Kiểm tra xem quyển số đã tồn tại chưa - chỉ tìm kiếm trong danh sách đã lọc
      const isDuplicate = this.listQuyenBienLai.some(item => 
        item.quyen_so === quyenSoValue && 
        (!this.editingQuyenBienLai || item.id !== this.editingQuyenBienLai.id)
      );

      if (isDuplicate) {
        quyenSoControl?.setErrors({ ...quyenSoControl.errors, duplicate: true });
        this.quyenSoStatus = 'error';
      } else {
        // Xóa lỗi duplicate nếu có
        if (quyenSoControl?.hasError('duplicate')) {
          const errors = { ...quyenSoControl.errors };
          delete errors['duplicate'];
          
          // Nếu không còn lỗi nào khác, set errors = null
          quyenSoControl.setErrors(Object.keys(errors).length ? errors : null);
        }
        
        this.quyenSoStatus = quyenSoControl?.invalid ? 'error' : 'success';
      }
    } catch (error) {
      console.error('Lỗi khi kiểm tra trùng lặp quyển số:', error);
    }
  }

  // Xử lý khi thay đổi trạng thái
  onTrangThaiChange(value: string): void {
    if (value === 'da_su_dung') {
      // Hiển thị cảnh báo trong form
      // Cảnh báo đã được thêm vào template HTML
    }
    
    // Thiết lập số hiện tại dựa trên trạng thái
    const tuSoControl = this.form.get('tu_so');
    const denSoControl = this.form.get('den_so');
    
    if (tuSoControl?.value && denSoControl?.value) {
      const tuSo = parseInt(tuSoControl.value);
      const denSo = parseInt(denSoControl.value);
      
      if (value === 'chua_su_dung') {
        // Nếu chưa sử dụng, số hiện tại = từ số
        this.form.patchValue({ so_hien_tai: tuSoControl.value });
      } else if (value === 'dang_su_dung') {
        // Nếu đang sử dụng, giữ nguyên số hiện tại nếu đã có, nếu không thì lấy từ số
        const soHienTai = this.form.get('so_hien_tai')?.value;
        if (!soHienTai) {
          this.form.patchValue({ so_hien_tai: tuSoControl.value });
        }
      } else if (value === 'da_su_dung') {
        // Nếu đã sử dụng, số hiện tại = đến số
        this.form.patchValue({ so_hien_tai: denSoControl.value });
      }
    }
  }

  // Phương thức lưu quyển biên lai
  saveQuyenBienLai(data: any): void {
    if (this.editingQuyenBienLai) {
      this.quyenBienLaiService.updateQuyenBienLai(this.editingQuyenBienLai.id!, data).subscribe({
        next: () => {
          this.message.success('Cập nhật quyển biên lai thành công');
          this.isVisible = false;
          this.isOkLoading = false;
          this.loadData();
        },
        error: (err: any) => {
          this.message.error('Lỗi khi cập nhật quyển biên lai');
          console.error(err);
          this.isOkLoading = false;
        }
      });
    } else {
      this.quyenBienLaiService.createQuyenBienLai(data).subscribe({
        next: () => {
          this.message.success('Thêm quyển biên lai thành công');
          this.isVisible = false;
          this.isOkLoading = false;
          this.loadData();
        },
        error: (err: any) => {
          this.message.error('Lỗi khi thêm quyển biên lai');
          console.error(err);
          this.isOkLoading = false;
        }
      });
    }
  }

  // Phương thức debounce để tránh gọi hàm quá nhiều lần
  debounce(func: Function, wait: number) {
    clearTimeout(this.debounceTimer);
    this.debounceTimer = setTimeout(() => {
      func();
    }, wait);
  }
}
````

## File: WebApp.Client/src/app/bien-lai/quyen-bien-lai-dien-tu/quyen-bien-lai-dien-tu.component.html
````html
<div class="container">
  <div class="page-header">
    <h2>Quản lý quyển biên lai điện tử</h2>
    <div class="action-buttons">
      <button nz-button nzType="primary" (click)="showAddModal()">
        <i nz-icon nzType="plus"></i> Thêm quyển biên lai
      </button>
      <button nz-button nzType="default" (click)="loadQuyenBienLais()">
        <i nz-icon nzType="reload"></i> Làm mới
      </button>
    </div>
  </div>

  <div class="filters" *ngIf="quyenBienLais.length > 0">
    <nz-alert 
      *ngIf="hasQuyenSapHet()"
      nzType="warning" 
      nzMessage="Cảnh báo: Có quyển biên lai sắp hết số"
      nzDescription="Một số quyển biên lai đang active sắp hết. Hãy kiểm tra và chuẩn bị quyển mới."
      nzShowIcon
      [nzCloseable]="true"
      class="margin-bottom"
    ></nz-alert>
  </div>

  <nz-table #basicTable [nzData]="quyenBienLais" [nzLoading]="isLoading" [nzBordered]="true">
    <thead>
      <tr>
        <th>STT</th>
        <th>Ký hiệu</th>
        <th>Từ số</th>
        <th>Đến số</th>
        <th>Số hiện tại</th>
        <th>Còn lại</th>
        <th>Mã cơ quan BHXH</th>
        <th>Người cấp</th>
        <th>Ngày cấp</th>
        <th>Trạng thái</th>
        <th>Thao tác</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of basicTable.data; let i = index" [ngClass]="{'near-end': isQuyenSapHet(item)}">
        <td>{{ i + 1 }}</td>
        <td>{{ item.ky_hieu }}</td>
        <td>{{ item.tu_so }}</td>
        <td>{{ item.den_so }}</td>
        <td>{{ item.so_hien_tai || item.tu_so }}</td>
        <td>
          <ng-container *ngIf="item.trang_thai !== TRANG_THAI.DA_SU_DUNG_HET">
            {{ getSoConLai(item) }}
            <nz-tag *ngIf="getSoConLai(item) < 20" nzColor="warning">
              Sắp hết
            </nz-tag>
          </ng-container>
          <ng-container *ngIf="item.trang_thai === TRANG_THAI.DA_SU_DUNG_HET">
            0
          </ng-container>
        </td>
        <td>{{ item.ma_co_quan_bhxh }}</td>
        <td>{{ item.nguoi_cap }}</td>
        <td>{{ item.ngay_cap | date:'dd/MM/yyyy' }}</td>
        <td>
          <nz-tag [nzColor]="getTrangThaiClass(item.trang_thai!)">
            {{ getTrangThaiText(item.trang_thai!) }}
          </nz-tag>
        </td>
        <td>
          <button nz-button nzType="primary" nzSize="small" (click)="showEditModal(item.id!)" 
            [disabled]="item.trang_thai === TRANG_THAI.DA_SU_DUNG_HET" nzTooltip="Chỉnh sửa">
            <i nz-icon nzType="edit"></i>
          </button>
          <nz-divider nzType="vertical"></nz-divider>
          <button nz-button nzType="primary" nzDanger nzSize="small" (click)="deleteQuyenBienLai(item.id!)" 
            [disabled]="item.trang_thai !== TRANG_THAI.CHUA_SU_DUNG" nzTooltip="Xóa">
            <i nz-icon nzType="delete"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </nz-table>

  <nz-modal
    [(nzVisible)]="isVisible"
    [nzTitle]="editingId ? 'Chỉnh sửa quyển biên lai điện tử' : 'Thêm quyển biên lai điện tử'"
    [nzOkText]="editingId ? 'Cập nhật' : 'Thêm'"
    nzCancelText="Hủy"
    (nzOnCancel)="handleCancel()"
    (nzOnOk)="handleSubmit()"
    [nzOkLoading]="isSubmitting"
    [nzBodyStyle]="{ maxHeight: '400px', overflow: 'auto' }"
  >
    <div *nzModalContent>
      <form nz-form [formGroup]="form">
        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Ký hiệu</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui lòng nhập ký hiệu">
            <input nz-input formControlName="ky_hieu" readonly />
            <div class="ant-form-item-explain">Ký hiệu cố định: BH25-AG/08907/E</div>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Từ số</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui lòng nhập số bắt đầu hợp lệ">
            <input nz-input formControlName="tu_so" />
            <div class="ant-form-item-explain">Mặc định: 0000001</div>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Đến số</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui lòng nhập số kết thúc hợp lệ">
            <input nz-input formControlName="den_so" />
            <div class="ant-form-item-explain">Mặc định: 9999999</div>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item *ngIf="editingId">
          <nz-form-label [nzSm]="6" [nzXs]="24">Số hiện tại</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Số hiện tại phải nằm trong khoảng từ số đến số">
            <input nz-input formControlName="so_hien_tai" />
            <div class="ant-form-item-explain">Số biên lai tiếp theo sẽ được sử dụng</div>
            <div *ngIf="isSoHienTaiGanHet()" 
                 class="ant-form-item-explain ant-form-item-explain-warning">
              <i nz-icon nzType="warning" nzTheme="fill"></i> 
              Số biên lai còn lại: {{ getSoConLaiFromForm() }}
            </div>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Trạng thái</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui lòng chọn trạng thái">
            <nz-select formControlName="trang_thai">
              <nz-option [nzValue]="TRANG_THAI.CHUA_SU_DUNG" nzLabel="Chưa sử dụng"></nz-option>
              <nz-option [nzValue]="TRANG_THAI.ACTIVE" nzLabel="Đang active"></nz-option>
              <nz-option [nzValue]="TRANG_THAI.INACTIVE" nzLabel="Không active"></nz-option>
              <nz-option [nzValue]="TRANG_THAI.DA_SU_DUNG_HET" nzLabel="Đã sử dụng hết"></nz-option>
            </nz-select>
            <div *ngIf="form.get('trang_thai')?.value === TRANG_THAI.DA_SU_DUNG_HET" class="ant-form-item-explain ant-form-item-explain-warning">
              <i nz-icon nzType="warning" nzTheme="fill"></i> Cảnh báo: Khi đặt trạng thái là "Đã sử dụng hết", hệ thống sẽ không sử dụng quyển biên lai này nữa!
            </div>
            <div *ngIf="form.get('trang_thai')?.value === TRANG_THAI.ACTIVE" class="ant-form-item-explain ant-form-item-explain-info">
              <i nz-icon nzType="info-circle" nzTheme="fill"></i> Hệ thống sẽ sử dụng quyển biên lai này để cấp biên lai mới.
            </div>
          </nz-form-control>
        </nz-form-item>
        
        <nz-form-item>
          <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Mã cơ quan BHXH</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Vui lòng nhập mã cơ quan BHXH">
            <input nz-input formControlName="ma_co_quan_bhxh" />
          </nz-form-control>
        </nz-form-item>

        <!-- Ẩn trường người cấp vì sẽ tự động lấy từ người đăng nhập -->
        <input type="hidden" formControlName="nguoi_cap" />
        
        <!-- Hiển thị thông tin cho người dùng biết -->
        <nz-form-item *ngIf="editingId">
          <nz-form-label [nzSm]="6" [nzXs]="24">Người cấp</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24">
            <input nz-input [value]="currentQuyenBienLai?.nguoi_cap" disabled />
          </nz-form-control>
        </nz-form-item>
        
        <nz-form-item *ngIf="!editingId">
          <nz-form-label [nzSm]="6" [nzXs]="24">Người cấp</nz-form-label>
          <nz-form-control [nzSm]="14" [nzXs]="24">
            <div class="ant-form-item-explain">Sẽ tự động lấy theo tài khoản đăng nhập</div>
          </nz-form-control>
        </nz-form-item>
      </form>
    </div>
  </nz-modal>
</div>

<style>
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .action-buttons {
    display: flex;
    gap: 8px;
  }

  .status-pending {
    background-color: #faad14;
    color: white;
  }

  .status-active {
    background-color: #52c41a;
    color: white;
  }

  .status-completed {
    background-color: #1890ff;
    color: white;
  }

  .margin-bottom {
    margin-bottom: 16px;
  }

  tr.near-end {
    background-color: #fff7e6;
  }

  .filters {
    margin-bottom: 16px;
  }
</style>
````

## File: WebApp.Client/src/app/bien-lai/quyen-bien-lai-dien-tu/quyen-bien-lai-dien-tu.component.scss
````scss
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.container {
  padding: 24px;
}

:host ::ng-deep {
  .status-pending {
    background-color: #faad14;
    color: white;
  }

  .status-active {
    background-color: #52c41a;
    color: white;
  }

  .status-completed {
    background-color: #1890ff;
    color: white;
  }
  
  /* Sửa lỗi hiển thị form trong modal */
  .ant-modal-body {
    max-height: 70vh;
    overflow-y: auto;
  }

  .ant-form-item {
    margin-bottom: 16px !important;
    display: flex;
  }

  .ant-form-item-control {
    flex: 1;
  }

  nz-form-label {
    display: inline-block !important;
  }

  .ant-form-item-label {
    line-height: 32px;
  }

  small {
    color: #999;
    font-size: 12px;
    display: block;
    margin-top: 5px;
  }
}
````

## File: WebApp.Client/src/app/bien-lai/quyen-bien-lai-dien-tu/quyen-bien-lai-dien-tu.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators, FormsModule, ReactiveFormsModule } from '@angular/forms';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzModalService } from 'ng-zorro-antd/modal';
import { BienLaiDienTuService } from '../../services/bien-lai-dien-tu.service';
import { QuyenBienLaiDienTu } from '../models/bien-lai-dien-tu.model';
import { User, UsersService } from '../../services/users.service';
import { CommonModule } from '@angular/common';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzAlertModule } from 'ng-zorro-antd/alert';
import { catchError, of } from 'rxjs';

// Cập nhật interface cho phù hợp với dữ liệu API trả về
interface NguoiDung {
  id: number;
  userName: string;
  hoTen: string;
  email: string | null;
  roles: string[] | null;
  maNhanVien: string | null;
}

@Component({
  selector: 'app-quyen-bien-lai-dien-tu',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    NzTableModule,
    NzButtonModule,
    NzFormModule,
    NzInputModule,
    NzSelectModule,
    NzModalModule,
    NzTagModule,
    NzIconModule,
    NzDividerModule,
    NzAlertModule
  ],
  templateUrl: './quyen-bien-lai-dien-tu.component.html',
  styleUrls: ['./quyen-bien-lai-dien-tu.component.scss']
})
export class QuyenBienLaiDienTuComponent implements OnInit {
  quyenBienLais: QuyenBienLaiDienTu[] = [];
  users: NguoiDung[] = [];
  isLoading = false;
  isVisible = false;
  isSubmitting = false;
  form!: FormGroup;
  editingId: number | null = null;
  currentQuyenBienLai: QuyenBienLaiDienTu | null = null;

  // Định nghĩa các trạng thái
  readonly TRANG_THAI = {
    CHUA_SU_DUNG: 'chua_su_dung',
    ACTIVE: 'active',
    INACTIVE: 'inactive',
    DA_SU_DUNG_HET: 'da_su_dung_het'
  };

  // Hàm helper để sử dụng trong template
  parseInt(value: string): number {
    return parseInt(value || '0');
  }

  constructor(
    private bienLaiDienTuService: BienLaiDienTuService,
    private usersService: UsersService,
    private fb: FormBuilder,
    private message: NzMessageService,
    private modal: NzModalService
  ) { }

  ngOnInit(): void {
    this.initForm();
    this.loadQuyenBienLais();
    this.loadUsers();
  }

  initForm(): void {
    this.form = this.fb.group({
      ky_hieu: ['BH25-AG/08907/E', [Validators.required]],
      tu_so: ['0000001', [Validators.required, Validators.pattern('^[0-9]+$')]],
      den_so: ['9999999', [Validators.required, Validators.pattern('^[0-9]+$')]],
      so_hien_tai: ['', [Validators.pattern('^[0-9]+$')]],
      trang_thai: [this.TRANG_THAI.CHUA_SU_DUNG, [Validators.required]],
      nguoi_cap: [''],
      ma_co_quan_bhxh: ['', [Validators.required, Validators.maxLength(20)]]
    });

    // Theo dõi thay đổi số hiện tại để tự động cập nhật trạng thái khi cần
    this.form.get('so_hien_tai')?.valueChanges.subscribe(value => {
      if (this.editingId && value) {
        this.checkSoHienTaiAndUpdateTrangThai();
      }
    });
  }

  loadQuyenBienLais(): void {
    this.isLoading = true;
    this.bienLaiDienTuService.getQuyenBienLais()
      .pipe(
        catchError(error => {
          console.error('Lỗi khi tải danh sách quyển biên lai điện tử:', error);
          this.message.error('Có lỗi khi tải danh sách quyển biên lai điện tử');
          this.isLoading = false;
          return of([]);
        })
      )
      .subscribe({
        next: (data: QuyenBienLaiDienTu[]) => {
          this.quyenBienLais = data;
          this.isLoading = false;
        }
      });
  }

  loadUsers(): void {
    this.usersService.getUsers()
      .pipe(
        catchError(error => {
          console.error('Lỗi khi tải danh sách người dùng:', error);
          this.message.error('Có lỗi khi tải danh sách người dùng');
          return of([]);
        })
      )
      .subscribe({
        next: (data: any[]) => {
          // Chuyển đổi dữ liệu từ API sang định dạng NguoiDung
          this.users = data.map(item => ({
            id: item.id,
            userName: item.userName,
            hoTen: item.hoTen,
            email: item.email,
            roles: item.roles,
            maNhanVien: item.maNhanVien
          }));
        }
      });
  }

  showAddModal(): void {
    this.editingId = null;
    this.form.reset();
    this.form.patchValue({
      ky_hieu: 'BH25-AG/08907/E',
      tu_so: '0000001',
      den_so: '9999999',
      ma_co_quan_bhxh: '',
      nguoi_cap: '',
      trang_thai: this.TRANG_THAI.CHUA_SU_DUNG
    });
    this.isVisible = true;
  }

  showEditModal(id: number): void {
    this.isLoading = true;
    
    this.bienLaiDienTuService.getQuyenBienLaiById(id)
      .pipe(
        catchError(error => {
          console.error('Lỗi khi tải thông tin quyển biên lai điện tử:', error);
          this.message.error('Có lỗi khi tải thông tin quyển biên lai điện tử');
          this.isLoading = false;
          return of(null);
        })
      )
      .subscribe({
        next: (data: QuyenBienLaiDienTu | null) => {
          if (data) {
            this.currentQuyenBienLai = data;
            this.editingId = id;
            this.form.patchValue({
              ky_hieu: data.ky_hieu,
              tu_so: data.tu_so,
              den_so: data.den_so,
              so_hien_tai: data.so_hien_tai,
              nguoi_cap: data.nguoi_cap,
              ma_co_quan_bhxh: data.ma_co_quan_bhxh,
              trang_thai: data.trang_thai || this.TRANG_THAI.CHUA_SU_DUNG
            });
            this.isVisible = true;
          }
          this.isLoading = false;
        }
      });
  }

  handleCancel(): void {
    this.isVisible = false;
  }

  // Kiểm tra số hiện tại và cập nhật trạng thái nếu cần
  checkSoHienTaiAndUpdateTrangThai(): void {
    const tuSo = parseInt(this.form.get('tu_so')?.value || '0');
    const denSo = parseInt(this.form.get('den_so')?.value || '0');
    const soHienTai = parseInt(this.form.get('so_hien_tai')?.value || '0');
    const trangThaiControl = this.form.get('trang_thai');
    
    if (!trangThaiControl) return;
    
    // Nếu số hiện tại đạt đến số cuối cùng hoặc vượt quá
    if (soHienTai >= denSo) {
      // Hiển thị thông báo gợi ý cho người dùng
      if (trangThaiControl.value !== this.TRANG_THAI.DA_SU_DUNG_HET) {
        this.message.warning('Số hiện tại đã đạt tới số cuối. Bạn có thể đánh dấu quyển này là "Đã sử dụng hết".');
        // Không tự động thay đổi trạng thái, chỉ gợi ý
      }
    }
  }

  handleSubmit(): void {
    if (this.form.invalid) {
      Object.values(this.form.controls).forEach(control => {
        if (control.invalid) {
          control.markAsDirty();
          control.updateValueAndValidity();
        }
      });
      return;
    }

    // Kiểm tra tính hợp lệ của số hiện tại
    if (this.editingId) {
      const tuSo = parseInt(this.form.get('tu_so')?.value || '0');
      const denSo = parseInt(this.form.get('den_so')?.value || '0');
      const soHienTai = parseInt(this.form.get('so_hien_tai')?.value || '0');
      
      if (soHienTai < tuSo || soHienTai > denSo) {
        this.message.error('Số hiện tại phải nằm trong khoảng từ số đến số');
        return;
      }
    }

    const formData = this.form.value;
    const trangThai = formData.trang_thai;
    const oldTrangThai = this.currentQuyenBienLai?.trang_thai;
    const soHienTai = parseInt(formData.so_hien_tai || '0');
    const denSo = parseInt(formData.den_so || '0');

    // Hiển thị cảnh báo khi số hiện tại gần đạt đến số cuối
    if (soHienTai > 0 && denSo > 0 && (denSo - soHienTai <= 10) && trangThai !== this.TRANG_THAI.DA_SU_DUNG_HET) {
      this.modal.confirm({
        nzTitle: 'Cảnh báo số biên lai còn lại',
        nzContent: `Quyển biên lai này chỉ còn ${denSo - soHienTai + 1} số biên lai có thể sử dụng. Bạn có muốn đánh dấu trạng thái là "Đã sử dụng hết" không?`,
        nzOkText: 'Đánh dấu đã sử dụng hết',
        nzCancelText: 'Giữ nguyên trạng thái',
        nzOnOk: () => {
          formData.trang_thai = this.TRANG_THAI.DA_SU_DUNG_HET;
          this.submitForm(formData);
        },
        nzOnCancel: () => {
          this.submitForm(formData);
        }
      });
      return;
    }

    // Hiển thị hộp thoại xác nhận khi thay đổi thành trạng thái "đã sử dụng hết"
    if (trangThai === this.TRANG_THAI.DA_SU_DUNG_HET && oldTrangThai !== this.TRANG_THAI.DA_SU_DUNG_HET) {
      this.modal.confirm({
        nzTitle: 'Xác nhận thay đổi trạng thái',
        nzContent: 'Khi đặt trạng thái là "Đã sử dụng hết", hệ thống sẽ không sử dụng quyển biên lai này nữa. Bạn có chắc chắn muốn tiếp tục?',
        nzOkText: 'Đồng ý',
        nzOkType: 'primary',
        nzOkDanger: true,
        nzOnOk: () => this.submitForm(formData),
        nzCancelText: 'Hủy',
        nzOnCancel: () => {
          this.isSubmitting = false;
        }
      });
    } 
    // Hiển thị xác nhận khi chuyển từ trạng thái inactive sang active
    else if (trangThai === this.TRANG_THAI.ACTIVE && oldTrangThai === this.TRANG_THAI.INACTIVE) {
      this.modal.confirm({
        nzTitle: 'Xác nhận kích hoạt',
        nzContent: 'Khi chuyển quyển biên lai sang trạng thái active, hệ thống sẽ sử dụng quyển này để cấp biên lai mới. Bạn có chắc chắn?',
        nzOkText: 'Đồng ý',
        nzOnOk: () => this.submitForm(formData),
        nzCancelText: 'Hủy',
        nzOnCancel: () => {
          this.isSubmitting = false;
        }
      });
    } else {
      this.submitForm(formData);
    }
  }

  submitForm(formData: any): void {
    this.isSubmitting = true;

    // Đảm bảo ký hiệu biên lai luôn là BH25-AG/08907/E
    formData.ky_hieu = 'BH25-AG/08907/E';
    
    // Để trống trường nguoi_cap, server sẽ tự động lấy từ người đăng nhập
    formData.nguoi_cap = '';

    if (this.editingId) {
      // Đảm bảo có trường id khi cập nhật
      formData.id = this.editingId;
      
      // Cập nhật quyển biên lai
      this.bienLaiDienTuService.updateQuyenBienLai(this.editingId, formData).subscribe({
        next: () => {
          this.message.success('Cập nhật quyển biên lai điện tử thành công');
          this.isVisible = false;
          this.isSubmitting = false;
          this.loadQuyenBienLais();
        },
        error: (error: any) => {
          console.error('Lỗi khi cập nhật quyển biên lai điện tử:', error);
          if (error.error && error.error.message) {
            this.message.error(error.error.message);
          } else {
            this.message.error('Có lỗi khi cập nhật quyển biên lai điện tử');
          }
          this.isSubmitting = false;
        }
      });
    } else {
      // Thêm quyển biên lai mới
      this.bienLaiDienTuService.createQuyenBienLai(formData).subscribe({
        next: (response: any) => {
          this.message.success('Thêm quyển biên lai điện tử thành công');
          this.isVisible = false;
          this.isSubmitting = false;
          this.loadQuyenBienLais();
        },
        error: (error: any) => {
          console.error('Lỗi khi thêm quyển biên lai điện tử:', error);
          if (error.error && error.error.message) {
            this.message.error(error.error.message);
          } else {
            this.message.error('Có lỗi khi thêm quyển biên lai điện tử');
          }
          this.isSubmitting = false;
        }
      });
    }
  }

  deleteQuyenBienLai(id: number): void {
    this.modal.confirm({
      nzTitle: 'Xác nhận xóa',
      nzContent: 'Bạn có chắc chắn muốn xóa quyển biên lai điện tử này?',
      nzOkText: 'Xóa',
      nzOkType: 'primary',
      nzOkDanger: true,
      nzOnOk: () => {
        this.isLoading = true;
        this.bienLaiDienTuService.deleteQuyenBienLai(id).subscribe({
          next: () => {
            this.message.success('Xóa quyển biên lai điện tử thành công');
            this.loadQuyenBienLais();
          },
          error: (error: any) => {
            console.error('Lỗi khi xóa quyển biên lai điện tử:', error);
            if (error.status === 400) {
              this.message.error('Không thể xóa quyển biên lai điện tử đã sử dụng');
            } else {
              this.message.error('Có lỗi khi xóa quyển biên lai điện tử');
            }
            this.isLoading = false;
          }
        });
      }
    });
  }

  // Hiển thị trạng thái dạng text
  getTrangThaiText(trangThai: string): string {
    switch (trangThai) {
      case this.TRANG_THAI.CHUA_SU_DUNG:
        return 'Chưa sử dụng';
      case this.TRANG_THAI.ACTIVE:
        return 'Đang active';
      case this.TRANG_THAI.INACTIVE:
        return 'Không active';
      case this.TRANG_THAI.DA_SU_DUNG_HET:
        return 'Đã sử dụng hết';
      default:
        return trangThai || 'Không xác định';
    }
  }

  // Lấy class CSS cho tag trạng thái
  getTrangThaiClass(trangThai: string): string {
    switch (trangThai) {
      case this.TRANG_THAI.CHUA_SU_DUNG:
        return 'processing';
      case this.TRANG_THAI.ACTIVE:
        return 'success';
      case this.TRANG_THAI.INACTIVE:
        return 'warning';
      case this.TRANG_THAI.DA_SU_DUNG_HET:
        return 'error';
      default:
        return 'default';
    }
  }

  // Kiểm tra nếu có quyển biên lai nào đang active và sắp hết số
  hasQuyenSapHet(): boolean {
    if (!this.quyenBienLais || this.quyenBienLais.length === 0) return false;
    
    return this.quyenBienLais.some(item => 
      item.trang_thai === this.TRANG_THAI.ACTIVE && 
      this.getSoConLai(item) < 20
    );
  }

  // Kiểm tra nếu quyển biên lai cụ thể đang sắp hết số
  isQuyenSapHet(quyen: QuyenBienLaiDienTu): boolean {
    return quyen.trang_thai === this.TRANG_THAI.ACTIVE && 
           this.getSoConLai(quyen) < 20;
  }

  // Tính số biên lai còn lại của một quyển
  getSoConLai(quyen: QuyenBienLaiDienTu): number {
    if (!quyen) return 0;
    if (quyen.trang_thai === this.TRANG_THAI.DA_SU_DUNG_HET) return 0;
    
    const denSo = parseInt(quyen.den_so || '0');
    const soHienTai = parseInt(quyen.so_hien_tai || quyen.tu_so || '0');
    
    return denSo - soHienTai + 1;
  }

  // Kiểm tra nếu số hiện tại trong form đang gần đến số cuối
  isSoHienTaiGanHet(): boolean {
    const soHienTaiValue = this.form.get('so_hien_tai')?.value;
    const denSoValue = this.form.get('den_so')?.value;
    
    if (!soHienTaiValue || !denSoValue) return false;
    
    const soHienTai = parseInt(soHienTaiValue);
    const denSo = parseInt(denSoValue);
    
    return (denSo - soHienTai) < 20;
  }

  // Tính số biên lai còn lại từ dữ liệu form
  getSoConLaiFromForm(): number {
    const soHienTai = parseInt(this.form.get('so_hien_tai')?.value || '0');
    const denSo = parseInt(this.form.get('den_so')?.value || '0');
    
    return denSo - soHienTai + 1;
  }
}
````

## File: WebApp.Client/src/app/bien-lai/thong-ke-bien-lai/thong-ke-bien-lai.component.ts
````typescript
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzCardModule } from 'ng-zorro-antd/card';
import { NzStatisticModule } from 'ng-zorro-antd/statistic';

@Component({
  selector: 'app-thong-ke-bien-lai',
  standalone: true,
  imports: [
    CommonModule,
    NzTableModule,
    NzCardModule,
    NzStatisticModule
  ],
  template: `
    <div class="page-header">
      <h2>Thống kê biên lai</h2>
    </div>
    <div class="page-content">
      <!-- Content here -->
    </div>
  `
})
export class ThongKeBienLaiComponent {
  // Component logic
}
````

## File: WebApp.Client/src/app/dai-ly/dai-ly.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule, FormBuilder, FormGroup, Validators } from '@angular/forms';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzModalModule, NzModalService } from 'ng-zorro-antd/modal';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzMessageModule, NzMessageService } from 'ng-zorro-antd/message';
import { NzPopconfirmModule } from 'ng-zorro-antd/popconfirm';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzSwitchModule } from 'ng-zorro-antd/switch';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { DaiLy, DaiLyService } from '../services/dai-ly.service';
import { DonViService } from '../services/don-vi.service';
import { DaiLyDonViService } from '../services/dai-ly-don-vi.service';
import { AuthService } from '../services/auth.service';

@Component({
  selector: 'app-dai-ly',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    NzTableModule,
    NzButtonModule,
    NzIconModule,
    NzModalModule,
    NzFormModule,
    NzInputModule,
    NzMessageModule,
    NzPopconfirmModule,
    NzTagModule,
    NzDividerModule,
    NzSwitchModule,
    NzSelectModule
  ],
  template: `
    <div class="page-header">
      <h1>Quản lý đại lý</h1>
      <button nz-button nzType="primary" (click)="showCreateModal()">
        <span nz-icon nzType="plus"></span>Thêm mới
      </button>
    </div>

    <nz-table #basicTable [nzData]="daiLys" [nzLoading]="isLoading">
      <thead>
        <tr>
          <th>Mã đại lý</th>
          <th>Tên đại lý</th>
          <th>Địa chỉ</th>
          <th>Số điện thoại</th>
          <th>Email</th>
          <th>Người đại diện</th>
          <th>Trạng thái</th>
          <th>Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of basicTable.data">
          <td>{{ data.ma }}</td>
          <td>{{ data.ten }}</td>
          <td>{{ data.diaChi }}</td>
          <td>{{ data.soDienThoai }}</td>
          <td>{{ data.email }}</td>
          <td>{{ data.nguoiDaiDien }}</td>
          <td>
            <nz-switch
              [(ngModel)]="data.trangThai"
              [nzLoading]="data.loading"
              (ngModelChange)="onStatusChange(data)">
            </nz-switch>
          </td>
          <td>
            <button nz-button nzType="primary" (click)="showEditModal(data)">
              <span nz-icon nzType="edit"></span>
            </button>
            <nz-divider nzType="vertical"></nz-divider>
            <button 
              nz-button 
              nzType="default" 
              nzDanger 
              nz-popconfirm
              [nzLoading]="isLoading"
              nzPopconfirmTitle="Bạn có chắc chắn muốn xóa đại lý này?"
              nzPopconfirmPlacement="left"
              nzOkText="Xóa"
              nzCancelText="Hủy"
              nzOkDanger
              (nzOnConfirm)="deleteData(data.id)">
              <span nz-icon nzType="delete"></span>
            </button>
          </td>
        </tr>
      </tbody>
    </nz-table>

    <nz-modal
      [(nzVisible)]="isModalVisible"
      [nzTitle]="modalTitle"
      (nzOnCancel)="handleCancel()"
      (nzOnOk)="handleOk()"
      [nzWidth]="700">
      <ng-container *nzModalContent>
        <form nz-form [formGroup]="daiLyForm">
          <nz-form-item>
            <nz-form-label [nzSpan]="6" nzRequired>Mã đại lý</nz-form-label>
            <nz-form-control [nzSpan]="18" nzErrorTip="Vui lòng nhập mã đại lý!">
              <input nz-input formControlName="ma" placeholder="Nhập mã đại lý"/>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label [nzSpan]="6" nzRequired>Tên đại lý</nz-form-label>
            <nz-form-control [nzSpan]="18" nzErrorTip="Vui lòng nhập tên đại lý!">
              <input nz-input formControlName="ten" placeholder="Nhập tên đại lý"/>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label [nzSpan]="6">Địa chỉ</nz-form-label>
            <nz-form-control [nzSpan]="18">
              <input nz-input formControlName="diaChi" placeholder="Nhập địa chỉ"/>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label [nzSpan]="6">Số điện thoại</nz-form-label>
            <nz-form-control [nzSpan]="18">
              <input nz-input formControlName="soDienThoai" placeholder="Nhập số điện thoại"/>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label [nzSpan]="6">Email</nz-form-label>
            <nz-form-control [nzSpan]="18" [nzErrorTip]="emailErrorTpl">
              <input nz-input formControlName="email" placeholder="Nhập email"/>
              <ng-template #emailErrorTpl let-control>
                <ng-container *ngIf="control.hasError('email')">
                  Email không đúng định dạng!
                </ng-container>
              </ng-template>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label [nzSpan]="6">Người đại diện</nz-form-label>
            <nz-form-control [nzSpan]="18">
              <input nz-input formControlName="nguoiDaiDien" placeholder="Nhập tên người đại diện"/>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label [nzSpan]="6">Trạng thái</nz-form-label>
            <nz-form-control [nzSpan]="18">
              <nz-switch formControlName="trangThai"></nz-switch>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label [nzSpan]="6">Đơn vị</nz-form-label>
            <nz-form-control [nzSpan]="18">
              <nz-select 
                [nzMode]="'multiple'"
                [(ngModel)]="selectedDonVis"
                [ngModelOptions]="{standalone: true}"
                (ngModelChange)="onDonVisChange($event)"
                nzPlaceHolder="Chọn đơn vị">
                <nz-option
                  *ngFor="let donVi of donVis"
                  [nzValue]="donVi.id"
                  [nzLabel]="donVi.tenDonVi">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>

        </form>
      </ng-container>
    </nz-modal>
  `,
  styles: [`
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    h1 {
      margin: 0;
    }
  `]
})
export class DaiLyComponent implements OnInit {
  daiLys: DaiLy[] = [];
  isLoading = false;
  isModalVisible = false;
  modalTitle = '';
  daiLyForm!: FormGroup;
  editingDaiLy: DaiLy | null = null;
  selectedDonVis: number[] = [];
  donVis: any[] = [];
  // Thêm cache cho danh sách đơn vị theo đại lý
  private donVisByDaiLyCache = new Map<number, any[]>();

  constructor(
    private daiLyService: DaiLyService,
    private message: NzMessageService,
    private modal: NzModalService,
    private fb: FormBuilder,
    private donViService: DonViService,
    private daiLyDonViService: DaiLyDonViService,
    private authService: AuthService
  ) {
    this.initForm();
  }

  ngOnInit(): void {
    this.loadDaiLys();
    this.loadDonVis();
  }

  initForm(): void {
    this.daiLyForm = this.fb.group({
      ma: ['', [Validators.required, Validators.maxLength(20)]],
      ten: ['', [Validators.required, Validators.maxLength(200)]],
      diaChi: ['', [Validators.maxLength(500)]],
      soDienThoai: ['', [Validators.maxLength(15)]],
      email: ['', [Validators.maxLength(100), Validators.email]],
      nguoiDaiDien: ['', [Validators.maxLength(100)]],
      trangThai: [true]
    });
  }

  loadDaiLys(): void {
    this.isLoading = true;
    this.daiLyService.getDaiLys().subscribe({
      next: (data) => {
        this.daiLys = data;
        this.isLoading = false;
      },
      error: () => {
        this.message.error('Có lỗi xảy ra khi tải danh sách đại lý');
        this.isLoading = false;
      }
    });
  }

  loadDonVis(): void {
    this.donViService.getDonVis().subscribe({
      next: (data) => {
        this.donVis = data;
      },
      error: () => {
        this.message.error('Không thể tải danh sách đơn vị');
      }
    });
  }

  showCreateModal(): void {
    this.modalTitle = 'Thêm mới đại lý';
    this.editingDaiLy = null;
    this.daiLyForm.reset({ trangThai: true });
    this.isModalVisible = true;
  }

  showEditModal(data: DaiLy): void {
    this.modalTitle = 'Chỉnh sửa đại lý';
    this.editingDaiLy = data;
    this.daiLyForm.patchValue(data);
    
    // Kiểm tra cache trước khi gọi API
    if (this.donVisByDaiLyCache.has(data.id)) {
      this.selectedDonVis = this.donVisByDaiLyCache.get(data.id)!.map(d => d.id);
      this.isModalVisible = true;
      return;
    }
    
    // Load đơn vị của đại lý từ API nếu không có trong cache
    this.daiLyDonViService.getDonVisByDaiLy(data.id).subscribe({
      next: (donVis) => {
        this.selectedDonVis = donVis.map(d => d.id);
        // Lưu vào cache
        this.donVisByDaiLyCache.set(data.id, donVis);
      },
      error: () => {
        this.message.error('Không thể tải danh sách đơn vị của đại lý');
      }
    });

    this.isModalVisible = true;
  }

  handleOk(): void {
    if (this.daiLyForm.valid) {
      this.isLoading = true;
      const formValue = this.daiLyForm.value;

      // Đảm bảo các trường không bắt buộc có giá trị rỗng thay vì null
      const daiLyData = {
        ma: formValue.ma,
        ten: formValue.ten,
        diaChi: formValue.diaChi || '',
        soDienThoai: formValue.soDienThoai || '',
        email: formValue.email || '',
        nguoiDaiDien: formValue.nguoiDaiDien || '',
        trangThai: formValue.trangThai
      };

      if (this.editingDaiLy) {
        // Thêm các trường cần thiết khi cập nhật
        const updateData = {
          ...daiLyData,
          id: this.editingDaiLy.id,
          ngayTao: this.editingDaiLy.ngayTao,
          nguoiTao: this.editingDaiLy.nguoiTao
        };

        this.daiLyService.updateDaiLy(this.editingDaiLy.id, updateData).subscribe({
          next: () => {
            this.message.success('Cập nhật đại lý thành công');
            this.loadDaiLys();
            this.isModalVisible = false;
            this.isLoading = false;
          },
          error: (error) => {
            console.error('Error details:', error);
            if (error.error?.errors) {
              const errorMessages = Object.values(error.error.errors)
                .flat()
                .join(', ');
              this.message.error(`Lỗi: ${errorMessages}`);
            } else {
              this.message.error(error.error?.message || 'Có lỗi xảy ra khi cập nhật đại lý');
            }
            this.isLoading = false;
          }
        });
      } else {
        this.daiLyService.createDaiLy(daiLyData).subscribe({
          next: () => {
            this.message.success('Thêm mới đại lý thành công');
            this.loadDaiLys();
            this.isModalVisible = false;
            this.isLoading = false;
          },
          error: (error) => {
            console.error('Error details:', error);
            if (error.error?.errors) {
              const errorMessages = Object.values(error.error.errors)
                .flat()
                .join(', ');
              this.message.error(`Lỗi: ${errorMessages}`);
            } else {
              this.message.error(error.error?.message || 'Có lỗi xảy ra khi thêm mới đại lý');
            }
            this.isLoading = false;
          }
        });
      }
    } else {
      Object.values(this.daiLyForm.controls).forEach(control => {
        if (control.invalid) {
          control.markAsTouched();
        }
      });
    }
  }

  handleCancel(): void {
    this.isModalVisible = false;
    this.editingDaiLy = null;
    this.selectedDonVis = [];
    this.daiLyForm.reset();
  }

  deleteData(id: number): void {
    this.isLoading = true;
    this.daiLyService.deleteDaiLy(id).subscribe({
      next: () => {
        this.message.success('Xóa đại lý thành công');
        this.loadDaiLys();
        this.isLoading = false;
      },
      error: (error) => {
        console.error('Delete error details:', {
          status: error.status,
          message: error.error?.message,
          error: error.error,
          fullError: error
        });
        
        this.isLoading = false;

        // Xử lý lỗi dựa trên error.error
        if (error.error) {
          // Kiểm tra nếu có thông tin về đơn vị liên kết
          if (error.error.donViCount) {
            this.modal.error({
              nzTitle: 'Không thể xóa',
              nzContent: `Không thể xóa đại lý này vì đang có ${error.error.donViCount} đơn vị liên kết. Vui lòng gỡ bỏ liên kết với các đơn vị trước khi xóa.`,
              nzOkText: 'Đóng'
            });
            return;
          }
          
          // Kiểm tra nếu có thông tin về đợt kê khai
          if (error.error.dotKeKhaiCount) {
            this.modal.error({
              nzTitle: 'Không thể xóa',
              nzContent: `Không thể xóa đại lý này vì đang có ${error.error.dotKeKhaiCount} đợt kê khai liên quan.`,
              nzOkText: 'Đóng'
            });
            return;
          }

          // Hiển thị thông báo lỗi từ server nếu có
          if (error.error.message) {
            this.message.error(error.error.message);
            return;
          }
        }

        // Thông báo lỗi mặc định nếu không xác định được lỗi cụ thể
        this.message.error('Có lỗi xảy ra khi xóa đại lý. Vui lòng thử lại sau.');
      }
    });
  }

  onStatusChange(daiLy: DaiLy): void {
    const oldStatus = !daiLy.trangThai;
    daiLy.loading = true;

    this.daiLyService.updateStatus(daiLy.id, daiLy).subscribe({
      next: () => {
        this.message.success(`${daiLy.trangThai ? 'Kích hoạt' : 'Vô hiệu hóa'} đại lý thành công`);
        daiLy.loading = false;
      },
      error: (error) => {
        daiLy.trangThai = oldStatus;
        if (error.error?.errors) {
          const errorMessages = Object.values(error.error.errors)
            .flat()
            .join(', ');
          this.message.error(`Lỗi: ${errorMessages}`);
        } else {
          this.message.error(error.error?.message || 'Có lỗi xảy ra khi cập nhật trạng thái');
        }
        daiLy.loading = false;
      }
    });
  }

  onDonVisChange(donViIds: number[]): void {
    if (!this.editingDaiLy) return;

    // Xóa các đơn vị cũ
    const removedDonViIds = this.selectedDonVis.filter(id => !donViIds.includes(id));
    removedDonViIds.forEach(donViId => {
      this.daiLyDonViService.deleteDaiLyDonVi(this.editingDaiLy!.id).subscribe({
        error: () => this.message.error('Có lỗi xảy ra khi xóa liên kết đơn vị')
      });
    });

    // Thêm các đơn vị mới
    const newDonViIds = donViIds.filter(id => !this.selectedDonVis.includes(id));
    newDonViIds.forEach(donViId => {
      this.daiLyDonViService.addDaiLyDonVi(
        this.editingDaiLy!.id, 
        donViId,
        this.authService.getCurrentUser()?.username || ''
      ).subscribe({
        error: () => this.message.error('Có lỗi xảy ra khi thêm liên kết đơn vị')
      });
    });

    this.selectedDonVis = donViIds;
  }
}
````

## File: WebApp.Client/src/app/dashboard/dashboard.component.html
````html
<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>{{title}}</h1>
    <div class="dashboard-actions">
      <button nz-button nzType="primary">
        <span nz-icon nzType="plus"></span>
        Thêm mới
      </button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card primary">
      <div class="stat-icon">
        <span nz-icon nzType="team" nzTheme="outline"></span>
      </div>
      <div class="stat-content">
        <div class="stat-value">2,451</div>
        <div class="stat-label">Tổng nhân viên</div>
      </div>
      <div class="stat-trend up">
        <span nz-icon nzType="arrow-up"></span>
        <span>12%</span>
      </div>
    </div>

    <div class="stat-card success">
      <div class="stat-icon">
        <span nz-icon nzType="solution" nzTheme="outline"></span>
      </div>
      <div class="stat-content">
        <div class="stat-value">1,257</div>
        <div class="stat-label">Hồ sơ đã xử lý</div>
      </div>
      <div class="stat-trend up">
        <span nz-icon nzType="arrow-up"></span>
        <span>8%</span>
      </div>
    </div>

    <div class="stat-card warning">
      <div class="stat-icon">
        <span nz-icon nzType="clock-circle" nzTheme="outline"></span>
      </div>
      <div class="stat-content">
        <div class="stat-value">145</div>
        <div class="stat-label">Đang chờ xử lý</div>
      </div>
      <div class="stat-trend down">
        <span nz-icon nzType="arrow-down"></span>
        <span>5%</span>
      </div>
    </div>

    <div class="stat-card info">
      <div class="stat-icon">
        <span nz-icon nzType="check-circle" nzTheme="outline"></span>
      </div>
      <div class="stat-content">
        <div class="stat-value">98%</div>
        <div class="stat-label">Tỷ lệ hoàn thành</div>
      </div>
      <div class="stat-trend up">
        <span nz-icon nzType="arrow-up"></span>
        <span>2%</span>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="dashboard-card">
      <div class="card-header">
        <h2>Hoạt động gần đây</h2>
        <a nz-button nzType="link">Xem tất cả</a>
      </div>
      <nz-list [nzDataSource]="recentActivities" nzItemLayout="horizontal">
        <nz-list-item *ngFor="let item of recentActivities">
          <nz-list-item-meta
            [nzAvatar]="item.avatar"
            [nzTitle]="item.title"
            [nzDescription]="item.description">
          </nz-list-item-meta>
        </nz-list-item>
      </nz-list>
    </div>

    <div class="dashboard-card">
      <div class="card-header">
        <h2>Thống kê theo tháng</h2>
        <nz-radio-group [(ngModel)]="selectedPeriod">
          <label nz-radio-button nzValue="week">Tuần</label>
          <label nz-radio-button nzValue="month">Tháng</label>
          <label nz-radio-button nzValue="year">Năm</label>
        </nz-radio-group>
      </div>
      <div class="chart-container">
        <!-- Thêm biểu đồ ở đây -->
      </div>
    </div>
  </div>
</div>
````

## File: WebApp.Client/src/app/dashboard/dashboard.component.scss
````scss
.dashboard-container {
  padding: 20px;

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;

    h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 500;
      color: #1f1f1f;
    }
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
  }

  .stat-card {
    display: flex;
    align-items: center;
    padding: 24px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    transition: all 0.3s ease;

    &:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .stat-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 8px;
      margin-right: 16px;
      font-size: 24px;

      .anticon {
        color: white;
      }
    }

    .stat-content {
      flex: 1;

      .stat-value {
        font-size: 24px;
        font-weight: 600;
        line-height: 1.2;
        margin-bottom: 4px;
      }

      .stat-label {
        color: #8c8c8c;
        font-size: 14px;
      }
    }

    .stat-trend {
      display: flex;
      align-items: center;
      font-size: 14px;
      margin-left: 16px;

      &.up {
        color: #52c41a;
      }

      &.down {
        color: #ff4d4f;
      }

      .anticon {
        margin-right: 4px;
      }
    }

    &.primary {
      .stat-icon {
        background: #1890ff;
      }
    }

    &.success {
      .stat-icon {
        background: #52c41a;
      }
    }

    &.warning {
      .stat-icon {
        background: #faad14;
      }
    }

    &.info {
      .stat-icon {
        background: #13c2c2;
      }
    }
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 24px;
  }

  .dashboard-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid #f0f0f0;

      h2 {
        margin: 0;
        font-size: 16px;
        font-weight: 500;
        color: #1f1f1f;
      }
    }

    nz-list {
      padding: 0 24px;
    }

    .chart-container {
      padding: 24px;
      height: 300px;
    }
  }
}

// Responsive styles
@media (max-width: 768px) {
  .dashboard-container {
    .dashboard-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }

    .stats-grid {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .dashboard-grid {
      grid-template-columns: 1fr;
    }

    .stat-card {
      padding: 16px;

      .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }

      .stat-content {
        .stat-value {
          font-size: 20px;
        }
      }
    }

    .dashboard-card {
      .card-header {
        padding: 12px 16px;
      }

      nz-list {
        padding: 0 16px;
      }

      .chart-container {
        padding: 16px;
        height: 250px;
      }
    }
  }
}
````

## File: WebApp.Client/src/app/dashboard/dashboard.component.spec.ts
````typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';

import { DashboardComponent } from './dashboard.component';

describe('DashboardComponent', () => {
  let component: DashboardComponent;
  let fixture: ComponentFixture<DashboardComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [DashboardComponent]
    })
    .compileComponents();

    fixture = TestBed.createComponent(DashboardComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});
````

## File: WebApp.Client/src/app/dashboard/dashboard.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzListModule } from 'ng-zorro-antd/list';
import { NzRadioModule } from 'ng-zorro-antd/radio';
import { FormsModule } from '@angular/forms';

interface Activity {
  avatar: string;
  title: string;
  description: string;
  time?: string;
}

@Component({
  selector: 'app-dashboard',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    NzButtonModule,
    NzIconModule,
    NzListModule,
    NzRadioModule
  ],
  templateUrl: './dashboard.component.html',
  styleUrls: ['./dashboard.component.scss']
})
export class DashboardComponent implements OnInit {
  title = 'Tổng quan';
  selectedPeriod = 'month';
  
  recentActivities: Activity[] = [
    {
      avatar: 'https://gw.alipayobjects.com/zos/rmsportal/ThXAXghbEsBCCSDihZxY.png',
      title: 'Nguyễn Văn A đã cập nhật hồ sơ',
      description: 'Cập nhật thông tin cá nhân và địa chỉ mới',
      time: '2 giờ trước'
    },
    {
      avatar: 'https://gw.alipayobjects.com/zos/rmsportal/OKJXDXrmkNshAMvwtvhu.png',
      title: 'Trần Thị B đã tạo yêu cầu mới',
      description: 'Yêu cầu xin nghỉ phép 3 ngày',
      time: '4 giờ trước'
    },
    {
      avatar: 'https://gw.alipayobjects.com/zos/rmsportal/kISTdvpyTAhtGxpovNWd.png',
      title: 'Lê Văn C đã phê duyệt hồ sơ',
      description: 'Phê duyệt đơn xin nghỉ phép của nhân viên',
      time: '1 ngày trước'
    }
  ];

  constructor() { }

  ngOnInit(): void {
    // Khởi tạo dữ liệu dashboard ở đây
  }
}
````

## File: WebApp.Client/src/app/guards/admin.guard.ts
````typescript
import { Injectable } from '@angular/core';
import { CanActivate, Router } from '@angular/router';
import { AuthService } from '../services/auth.service';

@Injectable({
  providedIn: 'root'
})
export class AdminGuard implements CanActivate {
  constructor(
    private router: Router,
    private authService: AuthService
  ) {}

  canActivate(): boolean {
    const currentUser = this.authService.getCurrentUser();
    
    // Kiểm tra quyền admin
    const isAdmin = currentUser?.roles?.some((role: string) => 
      ['admin', 'super_admin'].includes(role)
    ) || currentUser?.isSuperAdmin;

    if (isAdmin) {
      return true;
    }

    // Nếu không có quyền admin, chuyển hướng về trang chủ
    this.router.navigate(['/dashboard']);
    return false;
  }
}
````

## File: WebApp.Client/src/app/interceptors/api-token.interceptor.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpInterceptor, HttpRequest, HttpHandler, HttpEvent } from '@angular/common/http';
import { Observable } from 'rxjs';

const API_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiODg0MDAwX3hhX3RsaV9waHVvY2x0IiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjoidXNlciIsInN1YiI6IjEwMDkxNyIsInNpZCI6IkVHdTNMX2VYR0RmQ2s1RFMwMTRrX3RjemJGQXhFcWc3eklxU21QaW9aWUUiLCJuYW1lIjoiTMOqIFRo4buLIFBoxrDhu5tjIiwibmlja25hbWUiOiI4ODQwMDBfeGFfdGxpX3BodW9jbHQiLCJjbGllbnRfaWQiOiJaalJpWW1JNVpUZ3RaRGN5T0MwME9EUmtMVGt5T1RZdE1ETmpZbVV6TTJVNFlqYzUiLCJtYW5nTHVvaSI6Ijc2MjU1IiwiZG9uVmlDb25nVGFjIjoixJBp4buDbSB0aHUgeMOjIFTDom4gTOG7o2kiLCJjaHVjRGFuaCI6IkPhu5luZyB0w6FjIHZpw6puIHRodSIsImVtYWlsIjoibmd1eWVudGFuZHVuZzI3MTE4OUBnbWFpbC5jb20iLCJzb0RpZW5UaG9haSI6IiIsImlzU3VwZXJBZG1pbiI6IkZhbHNlIiwiaXNDYXMiOiJGYWxzZSIsIm5iZiI6MTc0MDA5NzcwOSwiZXhwIjoxNzQwMTE1NzA5LCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjUwMDAiLCJhdWQiOiJodHRwOi8vbG9jYWxob3N0OjQyMDAifQ.UhsxXa2zz_JVOqjYPyNbz1UqEDiqk7PwD1BumvGa-_w';

@Injectable()
export class ApiTokenInterceptor implements HttpInterceptor {
  intercept(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
    // Chỉ thêm token API cho request đến API tra cứu BHYT
    if (request.url.includes('ssmv2.vnpost.vn/connect/tracuu/thongtinbhytforkekhai')) {
      request = request.clone({
        setHeaders: {
          'Authorization': `Bearer ${API_TOKEN}`,
          'Accept': 'application/json',
          'Accept-Language': 'vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7',
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        }
      });
    }
    return next.handle(request);
  }
}

// Thêm export instance của interceptor
export const apiTokenInterceptor = new ApiTokenInterceptor();
````

## File: WebApp.Client/src/app/interceptors/auth.interceptor.ts
````typescript
import { HttpInterceptorFn, HttpErrorResponse } from '@angular/common/http';
import { environment } from '../../environments/environment';
import { catchError, throwError } from 'rxjs';

export const authInterceptor: HttpInterceptorFn = (req, next) => {
  // Không xử lý nếu là request đến API tra cứu BHYT
  if (req.url.includes('ssmv2.vnpost.vn/connect/tracuu/thongtinbhytforkekhai')) {
    return next(req);
  }

  // Xử lý token cho tất cả các request khác
  try {
    const user = localStorage.getItem('user');

    if (user) {
      const userData = JSON.parse(user);
      
      if (userData && userData.token) {
        console.log('Token being sent:', userData.token);
        req = req.clone({
          setHeaders: {
            Authorization: `Bearer ${userData.token}`
          }
        });
      }
    }
  } catch (error) {
    console.error('Error in auth interceptor:', error);
  }

  return next(req).pipe(
    catchError((error: HttpErrorResponse) => {
      if (error.status === 401) {
        console.log('401 error occurred:', error);
        // Clear localStorage và chuyển về trang login
        localStorage.clear();
        window.location.href = '/login';
      }
      return throwError(() => error);
    })
  );
};
````

## File: WebApp.Client/src/app/ke-khai/admin-danh-sach-ke-khai/admin-danh-sach-ke-khai.component.html
````html
<div class="page-container">
  <nz-card class="main-card">
    <div class="page-header">
      <h2>Quản lý danh sách kê khai</h2>
      <div class="page-actions">
        <button nz-button nzType="primary" (click)="duyetNhieuDotKeKhai()" nz-tooltip nzTooltipTitle="Duyệt nhiều đợt kê khai" [disabled]="getSoDotKeKhaiDaChon() === 0">
          <span nz-icon nzType="check-circle" nzTheme="outline"></span>
          Duyệt đợt kê khai <span *ngIf="getSoDotKeKhaiDaChon() > 0">({{ getSoDotKeKhaiDaChon() }})</span>
        </button>
        <button nz-button nzType="primary" (click)="xuatExcelNhieuDotKeKhai()" nz-tooltip nzTooltipTitle="Xuất Excel danh sách">
          <span nz-icon nzType="file-excel" nzTheme="outline"></span>
          Xuất Excel
        </button>
        <button nz-button nzType="primary" (click)="xuatVNPTNhieuDot()" nz-tooltip nzTooltipTitle="Xuất định dạng VNPT" [disabled]="getSoDotKeKhaiDaChon() === 0">
          <span nz-icon nzType="export" nzTheme="outline"></span>
          Xuất VNPT <span *ngIf="getSoDotKeKhaiDaChon() > 0">({{ getSoDotKeKhaiDaChon() }})</span>
        </button>
        <button nz-button nzType="primary" (click)="taiHoaDonNhieuDot()" nz-tooltip nzTooltipTitle="Tải hóa đơn" [disabled]="getSoDotKeKhaiDaChon() === 0">
          <span nz-icon nzType="download" nzTheme="outline"></span>
          Tải hóa đơn <span *ngIf="getSoDotKeKhaiDaChon() > 0">({{ getSoDotKeKhaiDaChon() }})</span>
        </button>
        <button nz-button nzType="primary" (click)="refreshData()" nz-tooltip nzTooltipTitle="Làm mới dữ liệu">
          <span nz-icon nzType="reload" nzTheme="outline"></span>
          Làm mới
        </button>
      </div>
    </div>

    <nz-divider></nz-divider>
    
    <!-- Thông báo hướng dẫn -->
    <div *ngIf="dotKeKhaiList.length > 0 && getSoDotKeKhaiDaChon() > 0" class="selected-summary">
      Đã chọn {{ getSoDotKeKhaiDaChon() }} / {{ dotKeKhaiList.length }} đợt kê khai
      <a (click)="onCheckTatCa(true)" *ngIf="getSoDotKeKhaiDaChon() < dotKeKhaiList.length">Chọn tất cả</a>
      <a (click)="onCheckTatCa(false)" *ngIf="getSoDotKeKhaiDaChon() > 0">Bỏ chọn tất cả</a>
    </div>

    <!-- Thống kê theo trạng thái -->
    <div class="status-statistics">
      <nz-card class="statistic-card" [nzBordered]="false" (click)="filterByStatus('chua_gui')">
        <nz-statistic
          [nzValue]="getCountByStatus('chua_gui')"
          [nzTitle]="'Chưa gửi'"
          [nzValueStyle]="{ color: '#8c8c8c' }"
          [nzPrefix]="prefixChuaGui"
        ></nz-statistic>
        <ng-template #prefixChuaGui><span nz-icon nzType="file" nzTheme="outline"></span></ng-template>
      </nz-card>
      <nz-card class="statistic-card" [nzBordered]="false" (click)="filterByStatus('da_gui')">
        <nz-statistic
          [nzValue]="getCountByStatus('da_gui')"
          [nzTitle]="'Đã gửi'"
          [nzValueStyle]="{ color: '#1890ff' }"
          [nzPrefix]="prefixDaGui"
        ></nz-statistic>
        <ng-template #prefixDaGui><span nz-icon nzType="send" nzTheme="outline"></span></ng-template>
      </nz-card>
      <nz-card class="statistic-card" [nzBordered]="false" (click)="filterByStatus('da_duyet')">
        <nz-statistic
          [nzValue]="getCountByStatus('da_duyet')"
          [nzTitle]="'Đã duyệt'"
          [nzValueStyle]="{ color: '#52c41a' }"
          [nzPrefix]="prefixDaDuyet"
        ></nz-statistic>
        <ng-template #prefixDaDuyet><span nz-icon nzType="check-circle" nzTheme="outline"></span></ng-template>
      </nz-card>
      <nz-card class="statistic-card" [nzBordered]="false" (click)="filterByStatus('da_tu_choi')">
        <nz-statistic
          [nzValue]="getCountByStatus('da_tu_choi')"
          [nzTitle]="'Đã từ chối'"
          [nzValueStyle]="{ color: '#f5222d' }"
          [nzPrefix]="prefixDaTuChoi"
        ></nz-statistic>
        <ng-template #prefixDaTuChoi><span nz-icon nzType="close-circle" nzTheme="outline"></span></ng-template>
      </nz-card>
      <nz-card class="statistic-card" [nzBordered]="false" (click)="refreshData()">
        <nz-statistic
          [nzValue]="originalDotKeKhaiList.length"
          [nzTitle]="'Tổng số'"
          [nzValueStyle]="{ color: '#722ed1' }"
          [nzPrefix]="prefixTotal"
        ></nz-statistic>
        <ng-template #prefixTotal><span nz-icon nzType="database" nzTheme="outline"></span></ng-template>
      </nz-card>
      <nz-card class="statistic-card statistic-money" [nzBordered]="false" (click)="refreshData()">
        <nz-statistic
          [nzValue]="getTotalAmount()"
          [nzTitle]="'Tổng tiền đang xử lý'"
          [nzValueStyle]="{ color: '#fa8c16' }"
          [nzPrefix]="prefixMoney"
          [nzSuffix]="suffixMoney"
          [nzFormatter]="formatterVND"
        ></nz-statistic>
        <ng-template #prefixMoney><span nz-icon nzType="dollar" nzTheme="outline"></span></ng-template>
        <ng-template #suffixMoney>đ</ng-template>
      </nz-card>
    </div>

    <!-- Tab phân loại theo trạng thái -->
    <div class="status-tabs">
      <nz-tabset [(nzSelectedIndex)]="tabTrangThaiIndex" (nzSelectedIndexChange)="onTabChange($event)">
        <nz-tab [nzTitle]="tabTitleTatCa">
          <ng-template #tabTitleTatCa>
            <div class="tab-title-container">
              <span>Tất cả</span>
              <nz-badge [nzCount]="originalDotKeKhaiList.length" [nzOverflowCount]="999" [nzStyle]="{ backgroundColor: '#722ed1' }"></nz-badge>
            </div>
          </ng-template>
        </nz-tab>
        <nz-tab [nzTitle]="tabTitleChuaGui">
          <ng-template #tabTitleChuaGui>
            <div class="tab-title-container">
              <span>Chưa gửi</span>
              <nz-badge [nzCount]="getCountByStatus('chua_gui')" [nzOverflowCount]="999" [nzStyle]="{ backgroundColor: '#8c8c8c' }"></nz-badge>
            </div>
          </ng-template>
        </nz-tab>
        <nz-tab [nzTitle]="tabTitleDaGui">
          <ng-template #tabTitleDaGui>
            <div class="tab-title-container">
              <span>Đã gửi</span>
              <nz-badge [nzCount]="getCountByStatus('da_gui')" [nzOverflowCount]="999" [nzStyle]="{ backgroundColor: '#1890ff' }"></nz-badge>
            </div>
          </ng-template>
        </nz-tab>
        <nz-tab [nzTitle]="tabTitleDaDuyet">
          <ng-template #tabTitleDaDuyet>
            <div class="tab-title-container">
              <span>Đã duyệt</span>
              <nz-badge [nzCount]="getCountByStatus('da_duyet')" [nzOverflowCount]="999" [nzStyle]="{ backgroundColor: '#52c41a' }"></nz-badge>
            </div>
          </ng-template>
        </nz-tab>
        <nz-tab [nzTitle]="tabTitleDaTuChoi">
          <ng-template #tabTitleDaTuChoi>
            <div class="tab-title-container">
              <span>Đã từ chối</span>
              <nz-badge [nzCount]="getCountByStatus('da_tu_choi')" [nzOverflowCount]="999" [nzStyle]="{ backgroundColor: '#f5222d' }"></nz-badge>
            </div>
          </ng-template>
        </nz-tab>
        <nz-tab [nzTitle]="tabTitleChoThanhToan">
          <ng-template #tabTitleChoThanhToan>
            <div class="tab-title-container">
              <span>Chờ thanh toán</span>
              <nz-badge [nzCount]="getCountByStatus('cho_thanh_toan')" [nzOverflowCount]="999" [nzStyle]="{ backgroundColor: '#faad14' }"></nz-badge>
            </div>
          </ng-template>
        </nz-tab>
        <nz-tab [nzTitle]="tabTitleHoanThanh">
          <ng-template #tabTitleHoanThanh>
            <div class="tab-title-container">
              <span>Hoàn thành</span>
              <nz-badge [nzCount]="getCountByStatus('hoan_thanh')" [nzOverflowCount]="999" [nzStyle]="{ backgroundColor: '#13c2c2' }"></nz-badge>
            </div>
          </ng-template>
        </nz-tab>
      </nz-tabset>
    </div>

    <!-- Bộ lọc và tìm kiếm -->
    <div class="filter-section">
      <div class="search-box">
        <nz-input-group [nzSuffix]="suffixIconSearch">
          <input type="text" nz-input placeholder="Tìm kiếm theo tên đợt kê khai..." [(ngModel)]="searchText" />
        </nz-input-group>
        <ng-template #suffixIconSearch>
          <span nz-icon nzType="search" nzTheme="outline"></span>
        </ng-template>
      </div>

      <div class="filter-options">
        <nz-select class="filter-item" nzPlaceHolder="Loại dịch vụ" [(ngModel)]="danhSachFilters.dichVu" nzAllowClear>
          <nz-option *ngFor="let option of danhSachDichVu" [nzValue]="option.value" [nzLabel]="option.text"></nz-option>
        </nz-select>

        <nz-select class="filter-item" nzPlaceHolder="Đơn vị" [(ngModel)]="danhSachFilters.donVi" nzAllowClear>
          <nz-option *ngFor="let option of danhSachDonVi" [nzValue]="option.value" [nzLabel]="option.text"></nz-option>
        </nz-select>

        <nz-input-group class="filter-item" [nzSuffix]="suffixTemplateUser">
          <input type="text" nz-input placeholder="Mã nhân viên" [(ngModel)]="danhSachFilters.maNhanVien" />
        </nz-input-group>
        <ng-template #suffixTemplateUser>
          <span nz-icon nzType="user" nzTheme="outline"></span>
        </ng-template>

        <nz-select class="filter-item" nzPlaceHolder="Tháng" [(ngModel)]="danhSachFilters.thang" nzAllowClear>
          <nz-option *ngFor="let option of danhSachThang" [nzValue]="option.value" [nzLabel]="option.text"></nz-option>
        </nz-select>

        <nz-select class="filter-item" nzPlaceHolder="Năm" [(ngModel)]="danhSachFilters.nam" nzAllowClear>
          <nz-option *ngFor="let option of danhSachNam" [nzValue]="option.value" [nzLabel]="option.text"></nz-option>
        </nz-select>

        <button nz-button nzType="primary" (click)="searchData()">
          <span nz-icon nzType="filter" nzTheme="outline"></span>
          Lọc
        </button>
      </div>
    </div>

    <!-- Danh sách kê khai -->
    <nz-table
      #basicTable
      [nzData]="dotKeKhaiList"
      [nzLoading]="loading"
      [nzBordered]="true"
      [nzShowSizeChanger]="true"
      [nzPageSizeOptions]="[10, 20, 30, 50]"
      nzShowPagination
    >
      <thead>
        <tr>
          <th nzWidth="40px" [nzChecked]="isTatCaDaChon()" [nzIndeterminate]="isIndeterminate()" (nzCheckedChange)="onCheckTatCa($event)"></th>
          <th>Tên đợt kê khai</th>
          <th>Mã hồ sơ</th>
          <th>Loại dịch vụ</th>
          <th>Đơn vị</th>
          <th>Số thẻ</th>
          <th>Tổng tiền</th>
          <th>Ngày gửi</th>
          <th>Mã nhân viên</th>
          <th>Trạng thái</th>
          <th nzWidth="100px">Hóa đơn</th>
          <th nzWidth="150px">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of basicTable.data">
          <td [nzChecked]="data.id ? danhSachDaChon.has(data.id) : false" (nzCheckedChange)="data.id && onCheckDotKeKhai(data.id, $event)"></td>
          <td>{{ data.ten_dot }}</td>
          <td>
            <div class="editable-cell">
              <div class="editable-cell-value-wrap" *ngIf="!editingId || editingId !== data.id" (click)="startEdit(data)">
                {{ data.ma_ho_so || '-' }}
                <span nz-icon nzType="edit" nzTheme="outline" class="edit-icon"></span>
              </div>
              <div *ngIf="editingId === data.id" class="editable-cell-input">
                <input 
                  nz-input 
                  [(ngModel)]="maHoSoTemp" 
                  (blur)="saveEdit(data)" 
                  (keydown.enter)="saveEdit(data)" 
                  (keydown.esc)="cancelEdit()" 
                  placeholder="Nhập mã hồ sơ"/>
              </div>
            </div>
          </td>
          <td>{{ data.dich_vu }}</td>
          <td>{{ getDonViName(data) }}</td>
          <td>{{ data.tong_so_the || 0 }}</td>
          <td>{{ data.tong_so_tien | number }} đ</td>
          <td>
            <ng-container *ngIf="data.ngay_gui">{{ data.ngay_gui | date: 'dd/MM/yyyy HH:mm' }}</ng-container>
            <ng-container *ngIf="!data.ngay_gui">-</ng-container>
          </td>
          <td>{{ data.nguoi_tao || '-' }}</td>
          <td>
            <div class="editable-cell">
              <div class="editable-cell-value-wrap" *ngIf="!editingTrangThaiId || editingTrangThaiId !== data.id" (click)="startEditTrangThai(data)">
                <nz-tag [nzColor]="getTrangThaiType(data.trang_thai)">
                  {{ getTrangThaiText(data.trang_thai) }}
                </nz-tag>
                <span nz-icon nzType="edit" nzTheme="outline" class="edit-icon"></span>
              </div>
              <div *ngIf="editingTrangThaiId === data.id" class="editable-cell-input">
                <nz-select 
                  #trangThaiSelect
                  [(ngModel)]="trangThaiTemp" 
                  (ngModelChange)="saveTrangThai(data)"
                  (blur)="cancelEditTrangThai()"
                  nzOpen
                  style="width: 100%">
                  <nz-option 
                    *ngFor="let tt of danhSachTrangThai" 
                    [nzValue]="tt.value" 
                    [nzLabel]="tt.text">
                  </nz-option>
                </nz-select>
              </div>
            </div>
          </td>
          <td>
            <button 
              *ngIf="data.url_bill" 
              nz-button 
              nzType="default" 
              nzShape="circle" 
              (click)="xemHoaDon(data)" 
              nz-tooltip 
              nzTooltipTitle="Xem hóa đơn">
              <span nz-icon nzType="file-image" nzTheme="outline"></span>
            </button>
            <span *ngIf="!data.url_bill">Không có</span>
          </td>
          <td>
            <div class="action-buttons">
              <button nz-button nzType="primary" (click)="xemChiTiet(data)" nz-tooltip nzTooltipTitle="Xem chi tiết">
                <span nz-icon nzType="eye" nzTheme="outline"></span>
              </button>
              
              <a nz-dropdown [nzDropdownMenu]="menu" nzTrigger="click" nzPlacement="bottomRight">
                <button nz-button nzType="default">
                  <span nz-icon nzType="more" nzTheme="outline"></span>
                </button>
              </a>
              <nz-dropdown-menu #menu="nzDropdownMenu">
                <ul nz-menu>
                  <li nz-menu-item (click)="chinhSuaDotKeKhai(data)">
                    <span nz-icon nzType="edit" nzTheme="outline"></span>
                    Chỉnh sửa
                  </li>
                  
                  <li nz-menu-item (click)="xuatExcelDotKeKhai(data)">
                    <span nz-icon nzType="file-excel" nzTheme="outline"></span>
                    Xuất Excel
                  </li>
                  
                  <li nz-menu-item *ngIf="data.trang_thai === 'da_gui'" (click)="duyetDotKeKhai(data)">
                    <span nz-icon nzType="check-circle" nzTheme="outline"></span>
                    Duyệt
                  </li>
                  
                  <li nz-menu-item *ngIf="data.trang_thai === 'da_gui'" (click)="tuChoiDotKeKhai(data)">
                    <span nz-icon nzType="close-circle" nzTheme="outline"></span>
                    Từ chối
                  </li>

                  <li nz-menu-divider></li>
                  
                  <li nz-menu-item nzDanger (click)="xoaDotKeKhai(data)">
                    <span nz-icon nzType="delete" nzTheme="outline"></span>
                    Xóa
                  </li>
                </ul>
              </nz-dropdown-menu>
            </div>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>
</div>

<!-- Modal xem hóa đơn -->
<app-xem-hoa-don-modal
  [isVisible]="isModalVisible"
  [dotKeKhai]="selectedDotKeKhai"
  [urlBill]="selectedHoaDonUrl"
  (closeModal)="handleModalCancel()"
  (viewKeKhaiBHYT)="xemKeKhaiBHYT($event)"
  (uploadBill)="uploadThayThe()"
  (downloadBill)="taiHoaDon()"
></app-xem-hoa-don-modal>

<!-- Modal nhập mã nhân viên thu -->
<nz-modal
  [(nzVisible)]="isModalNhapMaNhanVienVisible"
  nzTitle="Nhập mã nhân viên thu"
  (nzOnCancel)="handleModalNhapMaNhanVienCancel()"
  (nzOnOk)="handleModalOk()"
  [nzOkText]="'Đồng ý'"
  [nzCancelText]="'Hủy'"
>
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="maNhanVienForm">
      <nz-form-item>
        <nz-form-label [nzSpan]="24">Mã nhân viên thu</nz-form-label>
        <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mã nhân viên">
          <input nz-input formControlName="maNhanVien" placeholder="Nhập mã nhân viên thu" />
        </nz-form-control>
      </nz-form-item>
      <nz-form-item>
        <nz-form-control [nzSpan]="24">
          <label nz-checkbox formControlName="luuMaNhanVien">Lưu mã nhân viên này cho các lần sau</label>
        </nz-form-control>
      </nz-form-item>
      <nz-alert
        nzType="info"
        nzMessage="Thông báo"
        nzDescription="Mã nhân viên thu sẽ được sử dụng trong file xuất VNPT"
        nzShowIcon
      ></nz-alert>
    </form>
  </ng-container>
</nz-modal>

<!-- Modal xác nhận xóa đợt kê khai -->
<nz-modal
  [(nzVisible)]="isModalXoaVisible"
  nzTitle="Xác nhận xóa đợt kê khai"
  (nzOnCancel)="handleModalXoaCancel()"
  (nzOnOk)="confirmXoaDotKeKhai()"
  [nzOkText]="'Xóa'"
  [nzOkDanger]="true"
  [nzCancelText]="'Hủy'"
>
  <ng-container *nzModalContent>
    <p>Bạn có chắc chắn muốn xóa đợt kê khai "<strong>{{ selectedDotKeKhai?.ten_dot }}</strong>"?</p>
    <nz-alert
      nzType="warning"
      nzMessage="Cảnh báo"
      nzDescription="Hành động này không thể hoàn tác. Tất cả dữ liệu liên quan đến đợt kê khai này sẽ bị xóa vĩnh viễn."
      nzShowIcon
    ></nz-alert>
  </ng-container>
</nz-modal>

<!-- Modal xem chi tiết đợt kê khai -->
<nz-modal
  [(nzVisible)]="isModalChiTietVisible"
  [nzTitle]="chiTietModalTitle"
  (nzOnCancel)="handleModalChiTietCancel()"
  [nzWidth]="800"
  [nzFooter]="chiTietModalFooter"
>
  <ng-template #chiTietModalTitle>
    <div class="chi-tiet-header">
      <h3>Chi tiết đợt kê khai</h3>
      <span *ngIf="selectedDotKeKhai">{{ selectedDotKeKhai.ten_dot }}</span>
    </div>
  </ng-template>
  
  <ng-container *nzModalContent>
    <nz-spin [nzSpinning]="loading">
      <div class="chi-tiet-container">
        <ng-container *ngIf="selectedDotKeKhai && selectedDotKeKhai.id">
          <button nz-button nzType="primary" class="ds-button" (click)="loadDanhSachKeKhai(selectedDotKeKhai.id)">
            <span nz-icon nzType="reload" nzTheme="outline"></span>
            Tải danh sách
          </button>
          
          <nz-table 
            #keKhaiTable 
            [nzData]="danhSachKeKhai" 
            [nzLoading]="loadingKeKhai"
            [nzPageSize]="10"
            nzBordered>
            <thead>
              <tr>
                <th>STT</th>
                <th>Họ tên</th>
                <th>CCCD/CMND</th>
                <th>Mã số BHXH</th>
                <th>Số thẻ BHYT</th>
                <th>Số tiền</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of keKhaiTable.data; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ item.ho_ten }}</td>
                <td>{{ item.cccd || '' }}</td>
                <td>{{ item.ma_so_bhxh || '' }}</td>
                <td>{{ item.so_the_bhyt || '' }}</td>
                <td class="text-right">{{ item.so_tien | number }} đ</td>
              </tr>
            </tbody>
            <tfoot *ngIf="danhSachKeKhai.length > 0">
              <tr>
                <td colspan="5" class="text-right font-bold">Tổng cộng:</td>
                <td class="text-right font-bold">{{ tinhTongTien() | number }} đ</td>
              </tr>
            </tfoot>
          </nz-table>
          
          <div *ngIf="danhSachKeKhai.length === 0 && !loadingKeKhai" class="empty-data">
            <span nz-icon nzType="inbox" nzTheme="outline"></span>
            <p>Không có dữ liệu kê khai</p>
          </div>
        </ng-container>
      </div>
    </nz-spin>
  </ng-container>
  
  <ng-template #chiTietModalFooter>
    <button nz-button nzType="default" (click)="handleModalChiTietCancel()">Đóng</button>
    <button nz-button nzType="primary" *ngIf="selectedDotKeKhai" (click)="chinhSuaDotKeKhai(selectedDotKeKhai)">
      <span nz-icon nzType="edit" nzTheme="outline"></span>
      Chỉnh sửa
    </button>
    <button nz-button nzType="primary" *ngIf="selectedDotKeKhai" (click)="xuatExcelDotKeKhai(selectedDotKeKhai)">
      <span nz-icon nzType="file-excel" nzTheme="outline"></span>
      Xuất Excel
    </button>
  </ng-template>
</nz-modal>
````

## File: WebApp.Client/src/app/ke-khai/admin-danh-sach-ke-khai/admin-danh-sach-ke-khai.component.scss
````scss
.page-container {
  padding: 20px;
  background-color: #f0f2f5;
  min-height: calc(100vh - 64px);
}

.main-card {
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  
  h2 {
    margin-bottom: 0;
  }
  
  .page-actions {
    display: flex;
    gap: 8px;
  }
}

/* Thống kê theo trạng thái */
.status-statistics {
  display: flex;
  gap: 16px;
  margin-top: 16px;
  margin-bottom: 16px;
  flex-wrap: wrap;
  
  .statistic-card {
    flex: 1;
    min-width: 180px;
    cursor: pointer;
    transition: all 0.3s;
    
    &:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    &.statistic-money {
      background-color: #fff7e6;
      border: 1px solid #ffd591;
      
      &:hover {
        background-color: #ffe7ba;
        box-shadow: 0 2px 8px rgba(250, 140, 22, 0.2);
      }
      
      ::ng-deep {
        .ant-statistic-title {
          color: #873800;
          font-weight: 500;
        }
        
        .ant-statistic-content {
          color: #d46b08;
        }
      }
    }
  }
}

/* Tab phân loại theo trạng thái */
.status-tabs {
  margin-bottom: 24px;

  ::ng-deep {
    .ant-tabs-nav {
      margin-bottom: 16px;
    }
    
    .ant-tabs-tab {
      padding: 8px 16px;
      transition: all 0.3s;
      
      &:hover {
        color: #1890ff;
      }
      
      .ant-tabs-tab-btn {
        display: flex;
        align-items: center;
      }
    }
    
    .ant-tabs-ink-bar {
      height: 3px;
      border-radius: 3px 3px 0 0;
    }
    
    // Chỉnh lại cách hiển thị badge trong tab
    .ant-badge {
      display: inline-block;
      vertical-align: middle;
      margin-left: 8px;
    }
    
    .ant-badge-count {
      position: static;
      transform: none;
      height: 20px;
      min-width: 20px;
      line-height: 20px;
      padding: 0 6px;
      font-size: 12px;
      border-radius: 10px;
      box-shadow: none;
    }
  }
  
  .tab-title-container {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 22px;
    line-height: 22px;
    white-space: nowrap;
    
    span {
      display: inline-block;
      vertical-align: middle;
    }
  }
}

.filter-section {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  margin-bottom: 20px;

  .search-box {
    width: 300px;
  }

  .filter-options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    flex: 1;
  }

  .filter-item {
    width: 150px;
  }
}

.action-buttons {
  display: flex;
  gap: 8px;
  justify-content: flex-start;
  align-items: center;
  
  button {
    margin-right: 0;
  }
}

/* Style cho dropdown menu */
:host ::ng-deep {
  .ant-dropdown-menu {
    min-width: 160px;
    
    .ant-dropdown-menu-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      
      .anticon {
        margin-right: 8px;
        font-size: 14px;
      }
    }
  }
}

/* Responsive */
@media (max-width: 768px) {
  .status-statistics {
    flex-direction: column;
    
    .statistic-card {
      width: 100%;
      min-width: 100%;
    }
  }
  
  .filter-section {
    flex-direction: column;
    
    .search-box {
      width: 100%;
    }
    
    .filter-options {
      width: 100%;
      justify-content: space-between;
    }
    
    .filter-item {
      width: 48%;
      margin-bottom: 8px;
    }
  }
}

/* CSS cho body khi ở chế độ toàn màn hình */
:host ::ng-deep {
  .overflow-hidden {
    overflow: hidden !important;
  }
  
  // CSS cho modal
  .bill-modal {
    .ant-modal {
      max-width: 900px !important;
      
      .ant-modal-content {
        overflow: hidden;
        border-radius: 8px;
      }
      
      .ant-modal-header {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
      }
      
      .ant-modal-body {
        padding: 0 !important;
        max-height: 80vh;
        overflow: hidden;
      }
      
      .ant-modal-footer {
        padding: 10px 16px;
        border-top: 1px solid #f0f0f0;
      }
    }
  }
}

/* CSS cho modal xem hóa đơn */
.bill-modal-content {
  display: flex;
  flex-direction: row;
  height: 550px;
  max-height: 80vh;
  
  &.fullscreen-mode {
    .bill-image-wrapper {
      background-color: rgba(0, 0, 0, 0.9);
    }
  }
  
  @media (max-width: 767px) {
    flex-direction: column;
    height: auto;
    
    .bill-image-wrapper {
      min-height: 300px;
    }
  }
}

.bill-image-wrapper {
  flex: 1;
  position: relative;
  background-color: #f5f5f5;
  border-right: 1px solid #f0f0f0;
  
  @media (max-width: 767px) {
    border-right: none;
    border-bottom: 1px solid #f0f0f0;
  }
}

.loading-container {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: rgba(255, 255, 255, 0.8);
  z-index: 50;
}

.bill-image-container {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  overflow: hidden;
  padding: 16px;
}

.bill-toolbar {
  position: absolute;
  top: 10px;
  right: 10px;
  background-color: rgba(255, 255, 255, 0.8);
  border-radius: 4px;
  padding: 4px 8px;
  display: flex;
  gap: 4px;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  
  button {
    transition: transform 0.2s ease;
    
    &:hover {
      transform: scale(1.1);
    }
  }
}

.drag-instruction {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.6);
  color: white;
  border-radius: 4px;
  padding: 4px 12px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  z-index: 100;
  
  span[nz-icon] {
    font-size: 16px;
  }
}

.bill-image {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border: 1px solid #e8e8e8;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  transition: transform 0.3s ease;
  user-select: none;
  -webkit-user-drag: none;
  
  &.hidden {
    opacity: 0;
  }
}

.bill-info {
  width: 300px;
  padding: 16px;
  overflow-y: auto;
  
  @media (max-width: 767px) {
    width: 100%;
  }
}

.bill-info-content {
  h3 {
    margin-top: 0;
    margin-bottom: 16px;
    font-size: 16px;
    font-weight: 500;
  }
  
  .action-buttons {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    flex-wrap: wrap;
  }
}

.fullscreen-note {
  margin-top: 16px;
}

.no-bill-message {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 40px;
  height: 100%;
  color: #999;
  font-size: 14px;
  
  .empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    color: #d9d9d9;
  }
}

.modal-title {
  display: flex;
  flex-direction: column;
  
  .bill-subtitle {
    font-size: 12px;
    color: rgba(0, 0, 0, 0.45);
  }
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

/* Thông báo đã chọn */
.selected-summary {
  margin: 12px 0;
  padding: 8px 12px;
  background-color: #e6f7ff;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 16px;
  
  a {
    color: #1890ff;
    font-weight: 500;
    cursor: pointer;
    
    &:hover {
      text-decoration: underline;
    }
  }
}

/* Bảng danh sách kê khai */
nz-table {
  margin-top: 1rem;
}

/* Thêm CSS cho checkbox trong header */
::ng-deep .ant-table-selection-column {
  text-align: center;
}

// CSS cho chỉnh sửa inline
.editable-cell {
  position: relative;
  
  .editable-cell-value-wrap {
    padding: 5px 12px;
    padding-right: 28px;
    cursor: pointer;
    min-height: 32px;
    display: flex;
    align-items: center;
    
    &:hover {
      background-color: rgba(24, 144, 255, 0.05);
      
      .edit-icon {
        opacity: 1;
      }
    }
    
    .edit-icon {
      opacity: 0;
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      transition: all 0.3s;
      font-size: 14px;
      color: #1890ff;
    }

    nz-tag {
      transition: all 0.3s;
    }
  }
  
  .editable-cell-input {
    margin: 4px;
    
    nz-select {
      width: 100%;
      
      ::ng-deep {
        .ant-select-selector {
          border-radius: 4px;
          border: 1px solid #d9d9d9;
          transition: all 0.3s;
          
          &:hover {
            border-color: #40a9ff;
          }
        }
        
        &.ant-select-focused .ant-select-selector {
          border-color: #40a9ff;
          box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
      }
    }
  }
}

/* CSS cho modal chi tiết đợt kê khai */
.chi-tiet-header {
  h3 {
    margin-bottom: 4px;
    font-size: 18px;
    font-weight: 500;
  }
  
  span {
    font-size: 14px;
    color: rgba(0, 0, 0, 0.45);
  }
}

.chi-tiet-container {
  padding: 8px 0;
}

.chi-tiet-row {
  display: flex;
  margin-bottom: 16px;
  
  @media (max-width: 767px) {
    flex-direction: column;
  }
}

.chi-tiet-col {
  flex: 1;
  padding-right: 16px;
  
  @media (max-width: 767px) {
    padding-right: 0;
  }
}

.chi-tiet-item {
  margin-bottom: 16px;
  
  label {
    font-weight: 500;
    color: rgba(0, 0, 0, 0.65);
    display: block;
    margin-bottom: 4px;
  }
  
  div {
    color: rgba(0, 0, 0, 0.85);
  }
}

.hoa-don-section {
  margin-top: 16px;
  border-top: 1px dashed #e8e8e8;
  padding-top: 16px;
}

.hoa-don-preview {
  display: flex;
  align-items: center;
  gap: 16px;
  
  .hoa-don-thumbnail {
    width: 120px;
    height: 80px;
    object-fit: contain;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
    
    &:hover {
      border-color: #1890ff;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }
  }
}

.ds-button {
  margin-bottom: 16px;
}

.empty-data {
  padding: 32px;
  text-align: center;
  color: rgba(0, 0, 0, 0.45);
  
  span[nz-icon] {
    font-size: 48px;
    margin-bottom: 16px;
    display: block;
  }
  
  p {
    margin: 0;
  }
}

/* Classes tiện ích */
.text-right {
  text-align: right;
}

.font-bold {
  font-weight: 600;
}
````

## File: WebApp.Client/src/app/ke-khai/admin-danh-sach-ke-khai/admin-danh-sach-ke-khai.component.ts
````typescript
import { Component, OnInit, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { RouterModule, Router } from '@angular/router';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule, NzIconService } from 'ng-zorro-antd/icon';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzDatePickerModule } from 'ng-zorro-antd/date-picker';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzModalService } from 'ng-zorro-antd/modal';
import { NzCardModule } from 'ng-zorro-antd/card';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzDropDownModule } from 'ng-zorro-antd/dropdown';
import { NzToolTipModule } from 'ng-zorro-antd/tooltip';
import { NzBadgeModule } from 'ng-zorro-antd/badge';
import { NzSpinModule } from 'ng-zorro-antd/spin';
import { NzStatisticModule } from 'ng-zorro-antd/statistic';
import { NzTabsModule } from 'ng-zorro-antd/tabs';
import { NzMenuModule } from 'ng-zorro-antd/menu';
import { DotKeKhaiService, DotKeKhai } from '../../services/dot-ke-khai.service';
import { KeKhaiBHYTService } from '../../services/ke-khai-bhyt.service';
import { UserService } from '../../services/user.service';
import { DonViService, DonVi } from '../../services/don-vi.service';
import { ExportVnptService } from '../../services/export-vnpt.service';
import * as XLSX from 'xlsx';
import { 
  ExportOutline, 
  EyeOutline, 
  EditOutline, 
  DeleteOutline, 
  FileExcelOutline,
  CheckCircleOutline,
  CloseCircleOutline,
  SearchOutline,
  FilterOutline,
  ReloadOutline,
  SendOutline,
  FileOutline,
  DatabaseOutline,
  FileImageOutline,
  DownloadOutline,
  DollarOutline
} from '@ant-design/icons-angular/icons';
import { environment } from '../../../environments/environment';
import { XemHoaDonModalComponent } from '../../shared/components/xem-hoa-don-modal/xem-hoa-don-modal.component';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { NzAlertModule } from 'ng-zorro-antd/alert';
import { NzCheckboxModule } from 'ng-zorro-antd/checkbox';
import { HttpClient } from '@angular/common/http';

@Component({
  selector: 'app-admin-danh-sach-ke-khai',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    RouterModule,
    NzTableModule,
    NzButtonModule,
    NzIconModule,
    NzTagModule,
    NzModalModule,
    NzFormModule,
    NzInputModule,
    NzDatePickerModule,
    NzSelectModule,
    NzCardModule,
    NzDividerModule,
    NzDropDownModule,
    NzToolTipModule,
    NzBadgeModule,
    NzSpinModule,
    NzStatisticModule,
    NzTabsModule,
    NzAlertModule,
    NzCheckboxModule,
    XemHoaDonModalComponent,
    NzMenuModule
  ],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  templateUrl: './admin-danh-sach-ke-khai.component.html',
  styleUrls: ['./admin-danh-sach-ke-khai.component.scss']
})
export class AdminDanhSachKeKhaiComponent implements OnInit {
  dotKeKhaiList: DotKeKhai[] = [];
  originalDotKeKhaiList: DotKeKhai[] = []; // Lưu trữ dữ liệu gốc
  loading = false;
  searchText = '';
  
  // Biến cho modal chi tiết
  isModalChiTietVisible = false;
  danhSachKeKhai: any[] = [];
  loadingKeKhai = false;
  
  // Biến lưu danh sách id đợt kê khai đã được chọn
  danhSachDaChon = new Set<number>();
  
  // Biến cho modal hiển thị hóa đơn
  isModalVisible = false;
  selectedDotKeKhai: DotKeKhai | null = null;
  selectedHoaDonUrl: string | null = null;
  
  // Cache hóa đơn đã tải
  private imageCache: Map<string, string> = new Map();
  
  // Cache số lượng theo trạng thái
  private statusCountCache: Map<string, number> = new Map();
  
  // Biến cho tab
  tabTrangThaiIndex = 0;
  
  danhSachFilters = {
    dichVu: null as string | null,
    trangThai: null as string | null,
    donVi: null as number | null,
    nam: null as number | null,
    thang: null as number | null,
    maNhanVien: null as string | null
  };
  danhSachDichVu = [
    { text: 'BHYT', value: 'BHYT' },
    { text: 'BHXH TN', value: 'BHXH TN' }
  ];
  danhSachTrangThai = [
    { text: 'Chưa gửi', value: 'chua_gui' },
    { text: 'Đã gửi', value: 'da_gui' },
    { text: 'Đã duyệt', value: 'da_duyet' },
    { text: 'Đã từ chối', value: 'da_tu_choi' },
    { text: 'Chờ thanh toán', value: 'cho_thanh_toan' },
    { text: 'Hoàn thành', value: 'hoan_thanh' },
    { text: 'Đang xử lý', value: 'dang_xu_ly' }
  ];
  danhSachThang = Array.from({ length: 12 }, (_, i) => ({
    text: `Tháng ${i + 1}`,
    value: i + 1
  }));
  danhSachNam = Array.from({ length: 5 }, (_, i) => {
    const year = new Date().getFullYear() - 2 + i;
    return { text: `Năm ${year}`, value: year };
  });
  danhSachDonVi: { text: string; value: number }[] = [];

  // Form và modal nhập mã nhân viên
  maNhanVienForm!: FormGroup;
  isModalNhapMaNhanVienVisible = false;
  
  // Biến cho modal xác nhận xóa đợt kê khai
  isModalXoaVisible = false;
  dotKeKhaiToDelete: DotKeKhai | null = null;

  // Biến cho chế độ chỉnh sửa
  editingId: number | null = null;
  maHoSoTemp: string = '';

  // Biến cho chế độ chỉnh sửa trạng thái
  editingTrangThaiId: number | null = null;
  trangThaiTemp: string = '';

  // Định dạng số tiền VND
  formatterVND = (value: number): string => `${value.toLocaleString('vi-VN')}`;

  constructor(
    private dotKeKhaiService: DotKeKhaiService,
    private keKhaiBHYTService: KeKhaiBHYTService,
    private userService: UserService,
    private donViService: DonViService,
    private modalService: NzModalService,
    private message: NzMessageService,
    private iconService: NzIconService,
    private exportVnptService: ExportVnptService,
    private fb: FormBuilder,
    private router: Router,
    private http: HttpClient
  ) {
    this.iconService.addIcon(...[
      ExportOutline, 
      EyeOutline, 
      EditOutline, 
      DeleteOutline, 
      FileExcelOutline,
      CheckCircleOutline,
      CloseCircleOutline,
      SearchOutline,
      FilterOutline,
      ReloadOutline,
      SendOutline,
      FileOutline,
      DatabaseOutline,
      FileImageOutline,
      DownloadOutline,
      DollarOutline
    ]);

    // Khởi tạo form
    this.maNhanVienForm = this.fb.group({
      maNhanVien: ['', [Validators.required]],
      luuMaNhanVien: [true]
    });
  }

  ngOnInit(): void {
    this.loadDotKeKhaiList();
    this.loadDonViList();
    
    // Tải mã nhân viên từ localStorage nếu có
    const savedMaNhanVien = localStorage.getItem('maNhanVienThu');
    if (savedMaNhanVien) {
      this.maNhanVienForm.patchValue({
        maNhanVien: savedMaNhanVien
      });
    }
  }

  // Phương thức đếm số lượng đợt kê khai theo trạng thái với cache
  getCountByStatus(status: string): number {
    // Kiểm tra cache trước
    if (this.statusCountCache.has(status)) {
      return this.statusCountCache.get(status) || 0;
    }
    
    if (!this.originalDotKeKhaiList || this.originalDotKeKhaiList.length === 0) return 0;
    
    // Tính và cache kết quả từ dữ liệu gốc
    const count = this.originalDotKeKhaiList.filter(item => item.trang_thai === status).length;
    this.statusCountCache.set(status, count);
    return count;
  }

  // Cập nhật cache số lượng
  private updateStatusCountCache(): void {
    this.statusCountCache.clear();
    this.danhSachTrangThai.forEach(status => {
      const count = this.originalDotKeKhaiList.filter(item => item.trang_thai === status.value).length;
      this.statusCountCache.set(status.value, count);
    });
  }

  // Filter theo trạng thái khi click vào thẻ thống kê
  filterByStatus(status: string): void {
    this.danhSachFilters.trangThai = status;
    
    // Cập nhật tab tương ứng với trạng thái
    switch (status) {
      case 'chua_gui':
        this.tabTrangThaiIndex = 1;
        break;
      case 'da_gui':
        this.tabTrangThaiIndex = 2;
        break;
      case 'da_duyet':
        this.tabTrangThaiIndex = 3;
        break;
      case 'da_tu_choi':
        this.tabTrangThaiIndex = 4;
        break;
      case 'cho_thanh_toan':
        this.tabTrangThaiIndex = 5;
        break;
      case 'hoan_thanh':
        this.tabTrangThaiIndex = 6;
        break;
      case 'dang_xu_ly':
        this.tabTrangThaiIndex = 7;
        break;
      default:
        this.tabTrangThaiIndex = 0;
        break;
    }
    
    this.applyFilters();
  }

  loadDotKeKhaiList(): void {
    this.loading = true;
    this.danhSachDaChon.clear(); // Xóa danh sách đã chọn khi tải dữ liệu mới
    
    // Hiển thị thông báo đang tải
    const loadingMsg = this.message.loading('Đang tải danh sách đợt kê khai...', { nzDuration: 0 });
    
    this.dotKeKhaiService.getDotKeKhais().subscribe({
      next: (data: DotKeKhai[]) => {
        // Đóng thông báo loading
        this.message.remove(loadingMsg.messageId);
        
        // Sắp xếp danh sách theo ngày tạo mới nhất
        const sortedData = [...data].sort((a, b) => {
          const dateA = new Date(a.ngay_tao || '');
          const dateB = new Date(b.ngay_tao || '');
          return dateB.getTime() - dateA.getTime();
        });
        
        this.originalDotKeKhaiList = sortedData; // Lưu bản sao của dữ liệu gốc đã sắp xếp
        this.dotKeKhaiList = sortedData;
        this.updateStatusCountCache(); // Cập nhật cache khi có dữ liệu mới
        
        // Debug: Kiểm tra cấu trúc dữ liệu
        if (data && data.length > 0) {
          console.log('Dữ liệu DotKeKhai từ API:', data[0]);
          console.log('Thuộc tính DonVi:', data[0].DonVi);
          console.log('Thuộc tính don_vi:', data[0].don_vi);
          console.log('Tất cả các thuộc tính:', Object.keys(data[0]));
        }
        
        this.loading = false;
      },
      error: (error: any) => {
        // Đóng thông báo loading
        this.message.remove(loadingMsg.messageId);
        
        console.error('Lỗi khi tải danh sách đợt kê khai:', error);
        this.message.error('Có lỗi xảy ra khi tải danh sách đợt kê khai');
        this.loading = false;
      }
    });
  }

  loadDonViList(): void {
    // Gọi API để lấy danh sách đơn vị
    this.donViService.getDonVis().subscribe({
      next: (data: DonVi[]) => {
        if (data && data.length > 0) {
          this.danhSachDonVi = data.map(donVi => ({
            text: donVi.tenDonVi || 'Không có tên',
            value: donVi.id
          }));
        }
      },
      error: (error) => {
        console.error('Lỗi khi tải danh sách đơn vị:', error);
        this.message.error('Có lỗi khi tải danh sách đơn vị');
      }
    });
  }

  refreshData(): void {
    this.danhSachDaChon.clear(); // Xóa danh sách đã chọn khi làm mới dữ liệu
    this.searchText = '';
    this.danhSachFilters = {
      dichVu: null,
      trangThai: null,
      donVi: null,
      nam: null,
      thang: null,
      maNhanVien: null
    };
    this.tabTrangThaiIndex = 0;
    this.loadDotKeKhaiList();
  }

  // Áp dụng bộ lọc vào dữ liệu gốc
  applyFilters(): void {
    this.loading = true;
    
    let filteredData = [...this.originalDotKeKhaiList];
    
    // Lọc theo từ khóa tìm kiếm
    if (this.searchText && this.searchText.trim() !== '') {
      const searchLower = this.searchText.toLowerCase().trim();
      filteredData = filteredData.filter(item => 
        item.ten_dot.toLowerCase().includes(searchLower) || 
        (item.ma_ho_so && item.ma_ho_so.toLowerCase().includes(searchLower)) ||
        (item.ghi_chu && item.ghi_chu.toLowerCase().includes(searchLower))
      );
    }
    
    // Lọc theo loại dịch vụ
    if (this.danhSachFilters.dichVu) {
      filteredData = filteredData.filter(item => item.dich_vu === this.danhSachFilters.dichVu);
    }
    
    // Lọc theo trạng thái
    if (this.danhSachFilters.trangThai) {
      filteredData = filteredData.filter(item => item.trang_thai === this.danhSachFilters.trangThai);
    }
    
    // Lọc theo tháng
    if (this.danhSachFilters.thang) {
      filteredData = filteredData.filter(item => item.thang === this.danhSachFilters.thang);
    }
    
    // Lọc theo năm
    if (this.danhSachFilters.nam) {
      filteredData = filteredData.filter(item => item.nam === this.danhSachFilters.nam);
    }
    
    // Lọc theo đơn vị
    if (this.danhSachFilters.donVi) {
      filteredData = filteredData.filter(item => item.don_vi_id === this.danhSachFilters.donVi);
    }
    
    // Lọc theo mã nhân viên
    if (this.danhSachFilters.maNhanVien && this.danhSachFilters.maNhanVien.trim() !== '') {
      const maNhanVienLower = this.danhSachFilters.maNhanVien.toLowerCase().trim();
      filteredData = filteredData.filter(item => 
        item.nguoi_tao && item.nguoi_tao.toLowerCase().includes(maNhanVienLower)
      );
    }
    
    this.dotKeKhaiList = filteredData;
    // Không cập nhật cache số lượng sau khi lọc vì chúng ta muốn hiển thị thống kê theo dữ liệu gốc
    
    this.loading = false;
    
    // Hiển thị thông báo kết quả tìm kiếm
    if (filteredData.length === 0) {
      this.message.info('Không tìm thấy kết quả phù hợp');
    } else if (filteredData.length < this.originalDotKeKhaiList.length) {
      this.message.success(`Tìm thấy ${filteredData.length} kết quả phù hợp`);
    }
  }

  // Gọi phương thức này thay vì searchData (đổi tên để rõ ý đồ)
  searchData(): void {
    this.danhSachDaChon.clear(); // Xóa danh sách đã chọn khi lọc dữ liệu
    this.applyFilters();
  }

  xemChiTiet(dotKeKhai: DotKeKhai): void {
    if (!dotKeKhai || !dotKeKhai.id) {
      this.message.warning('Không tìm thấy thông tin đợt kê khai');
      return;
    }
    
    this.selectedDotKeKhai = dotKeKhai;
    this.isModalChiTietVisible = true;
    
    // Tải danh sách kê khai
    this.loadDanhSachKeKhai(dotKeKhai.id);
  }
  
  // Xử lý khi đóng modal chi tiết
  handleModalChiTietCancel(): void {
    this.isModalChiTietVisible = false;
    this.danhSachKeKhai = [];
  }
  
  // Tải danh sách kê khai
  loadDanhSachKeKhai(dotKeKhaiId: number): void {
    this.loadingKeKhai = true;
    this.danhSachKeKhai = [];
    
    this.dotKeKhaiService.getKeKhaiBHYTsByDotKeKhaiId(dotKeKhaiId).subscribe({
      next: (data: any[]) => {
        this.danhSachKeKhai = data;
        this.loadingKeKhai = false;
      },
      error: (error: any) => {
        console.error('Lỗi khi tải danh sách kê khai:', error);
        this.message.error('Có lỗi xảy ra khi tải danh sách kê khai');
        this.loadingKeKhai = false;
      }
    });
  }
  
  // Tính tổng tiền từ danh sách kê khai
  tinhTongTien(): number {
    return this.danhSachKeKhai.reduce((sum, item) => sum + item.so_tien, 0);
  }

  duyetDotKeKhai(dotKeKhai: DotKeKhai): void {
    this.modalService.confirm({
      nzTitle: 'Xác nhận duyệt',
      nzContent: `Bạn có chắc chắn muốn duyệt đợt kê khai "${dotKeKhai.ten_dot}" không?`,
      nzOkText: 'Duyệt',
      nzCancelText: 'Hủy',
      nzOnOk: () => {
        // Hiển thị loading
        const loadingMsg = this.message.loading('Đang duyệt đợt kê khai...', { nzDuration: 0 });
        
        // Gọi API để duyệt đợt kê khai
        if (dotKeKhai.id) {
          this.dotKeKhaiService.duyetDotKeKhai(dotKeKhai.id).subscribe({
            next: () => {
              this.message.remove(loadingMsg.messageId);
              this.message.success(`Đã duyệt thành công đợt kê khai "${dotKeKhai.ten_dot}"`);
              this.refreshData(); // Làm mới dữ liệu
            },
            error: (error) => {
              this.message.remove(loadingMsg.messageId);
              console.error('Lỗi khi duyệt đợt kê khai:', error);
              this.message.error('Có lỗi xảy ra khi duyệt đợt kê khai');
            }
          });
        }
      }
    });
  }

  tuChoiDotKeKhai(dotKeKhai: DotKeKhai): void {
    this.modalService.confirm({
      nzTitle: 'Xác nhận từ chối',
      nzContent: `Bạn có chắc chắn muốn từ chối đợt kê khai "${dotKeKhai.ten_dot}" không?`,
      nzOkText: 'Từ chối',
      nzCancelText: 'Hủy',
      nzOnOk: () => {
        // Gọi API để từ chối đợt kê khai
        this.message.info('Chức năng từ chối đợt kê khai đang được phát triển');
      }
    });
  }

  xuatExcelDotKeKhai(dotKeKhai: DotKeKhai): void {
    if (!dotKeKhai || !dotKeKhai.id) {
      this.message.warning('Không tìm thấy thông tin đợt kê khai');
      return;
    }

    this.loading = true;
    this.exportVnptService.xuatExcelDotKeKhai(dotKeKhai).subscribe({
      next: (success) => {
        this.loading = false;
      },
      error: (err) => {
        console.error('Lỗi khi xuất Excel:', err);
        this.message.error('Có lỗi xảy ra khi xuất dữ liệu kê khai');
        this.loading = false;
      }
    });
  }

  getTrangThaiText(trangThai: string): string {
    // Sử dụng ExportVnptService
    return this.exportVnptService.getTrangThaiText(trangThai);
  }

  getTrangThaiType(trangThai: string): string {
    switch (trangThai) {
      case 'chua_gui':
        return 'default';
      case 'da_gui':
        return 'processing';
      case 'da_duyet':
        return 'success';
      case 'da_tu_choi':
        return 'error';
      case 'cho_thanh_toan':
        return 'warning';
      case 'hoan_thanh':
        return 'success';
      case 'tu_choi':
        return 'error';
      case 'dang_xu_ly':
        return 'cyan';
      default:
        return 'default';
    }
  }

  // Hàm xử lý xem hóa đơn
  xemHoaDon(dotKeKhai: DotKeKhai): void {
    if (!dotKeKhai.url_bill) {
      this.message.warning('Không có ảnh hóa đơn');
      return;
    }

    this.selectedDotKeKhai = dotKeKhai;
    this.selectedHoaDonUrl = dotKeKhai.url_bill;
    this.isModalVisible = true;
  }

  // Hàm xử lý đóng modal
  handleModalCancel(): void {
    this.isModalVisible = false;
    this.selectedDotKeKhai = null;
    this.selectedHoaDonUrl = null;
  }

  // Phương thức lấy tên file từ URL
  getFileName(): string {
    if (!this.selectedHoaDonUrl) return 'Không có file';
    
    try {
      const url = new URL(this.selectedHoaDonUrl);
      const pathSegments = url.pathname.split('/');
      return pathSegments[pathSegments.length - 1] || 'hoa-don.jpg';
    } catch (e) {
      const pathSegments = this.selectedHoaDonUrl.split('/');
      return pathSegments[pathSegments.length - 1] || 'hoa-don.jpg';
    }
  }

  // Xem thông tin kê khai BHYT
  xemKeKhaiBHYT(dotKeKhaiId: number): void {
    if (!dotKeKhaiId) {
      this.message.warning('Không có thông tin kê khai BHYT');
      return;
    }
    
    // Hiển thị loading
    const loadingMsg = this.message.loading('Đang tải thông tin kê khai BHYT...', { nzDuration: 0 });
    
    // Gọi service để lấy dữ liệu
    this.dotKeKhaiService.getKeKhaiBHYTsByDotKeKhaiId(dotKeKhaiId).subscribe({
      next: (data: any[]) => {
        this.message.remove(loadingMsg.messageId);
        
        if (!data || data.length === 0) {
          this.message.info('Không có thông tin kê khai BHYT');
          return;
        }
        
        // Mở modal hiển thị bản kê
        this.modalService.create({
          nzTitle: `Bản kê BHYT - ${this.selectedDotKeKhai?.ten_dot}`,
          nzContent: `
            <div style="max-height: 500px; overflow: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr>
                    <th style="padding: 8px; border: 1px solid #f0f0f0; background-color: #fafafa;">STT</th>
                    <th style="padding: 8px; border: 1px solid #f0f0f0; background-color: #fafafa;">Họ tên</th>
                    <th style="padding: 8px; border: 1px solid #f0f0f0; background-color: #fafafa;">CCCD/CMND</th>
                    <th style="padding: 8px; border: 1px solid #f0f0f0; background-color: #fafafa;">Số thẻ BHYT</th>
                    <th style="padding: 8px; border: 1px solid #f0f0f0; background-color: #fafafa;">Số tiền</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.map((item: any, index: number) => `
                    <tr>
                      <td style="padding: 8px; border: 1px solid #f0f0f0;">${index + 1}</td>
                      <td style="padding: 8px; border: 1px solid #f0f0f0;">${item.ho_ten}</td>
                      <td style="padding: 8px; border: 1px solid #f0f0f0;">${item.cccd || ''}</td>
                      <td style="padding: 8px; border: 1px solid #f0f0f0;">${item.so_the_bhyt || ''}</td>
                      <td style="padding: 8px; border: 1px solid #f0f0f0; text-align: right;">${item.so_tien.toLocaleString('vi-VN')} đ</td>
                    </tr>
                  `).join('')}
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="4" style="padding: 8px; border: 1px solid #f0f0f0; text-align: right; font-weight: bold;">Tổng cộng:</td>
                    <td style="padding: 8px; border: 1px solid #f0f0f0; text-align: right; font-weight: bold;">${data.reduce((sum: number, item: any) => sum + item.so_tien, 0).toLocaleString('vi-VN')} đ</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          `,
          nzWidth: 800,
          nzFooter: null
        });
      },
      error: (error: any) => {
        this.message.remove(loadingMsg.messageId);
        console.error('Lỗi khi tải thông tin kê khai BHYT:', error);
        this.message.error('Có lỗi khi tải thông tin kê khai BHYT');
      }
    });
  }
  
  // Phương thức tải hóa đơn cho nhiều đợt kê khai
  taiHoaDonNhieuDot(): void {
    if (this.danhSachDaChon.size === 0) {
      this.message.warning('Vui lòng chọn ít nhất một đợt kê khai để tải hóa đơn');
      return;
    }

    // Lấy danh sách đợt kê khai đã chọn
    const dotKeKhaiDaChonList = this.dotKeKhaiList.filter(d => this.danhSachDaChon.has(d.id!));

    if (dotKeKhaiDaChonList.length === 0) {
      this.message.warning('Không tìm thấy dữ liệu cho các đợt kê khai đã chọn');
      return;
    }

    // Hiển thị loading
    const loadingMsg = this.message.loading('Đang tải hóa đơn...', { nzDuration: 0 });

    // Tạo một mảng Promise để tải tất cả hóa đơn
    const downloadPromises = dotKeKhaiDaChonList.map(dotKeKhai => {
      if (!dotKeKhai.url_bill) {
        return Promise.reject(`Đợt kê khai ${dotKeKhai.ten_dot} không có hóa đơn`);
      }

      // Tạo tên file theo format mới
      const maHoSo = dotKeKhai.ma_ho_so || 'khong-co-ma';
      const maNhanVien = dotKeKhai.nguoi_tao || 'khong-co-ma';
      const thangNam = `${dotKeKhai.thang.toString().padStart(2, '0')}_${dotKeKhai.nam}`;
      const extension = dotKeKhai.url_bill.split('.').pop() || 'jpg';
      const fileName = `${maHoSo}_${maNhanVien}_${thangNam}.${extension}`;

      return fetch(dotKeKhai.url_bill)
        .then(response => response.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        });
    });

    // Thực hiện tải tất cả hóa đơn
    Promise.allSettled(downloadPromises)
      .then(results => {
        this.message.remove(loadingMsg.messageId);
        
        const successCount = results.filter(r => r.status === 'fulfilled').length;
        const failureCount = results.filter(r => r.status === 'rejected').length;

        if (successCount > 0) {
          this.message.success(`Đã tải thành công ${successCount} hóa đơn`);
        }
        if (failureCount > 0) {
          this.message.error(`Có ${failureCount} hóa đơn không thể tải`);
        }

        // Reset danh sách đã chọn sau khi tải xong
        this.danhSachDaChon.clear();
      })
      .catch(error => {
        this.message.remove(loadingMsg.messageId);
        this.message.error('Có lỗi xảy ra khi tải hóa đơn');
        console.error('Lỗi khi tải hóa đơn:', error);
      });
  }

  // Phương thức tải hóa đơn đơn lẻ
  taiHoaDon(): void {
    if (!this.selectedDotKeKhai || !this.selectedHoaDonUrl) {
      this.message.warning('Không có thông tin hóa đơn để tải');
      return;
    }

    // Tạo tên file theo format mới
    const maHoSo = this.selectedDotKeKhai.ma_ho_so || 'khong-co-ma';
    const maNhanVien = this.selectedDotKeKhai.nguoi_tao || 'khong-co-ma';
    const thangNam = `${this.selectedDotKeKhai.thang.toString().padStart(2, '0')}_${this.selectedDotKeKhai.nam}`;
    const extension = this.selectedHoaDonUrl.split('.').pop() || 'jpg';
    const fileName = `${maHoSo}_${maNhanVien}_${thangNam}.${extension}`;

    // Hiển thị loading
    const loadingMsg = this.message.loading('Đang tải hóa đơn...', { nzDuration: 0 });

    fetch(this.selectedHoaDonUrl)
      .then(response => response.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        this.message.remove(loadingMsg.messageId);
        this.message.success('Đã tải hóa đơn thành công');
      })
      .catch(error => {
        this.message.remove(loadingMsg.messageId);
        this.message.error('Có lỗi xảy ra khi tải hóa đơn');
        console.error('Lỗi khi tải hóa đơn:', error);
      });
  }

  // Upload thay thế hóa đơn
  uploadThayThe(): void {
    if (!this.selectedDotKeKhai || !this.selectedDotKeKhai.id) {
      this.message.warning('Không thể tải lại hóa đơn');
      return;
    }
    
    // Mở modal tải lên hóa đơn mới
    this.modalService.confirm({
      nzTitle: 'Tải lại hóa đơn',
      nzContent: 'Bạn có chắc chắn muốn tải lại hóa đơn mới?',
      nzOkText: 'Tải lên',
      nzCancelText: 'Hủy',
      nzOnOk: () => {
        // Tạo input type file ẩn
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';
        
        fileInput.onchange = (event: any) => {
          const file = event.target.files[0];
          if (!file) return;
          
          // Kiểm tra kích thước file (tối đa 5MB)
          if (file.size > 5 * 1024 * 1024) {
            this.message.error('Kích thước file quá lớn, tối đa 5MB');
            return;
          }
          
          // Hiển thị loading
          const loadingMessage = this.message.loading('Đang tải lên hóa đơn mới...', { nzDuration: 0 });
          
          // Tạo FormData
          const formData = new FormData();
          formData.append('file', file);
          formData.append('dotKeKhaiId', this.selectedDotKeKhai!.id!.toString());
          
          // Gọi API upload hóa đơn
          this.http.post(`${environment.apiUrl}/DotKeKhai/${this.selectedDotKeKhai!.id}/upload-bill`, formData)
            .subscribe({
              next: (response: any) => {
                this.message.remove(loadingMessage.messageId);
                this.message.success('Tải lên hóa đơn thành công');
                
                // Cập nhật URL hóa đơn mới nếu có
                if (response && response.url) {
                  this.selectedHoaDonUrl = response.url;
                  if (this.selectedDotKeKhai) {
                    this.selectedDotKeKhai.url_bill = response.url;
                  }
                }
                
                // Cập nhật trạng thái sang "đang xử lý"
                if (this.selectedDotKeKhai && this.selectedDotKeKhai.id) {
                  this.dotKeKhaiService.updateTrangThai(this.selectedDotKeKhai.id, 'dang_xu_ly')
                    .subscribe({
                      next: () => {
                        this.message.success('Đã cập nhật trạng thái sang "Đang xử lý"');
                        // Cập nhật trạng thái trong đối tượng đã chọn
                        if (this.selectedDotKeKhai) {
                          this.selectedDotKeKhai.trang_thai = 'dang_xu_ly';
                        }
                        // Làm mới dữ liệu
                        this.refreshData();
                      },
                      error: (err) => {
                        console.error('Lỗi khi cập nhật trạng thái:', err);
                        this.message.error('Có lỗi xảy ra khi cập nhật trạng thái');
                      }
                    });
                }
              },
              error: (error) => {
                this.message.remove(loadingMessage.messageId);
                console.error('Lỗi khi tải lên hóa đơn:', error);
                this.message.error('Có lỗi xảy ra khi tải lên hóa đơn');
              }
            });
        };
        
        // Kích hoạt sự kiện click
        document.body.appendChild(fileInput);
        fileInput.click();
        document.body.removeChild(fileInput);
      }
    });
  }

  // Xử lý khi thay đổi tab
  onTabChange(index: number): void {
    // Cập nhật danhSachFilters.trangThai dựa vào tab được chọn
    switch (index) {
      case 0: // Tất cả
        this.danhSachFilters.trangThai = null;
        break;
      case 1: // Chưa gửi
        this.danhSachFilters.trangThai = 'chua_gui';
        break;
      case 2: // Đã gửi
        this.danhSachFilters.trangThai = 'da_gui';
        break;
      case 3: // Đã duyệt
        this.danhSachFilters.trangThai = 'da_duyet';
        break;
      case 4: // Đã từ chối
        this.danhSachFilters.trangThai = 'da_tu_choi';
        break;
      case 5: // Chờ thanh toán (nếu có tab này)
        this.danhSachFilters.trangThai = 'cho_thanh_toan';
        break;
      case 6: // Hoàn thành (nếu có tab này)
        this.danhSachFilters.trangThai = 'hoan_thanh';
        break;
      default:
        this.danhSachFilters.trangThai = null;
    }
    
    this.tabTrangThaiIndex = index;
    this.applyFilters();
  }

  // Phương thức trợ giúp để lấy tên đơn vị từ bất kỳ định dạng nào
  getDonViName(data: DotKeKhai): string {
    // Sử dụng ExportVnptService
    return this.exportVnptService.getDonViName(data);
  }

  // Lấy text cho phương án đóng BHYT
  getPhuongAnDongText(phuongAnDong: string): string {
    // Sử dụng ExportVnptService
    return this.exportVnptService.getPhuongAnDongText(phuongAnDong);
  }

  // Thêm hàm chuyển đổi giới tính
  getGioiTinhValue(gioiTinh: string): string {
    return gioiTinh?.toLowerCase() === 'nam' ? '1' : '0';
  }

  // Thêm hàm kiểm tra tuổi
  isUnder18(ngaySinh: string | Date | null | undefined): boolean {
    if (!ngaySinh) return false;
    
    const birthDate = new Date(ngaySinh);
    const today = new Date();
    
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    // Nếu chưa tới tháng sinh nhật hoặc tới tháng sinh nhật nhưng chưa tới ngày sinh nhật
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    
    return age < 18;
  }

  // Xuất Excel cho nhiều đợt kê khai cùng lúc
  xuatExcelNhieuDotKeKhai(): void {
    if (this.dotKeKhaiList.length === 0) {
      this.message.warning('Không có dữ liệu để xuất');
      return;
    }

    this.loading = true;
    const success = this.exportVnptService.xuatExcelNhieuDotKeKhai(this.dotKeKhaiList);
    this.loading = false;
  }

  // Xử lý xuất VNPT nhiều đợt kê khai
  xuatVNPTNhieuDot(): void {
    if (this.danhSachDaChon.size === 0) {
      this.message.warning('Vui lòng chọn ít nhất một đợt kê khai để xuất');
      return;
    }

    // Lấy danh sách đợt kê khai đã chọn
    const dotKeKhaiDaChonList = this.dotKeKhaiList.filter(d => this.danhSachDaChon.has(d.id!));

    if (dotKeKhaiDaChonList.length === 0) {
      this.message.warning('Không tìm thấy dữ liệu cho các đợt kê khai đã chọn');
      return;
    }

    // Hiển thị loading
    this.loading = true;
    
    // Gọi service để xuất file, truyền danh sách đợt kê khai đã chọn
    // Mã nhân viên sẽ được lấy trực tiếp từ mỗi đợt kê khai (nguoi_tao)
    this.exportVnptService.xuatVNPTNhieuDot(dotKeKhaiDaChonList)
      .subscribe(
        (success: boolean) => {
          this.loading = false;
          if (success) {
            // Reset danh sách đã chọn sau khi xuất thành công
            this.danhSachDaChon.clear();
          }
        },
        (error: any) => {
          this.loading = false;
          console.error('Lỗi khi xuất VNPT:', error);
          this.message.error('Có lỗi xảy ra khi xuất dữ liệu VNPT');
        }
      );
  }

  // Xử lý khi xác nhận mã nhân viên
  handleModalOk(): void {
    if (this.maNhanVienForm.invalid) {
      this.message.error('Vui lòng nhập mã nhân viên hợp lệ');
      return;
    }

    // Lấy mã nhân viên từ form
    const maNhanVien = this.maNhanVienForm.get('maNhanVien')?.value;
    
    // Lưu mã nhân viên vào localStorage nếu đã chọn
    if (this.maNhanVienForm.get('luuMaNhanVien')?.value) {
      localStorage.setItem('maNhanVienThu', maNhanVien);
    }

    // Đóng modal
    this.isModalNhapMaNhanVienVisible = false;

    // Lấy danh sách đợt kê khai đã chọn
    const dotKeKhaiDaChonList = this.dotKeKhaiList.filter(d => this.danhSachDaChon.has(d.id!));

    // Gọi service để xuất file với mã nhân viên
    this.exportVnptService.xuatVNPTNhieuDotVoiMaNhanVien(dotKeKhaiDaChonList, maNhanVien)
      .subscribe(
        (success: boolean) => {
          if (success) {
            // Reset danh sách đã chọn sau khi xuất thành công
            this.danhSachDaChon.clear();
          }
        },
        (error: any) => {
          console.error('Lỗi khi xuất VNPT:', error);
          this.message.error('Có lỗi xảy ra khi xuất dữ liệu VNPT');
        }
      );
  }

  // Xử lý khi hủy nhập mã nhân viên (không hiển thị hóa đơn)
  handleModalNhapMaNhanVienCancel(): void {
    this.isModalNhapMaNhanVienVisible = false;
  }

  // PHƯƠNG THỨC XỬ LÝ CHECKBOX
  
  // Kiểm tra xem tất cả các đợt kê khai hiện tại đã được chọn hết chưa
  isTatCaDaChon(): boolean {
    if (this.dotKeKhaiList.length === 0) return false;
    return this.dotKeKhaiList.every(item => item.id && this.danhSachDaChon.has(item.id));
  }
  
  // Kiểm tra trạng thái indeterminate (khi chỉ chọn một số, không phải tất cả)
  isIndeterminate(): boolean {
    const checkedCount = this.dotKeKhaiList.filter(item => item.id && this.danhSachDaChon.has(item.id)).length;
    return checkedCount > 0 && checkedCount < this.dotKeKhaiList.length;
  }
  
  // Xử lý khi checkbox của một đợt kê khai được chọn/bỏ chọn
  onCheckDotKeKhai(id: number | undefined, checked: boolean): void {
    if (!id) return; // Bỏ qua nếu id không tồn tại
    
    if (checked) {
      this.danhSachDaChon.add(id);
    } else {
      this.danhSachDaChon.delete(id);
    }
  }
  
  // Xử lý khi checkbox "Chọn tất cả" được chọn/bỏ chọn
  onCheckTatCa(checked: boolean): void {
    if (checked) {
      // Chọn tất cả các đợt kê khai hiện tại
      this.dotKeKhaiList.forEach(item => {
        if (item.id) {
          this.danhSachDaChon.add(item.id);
        }
      });
    } else {
      // Bỏ chọn tất cả
      this.danhSachDaChon.clear();
    }
  }
  
  // Lấy số lượng đợt kê khai đã chọn
  getSoDotKeKhaiDaChon(): number {
    return this.danhSachDaChon.size;
  }
  
  // Lấy danh sách các đợt kê khai đã chọn
  getDanhSachDotKeKhaiDaChon(): DotKeKhai[] {
    return this.dotKeKhaiList.filter(item => item.id && this.danhSachDaChon.has(item.id));
  }

  chinhSuaDotKeKhai(dotKeKhai: DotKeKhai): void {
    if (!dotKeKhai || !dotKeKhai.id) {
      this.message.warning('Không tìm thấy thông tin đợt kê khai');
      return;
    }

    // Chuyển hướng đến trang kê khai tương ứng với loại dịch vụ
    if (dotKeKhai.dich_vu === 'BHYT') {
      this.router.navigate(['/dot-ke-khai', dotKeKhai.id, 'ke-khai-bhyt']);
    } else if (dotKeKhai.dich_vu === 'BHXH TN') {
      this.router.navigate(['/dot-ke-khai', dotKeKhai.id, 'ke-khai-bhxh']);
    } else {
      this.message.warning('Không xác định được loại dịch vụ');
    }
  }

  // Phương thức xử lý hiển thị modal xác nhận xóa
  xoaDotKeKhai(dotKeKhai: DotKeKhai): void {
    this.dotKeKhaiToDelete = dotKeKhai;
    this.selectedDotKeKhai = dotKeKhai;
    this.isModalXoaVisible = true;
  }
  
  // Phương thức hủy xóa
  handleModalXoaCancel(): void {
    this.isModalXoaVisible = false;
    this.dotKeKhaiToDelete = null;
  }
  
  // Phương thức xác nhận xóa
  confirmXoaDotKeKhai(): void {
    if (!this.dotKeKhaiToDelete || !this.dotKeKhaiToDelete.id) {
      return;
    }
    
    this.loading = true;
    
    this.dotKeKhaiService.deleteDotKeKhai(this.dotKeKhaiToDelete.id).subscribe({
      next: () => {
        this.message.success('Xóa đợt kê khai thành công');
        this.loadDotKeKhaiList(); // Tải lại danh sách
        this.isModalXoaVisible = false;
        this.dotKeKhaiToDelete = null;
      },
      error: (error) => {
        console.error('Lỗi khi xóa đợt kê khai:', error);
        this.message.error('Có lỗi xảy ra khi xóa đợt kê khai');
        this.loading = false;
      }
    });
  }

  // Bắt đầu chỉnh sửa
  startEdit(data: DotKeKhai): void {
    this.editingId = data.id || null;
    this.maHoSoTemp = data.ma_ho_so || '';
  }
  
  // Hủy chỉnh sửa
  cancelEdit(): void {
    this.editingId = null;
  }
  
  // Lưu nội dung chỉnh sửa
  saveEdit(data: DotKeKhai): void {
    if (!data.id || this.editingId !== data.id) {
      return;
    }
    
    // Hiển thị loading
    const loadingMsg = this.message.loading('Đang cập nhật mã hồ sơ...', { nzDuration: 0 });
    
    // Gọi API cập nhật mã hồ sơ
    const apiUrl = `${environment.apiUrl}/DotKeKhai/${data.id}/update-ma-ho-so`;
    this.http.post(apiUrl, { ma_ho_so: this.maHoSoTemp }).subscribe({
      next: (_response: any) => {
        this.message.remove(loadingMsg.messageId);
        this.message.success('Cập nhật mã hồ sơ thành công');
        
        // Cập nhật lại dữ liệu trong danh sách
        this.dotKeKhaiList = this.dotKeKhaiList.map(d => {
          if (d.id === data.id) {
            return { ...d, ma_ho_so: this.maHoSoTemp };
          }
          return d;
        });
        
        // Cập nhật trong danh sách gốc
        this.originalDotKeKhaiList = this.originalDotKeKhaiList.map(d => {
          if (d.id === data.id) {
            return { ...d, ma_ho_so: this.maHoSoTemp };
          }
          return d;
        });
        
        // Kết thúc chế độ chỉnh sửa
        this.editingId = null;
      },
      error: (error: any) => {
        this.message.remove(loadingMsg.messageId);
        this.message.error('Có lỗi xảy ra khi cập nhật mã hồ sơ');
        console.error('Lỗi khi cập nhật mã hồ sơ:', error);
        // Vẫn kết thúc chế độ chỉnh sửa
        this.editingId = null;
      }
    });
  }

  // Tính tổng số tiền của các đợt kê khai có trạng thái đang xử lý
  getTotalAmount(): number {
    return this.dotKeKhaiList.reduce((total, dot) => {
      if (dot.trang_thai === 'dang_xu_ly') {
        return total + (dot.tong_so_tien || 0);
      }
      return total;
    }, 0);
  }

  // Tính tổng số tiền của tất cả các đợt kê khai gốc có trạng thái đang xử lý
  getTotalAmountOriginal(): number {
    return this.originalDotKeKhaiList.reduce((total, dot) => {
      if (dot.trang_thai === 'dang_xu_ly') {
        return total + (dot.tong_so_tien || 0);
      }
      return total + (dot.tong_so_tien || 0);
    }, 0);
  }

  // Bắt đầu chỉnh sửa trạng thái
  startEditTrangThai(data: DotKeKhai): void {
    this.editingTrangThaiId = data.id || null;
    this.trangThaiTemp = data.trang_thai;
  }
  
  // Hủy chỉnh sửa trạng thái
  cancelEditTrangThai(): void {
    this.editingTrangThaiId = null;
  }
  
  // Lưu trạng thái mới
  saveTrangThai(data: DotKeKhai): void {
    if (!data.id || this.editingTrangThaiId !== data.id) {
      return;
    }
    
    // Hiển thị loading
    const loadingMsg = this.message.loading('Đang cập nhật trạng thái...', { nzDuration: 0 });
    
    // Gọi API cập nhật trạng thái
    const apiUrl = `${environment.apiUrl}/DotKeKhai/${data.id}/trang-thai`;
    this.http.patch(apiUrl, { trang_thai: this.trangThaiTemp }).subscribe({
      next: (_response: any) => {
        this.message.remove(loadingMsg.messageId);
        this.message.success('Cập nhật trạng thái thành công');
        
        // Cập nhật lại dữ liệu trong danh sách
        this.dotKeKhaiList = this.dotKeKhaiList.map(d => {
          if (d.id === data.id) {
            return { ...d, trang_thai: this.trangThaiTemp };
          }
          return d;
        });
        
        // Cập nhật trong danh sách gốc
        this.originalDotKeKhaiList = this.originalDotKeKhaiList.map(d => {
          if (d.id === data.id) {
            return { ...d, trang_thai: this.trangThaiTemp };
          }
          return d;
        });
        
        // Cập nhật cache số lượng
        this.updateStatusCountCache();
        
        // Kết thúc chế độ chỉnh sửa
        this.editingTrangThaiId = null;
      },
      error: (error: any) => {
        this.message.remove(loadingMsg.messageId);
        this.message.error('Có lỗi xảy ra khi cập nhật trạng thái');
        console.error('Lỗi khi cập nhật trạng thái:', error);
        // Vẫn kết thúc chế độ chỉnh sửa
        this.editingTrangThaiId = null;
      }
    });
  }

  // Phương thức duyệt nhiều đợt kê khai cùng lúc
  duyetNhieuDotKeKhai(): void {
    if (this.danhSachDaChon.size === 0) {
      this.message.warning('Vui lòng chọn ít nhất một đợt kê khai để duyệt');
      return;
    }

    // Lấy danh sách đợt kê khai đã chọn
    const dotKeKhaiDaChonList = this.dotKeKhaiList.filter(d => this.danhSachDaChon.has(d.id!));
    
    // Lọc ra những đợt có trạng thái "đã gửi"
    const dotKeKhaiDaGuiList = dotKeKhaiDaChonList.filter(d => d.trang_thai === 'da_gui');
    
    if (dotKeKhaiDaGuiList.length === 0) {
      this.message.warning('Không có đợt kê khai nào ở trạng thái "Đã gửi" để duyệt');
      return;
    }
    
    // Hiển thị modal xác nhận
    this.modalService.confirm({
      nzTitle: 'Xác nhận duyệt nhiều đợt kê khai',
      nzContent: `Bạn có chắc chắn muốn duyệt ${dotKeKhaiDaGuiList.length} đợt kê khai đã chọn không?`,
      nzOkText: 'Duyệt',
      nzCancelText: 'Hủy',
      nzOnOk: () => {
        // Hiển thị loading
        this.loading = true;
        const loadingMsg = this.message.loading('Đang duyệt đợt kê khai...', { nzDuration: 0 });
        
        // Tạo một mảng Observable để duyệt tất cả đợt kê khai
        const duyetObservables = dotKeKhaiDaGuiList.map(dotKeKhai => 
          this.dotKeKhaiService.duyetDotKeKhai(dotKeKhai.id!)
        );
        
        // Import và sử dụng forkJoin
        import('rxjs').then(rxjs => {
          if (duyetObservables.length === 0) {
            this.loading = false;
            this.message.remove(loadingMsg.messageId);
            this.message.info('Không có đợt kê khai nào để duyệt');
            return;
          }
          
          rxjs.forkJoin(duyetObservables).subscribe({
            next: () => {
              this.message.remove(loadingMsg.messageId);
              this.message.success(`Đã duyệt thành công ${dotKeKhaiDaGuiList.length} đợt kê khai`);
              this.refreshData(); // Làm mới dữ liệu
              this.danhSachDaChon.clear(); // Xóa danh sách đã chọn
            },
            error: (error) => {
              this.message.remove(loadingMsg.messageId);
              console.error('Lỗi khi duyệt đợt kê khai:', error);
              this.message.error('Có lỗi xảy ra khi duyệt đợt kê khai');
              this.loading = false;
            },
            complete: () => {
              this.loading = false;
            }
          });
        });
      }
    });
  }
}
````

## File: WebApp.Client/src/app/ke-khai/don-vi/don-vi.component.html
````html
<div class="page-header">
  <h1>Quản lý đơn vị</h1>
  <div class="header-actions">
    <nz-input-group [nzSuffix]="suffixIconSearch" style="width: 300px; margin-right: 16px;">
      <input type="text" nz-input placeholder="Tìm kiếm theo mã hoặc tên đơn vị" [(ngModel)]="searchText" (ngModelChange)="onSearch()"/>
    </nz-input-group>
    <button nz-button nzType="primary" (click)="showCreateModal()">
      <span nz-icon nzType="plus"></span>Thêm mới
    </button>
  </div>
</div>

<ng-template #suffixIconSearch>
  <span nz-icon nzType="search"></span>
</ng-template>

<nz-table #basicTable [nzData]="donVis" [nzLoading]="loading">
  <thead>
    <tr>
      <th>Mã cơ quan BHXH</th>
      <th>Mã số BHXH</th>
      <th>Tên đơn vị</th>
      <th>Loại hình</th>
      <th>Trạng thái</th>
      <th>Thao tác</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let data of basicTable.data">
      <td>{{ data.maCoQuanBHXH }}</td>
      <td>{{ data.maSoBHXH }}</td>
      <td>{{ data.tenDonVi }}</td>
      <td>
        <nz-tag [nzColor]="data.isBHXHTN ? 'blue' : 'green'">
          {{ data.isBHXHTN ? 'BHXH tự nguyện' : 'BHYT' }}
        </nz-tag>
      </td>
      <td>
        <nz-switch
          [(ngModel)]="data.trangThai"
          [nzLoading]="data.loading"
          (ngModelChange)="onStatusChange(data)">
        </nz-switch>
      </td>
      <td>
        <button nz-button nzType="primary" (click)="showEditModal(data)">
          <span nz-icon nzType="edit"></span>
        </button>
        <nz-divider nzType="vertical"></nz-divider>
        <button 
          nz-button 
          nzType="default" 
          nzDanger
          nz-popconfirm
          nzPopconfirmTitle="Bạn có chắc chắn muốn xóa đơn vị này?"
          (nzOnConfirm)="deleteData(data.id)">
          <span nz-icon nzType="delete"></span>
        </button>
      </td>
    </tr>
  </tbody>
</nz-table>

<nz-modal
  [(nzVisible)]="isModalVisible"
  [nzTitle]="modalTitle"
  (nzOnCancel)="handleCancel()"
  (nzOnOk)="handleOk()"
  [nzWidth]="700">
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="donViForm">
      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Mã cơ quan BHXH</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Vui lòng nhập mã cơ quan BHXH!">
          <input nz-input formControlName="maCoQuanBHXH" placeholder="Nhập mã cơ quan BHXH"/>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Mã số BHXH</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Vui lòng nhập mã số BHXH!">
          <input nz-input formControlName="maSoBHXH" placeholder="Nhập mã số BHXH"/>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Tên đơn vị</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Vui lòng nhập tên đơn vị!">
          <input nz-input formControlName="tenDonVi" placeholder="Nhập tên đơn vị"/>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Loại hình</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-radio-group formControlName="type">
            <label nz-radio [nzValue]="1">BHXH tự nguyện</label>
            <label nz-radio [nzValue]="2">BHYT</label>
          </nz-radio-group>
        </nz-form-control>
      </nz-form-item>

      <!-- Ẩn các trường này vì sẽ được tự động cập nhật -->
      <input type="hidden" formControlName="isBHXHTN">
      <input type="hidden" formControlName="isBHYT">

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Đại lý quản lý</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-select 
            [nzMode]="'multiple'"
            [(ngModel)]="selectedDaiLys"
            [ngModelOptions]="{standalone: true}"
            (ngModelChange)="onDaiLysChange($event)"
            nzPlaceHolder="Chọn đại lý">
            <nz-option
              *ngFor="let daiLy of daiLys"
              [nzValue]="daiLy.id"
              [nzLabel]="daiLy.ten">
            </nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Trạng thái</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-switch formControlName="trangThai"></nz-switch>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>
````

## File: WebApp.Client/src/app/ke-khai/don-vi/don-vi.component.scss
````scss
.don-vi-container {
  padding: 24px;
}

nz-form-item {
  margin-bottom: 24px;
}

.ant-form-item-label {
  text-align: left;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding: 8px 0;

  h1 {
    margin: 0;
    font-size: 20px;
    font-weight: 500;
    color: rgba(0, 0, 0, 0.85);
    line-height: 32px;
  }

  .header-actions {
    display: flex;
    align-items: center;
  }
}
````

## File: WebApp.Client/src/app/ke-khai/don-vi/don-vi.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule, FormBuilder, FormGroup, Validators } from '@angular/forms';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzMessageModule, NzMessageService } from 'ng-zorro-antd/message';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzSwitchModule } from 'ng-zorro-antd/switch';
import { NzRadioModule } from 'ng-zorro-antd/radio';
import { NzPopconfirmModule } from 'ng-zorro-antd/popconfirm';
import { DonViService, DonVi } from '../../services/don-vi.service';
import { DaiLyService } from '../../services/dai-ly.service';
import { AuthService } from '../../services/auth.service';
import { DaiLyDonViService } from '../../services/dai-ly-don-vi.service';

@Component({
  selector: 'app-don-vi',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    NzFormModule,
    NzSelectModule,
    NzButtonModule,
    NzTableModule,
    NzMessageModule,
    NzModalModule,
    NzInputModule,
    NzIconModule,
    NzTagModule,
    NzDividerModule,
    NzSwitchModule,
    NzRadioModule,
    NzPopconfirmModule
  ],
  templateUrl: './don-vi.component.html',
  styleUrls: ['./don-vi.component.scss']
})
export class DonViComponent implements OnInit {
  donVis: DonVi[] = [];
  daiLys: any[] = [];
  selectedDaiLys: number[] = [];
  loading = false;
  isModalVisible = false;
  modalTitle = '';
  donViForm!: FormGroup;
  editingDonVi: DonVi | null = null;
  searchText = '';
  originalDonVis: DonVi[] = [];

  constructor(
    private fb: FormBuilder,
    private donViService: DonViService,
    private daiLyService: DaiLyService,
    private daiLyDonViService: DaiLyDonViService,
    private message: NzMessageService,
    private authService: AuthService
  ) {
    this.initForm();
  }

  ngOnInit(): void {
    this.loadData();
    this.loadDaiLys();
  }

  initForm(): void {
    this.donViForm = this.fb.group({
      maCoQuanBHXH: ['', [Validators.required]],
      maSoBHXH: ['', [Validators.required]],
      tenDonVi: ['', [Validators.required]],
      type: [1],
      isBHXHTN: [false],
      isBHYT: [false],
      trangThai: [true]
    });

    // Thêm xử lý khi type thay đổi
    this.donViForm.get('type')?.valueChanges.subscribe(value => {
      if (value === 1) {
        this.donViForm.patchValue({
          isBHXHTN: true,
          isBHYT: false
        });
      } else {
        this.donViForm.patchValue({
          isBHXHTN: false,
          isBHYT: true
        });
      }
    });
  }

  loadData(): void {
    this.loading = true;
    this.donViService.getDonVis().subscribe({
      next: (data) => {
        this.originalDonVis = data; // Lưu lại dữ liệu gốc
        this.donVis = data;
        this.loading = false;
      },
      error: () => {
        this.message.error('Có lỗi xảy ra khi tải danh sách đơn vị');
        this.loading = false;
      }
    });
  }

  loadDaiLys(): void {
    this.daiLyService.getDaiLys().subscribe({
      next: (data) => {
        this.daiLys = data;
      },
      error: () => {
        this.message.error('Có lỗi xảy ra khi tải danh sách đại lý');
      }
    });
  }

  showCreateModal(): void {
    this.modalTitle = 'Thêm mới đơn vị';
    this.donViForm.reset({
      type: 1,
      trangThai: true,
      isBHXHTN: false,
      isBHYT: false
    });
    this.selectedDaiLys = [];
    this.isModalVisible = true;
  }

  showEditModal(data: DonVi): void {
    this.modalTitle = 'Cập nhật đơn vị';
    this.editingDonVi = data;
    this.donViForm.patchValue({
      maCoQuanBHXH: data.maCoQuanBHXH,
      maSoBHXH: data.maSoBHXH,
      tenDonVi: data.tenDonVi,
      type: data.isBHXHTN ? 1 : 2,
      isBHXHTN: data.isBHXHTN,
      isBHYT: data.isBHYT,
      trangThai: data.trangThai
    });

    // Load danh sách đại lý của đơn vị
    this.daiLyDonViService.getDaiLysByDonVi(data.id).subscribe({
      next: (daiLys) => {
        this.selectedDaiLys = daiLys.map(d => d.id);
        this.isModalVisible = true;
      },
      error: (error) => {
        console.error('Error loading dai lys:', error);
        this.message.error('Có lỗi xảy ra khi tải danh sách đại lý');
      }
    });
  }

  handleOk(): void {
    if (this.donViForm.valid) {
      this.loading = true;
      const currentUser = this.authService.getCurrentUser();
      const formData = {
        ...this.donViForm.value,
        nguoiTao: currentUser?.username || 'system',
        ngayTao: new Date().toISOString()
      };

      // Nếu đang thêm mới
      if (this.modalTitle === 'Thêm mới đơn vị') {
        this.donViService.createDonVi(formData).subscribe({
          next: (donVi) => {
            // Sau khi tạo đơn vị thành công, tạo quan hệ với đại lý
            if (this.selectedDaiLys.length > 0) {
              const promises = this.selectedDaiLys.map(daiLyId => {
                return this.daiLyDonViService.createDaiLyDonVi({
                  daiLyId: daiLyId,
                  donViId: donVi.id,
                  trangThai: true,
                  nguoiTao: currentUser?.username || 'system'
                }).toPromise();
              });

              Promise.all(promises)
                .then(() => {
                  this.message.success('Thêm mới đơn vị và liên kết đại lý thành công');
                  this.loadData();
                  this.handleCancel();
                })
                .catch(error => {
                  console.error('Error creating dai ly don vi:', error);
                  this.message.error('Có lỗi xảy ra khi liên kết đại lý');
                })
                .finally(() => {
                  this.loading = false;
                });
            } else {
              this.message.success('Thêm mới đơn vị thành công');
              this.loadData();
              this.handleCancel();
              this.loading = false;
            }
          },
          error: (error) => {
            console.error('Error:', error);
            if (error.error?.errors) {
              const errorMessages = Object.values(error.error.errors)
                .flat()
                .join(', ');
              this.message.error(`Lỗi: ${errorMessages}`);
            } else {
              this.message.error(error.error?.message || 'Có lỗi xảy ra khi thêm đơn vị');
            }
            this.loading = false;
          }
        });
      } 
      // Nếu đang cập nhật
      else {
        const donViId = this.donVis.find(d => 
          d.id === this.editingDonVi?.id
        )?.id;

        if (donViId) {
          // Cập nhật thông tin đơn vị
          this.donViService.updateDonVi(donViId, {
            ...formData,
            daiLyIds: this.selectedDaiLys
          }).subscribe({
            next: () => {
              this.message.success('Cập nhật đơn vị thành công');
              this.loadData();
              this.handleCancel();
            },
            error: (error) => {
              console.error('Error:', error);
              if (error.error?.errors) {
                const errorMessages = Object.values(error.error.errors)
                  .flat()
                  .join(', ');
                this.message.error(`Lỗi: ${errorMessages}`);
              } else {
                this.message.error(error.error?.message || 'Có lỗi xảy ra khi cập nhật đơn vị');
              }
            },
            complete: () => {
              this.loading = false;
            }
          });
        } else {
          this.message.error('Không tìm thấy đơn vị cần cập nhật');
          this.loading = false;
        }
      }
    } else {
      // Đánh dấu tất cả các trường là đã chạm vào để hiển thị lỗi
      Object.values(this.donViForm.controls).forEach(control => {
        if (control.invalid) {
          control.markAsTouched();
          control.updateValueAndValidity();
        }
      });
    }
  }

  handleCancel(): void {
    this.isModalVisible = false;
    this.donViForm.reset();
    this.editingDonVi = null;
  }

  onStatusChange(data: DonVi): void {
    const oldStatus = !data.trangThai;
    data.loading = true;

    this.donViService.updateStatus(data.id, data.trangThai).subscribe({
      next: () => {
        this.message.success(`${data.trangThai ? 'Kích hoạt' : 'Vô hiệu hóa'} đơn vị thành công`);
        data.loading = false;
      },
      error: (error) => {
        data.trangThai = oldStatus; // Khôi phục trạng thái cũ nếu lỗi
        console.error('Error:', error);
        if (error.error?.errors) {
          const errorMessages = Object.values(error.error.errors)
            .flat()
            .join(', ');
          this.message.error(`Lỗi: ${errorMessages}`);
        } else {
          this.message.error(error.error?.message || 'Có lỗi xảy ra khi cập nhật trạng thái');
        }
        data.loading = false;
      }
    });
  }

  deleteData(id: number): void {
    this.donViService.deleteDonVi(id).subscribe({
      next: () => {
        this.message.success('Xóa đơn vị thành công');
        this.loadData();
      },
      error: (error) => {
        console.error('Delete error:', error);
        // Kiểm tra nếu là lỗi do đợt kê khai
        if (error.error?.dotKeKhaiCount) {
          this.message.error(`Không thể xóa đơn vị này vì đang có ${error.error.dotKeKhaiCount} đợt kê khai liên quan`);
          return;
        }
        
        // Hiển thị thông báo lỗi từ server nếu có
        if (error.error?.message) {
          this.message.error(error.error.message);
          return;
        }

        // Thông báo mặc định nếu không có thông tin lỗi cụ thể
        this.message.error('Có lỗi xảy ra khi xóa đơn vị');
      }
    });
  }

  onDaiLysChange(daiLyIds: number[]): void {
    this.selectedDaiLys = daiLyIds;
  }

  onSearch(): void {
    if (!this.searchText.trim()) {
      this.donVis = [...this.originalDonVis];
      return;
    }

    const searchValue = this.searchText.toLowerCase().trim();
    this.donVis = this.originalDonVis.filter(donVi => 
      donVi.maCoQuanBHXH.toLowerCase().includes(searchValue) ||
      donVi.maSoBHXH.toLowerCase().includes(searchValue) ||
      donVi.tenDonVi.toLowerCase().includes(searchValue)
    );
  }
}
````

## File: WebApp.Client/src/app/ke-khai/dot-ke-khai/thanh-toan-modal/thanh-toan-modal.component.scss
````scss
.qr-container {
  padding: 24px;
  background: #fff;
  border-radius: 8px;
  max-width: 900px;
  margin: 0 auto;

  .qr-header {
    text-align: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid #f0f0f0;

    h2 {
      font-size: 24px;
      color: #262626;
      margin: 0;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .dot-name {
      font-size: 16px;
      color: #1890ff;
      font-weight: 500;
    }
  }

  .qr-content {
    .payment-info {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
      align-items: stretch;

      .qr-section {
        .qr-wrapper {
          background: white;
          padding: 20px;
          border: 1px solid #e8e8e8;
          border-radius: 12px;
          text-align: center;
          box-shadow: 0 2px 8px rgba(0,0,0,0.06);
          height: 100%;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;

          img {
            width: 100%;
            max-width: 320px;
            height: auto;
            margin: 0 auto 16px;
            display: block;
          }

          .qr-note {
            margin-bottom: 12px;
            
            .qr-info-badge {
              display: inline-block;
              padding: 4px 10px;
              background-color: #e6f7ff;
              border: 1px solid #91d5ff;
              border-radius: 4px;
              color: #1890ff;
              font-size: 12px;
              font-weight: 500;
            }
          }

          .qr-actions {
            margin-top: 16px;
            
            button {
              height: 32px;
              padding: 0 16px;
              border-radius: 6px;
              font-size: 14px;
              display: flex;
              align-items: center;
              gap: 8px;
              border: 1px solid #d9d9d9;
              background: #fff;
              color: #595959;
              transition: all 0.3s;

              &:hover {
                color: #40a9ff;
                border-color: #40a9ff;
              }

              i {
                font-size: 16px;
              }
            }
          }
        }
      }

      .info-section {
        background: #f8f8f8;
        padding: 24px;
        border-radius: 12px;
        border: 1px solid #e8e8e8;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;

        .info-group {
          margin-bottom: 16px;
          position: relative;

          &:last-child {
            margin-bottom: 0;
          }

          .info-label {
            color: #595959;
            font-size: 14px;
            margin-bottom: 4px;
          }

          .info-value {
            color: #262626;
            font-weight: 500;
            font-size: 14px;
            word-break: break-word;

            &.bank-name {
              font-size: 15px;
              line-height: 1.4;
            }

            &.amount {
              color: #f5222d;
              font-weight: 600;
              font-size: 15px;
            }
          }
        }
      }
    }
  }

  .qr-footer {
    text-align: center;
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px solid #f0f0f0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;

    p {
      color: #8c8c8c;
      font-size: 14px;
      margin: 0;
    }

    .confirm-button {
      min-width: 180px;
      height: 36px;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;

      i {
        font-size: 16px;
      }
    }
  }
}

.loading-container {
  padding: 48px;
  text-align: center;
}
````

## File: WebApp.Client/src/app/ke-khai/dot-ke-khai/thanh-toan-modal/thanh-toan-modal.component.ts
````typescript
import { Component, OnInit, Input } from '@angular/core';
import { CommonModule } from '@angular/common';
import { NzModalRef, NzModalService } from 'ng-zorro-antd/modal';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzSpinModule } from 'ng-zorro-antd/spin';
import { NzCardModule } from 'ng-zorro-antd/card';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { DotKeKhai } from '../../../services/dot-ke-khai.service';
import { VietQRService, PaymentConfirmResponse } from '../../../services/viet-qr.service';
import { environment } from '../../../../environments/environment';
import { DownloadOutline, CheckCircleOutline } from '@ant-design/icons-angular/icons';
import { NzIconService } from 'ng-zorro-antd/icon';
import { UploadBillModalComponent } from '../upload-bill-modal/upload-bill-modal.component';
import { UserService, NguoiDung } from '../../../services/user.service';

@Component({
  selector: 'app-thanh-toan-modal',
  standalone: true,
  imports: [
    CommonModule,
    NzSpinModule,
    NzCardModule,
    NzButtonModule,
    NzIconModule
  ],
  template: `
    <div class="qr-container" *ngIf="!loading; else loadingTpl">      
      <div class="qr-content">
        <div class="payment-info">
          <div class="qr-section">
            <div class="qr-wrapper">
              <img [src]="qrDataUrl" *ngIf="qrDataUrl" alt="QR Code" />
              <div class="qr-actions">
                <button nz-button nzType="default" (click)="downloadQR()">
                  <i nz-icon nzType="download" nzTheme="outline"></i>
                  Tải mã QR
                </button>
              </div>
            </div>
          </div>

          <div class="info-section">
            <div class="info-group">
              <div class="info-label">Tên đợt:</div>
              <div class="info-value">{{ dotKeKhai.ten_dot }}</div>
            </div>
            <div class="info-group">
              <div class="info-label">Ngân hàng:</div>
              <div class="info-value">AGRIBANK</div>
            </div>
            <div class="info-group">
              <div class="info-label">Số tài khoản:</div>
              <div class="info-value">{{ environment.vietQR.accountNo }}</div>
            </div>
            <div class="info-group">
              <div class="info-label">Tên tài khoản:</div>
              <div class="info-value">{{ environment.vietQR.accountName }}</div>
            </div>
            <div class="info-group">
              <div class="info-label">Số tiền:</div>
              <div class="info-value amount">{{ dotKeKhai.tong_so_tien | number:'1.0-0' }} đ</div>
            </div>
            <div class="info-group">
              <div class="info-label">Nội dung:</div>
              <div class="info-value">{{ getTransferContent() }}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="qr-footer">
        <p>Vui lòng quét mã QR bằng ứng dụng ngân hàng để thanh toán</p>
        <button 
          nz-button 
          nzType="primary" 
          [nzLoading]="isConfirming"
          (click)="confirmPayment()"
          class="confirm-button"
        >
          <i nz-icon nzType="check-circle" nzTheme="outline"></i>
          Xác nhận thanh toán
        </button>
      </div>
    </div>
    <ng-template #loadingTpl>
      <div class="loading-container">
        <nz-spin nzTip="Đang tạo mã QR..."></nz-spin>
      </div>
    </ng-template>
  `,
  styleUrls: ['./thanh-toan-modal.component.scss']
})
export class ThanhToanModalComponent implements OnInit {
  @Input() dotKeKhai!: DotKeKhai;
  loading = true;
  isConfirming = false;
  qrDataUrl: string = '';
  environment = environment;
  currentUser = JSON.parse(localStorage.getItem('user') || '{}');
  nguoiDungInfo?: NguoiDung;

  constructor(
    private modal: NzModalRef,
    private modalService: NzModalService,
    private vietQRService: VietQRService,
    private message: NzMessageService,
    private iconService: NzIconService,
    private userService: UserService
  ) {
    this.iconService.addIcon(DownloadOutline, CheckCircleOutline);
  }

  ngOnInit(): void {
    if (!this.dotKeKhai) {
      this.dotKeKhai = this.modal.getConfig().nzData?.dotKeKhai;
    }
    
    if (!this.dotKeKhai) {
      this.message.error('Không có thông tin đợt kê khai');
      this.modal.close();
      return;
    }

    if (!this.dotKeKhai.DonVi?.maSoBHXH) {
      this.message.error('Không có thông tin mã số BHXH của đơn vị');
      this.modal.close();
      return;
    }

    this.userService.getCurrentUserInfo().subscribe({
      next: (nguoiDung) => {
        this.nguoiDungInfo = nguoiDung;
        this.generateQRCode();
      },
      error: (error) => {
        console.error('Lỗi khi lấy thông tin người dùng:', error);
        this.message.error('Không thể lấy thông tin người dùng');
        this.modal.close();
      }
    });
  }

  generateQRCode(): void {
    if (!this.dotKeKhai?.tong_so_tien) {
      this.message.error('Không có thông tin số tiền cần thanh toán');
      this.modal.close();
      return;
    }

    const request = {
      accountNo: environment.vietQR.accountNo,
      accountName: environment.vietQR.accountName,
      acqId: environment.vietQR.acqId,
      amount: this.dotKeKhai.tong_so_tien,
      addInfo: this.getTransferContent(),
      format: 'base64',
      template: 'compact2',
      bankName: 'AGRIBANK',
      displayAmount: true
    };

    this.vietQRService.generateQR(request).subscribe({
      next: (response) => {
        if (response.code === '00') {
          this.qrDataUrl = response.data.qrDataURL || '';
          this.loading = false;
        } else {
          this.message.error('Không thể tạo mã QR: ' + response.desc);
          this.modal.close();
        }
      },
      error: (error) => {
        console.error('Lỗi khi tạo mã QR:', error);
        this.message.error('Có lỗi xảy ra khi tạo mã QR');
        this.modal.close();
      }
    });
  }

  downloadQR(): void {
    if (!this.qrDataUrl) {
      this.message.warning('Chưa có mã QR để tải');
      return;
    }

    // Tạo một thẻ a ẩn để tải ảnh
    const link = document.createElement('a');
    link.href = this.qrDataUrl;
    link.download = `QR_${this.dotKeKhai.ten_dot.replace(/\s+/g, '_')}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  confirmPayment(): void {
    if (!this.dotKeKhai?.id) {
      this.message.error('Không có thông tin đợt kê khai');
      return;
    }

    // Mở modal upload bill
    const uploadModal = this.modalService.create({
      nzTitle: 'Upload bill thanh toán',
      nzContent: UploadBillModalComponent,
      nzWidth: 520,
      nzData: {
        dotKeKhaiId: this.dotKeKhai.id
      },
      nzFooter: null,
      nzClosable: true,
      nzMaskClosable: false
    });

    // Xử lý kết quả sau khi upload bill
    uploadModal.afterClose.subscribe((result) => {
      if (result?.code === '00') {
        this.modal.close(true);
      }
    });
  }

  getTransferContent(): string {
    if (!this.dotKeKhai.DonVi?.maSoBHXH) {
      return 'Chưa có mã số BHXH của đơn vị';
    }
    const maBHXH = this.dotKeKhai.DonVi.maSoBHXH;
    const maNhanVien = this.nguoiDungInfo?.ma_nhan_vien || this.nguoiDungInfo?.maNhanVien || '';
    return `BHXH 103 00 ${maBHXH} 08907 DONG BHXH CTY HUY PHUC ${maNhanVien}`;
  }
}
````

## File: WebApp.Client/src/app/ke-khai/dot-ke-khai/upload-bill-modal/upload-bill-modal.component.ts
````typescript
import { Component, OnInit, NgZone } from '@angular/core';
import { CommonModule } from '@angular/common';
import { NzModalRef } from 'ng-zorro-antd/modal';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzUploadModule, NzUploadFile, NzUploadChangeParam, NzUploadXHRArgs } from 'ng-zorro-antd/upload';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { UploadOutline } from '@ant-design/icons-angular/icons';
import { NzIconService } from 'ng-zorro-antd/icon';
import { CloudinaryService } from '../../../services/cloudinary.service';
import { VietQRService } from '../../../services/viet-qr.service';
import { DotKeKhaiService } from '../../../services/dot-ke-khai.service';
import { HoaDonThanhToanService } from '../../../services/hoa-don-thanh-toan.service';
import { Observable, Observer, Subscription, finalize, catchError } from 'rxjs';
import { environment } from '../../../../environments/environment';

@Component({
  selector: 'app-upload-bill-modal',
  standalone: true,
  imports: [
    CommonModule,
    NzUploadModule,
    NzButtonModule,
    NzIconModule
  ],
  template: `
    <div class="upload-container">
      <nz-upload
        [(nzFileList)]="fileList"
        [nzBeforeUpload]="beforeUpload"
        [nzCustomRequest]="customRequest"
        [nzShowUploadList]="true"
        [nzMultiple]="false"
        [nzAccept]="'.jpg,.jpeg,.png'"
        [nzRemove]="handleRemove"
        (nzChange)="handleChange($event)"
      >
        <button nz-button [disabled]="fileList.length > 0">
          <i nz-icon nzType="upload"></i>
          Chọn file
        </button>
      </nz-upload>
      <div class="upload-hint">
        <p>Hỗ trợ upload file: JPG, PNG</p>
        <p>Dung lượng tối đa: 5MB</p>
      </div>
    </div>
    <div *nzModalFooter>
      <button nz-button nzType="default" [disabled]="isUploading" (click)="handleCancel()">Hủy</button>
      <button 
        nz-button 
        nzType="primary" 
        [nzLoading]="isUploading"
        [disabled]="!hasFile || isUploading"
        (click)="handleOk()"
      >
        Xác nhận
      </button>
    </div>
  `,
  styles: [`
    .upload-container {
      padding: 24px;
      text-align: center;
    }
    .upload-hint {
      margin-top: 16px;
      color: #8c8c8c;
      font-size: 14px;
      
      p {
        margin: 4px 0;
      }
    }
    :host ::ng-deep {
      .ant-upload-list {
        width: 100%;
        max-width: 360px;
        margin: 16px auto 0;
        text-align: left;
      }
      .ant-upload-list-item {
        margin-top: 8px;
        padding: 8px;
        background: #fafafa;
        border: 1px solid #f0f0f0;
        border-radius: 4px;
      }
      .ant-upload-list-item-name {
        color: #262626;
      }
    }
  `]
})
export class UploadBillModalComponent implements OnInit {
  dotKeKhaiId: number;
  fileList: NzUploadFile[] = [];
  isUploading = false;
  hasFile = false;
  currentUser = JSON.parse(localStorage.getItem('user') || '{}');

  constructor(
    private modal: NzModalRef,
    private message: NzMessageService,
    private iconService: NzIconService,
    private cloudinaryService: CloudinaryService,
    private vietQRService: VietQRService,
    private dotKeKhaiService: DotKeKhaiService,
    private hoaDonService: HoaDonThanhToanService,
    private ngZone: NgZone
  ) {
    this.iconService.addIcon(UploadOutline);
    const modalData = this.modal.getConfig().nzData || {};
    this.dotKeKhaiId = modalData.dotKeKhaiId;
  }

  ngOnInit(): void {
    if (!this.dotKeKhaiId) {
      this.message.error('Không có thông tin đợt kê khai');
      setTimeout(() => this.modal.close(), 0);
    }
  }

  customRequest = (item: NzUploadXHRArgs): Subscription => {
    const formData = new FormData();
    formData.append('file', item.file as any);
    formData.append('upload_preset', environment.cloudinary.uploadPreset);
    
    // Format timestamp theo giờ Việt Nam
    const now = new Date();
    const timestamp = now.toLocaleString('vi-VN', {
      timeZone: 'Asia/Ho_Chi_Minh'
    }).replace(/[/:]/g, '').replace(/,/g, '_').replace(/ /g, '');
    
    const fileName = `bill_${this.dotKeKhaiId}_${timestamp}`;
    formData.append('public_id', fileName);
    formData.append('folder', 'bills');

    const req = new XMLHttpRequest();
    req.open('POST', `https://api.cloudinary.com/v1_1/${environment.cloudinary.cloudName}/image/upload`);

    req.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded * 100) / e.total);
        item.onProgress!({ percent }, item.file);
      }
    };

    req.onload = () => {
      if (req.status === 200) {
        const response = JSON.parse(req.response);
        item.onSuccess!(response, item.file, req);

        // Lưu thông tin response vào file
        const currentFile = this.fileList[0];
        if (currentFile) {
          currentFile.url = response.secure_url;
          currentFile.status = 'done';
          currentFile['cloudinaryResponse'] = response;
        }
      } else {
        item.onError!(new Error('Upload failed'), item.file);
        this.message.error('Upload thất bại');
      }
    };

    req.onerror = () => {
      item.onError!(new Error('Upload failed'), item.file);
      this.message.error('Upload thất bại');
    };

    req.send(formData);

    // Tạo một Subscription mới
    const subscription = new Subscription();
    subscription.add(() => {
      if (req && req.readyState !== 4) {
        req.abort();
      }
    });

    return subscription;
  };

  handleChange(info: NzUploadChangeParam): void {
    if (info.file.status === 'uploading') {
      this.isUploading = true;
      return;
    }
    if (info.file.status === 'done') {
      this.isUploading = false;
      this.hasFile = true;
      
      const response = info.file.response;
      
      // Tạo hóa đơn thanh toán
      const hoaDon = {
        dot_ke_khai_id: this.dotKeKhaiId,
        so_tien: 0, // Số tiền sẽ được cập nhật sau
        noi_dung_thanh_toan: 'Upload bill thanh toán',
        url_bill: response.secure_url,
        public_id: response.public_id,
        trang_thai: 'cho_duyet',
        nguoi_tao: this.currentUser.username || ''
      };

      this.hoaDonService.create(hoaDon).subscribe({
        next: () => {
          // Cập nhật trạng thái sang đang xử lý
          this.dotKeKhaiService.updateTrangThai(this.dotKeKhaiId, 'dang_xu_ly').subscribe({
            next: () => {
              this.message.success('Xác nhận thanh toán thành công');
              // Đóng modal hiện tại
              this.modal.close({
                code: '00',
                data: {
                  billUrl: response.secure_url,
                  publicId: response.public_id
                }
              });
            },
            error: (error) => {
              console.error('Lỗi khi cập nhật trạng thái:', error);
              this.message.error('Có lỗi xảy ra khi cập nhật trạng thái đợt kê khai');
            }
          });
        },
        error: (error) => {
          console.error('Lỗi khi lưu hóa đơn:', error);
          this.message.error('Có lỗi xảy ra khi lưu thông tin hóa đơn');
        }
      });
    } else if (info.file.status === 'error') {
      this.isUploading = false;
      this.message.error(`${info.file.name} không thể upload.`);
    }
    if (info.type === 'removed') {
      this.hasFile = false;
      this.fileList = [];
    }
  }

  beforeUpload = (file: NzUploadFile): boolean => {
    // Kiểm tra định dạng file
    const isValidType = file.type === 'image/jpeg' || file.type === 'image/png';
    if (!isValidType) {
      this.message.error('Chỉ hỗ trợ file JPG hoặc PNG!');
      return false;
    }

    // Kiểm tra dung lượng file (5MB)
    const isLt5M = file.size! / 1024 / 1024 < 5;
    if (!isLt5M) {
      this.message.error('File phải nhỏ hơn 5MB!');
      return false;
    }

    return true; // Cho phép upload
  };

  handleRemove = (): boolean => {
    this.hasFile = false;
    this.fileList = [];
    return true;
  };

  handleOk(): void {
    if (this.fileList.length === 0) {
      this.message.warning('Vui lòng chọn file bill thanh toán');
      return;
    }

    const currentFile = this.fileList[0];
    if (!currentFile || !currentFile['cloudinaryResponse']) {
      this.message.error('Vui lòng đợi upload hoàn tất');
      return;
    }

    const response = currentFile['cloudinaryResponse'];
    
    // Xác nhận thanh toán với URL của bill
    this.vietQRService.confirmPayment(
      this.dotKeKhaiId,
      response.secure_url,
      response.public_id
    ).subscribe({
      next: (confirmResponse) => {
        if (confirmResponse.code === '00' && confirmResponse.data.status === 'success') {
          this.message.success('Xác nhận thanh toán thành công');
          this.ngZone.run(() => {
            // Đóng modal hiện tại
            this.modal.close({
              code: '00',
              data: {
                billUrl: response.secure_url,
                publicId: response.public_id
              }
            });
          });
        } else {
          this.message.error('Xác nhận thanh toán thất bại');
        }
      },
      error: (error) => {
        console.error('Lỗi khi xác nhận thanh toán:', error);
        this.message.error('Có lỗi xảy ra khi xác nhận thanh toán');
      }
    });
  }

  handleCancel(): void {
    if (this.isUploading) {
      return;
    }
    this.modal.close();
  }
}
````

## File: WebApp.Client/src/app/ke-khai/dot-ke-khai/dot-ke-khai.component.html
````html
<div class="container">
  <div class="header">
    <div class="title">
      <h2>Quản lý đợt kê khai</h2>
    </div>
    <div class="actions">
      <button nz-button nzType="primary" (click)="showModal()">
        <i nz-icon nzType="plus"></i>
        Thêm mới
      </button>
      <button nz-button nzType="default" [disabled]="selectedIds.length === 0" (click)="deleteSelected()">
        <i nz-icon nzType="delete"></i>
        Xóa đã chọn
      </button>
      <button nz-button nzType="default" [disabled]="selectedIds.length === 0" (click)="downloadAllBills()" nz-tooltip="Tải tất cả ảnh hóa đơn của các đợt kê khai đã chọn">
        <i nz-icon nzType="download"></i>
        Tải tất cả hóa đơn <span *ngIf="getSelectedBillCount() > 0">({{ getSelectedBillCount() }})</span>
      </button>
    </div>
  </div>

  <!-- Thay thế phần thống kê hiện tại bằng đoạn code sau -->
  <div class="stats-grid">
    <div class="stat-card primary">
      <div class="stat-icon">
        <span nz-icon nzType="file-done" nzTheme="outline"></span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ dotKeKhais.length }}</div>
        <div class="stat-label">Tổng kê khai</div>
      </div>
    </div>

    <div class="stat-card success">
      <div class="stat-icon">
        <span nz-icon nzType="check-circle" nzTheme="outline"></span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ getCounts('hoan_thanh') }}</div>
        <div class="stat-label">Hoàn thành</div>
      </div>
      <div class="stat-trend up">
        <span nz-icon nzType="arrow-up" nzTheme="outline"></span>

        <span>8%</span>
      </div>
    </div>

    <div class="stat-card warning">
      <div class="stat-icon">
        <span nz-icon nzType="close-circle" nzTheme="outline"></span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ getCounts('tu_choi') }}</div>
        <div class="stat-label">Từ chối</div>
      </div>
      <div class="stat-trend down">
        <span nz-icon nzType="arrow-down" nzTheme="outline"></span>
        <span>5%</span>
      </div>
    </div>

    <div class="stat-card success">
      <div class="stat-icon">
        <span nz-icon nzType="dollar" nzTheme="outline"></span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ getTotalAmount() | number:'1.0-0' }}</div>
        <div class="stat-label">Tổng số tiền (đ)</div>
      </div>
    </div>
  </div>

  <!-- Card Danh sách -->
  <nz-card class="table-card" [nzBordered]="false">
    <div class="tab-filter-wrapper">
      <nz-tabset 
        [(nzSelectedIndex)]="selectedTabIndex" 
        (nzSelectedIndexChange)="onTabChange($event)"
        [nzAnimated]="false"
        [nzTabPosition]="'top'">
        <nz-tab nzTitle="Tất cả"></nz-tab>
        <nz-tab [nzTitle]="chuaGuiTemplate">
          <ng-template #chuaGuiTemplate>
            Chưa gửi <nz-badge [nzCount]="getCounts('chua_gui')" [nzStyle]="{ backgroundColor: '#108ee9' }"></nz-badge>
          </ng-template>
        </nz-tab>
        <nz-tab [nzTitle]="choThanhToanTemplate">
          <ng-template #choThanhToanTemplate>
            Chờ thanh toán <nz-badge [nzCount]="getCounts('cho_thanh_toan')" [nzStyle]="{ backgroundColor: '#faad14' }"></nz-badge>
          </ng-template>
        </nz-tab>
        <nz-tab nzTitle="Hoàn thành"></nz-tab>
        <nz-tab nzTitle="Từ chối"></nz-tab>
      </nz-tabset>
    </div>

    <button *ngIf="selectedIds.length > 0" nz-button nzType="primary" nzDanger (click)="deleteSelected()">
      <i nz-icon nzType="delete"></i>Xóa {{ selectedIds.length }} đợt đã chọn
    </button>

    <nz-table
      #basicTable
      [nzData]="filteredDotKeKhais"
      [nzScroll]="{ x: '1200px' }"
      [nzLoading]="loading">
      <thead>
        <tr>
          <th [nzWidth]="'50px'" [nzChecked]="isAllChecked" [nzIndeterminate]="isIndeterminate" (nzCheckedChange)="onAllChecked($event)"></th>
          <th [nzWidth]="'180px'">Tên đợt</th>
          <th [nzWidth]="'200px'">Đơn vị</th>
          <th [nzWidth]="'80px'" nzAlign="center">Dịch vụ</th>
          <th [nzWidth]="'100px'" nzAlign="right">Tổng số thẻ</th>
          <th [nzWidth]="'120px'" nzAlign="right">Tổng số tiền</th>
          <th [nzWidth]="'100px'" nzAlign="center">Trạng thái</th>
          <th [nzWidth]="'120px'">Ghi chú</th>
          <th [nzWidth]="'120px'">Mã hồ sơ</th>
          <th [nzWidth]="'120px'" nzAlign="center">Hóa đơn</th>
          <th [nzWidth]="'160px'" nzAlign="center">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of basicTable.data; let i = index" (click)="onRowClick(data)">
          <td [nzChecked]="getCheckedStatus(data)" (nzCheckedChange)="onItemChecked($event, data)"></td>
          <td>{{ data.ten_dot }}</td>
          <td>{{ getDonViName(data.don_vi_id) }}</td>
          <td nzAlign="center">{{ data.dich_vu }}</td>
          <td nzAlign="right">{{ data.tong_so_the || 0 }}</td>
          <td nzAlign="right">{{ data.tong_so_tien | number:'1.0-0' }} đ</td>
          <td nzAlign="center">
            <nz-tag [nzColor]="getTagColor(data.trang_thai)">
              {{ getTagText(data.trang_thai) }}
            </nz-tag>
          </td>
          <td>{{ data.ghi_chu }}</td>
          <td>{{ data.ma_ho_so }}</td>
          <td nzAlign="center">
            <ng-container *ngIf="data.url_bill">
              <button nz-button nzType="link" (click)="$event.stopPropagation(); showViewBillModal(data.url_bill)">
                <img [src]="data.url_bill" style="max-width: 50px; max-height: 50px; cursor: pointer;" 
                     nz-tooltip="Xem hóa đơn" />
              </button>
            </ng-container>
            <button *ngIf="!data.url_bill && (data.trang_thai === 'cho_thanh_toan' || data.trang_thai === 'chua_gui')" 
                    nz-button nzType="link" 
                    (click)="$event.stopPropagation(); showThanhToanModal(data)">
              <i nz-icon nzType="upload"></i>
              Thanh toán
            </button>
          </td>
          <td nzAlign="center">
            <nz-button-group>
              <button 
                nz-button 
                nzType="default"
                nz-tooltip="Sửa"
                (click)="$event.stopPropagation(); showModal(data)">
                <i nz-icon nzType="edit"></i>
              </button>
              <button 
                nz-button 
                nzType="default"
                nz-tooltip="Xuất Excel"
                (click)="$event.stopPropagation(); exportData(data)">
                <i nz-icon nzType="export"></i>
              </button>
              <button 
                *ngIf="data.dich_vu === 'BHXH TN'"
                nz-button 
                nzType="default"
                nz-tooltip="Xuất BHXH VNPT"
                (click)="$event.stopPropagation(); exportBHXHVNPT(data)">
                <i nz-icon nzType="file-excel"></i>
              </button>
              <button 
                *ngIf="data.trang_thai === 'chua_gui'" 
                nz-button
                nzType="primary"
                nz-tooltip="Gửi đợt kê khai"
                (click)="$event.stopPropagation(); guiDotKeKhai(data)">
                <i nz-icon nzType="send"></i>
              </button>
            </nz-button-group>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>

  <nz-modal
    [(nzVisible)]="isVisible"
    [nzTitle]="isEdit ? 'Cập nhật đợt kê khai' : 'Thêm mới đợt kê khai'"
    [nzOkText]="isEdit ? 'Cập nhật' : 'Thêm mới'"
    [nzCancelText]="'Hủy'"
    (nzOnCancel)="handleCancel()"
    (nzOnOk)="handleOk()"
    [nzWidth]="500">
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="form" class="compact-form">
        <nz-form-item>
          <nz-form-label [nzSpan]="5" nzRequired>Đơn vị</nz-form-label>
          <nz-form-control [nzSpan]="19" nzErrorTip="Vui lòng chọn đơn vị">
            <nz-select 
              formControlName="don_vi_id" 
              nzPlaceHolder="Chọn đơn vị"
              nzShowSearch
              [nzLoading]="loading">
              <nz-option
                *ngFor="let donVi of donVis"
                [nzValue]="donVi.id"
                [nzLabel]="donVi.tenDonVi + (donVi.IsBHYT ? ' (BHYT)' : '')">
              </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="5" nzRequired>Đại lý</nz-form-label>
          <nz-form-control [nzSpan]="19" nzErrorTip="Vui lòng chọn đại lý">
            <nz-select 
              formControlName="dai_ly_id" 
              nzPlaceHolder="Chọn đại lý"
              nzShowSearch
              [nzLoading]="loading"
              [nzDisabled]="!isEdit && daiLys.length === 1"
              style="width: 100%;">
              <nz-option
                *ngFor="let daiLy of daiLys"
                [nzValue]="daiLy.id"
                [nzLabel]="daiLy.ten">
              </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="5">Ghi chú</nz-form-label>
          <nz-form-control [nzSpan]="19">
            <textarea nz-input formControlName="ghi_chu" rows="3" placeholder="Nhập ghi chú"></textarea>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="5">Mã hồ sơ</nz-form-label>
          <nz-form-control [nzSpan]="19">
            <input nz-input formControlName="ma_ho_so" placeholder="Nhập mã hồ sơ (nếu có)" />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="5">Biên lai</nz-form-label>
          <nz-form-control [nzSpan]="19">
            <label nz-checkbox formControlName="is_bien_lai_dien_tu">
              Sử dụng biên lai điện tử
            </label>
          </nz-form-control>
        </nz-form-item>
      </form>
    </ng-container>
  </nz-modal>

  <!-- Modal xem hóa đơn -->
  <nz-modal
    [(nzVisible)]="isViewBillModalVisible"
    [nzTitle]="billModalTitle"
    [nzFooter]="billModalFooter"
    (nzOnCancel)="handleViewBillModalCancel()"
    [nzWidth]="800"
    [nzStyle]="{ top: '20px' }">
    <ng-container *nzModalContent>
      <div class="bill-container">
        <div class="bill-toolbar">
          <div class="bill-actions">
            <button nz-button nzType="default" (click)="zoomIn()" nz-tooltip="Phóng to">
              <i nz-icon nzType="zoom-in" nzTheme="outline"></i>
            </button>
            <button nz-button nzType="default" (click)="zoomOut()" nz-tooltip="Thu nhỏ">
              <i nz-icon nzType="zoom-out" nzTheme="outline"></i>
            </button>
            <button nz-button nzType="default" (click)="resetZoom()" nz-tooltip="Khôi phục kích thước">
              <i nz-icon nzType="fullscreen-exit" nzTheme="outline"></i>
            </button>
            <button nz-button nzType="default" (click)="rotateLeft()" nz-tooltip="Xoay trái">
              <i nz-icon nzType="rotate-left" nzTheme="outline"></i>
            </button>
            <button nz-button nzType="default" (click)="rotateRight()" nz-tooltip="Xoay phải">
              <i nz-icon nzType="rotate-right" nzTheme="outline"></i>
            </button>
          </div>
        </div>
        
        <div class="bill-content">
          <div class="bill-image-container" [style.transform]="'scale(' + zoomLevel + ') rotate(' + rotationDegree + 'deg)'">
            <img [src]="selectedBillUrl" alt="Hóa đơn" />
          </div>
        </div>
        
        <div class="bill-info" *ngIf="selectedDotKeKhai">
          <nz-descriptions nzTitle="Thông tin hóa đơn" [nzColumn]="{ xxl: 2, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }">
            <nz-descriptions-item nzTitle="Tên đợt">{{ selectedDotKeKhai.ten_dot }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Đơn vị">{{ getDonViName(selectedDotKeKhai.don_vi_id) }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Dịch vụ">{{ selectedDotKeKhai.dich_vu }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Tổng số thẻ">{{ selectedDotKeKhai.tong_so_the || 0 }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Tổng số tiền">{{ selectedDotKeKhai.tong_so_tien | number:'1.0-0' }} đ</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Trạng thái">
              <nz-tag [nzColor]="getTagColor(selectedDotKeKhai.trang_thai)">
                {{ getTagText(selectedDotKeKhai.trang_thai) }}
              </nz-tag>
            </nz-descriptions-item>
            <nz-descriptions-item nzTitle="Mã hồ sơ">{{ selectedDotKeKhai.ma_ho_so }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Ngày tạo">{{ selectedDotKeKhai.ngay_tao | date:'dd/MM/yyyy HH:mm' }}</nz-descriptions-item>
          </nz-descriptions>
        </div>
      </div>
    </ng-container>
    
    <ng-template #billModalTitle>
      <div class="modal-title">
        <span>Xem hóa đơn</span>
        <span *ngIf="selectedDotKeKhai" class="modal-subtitle">{{ selectedDotKeKhai.ten_dot }}</span>
      </div>
    </ng-template>
    
    <ng-template #billModalFooter>
      <button nz-button nzType="default" (click)="handleViewBillModalCancel()">Đóng</button>
      <button nz-button nzType="primary" (click)="downloadBill()">
        <i nz-icon nzType="download" nzTheme="outline"></i>
        Tải xuống
      </button>
    </ng-template>
  </nz-modal>

  <!-- Thêm template này ở cuối file -->
  <ng-template #modalGuiDotKeKhai>
    <div>
      <p>Bạn có chắc chắn muốn gửi đợt kê khai này?</p>
      <div *ngIf="willUseBienLaiDienTu" style="margin-top: 15px;">
        <nz-alert
          nzType="info"
          nzMessage="Thông báo"
          nzDescription="Đợt kê khai này sẽ tự động sử dụng biên lai điện tử khi gửi."
          nzShowIcon
        ></nz-alert>
      </div>
    </div>
  </ng-template>
</div>

<style>
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.filters {
  display: flex;
  gap: 8px;
  margin-right: 16px;
}

.compact-form {
  padding: 8px 0;
}

.compact-form nz-form-item {
  margin-bottom: 16px;
}

.compact-form nz-form-item:last-child {
  margin-bottom: 0;
}

.compact-form nz-form-label {
  padding: 0 8px;
}

:host ::ng-deep .ant-modal-body {
  padding: 16px;
}

:host ::ng-deep .ant-modal-footer {
  padding: 12px 16px;
}

:host ::ng-deep .ant-modal-header {
  padding: 12px 16px;
}

:host ::ng-deep .ant-form-item-label > label {
  font-size: 14px;
}

:host ::ng-deep .ant-select-selection-placeholder,
:host ::ng-deep .ant-input::placeholder {
  font-size: 14px;
}

.bill-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.bill-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
}

.bill-actions {
  display: flex;
  gap: 8px;
}

.bill-content {
  position: relative;
  width: 100%;
  height: 400px;
  overflow: auto;
  background-color: #f5f5f5;
  border-radius: 4px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.bill-image-container {
  transition: transform 0.3s ease;
  transform-origin: center center;
}

.bill-image-container img {
  max-width: 100%;
  height: auto;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.bill-info {
  border-top: 1px solid #f0f0f0;
  padding-top: 16px;
}

.modal-title {
  display: flex;
  flex-direction: column;
}

.modal-subtitle {
  font-size: 12px;
  color: rgba(0, 0, 0, 0.45);
  margin-top: 4px;
}

:host ::ng-deep .ant-descriptions-item-label {
  font-weight: 500;
  color: rgba(0, 0, 0, 0.65);
}

:host ::ng-deep {
  .ant-table-thead > tr > th {
    background-color: #f0f2f5;
    font-weight: 600;
    padding: 12px 8px;
  }

  .ant-table-tbody > tr > td {
    padding: 12px 8px;
  }

  .ant-table-tbody > tr:hover {
    cursor: pointer;
  }

  .ant-tag {
    margin: 0;
    min-width: 80px;
    text-align: center;
  }

  .ant-table-tbody > tr > td:nth-child(8) {
    padding: 12px 8px;
  }

  .ant-table-tbody > tr > td:nth-child(10) {
    padding: 8px 4px;
    min-width: 120px;

    img {
      max-width: 40px;
      max-height: 40px;
      object-fit: contain;
    }

    .ant-btn {
      padding: 0 8px;
      height: 32px;
    }
  }

  .ant-btn-group {
    display: flex;
    gap: 4px;
  }

  .ant-btn-group > .ant-btn {
    border-radius: 4px !important;
    padding: 0 8px;
    height: 32px;
    line-height: 32px;
  }

  .ant-btn-group > .ant-btn:not(:first-child):not(:last-child) {
    margin: 0;
  }

  .ant-btn-group > .ant-btn:hover {
    z-index: 2;
  }

  .ant-btn-group > .ant-btn > .anticon {
    font-size: 16px;
  }

  /* Style cho cột thao tác */
  .ant-table-tbody > tr > td:nth-child(11) {
    padding: 8px 4px;
    min-width: 160px;
  }

  /* Đảm bảo table scroll ngang khi cần thiết */
  .ant-table-content {
    overflow-x: auto;
  }
}
</style>
````

## File: WebApp.Client/src/app/ke-khai/dot-ke-khai/dot-ke-khai.component.scss
````scss
.container {
  padding: 24px;
  border-radius: 8px;
  min-height: calc(100vh - 48px);
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;

  h2 {
    margin-bottom: 0;
    color: #262626;
    font-weight: 600;
  }
}

.actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.tab-filter-wrapper {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;

  nz-tabset {
    flex: 1;
  }
}

:host ::ng-deep {
  .ant-table-thead > tr > th {
    background-color: #f0f2f5;
    font-weight: 600;
    height: 56px;
  }

  .ant-table-tbody > tr > td {
    height: 56px;
    padding: 12px 8px;
  }

  .ant-form-item {
    margin-bottom: 16px;
  }

  nz-date-picker {
    width: 100%;
  }

  .ant-card {
    background: transparent;
    box-shadow: none;
    
    &.statistics-card {
      .ant-card-body {
        background: transparent;
        padding: 0;
      }
    }
    
    &.table-card {
      .ant-card-body {
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      }
    }
  }

  .ant-select {
    min-width: 120px;
  }

  .ant-tabs {
    margin-bottom: 0;
  }

  .ant-badge {
    margin-left: 8px;
  }

  .ant-badge-count {
    font-size: 12px;
    height: 20px;
    line-height: 20px;
    padding: 0 6px;
    border-radius: 10px;
  }

  .ant-tabs-content {
    .ant-tabs-tabpane {
      &-hidden {
        opacity: 0;
        visibility: hidden;
        height: 0;
        overflow: hidden;
      }
      
      &-active {
        opacity: 1;
        visibility: visible;
        height: auto;
        transition: opacity 0.3s;
      }
    }
  }
}

.clickable-row {
  &:hover {
    background-color: #f5f5f5;
    transition: background-color 0.3s;
  }
  
  td {
    transition: background-color 0.3s;
  }
}

tr td:first-child,
tr td:last-child {
  background-color: inherit !important;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 24px;
  margin-bottom: 24px;

  .stat-card {
    display: flex;
    align-items: center;
    padding: 24px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    transition: all 0.3s ease;

    &:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .stat-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 8px;
      margin-right: 16px;
      font-size: 24px;

      .anticon {
        color: white;
      }
    }

    .stat-content {
      flex: 1;

      .stat-value {
        font-size: 24px;
        font-weight: 600;
        line-height: 1.2;
        margin-bottom: 4px;
      }

      .stat-label {
        color: #8c8c8c;
        font-size: 14px;
      }
    }

    .stat-trend {
      display: flex;
      align-items: center;
      font-size: 14px;
      margin-left: 16px;

      &.up {
        color: #52c41a;
      }

      &.down {
        color: #ff4d4f;
      }

      .anticon {
        margin-right: 4px;
      }
    }

    &.primary {
      .stat-icon {
        background: #1890ff;
      }
    }

    &.success {
      .stat-icon {
        background: #52c41a;
      }
    }

    &.warning {
      .stat-icon {
        background: #faad14;
      }
    }

    &.info {
      .stat-icon {
        background: #13c2c2;
      }
    }
  }
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;

    .stat-card {
      padding: 16px;

      .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }

      .stat-content {
        .stat-value {
          font-size: 20px;
        }
      }
    }
  }
}
````

## File: WebApp.Client/src/app/ke-khai/dot-ke-khai/dot-ke-khai.component.ts
````typescript
import { Component, OnInit, CUSTOM_ELEMENTS_SCHEMA, ViewChild, TemplateRef } from '@angular/core';
import { CommonModule } from '@angular/common';
import { DotKeKhai, CreateDotKeKhai, UpdateDotKeKhai, DotKeKhaiService } from '../../services/dot-ke-khai.service';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzModalService } from 'ng-zorro-antd/modal';
import { FormBuilder, FormGroup, Validators, FormsModule, ReactiveFormsModule } from '@angular/forms';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzDatePickerModule } from 'ng-zorro-antd/date-picker';
import { NzInputNumberModule } from 'ng-zorro-antd/input-number';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { RouterModule, Router } from '@angular/router';
import { NzCheckboxModule } from 'ng-zorro-antd/checkbox';
import { UserService, DaiLy } from '../../services/user.service';
import { 
  SaveOutline,
  PlusOutline,
  CloseOutline,
  EditOutline,
  DeleteOutline,
  FormOutline,
  FileDoneOutline,
  ReloadOutline,
  ArrowUpOutline,
  ArrowDownOutline,
  DollarOutline,
  ExportOutline,
  SendOutline,
  ZoomInOutline,
  ZoomOutOutline,
  FullscreenExitOutline,
  RotateLeftOutline,
  RotateRightOutline,
  DownloadOutline
} from '@ant-design/icons-angular/icons';
import { NzIconService } from 'ng-zorro-antd/icon';
import { NzTabsModule } from 'ng-zorro-antd/tabs';
import { NzBadgeModule } from 'ng-zorro-antd/badge';
import { NzStatisticModule } from 'ng-zorro-antd/statistic';
import { NzCardModule } from 'ng-zorro-antd/card';
import { DonViService } from '../../services/don-vi.service';
import { combineLatest } from 'rxjs';
import { debounceTime } from 'rxjs/operators';
import { ThanhToanModalComponent } from './thanh-toan-modal/thanh-toan-modal.component';
import * as XLSX from 'xlsx';
import { NzToolTipModule } from 'ng-zorro-antd/tooltip';
import { NzDescriptionsModule } from 'ng-zorro-antd/descriptions';
import JSZip from 'jszip';
import { saveAs } from 'file-saver';
import { HttpClient } from '@angular/common/http';
import { environment } from '../../../environments/environment';

interface QuyenBienLai {
  id: number;
  quyen_so: string;
  tu_so: string;
  den_so: string;
  so_hien_tai?: string;
  nhan_vien_thu: number;
  nguoi_cap: string;
  ngay_cap?: Date;
  trang_thai: string;
}

interface KeKhaiBHYT {
  ho_ten: string;
  cccd: string;
  ngay_sinh: Date;
  gioi_tinh: string;
  dia_chi: string;
  so_dien_thoai: string;
  email: string;
  so_tien: number;
  ghi_chu?: string;
  so_the_bhyt: string;
  ma_so_bhxh?: string;
  nguoi_thu: number;
  phuong_an_dong?: string;
  ngay_bien_lai?: Date;
  ma_tinh_nkq?: string;
  ma_huyen_nkq?: string;
  ma_xa_nkq?: string;
  dia_chi_nkq?: string;
  so_thang_dong?: number;
  ma_benh_vien?: string;
  ma_hgd?: string;
  quoc_tich?: string;
  ma_tinh_ks?: string;
  ma_huyen_ks?: string;
  ma_xa_ks?: string;
  so_bien_lai?: string;
  han_the_moi_tu?: Date;
  is_urgent?: boolean;
  ma_nhan_vien?: string;
  QuyenBienLai?: QuyenBienLai;
}

@Component({
  selector: 'app-dot-ke-khai',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    RouterModule,
    NzTableModule,
    NzButtonModule,
    NzIconModule,
    NzTagModule,
    NzModalModule,
    NzFormModule,
    NzInputModule,
    NzDatePickerModule,
    NzInputNumberModule,
    NzSelectModule,
    NzCheckboxModule,
    NzTabsModule,
    NzBadgeModule,
    NzStatisticModule,
    NzCardModule,
    NzToolTipModule,
    NzDescriptionsModule
  ],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  templateUrl: './dot-ke-khai.component.html',
  styleUrls: ['./dot-ke-khai.component.scss']
})
export class DotKeKhaiComponent implements OnInit {
  dotKeKhais: DotKeKhai[] = [];
  loading = false;
  isVisible = false;
  isEdit = false;
  form: FormGroup;
  currentUser = JSON.parse(localStorage.getItem('user') || '{}');
  selectedIds: number[] = [];
  originalDotKeKhais: DotKeKhai[] = []; // Lưu trữ dữ liệu gốc
  isAllChecked = false;
  isIndeterminate = false;
  selectedTabIndex = 0;
  filteredDotKeKhais: DotKeKhai[] = [];
  donVis: any[] = [];
  daiLys: DaiLy[] = [];
  checkedSet = new Set<number>();
  // API Url từ environment
  private apiUrl = `${environment.apiUrl}/dot-ke-khai`;
  // Cache cho danh sách đơn vị theo đại lý
  private donVisByDaiLyCache: Map<number, any[]> = new Map();

  // Thêm các thuộc tính cho modal xem hóa đơn
  isViewBillModalVisible = false;
  selectedBillUrl: string = '';
  selectedDotKeKhai: DotKeKhai | null = null;
  zoomLevel: number = 1;
  rotationDegree: number = 0;
  bienLaiDienTu: boolean = false;
  willUseBienLaiDienTu: boolean = false;

  // Map trạng thái theo tab index
  private readonly trangThaiMap = [
    '', // Tất cả
    'chua_gui',
    'da_gui',
    'dang_xu_ly',
    'cho_thanh_toan',
    'hoan_thanh',
    'tu_choi'
  ];

  // Trong phần khai báo các thuộc tính của class DotKeKhaiComponent
  isLoadingDonVis = false;
  dotKeKhai: any = null;
  donViSelected: any = null;
  dotKeKhaiForm: any = null;

  @ViewChild('modalGuiDotKeKhai') modalGuiDotKeKhaiTpl!: TemplateRef<any>;

  constructor(
    private dotKeKhaiService: DotKeKhaiService,
    private message: NzMessageService,
    private modal: NzModalService,
    private fb: FormBuilder,
    private router: Router,
    private iconService: NzIconService,
    private donViService: DonViService,
    private userService: UserService,
    private http: HttpClient
  ) {
    // Đăng ký các icons
    this.iconService.addIcon(
      SaveOutline,
      PlusOutline,
      CloseOutline,
      EditOutline,
      DeleteOutline,
      FormOutline,
      FileDoneOutline,
      ReloadOutline,
      ArrowUpOutline,
      ArrowDownOutline,
      DollarOutline,
      ExportOutline,
      SendOutline,
      ZoomInOutline,
      ZoomOutOutline,
      FullscreenExitOutline,
      RotateLeftOutline,
      RotateRightOutline,
      DownloadOutline
    );

    const currentDate = new Date();
    this.form = this.fb.group({
      id: [null],
      ten_dot: [{value: '', disabled: true}],
      so_dot: [1, [Validators.required, Validators.min(1)]],
      thang: [currentDate.getMonth() + 1, [Validators.required, Validators.min(1), Validators.max(12)]],
      nam: [currentDate.getFullYear(), [Validators.required, Validators.min(2000)]],
      ghi_chu: [null],
      trang_thai: ['chua_gui'],
      nguoi_tao: [this.currentUser.username || '', [Validators.required]],
      don_vi_id: [null, [Validators.required]],
      ma_ho_so: [null],
      is_bien_lai_dien_tu: [false],
      dai_ly_id: [null, [Validators.required]]
    });

    this.form.get('so_dot')?.valueChanges.subscribe(() => this.updateTenDot());
    this.form.get('thang')?.valueChanges.subscribe(() => this.updateTenDot());
    this.form.get('nam')?.valueChanges.subscribe(() => this.updateTenDot());
    
    // Thêm sự kiện lắng nghe khi thay đổi đại lý
    this.form.get('dai_ly_id')?.valueChanges.subscribe(daiLyId => {
      if (daiLyId) {
        // Reset giá trị đơn vị khi thay đổi đại lý
        this.form.patchValue({ don_vi_id: null }, { emitEvent: false });
        // Load danh sách đơn vị theo đại lý mới
        this.loadDonVisByDaiLy(daiLyId);
      } else {
        // Xóa danh sách đơn vị nếu không có đại lý
        this.donVis = [];
      }
    });

    // Subscribe to dotKeKhais stream
    this.dotKeKhaiService.dotKeKhais$.subscribe(data => {
      this.dotKeKhais = this.sortDotKeKhais(data);
      this.filterData();
    });
  }

  updateTenDot(): void {
    const so_dot = this.form.get('so_dot')?.value;
    const thang = this.form.get('thang')?.value;
    const nam = this.form.get('nam')?.value;

    if (so_dot > 0 && thang >= 1 && thang <= 12 && nam >= 2000) {
      const ten_dot = `Đợt ${so_dot} Tháng ${thang} năm ${nam}`;
      this.form.patchValue({ ten_dot }, { emitEvent: false });
    }
  }

  private sortDotKeKhais(data: any[]): any[] {
    return data.sort((a, b) => {
      const dateA = a.ngay_tao ? new Date(a.ngay_tao).getTime() : 0;
      const dateB = b.ngay_tao ? new Date(b.ngay_tao).getTime() : 0;
      return dateB - dateA; // Sắp xếp giảm dần (mới nhất lên trên)
    });
  }

  ngOnInit(): void {
    this.loadData();
    this.loadDaiLys();
    this.updateTenDot();
    
    // Theo dõi thay đổi của don_vi_id
    this.form.get('don_vi_id')?.valueChanges.subscribe(() => {
      this.updateSoDot();
    });

    // Theo dõi thay đổi của thang và nam
    this.form.get('thang')?.valueChanges.subscribe(() => {
      this.updateSoDot();
    });

    this.form.get('nam')?.valueChanges.subscribe(() => {
      this.updateSoDot();
    });

    // Không đăng ký sự kiện valueChanges của dai_ly_id ở đây
    // Sự kiện này sẽ được đăng ký trong phương thức showModal
  }

  private updateSoDot(): void {
    const donViId = this.form.get('don_vi_id')?.value;
    const thang = this.form.get('thang')?.value;
    const nam = this.form.get('nam')?.value;

    if (donViId && thang && nam) {
      this.loading = true;
      // Gọi API để lấy số đợt tiếp theo
      this.dotKeKhaiService.getNextSoDot(donViId, thang, nam).subscribe({
        next: (nextSoDot) => {
          this.form.patchValue({
            so_dot: nextSoDot,
            ten_dot: `Đợt ${nextSoDot} Tháng ${thang} năm ${nam}`
          }, { emitEvent: false });
          this.loading = false;
        },
        error: (error) => {
          console.error('Lỗi khi lấy số đợt:', error);
          this.message.error('Có lỗi xảy ra khi lấy số đợt');
          this.loading = false;
        }
      });
    }
  }

  loadData(): void {
    this.loading = true;
    // Lấy danh sách đợt kê khai
    this.dotKeKhaiService.getDotKeKhais().subscribe({
      next: (data) => {
        console.log('Danh sách đợt kê khai:', data);
        
        // Lọc theo người tạo
        const filteredData = data.filter(dot => dot.nguoi_tao === this.currentUser.username);
        
        // Kiểm tra thông tin đơn vị
        filteredData.forEach(dot => {
          if (!dot.DonVi) {
            console.warn(`Đợt kê khai ${dot.ten_dot} không có thông tin đơn vị`);
          } else if (!dot.DonVi.maSoBHXH) {
            console.warn(`Đơn vị của đợt kê khai ${dot.ten_dot} chưa có mã số BHXH`);
          }
        });
        
        this.dotKeKhais = this.sortDotKeKhais(filteredData);
        this.filterData();
        this.loading = false;
      },
      error: (error) => {
        console.error('Lỗi khi tải dữ liệu:', error);
        this.message.error('Có lỗi xảy ra khi tải dữ liệu');
        this.loading = false;
      }
    });
  }

  loadDaiLys(): void {
    this.loading = true;
    this.userService.getDaiLys().subscribe({
      next: (data) => {
        // Nếu user có donViCongTac, lọc theo đại lý của user
        if (this.currentUser.donViCongTac) {
          this.daiLys = data.filter(daiLy => daiLy.ma === this.currentUser.donViCongTac);
        } else {
          // Nếu không có donViCongTac, lấy tất cả đại lý
          this.daiLys = data;
        }
        
        // Nếu có đại lý và form chưa có giá trị đại lý, tự động set vào form
        // Sử dụng emitEvent: false để tránh kích hoạt sự kiện valueChanges
        if (this.daiLys.length === 1 && !this.form.get('dai_ly_id')?.value) {
          this.form.patchValue({
            dai_ly_id: this.daiLys[0].id
          }, { emitEvent: false });
          
          // Gọi trực tiếp loadDonVisByDaiLy thay vì thông qua sự kiện valueChanges
          this.loadDonVisByDaiLy(this.daiLys[0].id);
        }
        this.loading = false;
      },
      error: () => {
        this.message.error('Có lỗi xảy ra khi tải danh sách đại lý');
        this.loading = false;
      }
    });
  }

  onTabChange(index: number): void {
    this.selectedTabIndex = index;
    this.filterData();
  }

  filterData(): void {
    let filtered = [...this.dotKeKhais];

    // Lọc theo trạng thái (tab)
    const selectedTrangThai = this.trangThaiMap[this.selectedTabIndex];
    if (selectedTrangThai) {
      filtered = filtered.filter(item => item.trang_thai === selectedTrangThai);
    }

    // Đảm bảo tong_so_tien luôn là số
    filtered = filtered.map(item => ({
      ...item,
      tong_so_tien: item.tong_so_tien || 0
    }));

    this.filteredDotKeKhais = filtered;
  }

  getNextSoDot(nam: number): number {
    const dotKeKhaisInYear = this.filteredDotKeKhais.filter(dot => 
      dot.nam === nam && dot.nguoi_tao === this.currentUser.username
    );
    if (dotKeKhaisInYear.length === 0) {
      return 1;
    }
    const maxSoDot = Math.max(...dotKeKhaisInYear.map(dot => dot.so_dot));
    return maxSoDot + 1;
  }

  showModal(data?: DotKeKhai): void {
    this.isEdit = !!data;
    
    // Tạm thởi hủy đăng ký sự kiện valueChanges của dai_ly_id để tránh gọi API nhiều lần
    const subscription = this.form.get('dai_ly_id')?.valueChanges.subscribe();
    if (subscription) {
      subscription.unsubscribe();
    }
    
    // Load danh sách đại lý trước
    this.loading = true;
    this.userService.getDaiLys().subscribe({
      next: (daiLyData) => {
        // Nếu user có donViCongTac, lọc theo đại lý của user
        if (this.currentUser.donViCongTac) {
          this.daiLys = daiLyData.filter(daiLy => daiLy.ma === this.currentUser.donViCongTac);
        } else {
          // Nếu không có donViCongTac, lấy tất cả đại lý
          this.daiLys = daiLyData;
        }
        
        if (data) {
          // Kiểm tra xem đại lý của đợt kê khai có tồn tại trong danh sách đại lý không
          const daiLyExists = this.daiLys.some(daiLy => daiLy.id === data.dai_ly_id);
          
          // Nếu không tồn tại và chỉ có một đại lý, sử dụng đại lý đó
          if (!daiLyExists && this.daiLys.length === 1) {
            data.dai_ly_id = this.daiLys[0].id;
          }
          
          // Disable các control khi cập nhật
          this.disableFormControls();
          
          // Đầu tiên, load danh sách đơn vị dựa trên đại lý của đợt kê khai
          this.donViService.getDonVisByDaiLy(data.dai_ly_id).subscribe({
            next: (donViData) => {
              this.donVis = donViData;
              
              // Sau khi có danh sách đơn vị, mới patch giá trị vào form
              this.form.patchValue({
                id: data.id,
                ten_dot: data.ten_dot,
                so_dot: data.so_dot,
                thang: data.thang,
                nam: data.nam,
                ghi_chu: data.ghi_chu,
                trang_thai: data.trang_thai,
                nguoi_tao: data.nguoi_tao,
                don_vi_id: data.don_vi_id,
                ma_ho_so: data.ma_ho_so,
                is_bien_lai_dien_tu: data.is_bien_lai_dien_tu,
                dai_ly_id: data.dai_ly_id
              }, { emitEvent: false });
              
              this.loading = false;
              this.isVisible = true;
              
              // Đăng ký lại sự kiện valueChanges của dai_ly_id sau khi đã cập nhật form
              this.form.get('dai_ly_id')?.valueChanges.subscribe(daiLyId => {
                if (daiLyId) {
                  // Reset giá trị đơn vị khi thay đổi đại lý
                  this.form.patchValue({ don_vi_id: null }, { emitEvent: false });
                  // Load danh sách đơn vị theo đại lý mới
                  this.loadDonVisByDaiLy(daiLyId);
                } else {
                  // Xóa danh sách đơn vị nếu không có đại lý
                  this.donVis = [];
                }
              });
            },
            error: (error) => {
              console.error('Lỗi khi tải danh sách đơn vị:', error);
              this.message.error('Có lỗi xảy ra khi tải danh sách đơn vị');
              this.loading = false;
            }
          });
        } else {
          // Enable lại các control khi thêm mới
          this.enableFormControls();
          
          this.form.reset({
            ten_dot: '',
            so_dot: 1,
            thang: new Date().getMonth() + 1,
            nam: new Date().getFullYear(),
            ghi_chu: '',
            trang_thai: 'chua_gui',
            nguoi_tao: this.currentUser.username || '',
            don_vi_id: null,
            ma_ho_so: '',
            is_bien_lai_dien_tu: true, // Tự động chọn sử dụng biên lai điện tử
            dai_ly_id: this.daiLys.length === 1 ? this.daiLys[0].id : null
          }, { emitEvent: false });
          
          // Nếu có đại lý được chọn, load danh sách đơn vị
          const daiLyId = this.form.get('dai_ly_id')?.value;
          if (daiLyId) {
            this.loadDonVisByDaiLy(daiLyId);
          }
          
          this.loading = false;
          this.isVisible = true;
          
          // Đăng ký lại sự kiện valueChanges của dai_ly_id sau khi đã cập nhật form
          this.form.get('dai_ly_id')?.valueChanges.subscribe(daiLyId => {
            if (daiLyId) {
              // Reset giá trị đơn vị khi thay đổi đại lý
              this.form.patchValue({ don_vi_id: null }, { emitEvent: false });
              // Load danh sách đơn vị theo đại lý mới
              this.loadDonVisByDaiLy(daiLyId);
            } else {
              // Xóa danh sách đơn vị nếu không có đại lý
              this.donVis = [];
            }
          });
        }
      },
      error: () => {
        this.message.error('Có lỗi xảy ra khi tải danh sách đại lý');
        this.loading = false;
      }
    });
  }

  handleCancel(): void {
    this.isVisible = false;
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const nextSoDot = this.getNextSoDot(currentYear);
    
    // Enable lại các controls
    this.enableFormControls();
    
    this.form.reset({ 
      so_dot: nextSoDot,
      thang: currentDate.getMonth() + 1,
      nam: currentYear,
      ghi_chu: '',
      trang_thai: 'chua_gui',
      nguoi_tao: this.currentUser.username || '',
      don_vi_id: null,
      ma_ho_so: '',
      is_bien_lai_dien_tu: false,
      dai_ly_id: this.daiLys.length === 1 ? this.daiLys[0].id : null
    }, { emitEvent: false });

    this.updateTenDot();
  }

  handleOk(): void {
    if (this.form.valid) {
      const formValue = this.form.getRawValue();
      
      // Kiểm tra đại lý trước khi tạo/cập nhật
      const daiLyId = formValue.dai_ly_id;
      if (daiLyId === undefined || daiLyId === null) {
        // Nếu đang cập nhật, lấy giá trị dai_ly_id từ đợt kê khai hiện tại
        if (this.isEdit && formValue.id) {
          const currentDotKeKhai = this.dotKeKhais.find(d => d.id === formValue.id);
          if (currentDotKeKhai && currentDotKeKhai.dai_ly_id) {
            formValue.dai_ly_id = currentDotKeKhai.dai_ly_id;
          } else if (this.daiLys.length === 1) {
            // Nếu chỉ có một đại lý, sử dụng đại lý đó
            formValue.dai_ly_id = this.daiLys[0].id;
          } else {
            // Nếu không tìm thấy đại lý, hiển thị thông báo lỗi
            this.message.error('Không tìm thấy thông tin đại lý. Vui lòng thử lại.');
            return;
          }
        } else if (this.daiLys.length === 1) {
          // Nếu chỉ có một đại lý, sử dụng đại lý đó
          formValue.dai_ly_id = this.daiLys[0].id;
        } else {
          // Nếu không tìm thấy đại lý, hiển thị thông báo lỗi
          this.message.error('Vui lòng chọn đại lý');
          return;
        }
      }
      
      // Kiểm tra đơn vị trước khi tạo/cập nhật
      const donViId = formValue.don_vi_id;
      const donVi = this.donVis.find(d => d.id === donViId);
      
      if (!donVi) {
        this.message.warning('Vui lòng chọn đơn vị');
        return;
      }

      if (!donVi.maSoBHXH) {
        this.modal.confirm({
          nzTitle: 'Cảnh báo',
          nzContent: 'Đơn vị chưa có mã số BHXH. Bạn có muốn tiếp tục?',
          nzOkText: 'Tiếp tục',
          nzCancelText: 'Hủy',
          nzOnOk: () => this.submitForm(formValue)
        });
      } else {
        this.submitForm(formValue);
      }
    } else {
      Object.values(this.form.controls).forEach(control => {
        if (control.invalid) {
          control.markAsTouched();
        }
      });
    }
  }

  private submitForm(formValue: any): void {
    // Đảm bảo dai_ly_id luôn có giá trị
    if (formValue.dai_ly_id === undefined || formValue.dai_ly_id === null) {
      // Nếu đang cập nhật, lấy giá trị dai_ly_id từ đợt kê khai hiện tại
      if (this.isEdit && formValue.id) {
        const currentDotKeKhai = this.dotKeKhais.find(d => d.id === formValue.id);
        if (currentDotKeKhai && currentDotKeKhai.dai_ly_id) {
          formValue.dai_ly_id = currentDotKeKhai.dai_ly_id;
        } else if (this.daiLys.length === 1) {
          // Nếu chỉ có một đại lý, sử dụng đại lý đó
          formValue.dai_ly_id = this.daiLys[0].id;
        } else {
          // Nếu không tìm thấy đại lý, hiển thị thông báo lỗi
          this.message.error('Không tìm thấy thông tin đại lý. Vui lòng thử lại.');
          return;
        }
      } else if (this.daiLys.length === 1) {
        // Nếu chỉ có một đại lý, sử dụng đại lý đó
        formValue.dai_ly_id = this.daiLys[0].id;
      } else {
        // Nếu không tìm thấy đại lý, hiển thị thông báo lỗi
        this.message.error('Vui lòng chọn đại lý');
        return;
      }
    }

    if (this.isEdit) {
      const updateData: UpdateDotKeKhai = {
        id: formValue.id,
        ten_dot: formValue.ten_dot,
        so_dot: formValue.so_dot,
        thang: formValue.thang,
        nam: formValue.nam,
        ghi_chu: formValue.ghi_chu,
        trang_thai: formValue.trang_thai,
        nguoi_tao: formValue.nguoi_tao,
        don_vi_id: formValue.don_vi_id,
        ma_ho_so: formValue.ma_ho_so,
        is_bien_lai_dien_tu: formValue.is_bien_lai_dien_tu,
        dai_ly_id: formValue.dai_ly_id
      };

      this.dotKeKhaiService.updateDotKeKhai(formValue.id, updateData).subscribe({
        next: () => {
          this.message.success('Cập nhật đợt kê khai thành công');
          this.isVisible = false;
          this.loadData();
        },
        error: (error) => {
          console.error('Lỗi khi cập nhật:', error);
          this.message.error('Có lỗi xảy ra khi cập nhật đợt kê khai');
        }
      });
    } else {
      const createData: CreateDotKeKhai = {
        ten_dot: formValue.ten_dot,
        so_dot: formValue.so_dot,
        thang: formValue.thang,
        nam: formValue.nam,
        ghi_chu: formValue.ghi_chu,
        trang_thai: formValue.trang_thai,
        nguoi_tao: formValue.nguoi_tao,
        don_vi_id: formValue.don_vi_id,
        ma_ho_so: formValue.ma_ho_so,
        is_bien_lai_dien_tu: formValue.is_bien_lai_dien_tu,
        dai_ly_id: formValue.dai_ly_id,
        dich_vu: formValue.dich_vu || 'BHYT' // Thêm trường dich_vu với giá trị mặc định là BHYT
      };

      this.dotKeKhaiService.createDotKeKhai(createData).subscribe({
        next: (response) => {
          this.message.success('Thêm mới đợt kê khai thành công');
          this.isVisible = false;
          this.loadData();
          
          // Chuyển hướng dựa trên loại dịch vụ
          if (response && response.id) {
            if (response.dich_vu === 'BHYT') {
              this.router.navigate(['/dot-ke-khai', response.id, 'ke-khai-bhyt']);
            } else if (response.dich_vu === 'BHXH TN') {
              this.router.navigate(['/dot-ke-khai', response.id, 'ke-khai-bhxh']);
            }
          }
        },
        error: (error) => {
          if (error.status === 400 && error.error?.message?.includes('unique constraint')) {
            // Nếu bị trùng, tự động lấy số đợt mới và thử lại
            this.updateSoDot();
            this.message.warning('Đã tự động tăng số đợt do trùng lặp');
          } else {
            this.message.error('Có lỗi xảy ra khi thêm mới đợt kê khai');
          }
        }
      });
    }
  }

  delete(id: number | undefined): void {
    if (!id) return;
    
    this.modal.confirm({
      nzTitle: 'Xác nhận xóa',
      nzContent: 'Bạn có chắc chắn muốn xóa đợt kê khai này?',
      nzOkText: 'Xóa',
      nzOkType: 'primary',
      nzOkDanger: true,
      nzOnOk: () => {
        this.dotKeKhaiService.deleteDotKeKhai(id).subscribe({
          next: () => {
            this.message.success('Xóa thành công');
          },
          error: () => this.message.error('Có lỗi xảy ra khi xóa')
        });
      }
    });
  }

  getCheckedStatus(data: DotKeKhai): boolean {
    return this.checkedSet.has(data.id!);
  }

  onItemChecked(checked: boolean, data: DotKeKhai): void {
    if (checked) {
      this.checkedSet.add(data.id!);
    } else {
      this.checkedSet.delete(data.id!);
    }
    this.updateSelectedIds();
  }

  updateSelectedIds(): void {
    this.selectedIds = Array.from(this.checkedSet);
    this.isAllChecked = this.selectedIds.length === this.filteredDotKeKhais.length;
    this.isIndeterminate = this.selectedIds.length > 0 && this.selectedIds.length < this.filteredDotKeKhais.length;
  }

  onAllChecked(checked: boolean): void {
    this.isAllChecked = checked;
    this.filteredDotKeKhais.forEach(item => {
      if (checked) {
        this.checkedSet.add(item.id!);
      } else {
        this.checkedSet.delete(item.id!);
      }
    });
    this.updateSelectedIds();
  }

  deleteSelected(): void {
    if (this.selectedIds.length === 0) {
      this.message.warning('Vui lòng chọn ít nhất một đợt kê khai để xóa');
      return;
    }

    this.modal.confirm({
      nzTitle: 'Xác nhận xóa',
      nzContent: `Bạn có chắc chắn muốn xóa ${this.selectedIds.length} đợt kê khai đã chọn?`,
      nzOkText: 'Xóa',
      nzOkType: 'primary',
      nzOkDanger: true,
      nzOnOk: () => {
        const deletePromises = this.selectedIds.map(id =>
          this.dotKeKhaiService.deleteDotKeKhai(id).toPromise()
        );

        Promise.all(deletePromises)
          .then(() => {
            this.message.success('Xóa thành công');
            this.selectedIds = [];
            this.loadData();
          })
          .catch(() => {
            this.message.error('Có lỗi xảy ra khi xóa');
          });
      }
    });
  }

  onRowClick(data: DotKeKhai): void {
    if (data.dich_vu === 'BHYT') {
      this.router.navigate(['/dot-ke-khai', data.id, 'ke-khai-bhyt']);
    } else if (data.dich_vu === 'BHXH TN') {
      this.router.navigate(['/dot-ke-khai', data.id, 'ke-khai-bhxh']);
    }
  }

  getTagColor(trangThai: string): string {
    const colors: Record<string, string> = {
      'chua_gui': 'default',
      'da_gui': 'processing',
      'dang_xu_ly': 'cyan',
      'cho_thanh_toan': 'warning', 
      'hoan_thanh': 'success',
      'tu_choi': 'error'
    };
    return colors[trangThai] || 'default';
  }

  getTagText(trangThai: string): string {
    const texts: Record<string, string> = {
      'chua_gui': 'Chưa gửi',
      'da_gui': 'Đã gửi',
      'dang_xu_ly': 'Đang xử lý',
      'cho_thanh_toan': 'Chờ thanh toán',
      'hoan_thanh': 'Hoàn thành', 
      'tu_choi': 'Từ chối'
    };
    return texts[trangThai] || trangThai;
  }

  getCounts(trangThai: string): number {
    return this.dotKeKhais.filter(item => item.trang_thai === trangThai).length;
  }

  getTotalDotKeKhai(): number {
    return this.dotKeKhais.length;
  }

  getDonViName(donViId: number): string {
    const donVi = this.donVis.find(d => d.id === donViId);
    return donVi ? donVi.tenDonVi : '';
  }

  getDaiLyName(daiLyId: number): string {
    const daiLy = this.daiLys.find(d => d.id === daiLyId);
    return daiLy ? daiLy.ten : '';
  }

  getTotalAmount(): number {
    if (!this.filteredDotKeKhais) return 0;
    return this.filteredDotKeKhais.reduce((total, dot) => {
      const amount = dot.tong_so_tien || 0;
      return total + amount;
    }, 0);
  }

  showThanhToanModal(data: DotKeKhai): void {
    // Kiểm tra nếu không phải trạng thái chờ thanh toán
    if (data.trang_thai !== 'cho_thanh_toan') {
      this.message.warning('Đợt kê khai này không ở trạng thái chờ thanh toán');
      return;
    }

    // Kiểm tra và load thông tin đơn vị nếu cần
    if (!this.donVis.length) {
      this.loadDonVisByDaiLy(data.dai_ly_id);
    }

    // Lấy thông tin đợt kê khai với đầy đủ thông tin đơn vị
    this.loading = true;
    this.dotKeKhaiService.getDotKeKhai(data.id!).subscribe({
      next: (dotKeKhai) => {
        this.loading = false;
        
        // Kiểm tra thông tin đơn vị từ cache trước
        const donVi = this.donVis.find(d => d.id === dotKeKhai.don_vi_id);
        if (!donVi) {
          // Nếu không có trong cache, load lại danh sách đơn vị
          this.loadDonVisByDaiLy(dotKeKhai.dai_ly_id);
          this.message.warning('Đang tải lại thông tin đơn vị, vui lòng thử lại sau');
          return;
        }

        if (!donVi.maSoBHXH) {
          this.message.warning('Đơn vị chưa có mã số BHXH');
          return;
        }

        // Mở modal thanh toán
        const modalRef = this.modal.create({
          nzTitle: 'QR Thanh toán',
          nzContent: ThanhToanModalComponent,
          nzWidth: 800,
          nzData: {
            dotKeKhai: {
              ...dotKeKhai,
              DonVi: donVi // Gán thông tin đơn vị từ cache
            }
          },
          nzFooter: null,
          nzClosable: true,
          nzMaskClosable: false,
          nzClassName: 'thanh-toan-modal'
        });

        // Subscribe để nhận kết quả từ modal
        modalRef.afterClose.subscribe(result => {
          if (result) {
            // Đóng modal xem hóa đơn nếu đang mở
            if (this.isViewBillModalVisible) {
              this.handleViewBillModalCancel();
            }
            // Tải lại dữ liệu
            this.loadData();
          }
        });
      },
      error: (error) => {
        this.loading = false;
        console.error('Lỗi khi lấy thông tin đợt kê khai:', error);
        this.message.error('Có lỗi xảy ra khi lấy thông tin đợt kê khai');
      }
    });
  }

  // Thêm hàm chuyển đổi phương án đóng
  getPhuongAnDongText(phuongAnDong: string): string {
    const phuongAnDongMap: Record<string, string> = {
      'dao_han': 'ON',
      'tang_moi': 'TM',
      'dung_dong': 'GH'
    };
    return phuongAnDongMap[phuongAnDong] || '';
  }

  exportData(data: DotKeKhai): void {
    if (!data || !data.id) {
      this.message.warning('Không tìm thấy thông tin đợt kê khai');
      return;
    }

    if (data.dich_vu !== 'BHYT') {
      this.message.warning('Chỉ hỗ trợ xuất dữ liệu kê khai BHYT');
      return;
    }

    const dotKeKhaiId = data.id;

    // Lấy thông tin user từ service
    this.userService.getCurrentUserInfo().subscribe({
      next: (user) => {
        const maNhanVien = user.maNhanVien || '';
        this.loading = true;
        this.dotKeKhaiService.getKeKhaiBHYTsByDotKeKhaiId(dotKeKhaiId).subscribe({
          next: (keKhaiBHYTs: any[]) => {
            console.log('Dữ liệu từ API:', keKhaiBHYTs);

            // Sắp xếp dữ liệu theo số biên lai tăng dần
            keKhaiBHYTs.sort((a, b) => {
              // Nếu một trong hai bản ghi không có số biên lai, đặt nó ở cuối
              if (!a.so_bien_lai && !b.so_bien_lai) return 0;
              if (!a.so_bien_lai) return 1;
              if (!b.so_bien_lai) return -1;
              
              // Nếu cùng quyển biên lai, so sánh số biên lai
              if (a.QuyenBienLai?.quyen_so === b.QuyenBienLai?.quyen_so) {
                return parseInt(a.so_bien_lai) - parseInt(b.so_bien_lai);
              }
              
              // Nếu khác quyển biên lai, so sánh quyển biên lai
              return (a.QuyenBienLai?.quyen_so || '').localeCompare(b.QuyenBienLai?.quyen_so || '');
            });
            
            // Cập nhật lại STT sau khi sắp xếp
            keKhaiBHYTs = keKhaiBHYTs.map((item, index) => ({
              ...item,
              stt: index + 1
            }));

            // In ra console để kiểm tra dữ liệu sau khi sắp xếp
            console.log('Dữ liệu sau khi sắp xếp theo số biên lai:', keKhaiBHYTs.map(item => ({
              stt: item.stt,
              ngay_tao: item.ngay_tao,
              ho_ten: item.ho_ten,
              so_bien_lai: item.so_bien_lai || 'N/A',
              quyen_so: item.QuyenBienLai?.quyen_so || 'N/A'
            })));

            // Chuẩn bị dữ liệu cho sheet danh sách kê khai
            const keKhaiHeaders = [
              'STT', // Cột A - Số thứ tự
              'HoTen', // Cột B - Họ tên người tham gia
              'MasoBHXH', // Cột C - Mã số BHXH
              'MaPhongBan', // Cột D - Mã phòng ban (để trống)
              'Loai', // Cột E - Loại (mặc định là 1)
              'PA', // Cột F - Phương án đóng (ON/TM/GH)
              'TyleNSDP', // Cột G - Tỷ lệ NSDP (để trống)
              'NgayBienLai', // Cột H - Ngày biên lai
              'SoBienLai', // Cột I - Số biên lai (để trống)
              'NguoiThamGiaThu', // Cột J - Người thu
              'Tiendong', // Cột K - Tiền đóng (mặc định 2,340,000)
              'TienDongThucTe', // Cột L - Tiền đóng thực tế (để trống)
              'MucHuong', // Cột M - Mức hưởng (mặc định là 4)
              'TuNgay', // Cột N - Từ ngày (để trống)
              'NgayChet', // Cột O - Ngày chết (để trống)
              'HotroKhac', // Cột P - Hỗ trợ khác (để trống)
              'TenTinhDangSS', // Cột Q - Tên tỉnh đăng ký (để trống)
              'Matinh_DangSS', // Cột R - Mã tỉnh đăng ký
              'Tenhuyen_DangSS', // Cột S - Tên huyện đăng ký
              'Mahuyen_DangSS', // Cột T - Mã huyện đăng ký
              'TenxaDangSS', // Cột U - Tên xã đăng ký
              'Maxa_DangSS', // Cột V - Mã xã đăng ký
              'Diachi_DangSS', // Cột W - Địa chỉ đăng ký
              'Sothang', // Cột X - Số tháng đóng
              'Ghichu', // Cột Y - Ghi chú (để trống)
              'NgaySinh', // Cột Z - Ngày sinh
              'GioiTinh', // Cột AA - Giới tính
              'TenTinhBenhVien', // Cột AB - Tên tỉnh bệnh viện (để trống)
              'MaTinhBenhVien', // Cột AC - Mã tỉnh nơi khám quyết định
              'TenBenhVien', // Cột AD - Tên bệnh viện (để trống)
              'MaBenhVien', // Cột AE - Mã bệnh viện
              'MavungSS', // Cột AF - Mã vùng (để trống)
              'Tk1_Save', // Cột AG - TK1 Save (để trống)
              'CMND', // Cột AH - CCCD
              'Maho_Giadinh', // Cột AI - Mã hộ gia đình
              '', // Cột AJ - Để trống
              'QuocTich', // Cột AK - Quốc tịch
              '', // Cột AL - Để trống
              '', // Cột AM - Để trống
              'TenTinhKS', // Cột AN - Tên tỉnh khai sinh (để trống)
              'MaTinh_KS', // Cột AO - Mã tỉnh khai sinh
              'TenHuyenKS', // Cột AP - Tên huyện khai sinh (để trống)
              'MaHuyen_KS', // Cột AQ - Mã huyện khai sinh
              'TenXaKS', // Cột AR - Tên xã khai sinh (để trống)
              'MaXa_KS', // Cột AS - Mã xã khai sinh
              'TenTinhNN', // Cột AT - Tên tỉnh nơi khám (để trống)
              'Matinh_NN', // Cột AU - Mã tỉnh nơi khám quyết định
              'TenHuyenNN', // Cột AV - Tên huyện nơi khám (để trống)
              'Mahuyen_NN', // Cột AW - Mã huyện nơi khám quyết định
              'TenXaNN', // Cột AX - Tên xã nơi khám (để trống)
              'Maxa_NN', // Cột AY - Mã xã nơi khám quyết định
              'Diachi_NN', // Cột AZ - Địa chỉ nơi khám quyết định
              '', // Cột BA - Để trống
              '', // Cột BB - Để trống
              '', // Cột BC - Để trống
              '', // Cột BD - Để trống
              '', // Cột BE - Để trống
              '', // Cột BF - Để trống
              '', // Cột BG - Để trống
              '', // Cột BH - Để trống
              'SoCCCD', // Cột BI - Số CCCD
              'SoBienLai', // Cột BJ - Số biên lai
              'NgayBienLai', // Cột BK - Ngày biên lai
              'MaNhanvienThu', // Cột BL - Mã nhân viên thu
            ];

            // Thêm 2 dòng trống trước header
            const emptyRows = [
              Array(13).fill(''),  // Dòng 1 trống với 13 cột
              Array(13).fill('')   // Dòng 2 trống với 13 cột
            ];
            
            const keKhaiData = keKhaiBHYTs.map((item: any) => [
              item.stt, // Sử dụng STT từ API
              item.ho_ten,
              item.ma_so_bhxh || '', 
              maNhanVien, // Sử dụng mã nhân viên từ API
              '1', // Cột E giá trị mặc định là 1
              this.getPhuongAnDongText(item.phuong_an_dong || ''),
              '', // Cột G trống
              item.ngay_bien_lai ? new Date(item.ngay_bien_lai).toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
              }) : '',
              item.so_bien_lai ? (item.QuyenBienLai ? 
                `${item.QuyenBienLai.quyen_so}${item.so_bien_lai.padStart(5, '0')}` : 
                item.so_bien_lai
              ) : '',
              typeof item.nguoi_thu !== 'undefined' ? item.nguoi_thu.toString() : '',
              '2340000', // Cột K - Tiendong - giá trị mặc định không có dấu phẩy
              '0', // Cột L - giá trị mặc định là 0
              '4', // Cột M giá trị mặc định là 4
              item.han_the_moi_tu ? new Date(item.han_the_moi_tu).toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
              }) : '', // Cột N hiển thị Hạn thẻ mới từ
              '', // Cột O trống
              '', // Cột P trống
              '', // Cột Q trống
              item.ma_tinh_nkq || '', // Cột R - Mã tỉnh
              '', // Cột S - Tên huyện (trống)
              item.ma_huyen_nkq || '', // Cột T - Mã huyện
              '', // Cột U - Tên xã (trống)
              item.ma_xa_nkq || '', // Cột V - Mã xã
              item.dia_chi_nkq || '', // Cột W - Địa chỉ
              item.so_thang_dong?.toString() || '', // Cột X hiển thị số tháng đóng
              // Cột Y - Thêm "nghỉ học" nếu người tham gia có tuổi nhỏ hơn 18
              this.isUnder18(item.ngay_sinh) ? 'Nghỉ học' : (item.is_urgent ? 'Thẻ Gấp' : ''),
              item.ngay_sinh ? new Date(item.ngay_sinh).toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
              }) : '', // Cột Z hiển thị ngày sinh
              this.getGioiTinhValue(item.gioi_tinh), // Cột AA hiển thị giới tính
              '', // Cột AB trống
              item.ma_tinh_nkq || '', // Cột AC hiển thị mã tỉnh nơi khám quyết định
              '', // Cột AD trống
              item.ma_benh_vien || '', // Cột AE hiển thị mã bệnh viện
              '', // Cột AF trống
              'x', // Cột AG giá trị mặc định là x
              item.cccd || '', // Cột AH hiển thị CCCD
              item.ma_hgd || '', // Cột AI hiển thị mã hộ gia đình
              '', // Cột AJ trống
              item.quoc_tich || 'VN', // Cột AK hiển thị quốc tịch, mặc định là VN
              '', // Cột AL trống
              '', // Cột AM trống
              '', // Cột AN trống
              item.ma_tinh_ks || '', // Cột AO hiển thị mã tỉnh khai sinh
              '', // Cột AP trống
              item.ma_huyen_ks || '', // Cột AQ hiển thị mã huyện khai sinh
              '', // Cột AR trống
              item.ma_xa_ks || '', // Cột AS hiển thị mã xã khai sinh
              '', // Cột AT trống
              item.ma_tinh_nkq || '', // Cột AU hiển thị mã tỉnh nơi khám quyết định
              '', // Cột AV trống
              item.ma_huyen_nkq || '', // Cột AW hiển thị mã huyện nơi khám quyết định
              '', // Cột AX trống
              item.ma_xa_nkq || '', // Cột AY hiển thị mã xã nơi khám quyết định
              item.dia_chi_nkq || '', // Cột AZ hiển thị địa chỉ nơi khám quyết định
              '', // Cột BA trống
              '', // Cột BB trống
              '', // Cột BC trống
              '', // Cột BD trống
              '', // Cột BE trống
              '', // Cột BF trống
              '', // Cột BG trống
              '', // Cột BH trống
              item.cccd || '', // Cột BI hiển thị CCCD
              item.so_bien_lai ? (item.QuyenBienLai ? 
                `${item.QuyenBienLai.quyen_so}${item.so_bien_lai.padStart(5, '0')}` : 
                item.so_bien_lai
              ) : '', // Cột BJ - Số biên lai
              item.ngay_bien_lai ? new Date(item.ngay_bien_lai).toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
              }) : '', // Cột BK - Ngày biên lai
              item.ma_nhan_vien || '', // Cột BL - Mã nhân viên thu từ API
            ]);

            // Tạo workbook và thêm sheet danh sách kê khai
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([...emptyRows, keKhaiHeaders, ...keKhaiData]);
            XLSX.utils.book_append_sheet(wb, ws, 'Dữ Liệu');

            // Tạo style cho sheet
            ws['!cols'] = [
              { wch: 8 },  // STT
              { wch: 30 }, // HoTen  
              { wch: 15 }, // Mã số BHXH
              { wch: 10 }, // Cột D trống
              { wch: 10 }, // Cột E trống
              { wch: 15 }, // Phương án đóng
              { wch: 10 }, // Cột G trống 
              { wch: 15 }, // Ngày biên lai
              { wch: 10 }, // Cột I trống
              { wch: 15 }, // Người thứ
              { wch: 15 }, // Cột K
              { wch: 10 }, // Cột L
              { wch: 10 }, // Cột M
              { wch: 10 }, // Cột N trống
              { wch: 10 }, // Cột O trống
              { wch: 10 }, // Cột P trống
              { wch: 10 }, // Cột Q trống
              { wch: 15 }, // Cột R trống
              { wch: 10 }, // Cột S trống
              { wch: 15 }, // Cột T trống
              { wch: 10 }, // Cột U trống
              { wch: 50 }, // Cột V Diachi_DangSS
              { wch: 10 }, // Cột W trống
              { wch: 15 }, // Cột X Sothang
              { wch: 10 }, // Cột Y trống
              { wch: 15 }, // Cột Z NgaySinh
              { wch: 10 }, // Cột AA GioiTinh
              { wch: 10 }, // Cột AB trống
              { wch: 15 }, // Cột AC trống
              { wch: 10 }, // Cột AD trống
              { wch: 15 }, // Cột AE trống
              { wch: 10 }, // Cột AF trống
              { wch: 10 }, // Cột AG trống
              { wch: 15 }, // Cột AH trống
              { wch: 15 }, // Cột AI trống
              { wch: 15 }, // Cột AK trống
              { wch: 10 }, // Cột AL trống
              { wch: 10 }, // Cột AM trống
              { wch: 10 }, // Cột AN trống
              { wch: 15 }, // Cột AO trống
              { wch: 10 }, // Cột AP trống
              { wch: 15 }, // Cột AQ trống
              { wch: 10 }, // Cột AR trống
              { wch: 15 }, // Cột AS trống
              { wch: 10 }, // Cột AT trống
              { wch: 15 }, // Cột AU trống
              { wch: 10 }, // Cột AV trống
              { wch: 15 }, // Cột AW trống
              { wch: 10 }, // Cột AX trống
              { wch: 15 }, // Cột AY trống
              { wch: 50 }, // Cột AZ DiaChi_DangSS
              { wch: 10 }, // Cột BA trống
              { wch: 10 }, // Cột BB trống
              { wch: 10 }, // Cột BC trống
              { wch: 10 }, // Cột BD trống
              { wch: 10 }, // Cột BE trống
              { wch: 10 }, // Cột BF trống
              { wch: 10 }, // Cột BG trống
              { wch: 10 }, // Cột BH trống
              { wch: 15 }, // Cột BI trống
              { wch: 15 }, // Cột BJ trống
              { wch: 15 }, // Cột BK trống
              { wch: 15 }, // Cột BL trống
            ];

            // Xuất file Excel
            XLSX.writeFile(wb, `ke-khai-bhyt-${data.ten_dot.toLowerCase().replace(/\s+/g, '-')}.xlsx`);
            
            this.message.success('Xuất dữ liệu kê khai BHYT thành công');
            this.loading = false;
          },
          error: (error: any) => {
            console.error('Lỗi khi lấy dữ liệu kê khai BHYT:', error);
            if (error.status === 404) {
              this.message.error(`Không tìm thấy đợt kê khai có ID: ${data.id}`);
            } else {
              this.message.error('Có lỗi xảy ra khi xuất dữ liệu kê khai BHYT');
            }
            this.loading = false;
          }
        });
      },
      error: (error) => {
        console.error('Lỗi khi lấy thông tin người dùng:', error);
        this.message.error('Có lỗi xảy ra khi lấy thông tin người dùng');
        this.loading = false;
      }
    });
  }

  // Thêm hàm chuyển đổi giới tính
  getGioiTinhValue(gioiTinh: string): string {
    return gioiTinh?.toLowerCase() === 'nam' ? '1' : '0';
  }

  // Thêm hàm kiểm tra tuổi
  isUnder18(ngaySinh: string | Date | null | undefined): boolean {
    if (!ngaySinh) return false;
    
    const birthDate = new Date(ngaySinh);
    const today = new Date();
    
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    // Nếu chưa tới tháng sinh nhật hoặc tới tháng sinh nhật nhưng chưa tới ngày sinh nhật
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    
    return age < 18;
  }

  showViewBillModal(url: string): void {
    // Tìm đợt kê khai tương ứng với hóa đơn này
    const dotKeKhai = this.dotKeKhais.find(d => d.url_bill === url);
    
    this.selectedBillUrl = url;
    this.selectedDotKeKhai = dotKeKhai || null;
    this.isViewBillModalVisible = true;
    
    // Reset các giá trị zoom và xoay
    this.zoomLevel = 1;
    this.rotationDegree = 0;
  }

  handleViewBillModalCancel(): void {
    this.isViewBillModalVisible = false;
    this.selectedBillUrl = '';
    this.selectedDotKeKhai = null;
    this.zoomLevel = 1;
    this.rotationDegree = 0;
  }
  
  // Thêm các phương thức mới cho modal xem hóa đơn
  zoomIn(): void {
    if (this.zoomLevel < 3) {
      this.zoomLevel += 0.1;
    }
  }
  
  zoomOut(): void {
    if (this.zoomLevel > 0.5) {
      this.zoomLevel -= 0.1;
    }
  }
  
  resetZoom(): void {
    this.zoomLevel = 1;
    this.rotationDegree = 0;
  }
  
  rotateLeft(): void {
    this.rotationDegree = (this.rotationDegree - 90) % 360;
  }
  
  rotateRight(): void {
    this.rotationDegree = (this.rotationDegree + 90) % 360;
  }
  
  downloadBill(): void {
    if (!this.selectedBillUrl) {
      this.message.error('Không có hình ảnh hóa đơn để tải xuống');
      return;
    }
    
    if (!this.selectedDotKeKhai) {
      this.message.error('Không có thông tin đợt kê khai');
      return;
    }
    
    // Lấy mã hồ sơ và mã nhân viên
    const maHoSo = this.selectedDotKeKhai.ma_ho_so || 'unknown';
    const maNhanVien = this.currentUser.username || 'unknown';
    
    // Tạo một thẻ a ẩn để tải xuống hình ảnh
    const link = document.createElement('a');
    link.href = this.selectedBillUrl;
    link.download = `${maHoSo}_${maNhanVien}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    this.message.success('Đang tải xuống hóa đơn');
  }

  downloadAllBills(): void {
    // Lấy danh sách các đợt kê khai đã chọn
    const selectedDotKeKhais = this.dotKeKhais.filter(item => this.checkedSet.has(item.id!));
    
    // Kiểm tra nếu không có đợt kê khai nào được chọn
    if (selectedDotKeKhais.length === 0) {
      this.message.warning('Vui lòng chọn ít nhất một đợt kê khai có hóa đơn');
      return;
    }
    
    // Lọc các đợt kê khai có hóa đơn
    const dotKeKhaisWithBill = selectedDotKeKhais.filter(item => item.url_bill);
    
    if (dotKeKhaisWithBill.length === 0) {
      this.message.warning('Không có hóa đơn nào trong các đợt kê khai đã chọn');
      return;
    }
    
    // Hiển thị thông báo đang tải
    const loadingMessageId = this.message.loading(`Đang chuẩn bị tải ${dotKeKhaisWithBill.length} hóa đơn...`, { nzDuration: 0 }).messageId;
    
    // Lấy mã nhân viên
    const maNhanVien = this.currentUser.username || 'unknown';
    
    // Tạo một mảng để lưu trữ các blob của ảnh
    const imageBlobs: { fileName: string, blob: Blob }[] = [];
    
    // Hàm tải ảnh từ URL
    const downloadImage = (dotKeKhai: DotKeKhai) => {
      return new Promise<void>((resolve, reject) => {
        if (!dotKeKhai.url_bill) {
          resolve();
          return;
        }
        
        // Tải ảnh từ URL
        fetch(dotKeKhai.url_bill)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Không thể tải ảnh: ${response.statusText}`);
            }
            return response.blob();
          })
          .then(blob => {
            // Lấy mã hồ sơ và đảm bảo không có ký tự đặc biệt
            const maHoSo = (dotKeKhai.ma_ho_so || 'unknown').replace(/[\/\\:*?"<>|]/g, '_');
            
            // Tạo tên file theo cú pháp "mã hồ sơ_mã nhân viên.jpg"
            // Đảm bảo không có ký tự đặc biệt trong tên file
            const fileName = `${maHoSo}_${maNhanVien.replace(/[\/\\:*?"<>|]/g, '_')}.jpg`;
            
            // Thêm vào mảng imageBlobs
            imageBlobs.push({ fileName, blob });
            
            resolve();
          })
          .catch(error => {
            console.error(`Lỗi khi tải ảnh cho đợt kê khai ${dotKeKhai.id}:`, error);
            reject(error);
          });
      });
    };
    
    // Tải tất cả ảnh
    const downloadPromises = dotKeKhaisWithBill.map(dotKeKhai => downloadImage(dotKeKhai));
    
    Promise.all(downloadPromises)
      .then(() => {
        try {
          // Tạo file ZIP mới
          const zip = new JSZip();
          
          // Thêm các ảnh vào ZIP
          imageBlobs.forEach(item => {
            // Đảm bảo tên file không chứa đường dẫn
            const simpleName = item.fileName.split(/[\/\\]/).pop() || item.fileName;
            zip.file(simpleName, item.blob);
          });
          
          // Tạo file ZIP
          return zip.generateAsync({ 
            type: 'blob',
            compression: 'DEFLATE',
            compressionOptions: { level: 9 }
          });
        } catch (error) {
          throw error;
        }
      })
      .then(content => {
        // Tải xuống file ZIP
        saveAs(content, `hoa-don.zip`);
        
        // Đóng thông báo loading và hiển thị thông báo thành công
        this.message.remove(loadingMessageId);
        this.message.success(`Đã tải xuống ${imageBlobs.length} hóa đơn thành công`);
      })
      .catch(error => {
        // Đóng thông báo loading và hiển thị thông báo lỗi
        this.message.remove(loadingMessageId);
        console.error('Lỗi khi tạo file ZIP:', error);
        this.message.error('Có lỗi xảy ra khi tải xuống hóa đơn');
      });
  }

  getSelectedBillCount(): number {
    // Lấy danh sách các đợt kê khai đã chọn
    const selectedDotKeKhais = this.dotKeKhais.filter(item => this.checkedSet.has(item.id!));
    
    // Đếm số lượng đợt kê khai có hóa đơn
    return selectedDotKeKhais.filter(item => item.url_bill).length;
  }

  guiDotKeKhai(data: DotKeKhai): void {
    // Kiểm tra cả hai thuộc tính liên quan đến biên lai điện tử
    console.log('Đợt kê khai cần gửi:', data);
    const useBienLaiDienTu = !!(data.is_bien_lai_dien_tu || data.bien_lai_dien_tu);
    console.log('Sử dụng biên lai điện tử:', useBienLaiDienTu);
    
    // Cập nhật biến willUseBienLaiDienTu để hiển thị thông báo trong modal
    this.willUseBienLaiDienTu = useBienLaiDienTu;
    
    // Hiển thị modal xác nhận gửi đợt kê khai
    this.modal.confirm({
      nzTitle: 'Xác nhận gửi',
      nzContent: this.modalGuiDotKeKhaiTpl,
      nzOkText: 'Gửi',
      nzOkType: 'primary',
      nzOnOk: () => {
        this.loading = true;
        this.dotKeKhaiService.guiDotKeKhai(data.id!, useBienLaiDienTu).subscribe({
          next: () => {
            if (useBienLaiDienTu) {
              this.message.success('Gửi đợt kê khai thành công với biên lai điện tử');
            } else {
              this.message.success('Gửi đợt kê khai thành công');
            }
            this.loading = false;
            this.loadData(); // Tải lại dữ liệu sau khi gửi thành công
          },
          error: (error) => {
            console.error('Lỗi khi gửi đợt kê khai:', error);
            // Hiển thị thông báo lỗi từ server nếu có
            if (error.error && error.error.message) {
              this.message.error(error.error.message);
            } else {
              this.message.error('Có lỗi xảy ra khi gửi đợt kê khai');
            }
            this.loading = false;
          }
        });
      }
    });
  }

  // Thêm hàm loadDonVisByDaiLy
  loadDonVisByDaiLy(daiLyId?: number): void {
    this.isLoadingDonVis = true;
    
    if (!daiLyId) {
      this.donVis = [];
      this.isLoadingDonVis = false;
      return;
    }

    // Gọi service method đã được tối ưu hóa với caching
    this.donViService.getDonVisByDaiLy(daiLyId).subscribe({
      next: (donVis) => {
        this.donVis = donVis;
        
        // Kiểm tra nếu có đơn vị nào không có mã số BHXH thì hiển thị cảnh báo
        const donVisWithoutMaSoBHXH = donVis.filter(donVi => !donVi.maSoBHXH);
        if (donVisWithoutMaSoBHXH.length > 0) {
          console.warn('Có đơn vị không có mã số BHXH:', donVisWithoutMaSoBHXH);
        }
        
        // Nếu đợt kê khai đã có đơn vị, thì chọn đơn vị đó
        if (this.dotKeKhai && this.dotKeKhai.don_vi_id) {
          const donVi = this.donVis.find(dv => dv.id === this.dotKeKhai.don_vi_id);
          if (donVi) {
            this.donViSelected = donVi;
            this.dotKeKhaiForm.patchValue({
              don_vi_id: donVi.id
            });
          }
        }
        
        this.isLoadingDonVis = false;
      },
      error: (error) => {
        console.error('Lỗi khi tải danh sách đơn vị:', error);
        this.isLoadingDonVis = false;
      }
    });
  }

  // Thêm hàm để disable form controls
  private disableFormControls(): void {
    this.form.get('so_dot')?.disable();
    this.form.get('thang')?.disable();
    this.form.get('nam')?.disable();
    this.form.get('dai_ly_id')?.disable();
    this.form.get('ten_dot')?.disable();
  }

  // Thêm hàm để enable form controls
  private enableFormControls(): void {
    this.form.get('so_dot')?.enable();
    this.form.get('thang')?.enable();
    this.form.get('nam')?.enable();
    this.form.get('dai_ly_id')?.enable();
    this.form.get('ten_dot')?.disable(); // ten_dot luôn bị disable
  }

  // Sửa lại hàm loadDonVis
  loadDonVis(): void {
    // Nếu có đại lý được chọn, load đơn vị theo đại lý đó
    const daiLyId = this.form.get('dai_ly_id')?.value;
    if (daiLyId) {
      this.loadDonVisByDaiLy(daiLyId);
    }
  }

  // Hàm xuất BHXH VNPT
  exportBHXHVNPT(data: DotKeKhai): void {
    if (!data || !data.id) {
      this.message.error('Không tìm thấy thông tin đợt kê khai');
      return;
    }
    
    this.loading = true;
    this.message.loading('Đang xuất dữ liệu BHXH VNPT...', { nzDuration: 0 });
    
    // Gọi API để lấy dữ liệu BHXH của đợt kê khai này
    this.http.get(`${this.apiUrl}/${data.id}/ke-khai-bhxh-export-vnpt`, { 
      responseType: 'blob' 
    }).subscribe({
      next: (blob: Blob) => {
        // Tạo tên file dựa trên thông tin đợt kê khai
        const fileName = `BHXH_VNPT_${data.ten_dot?.replace(/\s+/g, '_')}_${new Date().getTime()}.xlsx`;
        
        // Sử dụng file-saver để lưu file
        saveAs(blob, fileName);
        
        this.message.remove();
        this.message.success('Đã xuất dữ liệu BHXH VNPT thành công');
        this.loading = false;
      },
      error: (error) => {
        console.error('Lỗi khi xuất dữ liệu BHXH VNPT:', error);
        this.message.remove();
        this.message.error('Có lỗi xảy ra khi xuất dữ liệu BHXH VNPT');
        this.loading = false;
      }
    });
  }
}
````

## File: WebApp.Client/src/app/ke-khai/ke-khai-bhxh/ke-khai-bhxh.component.html
````html
<div class="ke-khai-bhxh-container">
  <nz-card class="form-card fade-in" [nzExtra]="extraTemplate" nzTitle="Kê khai bảo hiểm xã hội tự nguyện">
    <ng-template #extraTemplate>
      <div class="card-actions">
        <button nz-button nzType="default" class="mr-2 ripple" nzTooltip="Làm mới form" (click)="resetForm()">
          <span nz-icon nzType="clear" nzTheme="outline"></span>Làm mới
        </button>
        <button nz-button nzType="primary" class="ripple" nzTooltip="Lưu thông tin kê khai" (click)="saveKeKhaiBHXH()">
          <span nz-icon nzType="save" nzTheme="outline"></span>Lưu thông tin
        </button>
      </div>
    </ng-template>
    <form nz-form [formGroup]="form">
      <div nz-row [nzGutter]="{ xs: 8, sm: 16, md: 24 }">
        <!-- Hàng 1 -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Mã số BHXH</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mã số BHXH (tối đa 10 số)">
              <div class="custom-input-group">
                <input nz-input 
                  formControlName="ma_so_bhxh" 
                  placeholder="Nhập mã số BHXH" 
                  maxlength="10"
                  (keypress)="onlyNumber($event)"
                  (keyup)="onKeyUp($event)" />
                <button nz-button nzType="primary" class="pulse" nzTooltip="Tìm kiếm thông tin BHXH" (click)="searchBHXH()">
                  <span nz-icon nzType="search"></span>
                </button>
              </div>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>CCCD</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập CCCD (12 số)">
              <div class="custom-input-group">
                <input nz-input 
                  formControlName="cccd" 
                  placeholder="Nhập CCCD" 
                  maxlength="12"
                  (keypress)="onlyNumber($event)" />
                <button nz-button nzType="primary" nzTooltip="Quét CCCD">
                  <span nz-icon nzType="idcard" nzTheme="outline"></span>
                </button>
              </div>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Họ tên</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập họ tên">
              <input nz-input formControlName="ho_ten" placeholder="Nhập họ tên" />
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Mã nhân viên</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mã nhân viên">
              <input nz-input formControlName="ma_nhan_vien" placeholder="Mã nhân viên" [readonly]="true" />
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Mã hộ gia đình</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mã hộ gia đình">
              <input nz-input formControlName="ma_hgd" placeholder="Nhập mã hộ gia đình" maxlength="20" />
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Mã dân tộc</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mã dân tộc">
              <input nz-input formControlName="ma_dan_toc" placeholder="Nhập mã dân tộc" maxlength="20" />
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Ngày sinh</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn ngày sinh">
              <nz-date-picker 
                formControlName="ngay_sinh"
                nzFormat="dd/MM/yyyy"
                [nzLocale]="locale"
                [nzPlaceHolder]="'Chọn ngày sinh'"
                [nzAllowClear]="false"
                [nzShowToday]="true"
                [nzInputReadOnly]="true"
                [nzDropdownClassName]="'date-picker-dropdown'"
                style="width: 100%">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Giới tính</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn giới tính">
              <nz-select formControlName="gioi_tinh" nzPlaceHolder="Chọn giới tính">
                <nz-option nzValue="Nam" nzLabel="Nam"></nz-option>
                <nz-option nzValue="Nữ" nzLabel="Nữ"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Số điện thoại</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập số điện thoại hợp lệ">
              <input nz-input formControlName="so_dien_thoai" placeholder="Nhập số điện thoại" />
            </nz-form-control>
          </nz-form-item>
        </div>
        
        <!-- Hàng 2 -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Mức thu nhập</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn mức thu nhập">
              <nz-select 
                formControlName="muc_thu_nhap" 
                nzShowSearch 
                style="width: 100%"
                [nzPlaceHolder]="'Chọn mức thu nhập'"
                [nzDropdownMatchSelectWidth]="false"
                [nzFilterOption]="mucThuNhapFilter">
                <nz-option
                  *ngFor="let item of danhSachMucThuNhap"
                  [nzValue]="item.value"
                  [nzLabel]="item.label">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Tỷ lệ đóng (%)</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập tỷ lệ đóng từ 0-100">
              <nz-input-number
                formControlName="ty_le_dong"
                [nzMin]="0"
                [nzMax]="100"
                [nzStep]="1"
                [nzFormatter]="formatPercent"
                [nzParser]="parsePercent"
                style="width: 100%">
              </nz-input-number>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Tỷ lệ NSNN (%)</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập tỷ lệ NSNN từ 0-100">
              <nz-input-number
                formControlName="ty_le_nsnn"
                [nzMin]="0"
                [nzMax]="100"
                [nzStep]="1"
                [nzFormatter]="formatPercent"
                [nzParser]="parsePercent"
                style="width: 100%">
              </nz-input-number>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Loại NSNN</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn loại NSNN">
              <nz-select formControlName="loai_nsnn" style="width: 100%">
                <nz-option
                  *ngFor="let item of danhSachLoaiNSNN"
                  [nzValue]="item.value"
                  [nzLabel]="item.label">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Tiền hỗ trợ</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <nz-input-number
                formControlName="tien_ho_tro"
                [nzMin]="0"
                [nzFormatter]="formatCurrency"
                [nzParser]="parseCurrency"
                style="width: 100%">
              </nz-input-number>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Số tiền cần đóng</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <nz-input-number
                formControlName="so_tien_can_dong"
                [nzFormatter]="formatCurrency"
                [nzParser]="parseCurrency"
                [nzMin]="0"
                style="width: 100%">
              </nz-input-number>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Phương thức đóng</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn phương thức đóng">
              <nz-select formControlName="phuong_thuc_dong" style="width: 100%">
                <nz-option
                  *ngFor="let item of danhSachPhuongThucDong"
                  [nzValue]="item.value"
                  [nzLabel]="item.label">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Tỉnh/Thành phố</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn tỉnh/thành phố">
              <nz-select 
                formControlName="ma_tinh" 
                nzShowSearch 
                style="width: 100%"
                [nzPlaceHolder]="'Chọn tỉnh/thành phố'"
                (ngModelChange)="onTinhChange($event)">
                <nz-option
                  *ngFor="let tinh of danhMucTinhs"
                  [nzValue]="tinh.ma"
                  [nzLabel]="tinh.ten">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Quận/Huyện</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn quận/huyện">
              <nz-select 
                formControlName="ma_huyen" 
                nzShowSearch 
                style="width: 100%"
                [nzPlaceHolder]="'Chọn quận/huyện'"
                (ngModelChange)="onHuyenChange($event)">
                <nz-option
                  *ngFor="let huyen of danhMucHuyens"
                  [nzValue]="huyen.ma"
                  [nzLabel]="huyen.ten">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Phường/Xã</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn phường/xã">
              <nz-select 
                formControlName="ma_xa" 
                nzShowSearch 
                style="width: 100%"
                [nzPlaceHolder]="'Chọn phường/xã'">
                <nz-option
                  *ngFor="let xa of danhMucXas"
                  [nzValue]="xa.ma"
                  [nzLabel]="xa.ten">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Hàng 3 -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Phương án</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn phương án">
              <nz-select formControlName="phuong_an" style="width: 100%">
                <nz-option
                  *ngFor="let item of danhSachPhuongAn"
                  [nzValue]="item.value"
                  [nzLabel]="item.label">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Loại khai báo</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <input nz-input
                formControlName="loai_khai_bao"
                [disabled]="true"
                style="width: 100%">
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Ngày biên lai</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <nz-date-picker
                formControlName="ngay_bien_lai"
                nzFormat="dd/MM/yyyy"
                [nzLocale]="locale"
                [nzDisabled]="true"
                style="width: 100%">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Tháng bắt đầu</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn tháng bắt đầu">
              <nz-date-picker 
                formControlName="thang_bat_dau"
                nzMode="month"
                nzFormat="MM/yyyy"
                [nzLocale]="locale"
                [nzPlaceHolder]="'Chọn tháng bắt đầu'"
                [nzAllowClear]="false"
                [nzInputReadOnly]="true"
                [nzDropdownClassName]="'date-picker-dropdown'"
                (ngModelChange)="onThangBatDauChange($event)"
                style="width: 100%">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Ghi chú</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <input nz-input
                formControlName="ghi_chu"
                placeholder="Nhập ghi chú">
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </form>
  </nz-card>
  
  <nz-card class="form-card fade-in">
    <div class="table-actions">
      <div class="left-actions">
        <button nz-button nzType="default" class="ripple" [disabled]="selectedIds.length === 0" (click)="deleteSelectedRecords()">
          <span nz-icon nzType="delete" nzTheme="outline"></span>Xóa đã chọn
        </button>
      </div>
      <div class="right-actions">
        <div>Tổng số: <span class="amount">{{thongKe.tongSoThe}}</span></div>
        <div>Tổng tiền: <span class="amount">{{thongKe.tongSoTien | number:'1.0-0'}} VNĐ</span></div>
      </div>
    </div>
    
    <nz-table
      #basicTable
      [nzData]="keKhaiBHXHs"
      [nzLoading]="loading"
      [nzShowPagination]="true"
      [nzPageSize]="10"
      [nzScroll]="{ x: '1200px' }">
      <thead>
        <tr>
          <th [nzWidth]="'60px'" [nzLeft]="true">
            <label nz-checkbox [(ngModel)]="isAllChecked" (ngModelChange)="onAllChecked($event)"></label>
          </th>
          <th [nzWidth]="'60px'" [nzLeft]="true">STT</th>
          <th [nzWidth]="'120px'">Mã số BHXH</th>
          <th [nzWidth]="'120px'">CCCD</th>
          <th [nzWidth]="'150px'">Họ tên</th>
          <th [nzWidth]="'100px'">Ngày sinh</th>
          <th [nzWidth]="'80px'">Giới tính</th>
          <th [nzWidth]="'120px'">Mã hộ gia đình</th>
          <th [nzWidth]="'120px'">Số điện thoại</th>
          <th [nzWidth]="'150px'">Tỉnh/Thành phố</th>
          <th [nzWidth]="'150px'">Quận/Huyện</th>
          <th [nzWidth]="'150px'">Phường/Xã</th>
          <th [nzWidth]="'150px'">Mức thu nhập</th>
          <th [nzWidth]="'100px'">Tỷ lệ đóng</th>
          <th [nzWidth]="'100px'">Tỷ lệ NSNN</th>
          <th [nzWidth]="'150px'">Số tiền cần đóng</th>
          <th [nzWidth]="'120px'" [nzRight]="true">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of basicTable.data; let i = index" 
            class="cursor-pointer" 
            [class.active-row]="selectedRowId === data.id"
            (click)="fillFormData(data)">
          <td [nzLeft]="true" (click)="$event.stopPropagation()">
            <label nz-checkbox [(ngModel)]="data.checked" (ngModelChange)="refreshCheckedStatus()"></label>
          </td>
          <td [nzLeft]="true">{{ i + 1 }}</td>
          <td>{{ data.ma_so_bhxh }}</td>
          <td>{{ data.cccd }}</td>
          <td>{{ data.ho_ten }}</td>
          <td>{{ data.ngay_sinh | date:'dd/MM/yyyy' }}</td>
          <td>{{ data.gioi_tinh }}</td>
          <td>{{ data.ma_hgd }}</td>
          <td>{{ data.so_dien_thoai }}</td>
          <td>{{ data.tinh_nkq }}</td>
          <td>{{ data.huyen_nkq }}</td>
          <td>{{ data.xa_nkq }}</td>
          <td>{{ data.muc_thu_nhap | number:'1.0-0' }}</td>
          <td>{{ data.ty_le_dong }}%</td>
          <td>{{ data.ty_le_nsnn }}%</td>
          <td>{{ data.so_tien_can_dong | number:'1.0-0' }}</td>
          <td [nzRight]="true" (click)="$event.stopPropagation()">
            <div class="table-actions-cell">
              <button nz-button nzType="primary" nzShape="circle" nzSize="small" nzTooltip="Sửa" (click)="showModal(data)">
                <span nz-icon nzType="edit" nzTheme="outline"></span>
              </button>
              <button nz-button nzType="primary" nzDanger nzShape="circle" nzSize="small" nzTooltip="Xóa" (click)="deleteKeKhaiBHXH(data.id)">
                <span nz-icon nzType="delete" nzTheme="outline"></span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>
</div>

<!-- Modal đăng nhập -->
<nz-modal
  [(nzVisible)]="isLoginVisible"
  [nzTitle]="'Xác thực'"
  [nzOkText]="'Xác thực'"
  [nzCancelText]="'Hủy'"
  [nzOkLoading]="loadingLogin"
  (nzOnOk)="handleLogin()"
  (nzOnCancel)="handleLoginCancel()">
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="loginForm" class="login-form">
      <!-- Ẩn phần nhập tài khoản và mật khẩu -->
      <div style="display: none;">
        <nz-form-item>
          <nz-form-label [nzSpan]="24" nzRequired>Tên đăng nhập</nz-form-label>
          <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập tên đăng nhập">
            <input nz-input formControlName="userName" placeholder="Nhập tên đăng nhập" />
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label [nzSpan]="24" nzRequired>Mật khẩu</nz-form-label>
          <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mật khẩu">
            <input nz-input type="password" formControlName="password" placeholder="Nhập mật khẩu" />
          </nz-form-control>
        </nz-form-item>
      </div>
      
      <div class="login-message">
        <p>Vui lòng nhập mã xác nhận để tiếp tục</p>
      </div>
      
      <div class="captcha-image" *ngIf="captchaImage">
        <img [src]="captchaImage" alt="Captcha" />
      </div>
      
      <nz-form-item class="captcha-container">
        <nz-form-label [nzSpan]="24" nzRequired>Mã xác nhận</nz-form-label>
        <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mã xác nhận">
          <div class="input-with-button">
            <input nz-input formControlName="text" placeholder="Nhập mã xác nhận" (input)="convertToUpperCase($event)" />
            <button nz-button class="refresh-button" (click)="getCaptcha()">
              <span nz-icon nzType="reload" nzTheme="outline"></span>
            </button>
          </div>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>
````

## File: WebApp.Client/src/app/ke-khai/ke-khai-bhxh/ke-khai-bhxh.component.scss
````scss
.ke-khai-bhxh-container {
  padding: 24px;
  background-color: #f5f7fa;
  min-height: 100vh;
  background-image: linear-gradient(to bottom right, rgba(24, 144, 255, 0.05), rgba(9, 109, 217, 0.05));

  .form-card {
    margin-bottom: 24px;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    
    &:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }
    
    ::ng-deep .ant-card-head {
      border-bottom: 1px solid #f0f2f5;
      padding: 16px 24px;
      background-color: #fafafa;
      border-radius: 8px 8px 0 0;
      
      .ant-card-head-title {
        font-size: 18px;
        font-weight: 600;
        color: #1890ff;
        position: relative;
        padding-left: 12px;
        
        &:before {
          content: '';
          position: absolute;
          left: 0;
          top: 50%;
          transform: translateY(-50%);
          width: 4px;
          height: 18px;
          background: linear-gradient(to bottom, #1890ff, #096dd9);
          border-radius: 2px;
        }
      }
      
      .card-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
    }
    
    ::ng-deep .ant-card-body {
      padding: 24px;
    }
  }

  .table-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 16px;

    .left-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      
      button {
        transition: all 0.2s ease;
        
        &:hover {
          transform: translateY(-2px);
        }
      }
    }

    .right-actions {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;

      .amount {
        color: #1890ff;
        font-weight: 600;
        font-size: 16px;
        background: rgba(24, 144, 255, 0.1);
        padding: 4px 12px;
        border-radius: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(24, 144, 255, 0.15);
        
        &:hover {
          background: rgba(24, 144, 255, 0.2);
          transform: translateY(-2px);
        }
      }
    }
  }

  .custom-input-group {
    display: flex;
    
    input {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
      transition: all 0.3s ease;
      
      &:focus {
        box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
      }
    }

    button {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      transition: all 0.3s ease;
      
      &:hover {
        background-color: #096dd9;
      }
    }
  }

  nz-form-label {
    font-weight: 500;
    color: #262626;
  }
  
  nz-form-item {
    margin-bottom: 20px;
    transition: all 0.3s ease;
    
    &:hover {
      ::ng-deep .ant-form-item-label > label {
        color: #1890ff;
      }
    }
  }
  
  ::ng-deep .ant-select {
    width: 100%;
    
    &-selector {
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    
    &-focused .ant-select-selector {
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2) !important;
    }
  }
  
  ::ng-deep .ant-input-number {
    width: 100%;
    border-radius: 4px;
    
    &-focused {
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }
  }
  
  ::ng-deep .ant-btn {
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    
    &-primary {
      background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
      border: none;
      
      &:hover {
        background: linear-gradient(135deg, #40a9ff 0%, #1890ff 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(24, 144, 255, 0.4);
      }
    }
  }
  
  .table-actions-cell {
    display: flex;
    gap: 8px;
    justify-content: center;
    
    button {
      transition: all 0.2s ease;
      
      &:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }
    }
  }

  // Thêm CSS cho cursor-pointer
  .cursor-pointer {
    cursor: pointer;
    transition: background-color 0.3s;
    
    &:hover {
      background-color: #f5f5f5;
    }
    
    &.active-row {
      background-color: #e6f7ff;
      border-left: 3px solid #1890ff;
    }
  }
}

::ng-deep {
  .date-picker-dropdown {
    position: fixed !important;
  }

  .ant-picker {
    width: 100%;
    border-radius: 4px;
    transition: all 0.3s ease;
    
    &:hover, &-focused {
      border-color: #40a9ff;
    }
    
    &-focused {
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }
    
    &-input {
      > input {
        text-align: left;
      }
    }
    
    &-panel-container {
      z-index: 1050;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }
  }
  
  .ant-table {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    
    &-thead > tr > th {
      background-color: #fafafa;
      font-weight: 600;
      
      &:first-child {
        border-top-left-radius: 8px;
      }
      
      &:last-child {
        border-top-right-radius: 8px;
      }
    }
    
    &-row {
      transition: all 0.3s ease;
      
      &:hover {
        background-color: #e6f7ff !important;
      }
      
      &:nth-child(even) {
        background-color: #f9f9f9;
      }
    }
    
    &-pagination {
      margin: 16px 0;
    }
    
    &-cell {
      transition: all 0.2s ease;
    }
  }
  
  .ant-tag {
    border-radius: 4px;
    padding: 2px 8px;
    font-weight: 500;
  }
  
  .ant-modal {
    &-content {
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    
    &-header {
      border-bottom: 1px solid #f0f2f5;
      padding: 16px 24px;
      
      .ant-modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #1890ff;
      }
    }
    
    &-body {
      padding: 24px;
    }
    
    &-footer {
      border-top: 1px solid #f0f2f5;
      padding: 16px 24px;
      
      .ant-btn {
        border-radius: 4px;
        transition: all 0.3s ease;
        
        &:hover {
          transform: translateY(-2px);
        }
      }
    }
  }
  
  .ant-checkbox {
    &-checked .ant-checkbox-inner {
      background-color: #1890ff;
      border-color: #1890ff;
    }
    
    &-wrapper:hover .ant-checkbox-inner, 
    &:hover .ant-checkbox-inner, 
    &-input:focus + .ant-checkbox-inner {
      border-color: #1890ff;
    }
  }
}

.form-actions {
  margin-top: 24px;
  padding-top: 16px;
  border-top: 1px solid #f0f0f0;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

.text-right {
  text-align: right;
}

.mr-2 {
  margin-right: 8px;
}

.captcha-container {
  .input-with-button {
    display: flex;
    gap: 8px;
    align-items: center;

    input {
      flex: 1;
      border-radius: 4px;
      transition: all 0.3s ease;
      
      &:focus {
        box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
      }
    }

    .refresh-button {
      padding: 4px 8px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.3s ease;
      
      &:hover {
        background-color: #f5f5f5;
      }
    }
  }
}

.captcha-image {
  margin-top: 12px;
  text-align: center;
  
  img {
    max-width: 100%;
    border-radius: 4px;
    border: 1px solid #f0f0f0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    
    &:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }
  }
}

.login-form {
  padding: 8px;
  max-width: 400px;
  margin: 0 auto;
  
  .login-message {
    margin-bottom: 16px;
    text-align: center;
    
    p {
      color: #1890ff;
      font-size: 14px;
    }
  }
  
  .captcha-image {
    text-align: center;
    margin-bottom: 16px;
    
    img {
      max-width: 100%;
      height: auto;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
    }
  }
  
  .captcha-container {
    .input-with-button {
      display: flex;
      
      .refresh-button {
        margin-left: 8px;
      }
    }
  }
}

.modal-form {
  padding: 8px;
  
  nz-form-item {
    margin-bottom: 16px;
  }
  
  textarea {
    resize: none;
    border-radius: 4px;
    
    &:focus {
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }
  }
}

// Responsive styles
@media (max-width: 768px) {
  .ke-khai-bhxh-container {
    padding: 16px;
    
    .form-card {
      ::ng-deep .ant-card-body {
        padding: 16px;
      }
    }
    
    .table-actions {
      flex-direction: column;
      align-items: flex-start;
      
      .right-actions {
        margin-top: 12px;
        width: 100%;
        justify-content: space-between;
      }
    }
  }
}

// Animation keyframes
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(24, 144, 255, 0.4);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(24, 144, 255, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(24, 144, 255, 0);
  }
}

.fade-in {
  animation: fadeIn 0.3s ease forwards;
}

.pulse {
  animation: pulse 2s infinite;
}

// Thêm hiệu ứng ripple cho các nút
.ripple {
  position: relative;
  overflow: hidden;
  
  &:after {
    content: "";
    display: block;
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    pointer-events: none;
    background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
    background-repeat: no-repeat;
    background-position: 50%;
    transform: scale(10, 10);
    opacity: 0;
    transition: transform .5s, opacity 1s;
  }
  
  &:active:after {
    transform: scale(0, 0);
    opacity: .3;
    transition: 0s;
  }
}
````

## File: WebApp.Client/src/app/ke-khai/ke-khai-bhxh/ke-khai-bhxh.component.ts
````typescript
import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule, DatePipe, DecimalPipe } from '@angular/common';
import { FormBuilder, FormGroup, Validators, FormsModule, ReactiveFormsModule } from '@angular/forms';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule, NzIconService } from 'ng-zorro-antd/icon';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzDatePickerModule } from 'ng-zorro-antd/date-picker';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzModalService } from 'ng-zorro-antd/modal';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzCardModule } from 'ng-zorro-antd/card';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzInputNumberModule } from 'ng-zorro-antd/input-number';
import { NzCheckboxModule } from 'ng-zorro-antd/checkbox';
import { NzToolTipModule } from 'ng-zorro-antd/tooltip';
import { ActivatedRoute } from '@angular/router';
import { DiaChiService, DanhMucTinh, DanhMucHuyen, DanhMucXa } from '../../services/dia-chi.service';
import { vi_VN } from 'ng-zorro-antd/i18n';
import { en_US, NZ_I18N } from 'ng-zorro-antd/i18n';
import { registerLocaleData } from '@angular/common';
import vi from '@angular/common/locales/vi';
import { SearchOutline, IdcardOutline, DeleteOutline, EditOutline, SaveOutline, ClearOutline } from '@ant-design/icons-angular/icons';
import { KeKhaiBHXHService } from '../../services/ke-khai-bhxh.service';
import { SSMV2Service } from '../../services/ssmv2.service';
import { Observable, of } from 'rxjs';
import { map, catchError } from 'rxjs/operators';

registerLocaleData(vi);

interface SearchResponse {
  success: boolean;
  data: any;
  message?: string;
}

@Component({
  selector: 'app-ke-khai-bhxh',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    NzTableModule,
    NzButtonModule,
    NzIconModule,
    NzTagModule,
    NzModalModule,
    NzFormModule,
    NzInputModule,
    NzDatePickerModule,
    NzSelectModule,
    NzDividerModule,
    NzCardModule,
    NzGridModule,
    NzInputNumberModule,
    NzCheckboxModule,
    DatePipe,
    NzToolTipModule
  ],
  templateUrl: './ke-khai-bhxh.component.html',
  styleUrls: ['./ke-khai-bhxh.component.scss'],
  providers: [
    DecimalPipe,
    DatePipe,
    { provide: NZ_I18N, useValue: vi_VN }
  ]
})
export class KeKhaiBHXHComponent implements OnInit, OnDestroy {
  form!: FormGroup;
  loading = false;
  isVisible = false;
  isEdit = false;
  selectedIds: number[] = [];
  isAllChecked = false;
  isIndeterminate = false;
  dotKeKhaiId: number = 0;
  currentUser = JSON.parse(localStorage.getItem('user') || '{}');
  ngay_bien_lai: Date = new Date();
  
  // Biến để theo dõi dòng đang được chọn
  selectedRowId: number | null = null;
  
  locale = {
    lang: {
      placeholder: 'Chọn ngày',
      rangePlaceholder: ['Ngày bắt đầu', 'Ngày kết thúc'],
      today: 'Hôm nay',
      now: 'Bây giờ',
      backToToday: 'Trở về hôm nay',
      ok: 'Đồng ý',
      clear: 'Xóa',
      month: 'Tháng',
      year: 'Năm',
      timeSelect: 'Chọn giờ',
      dateSelect: 'Chọn ngày',
      monthSelect: 'Chọn tháng',
      yearSelect: 'Chọn năm',
      decadeSelect: 'Chọn thập kỷ',
      yearFormat: 'YYYY',
      dateFormat: 'DD/MM/YYYY',
      dayFormat: 'DD',
      dateTimeFormat: 'DD/MM/YYYY HH:mm:ss',
      monthBeforeYear: true,
      previousMonth: 'Tháng trước',
      nextMonth: 'Tháng sau',
      previousYear: 'Năm trước',
      nextYear: 'Năm sau',
      previousDecade: 'Thập kỷ trước',
      nextDecade: 'Thập kỷ sau',
      previousCentury: 'Thế kỷ trước',
      nextCentury: 'Thế kỷ sau'
    },
    timePickerLocale: {
      placeholder: 'Chọn giờ'
    }
  };
  
  danhMucTinhs: DanhMucTinh[] = [];
  danhMucHuyens: DanhMucHuyen[] = [];
  danhMucXas: DanhMucXa[] = [];
  
  danhSachMucThuNhap: { value: number; label: string }[] = [];

  mucThuNhapFilter = (input: string, option: { nzLabel: string | number | null; nzValue: any }): boolean => {
    if (!input || !option.nzValue) return true;
    const searchValue = input.replace(/[,.]/g, '');
    const optionValue = option.nzValue.toString();
    return optionValue.includes(searchValue);
  };

  danhSachPhuongAn = [
    { value: 'TM', label: 'TM - Tăng mới' },
    { value: 'DT', label: 'DT - Đóng tiếp' },
    { value: 'DB', label: 'DB - Đóng bù' },
    { value: 'DL', label: 'DL - Đóng lại' },
    { value: 'GH', label: 'GH - Dừng đóng' }
  ];

  danhSachPhuongThucDong = [
    { value: 1, label: 'Đóng 1 tháng' },
    { value: 3, label: 'Đóng 3 tháng' },
    { value: 6, label: 'Đóng 6 tháng' },
    { value: 12, label: 'Đóng 1 Năm' },
    { value: 'VS', label: 'Đóng cho những năm về sau' },
    { value: 'TH', label: 'Đóng cho những năm còn thiếu' }
  ];

  danhSachLoaiNSNN = [
    { value: 'ngheo', label: 'Nghèo' },
    { value: 'can_ngheo', label: 'Cận nghèo' },
    { value: 'khac', label: 'Khác' }
  ];
  
  danhSachLoaiKhaiBao = [
    { value: '1', label: 'Khai báo lần đầu' },
    { value: '2', label: 'Khai báo điều chỉnh' },
    { value: '3', label: 'Khai báo bổ sung' }
  ];
  
  keKhaiBHXHs: any[] = [];
  thongKe = {
    tongSoThe: 0,
    tongSoTien: 0
  };

  formatCurrency = (value: number): string => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  parseCurrency = (value: string): number => Number(value.replace(/\$\s?|(,*)/g, ''));

  formatPercent = (value: number | string): string => `${value}%`;
  parsePercent = (value: string): number => Number(value.replace('%', ''));

  // Thêm biến để kiểm soát thời gian giữa các lần gọi API
  private isSearching = false;

  // Thêm các thuộc tính SSMV2
  isLoginVisible = false;
  captchaImage = '';
  captchaCode = '';
  loginForm: FormGroup;
  loadingLogin = false;

  // Thêm thuộc tính để lưu cache
  private diaChiCache: {
    tinhs: { [key: string]: DanhMucTinh[] },
    huyens: { [key: string]: DanhMucHuyen[] },
    xas: { [key: string]: DanhMucXa[] }
  } = {
    tinhs: {},
    huyens: {},
    xas: {}
  };

  constructor(
    private fb: FormBuilder,
    private route: ActivatedRoute,
    private message: NzMessageService,
    private modal: NzModalService,
    private diaChiService: DiaChiService,
    private datePipe: DatePipe,
    private iconService: NzIconService,
    private keKhaiBHXHService: KeKhaiBHXHService,
    private ssmv2Service: SSMV2Service
  ) {
    this.iconService.addIcon(...[SearchOutline, IdcardOutline, DeleteOutline, EditOutline, SaveOutline, ClearOutline]);
    this.generateMucThuNhap();
    
    // Khởi tạo form login SSMV2 với tài khoản và mật khẩu mặc định
    this.loginForm = this.fb.group({
      userName: ['884000_xa_tli_phuoclt', [Validators.required]],
      password: ['123456d@D', [Validators.required]],
      text: ['', [
        Validators.required,
        Validators.minLength(4),
        Validators.maxLength(4)
      ]]
    });
  }

  generateMucThuNhap(): void {
    const mucToiThieu = 1500000;
    const mucToiDa = 10000000; // Giả sử mức tối đa là 10 triệu
    const buocNhay = 50000;
    
    for (let muc = mucToiThieu; muc <= mucToiDa; muc += buocNhay) {
      this.danhSachMucThuNhap.push({
        value: muc,
        label: muc.toLocaleString('vi-VN') + ' đồng'
      });
    }
  }

  ngOnInit(): void {
    // Thêm CSS cho modal đăng nhập
    const style = document.createElement('style');
    style.innerHTML = `
      .login-message {
        text-align: center;
        margin-bottom: 20px;
        color: #1890ff;
        font-size: 16px;
      }
      
      .captcha-image {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }
      
      .captcha-image img {
        max-width: 100%;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }
      
      .input-with-button {
        display: flex;
      }
      
      .input-with-button .refresh-button {
        margin-left: 8px;
      }
      
      .captcha-container {
        margin-bottom: 0;
      }
    `;
    document.head.appendChild(style);
    
    // Thêm log để kiểm tra dữ liệu currentUser
    console.log('currentUser:', this.currentUser);
    console.log('Mã nhân viên:', this.currentUser?.ma_nhan_vien || this.currentUser?.username);
    
    this.route.params.subscribe(params => {
      this.dotKeKhaiId = +params['id']; // Chuyển đổi sang số
      console.log('dotKeKhaiId:', this.dotKeKhaiId);
      
      if (!this.dotKeKhaiId || isNaN(this.dotKeKhaiId)) {
        this.message.error('Không tìm thấy thông tin đợt kê khai');
        return;
      }
      
      this.initForm();
      this.loadDanhMucTinh();
      this.loadData();
      this.generateMucThuNhap();
      
      // Thiết lập các sự kiện theo dõi thay đổi của form
      this.setupFormValueChanges();
    });
  }

  ngOnDestroy(): void {
    // Cleanup if needed
  }

  initForm(): void {
    this.form = this.fb.group({
      id: [null],
      dot_ke_khai_id: [this.dotKeKhaiId],
      ma_so_bhxh: ['', [Validators.required, Validators.maxLength(10)]],
      cccd: ['', [Validators.required, Validators.maxLength(12)]],
      ho_ten: ['', [Validators.required, Validators.maxLength(100)]],
      ngay_sinh: [null, [Validators.required]],
      gioi_tinh: ['', [Validators.required]],
      so_dien_thoai: ['', [Validators.pattern(/^[0-9]{10,11}$/)]],
      ma_hgd: [''],
      ma_dan_toc: [''],
      ma_nhan_vien: [{value: this.currentUser?.ma_nhan_vien || '', disabled: true}, [Validators.required]],
      dia_chi_nkq: '',
      ma_tinh: [null, [Validators.required]],
      ma_huyen: [null, [Validators.required]],
      ma_xa: [null, [Validators.required]],
      muc_thu_nhap: [1500000, [Validators.required, Validators.min(1500000)]],
      ty_le_dong: [{value: 22, disabled: true}, [Validators.required, Validators.min(0), Validators.max(100)]],
      ty_le_nsnn: [{value: 10, disabled: true}, [Validators.required, Validators.min(0), Validators.max(100)]],
      loai_nsnn: ['khac', [Validators.required]],
      tien_ho_tro: [{value: 0, disabled: true}, [Validators.required, Validators.min(0)]],
      so_tien_can_dong: [{value: 0, disabled: true}, [Validators.required, Validators.min(0)]],
      phuong_thuc_dong: [1, [Validators.required]],
      thang_bat_dau: [null, Validators.required],
      tu_thang: [null],
      phuong_an: ['TM', [Validators.required]],
      loai_khai_bao: [{value: '1', disabled: true}, [Validators.required]],
      ngay_bien_lai: [new Date(), Validators.required],
      ghi_chu: ['']
    });
  }

  loadData(): void {
    this.loading = true;
    this.keKhaiBHXHService.getByDotKeKhaiId(this.dotKeKhaiId).subscribe({
      next: (data) => {
        console.log('Dữ liệu kê khai BHXH được tải về:', JSON.stringify(data));
        
        // Kiểm tra dữ liệu nhận được từ API
        if (Array.isArray(data)) {
          // Đảm bảo các trường dữ liệu được hiển thị đúng
          this.keKhaiBHXHs = data.map(item => {
            // Log chi tiết từng item để debug
            console.log(`Chi tiết item ${item.id}:`, JSON.stringify(item));
            console.log(`Mã hộ gia đình trực tiếp: ${item.ma_hgd || 'không có'}`);
            
            // Tạo ra một đối tượng mới với ma_hgd được gán đúng
            const itemWithMaHGD = {
              ...item,
              ma_hgd: item.ma_hgd || '' // Đảm bảo ma_hgd luôn có giá trị để hiển thị
            };
            
            return itemWithMaHGD;
          });
          
          // Log kết quả sau khi xử lý
          console.log('Danh sách kê khai sau khi xử lý:', this.keKhaiBHXHs);
        } else {
          console.error('Dữ liệu API không phải là mảng:', data);
          this.keKhaiBHXHs = [];
        }
        
        this.thongKe.tongSoThe = this.keKhaiBHXHs.length;
        this.thongKe.tongSoTien = this.keKhaiBHXHs.reduce((total, item) => total + (item.so_tien_can_dong || 0), 0);
        this.loading = false;
      },
      error: (error) => {
        console.error('Lỗi khi tải dữ liệu kê khai BHXH:', error);
        this.message.error('Có lỗi xảy ra khi tải dữ liệu kê khai BHXH');
        this.loading = false;
      }
    });
  }

  loadDanhMucTinh(): void {
    // Kiểm tra cache trước
    if (this.danhMucTinhs.length > 0) {
      return;
    }

    this.diaChiService.getDanhMucTinh().subscribe({
      next: (data) => {
        this.danhMucTinhs = data.sort((a, b) => a.ten.localeCompare(b.ten, 'vi'));
        // Lưu vào cache
        this.diaChiCache.tinhs['all'] = this.danhMucTinhs;
      },
      error: (error) => {
        console.error('Lỗi khi tải danh mục tỉnh:', error);
        this.message.error('Có lỗi xảy ra khi tải danh mục tỉnh');
      }
    });
  }

  onTinhChange(maTinh: string): void {
    console.log('onTinhChange được gọi với mã tỉnh:', maTinh);
    
    // Reset các danh sách và giá trị form
    this.danhMucHuyens = [];
    this.danhMucXas = [];
    this.form.patchValue({
      ma_huyen: null,
      ma_xa: null
    });
    
    if (!maTinh) return;

    // Kiểm tra cache
    if (this.diaChiCache.huyens[maTinh]) {
      this.danhMucHuyens = this.diaChiCache.huyens[maTinh];
      return;
    }

    this.diaChiService.getDanhMucHuyenByMaTinh(maTinh).subscribe({
      next: (data) => {
        this.danhMucHuyens = data.sort((a, b) => a.ten.localeCompare(b.ten, 'vi'));
        // Lưu vào cache
        this.diaChiCache.huyens[maTinh] = this.danhMucHuyens;
      },
      error: (error) => {
        console.error('Lỗi khi tải danh mục huyện:', error);
        this.message.error('Có lỗi xảy ra khi tải danh mục quận/huyện');
      }
    });
  }

  onHuyenChange(maHuyen: string): void {
    console.log('onHuyenChange được gọi với mã huyện:', maHuyen);
    
    // Reset danh sách xã và giá trị form
    this.danhMucXas = [];
    this.form.patchValue({
      ma_xa: null
    });
    
    if (!maHuyen) return;

    // Kiểm tra cache
    if (this.diaChiCache.xas[maHuyen]) {
      this.danhMucXas = this.diaChiCache.xas[maHuyen];
      return;
    }

    // Lấy mã tỉnh từ form
    const maTinh = this.form.get('ma_tinh')?.value;
    if (!maTinh) return;

    // Kiểm tra xem huyện có thuộc tỉnh đã chọn không
    const huyenHopLe = this.danhMucHuyens.find(h => h.ma === maHuyen && h.ma_tinh === maTinh);
    if (!huyenHopLe) return;

    this.diaChiService.getDanhMucXaByMaHuyen(maHuyen).subscribe({
      next: (xas: DanhMucXa[]) => {
        this.danhMucXas = xas.sort((a, b) => a.ten.localeCompare(b.ten, 'vi'));
        // Lưu vào cache
        this.diaChiCache.xas[maHuyen] = this.danhMucXas;
      },
      error: (error: any) => {
        console.error('Lỗi khi tải danh mục xã:', error);
        this.message.error('Có lỗi xảy ra khi tải danh mục phường/xã');
      }
    });
  }

  showModal(data?: any): void {
    this.isVisible = true;
    this.isEdit = !!data;
    this.form.reset();

    if (data) {
      this.form.patchValue({
        // TODO: Patch form values
      });
    }
  }

  handleOk(): void {
    if (this.form.valid) {
      const formValue = this.form.value;
      // TODO: Implement save/update logic
    } else {
      Object.values(this.form.controls).forEach(control => {
        if (control.invalid) {
          control.markAsTouched();
        }
      });
    }
  }

  handleCancel(): void {
    this.isVisible = false;
  }

  onAllChecked(checked: boolean): void {
    this.keKhaiBHXHs.forEach(item => {
      if (item.id) {
        const index = this.selectedIds.indexOf(item.id);
        if (checked && index === -1) {
          this.selectedIds.push(item.id);
        } else if (!checked && index !== -1) {
          this.selectedIds.splice(index, 1);
        }
      }
    });
    this.refreshCheckedStatus();
  }

  // Phương thức điền dữ liệu từ bảng vào form
  fillFormData(data: any): void {
    if (!data) return;
    
    // Cuộn lên đầu trang
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Cập nhật dòng đang được chọn
    this.selectedRowId = data.id;
    
    // Reset form trước khi điền dữ liệu
    this.form.reset();
    
    // In thông tin để debug
    console.log('Dữ liệu hàng được chọn:', data);
    
    // Lấy giá trị mã hộ gia đình từ dữ liệu
    const maHoGiaDinh = data.ma_hgd || data.thong_tin_the?.ma_hgd || '';
    console.log('Mã hộ gia đình trong fillFormData:', maHoGiaDinh);
    
    // Điền dữ liệu từ bảng vào form
    const ngaySinh = data.ngay_sinh ? new Date(data.ngay_sinh) : null;
    const thangBatDau = data.thang_bat_dau ? new Date(data.thang_bat_dau) : null;
    const ngayBienLai = data.ngay_bien_lai ? new Date(data.ngay_bien_lai) : new Date();
    
    // Điền dữ liệu cơ bản (không bao gồm thông tin địa chỉ)
    this.form.patchValue({
      id: data.id,
      dot_ke_khai_id: this.dotKeKhaiId,
      ma_so_bhxh: data.ma_so_bhxh,
      cccd: data.cccd,
      ho_ten: data.ho_ten,
      ngay_sinh: ngaySinh,
      gioi_tinh: data.gioi_tinh,
      so_dien_thoai: data.so_dien_thoai,
      ma_hgd: maHoGiaDinh,
      ma_dan_toc: data.ma_dan_toc || data.thong_tin_the?.ma_dan_toc,
      ma_nhan_vien: data.ma_nhan_vien || this.currentUser?.ma_nhan_vien,
      dia_chi_nkq: data.dia_chi_nkq,
      muc_thu_nhap: data.muc_thu_nhap,
      ty_le_dong: data.ty_le_dong,
      ty_le_nsnn: data.ty_le_nsnn,
      loai_nsnn: data.loai_nsnn,
      tien_ho_tro: data.tien_ho_tro,
      so_tien_can_dong: data.so_tien_can_dong,
      phuong_thuc_dong: data.phuong_thuc_dong,
      thang_bat_dau: thangBatDau,
      phuong_an: data.phuong_an,
      loai_khai_bao: data.loai_khai_bao || '1',
      ngay_bien_lai: ngayBienLai,
      ghi_chu: data.ghi_chu
    });
    
    // Xử lý dữ liệu địa chỉ
    // Đảm bảo tải danh mục tỉnh trước
    this.loadDanhMucTinh();
    
    // Lấy thông tin tỉnh, huyện, xã từ API
    this.diaChiService.getDanhMucTinh().subscribe({
      next: (tinhs) => {
        this.danhMucTinhs = tinhs;
        
        // Xác định mã tỉnh
        let maTinh = '';
        // Nếu có mã tỉnh trong data, sử dụng
        if (data.ma_tinh) {
          maTinh = data.ma_tinh;
        } 
        // Nếu không tìm thấy mã tỉnh nhưng có tên tỉnh
        else if (data.tinh_nkq) {
          const tinh = this.danhMucTinhs.find(t => t.ten.toLowerCase() === data.tinh_nkq.toLowerCase());
          if (tinh) {
            maTinh = tinh.ma;
          }
        }
        
        console.log('Mã tỉnh được xác định:', maTinh);
        
        if (maTinh) {
          // Cập nhật mã tỉnh vào form
          this.form.patchValue({ ma_tinh: maTinh });
          
          // Tải danh sách huyện
          this.diaChiService.getDanhMucHuyenByMaTinh(maTinh).subscribe({
            next: (huyens) => {
              this.danhMucHuyens = huyens;
              
              // Xác định mã huyện
              let maHuyen = '';
              // Nếu có mã huyện trong data, sử dụng
              if (data.ma_huyen) {
                maHuyen = data.ma_huyen;
              } 
              // Nếu không tìm thấy mã huyện nhưng có tên huyện
              else if (data.huyen_nkq) {
                const huyen = this.danhMucHuyens.find(h => h.ten.toLowerCase() === data.huyen_nkq.toLowerCase());
                if (huyen) {
                  maHuyen = huyen.ma;
                }
              }
              
              console.log('Mã huyện được xác định:', maHuyen);
              
              if (maHuyen) {
                // Cập nhật mã huyện vào form
                this.form.patchValue({ ma_huyen: maHuyen });
                
                // Tải danh sách xã
                this.diaChiService.getDanhMucXaByMaHuyen(maHuyen).subscribe({
                  next: (xas) => {
                    this.danhMucXas = xas;
                    
                    // Xác định mã xã
                    let maXa = '';
                    // Nếu có mã xã trong data, sử dụng
                    if (data.ma_xa) {
                      maXa = data.ma_xa;
                    } 
                    // Nếu không tìm thấy mã xã nhưng có tên xã
                    else if (data.xa_nkq) {
                      const xa = this.danhMucXas.find(x => x.ten.toLowerCase() === data.xa_nkq.toLowerCase());
                      if (xa) {
                        maXa = xa.ma;
                      }
                    }
                    
                    console.log('Mã xã được xác định:', maXa);
                    
                    if (maXa) {
                      // Cập nhật mã xã vào form
                      this.form.patchValue({ ma_xa: maXa });
                    }
                  },
                  error: (error) => {
                    console.error('Lỗi khi tải danh mục xã:', error);
                  }
                });
              }
            },
            error: (error) => {
              console.error('Lỗi khi tải danh mục huyện:', error);
            }
          });
        }
      },
      error: (error) => {
        console.error('Lỗi khi tải danh mục tỉnh:', error);
      }
    });
    
    // Hiển thị thông báo
    this.message.success('Đã điền thông tin vào form');
  }

  refreshCheckedStatus(): void {
    const allChecked = this.keKhaiBHXHs.every(item => 
      item.id && this.selectedIds.includes(item.id));
    const someChecked = this.keKhaiBHXHs.some(item => 
      item.id && this.selectedIds.includes(item.id));
    this.isAllChecked = allChecked;
    this.isIndeterminate = !allChecked && someChecked;
  }

  onlyNumber(event: KeyboardEvent): boolean {
    const charCode = (event.which) ? event.which : event.keyCode;
    if (charCode > 31 && (charCode < 48 || charCode > 57)) {
      return false;
    }
    return true;
  }

  getCurrentDate(): Date {
    return new Date();
  }

  tinhSoTienPhaiDong(): void {
    const mucThuNhap = this.form.get('muc_thu_nhap')?.value || 0;
    const tyLeDong = this.form.get('ty_le_dong')?.value || 0;
    const tyLeNSNN = this.form.get('ty_le_nsnn')?.value || 0;
    const phuongThucDong = this.form.get('phuong_thuc_dong')?.value || 1;
    
    // Lấy số tháng đóng từ phương thức đóng
    const soThangDong = typeof phuongThucDong === 'number' ? phuongThucDong : 1;
    
    // Tính mức đóng = Mức thu nhập × Tỷ lệ đóng × Số tháng đóng
    const mucDong = Math.round((mucThuNhap * tyLeDong * soThangDong) / 100);
    
    // Tính tiền đóng mức tối thiểu = 1,500,000 × Tỷ lệ đóng
    const tienDongMucToiThieu = Math.round((1500000 * tyLeDong) / 100);
    
    // Tính số tiền hỗ trợ = Tiền đóng mức tối thiểu × Tỷ lệ NSNN × Số tháng đóng
    const tienHoTro = Math.round((tienDongMucToiThieu * tyLeNSNN * soThangDong) / 100);
    
    // Tính số tiền thực phải đóng = Mức đóng - Tiền hỗ trợ
    const soTienCanDong = mucDong - tienHoTro;
    
    this.form.patchValue({
      tien_ho_tro: tienHoTro,
      so_tien_can_dong: soTienCanDong
    }, { emitEvent: false });
  }

  onLoaiNSNNChange(loaiNSNN: string): void {
    let tyLeNSNN = 10; // Mặc định là 10%
    
    switch (loaiNSNN) {
      case 'ngheo':
        tyLeNSNN = 30;
        break;
      case 'can_ngheo':
        tyLeNSNN = 25;
        break;
      case 'khac':
        tyLeNSNN = 10;
        break;
    }
    
    this.form.patchValue({
      ty_le_nsnn: tyLeNSNN
    });
  }

  onPhuongAnChange(phuongAn: string): void {
    if (phuongAn) {
      const tenPhuongAn = this.danhSachPhuongAn.find(pa => pa.value === phuongAn)?.label.split(' - ')[1] || phuongAn;
      this.form.patchValue({
        ghi_chu: `Phương án: ${tenPhuongAn}`
      });
    } else {
      this.form.patchValue({
        ghi_chu: ''
      });
    }
  }

  resetForm(): void {
    // Reset form về giá trị mặc định
    this.form.reset({
      id: null,
      dot_ke_khai_id: this.dotKeKhaiId,
      ma_so_bhxh: '',
      cccd: '',
      ho_ten: '',
      ngay_sinh: null,
      gioi_tinh: null,
      so_dien_thoai: '',
      ma_hgd: '',
      ma_dan_toc: '',
      ma_nhan_vien: this.currentUser?.ma_nhan_vien || '',
      dia_chi_nkq: '',
      ma_tinh: null,
      ma_huyen: null,
      ma_xa: null,
      muc_thu_nhap: 1500000,
      ty_le_dong: 22,
      ty_le_nsnn: 10,
      loai_nsnn: 'khac',
      tien_ho_tro: 0,
      so_tien_can_dong: 0,
      phuong_thuc_dong: 1,
      thang_bat_dau: null,
      phuong_an: 'TM',
      loai_khai_bao: '1',
      ngay_bien_lai: new Date(),
      ghi_chu: ''
    });
  }

  // Phương thức kiểm tra trùng lặp mã số BHXH
  private checkDuplicateBHXH(maSoBHXH: string): Observable<boolean> {
    // Nếu không có đợt kê khai, không cần kiểm tra
    if (!this.dotKeKhaiId) {
      return of(false);
    }
    
    // Kiểm tra trong danh sách kê khai hiện tại (không cần gọi API)
    const existingRecord = this.keKhaiBHXHs.find(item => 
      item.ma_so_bhxh === maSoBHXH && 
      (!this.isEdit || (this.isEdit && item.id !== this.form.get('id')?.value))
    );
    
    if (existingRecord) {
      return of(true); // Đã tìm thấy bản ghi trùng trong danh sách hiện tại
    }
    
    // Nếu không tìm thấy trong danh sách hiện tại, trả về false
    return of(false);
  }

  saveKeKhaiBHXH(): void {
    // Kiểm tra form hợp lệ
    if (this.form.invalid) {
      this.getFormValidationErrors();
      this.message.error('Vui lòng điền đầy đủ thông tin bắt buộc!');
      return;
    }

    const maSoBHXH = this.form.get('ma_so_bhxh')?.value;
    
    // Kiểm tra trùng lặp mã số BHXH
    this.checkDuplicateBHXH(maSoBHXH).subscribe(isDuplicate => {
      if (isDuplicate) {
        this.message.error(`Mã số BHXH ${maSoBHXH} đã tồn tại trong đợt kê khai này!`);
        return;
      }
      
      // Tiếp tục xử lý lưu kê khai nếu không trùng lặp
      this.processKeKhaiBHXH();
    });
  }

  // Thêm hàm này để kiểm tra lỗi của form
  getFormValidationErrors() {
    const result: any = {};
    Object.keys(this.form.controls).forEach(key => {
      const control = this.form.get(key);
      if (control && control.errors) {
        result[key] = control.errors;
      }
    });
    return result;
  }

  // Phương thức để lấy tên tỉnh từ mã
  getTinhTen(maTinh: string): string {
    if (!maTinh) return '';
    
    const tinh = this.danhMucTinhs.find(t => t.ma === maTinh);
    return tinh ? tinh.ten : '';
  }

  // Phương thức để lấy tên huyện từ mã
  getHuyenTen(maHuyen: string): string {
    if (!maHuyen) return '';
    
    const huyen = this.danhMucHuyens.find(h => h.ma === maHuyen);
    return huyen ? huyen.ten : '';
  }

  // Phương thức để lấy tên xã từ mã
  getXaTen(maXa: string): string {
    if (!maXa) return '';
    
    const xa = this.danhMucXas.find(x => x.ma === maXa);
    return xa ? xa.ten : '';
  }

  processKeKhaiBHXH(): void {
    // Lấy cả giá trị của các trường bị vô hiệu hóa
    const formValue = this.form.getRawValue();
    
    // Nếu tu_thang không có giá trị, sử dụng thang_bat_dau
    const tuThang = formValue.tu_thang || formValue.thang_bat_dau;
    
    // Đảm bảo ty_le_dong là số
    const tyLeDong = parseFloat(formValue.ty_le_dong);
    
    // Luôn sử dụng giá trị '1' cho loại khai báo
    const loaiKhaiBao = '1';
    
    // Lấy mã và tên tỉnh, huyện, xã
    const maTinh = formValue.ma_tinh;
    const tenTinh = this.getTinhTen(maTinh);
    
    const maHuyen = formValue.ma_huyen;
    const tenHuyen = this.getHuyenTen(maHuyen);
    
    const maXa = formValue.ma_xa;
    const tenXa = this.getXaTen(maXa);
    
    // Xử lý thang_bat_dau để chỉ lưu tháng và năm
    let thangBatDau = formValue.thang_bat_dau;
    let thangBatDauFormatted = '';
    if (thangBatDau) {
      // Format thành yyyy-MM (không có ngày)
      const date = new Date(thangBatDau);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const formattedMonth = month < 10 ? `0${month}` : `${month}`;
      thangBatDauFormatted = `${year}-${formattedMonth}`;
      
      console.log('Tháng bắt đầu đã được format:', thangBatDauFormatted);
    }
    
    // Xử lý tu_thang để chỉ lưu tháng và năm
    let tuThangDate = tuThang;
    let tuThangFormatted = null;
    if (tuThangDate) {
      // Format thành yyyy-MM (không có ngày)
      const date = new Date(tuThangDate);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const formattedMonth = month < 10 ? `0${month}` : `${month}`;
      tuThangFormatted = `${year}-${formattedMonth}`;
      
      console.log('Từ tháng đã được format:', tuThangFormatted);
    }
    
    const keKhaiBHXH = {
      dot_ke_khai_id: this.dotKeKhaiId,
      thong_tin_the: {
        ma_so_bhxh: formValue.ma_so_bhxh,
        cccd: formValue.cccd,
        ho_ten: formValue.ho_ten,
        ngay_sinh: this.datePipe.transform(formValue.ngay_sinh, 'yyyy-MM-dd'),
        gioi_tinh: formValue.gioi_tinh,
        so_dien_thoai: formValue.so_dien_thoai,
        tinh_nkq: formValue.ma_tinh,
        huyen_nkq: formValue.ma_huyen,
        xa_nkq: formValue.ma_xa,
        dia_chi_nkq: formValue.dia_chi_nkq,
        ma_tinh_nkq: maTinh,
        ma_huyen_nkq: maHuyen,
        ma_xa_nkq: maXa,
        ma_tinh_ks: maTinh,
        ma_huyen_ks: maHuyen,
        ma_xa_ks: maXa,
        ma_hgd: formValue.ma_hgd,
        ma_dan_toc: formValue.ma_dan_toc
      },
      muc_thu_nhap: formValue.muc_thu_nhap,
      ty_le_dong: tyLeDong, // Sử dụng giá trị đã chuyển đổi
      ty_le_nsnn: formValue.ty_le_nsnn,
      loai_nsnn: formValue.loai_nsnn,
      tien_ho_tro: formValue.tien_ho_tro,
      so_tien_can_dong: formValue.so_tien_can_dong,
      phuong_thuc_dong: formValue.phuong_thuc_dong,
      thang_bat_dau: thangBatDauFormatted, // Sử dụng định dạng yyyy-MM
      tu_thang: tuThangFormatted, // Sử dụng định dạng yyyy-MM
      phuong_an: formValue.phuong_an,
      loai_khai_bao: loaiKhaiBao, // Luôn sử dụng giá trị '1'
      ngay_bien_lai: this.datePipe.transform(formValue.ngay_bien_lai, 'yyyy-MM-dd'),
      ghi_chu: formValue.ghi_chu,
      nguoi_tao: this.currentUser.username || 'unknown',
      is_urgent: false,
      tinh_nkq: tenTinh, // Tên tỉnh
      huyen_nkq: tenHuyen, // Tên huyện
      xa_nkq: tenXa, // Tên xã
      ma_nhan_vien: formValue.ma_nhan_vien // Thêm mã nhân viên vào dữ liệu gửi đi
    };

    console.log('Dữ liệu gửi đi:', keKhaiBHXH);
    console.log('Tỷ lệ đóng gửi đi:', keKhaiBHXH.ty_le_dong);
    console.log('Tỉnh NKQ gửi đi:', keKhaiBHXH.tinh_nkq);
    console.log('Mã tỉnh NKQ gửi đi:', keKhaiBHXH.thong_tin_the.ma_tinh_nkq);
    console.log('Huyện NKQ gửi đi:', keKhaiBHXH.huyen_nkq);
    console.log('Xã NKQ gửi đi:', keKhaiBHXH.xa_nkq);
    
    this.loading = true;
    this.keKhaiBHXHService.create(keKhaiBHXH).subscribe({
      next: (response) => {
        console.log('Phản hồi từ server:', response);
        this.message.success('Lưu thông tin kê khai BHXH thành công');
        this.loading = false;
        this.resetForm();
        this.loadData(); // Tải lại danh sách
      },
      error: (error) => {
        console.error('Lỗi khi lưu thông tin kê khai BHXH:', error);
        this.message.error('Có lỗi xảy ra khi lưu thông tin kê khai BHXH: ' + (error.error?.message || error.message));
        this.loading = false;
      }
    });
  }

  // Thêm phương thức để tính ty_le_dong
  calculateTyLeDong(): void {
    // Lấy giá trị từ form
    const mucThuNhap = this.form.get('muc_thu_nhap')?.value || 0;
    const soTienPhaiDong = this.form.get('so_tien_can_dong')?.value || 0;
    
    // Tính tỷ lệ đóng
    let tyLeDong = 0;
    if (mucThuNhap > 0) {
      tyLeDong = (soTienPhaiDong / mucThuNhap) * 100;
    }
    
    // Cập nhật giá trị vào form
    this.form.patchValue({
      ty_le_dong: tyLeDong
    });
    
    console.log('Tỷ lệ đóng đã tính:', tyLeDong);
  }

  // Xử lý khi người dùng chọn tháng bắt đầu
  onThangBatDauChange(date: Date): void {
    if (date) {
      // Cập nhật giá trị vào form
      this.form.patchValue({
        thang_bat_dau: date
      });
      
      // Format thành yyyy-MM để hiển thị
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const formattedMonth = month < 10 ? `0${month}` : `${month}`;
      const formattedDate = `${year}-${formattedMonth}`;
      
      console.log('Tháng bắt đầu đã được chọn:', formattedDate);
    }
  }

  deleteKeKhaiBHXH(id: number): void {
    this.modal.confirm({
      nzTitle: 'Xác nhận xóa',
      nzContent: 'Bạn có chắc chắn muốn xóa bản ghi này không?',
      nzOkText: 'Đồng ý',
      nzOkType: 'primary',
      nzOkDanger: true,
      nzOnOk: () => {
        this.loading = true;
        this.keKhaiBHXHService.delete(this.dotKeKhaiId, id).subscribe({
          next: () => {
            this.message.success('Xóa bản ghi thành công');
            this.loadData();
          },
          error: (error) => {
            this.message.error('Xóa bản ghi thất bại: ' + error.error?.message || error.message);
            this.loading = false;
          }
        });
      },
      nzCancelText: 'Hủy'
    });
  }

  // Thêm xử lý xóa nhiều bản ghi
  deleteSelectedRecords(): void {
    this.modal.confirm({
      nzTitle: 'Xác nhận xóa',
      nzContent: `Bạn có chắc chắn muốn xóa ${this.selectedIds.length} bản ghi đã chọn không?`,
      nzOkText: 'Đồng ý',
      nzOkType: 'primary',
      nzOkDanger: true,
      nzOnOk: () => {
        this.loading = true;
        const deletePromises = this.selectedIds.map(id => 
          this.keKhaiBHXHService.delete(this.dotKeKhaiId, id).toPromise()
        );

        Promise.all(deletePromises)
          .then(() => {
            this.message.success('Xóa thành công');
            this.selectedIds = [];
            this.loadData();
          })
          .catch(error => {
            console.error('Lỗi khi xóa các kê khai BHXH:', error);
            this.message.error('Có lỗi xảy ra khi xóa các kê khai BHXH');
          })
          .finally(() => {
            this.loading = false;
          });
      },
      nzCancelText: 'Hủy'
    });
  }

  // Xử lý sự kiện keyup
  onKeyUp(event: KeyboardEvent): void {
    if (event.key === 'Enter' && !this.isSearching) {
      this.searchBHXH();
    }
  }

  searchBHXH(): void {
    if (this.isSearching) {
      return;
    }

    const maSoBHXH = this.form.get('ma_so_bhxh')?.value;
    if (!maSoBHXH) {
      this.message.warning('Vui lòng nhập mã số BHXH để tìm kiếm!');
      return;
    }

    // Kiểm tra xem có đang ở chế độ ngoại tuyến không
    const userInfo = localStorage.getItem('ssmv2_user_info');
    const isOfflineMode = userInfo && JSON.parse(userInfo).mangLuoi === 'OFFLINE';

    // Kiểm tra token trước khi tìm kiếm (trừ khi đang ở chế độ ngoại tuyến)
    const token = this.ssmv2Service.getToken();
    if (!token && !isOfflineMode) {
      // Tự động mở form đăng nhập mà không hiển thị thông báo
      this.getCaptcha();
      this.isLoginVisible = true;
      return;
    }

    // Bắt đầu tìm kiếm
    this.isSearching = true;
    
    // Hiển thị loading
    const msgId = this.message.loading('Đang tìm kiếm thông tin...', { nzDuration: 0 }).messageId;
    
    // Nếu đang ở chế độ ngoại tuyến, tạo dữ liệu mẫu
    if (isOfflineMode) {
      setTimeout(() => {
        this.isSearching = false;
        this.message.remove(msgId);
        
        // Tạo dữ liệu mẫu dựa trên mã số BHXH
        const mockData = this.createMockData(maSoBHXH);
        this.processSearchResult(mockData);
        this.message.success('Tìm kiếm thông tin thành công (chế độ ngoại tuyến)!');
      }, 1500); // Giả lập độ trễ mạng
      return;
    }
    
    // Gọi API tìm kiếm
    this.keKhaiBHXHService.searchBHXH(maSoBHXH).subscribe({
      next: (response: SearchResponse) => {
        this.isSearching = false;
        this.message.remove(msgId);
        
        if (response.success && response.data) {
          // Xử lý dữ liệu trả về
          const fixedData = this.fixDiaChiData(response.data);
          this.processSearchResult(fixedData);
          this.message.success('Tìm kiếm thông tin thành công!');
        } else {
          this.message.error(response.message || 'Không tìm thấy thông tin!');
        }
      },
      error: (error: any) => {
        this.isSearching = false;
        this.message.remove(msgId);
        
        if (error.status === 401) {
          this.message.error('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại!');
          this.getAccessToken();
        } else {
          this.message.error('Lỗi khi tìm kiếm: ' + (error.error?.message || error.message || 'Không xác định'));
        }
      }
    });
  }

  // Tạo dữ liệu mẫu cho chế độ ngoại tuyến
  createMockData(maSoBHXH: string): any {
    // Tạo họ tên ngẫu nhiên
    const ho = ['Nguyễn', 'Trần', 'Lê', 'Phạm', 'Hoàng', 'Huỳnh', 'Phan', 'Vũ', 'Võ', 'Đặng'];
    const tenDem = ['Văn', 'Thị', 'Đức', 'Minh', 'Quang', 'Thanh', 'Hồng', 'Thành', 'Đình', 'Xuân'];
    const ten = ['Anh', 'Hùng', 'Hương', 'Thảo', 'Nam', 'Linh', 'Tuấn', 'Hà', 'Phương', 'Tùng'];
    
    const randomHo = ho[Math.floor(Math.random() * ho.length)];
    const randomTenDem = tenDem[Math.floor(Math.random() * tenDem.length)];
    const randomTen = ten[Math.floor(Math.random() * ten.length)];
    
    const hoTen = `${randomHo} ${randomTenDem} ${randomTen}`;
    
    // Tạo ngày sinh ngẫu nhiên (từ 1960 đến 2000)
    const year = Math.floor(Math.random() * (2000 - 1960) + 1960);
    const month = Math.floor(Math.random() * 12) + 1;
    const day = Math.floor(Math.random() * 28) + 1;
    const ngaySinh = new Date(year, month - 1, day);
    
    // Tạo CCCD ngẫu nhiên (12 số)
    let cccd = '';
    for (let i = 0; i < 12; i++) {
      cccd += Math.floor(Math.random() * 10).toString();
    }
    
    // Tạo giới tính ngẫu nhiên
    const gioiTinh = Math.random() > 0.5 ? 'Nam' : 'Nữ';
    
    // Tạo số điện thoại ngẫu nhiên
    let soDienThoai = '0';
    for (let i = 0; i < 9; i++) {
      soDienThoai += Math.floor(Math.random() * 10).toString();
    }
    
    // Trả về dữ liệu mẫu
    return {
      ma_so_bhxh: maSoBHXH,
      ho_ten: hoTen,
      ngay_sinh: ngaySinh,
      gioi_tinh: gioiTinh,
      cccd: cccd,
      so_dien_thoai: soDienThoai,
      dia_chi: {
        ma_tinh: '01',
        ten_tinh: 'Thành phố Hà Nội',
        ma_huyen: '001',
        ten_huyen: 'Quận Ba Đình',
        ma_xa: '00001',
        ten_xa: 'Phường Phúc Xá',
        dia_chi_chi_tiet: 'Số 123, đường ABC'
      }
    };
  }

  // Thêm phương thức lấy token
  getAccessToken(): void {
    console.log('Yêu cầu xác thực');
    this.isLoginVisible = true;
    
    // Đặt lại giá trị mặc định cho form đăng nhập
    this.loginForm.patchValue({
      userName: '884000_xa_tli_phuoclt',
      password: '123456d@D',
      text: ''
    });
    
    // Lấy captcha
    this.getCaptcha();
  }

  getCaptcha(): void {
    this.ssmv2Service.getCaptcha().subscribe({
      next: (res) => {
        console.log('Captcha response:', res);
        if (res && res.data) {
          // Đảm bảo dữ liệu hình ảnh có định dạng đúng
          // Kiểm tra xem dữ liệu hình ảnh đã có tiền tố data:image chưa
          if (res.data.image && !res.data.image.startsWith('data:image')) {
            this.captchaImage = 'data:image/png;base64,' + res.data.image;
          } else {
            this.captchaImage = res.data.image;
          }
          this.captchaCode = res.data.code;
          console.log('Captcha image URL:', this.captchaImage);
        } else {
          console.warn('Không nhận được dữ liệu captcha từ server, sử dụng captcha dự phòng');
          this.generateFallbackCaptcha();
          this.message.warning('Không thể kết nối đến máy chủ BHXH. Đang sử dụng captcha dự phòng.');
        }
      },
      error: (err) => {
        console.error('Captcha error:', err);
        console.warn('Lỗi khi lấy captcha từ server, sử dụng captcha dự phòng');
        this.generateFallbackCaptcha();
        this.message.warning('Không thể kết nối đến máy chủ BHXH. Đang sử dụng captcha dự phòng.');
      }
    });
  }

  handleLogin(): void {
    // Đánh dấu trường captcha là đã chạm vào để hiển thị lỗi
    const textControl = this.loginForm.get('text');
    if (textControl && textControl.invalid) {
      textControl.markAsTouched();
    }

    // Kiểm tra tính hợp lệ của trường captcha
    if (textControl && textControl.valid) {
      this.loadingLogin = true;
      
      // Kiểm tra xem có đang sử dụng captcha dự phòng không
      const userInput = this.loginForm.get('text')?.value;
      const isFallbackCaptcha = this.captchaImage && this.captchaImage.startsWith('data:image/png;base64,') && !this.captchaImage.includes('iVBORw0KGgoAAAANSUhEUgAAASwAAABs');
      
      if (isFallbackCaptcha) {
        // Nếu đang sử dụng captcha dự phòng, kiểm tra trực tiếp
        if (userInput.toUpperCase() === this.captchaCode) {
          // Xác thực thành công với captcha dự phòng
          this.loadingLogin = false;
          this.message.success('Xác thực thành công (chế độ ngoại tuyến)');
          this.isLoginVisible = false;
          
          // Lưu thông tin đăng nhập tạm thời
          const userInfo = {
            userName: this.loginForm.get('userName')?.value,
            name: 'Người dùng ngoại tuyến',
            mangLuoi: 'OFFLINE',
            donViCongTac: 'Chế độ ngoại tuyến',
            chucDanh: 'Người dùng'
          };
          localStorage.setItem('ssmv2_user_info', JSON.stringify(userInfo));
          
          // Đảm bảo token đã được lưu trước khi tìm kiếm
          setTimeout(() => {
            if (this.form.get('ma_so_bhxh')?.value) {
              console.log('Thực hiện tìm kiếm sau khi xác thực thành công (chế độ ngoại tuyến)');
              this.searchBHXH();
            }
          }, 2000);
        } else {
          this.loadingLogin = false;
          this.message.error('Mã xác thực sai');
          this.loginForm.patchValue({ text: '' });
          this.generateFallbackCaptcha();
        }
        return;
      }
      
      // Xử lý đăng nhập bình thường với server
      const data = {
        grant_type: 'password',
        userName: this.loginForm.get('userName')?.value,
        password: this.loginForm.get('password')?.value,
        text: this.loginForm.get('text')?.value,
        code: this.captchaCode,
        clientId: 'ZjRiYmI5ZTgtZDcyOC00ODRkLTkyOTYtMDNjYmUzM2U4Yjc5',
        isWeb: true
      };

      console.log('Gửi request xác thực với data:', { ...data, password: '***' });

      this.ssmv2Service.authenticate(data).subscribe({
        next: (response) => {
          this.loadingLogin = false;
          
          if (response.body?.access_token) {
            console.log('Xác thực thành công, token hết hạn sau:', response.body.expires_in, 'giây');
            this.message.success('Xác thực thành công');
            this.isLoginVisible = false;
            
            // Đảm bảo token đã được lưu trước khi tìm kiếm
            setTimeout(() => {
              if (this.form.get('ma_so_bhxh')?.value) {
                console.log('Thực hiện tìm kiếm sau khi xác thực thành công');
                this.searchBHXH();
              }
            }, 2000); // Tăng thời gian chờ lên 2 giây
          } else {
            this.message.error('Không nhận được token');
            this.getCaptcha();
          }
        },
        error: (err) => {
          console.error('Lỗi xác thực:', err);
          this.loadingLogin = false;
          this.loginForm.patchValue({ text: '' });

          if (err.error?.error === 'invalid_captcha') {
            this.message.error('Mã xác thực sai');
          } else if (err.error?.error_description?.includes('xác thực')) {
            this.message.error('Mã xác thực sai');
          } else if (err.error?.message) {
            this.message.error(err.error.message);
          } else {
            this.message.error('Xác thực thất bại, vui lòng thử lại');
          }

          setTimeout(() => {
            this.getCaptcha();
          }, 100);
        }
      });
    } else {
      this.message.warning('Vui lòng nhập mã xác nhận!');
    }
  }

  handleLoginCancel(): void {
    this.isLoginVisible = false;
    // Chỉ reset trường text, giữ nguyên tài khoản và mật khẩu mặc định
    this.loginForm.patchValue({
      text: ''
    });
  }

  // Tạo captcha dự phòng trong trường hợp không thể kết nối đến máy chủ
  generateFallbackCaptcha(): void {
    // Tạo mã captcha ngẫu nhiên gồm 6 ký tự
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let captchaCode = '';
    for (let i = 0; i < 6; i++) {
      captchaCode += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    this.captchaCode = captchaCode;
    
    // Tạo hình ảnh captcha đơn giản
    const canvas = document.createElement('canvas');
    canvas.width = 200;
    canvas.height = 80;
    const ctx = canvas.getContext('2d');
    
    if (ctx) {
      // Vẽ nền
      ctx.fillStyle = '#f0f2f5';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Vẽ text
      ctx.font = 'bold 36px Arial';
      ctx.fillStyle = '#1890ff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      // Thêm hiệu ứng nhiễu
      for (let i = 0; i < 100; i++) {
        ctx.fillStyle = `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.2)`;
        ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 2);
      }
      
      // Vẽ text với hiệu ứng nghiêng
      ctx.save();
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate((Math.random() - 0.5) * 0.2);
      ctx.fillText(captchaCode, 0, 0);
      ctx.restore();
      
      // Chuyển canvas thành base64 image
      this.captchaImage = canvas.toDataURL('image/png');
    }
    
    console.log('Đã tạo captcha dự phòng:', captchaCode);
  }

  convertToUpperCase(event: Event): void {
    const input = event.target as HTMLInputElement;
    const upperCaseValue = input.value.toUpperCase();
    
    if (input.value !== upperCaseValue) {
      input.value = upperCaseValue;
      this.loginForm.get('text')?.setValue(upperCaseValue, { emitEvent: false });
    }
  }

  // Phương thức để tải danh sách huyện theo tỉnh
  loadHuyensByTinh(maTinh: string): void {
    if (!maTinh) return;
    
    this.diaChiService.getDanhMucHuyenByMaTinh(maTinh).subscribe({
      next: (huyens: DanhMucHuyen[]) => {
        this.danhMucHuyens = huyens;
        console.log(`Đã tải ${huyens.length} huyện của tỉnh ${maTinh}`);
      },
      error: (error: any) => {
        console.error('Lỗi khi tải danh sách huyện:', error);
        this.message.error('Có lỗi xảy ra khi tải danh sách huyện');
      }
    });
  }

  // Phương thức để tính số tiền cần đóng
  calculateSoTienCanDong(): void {
    const mucThuNhap = this.form.get('muc_thu_nhap')?.value || 0;
    const tyLeDong = this.form.get('ty_le_dong')?.value || 0;
    const tyLeNSNN = this.form.get('ty_le_nsnn')?.value || 0;
    
    // Tính tiền hỗ trợ
    const tienHoTro = Math.round((mucThuNhap * tyLeNSNN) / 100);
    
    // Tính số tiền cần đóng
    const soTienCanDong = Math.round((mucThuNhap * tyLeDong) / 100) - tienHoTro;
    
    // Cập nhật form
    this.form.patchValue({
      tien_ho_tro: tienHoTro,
      so_tien_can_dong: soTienCanDong
    });
    
    console.log('Đã tính toán số tiền:', {
      mucThuNhap,
      tyLeDong,
      tyLeNSNN,
      tienHoTro,
      soTienCanDong
    });
  }

  // Phương thức định dạng ngày tháng
  private formatDate(dateStr: string): string {
    if (!dateStr) return '';
    
    // Kiểm tra nếu dateString đã ở định dạng yyyy-MM-dd
    if (dateStr.includes('-')) {
      const [year, month, day] = dateStr.split('-');
      const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
      console.log('Parsed date from yyyy-MM-dd:', date);
      return date.toISOString().split('T')[0];
    }
    
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return '';
    
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    
    return `${year}-${month}-${day}`;
  }

  // Phương thức để xử lý các sự kiện thay đổi giá trị form
  setupFormValueChanges(): void {
    console.log('Thiết lập các sự kiện theo dõi thay đổi của form');
    
    // Không cần thiết lập sự kiện cho tinh_nkq và huyen_nkq vì đã có onTinhChange và onHuyenChange
    // Chỉ thiết lập sự kiện cho các trường khác
    
    // Xử lý khi thay đổi mức thu nhập hoặc tỷ lệ đóng
    this.form.get('muc_thu_nhap')?.valueChanges.subscribe(() => {
      this.calculateSoTienCanDong();
      this.tinhSoTienPhaiDong(); // Gọi phương thức cũ nếu cần
    });

    this.form.get('ty_le_dong')?.valueChanges.subscribe(() => {
      this.calculateSoTienCanDong();
      this.tinhSoTienPhaiDong(); // Gọi phương thức cũ nếu cần
    });

    this.form.get('ty_le_nsnn')?.valueChanges.subscribe(() => {
      this.calculateSoTienCanDong();
      this.tinhSoTienPhaiDong(); // Gọi phương thức cũ nếu cần
    });

    this.form.get('phuong_thuc_dong')?.valueChanges.subscribe(() => {
      this.tinhSoTienPhaiDong(); // Gọi phương thức cũ
    });

    // Theo dõi thay đổi loại NSNN
    this.form.get('loai_nsnn')?.valueChanges.subscribe(loaiNSNN => {
      // Cập nhật tỷ lệ NSNN dựa trên loại NSNN
      let tyLeNSNN = 0;
      if (loaiNSNN === 'ngheo') {
        tyLeNSNN = 30;
      } else if (loaiNSNN === 'can_ngheo') {
        tyLeNSNN = 25;
      } else if (loaiNSNN === 'khac') {
        tyLeNSNN = 10;
      }
      
      this.form.patchValue({
        ty_le_nsnn: tyLeNSNN
      });
      
      // Tính lại số tiền cần đóng
      this.calculateSoTienCanDong();
      
      // Gọi phương thức cũ nếu cần
      this.onLoaiNSNNChange(loaiNSNN);
    });

    // Theo dõi thay đổi phương án
    this.form.get('phuong_an')?.valueChanges.subscribe(phuongAn => {
      this.onPhuongAnChange(phuongAn);
    });
  }

  // Phương thức để kiểm tra và sửa lỗi dữ liệu tỉnh, huyện, xã
  fixDiaChiData(data: any): any {
    // Clone dữ liệu để không ảnh hưởng đến dữ liệu gốc
    const fixedData = { ...data };
    
    // Kiểm tra mã tỉnh
    if (!fixedData.maTinhKs) {
      console.log('Không tìm thấy mã tỉnh trong dữ liệu API');
      
      // Thử tìm mã tỉnh từ danh sách tỉnh nếu có
      if (this.danhMucTinhs.length > 0) {
        // Nếu có mã huyện, thử tìm mã tỉnh từ mã huyện
        if (fixedData.maHuyenKs) {
          console.log('Tìm mã tỉnh từ mã huyện:', fixedData.maHuyenKs);
          const huyen = this.danhMucHuyens.find(h => h.ma === fixedData.maHuyenKs);
          if (huyen) {
            console.log('Đã tìm thấy mã tỉnh từ huyện:', huyen.ma_tinh);
            fixedData.maTinhKs = huyen.ma_tinh;
          }
        }
      }
    }
    
    // Nếu vẫn không có mã tỉnh, gán giá trị mặc định
    if (!fixedData.maTinhKs) {
      console.log('Không thể tìm thấy mã tỉnh, sử dụng giá trị mặc định');
      // Sử dụng mã tỉnh đầu tiên trong danh sách (nếu có)
      if (this.danhMucTinhs.length > 0) {
        fixedData.maTinhKs = this.danhMucTinhs[0].ma;
      }
    }
    
    // Kiểm tra và chuyển đổi các giá trị khác
    if (fixedData.phuongThuc && typeof fixedData.phuongThuc === 'string') {
      // Chuyển đổi phuongThuc từ chuỗi sang số nếu có thể
      const phuongThucNum = parseInt(fixedData.phuongThuc);
      if (!isNaN(phuongThucNum)) {
        fixedData.phuongThuc = phuongThucNum;
      }
    }
    
    // Đảm bảo các giá trị số là số
    if (fixedData.mucThuNhap && typeof fixedData.mucThuNhap === 'string') {
      fixedData.mucThuNhap = parseFloat(fixedData.mucThuNhap);
    }
    
    if (fixedData.tongTien && typeof fixedData.tongTien === 'string') {
      fixedData.tongTien = parseFloat(fixedData.tongTien);
    }
    
    if (fixedData.tienHoTro && typeof fixedData.tienHoTro === 'string') {
      fixedData.tienHoTro = parseFloat(fixedData.tienHoTro);
    }
    
    console.log('Dữ liệu sau khi sửa:', fixedData);
    return fixedData;
  }

  // Phương thức để xử lý dữ liệu từ API
  private processSearchResult(data: any): void {
    try {
      console.log('Processing search result:', data);
      
      // Log để kiểm tra giá trị giới tính từ API
      console.log('Giới tính từ API:', data.gioiTinh);
      
      // Kiểm tra và ghi log mã hộ gia đình từ API
      console.log('Mã hộ gia đình từ API:', data.maHoGiaDinh);
      
      // Xử lý dữ liệu cơ bản
      const processedData = {
        ...data,
        ngaySinh: this.parseDate(data.ngaySinh),
        gioiTinh: data.gioiTinh, // Giữ nguyên giá trị gốc
        thangBatDau: this.parseDate(data.thangBatDau),
        phuongThuc: parseInt(data.phuongThuc),
        mucThuNhap: parseFloat(data.mucThuNhap),
        tongTien: parseFloat(data.tongTien),
        tienHoTro: parseFloat(data.tienHoTro),
        maHoGiaDinh: data.maHoGiaDinh || '',
        maDanToc: data.danToc
      };

      // Format thangBatDau thành yyyy-MM
      if (processedData.thangBatDau) {
        const date = new Date(processedData.thangBatDau);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const formattedMonth = month < 10 ? `0${month}` : `${month}`;
        
        // Tạo chuỗi yyyy-MM
        const formattedDate = `${year}-${formattedMonth}`;
        
        console.log('Tháng bắt đầu đã được format:', formattedDate);
        
        // Lưu lại giá trị đã format
        processedData.thangBatDauFormatted = formattedDate;
      }
      
      // Cập nhật form với dữ liệu cơ bản
      const formData = {
        ma_so_bhxh: processedData.maSoBHXH,
        cccd: processedData.cmnd,
        ho_ten: processedData.hoTen,
        ngay_sinh: processedData.ngaySinh,
        gioi_tinh: processedData.gioiTinh === 1 || processedData.gioiTinh === '1' ? 'Nam' : 'Nữ',
        so_dien_thoai: processedData.dienThoaiLh,
        muc_thu_nhap: processedData.mucThuNhap,
        phuong_an: processedData.phuongAn,
        phuong_thuc_dong: processedData.phuongThuc,
        thang_bat_dau: processedData.thangBatDau,
        ty_le_dong: 22,
        tien_ho_tro: processedData.tienHoTro,
        so_tien_can_dong: processedData.tongTien,
        ma_hgd: processedData.maHoGiaDinh || '',
        ma_dan_toc: processedData.maDanToc || ''
      };

      console.log('Giới tính sau khi xử lý:', formData.gioi_tinh);
      
      this.form.patchValue(formData);

      // Xử lý địa chỉ
      if (processedData.maTinhKs) {
        this.form.patchValue({ ma_tinh: processedData.maTinhKs });
        
        // Load danh sách huyện
        this.diaChiService.getDanhMucHuyenByMaTinh(processedData.maTinhKs).subscribe({
          next: (huyens) => {
            this.danhMucHuyens = huyens;
            if (processedData.maHuyenKs) {
              this.form.patchValue({ ma_huyen: processedData.maHuyenKs });
              
              // Load danh sách xã
              this.diaChiService.getDanhMucXaByMaHuyen(processedData.maHuyenKs).subscribe({
                next: (xas) => {
                  this.danhMucXas = xas;
                  if (processedData.maXaKs) {
                    this.form.patchValue({ ma_xa: processedData.maXaKs });
                  }
                }
              });
            }
          }
        });
      }

      // Tính toán các giá trị liên quan
      this.tinhSoTienPhaiDong();

    } catch (error) {
      console.error('Lỗi khi xử lý dữ liệu từ API:', error);
      this.message.error('Có lỗi xảy ra khi xử lý dữ liệu');
    }
  }

  private parseDate(dateStr: string | null): Date | null {
    if (!dateStr) return null;
    
    console.log('Parsing date:', dateStr);
    
    try {
      if (typeof dateStr === 'string') {
        // Xử lý định dạng yyyy-MM-dd hoặc yyyy-MM
        if (dateStr.includes('-')) {
          const parts = dateStr.split('-');
          if (parts.length === 3) {
            // Định dạng yyyy-MM-dd
            const [year, month, day] = parts;
            const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            console.log('Parsed date from yyyy-MM-dd:', date);
            return date;
          } else if (parts.length === 2) {
            // Định dạng yyyy-MM
            const [year, month] = parts;
            // Tạo đối tượng Date với ngày 1
            const date = new Date(parseInt(year), parseInt(month) - 1, 1);
            console.log('Parsed date from yyyy-MM:', date);
            return date;
          }
        }
        
        // Xử lý định dạng dd/MM/yyyy hoặc MM/yyyy
        if (dateStr.includes('/')) {
          const parts = dateStr.split('/');
          if (parts.length === 3) {
            // Định dạng dd/MM/yyyy
            const [day, month, year] = parts;
            const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            console.log('Parsed date from dd/MM/yyyy:', date);
            return date;
          } else if (parts.length === 2) {
            // Định dạng MM/yyyy
            const [month, year] = parts;
            // Tạo đối tượng Date với ngày 1
            const date = new Date(parseInt(year), parseInt(month) - 1, 1);
            console.log('Parsed date from MM/yyyy:', date);
            return date;
          }
        }
        
        // Xử lý timestamp
        const timestamp = parseInt(dateStr);
        if (!isNaN(timestamp)) {
          const date = new Date(timestamp);
          console.log('Parsed date from timestamp:', date);
          return date;
        }
      }
      
      // Thử parse trực tiếp
      const date = new Date(dateStr);
      if (!isNaN(date.getTime())) {
        console.log('Parsed date directly:', date);
        return date;
      }
      
      console.log('Failed to parse date');
      return null;
    } catch (error) {
      console.error('Error parsing date:', error);
      return null;
    }
  }

  private parseGioiTinh(gioiTinh: any): string | null {
    if (gioiTinh === null || gioiTinh === undefined) return null;
    
    if (typeof gioiTinh === 'number') {
      return gioiTinh === 1 ? 'Nam' : 'Nữ';
    }
    
    if (typeof gioiTinh === 'string') {
      const gioiTinhLower = gioiTinh.toLowerCase();
      if (['nam', 'male', '1'].includes(gioiTinhLower)) return 'Nam';
      if (['nữ', 'nu', 'female', '0'].includes(gioiTinhLower)) return 'Nữ';
    }
    
    return null;
  }
}
````

## File: WebApp.Client/src/app/ke-khai/ke-khai-bhyt/ke-khai-bhyt.component.html
````html
<div class="ke-khai-bhyt-container">
  <nz-card class="form-card" [nzExtra]="extraTemplate" [nzTitle]="titleTemplate">
    <ng-template #titleTemplate>
      <div class="card-title">
        <div class="title-text">Kê khai bảo hiểm y tế</div>
      </div>
    </ng-template>
    <ng-template #extraTemplate>
      <div class="card-actions">
        <button nz-button nzType="default" class="mr-2 ripple" nzTooltip="Tra cứu mã số BHXH" (click)="showTraCuuMaSoBHXHModal()">
          <span nz-icon nzType="search" nzTheme="outline"></span>Tra cứu
        </button>
        <button nz-button nzType="default" class="mr-2 ripple" nzTooltip="Tìm nhiều mã số" (click)="showSearchMultipleModal()">
          <span nz-icon nzType="search" nzTheme="outline"></span>Tìm nhiều mã số
        </button>
        <button nz-button nzType="default" class="mr-2 ripple" nzTooltip="Nhập nhanh" (click)="showQuickInputModal()">
          <span nz-icon nzType="import" nzTheme="outline"></span>Nhập nhanh
        </button>
        <button 
          nz-button 
          nzType="primary" 
          class="ripple" 
          nzTooltip="Lưu thông tin"
          (click)="onSave()"
          [nzLoading]="loadingSave">
          <span nz-icon nzType="save" nzTheme="outline"></span>Lưu
        </button>
        <button *ngIf="isEdit" nz-button class="ripple" nzTooltip="Hủy" (click)="handleCancel()">
          <span nz-icon nzType="close" nzTheme="outline"></span>Hủy
        </button>
        <button 
          nz-button 
          nzType="primary" 
          class="ripple"
          nzTooltip="Gửi đợt kê khai"
          (click)="guiDotKeKhai()"
          [disabled]="!dotKeKhai || dotKeKhai.trang_thai === 'cho_thanh_toan' || keKhaiBHYTs.length === 0"
          [nzLoading]="loadingGui">
          <span nz-icon nzType="send" nzTheme="outline"></span>Gửi
        </button>
      </div>
    </ng-template>

    <!-- Thông báo về cấp số biên lai - đã ẩn -->
    <!-- <nz-alert *ngIf="dotKeKhai && dotKeKhai.trang_thai === 'chua_gui' && keKhaiBHYTs.length > 0"
      nzType="info"
      nzMessage="Lưu ý: Số biên lai sẽ được cấp tự động khi bấm nút Gửi"
      nzShowIcon
      class="bien-lai-alert">
    </nz-alert> -->
    
    <!-- Thông báo về biên lai điện tử -->
    <nz-alert *ngIf="dotKeKhai && dotKeKhai.trang_thai === 'chua_gui' && willUseBienLaiDienTu"
      nzType="info"
      nzMessage="Đợt kê khai này sẽ tự động sử dụng biên lai điện tử khi gửi"
      nzShowIcon
      class="bien-lai-alert">
    </nz-alert>

    <form nz-form [formGroup]="form">
      <div nz-row [nzGutter]="{ xs: 8, sm: 16, md: 24 }">
        <!-- Hàng 1 -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Mã số BHXH</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mã số BHXH (tối đa 10 số)">
              <div class="custom-input-group">
                <input nz-input 
                  formControlName="ma_so_bhxh" 
                  placeholder="Nhập mã số BHXH" 
                  maxlength="10"
                  (keypress)="onlyNumber($event)"
                  (keyup.enter)="$event.preventDefault(); onSearchBHYT()" />
                <button nz-button nzType="primary" class="pulse" nzTooltip="Tìm kiếm thông tin BHYT" (click)="onSearchBHYT()" [nzLoading]="loadingSearch">
                  <span nz-icon nzType="search"></span>
                </button>
              </div>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>CCCD</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập CCCD (12 số)">
              <div class="custom-input-group">
                <input nz-input 
                  formControlName="cccd" 
                  placeholder="Nhập CCCD" 
                  maxlength="12"
                  (keypress)="onlyNumber($event)" />
                <button nz-button nzType="primary" class="pulse" nzTooltip="Quét CCCD" (click)="showQuetCCCDModal()">
                  <span nz-icon nzType="idcard"></span>
                </button>
              </div>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Họ tên</nz-form-label>
            <nz-form-control [nzSpan]="24" [nzErrorTip]="hoTenErrorTpl">
              <input nz-input 
                formControlName="ho_ten" 
                placeholder="Nhập họ tên" 
                (blur)="validateHoTen()" />
              <ng-template #hoTenErrorTpl let-control>
                <ng-container *ngIf="control.hasError('required')">
                  Vui lòng nhập họ tên
                </ng-container>
                <ng-container *ngIf="control.hasError('invalidName')">
                  Họ tên không hợp lệ
                </ng-container>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Ngày sinh</nz-form-label>
            <nz-form-control [nzSpan]="24" [nzErrorTip]="ngaySinhErrorTpl">
              <input 
                nz-input
                formControlName="ngay_sinh"
                placeholder="Nhập ngày sinh (dd/MM/yyyy)"
                (blur)="onNgaySinhBlur($event)"
                (paste)="handleNgaySinhPaste($event)"
              />
              <ng-template #ngaySinhErrorTpl let-control>
                <ng-container *ngIf="control.hasError('required')">
                  Vui lòng nhập ngày sinh
                </ng-container>
                <ng-container *ngIf="control.hasError('pattern')">
                  Ngày sinh không đúng định dạng (dd/MM/yyyy hoặc yyyy)
                </ng-container>
                <ng-container *ngIf="control.hasError('invalidDate')">
                  Ngày sinh không hợp lệ
                </ng-container>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Giới tính</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn giới tính">
              <nz-select formControlName="gioi_tinh" nzPlaceHolder="Chọn giới tính">
                <nz-option nzValue="Nam" nzLabel="Nam"></nz-option>
                <nz-option nzValue="Nữ" nzLabel="Nữ"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Số điện thoại</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập đúng định dạng số điện thoại">
              <input nz-input formControlName="so_dien_thoai" placeholder="Nhập số điện thoại" (keypress)="onlyNumber($event)" />
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4" [style.display]="'none'">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Quốc tịch</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn quốc tịch">
              <nz-select 
                formControlName="quoc_tich" 
                nzPlaceHolder="Chọn quốc tịch"
                nzShowSearch
                [nzDropdownMatchSelectWidth]="false">
                <nz-option *ngFor="let country of countries" [nzValue]="country.ma" [nzLabel]="country.ten"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <!-- Giữ nguyên phần còn lại của form, chỉ thay đổi cấu trúc và class để phù hợp với thiết kế mới -->
      <div nz-row [nzGutter]="24">
        <!-- Hàng 2 -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Người thứ</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn người thứ">
              <nz-select formControlName="nguoi_thu" nzPlaceHolder="Chọn người thứ" [nzDisabled]="donViName.includes('DTTS')">
                <nz-option [nzValue]="1" nzLabel="Người thứ 1"></nz-option>
                <nz-option [nzValue]="2" nzLabel="Người thứ 2"></nz-option>
                <nz-option [nzValue]="3" nzLabel="Người thứ 3"></nz-option>
                <nz-option [nzValue]="4" nzLabel="Người thứ 4"></nz-option>
                <nz-option [nzValue]="5" nzLabel="Người thứ 5 trở đi"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Số tháng đóng</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn số tháng đóng">
              <nz-select formControlName="so_thang_dong" nzPlaceHolder="Chọn số tháng đóng">
                <nz-option [nzValue]="3" nzLabel="3 tháng"></nz-option>
                <nz-option [nzValue]="6" nzLabel="6 tháng"></nz-option>
                <nz-option [nzValue]="12" nzLabel="12 tháng"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Phương án đóng</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn phương án đóng">
              <nz-select formControlName="phuong_an_dong" nzPlaceHolder="Chọn phương án đóng">
                <nz-option nzValue="tang_moi" nzLabel="Tăng mới"></nz-option>
                <nz-option nzValue="dao_han" nzLabel="Đáo hạn"></nz-option>
                <nz-option nzValue="dung_dong" nzLabel="Dừng đóng"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Ẩn trường số tiền cần đóng -->
        <input type="hidden" formControlName="so_tien_can_dong">

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Hạn thẻ cũ</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <nz-date-picker 
                formControlName="han_the_cu" 
                nzFormat="dd/MM/yyyy"
                [nzLocale]="locale"
                [nzPlaceHolder]="'Chọn ngày'"
                [nzInputReadOnly]="true"
                class="w-100">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Hạn thẻ mới từ</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn hạn thẻ mới từ">
              <nz-date-picker 
                formControlName="han_the_moi_tu" 
                nzFormat="dd/MM/yyyy"
                [nzLocale]="locale"
                [nzPlaceHolder]="'Chọn ngày'"
                [nzInputReadOnly]="true"
                class="w-100">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Hạn thẻ mới đến</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn hạn thẻ mới đến">
              <nz-date-picker 
                formControlName="han_the_moi_den" 
                nzFormat="dd/MM/yyyy"
                [nzLocale]="locale"
                [nzPlaceHolder]="'Chọn ngày'"
                [nzInputReadOnly]="true"
                class="w-100">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Ẩn ô ngày biên lai -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4" style="display: none;">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Ngày biên lai</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <nz-date-picker 
                formControlName="ngay_bien_lai" 
                nzFormat="dd/MM/yyyy"
                [nzPlaceHolder]="'Chọn ngày'"
                [nzPopupStyle]="{ 'font-family': 'Arial' }"
                nzAllowClear>
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Hàng 3 -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Tỉnh NKQ</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn tỉnh">
              <nz-select formControlName="tinh_nkq" nzPlaceHolder="Chọn tỉnh" nzShowSearch (ngModelChange)="loadDanhMucHuyenByMaTinh($event)">
                <nz-option 
                  *ngFor="let tinh of danhMucTinhs" 
                  [nzValue]="tinh.ma"
                  [nzLabel]="tinh.ten">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Huyện NKQ</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn huyện">
              <nz-select formControlName="huyen_nkq" nzPlaceHolder="Chọn huyện" nzShowSearch (ngModelChange)="loadDanhMucXaByMaHuyen($event)">
                <nz-option 
                  *ngFor="let huyen of danhMucHuyens" 
                  [nzValue]="huyen.ma"
                  [nzLabel]="huyen.ten">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Xã NKQ</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn xã">
              <nz-select formControlName="xa_nkq" nzPlaceHolder="Chọn xã" nzShowSearch>
                <nz-option 
                  *ngFor="let xa of danhMucXas" 
                  [nzValue]="xa.ma"
                  [nzLabel]="xa.ten">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Địa chỉ NKQ</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập địa chỉ">
              <input nz-input formControlName="dia_chi_nkq" placeholder="Nhập địa chỉ nơi khám, chữa bệnh" />
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="8">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Bệnh viện (KCB ban đầu)</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn bệnh viện">
              <nz-select 
                formControlName="benh_vien_kcb" 
                nzPlaceHolder="Chọn bệnh viện" 
                nzShowSearch
                [nzFilterOption]="filterOption">
                <nz-option 
                  *ngFor="let benhVien of danhMucCSKCBs" 
                  [nzValue]="benhVien.value"
                  [nzLabel]="benhVien.ten">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Số thẻ BHYT -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4" [style.display]="'none'">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Số thẻ BHYT</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <input nz-input formControlName="so_the_bhyt" placeholder="Nhập số thẻ BHYT" />
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Huyện KS -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4" [style.display]="'none'">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Huyện KS</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <nz-select formControlName="ma_huyen_ks" nzPlaceHolder="Chọn huyện KS" nzShowSearch>
                <nz-option 
                  *ngFor="let huyen of danhMucHuyenKS" 
                  [nzValue]="huyen.ma"
                  [nzLabel]="huyen.ten">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Xã KS -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="4" [style.display]="'none'">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Xã KS</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <nz-select formControlName="ma_xa_ks" nzPlaceHolder="Chọn xã KS" nzShowSearch>
                <nz-option 
                  *ngFor="let xa of danhMucXaKS" 
                  [nzValue]="xa.ma"
                  [nzLabel]="xa.ten">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </form>
  </nz-card>

  <nz-card class="form-card" nzTitle="Danh sách kê khai">
    <div class="table-actions">
      <div class="left-actions">
        <button *ngIf="selectedIds.length > 0" nz-button nzType="primary" nzDanger class="ripple" (click)="deleteMultiple()">
          <span nz-icon nzType="delete" nzTheme="outline"></span>Xóa {{ selectedIds.length }} bản ghi đã chọn
        </button>
        <button 
          *ngIf="selectedIds.length > 0"
          nz-button 
          nzType="default" 
          class="ripple"
          (click)="copyNhieuMaSoBHXH()"
          nz-tooltip="Sao chép mã số BHXH đã chọn">
          <span nz-icon nzType="copy" nzTheme="outline"></span>Sao chép {{ selectedIds.length }} mã số BHXH
        </button>
        
        <!-- Bộ lọc người thứ -->
        <nz-select 
          [nzPlaceHolder]="'Lọc theo người thứ'"
          [(ngModel)]="filterNguoiThu"
          (ngModelChange)="onFilterNguoiThuChange($event)"
          [nzAllowClear]="true"
          style="width: 180px; margin-left: 16px;">
          <nz-option *ngFor="let option of nguoiThuOptions" [nzValue]="option" [nzLabel]="getNguoiThuText(option)"></nz-option>
        </nz-select>
        
        <!-- Bộ lọc số tháng đóng -->
        <nz-select 
          [nzPlaceHolder]="'Lọc theo số tháng đóng'"
          [(ngModel)]="filterSoThangDong"
          (ngModelChange)="onFilterSoThangDongChange($event)"
          [nzAllowClear]="true"
          style="width: 180px; margin-left: 8px;">
          <nz-option *ngFor="let option of soThangDongOptions" [nzValue]="option" [nzLabel]="option + ' tháng'"></nz-option>
        </nz-select>
        
        <button 
          *ngIf="hasActiveFilters()"
          nz-button 
          nzType="default" 
          class="ripple"
          (click)="clearFilters()"
          style="margin-left: 8px;">
          <span nz-icon nzType="clear" nzTheme="outline"></span>Xóa bộ lọc
        </button>
      </div>
      <div class="right-actions">
        <span>Tổng số thẻ: <strong>{{ thongKe.tongSoThe }}</strong></span>
        <nz-divider nzType="vertical"></nz-divider>
        <span>Đáo hạn: <strong>{{ thongKe.daoHan }}</strong></span>
        <nz-divider nzType="vertical"></nz-divider>
        <span>Tăng mới: <strong>{{ thongKe.tangMoi }}</strong></span>
        <nz-divider nzType="vertical"></nz-divider>
        <span>Dừng đóng: <strong>{{ thongKe.dungDong }}</strong></span>
        <nz-divider nzType="vertical"></nz-divider>
        <span>Tổng tiền: <strong class="amount">{{ thongKe.tongSoTien | number:'1.0-0' }}đ</strong></span>
      </div>
    </div>

    <nz-table
      #basicTable
      [nzData]="filterSoThangDong !== null || filterNguoiThu !== null ? filteredKeKhaiBHYTs : keKhaiBHYTs"
      [nzLoading]="loadingTable"
      [nzShowSizeChanger]="true"
      [nzShowPagination]="true"
      [nzScroll]="{ x: '1500px' }">
      <thead>
        <tr>
          <th [nzWidth]="'40px'" nzLeft [(nzChecked)]="isAllChecked" [nzIndeterminate]="isIndeterminate" (nzCheckedChange)="onAllChecked($event)"></th>
          <th [nzWidth]="'120px'" nzLeft nzColumnKey="ma_so_bhxh">Mã số BHXH</th>
          <th [nzWidth]="'180px'" nzLeft nzColumnKey="ho_ten">Họ tên</th>
          <th [nzWidth]="'120px'" nzAlign="center" nzColumnKey="cccd">CCCD</th>
          <th [nzWidth]="'120px'" nzAlign="center" nzColumnKey="ngay_sinh">Ngày sinh</th>
          <th [nzWidth]="'100px'" nzAlign="center" nzColumnKey="gioi_tinh">Giới tính</th>
          <th [nzWidth]="'120px'" nzAlign="center">Số điện thoại</th>
          <th [nzWidth]="'120px'" nzAlign="center" nzColumnKey="nguoi_thu">Người thứ</th>
          <th [nzWidth]="'150px'" nzAlign="center" nzColumnKey="phuong_an_dong">Phương án đóng</th>
          <th [nzWidth]="'120px'" nzAlign="center" nzColumnKey="so_thang_dong">Số tháng đóng</th>
          <th [nzWidth]="'180px'">Địa chỉ NKQ</th>
          <th [nzWidth]="'150px'">Xã NKQ</th>
          <th [nzWidth]="'150px'">Huyện NKQ</th>
          <th [nzWidth]="'150px'">Tỉnh NKQ</th>
          <th [nzWidth]="'250px'">Bệnh viện KCB</th>
          <th [nzWidth]="'150px'" nzAlign="right" nzRight nzColumnKey="so_tien_can_dong">Số tiền cần đóng</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of basicTable.data; let i = index" (click)="showEditForm(data)" class="table-row">
          <td nzLeft [nzChecked]="data.id ? selectedIds.includes(data.id) : false" (nzCheckedChange)="data.id && onKeKhaiChecked(data.id, $event)" (click)="$event.stopPropagation()"></td>
          <td nzLeft nzEllipsis>{{ data.thongTinThe.ma_so_bhxh }}</td>
          <td nzLeft nzEllipsis>{{ data.thongTinThe.ho_ten }}</td>
          <td nzAlign="center">{{ data.thongTinThe.cccd }}</td>
          <td nzAlign="center">
            <span *ngIf="data.thongTinThe.ngaySinhFormatted">{{ data.thongTinThe.ngaySinhFormatted }}</span>
            <span *ngIf="!data.thongTinThe.ngaySinhFormatted">{{ data.thongTinThe.ngay_sinh | date:'dd/MM/yyyy' }}</span>
          </td>
          <td nzAlign="center">{{ data.thongTinThe.gioi_tinh }}</td>
          <td nzAlign="center">{{ data.thongTinThe.so_dien_thoai }}</td>
          <td nzAlign="center">{{ getNguoiThuText(data.nguoi_thu) }}</td>
          <td nzAlign="center">{{ getPhuongAnDongText(data.phuong_an_dong) }}</td>
          <td nzAlign="center">{{ data.so_thang_dong }} tháng</td>
          <td nzEllipsis>{{ data.dia_chi_nkq }}</td>
          <td nzEllipsis>{{ data.xa_nkq }}</td>
          <td nzEllipsis>{{ data.huyen_nkq }}</td>
          <td nzEllipsis>{{ data.tinh_nkq }}</td>
          <td nzEllipsis>{{ data.benh_vien_kcb }}</td>
          <td nzAlign="right" nzRight>{{ data.so_tien_can_dong | number:'1.0-0' }} đ</td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>
</div>

<!-- Thêm modal tìm kiếm nhiều mã số vào cuối file -->
<nz-modal
  [(nzVisible)]="isSearchMultipleVisible"
  [nzTitle]="'Tìm kiếm nhiều mã số BHXH'"
  [nzWidth]="600"
  (nzOnCancel)="handleSearchMultipleCancel()"
  (nzOnOk)="handleSearchMultipleOk()"
  [nzOkText]="'Tìm kiếm'"
  [nzCancelText]="'Hủy'"
  [nzOkLoading]="isSearchingMultiple"
>
  <ng-container *nzModalContent>
    <!-- Thêm radio group để chọn chế độ -->
    <div style="margin-bottom: 16px;">
      <nz-radio-group [(ngModel)]="isHoGiaDinh" (ngModelChange)="onModeChange($event)">
        <label nz-radio [nzValue]="false">Thông thường</label>
        <label nz-radio [nzValue]="true">Theo Hộ gia đình</label>
      </nz-radio-group>
    </div>

    <!-- Textarea nhập mã số BHXH -->
    <textarea
      nz-input
      [(ngModel)]="multipleSearchText"
      [nzAutosize]="{ minRows: 4, maxRows: 8 }"
      placeholder="Nhập danh sách mã số BHXH, mỗi mã số một dòng"
      style="width: 100%; margin-bottom: 16px; resize: none;"
      (input)="onMultipleSearchTextInput($event)"
      (paste)="onMultipleSearchTextPaste($event)"
    ></textarea>

    <!-- Người thứ - Ẩn khi chọn chế độ Hộ gia đình -->
    <div style="margin-bottom: 16px;" *ngIf="!isHoGiaDinh">
      <div style="margin-bottom: 8px;">Người thứ:</div>
      <nz-select 
        [(ngModel)]="multipleSearchNguoiThu"
        [nzPlaceHolder]="'Chọn người thứ'"
        [nzDisabled]="donViName.includes('DTTS')"
        style="width: 100%;"
      >
        <nz-option [nzValue]="1" [nzLabel]="'Người thứ 1'"></nz-option>
        <nz-option [nzValue]="2" [nzLabel]="'Người thứ 2'"></nz-option>
        <nz-option [nzValue]="3" [nzLabel]="'Người thứ 3'"></nz-option>
        <nz-option [nzValue]="4" [nzLabel]="'Người thứ 4'"></nz-option>
        <nz-option [nzValue]="5" [nzLabel]="'Người thứ 5 trở đi'"></nz-option>
      </nz-select>
    </div>

    <!-- Người thứ bắt đầu - Chỉ hiển thị khi chọn chế độ Hộ gia đình -->
    <div style="margin-bottom: 16px;" *ngIf="isHoGiaDinh">
      <div style="margin-bottom: 8px;">Người thứ bắt đầu:</div>
      <nz-select 
        [(ngModel)]="hoGiaDinhStartIndex"
        [nzPlaceHolder]="'Chọn người thứ bắt đầu'"
        [nzDisabled]="donViName.includes('DTTS')"
        style="width: 100%;"
      >
        <nz-option [nzValue]="1" [nzLabel]="'Người thứ 1'"></nz-option>
        <nz-option [nzValue]="2" [nzLabel]="'Người thứ 2'"></nz-option>
        <nz-option [nzValue]="3" [nzLabel]="'Người thứ 3'"></nz-option>
        <nz-option [nzValue]="4" [nzLabel]="'Người thứ 4'"></nz-option>
        <nz-option [nzValue]="5" [nzLabel]="'Người thứ 5'"></nz-option>
      </nz-select>
    </div>

    <!-- Số tháng đóng -->
    <div style="margin-bottom: 16px;">
      <div style="margin-bottom: 8px;">Số tháng đóng:</div>
      <nz-select 
        [(ngModel)]="multipleSearchSoThangDong"
        [nzPlaceHolder]="'Chọn số tháng đóng'"
        style="width: 100%;"
      >
        <nz-option [nzValue]="3" [nzLabel]="'3 tháng'"></nz-option>
        <nz-option [nzValue]="6" [nzLabel]="'6 tháng'"></nz-option>
        <nz-option [nzValue]="12" [nzLabel]="'12 tháng'"></nz-option>
      </nz-select>
    </div>

    <!-- KCB ban đầu -->
    <div style="margin-bottom: 16px;">
      <div style="margin-bottom: 8px;">Bệnh viện KCB:</div>
      <nz-select 
        [(ngModel)]="multipleSearchBenhVien"
        [nzShowSearch]="true"
        [nzAllowClear]="true"
        [nzPlaceHolder]="'Chọn bệnh viện KCB'"
        style="width: 100%;"
      >
        <nz-option
          *ngFor="let bv of danhMucCSKCBs"
          [nzValue]="bv.value"
          [nzLabel]="bv.ten"
        ></nz-option>
      </nz-select>
    </div>

    <!-- Ghi chú -->
    <div style="color: rgba(0, 0, 0, 0.45); font-size: 12px;">
      <i nz-icon nzType="info-circle" nzTheme="outline"></i>
      <span style="margin-left: 8px;">
        {{ isHoGiaDinh ? 
          'Chế độ Hộ gia đình: Mã số đầu tiên sẽ là người thứ bắt đầu, mã số thứ hai là người thứ tiếp theo, và tiếp tục. Các mã số từ thứ 6 trở đi sẽ được gán là người thứ 5 trở đi' : 
          'Lưu ý: Mỗi mã số BHXH nhập trên một dòng' }}
      </span>
    </div>
  </ng-container>
</nz-modal>

<!-- Modal kết quả tìm kiếm -->
<nz-modal
  [(nzVisible)]="isSearchResultVisible"
  nzTitle="Kết quả tìm kiếm và tạo kê khai"
  (nzOnCancel)="handleSearchResultCancel()"
  [nzWidth]="800"
  [nzFooter]="null">
  
  <ng-container *nzModalContent>
    <div class="search-result-summary">
      <div class="total">
        Tổng số: {{ searchResults.length }} mã số
      </div>
      <div class="stats">
        <div class="success">
          Thành công: {{ getSuccessCount() }}
        </div>
        <div class="error">
          Thất bại: {{ getErrorCount() }}
        </div>
      </div>
    </div>

    <nz-tabset>
      <nz-tab [nzTitle]="'Thất bại (' + getErrorCount() + ')'">
        <div class="result-list">
          <ng-container *ngFor="let result of getErrorResults()">
            <div class="result-item error">
              <div class="result-header">
                <span class="label">Mã số BHXH:</span>
                <span class="value">{{ result.maSoBHXH }}</span>
              </div>
              <div class="result-message">
                {{ result.message }}
              </div>
            </div>
          </ng-container>
          <div *ngIf="getErrorCount() === 0" class="empty-message">
            Không có kê khai thất bại
          </div>
        </div>
      </nz-tab>

      <nz-tab [nzTitle]="'Thành công (' + getSuccessCount() + ')'">
        <div class="result-list">
          <ng-container *ngFor="let result of getSuccessResults()">
            <div class="result-item success">
              <div class="result-header">
                <span class="label">Mã số BHXH:</span>
                <span class="value">{{ result.maSoBHXH }}</span>
              </div>
              <div class="result-message">
                {{ result.message }}
              </div>
            </div>
          </ng-container>
          <div *ngIf="getSuccessCount() === 0" class="empty-message">
            Không có kê khai thành công
          </div>
        </div>
      </nz-tab>
    </nz-tabset>
  </ng-container>
</nz-modal>

<!-- Thêm template reference vào đầu file -->
<ng-template #naTemplate>N/A</ng-template>

<!-- Thay thế modal quét CCCD hiện tại bằng code sau -->
<nz-modal
  [(nzVisible)]="isQuetCCCDVisible"
  [nzTitle]="'Quét thông tin CCCD'"
  [nzWidth]="1200"
  (nzOnCancel)="handleQuetCCCDCancel()"
  [nzFooter]="modalFooter"
>
  <div *nzModalContent (paste)="handlePaste($event)" tabindex="0">
    <div class="paste-instruction" *ngIf="!avatarUrls.length">
      <i nz-icon nzType="scissor"></i>
      <span>Bạn có thể dán ảnh trực tiếp từ clipboard (Ctrl+V) hoặc nhấn nút bên dưới</span>
    </div>
    <div nz-row [nzGutter]="16">
      <div nz-col [nzSpan]="8">
        <nz-upload
          class="avatar-uploader"
          [nzShowUploadList]="false"
          [nzBeforeUpload]="beforeUpload"
          [nzMultiple]="true"
          (nzChange)="handleChange($event)"
        >
          <ng-container *ngIf="!avatarUrls.length">
            <i class="upload-icon" nz-icon [nzType]="loadingQuetCCCD ? 'loading' : 'plus'"></i>
            <div class="ant-upload-text">Tải ảnh CCCD lên</div>
            <div class="ant-upload-hint">Hỗ trợ tải nhiều ảnh cùng lúc</div>
          </ng-container>
          <div *ngIf="avatarUrls.length" class="image-preview-container">
            <img [src]="avatarUrls[currentImageIndex]" class="avatar" />
            <div class="image-navigation">
              <button nz-button nzType="text" (click)="previousImage()" [disabled]="currentImageIndex === 0">
                <i nz-icon nzType="left"></i>
              </button>
              <span>{{currentImageIndex + 1}}/{{avatarUrls.length}}</span>
              <button nz-button nzType="text" (click)="nextImage()" [disabled]="currentImageIndex === avatarUrls.length - 1">
                <i nz-icon nzType="right"></i>
              </button>
            </div>
          </div>
        </nz-upload>
        <div class="upload-actions" *ngIf="!avatarUrls.length">
          <button nz-button nzType="primary" (click)="requestPasteFromClipboard()">
            <i nz-icon nzType="copy"></i>Dán ảnh từ clipboard
          </button>
        </div>
        <div class="upload-actions" *ngIf="avatarUrls.length">
          <button nz-button (click)="clearImages()">
            <i nz-icon nzType="delete"></i>Xóa tất cả
          </button>
          <button nz-button nzType="primary" (click)="quetTatCaCCCD()" [nzLoading]="loadingQuetCCCD">
            <i nz-icon nzType="scan"></i>Quét tất cả
          </button>
        </div>
      </div>
      <div nz-col [nzSpan]="16">
        <nz-spin [nzSpinning]="loadingQuetCCCD">
          <nz-table 
            #basicTable 
            [nzData]="danhSachCCCD"
            [nzPageSize]="5"
            [nzShowPagination]="true"
            [nzLoading]="loadingQuetCCCD"
          >
            <thead>
              <tr>
                <th [nzWidth]="'60px'">
                  <label nz-checkbox 
                    [(ngModel)]="isAllChecked" 
                    (ngModelChange)="onAllChecked($event)"
                    [nzIndeterminate]="isIndeterminate">
                  </label>
                </th>
                <th>Số CCCD</th>
                <th>Họ tên</th>
                <th>Ngày sinh</th>
                <th>Giới tính</th>
                <th>Quê quán</th>
                <th>Nơi thường trú</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let cccd of basicTable.data">
                <td>
                  <label nz-checkbox 
                    [(ngModel)]="cccd.checked" 
                    (ngModelChange)="onCCCDChecked(cccd, $event)"
                    [nzDisabled]="cccd.status === 'error'">
                  </label>
                </td>
                <td>{{ cccd.id || 'N/A' }}</td>
                <td>{{ cccd.name || 'N/A' }}</td>
                <td>
                  <span *ngIf="cccd.ngaySinhFormatted">{{ cccd.ngaySinhFormatted }}</span>
                  <span *ngIf="!cccd.ngaySinhFormatted">{{ cccd.dob | date:'dd/MM/yyyy' }}</span>
                </td>
                <td>{{ cccd.gioiTinh || cccd.sex }}</td>
                <td>
                  <ng-container *ngIf="cccd.home_address; else naTemplate">
                    {{ formatFullAddress(cccd.home_address) }}
                  </ng-container>
                </td>
                <td>
                  <ng-container *ngIf="cccd.permanent_address; else naTemplate">
                    {{ formatFullAddress(cccd.permanent_address) }}
                  </ng-container>
                </td>
                <td>
                  <nz-tag [nzColor]="cccd.status === 'success' ? 'success' : 'error'">
                    {{ cccd.status === 'success' ? 'Thành công' : 'Thất bại' }}
                  </nz-tag>
                  <div *ngIf="cccd.status === 'error'" class="error-message">
                    {{ cccd.message }}
                  </div>
                </td>
                <td>
                  <button 
                    nz-button 
                    nz-tooltip
                    nzTooltipTitle="Sao chép thông tin"
                    nzType="link" 
                    (click)="copyThongTin(cccd)"
                  >
                    <i nz-icon nzType="copy"></i>
                  </button>
                  <button 
                    nz-button 
                    nz-tooltip
                    [nzTooltipTitle]="cccd.status === 'error' ? 'Không thể áp dụng thông tin lỗi' : 'Áp dụng thông tin'"
                    nzType="link" 
                    (click)="apDungThongTin(cccd)" 
                    [disabled]="cccd.status === 'error'"
                  >
                    <i nz-icon nzType="import"></i>
                  </button>
                </td>
              </tr>
              <tr *ngIf="danhSachCCCD.length === 0">
                <td colspan="9" class="ant-table-cell-empty">
                  <nz-empty 
                    [nzNotFoundContent]="'Chưa có dữ liệu. Vui lòng tải lên và quét CCCD'"
                  ></nz-empty>
                </td>
              </tr>
            </tbody>
          </nz-table>
        </nz-spin>
      </div>
    </div>
  </div>

  <ng-template #modalFooter>
    <div style="display: flex; align-items: center; gap: 16px;">
      <div class="address-options">
        <label nz-checkbox [(ngModel)]="applyPermanentAddress">
          Áp dụng địa chỉ thường trú
        </label>
        <label nz-checkbox [(ngModel)]="applyHomeAddress">
          Áp dụng quê quán
        </label>
      </div>

      <div style="flex: 1;"></div>
      
      <button nz-button (click)="copyNhieuThongTin()" [disabled]="!hasSelectedCCCD()">
        <i nz-icon nzType="copy"></i>Sao chép đã chọn
      </button>
      <button nz-button (click)="xuatTK1()" [disabled]="!hasSelectedCCCD()">
        <i nz-icon nzType="file-excel"></i>Xuất TK1
      </button>
      <button nz-button (click)="handleQuetCCCDCancel()">Đóng</button>
      <button 
        nz-button 
        nzType="primary" 
        (click)="apDungNhieuCCCD()"
        [disabled]="!hasSelectedCCCD() || (!applyPermanentAddress && !applyHomeAddress)"
        [nzLoading]="loadingApDung"
      >
        <i nz-icon nzType="import"></i>Áp dụng đã chọn
      </button>
    </div>
  </ng-template>
</nz-modal>

<!-- Thêm modal nhập nhanh -->
<nz-modal
  [(nzVisible)]="isQuickInputVisible"
  nzTitle="Nhập nhanh thông tin"
  (nzOnCancel)="handleQuickInputCancel()"
  (nzOnOk)="handleQuickInputOk()"
  [nzOkLoading]="isProcessing"
>
  <ng-container *nzModalContent>
    <form nz-form>
      <nz-form-item>
        <nz-form-label [nzSpan]="24">Dán thông tin vào đây</nz-form-label>
        <nz-form-control [nzSpan]="24">
          <textarea
            nz-input
            [(ngModel)]="quickInputText"
            name="quickInputText"
            [nzAutosize]="{ minRows: 4, maxRows: 8 }"
            placeholder="Ví dụ: 8923419792&#9;NGŨ THANH TÙNG&#9;Nam&#9;13/05/1978&#9;Tân Thuận, Tân Lợi, Tịnh Biên&#9;089078015892&#9;0986119811"
          ></textarea>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<!-- Thêm modal đăng nhập vào cuối file -->
<nz-modal
  [(nzVisible)]="isLoginVisible"
  [nzTitle]="'Xác thực captcha'"
  (nzOnCancel)="handleLoginCancel()"
  (nzOnOk)="handleLogin()"
  [nzOkText]="'Xác nhận'"
  [nzCancelText]="'Hủy'"
  [nzOkLoading]="loadingLogin">
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="loginForm">
      <!-- Ẩn input tài khoản và mật khẩu -->
      <input type="hidden" formControlName="userName">
      <input type="hidden" formControlName="password">

      <nz-form-item>
        <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mã xác nhận">
          <div class="captcha-container">
            <img [src]="'data:image/png;base64,' + captchaImage" alt="captcha" 
              style="margin-bottom: 8px; max-width: 100%;" />
            <div class="input-with-button">
              <input nz-input 
                formControlName="text" 
                placeholder="Nhập mã xác nhận"
                (input)="convertToUpperCase($event)"
                maxlength="4" />
              <button 
                nz-button 
                nzType="default"
                class="refresh-button"
                (click)="getCaptcha()">
                <i nz-icon nzType="reload"></i>
              </button>
            </div>
          </div>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<!-- Sửa lại modal tra cứu mã số BHXH -->
<nz-modal
  [(nzVisible)]="isTraCuuMaSoBHXHVisible"
  nzTitle="Tra cứu mã số BHXH"
  [nzWidth]="900"
  (nzOnCancel)="handleTraCuuMaSoBHXHCancel()"
  [nzFooter]="null">

  <ng-container *nzModalContent>
    <form nz-form [formGroup]="traCuuVNPostForm" class="tra-cuu-form">
      <div nz-row [nzGutter]="16">
        <!-- Tỉnh/Thành phố -->
        <div nz-col [nzXs]="24" [nzMd]="8">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Tỉnh/Thành phố</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn Tỉnh/Thành phố">
              <nz-select 
                formControlName="maTinh" 
                nzPlaceHolder="Chọn Tỉnh/Thành phố"
                nzShowSearch 
                [nzFilterOption]="filterOption"
                (ngModelChange)="onTinhChangeTraCuu($event)">
                <nz-option *ngFor="let tinh of danhSachTinhTraCuu" [nzValue]="tinh.ma" [nzLabel]="tinh.ten"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        
        <!-- Quận/Huyện -->
        <div nz-col [nzXs]="24" [nzMd]="8">
          <nz-form-item>
            <nz-form-label [nzSpan]="24" nzRequired>Quận/Huyện</nz-form-label>
            <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng chọn Quận/Huyện">
              <nz-select 
                formControlName="maHuyen" 
                nzPlaceHolder="Chọn Quận/Huyện"
                nzShowSearch 
                [nzFilterOption]="filterOption"
                (ngModelChange)="onHuyenChangeTraCuu($event)">
                <nz-option *ngFor="let huyen of huyenTheoTinhTraCuu" [nzValue]="huyen.ma" [nzLabel]="huyen.ten"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        
        <!-- Xã/Phường -->
        <div nz-col [nzXs]="24" [nzMd]="8">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Xã/Phường</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <nz-select 
                formControlName="maXa" 
                nzPlaceHolder="Chọn Xã/Phường"
                nzShowSearch 
                [nzFilterOption]="filterOption">
                <nz-option *ngFor="let xa of xaTheoHuyenTraCuu" [nzValue]="xa.ma" [nzLabel]="xa.ten"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <div nz-row [nzGutter]="16">
        <!-- Họ tên -->
        <div nz-col [nzXs]="24" [nzMd]="8">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Họ tên</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <input nz-input formControlName="hoTen" placeholder="Nhập họ tên" />
            </nz-form-control>
          </nz-form-item>
        </div>
        
        <!-- Ngày sinh -->
        <div nz-col [nzXs]="24" [nzMd]="8">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Ngày sinh</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <nz-date-picker 
                formControlName="ngaySinh" 
                nzFormat="dd/MM/yyyy"
                [nzPlaceHolder]="'Chọn ngày sinh'"
                class="w-100">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>
        
        <!-- Số CMND/CCCD -->
        <div nz-col [nzXs]="24" [nzMd]="8">
          <nz-form-item>
            <nz-form-label [nzSpan]="24">Số CMND/CCCD</nz-form-label>
            <nz-form-control [nzSpan]="24">
              <input nz-input formControlName="soCMND" placeholder="Nhập số CMND/CCCD" (keypress)="onlyNumber($event)" />
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <div nz-row [nzGutter]="16" class="btn-row">
        <div nz-col [nzSpan]="24" class="text-right">
          <button nz-button nzType="primary" (click)="submitTraCuuVNPostForm()" [nzLoading]="isLoadingTraCuu" class="mr-8">
            <span nz-icon nzType="search"></span> Tra cứu
          </button>
          <button nz-button nzType="default" (click)="resetTraCuuForm()" class="mr-8">
            <span nz-icon nzType="redo"></span> Làm mới
          </button>
          <button nz-button nzType="default" (click)="handleTraCuuMaSoBHXHCancel()">
            <span nz-icon nzType="close"></span> Đóng
          </button>
        </div>
      </div>
    </form>

    <!-- Hiển thị thông báo khi không tìm thấy hoặc có lỗi -->
    <nz-alert *ngIf="daTimKiem && loiTraCuu" [nzType]="'error'" [nzMessage]="loiTraCuu" nzShowIcon class="mb-3"></nz-alert>

    <!-- Hiển thị bảng kết quả -->
    <div *ngIf="daTimKiem && ketQuaTraCuu.length > 0" class="ket-qua-container">
      <h3>Kết quả tra cứu</h3>
      <nz-table 
        #ketQuaTable 
        [nzData]="ketQuaTraCuu" 
        [nzPageSize]="5"
        [nzBordered]="true"
        [nzScroll]="{ x: '1200px' }"
        [nzLoading]="isLoadingTraCuu">
        <thead>
          <tr>
            <th nzWidth="120px">Mã số BHXH</th>
            <th nzWidth="160px">Họ tên</th>
            <th nzWidth="120px">Ngày sinh</th>
            <th nzWidth="80px">Giới tính</th>
            <th nzWidth="130px">CCCD/CMND</th>
            <th nzWidth="120px">Mã hộ</th>
            <th>Địa chỉ</th>
            <th nzWidth="100px">Trạng thái</th>
            <th nzWidth="100px" nzRight>Thao tác</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of ketQuaTable.data">
            <td>{{ item.maSoBHXH }}</td>
            <td>{{ item.hoTen }}</td>
            <td>
              <span *ngIf="item.ngaySinhFormatted">{{ item.ngaySinhFormatted }}</span>
              <span *ngIf="!item.ngaySinhFormatted">{{ item.ngaySinh | date:'dd/MM/yyyy' }}</span>
            </td>
            <td>{{ item.gioiTinh }}</td>
            <td>{{ item.soCCCD }}</td>
            <td>{{ item.maHo }}</td>
            <td [attr.title]="item.diaChi">{{ item.diaChi || 'N/A' }}</td>
            <td>
              <nz-tag [nzColor]="item.trangThai === 'Đã duyệt' ? 'success' : 'warning'">{{ item.trangThai }}</nz-tag>
            </td>
            <td nzRight>
              <button nz-button nzType="primary" nzSize="small" (click)="apDungThongTinBHXH(item)" title="Áp dụng thông tin này">
                <span nz-icon nzType="import"></span> Áp dụng
              </button>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </div>
  </ng-container>
</nz-modal>
````

## File: WebApp.Client/src/app/ke-khai/ke-khai-bhyt/ke-khai-bhyt.component.scss
````scss
:host {
  display: block;
  background: #ffffff;
}

.ke-khai-bhyt-container {
  padding: 24px;
  background-color: #f5f7fa;
  min-height: 100vh;
  background-image: linear-gradient(to bottom right, rgba(24, 144, 255, 0.05), rgba(9, 109, 217, 0.05));

  .form-card {
    margin-bottom: 24px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    border: none;
    
    ::ng-deep .ant-card-head {
      border-bottom: 1px solid #f0f2f5;
      padding: 16px 24px;
      background: linear-gradient(to right, #fafafa, #f5f7fa);
      border-radius: 12px 12px 0 0;
      position: relative;
      overflow: hidden;
      
      &:before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(to right, #1890ff, #096dd9);
      }
      
      .ant-card-head-title {
        padding: 12px 0;
      }
      
      .card-actions {
        display: flex;
        gap: 8px;
      }
    }
    
    ::ng-deep .ant-card-body {
      padding: 24px;
    }
  }

  .dot-info {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding: 12px 16px;
    background-color: #f9f9f9;
    border-radius: 6px;
    border-left: 4px solid #1890ff;
    
    .dot-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: rgba(0, 0, 0, 0.65);
      
      i {
        color: #1890ff;
        font-size: 16px;
      }
    }
    
    .ant-divider {
      margin: 0 16px;
      height: 16px;
    }
  }

  .custom-input-group {
    display: flex;
    
    input {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }
    
    button {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      margin-left: -1px;
    }
  }

  .w-100 {
    width: 100%;
  }

  .mr-2 {
    margin-right: 8px;
  }

  // Style cho bảng dữ liệu
  .table-row {
    cursor: pointer;
  }
  
  .table-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 16px;
    
    .left-actions {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .right-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      
      .amount {
        color: #1890ff;
      }
    }
  }
  
  // Style cho bảng
  ::ng-deep .ant-table {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    
    .ant-table-container {
      border-radius: 12px;
      overflow: hidden;
    }
    
    .ant-table-thead > tr > th {
      background: linear-gradient(to right, #f5f7fa, #fafafa);
      font-weight: 600;
      padding: 16px;
      border-bottom: 2px solid #f0f2f5;
    }
    
    .ant-table-tbody > tr > td {
      padding: 12px 16px;
    }
  }
}

// Các style cho bảng dữ liệu
.data-table-container {
  margin-top: 24px;
  
  .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    
    h3 {
      margin-bottom: 0;
      font-size: 16px;
      font-weight: 600;
      color: #262626;
    }
    
    .table-actions {
      display: flex;
      gap: 8px;
    }
  }
  
  ::ng-deep .ant-table-thead > tr > th {
    background-color: #f5f7fa;
    font-weight: 600;
  }
  
  ::ng-deep .ant-table-tbody > tr:hover > td {
    background-color: #e6f7ff;
  }
  
  .action-column {
    display: flex;
    gap: 8px;
    justify-content: center;
    
    button {
      padding: 0 8px;
    }
  }
}

// Các style cho modal
::ng-deep .custom-modal {
  .ant-modal-header {
    border-bottom: 1px solid #f0f2f5;
    padding: 16px 24px;
    
    .ant-modal-title {
      font-size: 16px;
      font-weight: 600;
      color: #262626;
    }
  }
  
  .ant-modal-body {
    padding: 24px;
  }
  
  .ant-modal-footer {
    border-top: 1px solid #f0f2f5;
    padding: 12px 24px;
  }
}

// Responsive styles
@media (max-width: 768px) {
  .ke-khai-bhyt-container {
    padding: 16px;
    
    .form-card {
      ::ng-deep .ant-card-head {
        padding: 12px 16px;
      }
      
      ::ng-deep .ant-card-body {
        padding: 16px;
      }
    }
    
    .card-actions {
      flex-wrap: wrap;
    }
  }
  
  .data-table-container {
    .table-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
      
      .table-actions {
        width: 100%;
        flex-wrap: wrap;
      }
    }
  }
}

.container {
  padding: 24px;
  background: #ffffff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  min-height: calc(100vh - 48px);

  .header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    
    .header-info {
      h2 {
        margin-bottom: 8px;
        color: #262626;
        font-weight: 600;
      }

      .header-details {
        display: flex;
        align-items: center;
        color: rgba(0, 0, 0, 0.65);
        font-size: 14px;

        .detail-item {
          display: flex;
          align-items: center;
          gap: 8px;

          i {
            font-size: 16px;
            color: #1890ff;
          }
        }

        .ant-divider {
          margin: 0 16px;
          height: 16px;
        }
      }
    }

    .header-actions {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
  }
}

.form-card {
  margin-bottom: 24px;
  
  ::ng-deep {
    .ant-card-body {
      padding: 24px;
    }

    .ant-form-item {
      margin-bottom: 16px;
    }

    .ant-form-item-label {
      padding-bottom: 4px;
      
      label {
        color: rgba(0, 0, 0, 0.85);
        font-size: 14px;
        height: 22px;
        font-weight: 600 !important;
      }

      .ant-form-item-required::before {
        display: inline-block;
        margin-right: 4px;
        color: #ff4d4f;
        font-size: 14px;
        font-family: SimSun, sans-serif;
        line-height: 1;
        content: "*";
        font-weight: normal !important;
      }
    }

    nz-date-picker,
    nz-select,
    nz-input-number {
      width: 100%;
    }

    .ant-input-number {
      width: 100%;
    }
  }
}

nz-table {
  th, td {
    white-space: nowrap;
  }
  
  th:nth-child(7), 
  td:nth-child(7) {
    white-space: normal;
    max-width: 250px;
    min-width: 150px;
  }
  
  .ant-tag {
    margin-right: 0;
  }
}

.ket-qua-container {
  margin-top: 20px;
  overflow-x: auto;
  
  h3 {
    margin-bottom: 16px;
    font-weight: 500;
  }

  nz-table {
    /* Định dạng các cột trong bảng */
    .ant-table-thead > tr > th {
      background-color: #f5f7fa !important;
      font-weight: 600 !important;
      text-align: center;
      padding: 12px 8px;
    }
    
    .ant-table-tbody > tr > td {
      padding: 12px 8px;
      vertical-align: middle;
    }
    
    /* Đảm bảo cột địa chỉ hiển thị tốt */
    th:nth-child(7), 
    td:nth-child(7) {
      white-space: normal;
      max-width: 250px;
      min-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    
    /* Căn giữa trạng thái */
    th:nth-child(8), 
    td:nth-child(8) {
      text-align: center;
    }
    
    /* Căn giữa cột thao tác */
    th:nth-child(9), 
    td:nth-child(9) {
      text-align: center;
    }
    
    /* Sửa style cho nút áp dụng */
    button {
      width: 85px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      
      .anticon {
        font-size: 14px;
      }
    }
    
    /* Định dạng cho tag trạng thái */
    .ant-tag {
      margin-right: 0;
      width: 80px;
      text-align: center;
    }
  }
}

:host ::ng-deep {
  // Reset tất cả control về cùng kích thước
  .ant-input,
  .ant-select-selector,
  .ant-picker,
  nz-select,
  nz-date-picker {
    height: 36px !important;
  }

  // Style cho custom input group
  .custom-input-group {
    display: flex;
    position: relative;
    width: 100%;

    input {
      width: 100%;
      padding-right: 40px;
    }

    button {
      position: absolute;
      right: 0;
      top: 0;
      height: 100% !important;
      margin: 0;
      border: none;
      background: transparent;
      box-shadow: none;
      padding: 0 8px;
      border-radius: 0 2px 2px 0;

      &:hover {
        background: rgba(0, 0, 0, 0.03);
      }

      &:focus {
        outline: none;
      }

      i {
        font-size: 16px;
        color: rgba(0, 0, 0, 0.45);
      }
    }

    // Thêm style cho button primary (nút tìm kiếm)
    button[nzType="primary"] {
      border-left: 1px solid #d9d9d9;
      
      &:hover {
        background: #40a9ff;
      }

      i {
        color: #fff;
      }
    }
  }

  // Style cho các control khác
  .ant-select-selector {
    height: 36px !important;
    padding: 0 11px !important;
    display: flex !important;
    align-items: center !important;

    .ant-select-selection-item {
      line-height: 34px !important;
    }
  }

  .ant-picker {
    height: 36px !important;
    padding: 0 11px !important;
    
    .ant-picker-input {
      height: 36px !important;
      
      input {
        height: 36px !important;
      }
    }
  }

  // Điều chỉnh input placeholder
  .ant-input::placeholder,
  .ant-select-selection-placeholder,
  .ant-picker-input > input::placeholder {
    line-height: 36px !important;
  }

  // Style cho input disabled
  .ant-input[disabled] {
    color: #262626;
    background-color: transparent;
    border: none;
    cursor: default;
    padding-left: 0;
    font-weight: 500;

    &[nz-borderless] {
      border-bottom: 1px dashed #d9d9d9;
      border-radius: 0;
      
      &:hover {
        border-bottom-color: #40a9ff;
      }
    }
  }

  // Thêm styles cho descriptions trong modal quét CCCD
  .ant-descriptions {
    background: #fff;
    padding: 16px;
    border-radius: 4px;
    
    .ant-descriptions-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .ant-descriptions-item-label {
      font-weight: 500;
      color: rgba(0, 0, 0, 0.85);
      background: #fafafa;
    }

    .ant-descriptions-item-content {
      color: rgba(0, 0, 0, 0.65);
    }
  }

  // Đảm bảo input và button có cùng chiều cao
  .custom-input-group {
    .ant-input {
      height: 36px !important;
      line-height: 36px !important;
    }

    .ant-btn {
      height: 36px !important;
      line-height: 34px !important;
    }
  }

  nz-tag {
    min-width: 80px;
    text-align: center;
    margin: 0;
    
    &.ant-tag-blue {
      color: #1890ff;
      background: #e6f7ff;
      border-color: #91d5ff;
    }
    
    &.ant-tag-green {
      color: #52c41a;
      background: #f6ffed;
      border-color: #b7eb8f;
    }
    
    &.ant-tag-red {
      color: #ff4d4f;
      background: #fff1f0;
      border-color: #ffa39e;
    }
  }
}

nz-form-item {
  margin-bottom: 24px;
}

nz-date-picker {
  width: 100%;
}

nz-input-number {
  width: 100%;
}

[nz-input] {
  width: 100%;
}

.label-wrapper {
  font-weight: 500;
  color: rgba(0, 0, 0, 0.85);
}

/* Styles cho modal kết quả tìm kiếm */
.search-result-summary {
  text-align: center;
  margin-bottom: 24px;
  padding: 16px;
  background: #fafafa;
  border-radius: 4px;

  .total {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 8px;
  }

  .stats {
    display: flex;
    justify-content: center;
    gap: 32px;

    .success {
      color: #52c41a;
      font-weight: 500;
    }

    .error {
      color: #ff4d4f;
      font-weight: 500;
    }
  }
}

.result-list {
  max-height: 400px;
  overflow-y: auto;
  padding: 8px 0;

  .result-item {
    padding: 12px;
    margin-bottom: 12px;
    border-radius: 4px;
    
    &.success {
      background: #f6ffed;
      border: 1px solid #b7eb8f;

      .result-message {
        color: #52c41a;
      }
    }

    &.error {
      background: #fff1f0;
      border: 1px solid #ffa39e;

      .result-message {
        color: #ff4d4f;
      }
    }

    .result-header {
      margin-bottom: 8px;

      .label {
        font-weight: 500;
        margin-right: 8px;
      }

      .value {
        font-family: monospace;
      }
    }

    .result-message {
      font-size: 14px;
    }
  }

  .empty-message {
    text-align: center;
    color: #8c8c8c;
    padding: 16px;
  }
}

/* Custom scrollbar cho result-list */
.result-list::-webkit-scrollbar {
  width: 6px;
}

.result-list::-webkit-scrollbar-track {
  background: #f0f0f0;
  border-radius: 3px;
}

.result-list::-webkit-scrollbar-thumb {
  background: #d9d9d9;
  border-radius: 3px;
}

.result-list::-webkit-scrollbar-thumb:hover {
  background: #bfbfbf;
}

.avatar-uploader {
  width: 100%;
  height: 400px;
  border: 1px dashed #d9d9d9;
  border-radius: 8px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fafafa;

  &:hover {
    border-color: #1890ff;
  }

  .upload-icon {
    font-size: 32px;
    color: #999;
  }

  .ant-upload-text {
    margin-top: 8px;
    color: #666;
  }

  .image-preview-container {
    width: 100%;
    height: 100%;
    position: relative;
    display: flex;
    flex-direction: column;

    .avatar {
      width: 100%;
      height: calc(100% - 40px);
      object-fit: contain;
      padding: 8px;
    }

    .image-navigation {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      background: rgba(0, 0, 0, 0.03);
      padding: 0 16px;
      
      span {
        font-size: 14px;
        color: rgba(0, 0, 0, 0.85);
        min-width: 60px;
        text-align: center;
      }

      button {
        min-width: 32px;
        padding: 4px 8px;

        &:disabled {
          cursor: not-allowed;
          opacity: 0.5;
        }
      }
    }
  }
}

.ant-table-wrapper {
  margin-top: 16px;
}

.upload-actions {
  margin-top: 16px;
  display: flex;
  gap: 8px;
  justify-content: center;

  button {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 16px;

    i {
      font-size: 16px;
    }
  }
}

.ant-upload-hint {
  font-size: 12px;
  color: rgba(0, 0, 0, 0.45);
  margin-top: 4px;
}

.error-message {
  color: #ff4d4f;
  font-size: 12px;
  margin-top: 4px;
}

.ant-table-cell-empty {
  text-align: center;
  padding: 32px !important;
}

nz-tag {
  min-width: 80px;
  text-align: center;
}

.address-options {
  display: flex;
  gap: 16px;
  
  label {
    margin: 0;
  }
}

.urgent {
  color: #ff4d4f !important;
  font-weight: 500;
  cursor: pointer;
  
  &:hover {
    opacity: 0.85;
    text-decoration: underline;
  }
}

.urgent-icon {
  color: #ff4d4f !important;
}

// Thêm animation cho trạng thái gấp
@keyframes urgent-pulse {
  0% {
    opacity: 1;
  }
  50% {
    opacity: 0.6;
  }
  100% {
    opacity: 1;
  }
}

.urgent {
  animation: urgent-pulse 2s infinite;
}

.header-actions {
  button {
    i[nzType="key"] {
      color: #1890ff;
    }
  }
}

.captcha-container {
  display: flex;
  flex-direction: column;
  gap: 8px;

  .input-with-button {
    display: flex;
    position: relative;
    
    input {
      width: 100%;
      padding-right: 40px;
    }
    
    .refresh-button {
      position: absolute;
      right: 0;
      top: 0;
      height: 100%;
      margin: 0;
      border: none;
      background: transparent;
      box-shadow: none;
      padding: 0 8px;
      border-radius: 0 2px 2px 0;
      
      &:hover {
        background: rgba(0, 0, 0, 0.05);
      }
      
      i {
        font-size: 16px;
        color: rgba(0, 0, 0, 0.45);
      }
    }
  }
}

.bien-lai-alert {
  margin-bottom: 16px;
}

// Style cho modal quét CCCD
.paste-instruction {
  text-align: center;
  padding: 12px;
  background-color: #f6f6f6;
  border-radius: 4px;
  margin-bottom: 16px;
  border: 1px dashed #d9d9d9;
  
  i {
    margin-right: 8px;
    color: #1890ff;
  }
  
  span {
    color: rgba(0, 0, 0, 0.65);
  }
}

// Style cho avatar uploader trong modal quét CCCD
.avatar-uploader {
  width: 100%;
  min-height: 200px;
  margin-bottom: 16px;
}

.upload-actions {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 16px;
  
  button {
    display: flex;
    align-items: center;
    
    i {
      margin-right: 8px;
    }
  }
}

.image-preview-container {
  position: relative;
  
  .avatar {
    width: 100%;
    height: auto;
    max-height: 300px;
    object-fit: contain;
    border-radius: 4px;
  }
  
  .image-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    
    span {
      font-size: 14px;
      color: rgba(0, 0, 0, 0.65);
    }
  }
}

// Thêm style cho các thẻ nz-card
::ng-deep .ant-card + .ant-card {
  margin-top: 24px;
}

// Style cho các input và select
::ng-deep .ant-select, ::ng-deep .ant-picker {
  width: 100%;
}

/* Styles cho modal tra cứu mã số BHXH */
.tra-cuu-form {
  margin-bottom: 20px;
  padding: 16px 0;
}

.ket-qua-container {
  margin-top: 20px;
  overflow-x: auto;
  
  h3 {
    margin-bottom: 16px;
    font-weight: 500;
  }
}

.mb-3 {
  margin-bottom: 15px;
}

/* Điều chỉnh độ rộng nút tra cứu */
.custom-input-group {
  display: flex;

  button.pulse {
    margin-left: 5px;
  }
}

/* Style cho các nút trong modal */
.btn-row {
  margin-top: 20px;
  margin-bottom: 10px;
}

.text-right {
  text-align: right;
}

.mr-8 {
  margin-right: 8px;
}

/* Cải thiện hiển thị bảng kết quả tra cứu */
.ket-qua-container {
  nz-table {
    th, td {
      white-space: nowrap;
    }
    
    th:nth-child(7), 
    td:nth-child(7) {
      white-space: normal;
      max-width: 250px;
      min-width: 150px;
    }
    
    .ant-tag {
      margin-right: 0;
    }
  }
}

/* Responsive styles cho modal */
@media (max-width: 768px) {
  nz-date-picker {
    width: 100%;
  }
  
  .text-right {
    text-align: center;
  }
  
  .mr-8 {
    margin-right: 5px;
    margin-bottom: 8px;
  }
}
````

## File: WebApp.Client/src/app/ke-khai/ke-khai-bhyt/ke-khai-bhyt.component.ts
````typescript
import { Component, OnInit, OnDestroy, HostListener } from '@angular/core';
import { CommonModule, DatePipe } from '@angular/common';
import { FormBuilder, FormGroup, Validators, FormsModule, ReactiveFormsModule } from '@angular/forms';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzDatePickerModule } from 'ng-zorro-antd/date-picker';
import { NzSelectModule, NzFilterOptionType } from 'ng-zorro-antd/select';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzModalService } from 'ng-zorro-antd/modal';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzCardModule } from 'ng-zorro-antd/card';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzInputNumberModule } from 'ng-zorro-antd/input-number';
import { NzCheckboxModule } from 'ng-zorro-antd/checkbox';
import { KeKhaiBHYT, KeKhaiBHYTService, ThongTinThe, DanhMucCSKCB } from '../../services/ke-khai-bhyt.service';
import { DotKeKhai, DotKeKhaiService } from '../../services/dot-ke-khai.service';
import { DiaChiService, DanhMucTinh, DanhMucHuyen, DanhMucXa } from '../../services/dia-chi.service';
import { ActivatedRoute } from '@angular/router';
import { vi_VN } from 'ng-zorro-antd/i18n';
import { NzI18nService } from 'ng-zorro-antd/i18n';
import { registerLocaleData } from '@angular/common';
import vi from '@angular/common/locales/vi';
import { 
  SaveOutline,
  PlusOutline,
  CloseOutline,
  EditOutline,
  DeleteOutline,
  ReloadOutline,
  ApartmentOutline,
  CalendarOutline,
  IdcardOutline,
  SearchOutline,
  CopyOutline // Thêm icon Copy
} from '@ant-design/icons-angular/icons';
import { NzIconService } from 'ng-zorro-antd/icon';
import { DonViService, DonVi } from '../../services/don-vi.service';
import { NzTabsModule } from 'ng-zorro-antd/tabs';
import { NzUploadModule, NzUploadFile } from 'ng-zorro-antd/upload';
import { NzDescriptionsModule } from 'ng-zorro-antd/descriptions';
import { NzSpinModule } from 'ng-zorro-antd/spin';
import { CCCDService } from '../../services/cccd.service';
import { NzEmptyModule } from 'ng-zorro-antd/empty';
import { NzToolTipModule } from 'ng-zorro-antd/tooltip';
import { NzRadioModule } from 'ng-zorro-antd/radio';
import * as XLSX from 'xlsx';
import * as docx from 'docxtemplater';
import PizZip from 'pizzip';
import { saveAs } from 'file-saver';
import Docxtemplater from 'docxtemplater';
import { AuthService } from '../../services/auth.service';
import { SSMV2Service } from '../../services/ssmv2.service';
import { BienLaiService, BienLai } from '../../services/bien-lai.service';
import { NzAlertModule } from 'ng-zorro-antd/alert';
import { BHXHService, TraCuuVNPostRequest } from '../../services/tra-cuu-ma-so-bhxh.service';
import { LocationService, Province, District, Commune } from '../../services/location.service';
import { finalize } from 'rxjs/operators';

registerLocaleData(vi);

interface NoiNhanHoSo {
  diaChi?: string;
  tinh?: string;
  huyen?: string;
  xa?: string;
}

// Thêm interface để định nghĩa kiểu dữ liệu cho giới tính
type GioiTinh = 'Nam' | 'Nữ';

// Thêm các biến mới để lưu kết quả tìm kiếm
interface SearchResult {
  maSoBHXH: string;
  status: 'success' | 'error';
  message: string;
}

// Thêm interface để định nghĩa kiểu dữ liệu cho thông tin CCCD
interface ThongTinCCCD {
  id: string;                    // Số CCCD
  id_prob: string;              // Độ chính xác số CCCD
  name: string;                 // Họ và tên
  name_prob: string;            // Độ chính xác họ tên
  dob: string;                  // Ngày sinh
  dob_prob: string;             // Độ chính xác ngày sinh
  sex: string;                  // Giới tính
  sex_prob: string;             // Độ chính xác giới tính
  nationality: string;          // Quốc tịch
  nationality_prob: string;     // Độ chính xác quốc tịch
  home: string;                 // Quê quán
  home_prob: string;            // Độ chính xác quê quán
  address: string;              // Địa chỉ thường trú
  address_prob: string;         // Độ chính xác địa chỉ
  doe: string;                  // Ngày hết hạn
  doe_prob: string;             // Độ chính xác ngày hết hạn
  overall_score: string;        // Điểm tổng thể
  number_of_name_lines: string; // Số dòng tên
  address_entities: {           // Thông tin địa chỉ chi tiết
    province: string;           // Tỉnh/thành phố
    district: string;           // Quận/huyện
    ward: string;               // Phường/xã
    street: string;             // Đường/phố
  };
  type_new: string;             // Loại CCCD mới
  type: string;                 // Loại CCCD
}

// Thêm interface mới
interface CCCDResult {
  id: string;                    
  id_prob?: string;              
  name: string;                 
  name_prob?: string;            
  dob: string;                  
  dob_prob?: string;             
  sex: string;                  
  sex_prob?: string;             
  nationality: string;          
  nationality_prob?: string;     
  home?: string;                 
  home_prob?: string;            
  address: string;              
  address_prob?: string;         
  doe?: string;                  
  doe_prob?: string;             
  overall_score?: string;        
  number_of_name_lines?: string; 
  address_entities?: {           
    province: string;           
    district: string;           
    ward: string;               
    street?: string;             
  };
  type_new?: string;             
  type?: string;                 
  status: 'success' | 'error';
  message: string;
  checked?: boolean;
  home_address?: {
    province: string;
    district: string;
    ward: string;
    street?: string;
  };
  permanent_address?: {
    province: string;
    district: string;
    ward: string;
    street?: string;
  };
  // Thêm các thuộc tính phụ trợ để hiển thị
  ngaySinhFormatted?: string; // Ngày sinh định dạng
  gioiTinh?: string; // Giới tính dạng chữ (Nam/Nữ)
}

interface TinhThanh {
  ma: string;
  ten: string;
}

interface QuanHuyen {
  ma: string;
  ten: string;
  maTinh: string;
}

interface XaPhuong {
  ma: string;
  ten: string;
  maHuyen: string;
}

@Component({
  selector: 'app-ke-khai-bhyt',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    NzTableModule,
    NzButtonModule,
    NzIconModule,
    NzTagModule,
    NzModalModule,
    NzFormModule,
    NzInputModule,
    NzDatePickerModule,
    NzSelectModule,
    NzDividerModule,
    NzCardModule,
    NzGridModule,
    NzInputNumberModule,
    NzCheckboxModule,
    DatePipe,
    NzTabsModule,
    NzUploadModule,
    NzDescriptionsModule,
    NzSpinModule,
    NzEmptyModule,
    NzToolTipModule,
    NzRadioModule,
    NzAlertModule
  ],
  templateUrl: './ke-khai-bhyt.component.html',
  styleUrls: ['./ke-khai-bhyt.component.scss']
})
export class KeKhaiBHYTComponent implements OnInit, OnDestroy {
  keKhaiBHYTs: KeKhaiBHYT[] = [];
  filteredKeKhaiBHYTs: KeKhaiBHYT[] = []; // Thêm biến để lưu kết quả lọc
  thongTinThe: ThongTinThe | null = null;
  dotKeKhai: DotKeKhai | null = null;
  loadingSearch = false; // Thêm biến loading cho tìm kiếm
  loadingTable = false; // Thêm biến loading cho bảng
  isVisible = false;
  isEdit = false;
  form!: FormGroup;
  currentUser: any = {};
  selectedIds: number[] = [];
  dotKeKhaiId: number = 0;
  isAllChecked = false;
  isIndeterminate = false;
  loadingApDung = false;
  danhMucTinhs: DanhMucTinh[] = [];
  danhMucHuyens: DanhMucHuyen[] = [];
  danhMucXas: DanhMucXa[] = [];
  danhMucCSKCBs: DanhMucCSKCB[] = [];
  danhMucHuyenKS: DanhMucHuyen[] = [];
  danhMucXaKS: DanhMucXa[] = [];
  donViName: string = '';
  private donViCache: DonVi[] = [];
  isSearchMultipleVisible = false;
  isSearchingMultiple = false;
  multipleSearchText = '';
  multipleSearchNguoiThu: number = 1;
  multipleSearchSoThangDong: number = 3;
  // Thêm biến để lưu bệnh viện được chọn
  multipleSearchBenhVien: string = '';
  // Thêm biến để lưu người thứ bắt đầu trong chế độ hộ gia đình
  hoGiaDinhStartIndex: number = 1;

  // Thêm biến lọc số tháng đóng
  filterSoThangDong: number | null = null;
  // Thêm biến lọc người thứ
  filterNguoiThu: number | null = null;
  // Danh sách các lựa chọn số tháng đóng phổ biến
  soThangDongOptions: number[] = [1, 3, 6, 12];
  // Danh sách các lựa chọn người thứ
  nguoiThuOptions: number[] = [1, 2, 3, 4, 5];

  // Thêm các biến thống kê
  thongKe = {
    daoHan: 0,
    tangMoi: 0,
    dungDong: 0,
    tongSoTien: 0,
    tongSoThe: 0
  };

  isSearchResultVisible = false;
  searchResults: SearchResult[] = [];
  isQuetCCCDVisible = false;
  loadingQuetCCCD = false;
  avatarUrl?: string;
  thongTinCCCD: ThongTinCCCD | null = null;

  avatarUrls: string[] = [];
  currentImageIndex = 0;
  danhSachCCCD: CCCDResult[] = [];
  pendingFiles: File[] = [];

  // Thêm thuộc tính mới
  applyPermanentAddress = true;
  applyHomeAddress = false;

  // Thêm biến để theo dõi trạng thái loading khi lưu
  loadingSave = false;
  loadingGui = false;

  // Thêm các thuộc tính cho modal nhập nhanh
  isQuickInputVisible = false;
  isProcessing = false;
  quickInputText = '';

  accessToken: string = '';
  loadingToken = false;

  isLoginVisible = false;
  captchaImage = '';
  captchaCode = '';
  loginForm: FormGroup;
  loadingLogin = false;

  // Thêm thuộc tính mới
  isHoGiaDinh = false; // Thêm biến để theo dõi chế độ Hộ gia đình

  // Thêm các biến cache để lưu trữ dữ liệu đã tải
  private tinhCache: Map<string, any[]> = new Map(); // Cache danh sách tỉnh
  private huyenCache: Map<string, any[]> = new Map(); // Cache danh sách huyện theo mã tỉnh
  private xaCache: Map<string, any[]> = new Map(); // Cache danh sách xã theo mã huyện

  // Thêm các hằng số để lưu trữ cache
  private readonly TINH_CACHE_KEY = 'bhyt_tinh_cache';
  private readonly HUYEN_CACHE_PREFIX = 'bhyt_huyen_cache_';
  private readonly XA_CACHE_PREFIX = 'bhyt_xa_cache_';

  // Thêm biến theo dõi đã tải dữ liệu hay chưa
  private dataInitialized = false;

  // Thêm biến locale cho DatePicker
  locale = {
    lang: {
      placeholder: 'Chọn ngày',
      rangePlaceholder: ['Ngày bắt đầu', 'Ngày kết thúc'],
      today: 'Hôm nay',
      now: 'Bây giờ',
      backToToday: 'Trở về hôm nay',
      ok: 'Đồng ý',
      clear: 'Xóa',
      month: 'Tháng',
      year: 'Năm',
      timeSelect: 'Chọn giờ',
      dateSelect: 'Chọn ngày',
      monthSelect: 'Chọn tháng',
      yearSelect: 'Chọn năm',
      decadeSelect: 'Chọn thập kỷ',
      yearFormat: 'YYYY',
      dateFormat: 'DD/MM/YYYY',
      dayFormat: 'DD',
      dateTimeFormat: 'DD/MM/YYYY HH:mm:ss',
      monthBeforeYear: true,
      previousMonth: 'Tháng trước',
      nextMonth: 'Tháng sau',
      previousYear: 'Năm trước',
      nextYear: 'Năm sau',
      previousDecade: 'Thập kỷ trước',
      nextDecade: 'Thập kỷ sau',
      previousCentury: 'Thế kỷ trước',
      nextCentury: 'Thế kỷ sau'
    },
    timePickerLocale: {
      placeholder: 'Chọn giờ'
    }
  };

  // Thêm biến countries cho danh sách quốc tịch
  countries = [
    { ma: 'VN', ten: 'Việt Nam' },
    { ma: 'US', ten: 'Hoa Kỳ' },
    { ma: 'CN', ten: 'Trung Quốc' },
    { ma: 'JP', ten: 'Nhật Bản' },
    { ma: 'KR', ten: 'Hàn Quốc' },
    { ma: 'GB', ten: 'Anh' },
    { ma: 'FR', ten: 'Pháp' },
    { ma: 'DE', ten: 'Đức' },
    { ma: 'SG', ten: 'Singapore' },
    { ma: 'TH', ten: 'Thái Lan' },
    { ma: 'LA', ten: 'Lào' },
    { ma: 'KH', ten: 'Campuchia' },
    { ma: 'MY', ten: 'Malaysia' },
    { ma: 'AU', ten: 'Úc' },
    { ma: 'CA', ten: 'Canada' }
  ];

  // Thêm thuộc tính cho modal tra cứu mã số BHXH
  isTraCuuMaSoBHXHVisible = false;
  traCuuVNPostForm!: FormGroup;
  isLoadingTraCuu = false;
  ketQuaTraCuu: any[] = [];
  daTimKiem = false;
  loiTraCuu = '';

  danhSachTinhTraCuu: TinhThanh[] = [];
  danhSachHuyenTraCuu: QuanHuyen[] = [];
  danhSachXaTraCuu: XaPhuong[] = [];

  huyenTheoTinhTraCuu: QuanHuyen[] = [];
  xaTheoHuyenTraCuu: XaPhuong[] = [];

  // Thêm biến class thành viên mới
  willUseBienLaiDienTu = false;
  
  constructor(
    private keKhaiBHYTService: KeKhaiBHYTService,
    private dotKeKhaiService: DotKeKhaiService,
    private diaChiService: DiaChiService,
    private message: NzMessageService,
    private modal: NzModalService,
    private fb: FormBuilder,
    private route: ActivatedRoute,
    private i18n: NzI18nService,
    private iconService: NzIconService,
    private donViService: DonViService,
    private cccdService: CCCDService,
    private authService: AuthService,
    private ssmv2Service: SSMV2Service,
    private bienLaiService: BienLaiService,
    private bhxhService: BHXHService,
    private locationService: LocationService
  ) {
    this.i18n.setLocale(vi_VN);
    this.iconService.addIcon(
      SaveOutline,
      PlusOutline,
      CloseOutline,
      EditOutline,
      DeleteOutline,
      ReloadOutline,
      ApartmentOutline,
      CalendarOutline,
      IdcardOutline,  // Thêm vào danh sách
      SearchOutline,   // Thêm vào danh sách
      CopyOutline // Thêm vào danh sách
    );
    this.initForm();
    
    // Khởi tạo form trong constructor
    this.loginForm = this.fb.group({
      userName: ['884000_xa_tli_phuoclt'], // Tài khoản mặc định
      password: ['123456d@D'], // Mật khẩu mặc định  
      text: ['', [
        Validators.required,
        Validators.minLength(4),
        Validators.maxLength(4)
      ]] // Validate độ dài 4 ký tự
    });
  }

  ngOnInit(): void {
    // Lấy thông tin user từ localStorage
    const userStr = localStorage.getItem('user');
    if (userStr) {
      this.currentUser = JSON.parse(userStr);
      console.log('currentUser trong component:', this.currentUser);
    }
    
    // Các phần khởi tạo khác
    this.loadingTable = true;
    this.route.params.subscribe(params => {
      this.dotKeKhaiId = +params['id'];
      this.loadDotKeKhai();
      this.loadData();
    });

    // Khởi tạo form
    this.initForm();

    // Load danh mục CSKCB một lần duy nhất ở đây
    this.loadDanhMucCSKCB();

    // Subscribe to changes in tinh_nkq to load huyện NKQ
    this.form.get('tinh_nkq')?.valueChanges.subscribe(maTinh => {
      if (maTinh) {
        this.loadDanhMucHuyenByMaTinh(maTinh);
      } else {
        this.danhMucHuyens = [];
        this.danhMucXas = [];
        this.form.patchValue({
          huyen_nkq: null,
          xa_nkq: null
        });
      }
    });

    // Subscribe to changes in huyen_nkq to load xã NKQ
    this.form.get('huyen_nkq')?.valueChanges.subscribe(maHuyen => {
      if (maHuyen) {
        this.loadDanhMucXaByMaHuyen(maHuyen);
      } else {
        this.danhMucXas = [];
        this.form.patchValue({
          xa_nkq: null
        });
      }
    });

    // Subscribe to changes in ma_tinh_ks to load huyện KS
    this.form.get('ma_tinh_ks')?.valueChanges.subscribe(maTinh => {
      console.log('ma_tinh_ks changed:', maTinh);
      if (maTinh) {
        // Tạo một biến riên để lưu danh sách huyện KS
        this.diaChiService.getDanhMucHuyenByMaTinh(maTinh).subscribe({
          next: (huyens) => {
            this.danhMucHuyenKS = huyens.sort((a, b) => a.ten.localeCompare(b.ten, 'vi'));
            console.log('Loaded huyện KS:', this.danhMucHuyenKS);
          },
          error: (error) => {
            console.error('Error loading huyện KS:', error);
            this.message.error('Có lỗi xảy ra khi tải danh sách quận/huyện KS');
          }
        });
      } else {
        this.danhMucHuyenKS = [];
        this.danhMucXaKS = [];
        this.form.patchValue({
          ma_huyen_ks: null,
          ma_xa_ks: null
        });
      }
    });

    // Subscribe to changes in ma_huyen_ks to load xã KS
    this.form.get('ma_huyen_ks')?.valueChanges.subscribe(maHuyen => {
      console.log('ma_huyen_ks changed:', maHuyen);
      if (maHuyen) {
        // Tạo một biến riên để lưu danh sách xã KS
        this.diaChiService.getDanhMucXaByMaHuyen(maHuyen).subscribe({
          next: (xas) => {
            this.danhMucXaKS = xas.sort((a, b) => a.ten.localeCompare(b.ten, 'vi'));
            console.log('Loaded xã KS:', this.danhMucXaKS);
          },
          error: (error) => {
            console.error('Error loading xã KS:', error);
            this.message.error('Có lỗi xảy ra khi tải danh sách xã/phường KS');
          }
        });
      } else {
        this.danhMucXaKS = [];
        this.form.patchValue({
          ma_xa_ks: null
        });
      }
    });

    // Subscribe to changes in han_the_cu
    this.form.get('han_the_cu')?.valueChanges.subscribe(value => {
      if (value) {
        const hanTheCu = new Date(value);
        const phuongAnDong = this.checkPhuongAnDong(hanTheCu);
        this.form.patchValue({
          phuong_an_dong: phuongAnDong
        }, { emitEvent: false });
      } else {
        // Nếu không có hạn thẻ cũ -> tăng mới
        this.form.patchValue({
          phuong_an_dong: 'tang_moi'
        }, { emitEvent: false });
      }
    });

    // Subscribe cho benh_vien_kcb đang có vấn đề
    this.form.get('benh_vien_kcb')?.valueChanges.subscribe(value => {
      if (value) {
        const benhVien = this.danhMucCSKCBs.find(bv => bv.value === value);
        if (benhVien) {
          this.form.patchValue({
            ma_benh_vien: benhVien.value
          }, { emitEvent: false });
        }
      }
    });

    // Thêm subscription cho nguoi_thu và so_thang_dong
    this.form.get('nguoi_thu')?.valueChanges.subscribe(() => {
      this.capNhatSoTienCanDong();
    });

    this.form.get('so_thang_dong')?.valueChanges.subscribe(soThangDong => {
      if (soThangDong) {
        const hanTheMoiTu = this.form.get('han_the_moi_tu')?.value;
        if (hanTheMoiTu) {
          const hanTheMoiDen = this.tinhHanTheMoiDen(new Date(hanTheMoiTu), soThangDong);
          this.form.patchValue({
            han_the_moi_den: hanTheMoiDen
          }, { emitEvent: false });
        }
      }
    });

    // Subscribe to changes in ngay_bien_lai and han_the_cu
    this.form.get('ngay_bien_lai')?.valueChanges.subscribe(() => {
      this.capNhatHanThe();
    });

    // Subscribe to changes in han_the_cu
    this.form.get('han_the_cu')?.valueChanges.subscribe(() => {
      this.capNhatHanThe();
    });

    // Subscribe to changes in so_thang_dong
    this.form.get('so_thang_dong')?.valueChanges.subscribe(() => {
      this.capNhatSoTienCanDong();
    });

    // Tải danh sách tỉnh khi component được khởi tạo
    this.loadDanhMucTinh().then(() => {
      console.log('Đã tải danh sách tỉnh thành công');
    });

    // Khởi tạo form tra cứu VNPost
    this.traCuuVNPostForm = this.fb.group({
      maTinh: [null, [Validators.required]],
      maHuyen: [null, [Validators.required]],
      maXa: [null],
      hoTen: [null],
      ngaySinh: [null],
      soCMND: [null]
    });

    // Load danh sách tỉnh cho tra cứu
    this.loadDanhSachTinhTraCuu();
  }

  ngOnDestroy(): void {
    localStorage.removeItem('urgentItems');
    
    // Không xóa cache địa chính để sử dụng lại cho các lần sau
    // Chỉ xóa nếu cần thiết, ví dụ khi dữ liệu quá cũ
    // this.clearAddressCache();
  }

  initForm(): void {
    this.form = this.fb.group({
      id: [null],
      thong_tin_the_id: [null],
      ma_so_bhxh: ['', [Validators.required, Validators.maxLength(10)]],
      cccd: ['', [Validators.required, Validators.pattern(/^\d{12}$/)]],
      ho_ten: ['', [Validators.required, Validators.minLength(3), Validators.maxLength(50)]],
      ngay_sinh: ['', [
        Validators.required,
        Validators.pattern(/^(0[1-9]|[12][0-9]|3[01])\/(0[1-9]|1[0-2])\/\d{4}|\d{4}$/)
      ]],
      gioi_tinh: [null, Validators.required],
      so_dien_thoai: ['', [Validators.pattern(/^(0|84)\d{9,10}$/)]],
      ma_hgd: [null],
      ma_tinh_ks: [null],
      ma_huyen_ks: [null],
      ma_xa_ks: [null],
      tinh_nkq: [null, Validators.required],
      huyen_nkq: [null, Validators.required],
      xa_nkq: [null, Validators.required],
      dia_chi_nkq: ['', Validators.required],
      benh_vien_kcb: ['', Validators.required],
      ma_benh_vien: [''],
      so_the_bhyt: [''],
      ma_dan_toc: [null],
      quoc_tich: ['VN'],
      nguoi_thu: [null, Validators.required],
      so_thang_dong: [null, Validators.required],
      phuong_an_dong: [null, Validators.required],
      han_the_cu: [null],
      han_the_moi_tu: [null, Validators.required],
      han_the_moi_den: [null, Validators.required],
      so_tien_can_dong: [null],
      ngay_bien_lai: [new Date()],
      so_bien_lai: [null], // Thêm trường so_bien_lai
      quyen_bien_lai_id: [null], // Thêm trường quyen_bien_lai_id
      trang_thai: ['chua_gui'] // Thêm trường trang_thai với giá trị mặc định
    });

    // Reset các biến trạng thái
    this.isVisible = false;
    this.isEdit = false;
    this.selectedIds = [];
    this.isAllChecked = false;
    this.isIndeterminate = false;
    this.loadingApDung = false;
    this.thongTinThe = null;
    this.loadingSave = false;
    
    // Reset các danh mục
    this.danhMucHuyens = [];
    this.danhMucXas = [];
    this.danhMucHuyenKS = [];
    this.danhMucXaKS = [];

    // Lắng nghe sự thay đổi của số tháng đóng
    this.form.get('so_thang_dong')?.valueChanges.subscribe(soThangDong => {
      if (soThangDong) {
        const hanTheMoiTu = this.form.get('han_the_moi_tu')?.value;
        if (hanTheMoiTu) {
          const hanTheMoiDen = this.tinhHanTheMoiDen(new Date(hanTheMoiTu), soThangDong);
          this.form.patchValue({
            han_the_moi_den: hanTheMoiDen
          }, { emitEvent: false });
        }
      }
    });

    // Log để kiểm tra form sau khi khởi tạo
    console.log('Form after init:', this.form);
  }

  loadDotKeKhai(): void {
    this.dotKeKhaiService.getDotKeKhai(this.dotKeKhaiId).subscribe({
      next: (data) => {
        this.dotKeKhai = data;
        // Log để kiểm tra giá trị
        console.log('Đợt kê khai:', data);
        console.log('is_bien_lai_dien_tu:', data.is_bien_lai_dien_tu);
        console.log('bien_lai_dien_tu:', data.bien_lai_dien_tu);
        
        // Lưu lại giá trị cho việc sử dụng biên lai điện tử
        this.willUseBienLaiDienTu = !!data.is_bien_lai_dien_tu;
        
        // Kiểm tra cache trước khi gọi API
        if (data.don_vi_id) {
          if (this.donViCache.length > 0) {
            const donVi = this.donViCache.find(d => d.id === data.don_vi_id);
            if (donVi) {
              this.donViName = donVi.tenDonVi + (donVi.isBHYT ? ' (BHYT)' : '');
              // Nếu là DTTS, tự động set người thứ là 1
              if (this.donViName.includes('DTTS')) {
                this.form.patchValue({
                  nguoi_thu: 1
                });
              }
              return;
            }
          }

          this.donViService.getDonVis().subscribe({
            next: (donVis: DonVi[]) => {
              this.donViCache = donVis; // Lưu vào cache
              const donVi = donVis.find(d => d.id === data.don_vi_id);
              if (donVi) {
                this.donViName = donVi.tenDonVi + (donVi.isBHYT ? ' (BHYT)' : '');
                // Nếu là DTTS, tự động set người thứ là 1
                if (this.donViName.includes('DTTS')) {
                  this.form.patchValue({
                    nguoi_thu: 1
                  });
                }
              }
            },
            error: (error: Error) => {
              console.error('Error loading don vi:', error);
              this.message.error('Có lỗi xảy ra khi tải thông tin đơn vị');
            }
          });
        }
      },
      error: (error) => {
        this.message.error('Có lỗi xảy ra khi tải thông tin đợt kê khai');
      }
    });
  }

  loadData(): void {
    this.loadingTable = true; // Sử dụng loadingTable thay vì loading
    this.keKhaiBHYTService.getByDotKeKhai(this.dotKeKhaiId).subscribe({
      next: (data) => {
        const urgentItems = JSON.parse(localStorage.getItem('urgentItems') || '{}');
        
        this.keKhaiBHYTs = data
          .map(item => ({
            ...item,
            is_urgent: urgentItems[item.id!] || false
          }))
          .sort((a, b) => (b.id || 0) - (a.id || 0));
        
        this.applyFilters();
        this.tinhThongKe();
        this.loadingTable = false; // Sử dụng loadingTable
      },
      error: (error) => {
        this.message.error('Có lỗi xảy ra khi tải dữ liệu');
        this.loadingTable = false; // Sử dụng loadingTable
      }
    });
  }

  // Tải danh mục tỉnh với cache
  loadDanhMucTinh(): Promise<void> {
    // Nếu đã có dữ liệu trong bộ nhớ, sử dụng luôn
    if (this.danhMucTinhs?.length > 0) {
      return Promise.resolve();
    }
    
    // Kiểm tra xem có trong localStorage không
    const cachedData = this.loadFromLocalStorage(this.TINH_CACHE_KEY);
    if (cachedData) {
      this.danhMucTinhs = cachedData;
      return Promise.resolve();
    }
    
    return new Promise<void>((resolve, reject) => {
      this.diaChiService.getDanhMucTinh().subscribe({
        next: (tinhs) => {
          const sortedTinhs = tinhs.sort((a, b) => a.ten.localeCompare(b.ten, 'vi'));
          this.danhMucTinhs = sortedTinhs;
          
          // Lưu vào localStorage
          this.saveToLocalStorage(this.TINH_CACHE_KEY, sortedTinhs);
          
          resolve();
        },
        error: (error) => {
          console.error('Lỗi khi tải danh mục tỉnh:', error);
          reject(error);
        }
      });
    });
  }

  // Tối ưu tải danh mục huyện với cache
  loadDanhMucHuyenByMaTinh(maTinh: string): Promise<void> {
    if (!maTinh) return Promise.resolve();
    
    // Kiểm tra cache trong bộ nhớ
    if (this.huyenCache.has(maTinh)) {
      this.danhMucHuyens = this.huyenCache.get(maTinh) || [];
      return Promise.resolve();
    }
    
    // Kiểm tra cache trong localStorage
    const cacheKey = this.HUYEN_CACHE_PREFIX + maTinh;
    const cachedData = this.loadFromLocalStorage(cacheKey);
    if (cachedData) {
      this.danhMucHuyens = cachedData;
      this.huyenCache.set(maTinh, cachedData);
      return Promise.resolve();
    }
    
    return new Promise<void>((resolve, reject) => {
      this.diaChiService.getDanhMucHuyenByMaTinh(maTinh).subscribe({
        next: (huyens) => {
          const sortedHuyens = huyens.sort((a, b) => a.ten.localeCompare(b.ten, 'vi'));
          this.danhMucHuyens = sortedHuyens;
          
          // Lưu vào cache và localStorage
          this.huyenCache.set(maTinh, sortedHuyens);
          this.saveToLocalStorage(cacheKey, sortedHuyens);
          
          resolve();
        },
        error: (error) => {
          console.error('Lỗi khi tải danh mục huyện:', error);
          reject(error);
        }
      });
    });
  }

  // Tối ưu tải danh mục xã với cache
  loadDanhMucXaByMaHuyen(maHuyen: string): Promise<void> {
    if (!maHuyen) return Promise.resolve();
    
    // Kiểm tra cache trong bộ nhớ
    if (this.xaCache.has(maHuyen)) {
      this.danhMucXas = this.xaCache.get(maHuyen) || [];
      return Promise.resolve();
    }
    
    // Kiểm tra cache trong localStorage
    const cacheKey = this.XA_CACHE_PREFIX + maHuyen;
    const cachedData = this.loadFromLocalStorage(cacheKey);
    if (cachedData) {
      this.danhMucXas = cachedData;
      this.xaCache.set(maHuyen, cachedData);
      return Promise.resolve();
    }
    
    return new Promise<void>((resolve, reject) => {
      this.diaChiService.getDanhMucXaByMaHuyen(maHuyen).subscribe({
        next: (xas) => {
          const sortedXas = xas.sort((a, b) => a.ten.localeCompare(b.ten, 'vi'));
          this.danhMucXas = sortedXas;
          
          // Lưu vào cache và localStorage
          this.xaCache.set(maHuyen, sortedXas);
          this.saveToLocalStorage(cacheKey, sortedXas);
          
          resolve();
        },
        error: (error) => {
          console.error('Lỗi khi tải danh mục xã:', error);
          reject(error);
        }
      });
    });
  }

  loadDanhMucCSKCB(): void {
    this.keKhaiBHYTService.getDanhMucCSKCB().subscribe({
      next: (data) => {
        this.danhMucCSKCBs = data;
        console.log('Đã load danh sách bệnh viện:', this.danhMucCSKCBs);
      },
      error: (error) => {
        console.error('Lỗi khi load danh sách bệnh viện:', error);
        this.message.error('Có lỗi xảy ra khi tải danh sách bệnh viện');
      }
    });
  }

  showModal(data?: KeKhaiBHYT): void {
    this.isVisible = true;
    this.isEdit = !!data;
    this.form.reset();

    if (data) {
      console.log('Modal data:', data);
      
      // Patch thông tin thẻ trước
      if (data.thongTinThe) {
        this.form.patchValue({
          id: data.id, // Thêm ID của kê khai
          thong_tin_the_id: data.thongTinThe.id, // Thêm ID của thông tin thẻ
          ma_so_bhxh: data.thongTinThe.ma_so_bhxh,
          cccd: data.thongTinThe.cccd,
          ho_ten: data.thongTinThe.ho_ten,
          ngay_sinh: data.thongTinThe.ngay_sinh,
          gioi_tinh: data.thongTinThe.gioi_tinh,
          so_dien_thoai: data.thongTinThe.so_dien_thoai,
          ma_hgd: data.thongTinThe.ma_hgd,
          ma_tinh_ks: data.thongTinThe.ma_tinh_ks,
          ma_huyen_ks: data.thongTinThe.ma_huyen_ks,
          ma_xa_ks: data.thongTinThe.ma_xa_ks,
          tinh_nkq: data.thongTinThe.ma_tinh_nkq,
          huyen_nkq: data.thongTinThe.ma_huyen_nkq,
          xa_nkq: data.thongTinThe.ma_xa_nkq,
          dia_chi_nkq: data.thongTinThe.dia_chi_nkq || '',
          benh_vien_kcb: data.benh_vien_kcb || data.thongTinThe.benh_vien_kcb || '',
          ma_benh_vien: data.ma_benh_vien || data.thongTinThe.ma_benh_vien || '',
          so_the_bhyt: data.thongTinThe.so_the_bhyt,
          ma_dan_toc: data.thongTinThe.ma_dan_toc,
          quoc_tich: data.thongTinThe.quoc_tich,
          nguoi_thu: data.nguoi_thu,
          so_thang_dong: data.so_thang_dong,
          phuong_an_dong: data.phuong_an_dong,
          han_the_cu: data.han_the_cu,
          han_the_moi_tu: data.han_the_moi_tu,
          han_the_moi_den: data.han_the_moi_den,
          so_tien_can_dong: data.so_tien_can_dong,
          ngay_bien_lai: data.ngay_bien_lai || new Date(),
          so_bien_lai: data.so_bien_lai, // Thêm trường so_bien_lai
          quyen_bien_lai_id: data.quyen_bien_lai_id, // Thêm trường quyen_bien_lai_id
          trang_thai: data.trang_thai // Thêm trường trang_thai với giá trị mặc định
        });

        // Log để kiểm tra
        console.log('Form values after patch:', this.form.value);
      }
    }
  }

  handleCancel(): void {
    this.isVisible = false;
    this.isEdit = false;
    this.form.reset();
  }

  // Hàm format tên đợt theo định dạng yêu cầu
  formatTenDot(soDot: number, thang: number, nam: number): string {
    return `Đợt ${soDot} Tháng ${thang} năm ${nam}`;
  }

  handleOk(): void {
    if (this.form.valid) {
      const formValue = this.form.value;
      const soTienCanDong = this.tinhSoTienCanDong(formValue.nguoi_thu, formValue.so_thang_dong);
      
      // Gán giá trị so_tien_can_dong vào form
      formValue.so_tien_can_dong = soTienCanDong;

      // Sử dụng hàm formatNgaySinh để chuyển đổi ngày sinh sang chuỗi ISO
      const ngaySinh = this.formatNgaySinh(formValue.ngay_sinh);

      // Chuyển đổi chuỗi ISO thành đối tượng Date
      const ngaySinhDate = new Date(ngaySinh);

      if (this.isEdit) {
        const keKhaiBHYTId = formValue.id;
        const thongTinTheId = formValue.thong_tin_the_id;

        if (typeof keKhaiBHYTId !== 'number' || typeof thongTinTheId !== 'number') {
          this.message.error('Không tìm thấy ID kê khai hoặc thông tin thẻ');
          this.loadingTable = false;
          return;
        }

        // Lấy thông tin thẻ hiện tại để giữ lại các giá trị cũ
        this.keKhaiBHYTService.getThongTinTheById(thongTinTheId).subscribe({
          next: (currentThongTinThe) => {
            // Cập nhật ThongTinThe
            const updateData: ThongTinThe = {
              id: thongTinTheId,
              ma_so_bhxh: formValue.ma_so_bhxh,
              cccd: formValue.cccd,
              ho_ten: formValue.ho_ten,
              // Sử dụng ngày sinh đã được xử lý
              ngay_sinh: ngaySinhDate, // Sử dụng chuỗi ISO
              gioi_tinh: formValue.gioi_tinh,
              so_dien_thoai: formValue.so_dien_thoai || '',
              ma_hgd: formValue.ma_hgd || '',
              // Giữ lại giá trị cũ nếu form không có giá trị mới
              ma_tinh_ks: formValue.ma_tinh_ks || currentThongTinThe.ma_tinh_ks,
              ma_huyen_ks: formValue.ma_huyen_ks || currentThongTinThe.ma_huyen_ks,
              ma_xa_ks: formValue.ma_xa_ks || currentThongTinThe.ma_xa_ks,
              ma_tinh_nkq: formValue.tinh_nkq || '',
              ma_huyen_nkq: formValue.huyen_nkq || '',
              ma_xa_nkq: formValue.xa_nkq || '',
              dia_chi_nkq: formValue.dia_chi_nkq,
              benh_vien_kcb: this.getBenhVienTen(formValue.benh_vien_kcb),
              ma_benh_vien: formValue.benh_vien_kcb || '',
              nguoi_tao: this.currentUser.userName,
              ngay_tao: new Date(),
              so_the_bhyt: formValue.so_the_bhyt || '',
              ma_dan_toc: formValue.ma_dan_toc || '',
              quoc_tich: formValue.quoc_tich || 'VN',
              noiNhanHoSo: {
                tinh: this.getTinhTen(formValue.tinh_nkq),
                huyen: this.getHuyenTen(formValue.huyen_nkq),
                xa: this.getXaTen(formValue.xa_nkq),
                diaChi: formValue.dia_chi_nkq
              }
            };

            // Tiếp tục với phần cập nhật
            this.keKhaiBHYTService.updateThongTinThe(thongTinTheId, updateData).subscribe({
              next: () => {
                // Lấy thông tin kê khai hiện tại để giữ lại số biên lai
                this.keKhaiBHYTService.getById(this.dotKeKhaiId, keKhaiBHYTId).subscribe({
                  next: (currentKeKhai) => {
                    // Tạo đối tượng KeKhaiBHYT với thông tin thẻ đã cập nhật
                    const keKhaiBHYTData: KeKhaiBHYT = {
                      id: keKhaiBHYTId,
                      dot_ke_khai_id: this.dotKeKhaiId,
                      thong_tin_the_id: thongTinTheId,
                      dotKeKhai: this.dotKeKhai || undefined,
                      thongTinThe: updateData,
                      nguoi_thu: formValue.nguoi_thu,
                      so_thang_dong: formValue.so_thang_dong,
                      phuong_an_dong: formValue.phuong_an_dong,
                      han_the_cu: formValue.han_the_cu ? new Date(formValue.han_the_cu) : null,
                      han_the_moi_tu: formValue.han_the_moi_tu ? new Date(formValue.han_the_moi_tu) : new Date(),
                      han_the_moi_den: formValue.han_the_moi_den ? new Date(formValue.han_the_moi_den) : new Date(),
                      tinh_nkq: this.getTinhTen(formValue.tinh_nkq),
                      huyen_nkq: this.getHuyenTen(formValue.huyen_nkq),
                      xa_nkq: this.getXaTen(formValue.xa_nkq),
                      dia_chi_nkq: formValue.dia_chi_nkq,
                      benh_vien_kcb: this.getBenhVienTen(formValue.benh_vien_kcb),
                      ma_benh_vien: formValue.benh_vien_kcb || '',
                      nguoi_tao: this.currentUser.userName || this.currentUser.name || 'unknown_user',
                      ngay_tao: new Date(),
                      ngay_bien_lai: formValue.ngay_bien_lai ? new Date(formValue.ngay_bien_lai) : null,
                      so_tien_can_dong: formValue.so_tien_can_dong || 0,
                      is_urgent: false,
                      so_bien_lai: currentKeKhai.so_bien_lai, // Giữ lại số biên lai từ dữ liệu hiện tại
                      quyen_bien_lai_id: currentKeKhai.quyen_bien_lai_id, // Giữ lại ID quyển biên lai từ dữ liệu hiện tại
                      trang_thai: currentKeKhai.trang_thai // Giữ lại trạng thái từ dữ liệu hiện tại
                    };

                    this.keKhaiBHYTService.update(this.dotKeKhaiId, keKhaiBHYTId, keKhaiBHYTData).subscribe({
                      next: () => {
                        this.message.success('Cập nhật thành công');
                        this.isVisible = false;
                        this.isEdit = false;
                        this.loadData();
                        this.loadingTable = false;
                        this.loadingSave = false;
                        this.initForm();
                      },
                      error: (error) => {
                        console.error('Error updating KeKhaiBHYT:', error);
                        this.message.error('Có lỗi xảy ra khi cập nhật kê khai');
                        this.loadingTable = false;
                        this.loadingSave = false;
                      }
                    });
                  },
                  error: (error) => {
                    console.error('Error getting current KeKhaiBHYT:', error);
                    this.message.error('Có lỗi xảy ra khi lấy thông tin kê khai hiện tại');
                    this.loadingTable = false;
                    this.loadingSave = false;
                  }
                });
              },
              error: (error) => {
                console.error('Error updating ThongTinThe:', error);
                this.message.error('Có lỗi xảy ra khi cập nhật thông tin thẻ');
                this.loadingTable = false;
                this.loadingSave = false;
              }
            });
          },
          error: (error) => {
            console.error('Error getting ThongTinThe:', error);
            this.message.error('Có lỗi xảy ra khi lấy thông tin thẻ');
            this.loadingTable = false;
            this.loadingSave = false;
          }
        });
      } else {
        // Tạo mới ThongTinThe
        const thongTinTheData: ThongTinThe = {
          id: undefined,
          ma_so_bhxh: formValue.ma_so_bhxh,
          cccd: formValue.cccd,
          ho_ten: formValue.ho_ten,
          // Sử dụng ngày sinh đã được xử lý
          ngay_sinh: ngaySinhDate, // Sử dụng chuỗi ISO
          gioi_tinh: formValue.gioi_tinh,
          so_dien_thoai: formValue.so_dien_thoai || '',
          ma_hgd: formValue.ma_hgd || '',
          ma_tinh_ks: formValue.ma_tinh_ks || null,
          nguoi_tao: this.currentUser.userName || this.currentUser.name || 'unknown_user', // Đảm bảo có giá trị
          ngay_tao: new Date(),
          noiNhanHoSo: {
            tinh: this.getTinhTen(formValue.tinh_nkq),
            huyen: this.getHuyenTen(formValue.huyen_nkq),
            xa: this.getXaTen(formValue.xa_nkq),
            diaChi: formValue.dia_chi_nkq
          },
          ma_huyen_ks: formValue.ma_huyen_ks || null,
          ma_xa_ks: formValue.ma_xa_ks || null,
          ma_tinh_nkq: formValue.tinh_nkq || '',
          ma_huyen_nkq: formValue.huyen_nkq || '',
          ma_xa_nkq: formValue.xa_nkq || '',
          so_the_bhyt: formValue.so_the_bhyt || '',
          ma_dan_toc: formValue.ma_dan_toc || '',
          quoc_tich: formValue.quoc_tich || 'VN',
          ma_benh_vien: formValue.benh_vien_kcb || '',
        };

        // Tạo đối tượng KeKhaiBHYT
        const data: KeKhaiBHYT = {
          id: 0,
          dot_ke_khai_id: this.dotKeKhaiId,
          thong_tin_the_id: 0,
          thongTinThe: thongTinTheData,
          nguoi_thu: formValue.nguoi_thu,
          so_thang_dong: formValue.so_thang_dong,
          so_tien_can_dong: formValue.so_tien_can_dong || 0,
          phuong_an_dong: formValue.phuong_an_dong,
          han_the_cu: formValue.han_the_cu ? new Date(formValue.han_the_cu) : null,
          han_the_moi_tu: formValue.han_the_moi_tu ? new Date(formValue.han_the_moi_tu) : new Date(),
          han_the_moi_den: formValue.han_the_moi_den ? new Date(formValue.han_the_moi_den) : new Date(),
          tinh_nkq: this.getTinhTen(formValue.tinh_nkq),
          huyen_nkq: this.getHuyenTen(formValue.huyen_nkq),
          xa_nkq: this.getXaTen(formValue.xa_nkq),
          dia_chi_nkq: formValue.dia_chi_nkq,
          benh_vien_kcb: this.getBenhVienTen(formValue.benh_vien_kcb),
          ma_benh_vien: formValue.benh_vien_kcb || '',
          nguoi_tao: this.currentUser.userName || this.currentUser.name || 'unknown_user',
          ngay_tao: new Date(),
          ngay_bien_lai: formValue.ngay_bien_lai ? new Date(formValue.ngay_bien_lai) : null,
          is_urgent: false,
          trang_thai: 'chua_gui'
        };

        // Tạo mới KeKhaiBHYT
        this.keKhaiBHYTService.create(this.dotKeKhaiId, data).subscribe({
          next: (response) => {
            this.message.success('Thêm mới thành công');
            this.isVisible = false;
            this.loadData();
            this.loadingSave = false; // Reset trạng thái loading
            this.initForm(); // Thêm dòng này để làm mới form
          },
          error: (error) => {
            console.error('Lỗi khi gọi API create:', error);
            console.log('Dữ liệu gửi đi:', JSON.stringify(data));
            if (error.error && error.error.message) {
              this.message.error(error.error.message);
            } else {
              this.message.error('Có lỗi xảy ra khi tạo mới');
            }
            this.loadingSave = false; // Reset trạng thái loading khi có lỗi
          }
        });
      }
    } else {
      if (!this.dotKeKhai) {
        this.message.error('Không tìm thấy thông tin đợt kê khai');
        this.loadingSave = false;
        return;
      }
      Object.values(this.form.controls).forEach(control => {
        if (control.invalid) {
          control.markAsTouched();
          control.updateValueAndValidity({ onlySelf: true });
        }
      });
      this.loadingSave = false;
    }
  }

  delete(id: number): void {
    this.modal.confirm({
      nzTitle: 'Xác nhận xóa',
      nzContent: 'Bạn có chắc chắn muốn xóa kê khai này?',
      nzOkText: 'Xóa',
      nzOkType: 'primary',
      nzOkDanger: true,
      nzOnOk: () => {
        this.keKhaiBHYTService.delete(this.dotKeKhaiId, id).subscribe({
          next: () => {
            this.message.success('Xóa thành công');
            this.loadData();
          },
          error: (error) => {
            this.message.error('Có lỗi xảy ra khi xóa');
          }
        });
      },
      nzCancelText: 'Hủy'
    });
  }

  deleteMultiple(): void {
    if (this.selectedIds.length === 0) {
      this.message.warning('Vui lòng chọn ít nhất một kê khai để xóa');
      return;
    }

    this.modal.confirm({
      nzTitle: 'Xác nhận xóa',
      nzContent: `Bạn có chắc chắn muốn xóa ${this.selectedIds.length} kê khai đã chọn?`,
      nzOkText: 'Xóa',
      nzOkType: 'primary',
      nzOkDanger: true,
      nzOnOk: () => {
        this.keKhaiBHYTService.deleteMultiple(this.dotKeKhaiId, this.selectedIds).subscribe({
          next: () => {
            this.message.success('Xóa thành công');
            this.selectedIds = [];
            this.isAllChecked = false;
            this.loadData();
          },
          error: (error) => {
            this.message.error('Có lỗi xảy ra khi xóa');
          }
        });
      },
      nzCancelText: 'Hủy'
    });
  }

  onAllChecked(checked: boolean): void {
    // Reset mảng selectedIds
    this.selectedIds = [];
    
    // Nếu checked là true thì thêm tất cả id vào mảng selectedIds
    if (checked) {
      this.keKhaiBHYTs.forEach(item => {
        if (item.id) {
          this.selectedIds.push(item.id);
        }
      });
    }
    
    // Cập nhật trạng thái
    this.isAllChecked = checked;
    this.isIndeterminate = false;
  }

  onCCCDChecked(cccd: CCCDResult, checked: boolean): void {
    cccd.checked = checked;
    this.refreshCheckStatus();
  }

  refreshCheckStatus(): void {
    const validItems = this.danhSachCCCD.filter(cccd => cccd.status === 'success');
    const allChecked = validItems.length > 0 && validItems.every(item => item.checked);
    const allUnchecked = validItems.every(item => !item.checked);
    
    this.isAllChecked = allChecked;
    this.isIndeterminate = !allChecked && !allUnchecked;
  }

  hasSelectedCCCD(): boolean {
    return this.danhSachCCCD.some(cccd => cccd.checked && cccd.status === 'success');
  }

  async apDungNhieuCCCD(): Promise<void> {
    const selectedCCCDs = this.danhSachCCCD.filter(cccd => cccd.checked && cccd.status === 'success');
    if (selectedCCCDs.length === 0) {
      this.message.warning('Vui lòng chọn ít nhất một CCCD để áp dụng');
      return;
    }

    if (!this.applyPermanentAddress && !this.applyHomeAddress) {
      this.message.warning('Vui lòng chọn ít nhất một loại địa chỉ để áp dụng');
      return;
    }

    this.loadingApDung = true;
    try {
      for (const cccd of selectedCCCDs) {
        await this.apDungThongTin(cccd, false);
      }
      
      const addressTypes = [];
      if (this.applyPermanentAddress) addressTypes.push('địa chỉ thường trú');
      if (this.applyHomeAddress) addressTypes.push('quê quán');
      
      this.message.success(
        `Đã áp dụng thành công ${selectedCCCDs.length} CCCD với ${addressTypes.join(' và ')}`
      );
      this.isQuetCCCDVisible = false;
    } catch (error) {
      this.message.error('Có lỗi xảy ra khi áp dụng thông tin CCCD');
      console.error('Error applying multiple CCCDs:', error);
    } finally {
      this.loadingApDung = false;
    }
  }

  formatCurrency = (value: number): string => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  parseCurrency = (value: string): number => Number(value.replace(/\$\s?|(,*)/g, ''));

  onlyNumber(event: KeyboardEvent): boolean {
    const charCode = (event.which) ? event.which : event.keyCode;
    if (charCode > 31 && (charCode < 48 || charCode > 57)) {
      return false;
    }
    return true;
  }

  onlyLetter(event: KeyboardEvent): boolean {
    const charCode = (event.which) ? event.which : event.keyCode;
    // Cho phép các phím điều khiển như Backspace, Delete, mũi tên,...
    if (charCode <= 31) {
      return true;
    }
    // Cho phép khoảng trắng
    if (charCode === 32) {
      return true;
    }
    // Chỉ cho phép chữ cái (a-z, A-Z) và chữ có dấu
    const char = String.fromCharCode(charCode);
    return /^[a-zA-ZÀ-ỹ]$/.test(char);
  }

  // Hàm helper để chuyển đổi ngày tháng an toàn
  private parseDate(dateStr: string | null): Date | null {
    if (!dateStr) return null;
    
    // Kiểm tra nếu chỉ là năm
    if (/^\d{4}$/.test(dateStr)) {
      const year = parseInt(dateStr);
      if (year >= 1900 && year <= new Date().getFullYear()) {
        return new Date(year, 0, 1); // Trả về ngày 1/1 của năm đó
      }
      return null;
    }
    
    // Nếu dateStr là định dạng dd/MM/yyyy
    if (dateStr.includes('/')) {
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        const [day, month, year] = parts.map(Number);
        const date = new Date(year, month - 1, day);
        
        // Kiểm tra tính hợp lệ của ngày
        if (
          date.getDate() === day &&
          date.getMonth() === month - 1 &&
          date.getFullYear() === year &&
          date.getFullYear() >= 1900 &&
          date.getFullYear() <= new Date().getFullYear() &&
          !isNaN(date.getTime())
        ) {
          return date;
        }
      }
    }
    
    // Thử parse các định dạng khác
    const date = new Date(dateStr);
    return !isNaN(date.getTime()) ? date : null;
  }

  onSearchBHYT(): void {
    if (this.loadingSearch) return; // Sử dụng loadingSearch
    
    const maSoBHXH = this.form.get('ma_so_bhxh')?.value;
    if (maSoBHXH && maSoBHXH.length === 10) {
      // Kiểm tra token trước khi tìm kiếm
      if (!this.ssmv2Service.getToken()) {
        // Bỏ dòng hiển thị thông báo
        // this.message.warning('Vui lòng xác thực lại để lấy token mới');
        this.getAccessToken(); // Chỉ hiển thị modal xác thực
        return;
      }

      this.loadingSearch = true; // Sử dụng loadingSearch
      
      this.keKhaiBHYTService.traCuuThongTinBHYT(maSoBHXH).subscribe({
        next: async (response) => {
          if (response.success) {
            const data = response.data;
            console.log('BHYT search response:', data);
            
            // Kiểm tra nếu isThamGiaBb = 1 thì hiển thị thông báo
            if (data.isThamGiaBb === 1) {
              this.modal.warning({
                nzTitle: 'Thông báo BHXH bắt buộc',
                nzContent: `<div>
                  <p><strong>Họ tên:</strong> ${data.hoTen || 'Không có'}</p>
                  <p><strong>Mã số BHXH:</strong> ${data.maSoBHXH || 'Không có'}</p>
                  <p><strong>Số thẻ BHYT:</strong> ${data.soTheBHYT || 'Chưa có'}</p>
                  <p>Đối tượng đang tham gia BHXH bắt buộc.</p>
                </div>`,
                nzOkText: 'Đã hiểu'
              });
              this.loadingSearch = false;
              return;
            }

            // Kiểm tra hạn thẻ cũ
            if (data.denNgayTheCu) {
              const denNgayTheCu = this.parseDate(data.denNgayTheCu);
              if (denNgayTheCu) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const timeDiff = denNgayTheCu.getTime() - today.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                
                if (daysDiff > 30) {
                  return new Promise((resolve) => {
                    this.modal.warning({
                      nzTitle: 'Cảnh báo',
                      nzContent: `Thẻ BHYT hiện tại còn ${daysDiff} ngày sử dụng. Bạn có muốn tiếp tục kê khai không?`,
                      nzOkText: 'Tiếp tục',
                      nzCancelText: 'Hủy',
                      nzOnOk: () => {
                        resolve(true);
                      },
                      nzOnCancel: () => {
                        this.form.reset();
                        this.loadingSearch = false;
                        resolve(false);
                      }
                    });
                  }).then((shouldContinue) => {
                    if (!shouldContinue) return;
                    this.processSearchResult(data);
                  });
                }
              }
            }

            await this.processSearchResult(data);
          } else {
            this.message.error(response.message || 'Lỗi không xác định');
          }
        },
        error: (err) => {
          console.error('Search error:', err);
          if (err.error?.error === 'Lỗi xác thực') {
            this.ssmv2Service.clearToken();
            // Bỏ dòng hiển thị thông báo
            // this.message.warning('Phiên làm việc hết hạn, vui lòng xác thực lại');
            this.getAccessToken();
          } else {
            this.message.error('Lỗi tìm kiếm: ' + (err.error?.message || 'Lỗi không xác định'));
          }
        },
        complete: () => {
          this.loadingSearch = false; // Sử dụng loadingSearch
        }
      });
    } else {
      this.message.warning('Vui lòng nhập đủ 10 số BHXH');
    }
  }

  // Thêm lại phương thức processSearchResult
  private async processSearchResult(data: any): Promise<void> {
    try {
      // Xử lý và chuyển đổi ngày tháng
      const ngaySinhDate = this.formatNgaySinh(data.ngaySinh);
      const ngaySinh = this.formatDateToString(ngaySinhDate);
      const denNgayTheCu = data.denNgayTheCu ? this.formatNgaySinh(data.denNgayTheCu) : null;

      // Cập nhật form với dữ liệu từ API
      this.form.patchValue({
        ma_so_bhxh: data.maSoBHXH,
        cccd: data.cmnd,
        ho_ten: data.hoTen,
        ngay_sinh: ngaySinh,
        gioi_tinh: data.gioiTinh === 1 ? 'Nam' : 'Nữ',
        so_dien_thoai: data.soDienThoai,
        ma_hgd: data.maHoGiaDinh,
        ma_tinh_ks: data.maTinhKS,
        ma_huyen_ks: data.maHuyenKS,
        ma_xa_ks: data.maXaKS,
        tinh_nkq: data.maTinhNkq,
        huyen_nkq: data.maHuyenNkq,
        xa_nkq: data.maXaNkq,
        dia_chi_nkq: data.noiNhanHoSo,
        benh_vien_kcb: data.maBenhVien,
        ma_benh_vien: data.maBenhVien,
        so_the_bhyt: data.soTheBHYT,
        han_the_cu: denNgayTheCu,
        ma_dan_toc: data.danToc,
        quoc_tich: data.quocTich,
      });

      try {
        // Load danh sách huyện và xã tương ứng
        if (data.maTinhNkq) {
          await this.loadDanhMucHuyenByMaTinh(data.maTinhNkq);
        }
        if (data.maHuyenNkq) {
          await this.loadDanhMucXaByMaHuyen(data.maHuyenNkq);
        }
      } catch (error) {
        console.error('Lỗi khi tải danh mục địa chỉ:', error);
        this.message.warning('Không thể tải đầy đủ thông tin địa chỉ');
      }

      // Tính toán phương án đóng
      const phuongAnDong = this.checkPhuongAnDong(denNgayTheCu);
      this.form.patchValue({
        phuong_an_dong: phuongAnDong
      });

      // Tính hạn thẻ mới từ
      const ngayBienLai = this.form.get('ngay_bien_lai')?.value;
      if (ngayBienLai) {
        const hanTheMoiTu = this.tinhHanTheMoiTu(new Date(ngayBienLai), denNgayTheCu);
        this.form.patchValue({
          han_the_moi_tu: hanTheMoiTu
        });
      }

      this.message.success('Đã tìm thấy thông tin BHYT');
    } catch (error) {
      console.error('Lỗi xử lý dữ liệu BHYT:', error);
      this.message.error('Có lỗi khi xử lý thông tin BHYT');
    } finally {
      this.loadingSearch = false;
    }
  }

  filterOption: NzFilterOptionType = (input: string, option: { nzLabel: string | number | null; nzValue: any }): boolean => {
    if (option.nzLabel === null) return false;
    return String(option.nzLabel).toLowerCase().indexOf(input.toLowerCase()) >= 0;
  };

  // Thêm phương thức để lấy tên bệnh viện từ mã
  getBenhVienTen(value: string): string {
    const benhVien = this.danhMucCSKCBs.find(bv => bv.value === value);
    return benhVien ? benhVien.ten : value;
  }

  // Thêm phương thức xử lý khi tìm kiếm bằng mã số BHXH
  searchByMaSoBHXH(): void {
    const maSoBHXH = this.form.get('ma_so_bhxh')?.value;
    if (!maSoBHXH) {
      this.message.warning('Vui lòng nhập mã số BHXH');
      return;
    }

    // Hiển thị loading
    this.loadingSearch = true;

    // Gọi API tra cứu thông tin BHYT
    this.keKhaiBHYTService.traCuuThongTinBHYT(maSoBHXH).subscribe({
      next: (response) => {
        if (response.success) {
          console.log('Thông tin BHYT:', response.data);
          
          // Cập nhật form với thông tin nhận được
          this.form.patchValue({
            ma_so_bhxh: response.data.maSoBHXH,
            ho_ten: response.data.hoTen,
            cccd: response.data.cmnd,
            so_dien_thoai: response.data.soDienThoai,
            ma_hgd: response.data.maHoGiaDinh,
            benh_vien_kcb: response.data.maBenhVien, // Cập nhật mã bệnh viện
          });

          // Log để kiểm tra
          console.log('Form sau khi cập nhật:', this.form.value);
          console.log('Mã bệnh viện nhận được:', response.data.maBenhVien);
          console.log('Danh sách bệnh viện hiện có:', this.danhMucCSKCBs);

          // Đảm bảo danh sách bệnh viện đã được load
          if (!this.danhMucCSKCBs.length) {
            this.loadDanhMucCSKCB();
          }

          this.loadingSearch = false;
        } else {
          this.message.error(response.message || 'Không tìm thấy thông tin BHYT');
          this.loadingSearch = false;
        }
      },
      error: (error) => {
        console.error('Lỗi tra cứu BHYT:', error);
        this.message.error('Có lỗi xảy ra khi tra cứu thông tin BHYT');
        this.loadingSearch = false;
      }
    });
  }

  getTinhTen(maTinh: string): string {
    const tinh = this.danhMucTinhs.find(t => t.ma === maTinh);
    if (!tinh) {
      console.warn(`Không tìm thấy tỉnh với mã: ${maTinh}`);
      return maTinh; // Trả về mã nếu không tìm thấy tên
    }
    return tinh.ten;
  }

  getHuyenTen(maHuyen: string): string {
    console.log('getHuyenTen được gọi với mã:', maHuyen);
    console.log('Danh mục huyện hiện tại:', this.danhMucHuyens);
    
    const huyen = this.danhMucHuyens.find(h => h.ma === maHuyen);
    if (!huyen) {
      console.warn(`Không tìm thấy huyện với mã: ${maHuyen}`);
      return maHuyen;
    }
    return huyen.ten;
  }

  getXaTen(maXa: string): string {
    const xa = this.danhMucXas.find(x => x.ma === maXa);
    if (!xa) {
      console.warn(`Không tìm thấy xã với mã: ${maXa}`);
      return maXa; // Trả về mã nếu không tìm thấy tên
    }
    return xa.ten;
  }

  refresh(): void {
    this.loadingTable = true;
    this.loadData();
    this.message.success('Đã làm mới dữ liệu');
  }

  // Thêm phương thức mới để hiển thị tên bệnh viện
  getBenhVienDisplay(maBenhVien: string): string {
    const benhVien = this.danhMucCSKCBs.find(bv => bv.value === maBenhVien);
    return benhVien ? benhVien.ten : maBenhVien;
  }

  // Thêm hàm tính số tiền cần đóng
  tinhSoTienCanDong(nguoiThu: number, soThangDong: number): number {
    const mucDong = 2340000 * 0.045;
    let tyLe = 1;
    
    // Kiểm tra nếu đơn vị là DTTS
    if (this.donViName.includes('DTTS')) {
      // Công thức cho DTTS: 2.340.000×4,5%×(100%−70%) x số tháng đóng
      return Math.round(mucDong * 0.3 * soThangDong); // 0.3 = 100% - 70%
    }

    // Kiểm tra nếu đơn vị là NLNN
    if (this.donViName.includes('NLNN')) {
      // Công thức cho NLNN: 2.340.000×4,5%×(100%−30%) x số tháng đóng
      return Math.round(mucDong * 0.7 * soThangDong); // 0.7 = 100% - 30%
    }
    
    // Công thức thông thường cho các đơn vị khác
    if (nguoiThu >= 1 && nguoiThu <= 5) {
      switch(nguoiThu) {
        case 1: tyLe = 1; break;
        case 2: tyLe = 0.7; break;
        case 3: tyLe = 0.6; break;
        case 4: tyLe = 0.5; break;
        case 5: tyLe = 0.4; break;
      }
    }

    return Math.round(mucDong * tyLe * soThangDong);
  }

  // Thêm hàm xử lý khi thay đổi người thứ hoặc số tháng đóng
  capNhatSoTienCanDong(): void {
    const nguoiThu = this.form.get('nguoi_thu')?.value;
    const soThangDong = this.form.get('so_thang_dong')?.value;
    
    if (nguoiThu && soThangDong) {
      const soTienCanDong = this.tinhSoTienCanDong(nguoiThu, soThangDong);
      this.form.patchValue({
        so_tien_can_dong: soTienCanDong
      }, { emitEvent: false });
    }
  }

  // Thêm hàm tính hạn thẻ mới từ
  tinhHanTheMoiTu(ngayBienLai: Date, hanTheCu: Date | null): Date {
    // Log để debug
    console.log('Tính hạn thẻ mới từ với:', {
      ngayBienLai: ngayBienLai,
      hanTheCu: hanTheCu,
      donViName: this.donViName
    });

    // Đảm bảo ngayBienLai là Date object và reset time về 00:00:00
    const ngayBL = new Date(ngayBienLai);
    ngayBL.setHours(0, 0, 0, 0);

    // Trường hợp DTTS
    if (this.donViName.includes('DTTS')) {
      // Lấy ngày đầu tháng của ngày biên lai hiện tại (không phải tháng tiếp theo)
      const result = new Date(ngayBL.getFullYear(), ngayBL.getMonth(), 1);
      console.log('DTTS - Hạn thẻ mới từ:', result);
      return result;
    }
    
    // Trường hợp HGD, NLNN và các đơn vị khác (mặc định)
    // Nếu không có hạn thẻ cũ, cộng 30 ngày
    if (!hanTheCu) {
      const result = new Date(ngayBL.getTime());
      result.setDate(result.getDate() + 30);
      console.log('Không có hạn thẻ cũ - Hạn thẻ mới từ:', result);
      return result;
    }

    // Đảm bảo hanTheCu là Date object và reset time về 00:00:00
    const hanTC = new Date(hanTheCu);
    hanTC.setHours(0, 0, 0, 0);

    // Nếu ngày biên lai lớn hơn hạn thẻ cũ
    if (ngayBL.getTime() > hanTC.getTime()) {
      const result = new Date(ngayBL.getTime());
      result.setDate(result.getDate() + 1);
      console.log('Ngày biên lai lớn hơn hạn thẻ cũ - Hạn thẻ mới từ:', result);
      return result;
    }

    // Nếu hạn thẻ cũ lớn hơn ngày biên lai
    if (hanTC.getTime() > ngayBL.getTime()) {
      // Tạo một ngày mới là hạn thẻ cũ + 1 ngày
      const result = new Date(hanTC);
      result.setDate(result.getDate() + 1);
      
      // Log để debug
      console.log('Hạn thẻ cũ:', hanTC);
      console.log('Hạn thẻ mới từ (cộng 1 ngày):', result);
      
      return result;
    }

    // Nếu không thuộc các trường hợp trên (hiếm gặp, ngày bằng nhau), mặc định cộng 1 ngày vào ngày biên lai
    const result = new Date(ngayBL.getTime());
    result.setDate(result.getDate() + 1);
    console.log('Ngày biên lai bằng hạn thẻ cũ - Hạn thẻ mới từ:', result);
    return result;
  }

  // Cập nhật lại phương thức tính hạn thẻ mới đến
  tinhHanTheMoiDen(hanTheMoiTu: Date, soThangDong: number): Date {
    // Tạo bản sao của hanTheMoiTu để không ảnh hưởng đến ngày gốc
    const result = new Date(hanTheMoiTu);
    
    // Cộng số tháng đóng vào hạn thẻ mới từ
    result.setMonth(result.getMonth() + soThangDong);
    // Trừ đi 1 ngày
    result.setDate(result.getDate() - 1);
    
    return result;
  }

  // Thêm phương thức cập nhật hạn thẻ
  capNhatHanThe(): void {
    const ngayBienLai = this.form.get('ngay_bien_lai')?.value;
    const hanTheCu = this.form.get('han_the_cu')?.value;
    const soThangDong = this.form.get('so_thang_dong')?.value;

    if (ngayBienLai) {
      // Tính hạn thẻ mới từ
      const hanTheMoiTu = this.tinhHanTheMoiTu(new Date(ngayBienLai), hanTheCu ? new Date(hanTheCu) : null);
      
      this.form.patchValue({
        han_the_moi_tu: hanTheMoiTu
      }, { emitEvent: false });

      // Nếu có số tháng đóng thì tính hạn thẻ mới đến
      if (soThangDong) {
        const hanTheMoiDen = this.tinhHanTheMoiDen(hanTheMoiTu, soThangDong);
        this.form.patchValue({
          han_the_moi_den: hanTheMoiDen
        }, { emitEvent: false });
      }
    }
  }

  // Thêm phương thức tính tổng số tiền
  getTongSoTienCanDong(): number {
    return this.keKhaiBHYTs.reduce((total, item) => total + (item.so_tien_can_dong || 0), 0);
  }

  toggleUrgent(id: number, event?: MouseEvent): void {
    if (event) {
      event.stopPropagation();
    }

    this.keKhaiBHYTService.toggleUrgent(this.dotKeKhaiId, id).subscribe({
      next: (response) => {
        // Cập nhật trạng thái trong danh sách local
        const item = this.keKhaiBHYTs.find(x => x.id === id);
        if (item) {
          item.is_urgent = response.is_urgent; // Sử dụng giá trị từ response
          // Lưu vào localStorage để duy trì trạng thái
          const urgentItems = JSON.parse(localStorage.getItem('urgentItems') || '{}');
          urgentItems[id] = response.is_urgent;
          localStorage.setItem('urgentItems', JSON.stringify(urgentItems));
        }
        this.message.success(item?.is_urgent ? 'Đã đánh dấu gấp' : 'Đã bỏ đánh dấu gấp');
      },
      error: (error) => {
        console.error('Error toggling urgent status:', error);
        this.message.error('Có lỗi xảy ra khi cập nhật trạng thái gấp');
      }
    });
  }

  getNguoiThuText(nguoiThu: number): string {
    switch (nguoiThu) {
      case 1:
        return 'Người thứ 1';
      case 2:
        return 'Người thứ 2';
      case 3:
        return 'Người thứ 3';
      case 4:
        return 'Người thứ 4';
      case 5:
        return 'Người thứ 5 trở đi';
      default:
        return '';
    }
  }

  // Thêm các hàm xử lý modal tìm kiếm nhiều mã số
  showSearchMultipleModal(): void {
    this.isSearchMultipleVisible = true;
    this.multipleSearchText = '';
    this.multipleSearchBenhVien = '';
    this.hoGiaDinhStartIndex = 1; // Reset về người thứ 1
    
    // Bỏ việc gán giá trị mặc định
    this.multipleSearchNguoiThu = null as any;
    this.multipleSearchSoThangDong = null as any;

    // Chỉ set người thứ = 1 nếu là DTTS
    if (this.donViName.includes('DTTS')) {
      this.multipleSearchNguoiThu = 1;
    }
  }

  handleSearchMultipleCancel(): void {
    this.isSearchMultipleVisible = false;
  }

  // Thêm hàm mới để tạo kê khai từ dữ liệu API
  private async createKeKhaiFromApiData(data: any): Promise<{ success: boolean; message?: string }> {
    try {
      // Kiểm tra xem đối tượng có đang tham gia BHXH bắt buộc không
      if (data.isThamGiaBb === 1) {
        const theBhyt = data.soTheBHYT ? 
          `Số thẻ BHYT: ${data.soTheBHYT}` : 
          'Chưa có thông tin số thẻ BHYT';
          
        return {
          success: false,
          message: `Đối tượng đang tham gia BHXH bắt buộc.\n${theBhyt}`
        };
      }
      
      // Kiểm tra hạn thẻ cũ
      if (data.denNgayTheCu) {
        const denNgayTheCu = this.parseDate(data.denNgayTheCu);
        if (denNgayTheCu) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          const timeDiff = denNgayTheCu.getTime() - today.getTime();
          const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
          
          // Nếu thẻ còn hạn sử dụng > 60 ngày
          if (daysDiff > 60) {
            return {
              success: false,
              message: `Thẻ BHYT còn ${daysDiff} ngày sử dụng (> 60 ngày). Không thể tạo kê khai.`
            };
          }
        }
      }
      
      // Truy xuất thông tin đợt kê khai
      const dotKeKhai = await this.dotKeKhaiService.getDotKeKhai(this.dotKeKhaiId).toPromise();
      if (!dotKeKhai) {
        return { success: false, message: 'Không tìm thấy thông tin đợt kê khai' };
      }

      // Kiểm tra đối tượng đã được kê khai trong đợt này hay chưa
      const existingKeKhai = await this.keKhaiBHYTService.getByDotKeKhai(this.dotKeKhaiId).toPromise();
      const isExisting = existingKeKhai?.some(k => k.thongTinThe?.ma_so_bhxh === data.maSoBHXH);

      if (isExisting) {
        return { success: false, message: 'Mã số BHXH đã được kê khai trong đợt này' };
      }

      // Trích xuất ngày tháng từ dữ liệu
      const ngaySinhDate = this.formatNgaySinh(data.ngaySinh);
      
      // Xác định hạn thẻ cũ
      const denNgayTheCu = data.denNgayTheCu ? this.formatNgaySinh(data.denNgayTheCu) : null;
      
      // Kiểm tra phương án đóng
      const phuongAnDong = this.checkPhuongAnDong(denNgayTheCu);
      
      // Xác định thông tin đóng phí
      const nguoiThu = data.nguoiThu || 1;
      const soThangDong = this.multipleSearchSoThangDong || 3;
      
      // Tính hạn thẻ mới
      const ngayLap = new Date(); // Ngày lập là ngày hiện tại
      const hanTheMoiTu = this.tinhHanTheMoiTu(ngayLap, denNgayTheCu);
      const hanTheMoiDen = this.tinhHanTheMoiDen(hanTheMoiTu, soThangDong);
      
      // Tính số tiền cần đóng
      const soTienCanDong = this.tinhSoTienCanDong(nguoiThu, soThangDong);
      
      // Tạo đối tượng kê khai mới
      const keKhaiBHYT: KeKhaiBHYT = {
        id: 0, // ID sẽ được sinh bởi cơ sở dữ liệu
        dot_ke_khai_id: this.dotKeKhaiId,
        thong_tin_the_id: 0, // Sẽ được cấp sau khi tạo ThongTinThe
        thongTinThe: {
          ma_so_bhxh: data.maSoBHXH,
          ho_ten: data.hoTen,
          ngay_sinh: ngaySinhDate, // Sử dụng Date thay vì string
          gioi_tinh: data.gioiTinh === 1 ? 'Nam' : 'Nữ',
          cccd: data.cmnd || '',
          so_dien_thoai: data.soDienThoai || '',
          ma_hgd: data.maHoGiaDinh || '',
          ma_benh_vien: data.maBenhVien || '',
          benh_vien_kcb: data.maBenhVien || '',
          so_the_bhyt: data.soTheBHYT || '',
          ma_dan_toc: data.ma_dan_toc || data.danToc || '',
          quoc_tich: data.quoc_tich || data.quocTich || 'Việt Nam',
          nguoi_tao: this.currentUser.userName || this.currentUser.name || 'unknown_user'
        },
        nguoi_thu: nguoiThu,
        so_thang_dong: soThangDong,
        so_tien_can_dong: soTienCanDong,
        phuong_an_dong: phuongAnDong,
        han_the_cu: denNgayTheCu,
        han_the_moi_tu: hanTheMoiTu,
        han_the_moi_den: hanTheMoiDen,
        tinh_nkq: this.getTinhTen(data.maTinhNkq),
        huyen_nkq: this.getHuyenTen(data.maHuyenNkq),
        xa_nkq: this.getXaTen(data.maXaNkq),
        dia_chi_nkq: data.noiNhanHoSo || '',
        benh_vien_kcb: this.getBenhVienTen(data.maBenhVien || ''),
        ma_benh_vien: data.maBenhVien || '',
        nguoi_tao: this.currentUser.userName || this.currentUser.name || 'unknown_user',
        ngay_tao: new Date(),
        ngay_bien_lai: ngayLap,
        is_urgent: false,
        trang_thai: 'chua_gui'
      };
      
      // Lưu kê khai mới vào cơ sở dữ liệu
      try {
        await this.keKhaiBHYTService.create(this.dotKeKhaiId, keKhaiBHYT).toPromise();
        return { success: true };
      } catch (error: any) {
        return { 
          success: false, 
          message: error?.error?.message || 'Không thể tạo kê khai BHYT' 
        };
      }
    } catch (error) {
      console.error('Lỗi tạo kê khai từ dữ liệu API:', error);
      return { 
        success: false, 
        message: 'Có lỗi xảy ra khi tạo kê khai BHYT' 
      };
    }
  }

  // Cập nhật hàm handleSearchMultipleOk để sử dụng hàm mới
  async handleSearchMultipleOk(): Promise<void> {
    if (!this.multipleSearchText.trim()) {
      this.message.warning('Vui lòng nhập danh sách mã số BHXH');
      return;
    }

    if (!this.isHoGiaDinh && !this.multipleSearchNguoiThu) {
      this.message.warning('Vui lòng chọn người thứ');
      return;
    }

    if (this.isHoGiaDinh && !this.hoGiaDinhStartIndex) {
      this.message.warning('Vui lòng chọn người thứ bắt đầu');
      return;
    }

    if (!this.multipleSearchSoThangDong) {
      this.message.warning('Vui lòng chọn số tháng đóng');
      return;
    }

    this.isSearchingMultiple = true;
    this.searchResults = [];
    let loadingMessageId: string | undefined;
    
    try {
      const maSoBHXHList = this.multipleSearchText
        .split('\n')
        .map(item => item.trim())
        .filter(item => item.length === 10);

      if (maSoBHXHList.length === 0) {
        this.message.warning('Không tìm thấy mã số BHXH hợp lệ (phải có 10 số)');
        return;
      }

      const totalCount = maSoBHXHList.length;
      let successCount = 0;
      let failedCount = 0;
      let processedCount = 0;

      loadingMessageId = this.message.loading(
        `Đang xử lý 0/${totalCount} mã số BHXH...`, 
        { nzDuration: 0 }
      ).messageId;

      // Xử lý từng mã số BHXH
      for (let i = 0; i < maSoBHXHList.length; i++) {
        const maSoBHXH = maSoBHXHList[i];
        try {
          processedCount++;

          if (loadingMessageId) {
            this.message.remove(loadingMessageId);
            loadingMessageId = this.message.loading(
              `Đang xử lý ${processedCount}/${totalCount} mã số BHXH...`,
              { nzDuration: 0 }
            ).messageId;
          }

          const response = await this.keKhaiBHYTService.traCuuThongTinBHYT(maSoBHXH).toPromise();
          if (response && response.success) {
            // Kiểm tra isThamGiaBb
            if (response.data.isThamGiaBb === 1) {
              failedCount++;
              
              const theBhyt = response.data.soTheBHYT ? 
                `Số thẻ BHYT: ${response.data.soTheBHYT}` : 
                'Chưa có thông tin số thẻ BHYT';
                
              this.searchResults.push({
                maSoBHXH,
                status: 'error',
                message: `Họ tên: ${response.data.hoTen || 'Không có'}\nMã số BHXH: ${maSoBHXH}\n${theBhyt}\nĐối tượng đang tham gia BHXH bắt buộc.`
              });
              continue;
            }
            
            let nguoiThu: number;
            
            if (this.isHoGiaDinh) {
              // Trong chế độ Hộ gia đình:
              // - Sử dụng hoGiaDinhStartIndex làm người thứ bắt đầu
              // - Nếu (hoGiaDinhStartIndex + i) <= 5: gán người thứ theo (hoGiaDinhStartIndex + i)
              // - Nếu (hoGiaDinhStartIndex + i) > 5: gán người thứ 5 (người thứ 5 trở đi)
              const calculatedIndex = this.hoGiaDinhStartIndex + i;
              nguoiThu = calculatedIndex <= 5 ? calculatedIndex : 5;
            } else {
              // Trong chế độ thông thường, sử dụng người thứ được chọn
              nguoiThu = this.multipleSearchNguoiThu;
            }

            const result = await this.createKeKhaiFromApiData({
              ...response.data,
              nguoiThu: nguoiThu,
              ma_dan_toc: response.data.danToc,
              quoc_tich: response.data.quocTich
            });

            if (result.success) {
              successCount++;
              this.searchResults.push({
                maSoBHXH: this.isHoGiaDinh ? 
                  `${maSoBHXH} (${this.getNguoiThuText(nguoiThu)})` : 
                  maSoBHXH,
                status: 'success',
                message: 'Tạo kê khai thành công'
              });
            } else {
              failedCount++;
              this.searchResults.push({
                maSoBHXH: this.isHoGiaDinh ? 
                  `${maSoBHXH} (${this.getNguoiThuText(nguoiThu)})` : 
                  maSoBHXH,
                status: 'error',
                message: result.message || 'Không thể tạo kê khai'
              });
            }
          } else {
            failedCount++;
            this.searchResults.push({
              maSoBHXH,
              status: 'error',
              message: response?.message || 'Không tìm thấy thông tin BHYT'
            });
          }
        } catch (error) {
          failedCount++;
          this.searchResults.push({
            maSoBHXH,
            status: 'error',
            message: 'Lỗi khi xử lý mã số BHXH'
          });
        }
      }

      if (loadingMessageId) {
        this.message.remove(loadingMessageId);
      }

      this.message.success(`Đã xử lý ${successCount}/${totalCount} mã số BHXH thành công`);
      this.isSearchMultipleVisible = false;
      this.isSearchResultVisible = true;
      this.loadData();
    } catch (error) {
      this.message.error('Có lỗi xảy ra khi xử lý danh sách mã số BHXH');
    } finally {
      this.isSearchingMultiple = false;
      if (loadingMessageId) {
        this.message.remove(loadingMessageId);
      }
    }
  }

  handleSearchResultCancel(): void {
    this.isSearchResultVisible = false;
    this.searchResults = [];
  }

  // Thêm phương thức tính thống kê
  tinhThongKe(): void {
    // Sử dụng dữ liệu đã lọc thay vì toàn bộ dữ liệu
    const data = this.filterSoThangDong !== null ? this.filteredKeKhaiBHYTs : this.keKhaiBHYTs;
    
    this.thongKe.tongSoThe = data.length;
    this.thongKe.daoHan = data.filter(item => item.phuong_an_dong === 'dao_han').length;
    this.thongKe.tangMoi = data.filter(item => item.phuong_an_dong === 'tang_moi').length;
    this.thongKe.dungDong = data.filter(item => item.phuong_an_dong === 'dung_dong').length;
    this.thongKe.tongSoTien = data.reduce((sum, item) => sum + (item.so_tien_can_dong || 0), 0);
  }

  // Thêm các phương thức helper
  getSuccessResults(): SearchResult[] {
    return this.searchResults.filter(r => r.status === 'success');
  }

  getErrorResults(): SearchResult[] {
    return this.searchResults.filter(r => r.status === 'error');
  }

  getSuccessCount(): number {
    return this.getSuccessResults().length;
  }

  getErrorCount(): number {
    return this.getErrorResults().length;
  }

  showQuetCCCDModal(): void {
    this.isQuetCCCDVisible = true;
    this.clearImages();
    
    // Tự động focus vào modal sau khi nó được mở
    setTimeout(() => {
      const modalContent = document.querySelector('.ant-modal-content');
      if (modalContent) {
        const focusableElement = modalContent.querySelector('[tabindex="0"]') as HTMLElement;
        if (focusableElement) {
          focusableElement.focus();
        }
      }
    }, 100);
  }

  handleQuetCCCDCancel(): void {
    this.isQuetCCCDVisible = false;
    this.clearImages();
  }

  beforeUpload = (file: NzUploadFile): boolean => {
    const isJpgOrPng = file.type === 'image/jpeg' || file.type === 'image/png';
    if (!isJpgOrPng) {
      this.message.error('Bạn chỉ có thể tải lên file JPG/PNG!');
      return false;
    }
    const isLt2M = (file.size || 0) / 1024 / 1024 < 2;
    if (!isLt2M) {
      this.message.error('Ảnh phải nhỏ hơn 2MB!');
      return false;
    }
    this.addToPendingFiles(file as any);
    return false;
  };

  handleChange(info: { file: NzUploadFile, fileList: NzUploadFile[] }): void {
    if (info.file.status !== 'uploading') {
      console.log('File upload status changed:', info.file.status);
    }
    if (info.file.status === 'done') {
      this.message.success(`${info.file.name} đã được tải lên thành công`);
      if (info.file.originFileObj) {
        this.addToPendingFiles(info.file.originFileObj);
      }
    } else if (info.file.status === 'error') {
      this.message.error(`${info.file.name} tải lên thất bại.`);
    }
  }

  handlePaste(event: ClipboardEvent): void {
    if (!event.clipboardData) {
      return;
    }
    
    const items = event.clipboardData.items;
    let imageFound = false;
    
    for (let i = 0; i < items.length; i++) {
      if (items[i].type.indexOf('image') !== -1) {
        imageFound = true;
        const blob = items[i].getAsFile();
        
        if (blob) {
          // Kiểm tra kích thước file
          const isLt2M = blob.size / 1024 / 1024 < 2;
          if (!isLt2M) {
            this.message.error('Ảnh phải nhỏ hơn 2MB!');
            return;
          }
          
          // Tạo tên file ngẫu nhiên
          const fileName = `pasted-image-${new Date().getTime()}.png`;
          const file = new File([blob], fileName, { type: 'image/png' });
          
          this.message.success('Đã dán ảnh từ clipboard');
          this.addToPendingFiles(file);
        }
        break;
      }
    }
    
    if (!imageFound) {
      this.message.info('Không tìm thấy ảnh trong clipboard');
    }
  }

  requestPasteFromClipboard(): void {
    // Hiển thị thông báo hướng dẫn
    this.message.info('Nhấn Ctrl+V để dán ảnh từ clipboard');
    
    // Focus vào modal để nhận sự kiện paste
    const modalContent = document.querySelector('.ant-modal-content');
    if (modalContent) {
      const focusableElement = modalContent.querySelector('[tabindex="0"]') as HTMLElement;
      if (focusableElement) {
        focusableElement.focus();
      }
    }
    
    // Thử đọc clipboard thông qua Clipboard API (chỉ hoạt động trên HTTPS)
    if (navigator.clipboard && navigator.clipboard.read) {
      navigator.clipboard.read()
        .then(clipboardItems => {
          for (const clipboardItem of clipboardItems) {
            for (const type of clipboardItem.types) {
              if (type.startsWith('image/')) {
                clipboardItem.getType(type)
                  .then(blob => {
                    const fileName = `pasted-image-${new Date().getTime()}.png`;
                    const file = new File([blob], fileName, { type });
                    this.addToPendingFiles(file);
                    this.message.success('Đã dán ảnh từ clipboard');
                  })
                  .catch(err => {
                    console.error('Lỗi khi đọc ảnh từ clipboard:', err);
                  });
                return;
              }
            }
          }
        })
        .catch(err => {
          console.log('Không thể truy cập clipboard qua API:', err);
          // Không hiển thị lỗi cho người dùng vì đây là tính năng bổ sung
        });
    }
  }

  private addToPendingFiles(file: File): void {
    console.log('Adding file to pending:', file);
    this.getBase64(file, (img: string) => {
      console.log('Generated base64 preview');
      this.avatarUrls = [...this.avatarUrls, img];
      this.pendingFiles = [...this.pendingFiles, file];
      this.currentImageIndex = this.avatarUrls.length - 1;
    });
  }

  previousImage(): void {
    if (this.currentImageIndex > 0) {
      this.currentImageIndex--;
    }
  }

  nextImage(): void {
    if (this.currentImageIndex < this.avatarUrls.length - 1) {
      this.currentImageIndex++;
    }
  }

  clearImages(): void {
    this.avatarUrls = [];
    this.pendingFiles = [];
    this.currentImageIndex = 0;
    this.danhSachCCCD = [];
  }

  async quetTatCaCCCD(): Promise<void> {
    if (this.pendingFiles.length === 0) {
      this.message.warning('Vui lòng tải lên ít nhất một ảnh CCCD!');
      return;
    }

    this.loadingQuetCCCD = true;
    this.danhSachCCCD = [];

    try {
      for (const file of this.pendingFiles) {
        try {
          const response = await this.cccdService.quetCCCD(file).toPromise();
          console.log('Raw API Response:', response);

          // FPT.AI trả về dữ liệu trong response.data
          if (response && response.data && response.data.length > 0) {
            const cccdData = response.data[0];
            console.log('CCCD Data from FPT.AI:', cccdData);

            // Chuyển đổi dữ liệu từ FPT.AI sang định dạng CCCDResult
            const result: CCCDResult = {
              id: cccdData.id_number || cccdData.id || '',
              name: cccdData.name || '',
              dob: cccdData.birth_date || cccdData.dob || '',
              sex: this.formatGender(cccdData.gender || cccdData.sex || ''),
              nationality: 'Việt Nam',
              address: this.formatAddress(cccdData.residence || cccdData.address),
              home_address: {
                province: this.extractProvince(cccdData.home),
                district: this.extractDistrict(cccdData.home),
                ward: this.extractWard(cccdData.home),
                street: this.extractStreet(cccdData.home)
              },
              permanent_address: {
                province: this.extractProvince(cccdData.residence || cccdData.address),
                district: this.extractDistrict(cccdData.residence || cccdData.address),
                ward: this.extractWard(cccdData.residence || cccdData.address),
                street: this.extractStreet(cccdData.residence || cccdData.address)
              },
              status: 'success',
              message: 'Quét thành công'
            };

            console.log('Processed CCCD Result:', result);
            this.danhSachCCCD = [...this.danhSachCCCD, result];
          } else {
            const errorResult: CCCDResult = {
              id: '',
              name: '',
              dob: '',
              sex: '',
              nationality: '',
              address: '',
              status: 'error',
              message: 'Không nhận dạng được thông tin'
            };
            this.danhSachCCCD = [...this.danhSachCCCD, errorResult];
          }
        } catch (error: any) {
          console.error('Error scanning CCCD:', error);
          const errorResult: CCCDResult = {
            id: '',
            name: '',
            dob: '',
            sex: '',
            nationality: '',
            address: '',
            status: 'error',
            message: error?.error?.message || error?.message || 'Lỗi khi xử lý ảnh'
          };
          this.danhSachCCCD = [...this.danhSachCCCD, errorResult];
        }
      }

      // Cập nhật UI
      this.danhSachCCCD = [...this.danhSachCCCD];
      console.log('Final CCCD List:', this.danhSachCCCD);

      const successCount = this.danhSachCCCD.filter(cccd => cccd.status === 'success').length;
      if (successCount > 0) {
        this.message.success(`Đã quét thành công ${successCount} CCCD`);
      } else {
        this.message.error('Không thể đọc thông tin từ các ảnh đã tải lên');
      }
    } finally {
      this.loadingQuetCCCD = false;
    }
  }

  // Thêm các phương thức hỗ trợ xử lý dữ liệu
  private formatGender(gender: string): string {
    if (!gender) return '';
    const normalizedGender = gender.toUpperCase();
    if (normalizedGender.includes('NAM') || normalizedGender === 'MALE') return 'Nam';
    if (normalizedGender.includes('NỮ') || normalizedGender === 'FEMALE') return 'Nữ';
    return gender;
  }

  private formatAddress(addressData: any): string {
    if (!addressData) return '';
    const parts = [];
    
    if (typeof addressData === 'string') {
      return addressData;
    }

    if (addressData.street) parts.push(addressData.street);
    if (addressData.ward) parts.push(addressData.ward);
    if (addressData.district) parts.push(addressData.district);
    if (addressData.province) parts.push(addressData.province);

    return parts.join(', ');
  }

  private extractProvince(address?: any): string {
    if (!address) return '';
    return typeof address === 'object' ? (address.province || '').trim() : '';
  }

  private extractDistrict(address?: any): string {
    if (!address) return '';
    return typeof address === 'object' ? (address.district || '').trim() : '';
  }

  private extractWard(address?: any): string {
    if (!address) return '';
    return typeof address === 'object' ? (address.ward || '').trim() : '';
  }

  private extractStreet(address?: any): string {
    if (!address) return '';
    return typeof address === 'object' ? (address.street || '').trim() : '';
  }

  apDungThongTin(cccd: CCCDResult, closeModal: boolean = true): void {
    if (cccd.status === 'success') {
      // Cập nhật thông tin cơ bản
      this.form.patchValue({
        cccd: cccd.id,
        ho_ten: cccd.name,
        ngay_sinh: new Date(this.formatDate(cccd.dob)),
        gioi_tinh: cccd.sex === 'NAM' ? 'Nam' : 'Nữ',
        quoc_tich: cccd.nationality
      });

      // Áp dụng địa chỉ thường trú nếu được chọn
      if (this.applyPermanentAddress && cccd.permanent_address) {
        const { province, district, ward, street } = cccd.permanent_address;
        this.form.patchValue({
          dia_chi_nkq: this.formatFullAddress(cccd.permanent_address)
        });
        this.updateAddressFields(province, district, ward);
      }

      // Áp dụng quê quán nếu được chọn
      if (this.applyHomeAddress && cccd.home_address) {
        const { province, district, ward, street } = cccd.home_address;
        this.form.patchValue({
          que_quan: this.formatFullAddress(cccd.home_address)
        });
        this.updateHomeAddressFields(province, district, ward);
      }

      if (closeModal) {
        this.message.success('Đã áp dụng thông tin CCCD');
        this.isQuetCCCDVisible = false;
      }
    }
  }

  // Thêm phương thức mới để cập nhật trường quê quán
  private async updateHomeAddressFields(province: string, district: string, ward: string) {
    // Tìm mã tỉnh
    const tinh = this.danhMucTinhs.find(t => t.ten.toUpperCase().includes(province.toUpperCase()));
    if (tinh) {
      this.form.patchValue({ tinh_qq: tinh.ma });
      
      // Load và tìm mã huyện
      await this.loadDanhMucHuyenByMaTinh(tinh.ma);
      const huyen = this.danhMucHuyens.find(h => h.ten.toUpperCase().includes(district.toUpperCase()));
      if (huyen) {
        this.form.patchValue({ huyen_qq: huyen.ma });
        
        // Load và tìm mã xã
        await this.loadDanhMucXaByMaHuyen(huyen.ma);
        const xa = this.danhMucXas.find(x => x.ten.toUpperCase().includes(ward.toUpperCase()));
        if (xa) {
          this.form.patchValue({ xa_qq: xa.ma });
        }
      }
    }
  }

  // Thêm phương thức hỗ trợ format ngày
  private formatDate(dateStr: string): string {
    if (!dateStr) return '';
    
    // Kiểm tra nếu dateString đã ở định dạng yyyy-MM-dd
    if (dateStr.includes('-')) {
      const [year, month, day] = dateStr.split('-');
      return `${day}/${month}/${year}`;
    }
    
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return '';
    
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    
    return `${day}/${month}/${year}`;
  }

  // Thêm phương thức cập nhật các trường địa chỉ
  private async updateAddressFields(province: string, district: string, ward: string) {
    try {
      // Tải danh mục tỉnh nếu chưa có
      if (this.danhMucTinhs.length === 0) {
        await this.loadDanhMucTinh();
      }
      
      // Tìm mã tỉnh
      const tinh = this.danhMucTinhs.find(t => 
        t.ten.toUpperCase().includes(province.toUpperCase())
      );
      
      if (tinh) {
        // Cập nhật mã tỉnh
        this.form.patchValue({ tinh_nkq: tinh.ma });
        
        // Tải danh mục huyện sử dụng phương thức đã tối ưu
        await this.loadDanhMucHuyenByMaTinh(tinh.ma);
        
        // Tìm mã huyện
        const huyen = this.danhMucHuyens.find(h => 
          h.ten.toUpperCase().includes(district.toUpperCase())
        );
        
        if (huyen) {
          // Cập nhật mã huyện
          this.form.patchValue({ huyen_nkq: huyen.ma });
          
          // Tải danh mục xã sử dụng phương thức đã tối ưu
          await this.loadDanhMucXaByMaHuyen(huyen.ma);
          
          // Tìm mã xã
          const xa = this.danhMucXas.find(x => 
            x.ten.toUpperCase().includes(ward.toUpperCase())
          );
          
          if (xa) {
            // Cập nhật mã xã
            this.form.patchValue({ xa_nkq: xa.ma });
          }
        }
      }
    } catch (error) {
      console.error('Lỗi trong quá trình cập nhật địa chỉ:', error);
    }
  }

  // Thêm phương thức getBase64 vào class KeKhaiBHYTComponent
  private getBase64(img: File, callback: (img: string) => void): void {
    const reader = new FileReader();
    reader.addEventListener('load', () => callback(reader.result!.toString()));
    reader.readAsDataURL(img);
  }

  // Thêm phương thức mới cho danh sách kê khai
  onKeKhaiChecked(id: number, checked: boolean): void {
    if (checked) {
      this.selectedIds = [...this.selectedIds, id];
    } else {
      this.selectedIds = this.selectedIds.filter(item => item !== id);
    }
    this.isAllChecked = this.keKhaiBHYTs.every(item => this.selectedIds.includes(item.id!));
  }

  // Thêm phương thức mới để format địa chỉ đầy đủ
  public formatFullAddress(address?: { province: string; district: string; ward: string; street?: string }): string {
    if (!address) return '';
    
    const parts = [];
    if (address.street?.trim()) parts.push(address.street.trim());
    if (address.ward?.trim()) parts.push(address.ward.trim());
    if (address.district?.trim()) parts.push(address.district.trim());
    if (address.province?.trim()) parts.push(address.province.trim());
    
    return parts.join(', ') || '';
  }

  // Thêm phương thức showEditForm
  showEditForm(data: KeKhaiBHYT): void {
    this.isVisible = true;
    this.isEdit = true;
    this.form.reset();

    if (data) {
      console.log('Modal data:', data);
      
      // Đảm bảo danh mục bệnh viện đã được load
      if (!this.danhMucCSKCBs || this.danhMucCSKCBs.length === 0) {
        this.keKhaiBHYTService.getDanhMucCSKCB().subscribe({
          next: (cskcbs) => {
            this.danhMucCSKCBs = cskcbs;
            // Truyền data gốc vào setFormValues
            this.setFormValues(data);
          },
          error: (error) => {
            console.error('Error loading CSKCB:', error);
            this.message.error('Có lỗi xảy ra khi tải danh sách cơ sở KCB');
          }
        });
      } else {
        // Truyền data gốc vào setFormValues
        this.setFormValues(data);
      }
    }
  }

  // Tách phần gán giá trị form ra một phương thức riêng
  private setFormValues(data: KeKhaiBHYT): void {
    if (data.thongTinThe) {
      // Xử lý ngày sinh
      let ngaySinh = '';
      if (data.thongTinThe.ngay_sinh) {
        const ngaySinhDate = this.formatNgaySinh(data.thongTinThe.ngay_sinh);
        ngaySinh = this.formatDateToString(ngaySinhDate);
      }
      
      this.form.patchValue({
        ma_so_bhxh: data.thongTinThe.ma_so_bhxh,
        cccd: data.thongTinThe.cccd,
        ho_ten: data.thongTinThe.ho_ten,
        ngay_sinh: ngaySinh,
        gioi_tinh: data.thongTinThe.gioi_tinh,
        so_dien_thoai: data.thongTinThe.so_dien_thoai,
        ma_hgd: data.thongTinThe.ma_hgd,
        ma_tinh_ks: data.thongTinThe.ma_tinh_ks,
        tinh_nkq: data.thongTinThe.ma_tinh_nkq,
        huyen_nkq: data.thongTinThe.ma_huyen_nkq,
        xa_nkq: data.thongTinThe.ma_xa_nkq,
        dia_chi_nkq: data.thongTinThe.dia_chi_nkq || '',
        // Tìm bệnh viện trong danh mục và gán value
        benh_vien_kcb: this.danhMucCSKCBs.find(bv => bv.ma === data.ma_benh_vien)?.value || '',
        so_the_bhyt: data.thongTinThe.so_the_bhyt,
        ma_dan_toc: data.thongTinThe.ma_dan_toc,
        quoc_tich: data.thongTinThe.quoc_tich
      });

      // Load danh sách huyện và xã dựa trên mã tỉnh/huyện đã chọn
      if (data.thongTinThe.ma_tinh_ks) {
        this.diaChiService.getDanhMucHuyenByMaTinh(data.thongTinThe.ma_tinh_ks).subscribe({
          next: (huyens) => {
            this.danhMucHuyenKS = huyens.sort((a, b) => a.ten.localeCompare(b.ten, 'vi'));
            console.log('Loaded huyện KS:', this.danhMucHuyenKS);
          },
          error: (error) => {
            console.error('Error loading huyện KS:', error);
            this.message.error('Có lỗi xảy ra khi tải danh sách quận/huyện KS');
          }
        });
      }

      // Sửa lại cách gán giá trị cho benh_vien_kcb
      const benhVienValue = data.ma_benh_vien || data.thongTinThe.ma_benh_vien;
      
      this.form.patchValue({
        // Các trường khác giữ nguyên...
        benh_vien_kcb: benhVienValue, // Gán trực tiếp mã bệnh viện
        ma_benh_vien: benhVienValue
      });

      console.log('Bệnh viện được chọn:', {
        ma_benh_vien: benhVienValue,
        danh_sach_benh_vien: this.danhMucCSKCBs
      });
    }

    // Patch các thông tin khác
    this.form.patchValue({
      id: data.id,
      thong_tin_the_id: data.thong_tin_the_id,
      nguoi_thu: data.nguoi_thu,
      so_thang_dong: data.so_thang_dong,
      phuong_an_dong: data.phuong_an_dong,
      han_the_cu: data.han_the_cu,
      han_the_moi_tu: data.han_the_moi_tu,
      han_the_moi_den: data.han_the_moi_den,
      dia_chi_nkq: data.dia_chi_nkq,
      so_tien_can_dong: data.so_tien_can_dong,
      ngay_bien_lai: data.ngay_bien_lai || new Date(),
      so_bien_lai: data.so_bien_lai,
      quyen_bien_lai_id: data.quyen_bien_lai_id,
      trang_thai: data.trang_thai // Thêm trường trang_thai vào form
    });

    // Log để kiểm tra
    console.log('Form values after patch:', this.form.value);
  }

  getPhuongAnDongText(phuongAnDong: string): string {
    switch (phuongAnDong) {
      case 'tang_moi':
        return 'Tăng mới';
      case 'dao_han':
        return 'Đáo hạn';
      case 'dung_dong':
        return 'Dừng đóng';
      default:
        return '';
    }
  }

  getPhuongAnDongColor(phuongAnDong: string): string {
    switch (phuongAnDong) {
      case 'tang_moi':
        return 'blue';
      case 'dao_han':
        return 'green';
      case 'dung_dong':
        return 'red';
      default:
        return 'default';
    }
  }

  async xuatTK1(): Promise<void> {
    const selectedCCCDs = this.danhSachCCCD.filter(cccd => cccd.checked && cccd.status === 'success');
    if (selectedCCCDs.length === 0) {
      this.message.warning('Vui lòng chọn ít nhất một CCCD để xuất TK1');
      return;
    }

    try {
      // Tải file mẫu
      const response = await fetch('assets/templates/FileMau_TK1.docx');
      if (!response.ok) {
        throw new Error('Không tìm thấy file mẫu TK1');
      }
      const buffer = await response.arrayBuffer();

      // Xử lý từng CCCD đã chọn
      for (const cccd of selectedCCCDs) {
        const zip = new PizZip(buffer);
        const doc = new Docxtemplater().loadZip(zip);

        // Format ngày sinh
        const ngaySinh = cccd.dob ? this.formatDateForTK1(cccd.dob) : '';

        // Xử lý địa chỉ thường trú từ address
        const addressParts = this.parseAddress(cccd.address || '');
        
        // Xử lý quê quán từ home
        const homeParts = this.parseAddress(cccd.home || '');

        // Lấy ngày tháng năm hiện tại cho phần chữ ký
        const now = new Date();
        const ngay = now.getDate();
        const thang = now.getMonth() + 1;
        const nam = now.getFullYear();

        const data = {
          hoten: cccd.name || '',
          gioitinh: cccd.sex || '',
          ngaysinh: ngaySinh,
          quoctich: cccd.nationality || 'Việt Nam',
          dantoc: 'Kinh',
          cccd: cccd.id || '',
          dienthoai: '',
          email: '',
          noisinh_xa: homeParts.ward || '',
          noisinh_huyen: homeParts.district || '',
          noisinh_tinh: homeParts.province || '',
          diachi: addressParts.street || '',
          diachi_xa: addressParts.ward || '',
          diachi_huyen: addressParts.district || '',
          diachi_tinh: addressParts.province || '',
          ngay: ngay.toString(),
          thang: thang.toString(),
          nam: nam.toString(),
          noidung: 'Xin mã số'
        };

        doc.setData(data);

        try {
          doc.render();
          const out = doc.getZip().generate({
            type: 'blob',
            mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
          });

          // Tạo tên file riêng cho từng người
          const fileName = `tk1-${cccd.name}-${new Date().getTime()}.docx`;
          saveAs(out, fileName);
        } catch (error) {
          console.error(`Lỗi khi render template cho ${cccd.name}:`, error);
          this.message.error(`Có lỗi xảy ra khi tạo file TK1 cho ${cccd.name}`);
        }
      }

      this.message.success(`Đã xuất ${selectedCCCDs.length} file TK1 thành công`);
    } catch (error) {
      console.error('Lỗi xuất TK1:', error);
      this.message.error('Có lỗi xảy ra khi xuất TK1');
    }
  }

  // Thêm phương thức mới để parse địa chỉ từ chuỗi
  private parseAddress(addressStr: string): {
    street?: string;
    ward?: string;
    district?: string;
    province?: string;
  } {
    if (!addressStr) return {};

    // Tách chuỗi địa chỉ theo dấu phẩy và chuẩn hóa mỗi phần
    const parts = addressStr.split(',')
      .map(part => this.capitalizeFirstLetter(part.trim()));

    switch (parts.length) {
      case 4: // Đầy đủ: street, ward, district, province
        return {
          street: parts[0],
          ward: parts[1],
          district: parts[2],
          province: parts[3]
        };
      case 3: // Thiếu street: ward, district, province
        return {
          ward: parts[0],
          district: parts[1],
          province: parts[2]
        };
      case 2: // Chỉ có district, province
        return {
          district: parts[0],
          province: parts[1]
        };
      case 1: // Chỉ có province
        return {
          province: parts[0]
        };
      default:
        return {
          street: this.capitalizeFirstLetter(addressStr) // Chuẩn hóa cả trường hợp mặc định
        };
    }
  }

  // Cập nhật hàm format ngày tháng
  private formatDateForTK1(dateStr: string): string {
    try {
      if (!dateStr) return '';
      
      // Kiểm tra nếu đã đúng định dạng dd/MM/yyyy
      if (dateStr.includes('/')) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
          return dateStr; // Giữ nguyên nếu đã đúng định dạng
        }
      }

      // Xử lý các định dạng khác
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) {
        return dateStr; // Trả về nguyên gốc nếu không parse được
      }

      // Format về dd/MM/yyyy
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    } catch {
      return dateStr; // Trả về nguyên gốc nếu có lỗi
    }
  }

  // Thêm hàm chuẩn hóa chữ hoa đầu câu
  private capitalizeFirstLetter(str: string): string {
    if (!str) return '';
    // Tách chuỗi thành các từ
    const words = str.toLowerCase().split(' ');
    // Viết hoa chữ cái đầu của mỗi từ
    return words.map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
  }

  // Thêm phương thức copy thông tin
  copyThongTin(cccd: CCCDResult): void {
    if (!cccd) return;

    // Format thông tin theo yêu cầu, bỏ mã số BH ở đầu
    const thongTin = [
      cccd.name || '', // Họ và tên
      cccd.sex || '', // Giới tính
      cccd.dob || '', // Ngày tháng năm sinh
      cccd.address || '', // Địa chỉ
      cccd.id || '', // CCCD
      '' // Số điện thoại
    ].join('\t');

    // Copy vào clipboard
    navigator.clipboard.writeText(thongTin).then(() => {
      this.message.success('Đã sao chép thông tin');
    }).catch(err => {
      console.error('Lỗi khi sao chép:', err);
      this.message.error('Có lỗi xảy ra khi sao chép thông tin');
    });
  }

  // Thêm phương thức copy nhiều thông tin
  copyNhieuThongTin(): void {
    const selectedCCCDs = this.danhSachCCCD.filter(cccd => cccd.checked && cccd.status === 'success');
    if (selectedCCCDs.length === 0) {
      this.message.warning('Vui lòng chọn ít nhất một CCCD để sao chép thông tin');
      return;
    }
    
    // Format dữ liệu, bỏ mã số BH ở đầu
    const rows = selectedCCCDs.map(cccd => [
      cccd.name || '', // Họ và tên
      cccd.sex || '', // Giới tính
      cccd.dob || '', // Ngày tháng năm sinh
      cccd.address || '', // Địa chỉ
      cccd.id || '', // CCCD
      '' // Số điện thoại
    ]);

    // Chỉ join các rows
    const allData = rows.map(row => row.join('\t')).join('\n');

    // Copy vào clipboard
    navigator.clipboard.writeText(allData).then(() => {
      this.message.success(`Đã sao chép thông tin của ${selectedCCCDs.length} người`);
    }).catch(err => {
      console.error('Lỗi khi sao chép:', err);
      this.message.error('Có lỗi xảy ra khi sao chép thông tin');
    });
  }

  @HostListener('window:keydown', ['$event'])
  handleKeyboardEvent(event: KeyboardEvent) {
    // Kiểm tra nếu là Ctrl + S
    if (event.ctrlKey && event.key === 's') {
      event.preventDefault(); // Ngăn chặn hành vi mặc định của trình duyệt
      if (this.form.valid) {
        this.handleOk();
      } else {
        this.message.warning('Vui lòng điền đầy đủ thông tin bắt buộc');
      }
    }
  }

  // Thêm phương thức xử lý khi bấm nút Lưu
  onSave(): void {
    if (this.loadingSave) {
      return;
    }

    // Log để kiểm tra trạng thái form
    console.log('Form valid:', this.form.valid);
    console.log('Form values:', this.form.value);
    console.log('Form errors:', this.form.errors);

    // Log chi tiết các trường invalid
    Object.keys(this.form.controls).forEach(key => {
      const control = this.form.get(key);
      if (control?.invalid) {
        console.log(`Field ${key} errors:`, control.errors);
      }
    });

    if (this.form.valid) {
      this.loadingSave = true;
      this.handleOk();
    } else {
      // Đánh dấu tất cả các trường là đã chạm vào để hiển thị lỗi
      Object.values(this.form.controls).forEach(control => {
        if (control.invalid) {
          control.markAsTouched();
          control.updateValueAndValidity({ onlySelf: true });
        }
      });

      // Hiển thị thông báo chi tiết hơn về các trường bị lỗi
      const invalidFields = Object.keys(this.form.controls)
        .filter(key => this.form.get(key)?.invalid)
        .map(key => {
          // Map tên field sang tên hiển thị
          const fieldNames: {[key: string]: string} = {
            ma_so_bhxh: 'Mã số BHXH',
            cccd: 'CCCD',
            ho_ten: 'Họ tên',
            ngay_sinh: 'Ngày sinh',
            gioi_tinh: 'Giới tính',
            nguoi_thu: 'Người thứ',
            so_thang_dong: 'Số tháng đóng',
            tinh_nkq: 'Tỉnh NKQ',
            huyen_nkq: 'Huyện NKQ',
            xa_nkq: 'Xã NKQ',
            dia_chi_nkq: 'Địa chỉ NKQ',
            benh_vien_kcb: 'Bệnh viện KCB'
          };
          return fieldNames[key] || key;
        });

      if (invalidFields.length > 0) {
        this.message.warning(`Vui lòng điền đầy đủ thông tin: ${invalidFields.join(', ')}`);
      } else {
        this.message.warning('Vui lòng điền đầy đủ thông tin bắt buộc');
      }
    }
  }

  // Thêm phương thức xử lý paste ngày sinh
  handleNgaySinhPaste(event: ClipboardEvent): void {
    event.preventDefault();
    
    // Lấy text từ clipboard
    const clipboardData = event.clipboardData;
    let pastedText = clipboardData?.getData('text') || '';
    
    // Thử parse các định dạng ngày phổ biến
    let formattedDate = '';
    
    // Thử các định dạng phổ biến
    const formats = [
      /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, // dd/MM/yyyy
      /^(\d{4})-(\d{1,2})-(\d{1,2})$/,   // yyyy-MM-dd
      /^(\d{1,2})-(\d{1,2})-(\d{4})$/    // dd-MM-yyyy
    ];

    for (const format of formats) {
      const match = pastedText.match(format);
      if (match) {
        try {
          let day, month, year;
          if (format === formats[0]) { // dd/MM/yyyy
            [, day, month, year] = match;
          } else if (format === formats[1]) { // yyyy-MM-dd
            [, year, month, day] = match;
          } else { // dd-MM-yyyy
            [, day, month, year] = match;
          }
          
          // Chuẩn hóa về định dạng dd/MM/yyyy
          formattedDate = `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
          break;
        } catch (e) {
          console.error('Lỗi parse ngày:', e);
        }
      }
    }

    // Nếu parse được ngày hợp lệ
    if (formattedDate) {
      const input = event.target as HTMLInputElement;
      input.value = formattedDate;
      this.form.patchValue({
        ngay_sinh: formattedDate
      });
    } else {
      this.message.warning('Định dạng ngày không hợp lệ. Vui lòng sử dụng định dạng dd/MM/yyyy');
    }
  }

  copyMaSoBHXH(maSoBHXH: string): void {
    const el = document.createElement('textarea');
    el.value = maSoBHXH;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    this.message.success('Đã sao chép mã số BHXH: ' + maSoBHXH);
  }

  copyNhieuMaSoBHXH(): void {
    const selectedKeKhai = this.keKhaiBHYTs.filter(item => this.selectedIds.includes(item.id || 0));
    if (selectedKeKhai.length === 0) {
      this.message.warning('Vui lòng chọn ít nhất một mã số BHXH để sao chép');
      return;
    }

    const maSoBHXHList = selectedKeKhai.map(item => item.thongTinThe.ma_so_bhxh).join('\n');
    const el = document.createElement('textarea');
    el.value = maSoBHXHList;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    this.message.success(`Đã sao chép ${selectedKeKhai.length} mã số BHXH`);
  }

  // Thêm phương thức nhận diện thông tin từ chuỗi
  parseInfoFromString(input: string): any {
    const parts = input.split('\t').map(part => part.trim());
    if (parts.length >= 7) {
      const [maSoBHXH, hoTen, gioiTinh, ngaySinh, diaChi, soCCCD, soDienThoai] = parts;
      
      // Kiểm tra và chuẩn hóa dữ liệu
      if (!maSoBHXH || !hoTen || !ngaySinh || !soCCCD) {
        this.message.warning('Thiếu thông tin bắt buộc: Mã số BHXH, Họ tên, Ngày sinh hoặc CCCD');
        return null;
      }

      return {
        maSoBHXH: maSoBHXH,
        hoTen: this.capitalizeFullName(hoTen),
        gioiTinh: this.normalizeGender(gioiTinh),
        ngaySinh: this.parseNgaySinh(ngaySinh),
        diaChi: diaChi,
        soCCCD: soCCCD,
        soDienThoai: soDienThoai
      };
    }
    return null;
  }

  // Thêm các phương thức hỗ trợ
  private capitalizeFullName(name: string): string {
    return name.split(' ')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
      .join(' ');
  }

  private normalizeGender(gender: string): 'Nam' | 'Nữ' {
    const normalizedGender = gender.toLowerCase().trim();
    return normalizedGender === 'nam' || normalizedGender === 'nam' ? 'Nam' : 'Nữ';
  }

  // Hàm hỗ trợ chuyển đổi ngày sinh sang định dạng yyyy-MM-dd
  private parseNgaySinh(dateStr: string): string {
    const parts = dateStr.split('/');
    if (parts.length === 3) {
      return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
    }
    return dateStr;
  }

  // Thêm phương thức điền thông tin vào form
  fillFormFromString(input: string): void {
    const info = this.parseInfoFromString(input);
    if (info) {
      // Chuyển đổi ngày sinh sang đối tượng Date
      const [day, month, year] = info.ngaySinh.split('-').reverse();
      const ngaySinh = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));

      // Chỉ cập nhật các thông tin cơ bản từ dữ liệu đầu vào
      this.form.patchValue({
        ma_so_bhxh: info.maSoBHXH,
        cccd: info.soCCCD,
        ho_ten: info.hoTen,
        ngay_sinh: ngaySinh,
        gioi_tinh: info.gioiTinh,
        so_dien_thoai: info.soDienThoai,
        dia_chi_nkq: info.diaChi
      });

      // Hiển thị thông báo thành công
      this.message.success('Đã điền thông tin tự động vào form');
    } else {
      this.message.error('Không thể nhận diện thông tin từ chuỗi dữ liệu');
    }
  }

  // Thêm phương thức hiển thị modal
  showQuickInputModal(): void {
    this.isQuickInputVisible = true;
    this.quickInputText = '';
  }

  // Thêm phương thức đóng modal
  handleQuickInputCancel(): void {
    this.isQuickInputVisible = false;
  }

  // Thêm phương thức xử lý khi nhấn OK
  async handleQuickInputOk(): Promise<void> {
    if (!this.quickInputText.trim()) {
      this.message.warning('Vui lòng nhập thông tin cần xử lý');
      return;
    }

    this.isProcessing = true;
    try {
      this.fillFormFromString(this.quickInputText);
      this.isQuickInputVisible = false;
    } catch (error) {
      this.message.error('Có lỗi xảy ra khi xử lý thông tin');
    } finally {
      this.isProcessing = false;
    }
  }

  // Thêm phương thức lấy token
  getAccessToken(): void {
    this.isLoginVisible = true;
    this.getCaptcha();
  }

  getCaptcha(): void {
    this.ssmv2Service.getCaptcha().subscribe({
      next: (res) => {
        console.log('Captcha response:', res); // Log để debug
        if (res && res.data) {
          this.captchaImage = res.data.image;
          this.captchaCode = res.data.code;
        } else {
          this.message.error('Không nhận được dữ liệu captcha');
        }
      },
      error: (err) => {
        console.error('Captcha error:', err); // Log để debug
        this.message.error('Lỗi khi lấy captcha: ' + err.message);
      }
    });
  }

  handleLogin(): void {
    if (this.loginForm.get('text')?.valid) {
      this.loadingLogin = true;
      
      const data = {
        grant_type: 'password',
        userName: this.loginForm.get('userName')?.value,
        password: this.loginForm.get('password')?.value,
        text: this.loginForm.get('text')?.value,
        code: this.captchaCode,
        clientId: 'ZjRiYmI5ZTgtZDcyOC00ODRkLTkyOTYtMDNjYmUzM2U4Yjc5',
        isWeb: true
      };

      this.ssmv2Service.authenticate(data).subscribe({
        next: (response) => {
          this.loadingLogin = false;
          
          if (response.body?.access_token) {
            this.message.success('Xác thực thành công');
            this.isLoginVisible = false;
            
            if (this.form.get('ma_so_bhxh')?.value) {
              this.onSearchBHYT();
            }
          } else {
            this.message.error('Không nhận được token');
            this.getCaptcha();
          }
        },
        error: (err) => {
          console.log('Error details:', {
            error: err.error,
            status: err.status,
            message: err.message,
            fullError: err
          });

          this.loadingLogin = false;
          this.loginForm.patchValue({ text: '' });

          if (err.error?.error === 'invalid_captcha') {
            this.message.error('Mã xác thực sai');
          } else if (err.error?.error_description?.includes('xác thực')) {
            this.message.error('Mã xác thực sai');
          } else if (err.error?.message) {
            this.message.error(err.error.message);
          } else {
            this.message.error('Xác thực thất bại, vui lòng thử lại');
          }

          setTimeout(() => {
            this.getCaptcha();
          }, 100);
        }
      });
    } else {
      Object.values(this.loginForm.controls).forEach(control => {
        if (control.invalid) {
          control.markAsTouched();
        }
      });
    }
  }

  handleLoginCancel(): void {
    this.isLoginVisible = false;
    this.loginForm.reset();
  }

  // Thêm phương thức checkPhuongAnDong
  private checkPhuongAnDong(hanTheCu: Date | null): string {
    // Nếu không có hạn thẻ cũ -> tăng mới
    if (!hanTheCu) return 'tang_moi';

    const today = new Date();
    today.setHours(0, 0, 0, 0); // Reset time về 00:00:00
    
    const hanTheCuDate = new Date(hanTheCu);
    hanTheCuDate.setHours(0, 0, 0, 0);

    // Tính số ngày từ hạn thẻ cũ đến hiện tại
    const diffTime = today.getTime() - hanTheCuDate.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    // Nếu hạn thẻ cũ hết hạn KHÔNG QUÁ 90 ngày -> đáo hạn
    // Ngược lại (quá 90 ngày hoặc không có hạn thẻ cũ) -> tăng mới
    return diffDays <= 90 ? 'dao_han' : 'tang_moi';
  }

  // Thêm phương thức xử lý input captcha
  onCaptchaInput(event: any): void {
    const input = event.target as HTMLInputElement;
    let value = input.value;
    
    // Chỉ lấy 4 ký tự đầu tiên
    if (value.length > 4) {
      value = value.slice(0, 4);
    }
    
    // Chuyển đổi thành chữ hoa và cập nhật vào form
    this.loginForm.patchValue({
      text: value.toUpperCase()
    }, { emitEvent: false });
  }

  // Thêm phương thức mới để xử lý khi thay đổi chế độ
  onModeChange(isHoGiaDinh: boolean): void {
    this.isHoGiaDinh = isHoGiaDinh;
    // Nếu chuyển sang chế độ hộ gia đình, không cần chọn người thứ
    if (isHoGiaDinh) {
      this.multipleSearchNguoiThu = null as any;
      this.hoGiaDinhStartIndex = 1; // Đặt người thứ bắt đầu mặc định là 1
    }
  }

  // Xử lý sự kiện khi người dùng nhập vào textarea
  onMultipleSearchTextInput(event: Event): void {
    const textarea = event.target as HTMLTextAreaElement;
    const value = textarea.value;
    
    // Nếu người dùng nhập đủ 10 số và không có dấu xuống dòng ở cuối
    if (value.length > 0 && !value.endsWith('\n')) {
      const lines = value.split('\n');
      const lastLine = lines[lines.length - 1];
      
      // Nếu dòng cuối cùng đã đủ 10 ký tự (đủ 1 mã số BHXH), tự động thêm xuống dòng
      if (lastLine.length === 10 && /^\d+$/.test(lastLine)) {
        textarea.value = value + '\n';
        this.multipleSearchText = textarea.value;
      }
    }
  }

  // Xử lý sự kiện khi người dùng dán vào textarea
  onMultipleSearchTextPaste(event: ClipboardEvent): void {
    // Ngăn hành vi mặc định của trình duyệt
    event.preventDefault();
    
    // Lấy nội dung từ clipboard
    const clipboardData = event.clipboardData;
    if (!clipboardData) return;
    
    const pastedText = clipboardData.getData('text');
    if (!pastedText) return;
    
    // Xử lý nội dung dán vào
    const textarea = event.target as HTMLTextAreaElement;
    const currentValue = textarea.value;
    const cursorPosition = textarea.selectionStart;
    
    // Tách nội dung dán thành các dòng
    let formattedText = pastedText
      .replace(/\s+/g, '') // Loại bỏ tất cả khoảng trắng
      .replace(/(.{10})/g, '$1\n'); // Thêm xuống dòng sau mỗi 10 ký tự
    
    // Nếu dòng cuối không đủ 10 ký tự và không phải là dòng trống, không thêm xuống dòng
    if (formattedText.endsWith('\n') && formattedText.length % 11 !== 0) {
      formattedText = formattedText.slice(0, -1);
    }
    
    // Chèn nội dung đã định dạng vào vị trí con trỏ
    const newValue = 
      currentValue.substring(0, cursorPosition) + 
      formattedText + 
      currentValue.substring(textarea.selectionEnd || cursorPosition);
    
    // Cập nhật giá trị của textarea
    textarea.value = newValue;
    this.multipleSearchText = newValue;
    
    // Di chuyển con trỏ đến cuối nội dung vừa dán
    const newCursorPosition = cursorPosition + formattedText.length;
    textarea.setSelectionRange(newCursorPosition, newCursorPosition);
  }

  inBienLai(keKhaiId: number): void {
    this.bienLaiService.getBienLaiByKeKhai(keKhaiId).subscribe({
      next: (bienLai: BienLai) => {
        this.bienLaiService.inBienLai(bienLai.id).subscribe(
          (response: Blob) => {
            const blob = new Blob([response], { type: 'application/pdf' });
            const url = window.URL.createObjectURL(blob);
            window.open(url);
          },
          (error: any) => {
            this.message.error('Lỗi khi in biên lai');
          }
        );
      },
      error: () => {
        this.message.error('Không tìm thấy biên lai');
      }
    });
  }

  // Thêm hàm xử lý khi blur khỏi ô ngày sinh
  onNgaySinhBlur(event: FocusEvent) {
    const input = event.target as HTMLInputElement;
    const value = input.value;

    if (!value) return;

    // Kiểm tra nếu chỉ nhập năm
    if (/^\d{4}$/.test(value)) {
      const year = parseInt(value);
      if (year >= 1900 && year <= new Date().getFullYear()) {
        // Giữ nguyên giá trị năm
        this.form.patchValue({
          ngay_sinh: value
        });
        return;
      }
    }

    // Kiểm tra nếu đã đúng định dạng dd/MM/yyyy
    if (/^(0[1-9]|[12][0-9]|3[01])\/(0[1-9]|1[0-2])\/\d{4}$/.test(value)) {
      const [day, month, year] = value.split('/').map(Number);
      const date = new Date(year, month - 1, day);
      
      // Kiểm tra tính hợp lệ của ngày
      if (
        date.getDate() === day &&
        date.getMonth() === month - 1 &&
        date.getFullYear() === year &&
        date.getFullYear() >= 1900 &&
        date.getFullYear() <= new Date().getFullYear()
      ) {
        return;
      }
    }

    // Nếu không hợp lệ, set lỗi
    const control = this.form.get('ngay_sinh');
    if (control) {
      control.setErrors({ invalidDate: true });
    }
  }

  // Thêm hàm mới để xử lý ngày sinh
  private formatNgaySinh(ngaySinhInput: any): Date {
    let date: Date;
    
    // Nếu không có giá trị, trả về ngày hiện tại
    if (!ngaySinhInput) {
      date = new Date();
    }
    // Xử lý trường hợp chỉ nhập năm
    else if (typeof ngaySinhInput === 'string' && /^\d{4}$/.test(ngaySinhInput)) {
      const year = parseInt(ngaySinhInput);
      if (year >= 1900 && year <= new Date().getFullYear()) {
        date = new Date(Date.UTC(year, 0, 1));
      } else {
        date = new Date();
      }
    } 
    // Xử lý trường hợp dd/MM/yyyy
    else if (typeof ngaySinhInput === 'string' && ngaySinhInput.includes('/')) {
      const [day, month, year] = ngaySinhInput.split('/').map(Number);
      // Sử dụng Date.UTC để đảm bảo múi giờ
      date = new Date(Date.UTC(year, month - 1, day));
      
      // Kiểm tra tính hợp lệ của ngày
      if (
        !(date.getUTCDate() === day &&
        date.getUTCMonth() === month - 1 &&
        date.getUTCFullYear() === year &&
        date.getUTCFullYear() >= 1900 &&
        date.getUTCFullYear() <= new Date().getFullYear() &&
        !isNaN(date.getTime()))
      ) {
        date = new Date();
      }
    }
    // Trường hợp đã là đối tượng Date
    else if (ngaySinhInput instanceof Date && !isNaN(ngaySinhInput.getTime())) {
      // Tạo lại date với UTC để đảm bảo múi giờ
      date = new Date(Date.UTC(
        ngaySinhInput.getFullYear(),
        ngaySinhInput.getMonth(),
        ngaySinhInput.getDate()
      ));
    }
    else {
      date = new Date();
    }
    
    return date;
  }

  // Thêm phương thức tải trước dữ liệu địa chính
  async preloadAddressData(): Promise<void> {
    if (this.dataInitialized) return;
    
    try {
      console.log('Bắt đầu tải trước dữ liệu địa chính...');
      
      // Tải danh sách tỉnh
      await this.loadDanhMucTinh();
      
      // Tải trước danh sách huyện cho các tỉnh phổ biến
      const commonProvinces = ['01', '79', '48']; // Hà Nội, HCM, Đà Nẵng
      for (const province of commonProvinces) {
        await this.loadDanhMucHuyenByMaTinh(province);
        
        // Lấy các huyện đã tải
        const huyens = this.huyenCache.get(province) || [];
        
        // Tải trước xã cho một số huyện
        if (huyens.length > 0) {
          // Chỉ tải 2 huyện đầu tiên để không tải quá nhiều
          for (let i = 0; i < Math.min(2, huyens.length); i++) {
            await this.loadDanhMucXaByMaHuyen(huyens[i].ma);
          }
        }
      }
      
      this.dataInitialized = true;
      console.log('Đã tải xong dữ liệu địa chính!');
    } catch (error) {
      console.error('Lỗi khi tải trước dữ liệu địa chính:', error);
    }
  }

  // Thêm phương thức xóa cache (tùy chọn)
  private clearAddressCache(): void {
    // Xóa cache tỉnh
    localStorage.removeItem(this.TINH_CACHE_KEY);
    
    // Xóa cache huyện
    this.huyenCache.forEach((_, key) => {
      localStorage.removeItem(this.HUYEN_CACHE_PREFIX + key);
    });
    
    // Xóa cache xã
    this.xaCache.forEach((_, key) => {
      localStorage.removeItem(this.XA_CACHE_PREFIX + key);
    });
    
    // Xóa cache trong bộ nhớ
    this.huyenCache.clear();
    this.xaCache.clear();
  }

  // Thêm phương thức lưu cache vào localStorage
  private saveToLocalStorage(key: string, data: any[]): void {
    try {
      localStorage.setItem(key, JSON.stringify(data));
    } catch (error) {
      console.error('Lỗi khi lưu cache vào localStorage:', error);
    }
  }

  // Thêm phương thức đọc cache từ localStorage
  private loadFromLocalStorage(key: string): any[] | null {
    try {
      const cachedData = localStorage.getItem(key);
      return cachedData ? JSON.parse(cachedData) : null;
    } catch (error) {
      console.error('Lỗi khi đọc cache từ localStorage:', error);
      return null;
    }
  }

  convertToUpperCase(event: Event): void {
    const input = event.target as HTMLInputElement;
    const upperCaseValue = input.value.toUpperCase();
    
    // Nếu giá trị đã thay đổi sau khi chuyển đổi
    if (input.value !== upperCaseValue) {
      input.value = upperCaseValue;
      this.loginForm.get('text')?.setValue(upperCaseValue, { emitEvent: false });
    }
  }

  // Thêm phương thức mới để format ngày sinh thành chuỗi dd/MM/yyyy
  private formatDateToString(date: Date): string {
    const day = date.getUTCDate().toString().padStart(2, '0');
    const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
    const year = date.getUTCFullYear();
    return `${day}/${month}/${year}`;
  }

  guiDotKeKhai(): void {
    if (!this.dotKeKhai || this.dotKeKhai.trang_thai === 'cho_thanh_toan' || this.keKhaiBHYTs.length === 0) {
      return;
    }

    // Tạo nội dung thông báo với thông tin về biên lai điện tử
    let confirmMessage = 'Bạn có chắc chắn muốn gửi đợt kê khai này? Sau khi gửi sẽ không thể chỉnh sửa.';
    
    if (this.willUseBienLaiDienTu) {
      confirmMessage += '\n\nĐợt kê khai này sẽ tự động sử dụng biên lai điện tử.';
    }
    
    this.modal.confirm({
      nzTitle: 'Xác nhận gửi',
      nzContent: confirmMessage,
      nzOkText: 'Gửi',
      nzOkType: 'primary',
      nzOnOk: () => {
        this.loadingGui = true;
        console.log('Gửi đợt kê khai với biên lai điện tử:', this.willUseBienLaiDienTu);
        
        // Sử dụng giá trị đã được xác định từ đợt kê khai
        this.dotKeKhaiService.guiDotKeKhai(this.dotKeKhaiId, this.willUseBienLaiDienTu).subscribe({
          next: () => {
            if (this.willUseBienLaiDienTu) {
              this.message.success('Gửi đợt kê khai thành công với biên lai điện tử.');
            } else {
              this.message.success('Gửi đợt kê khai thành công.');
            }
            this.loadDotKeKhai();
          },
          error: (error) => {
            console.error('Lỗi khi gửi đợt kê khai:', error);
            
            // Hiển thị thông báo lỗi từ server nếu có
            if (error.error && error.error.message) {
              this.message.error(error.error.message);
              
              // Nếu lỗi liên quan đến biên lai, hiển thị hướng dẫn thêm
              if (error.error.message.includes('Người thu chưa được cấp quyển biên lai') || 
                  error.error.message.includes('hết số')) {
                this.modal.confirm({
                  nzTitle: 'Lỗi quyển biên lai',
                  nzContent: 'Bạn chưa được cấp quyển biên lai hoặc đã hết số. Bạn có muốn sử dụng biên lai điện tử không?',
                  nzOkText: 'Sử dụng biên lai điện tử',
                  nzCancelText: 'Hủy',
                  nzOnOk: () => {
                    // Gửi lại với biên lai điện tử = true
                    this.loadingGui = true;
                    this.dotKeKhaiService.guiDotKeKhai(this.dotKeKhaiId, true).subscribe({
                      next: () => {
                        this.message.success('Gửi đợt kê khai thành công với biên lai điện tử.');
                        this.loadDotKeKhai();
                        this.loadingGui = false;
                      },
                      error: (err) => {
                        console.error('Lỗi khi gửi đợt kê khai với biên lai điện tử:', err);
                        this.message.error(err.error?.message || 'Có lỗi xảy ra khi gửi đợt kê khai');
                        this.loadingGui = false;
                      }
                    });
                  }
                });
              }
            } else {
              this.message.error('Có lỗi xảy ra khi gửi đợt kê khai');
            }
          },
          complete: () => {
            this.loadingGui = false;
          }
        });
      },
      nzCancelText: 'Hủy'
    });
  }

  // Thêm phương thức để áp dụng bộ lọc
  applyFilters(): void {
    // Bắt đầu với tất cả dữ liệu
    this.filteredKeKhaiBHYTs = [...this.keKhaiBHYTs];
    
    // Áp dụng lọc theo số tháng đóng nếu có
    if (this.filterSoThangDong !== null) {
      this.filteredKeKhaiBHYTs = this.filteredKeKhaiBHYTs.filter(
        item => item.so_thang_dong === this.filterSoThangDong
      );
    }

    // Áp dụng lọc theo người thứ nếu có
    if (this.filterNguoiThu !== null) {
      this.filteredKeKhaiBHYTs = this.filteredKeKhaiBHYTs.filter(
        item => item.nguoi_thu === this.filterNguoiThu
      );
    }
  }

  // Phương thức để thay đổi bộ lọc số tháng đóng
  onFilterSoThangDongChange(value: number | null): void {
    this.filterSoThangDong = value;
    this.applyFilters();
    this.tinhThongKe();
  }

  // Phương thức để thay đổi bộ lọc người thứ
  onFilterNguoiThuChange(value: number | null): void {
    this.filterNguoiThu = value;
    this.applyFilters();
    this.tinhThongKe();
  }

  // Phương thức để xóa bộ lọc
  clearFilters(): void {
    this.filterSoThangDong = null;
    this.filterNguoiThu = null;
    this.applyFilters();
    this.tinhThongKe();
  }

  // Phương thức để kiểm tra xem có bộ lọc nào đang được áp dụng không
  hasActiveFilters(): boolean {
    return this.filterSoThangDong !== null || this.filterNguoiThu !== null;
  }

  /**
   * Kiểm tra họ tên hợp lệ
   */
  validateHoTen(): void {
    const hoTenControl = this.form.get('ho_ten');
    if (hoTenControl && hoTenControl.value) {
      const hoTen = hoTenControl.value.trim();
      
      // Kiểm tra độ dài
      if (hoTen.length < 3) {
        hoTenControl.setErrors({ invalidName: true });
        return;
      }
      
      // Kiểm tra ký tự đặc biệt không hợp lệ
      const regex = /^[a-zA-ZÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼỀỀỂẾưăạảấầẩẫậắằẳẵặẹẻẽềềểếỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵỷỹ\s\-]+$/;
      if (!regex.test(hoTen)) {
        hoTenControl.setErrors({ invalidName: true });
        return;
      }
      
      // Kiểm tra khoảng trắng liên tiếp
      if (/\s\s/.test(hoTen)) {
        hoTenControl.setErrors({ invalidName: true });
        return;
      }
      
      // Nếu mọi kiểm tra đều thành công, xóa lỗi
      hoTenControl.setErrors(null);
    }
  }

  // Thêm các phương thức cho tra cứu mã số BHXH
  showTraCuuMaSoBHXHModal(): void {
    this.isTraCuuMaSoBHXHVisible = true;
  }

  handleTraCuuMaSoBHXHCancel(): void {
    this.isTraCuuMaSoBHXHVisible = false;
  }

  loadDanhSachTinhTraCuu(): void {
    this.isLoadingTraCuu = true;
    this.locationService.getProvinces()
      .pipe(finalize(() => this.isLoadingTraCuu = false))
      .subscribe({
        next: (provinces) => {
          this.danhSachTinhTraCuu = provinces.map(province => ({
            ma: province.ma,
            ten: province.ten
          }));
        },
        error: (err) => {
          console.error('Lỗi khi lấy danh sách tỉnh/thành phố:', err);
          this.message.error('Không thể tải danh sách tỉnh/thành phố. Vui lòng thử lại sau.');
        }
      });
  }

  onTinhChangeTraCuu(maTinh: string): void {
    if (!maTinh) {
      this.huyenTheoTinhTraCuu = [];
      this.traCuuVNPostForm.patchValue({ maHuyen: null, maXa: null });
      this.xaTheoHuyenTraCuu = [];
      return;
    }

    this.isLoadingTraCuu = true;
    this.locationService.getDistricts(maTinh)
      .pipe(finalize(() => this.isLoadingTraCuu = false))
      .subscribe({
        next: (districts) => {
          this.danhSachHuyenTraCuu = districts.map(district => ({
            ma: district.ma,
            ten: district.ten,
            maTinh: district.ma_tinh
          }));
          this.huyenTheoTinhTraCuu = this.danhSachHuyenTraCuu;
          this.traCuuVNPostForm.patchValue({ maHuyen: null, maXa: null });
          this.xaTheoHuyenTraCuu = [];
        },
        error: (err) => {
          console.error(`Lỗi khi lấy danh sách quận/huyện cho tỉnh ${maTinh}:`, err);
          this.message.error('Không thể tải danh sách quận/huyện. Vui lòng thử lại sau.');
          this.huyenTheoTinhTraCuu = [];
        }
      });
  }

  onHuyenChangeTraCuu(maHuyen: string): void {
    if (!maHuyen) {
      this.xaTheoHuyenTraCuu = [];
      this.traCuuVNPostForm.patchValue({ maXa: null });
      return;
    }

    this.isLoadingTraCuu = true;
    this.locationService.getCommunes(maHuyen)
      .pipe(finalize(() => this.isLoadingTraCuu = false))
      .subscribe({
        next: (response) => {
          if (response && response.success && response.data) {
            this.danhSachXaTraCuu = response.data.map((commune: any) => ({
              ma: commune.ma,
              ten: commune.ten,
              maHuyen: commune.ma_huyen
            }));
            this.xaTheoHuyenTraCuu = this.danhSachXaTraCuu;
          } else {
            this.xaTheoHuyenTraCuu = [];
          }
          this.traCuuVNPostForm.patchValue({ maXa: null });
        },
        error: (err) => {
          console.error(`Lỗi khi lấy danh sách xã/phường cho huyện ${maHuyen}:`, err);
          this.message.error('Không thể tải danh sách xã/phường. Vui lòng thử lại sau.');
          this.xaTheoHuyenTraCuu = [];
        }
      });
  }

  submitTraCuuVNPostForm(): void {
    if (this.traCuuVNPostForm.valid) {
      this.isLoadingTraCuu = true;
      this.daTimKiem = true;
      this.loiTraCuu = '';
      
      // Kiểm tra token VNPost
      const token = this.ssmv2Service.getToken();
      if (!token) {
        // Tự động đăng nhập VNPost thay vì hiển thị thông báo
        this.autoLoginVNPost(true);
        return;
      }
      
      // Lấy dữ liệu từ form
      const formData: TraCuuVNPostRequest = {
        maTinh: this.traCuuVNPostForm.value.maTinh,
        maHuyen: this.traCuuVNPostForm.value.maHuyen,
        maXa: this.traCuuVNPostForm.value.maXa || '',
        hoTen: this.traCuuVNPostForm.value.hoTen || '',
        ngaySinh: this.formatDateTraCuu(this.traCuuVNPostForm.value.ngaySinh),
        soCMND: this.traCuuVNPostForm.value.soCMND || ''
      };
      
      console.log('Dữ liệu gửi đi:', formData);
      
      // Gọi API tra cứu VNPost
      this.bhxhService.traCuuMaSoBHXHVNPost(formData)
        .subscribe({
          next: (res: any) => {
            this.isLoadingTraCuu = false;
            
            // Log response để debug
            console.log('Response từ API VNPost:', res);
            
            // Kiểm tra nếu response có chứa thông báo lỗi xác thực
            if (res && res.error === 'Lỗi xác thực') {
              this.ketQuaTraCuu = [];
              this.loiTraCuu = 'Lỗi xác thực: ' + (res.error_description || 'Không tìm thấy thông tin phiên đăng nhập');
              this.message.error(this.loiTraCuu);
              
              // Hiển thị form đăng nhập lại
              this.ssmv2Service.clearToken();
              this.message.warning('Vui lòng đăng nhập lại để tiếp tục');
              this.isLoginVisible = true;
              return;
            }
            
            // Kiểm tra nếu response có status khác 200
            if (res && res.status && res.status !== 200) {
              this.ketQuaTraCuu = [];
              this.loiTraCuu = res.message || 'Có lỗi xảy ra khi tra cứu';
              this.message.error(this.loiTraCuu);
              return;
            }
            
            // Xử lý dữ liệu trả về
            if (res && res.success && res.data && res.data.length > 0) {
              // Xử lý tất cả kết quả thay vì chỉ kết quả đầu tiên
              this.ketQuaTraCuu = res.data.map((data: any) => {
                // Xử lý đặc biệt cho ngày sinh
                let ngaySinh: Date;
                let ngaySinhFormatted: string | undefined = undefined;
                
                if (data.ngaySinhDt) {
                  ngaySinh = new Date(data.ngaySinhDt);
                } else if (data.ngaySinh) {
                  const year = parseInt(data.ngaySinh.substring(0, 4));
                  
                  // Kiểm tra nếu chỉ có năm, không có tháng và ngày (hoặc là 0000)
                  if (data.ngaySinh.substring(4, 8) === "0000") {
                    ngaySinh = new Date(year, 0, 1);
                    ngaySinhFormatted = `${year}`;
                  } else {
                    const month = parseInt(data.ngaySinh.substring(4, 6)) - 1;
                    const day = parseInt(data.ngaySinh.substring(6, 8));
                    
                    // Kiểm tra tính hợp lệ của tháng và ngày
                    const validMonth = month >= 0 && month <= 11;
                    const validDay = day >= 1 && day <= 31;
                    
                    if (validMonth && validDay) {
                      ngaySinh = new Date(year, month, day);
                    } else {
                      ngaySinh = new Date(year, 0, 1);
                      ngaySinhFormatted = `${year}`;
                    }
                  }
                } else {
                  ngaySinh = new Date();
                }
                
                return {
                  maSoBHXH: data.maSoBhxh,
                  hoTen: data.hoTen,
                  ngaySinh: ngaySinh,
                  ngaySinhFormatted: ngaySinhFormatted,
                  gioiTinh: data.gioiTinh,
                  soCCCD: data.soCmnd || 'N/A',
                  diaChi: data.diaChi || 'N/A',
                  trangThai: data.trangThai,
                  maHo: data.maHo
                };
              });
              
              this.message.success(`Tra cứu thành công: Tìm thấy ${this.ketQuaTraCuu.length} kết quả`);
              console.log('Kết quả tra cứu đã xử lý:', this.ketQuaTraCuu);
            } else {
              this.ketQuaTraCuu = [];
              this.loiTraCuu = 'Không tìm thấy thông tin mã số BHXH';
              this.message.warning(this.loiTraCuu);
            }
          },
          error: (err: any) => {
            // Xử lý lỗi từ API
            this.isLoadingTraCuu = false;
            this.ketQuaTraCuu = [];
            
            console.error('Lỗi khi tra cứu:', err);
            
            if (err.error === 'Lỗi xác thực') {
              this.loiTraCuu = 'Lỗi xác thực: ' + (err.error_description || 'Phiên làm việc đã hết hạn');
              this.message.error(this.loiTraCuu);
              this.ssmv2Service.clearToken();
              this.isLoginVisible = true;
            } else {
              this.loiTraCuu = 'Đã xảy ra lỗi khi tra cứu: ' + (err.error?.message || err.message || 'Vui lòng thử lại sau');
              this.message.error(this.loiTraCuu);
            }
          }
        });
    } else {
      // Xử lý khi form không hợp lệ
      Object.values(this.traCuuVNPostForm.controls).forEach(control => {
        if (control.invalid) {
          control.markAsDirty();
          control.updateValueAndValidity();
        }
      });
    }
  }

  resetTraCuuForm(): void {
    this.traCuuVNPostForm.reset();
    this.huyenTheoTinhTraCuu = [];
    this.xaTheoHuyenTraCuu = [];
    this.ketQuaTraCuu = [];
    this.daTimKiem = false;
    this.loiTraCuu = '';
  }

  private formatDateTraCuu(date: Date | string): string {
    if (!date) return '';
    
    // Nếu là chuỗi có định dạng dd/MM/yyyy
    if (typeof date === 'string' && date.includes('/')) {
      // Chuyển đổi từ dd/MM/yyyy sang yyyy-MM-dd
      const datePattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
      const match = date.match(datePattern);
      if (match) {
        const [_, day, month, year] = match;
        return `${year}-${month}-${day}`;
      }
    }
    
    // Nếu là đối tượng Date
    const dateObj = typeof date === 'string' ? new Date(date) : date;
    if (isNaN(dateObj.getTime())) return '';
    
    const day = dateObj.getDate().toString().padStart(2, '0');
    const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
    const year = dateObj.getFullYear();
    
    // Trả về định dạng yyyy-MM-dd
    return `${year}-${month}-${day}`;
  }

  private parseNgaySinhTraCuu(ngaySinhStr: string, ngaySinhDt: string): Date {
    if (ngaySinhDt) {
      return new Date(ngaySinhDt);
    }
    
    if (ngaySinhStr) {
      // Chuyển đổi chuỗi ngày sinh dạng 'YYYYMMDD' thành Date
      const year = parseInt(ngaySinhStr.substring(0, 4));
      const month = parseInt(ngaySinhStr.substring(4, 6)) - 1; // Tháng trong JS bắt đầu từ 0
      const day = parseInt(ngaySinhStr.substring(6, 8));
      return new Date(year, month, day);
    }
    
    return new Date();
  }

  // Kiểm tra trạng thái đăng nhập VNPost
  isVNPostLoggedIn(): boolean {
    return !!this.ssmv2Service.getToken();
  }

  // Thêm phương thức tự động đăng nhập VNPost
  autoLoginVNPost(fromSubmitTraCuu: boolean = false): void {
    // Lấy captcha
    this.ssmv2Service.getCaptcha().subscribe({
      next: (res) => {
        if (res && res.data) {
          this.captchaImage = res.data.image;
          this.captchaCode = res.data.code;
          
          // Thực hiện đăng nhập tự động
          const data = {
            grant_type: 'password',
            userName: this.loginForm.get('userName')?.value,
            password: this.loginForm.get('password')?.value,
            text: this.captchaCode, // Sử dụng mã captcha làm text
            code: this.captchaCode,
            clientId: 'ZjRiYmI5ZTgtZDcyOC00ODRkLTkyOTYtMDNjYmUzM2U4Yjc5',
            isWeb: true
          };

          this.ssmv2Service.authenticate(data).subscribe({
            next: (response) => {
              if (response.body?.access_token) {
                console.log('Tự động xác thực thành công');
                
                // Chỉ thực hiện tìm kiếm nếu đăng nhập từ quá trình submit form
                if (fromSubmitTraCuu) {
                  setTimeout(() => {
                    this.submitTraCuuVNPostForm();
                  }, 1000);
                }
              } else {
                if (fromSubmitTraCuu) {
                  this.isLoadingTraCuu = false;
                }
              }
            },
            error: (err) => {
              console.error('Lỗi tự động đăng nhập:', err);
              if (fromSubmitTraCuu) {
                this.isLoadingTraCuu = false;
                this.isLoginVisible = true; // Hiển thị form đăng nhập nếu tự động đăng nhập thất bại
              }
            }
          });
        } else {
          if (fromSubmitTraCuu) {
            this.isLoadingTraCuu = false;
          }
        }
      },
      error: (err) => {
        console.error('Lỗi khi lấy captcha:', err);
        if (fromSubmitTraCuu) {
          this.isLoadingTraCuu = false;
          this.isLoginVisible = true; // Hiển thị form đăng nhập nếu không lấy được captcha
        }
      }
    });
  }

  // Áp dụng thông tin từ kết quả tra cứu vào form chính
  apDungThongTinBHXH(item: any): void {
    this.form.patchValue({
      ma_so_bhxh: item.maSoBHXH,
      ho_ten: item.hoTen,
      ngay_sinh: this.formatDateToString(new Date(item.ngaySinh)),
      gioi_tinh: item.gioiTinh === 'Nam' ? 'Nam' : 'Nữ',
      cccd: item.soCCCD || '',
      so_dien_thoai: item.soDienThoai && item.soDienThoai !== 'N/A' ? item.soDienThoai : ''
    });
    
    // Đóng modal
    this.handleTraCuuMaSoBHXHCancel();
    
    // Thông báo
    this.message.success('Đã áp dụng thông tin BHXH vào form');
    
    // Tự động tìm kiếm thông tin BHYT
    this.onSearchBHYT();
  }

  // Thêm phương thức xử lý dữ liệu CCCD
  processCCCDData(cccdData: any): void {
    if (Array.isArray(cccdData)) {
      const processedData = cccdData.map(item => {
        const result: CCCDResult = {
          ...item,
          status: item.id ? 'success' : 'error',
          message: item.id ? 'Quét thành công' : 'Không quét được thông tin',
          // Định dạng ngày sinh và giới tính
          ngaySinhFormatted: this.formatDateFromCCCD(item.dob),
          gioiTinh: this.formatGenderFromCCCD(item.sex)
        };
        return result;
      });
      
      this.danhSachCCCD = processedData;
    }
  }

  // Thêm phương thức định dạng ngày sinh từ CCCD
  formatDateFromCCCD(dateStr: string): string {
    if (!dateStr) return '';
    
    try {
      const date = new Date(dateStr);
      return date.toLocaleDateString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    } catch (error) {
      return dateStr;
    }
  }

  // Thêm phương thức định dạng giới tính từ CCCD
  formatGenderFromCCCD(gender: string): string {
    if (!gender) return '';
    
    if (gender.toLowerCase() === 'male' || gender === 'nam' || gender === 'Nam') {
      return 'Nam';
    } else if (gender.toLowerCase() === 'female' || gender === 'nữ' || gender === 'Nữ') {
      return 'Nữ';
    }
    
    return gender;
  }
}
````

## File: WebApp.Client/src/app/ke-khai/lich-su-ke-khai/lich-su-ke-khai.component.html
````html
<div class="container">
  <div class="header">
    <h2>
      <i nz-icon nzType="history" nzTheme="outline"></i>
      Lịch sử kê khai
    </h2>
    <div class="button-group">
      <button nz-button nzType="primary" (click)="search()">
        <i nz-icon nzType="search"></i>
        Tìm kiếm
      </button>
      <button nz-button (click)="resetForm()">
        <i nz-icon nzType="reload"></i>
        Làm mới
      </button>
      <button nz-button (click)="exportToExcel()">
        <i nz-icon nzType="download"></i>
        Xuất Excel
      </button>
    </div>
  </div>

  <!-- Form tìm kiếm -->
  <div class="search-section">
    <div class="search-form">
      <nz-row [nzGutter]="16">
        <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6">
          <nz-form-item>
            <nz-form-label>Mã số BHXH:</nz-form-label>
            <nz-form-control>
              <input nz-input placeholder="Nhập mã số BHXH" [(ngModel)]="searchForm.maSoBHXH" name="maSoBHXH">
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6">
          <nz-form-item>
            <nz-form-label>CCCD:</nz-form-label>
            <nz-form-control>
              <input nz-input placeholder="Nhập CCCD" [(ngModel)]="searchForm.cccd" name="cccd">
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6">
          <nz-form-item>
            <nz-form-label>Họ tên:</nz-form-label>
            <nz-form-control>
              <input nz-input placeholder="Nhập họ tên" [(ngModel)]="searchForm.hoTen" name="hoTen">
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6">
          <nz-form-item>
            <nz-form-label>Thời gian:</nz-form-label>
            <nz-form-control>
              <nz-range-picker
                [(ngModel)]="searchForm.tuNgay"
                [nzFormat]="'dd/MM/yyyy'"
                name="dateRange">
              </nz-range-picker>
            </nz-form-control>
          </nz-form-item>
        </nz-col>
      </nz-row>
    </div>
  </div>

  <!-- Tabs và Bảng dữ liệu -->
  <nz-tabset [(nzSelectedIndex)]="selectedTabIndex" (nzSelectedIndexChange)="onTabChange($event)">
    <nz-tab nzTitle="Kê khai BHYT">
      <nz-table
        #bhytTable
        [nzData]="keKhaiBHYTs"
        [nzLoading]="loading"
        [nzShowSizeChanger]="true"
        [nzPageSizeOptions]="[10, 20, 30, 40, 50]"
        [nzShowTotal]="totalTemplate"
        [nzShowPagination]="true"
        [nzScroll]="{ x: '1200px' }"
        class="mt-4">
        <thead>
          <tr>
            <th nzWidth="180px">Đợt kê khai</th>
            <th nzWidth="120px">Mã số BHXH</th>
            <th nzWidth="150px">Họ tên</th>
            <th nzWidth="120px">CCCD</th>
            <th nzWidth="100px">Ngày sinh</th>
            <th nzWidth="80px">Giới tính</th>
            <th nzWidth="80px">Người thứ</th>
            <th nzWidth="120px">Phương án đóng</th>
            <th nzWidth="100px">Số tháng</th>
            <th nzWidth="120px" nzAlign="right">Số tiền đóng</th>
            <th nzWidth="150px">Ngày tạo</th>
            <th nzWidth="120px">Mã hồ sơ</th>
            <th nzWidth="100px">Trạng thái</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of bhytTable.data">
            <td>{{ item.dotKeKhaiInfo }}</td>
            <td>
              <ng-container *ngIf="item.thongTinThe">{{ item.thongTinThe.ma_so_bhxh }}</ng-container>
            </td>
            <td>
              <ng-container *ngIf="item.thongTinThe">{{ item.thongTinThe.ho_ten }}</ng-container>
            </td>
            <td>
              <ng-container *ngIf="item.thongTinThe">{{ item.thongTinThe.cccd }}</ng-container>
            </td>
            <td>
              <ng-container *ngIf="item.thongTinThe">{{ item.thongTinThe.ngay_sinh | date:'dd/MM/yyyy' }}</ng-container>
            </td>
            <td>
              <ng-container *ngIf="item.thongTinThe">{{ item.thongTinThe.gioi_tinh === 'nam' ? 'Nam' : 'Nữ' }}</ng-container>
            </td>
            <td>{{ item.nguoi_thu }}</td>
            <td>
              <nz-tag [nzColor]="'blue'">
                {{ getPhuongAnDongText(item.phuong_an_dong) }}
              </nz-tag>
            </td>
            <td>{{ item.so_thang_dong }}</td>
            <td nzAlign="right">{{ item.so_tien_can_dong | number }} đ</td>
            <td>{{ item.ngay_tao | date:'dd/MM/yyyy HH:mm' }}</td>
            <td>{{ item.ma_ho_so || 'N/A' }}</td>
            <td>
              <nz-tag [nzColor]="item.dotKeKhai?.trang_thai === 'hoan_thanh' ? 'success' : 'processing'">
                {{ item.dotKeKhai?.trang_thai === 'hoan_thanh' ? 'Hoàn thành' : 'Đang xử lý' }}
              </nz-tag>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </nz-tab>

    <nz-tab nzTitle="Kê khai BHXH">
      <nz-table
        #bhxhTable
        [nzData]="keKhaiBHXHs"
        [nzLoading]="loading"
        [nzShowSizeChanger]="true"
        [nzPageSizeOptions]="[10, 20, 30, 40, 50]"
        [nzShowTotal]="totalTemplate"
        [nzShowPagination]="true"
        [nzScroll]="{ x: '1200px' }"
        class="mt-4">
        <thead>
          <tr>
            <th nzWidth="180px">Đợt kê khai</th>
            <th nzWidth="120px">Mã số BHXH</th>
            <th nzWidth="150px">Họ tên</th>
            <th nzWidth="120px">CCCD</th>
            <th nzWidth="100px">Ngày sinh</th>
            <th nzWidth="80px">Giới tính</th>
            <th nzWidth="120px">Mức lương</th>
            <th nzWidth="120px">Phương án đóng</th>
            <th nzWidth="100px">Số tháng</th>
            <th nzWidth="120px" nzAlign="right">Số tiền đóng</th>
            <th nzWidth="150px">Ngày tạo</th>
            <th nzWidth="120px">Mã hồ sơ</th>
            <th nzWidth="100px">Trạng thái</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of bhxhTable.data">
            <td>{{ item.dotKeKhaiInfo }}</td>
            <td>
              <ng-container *ngIf="item.thongTinThe">{{ item.thongTinThe.ma_so_bhxh }}</ng-container>
            </td>
            <td>
              <ng-container *ngIf="item.thongTinThe">{{ item.thongTinThe.ho_ten }}</ng-container>
            </td>
            <td>
              <ng-container *ngIf="item.thongTinThe">{{ item.thongTinThe.cccd }}</ng-container>
            </td>
            <td>
              <ng-container *ngIf="item.thongTinThe">{{ item.thongTinThe.ngay_sinh | date:'dd/MM/yyyy' }}</ng-container>
            </td>
            <td>
              <ng-container *ngIf="item.thongTinThe">{{ item.thongTinThe.gioi_tinh === 'nam' ? 'Nam' : 'Nữ' }}</ng-container>
            </td>
            <td>{{ item.muc_luong | number }} đ</td>
            <td>
              <nz-tag [nzColor]="'blue'">
                {{ getPhuongAnDongText(item.phuong_an_dong) }}
              </nz-tag>
            </td>
            <td>{{ item.so_thang_dong }}</td>
            <td nzAlign="right">{{ item.so_tien_can_dong | number }} đ</td>
            <td>{{ item.ngay_tao | date:'dd/MM/yyyy HH:mm' }}</td>
            <td>{{ item.ma_ho_so || 'N/A' }}</td>
            <td>
              <nz-tag [nzColor]="item.dotKeKhai?.trang_thai === 'hoan_thanh' ? 'success' : 'processing'">
                {{ item.dotKeKhai?.trang_thai === 'hoan_thanh' ? 'Hoàn thành' : 'Đang xử lý' }}
              </nz-tag>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </nz-tab>
  </nz-tabset>

  <ng-template #totalTemplate let-total>
    Tổng số {{ total }} bản ghi
  </ng-template>
</div>
````

## File: WebApp.Client/src/app/ke-khai/lich-su-ke-khai/lich-su-ke-khai.component.scss
````scss
.container {
  padding: 24px;
  background-color: #fff;
}

.header {
  margin-bottom: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  
  h2 {
    margin-bottom: 0;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;

    i {
      color: #1890ff;
    }
  }
}

.search-section {
  margin-bottom: 24px;
}

.search-form {
  margin-bottom: 16px;

  nz-form-item {
    margin-bottom: 16px;

    nz-form-label {
      color: #262626;
      font-weight: 500;
    }

    input, nz-range-picker {
      width: 100%;
    }
  }
}

.button-group {
  display: flex;
  gap: 8px;

  button {
    display: flex;
    align-items: center;
    gap: 4px;

    i {
      font-size: 16px;
    }
  }
}

.table-container {
  overflow-x: auto;

  :host ::ng-deep {
    .ant-table-thead > tr > th {
      background: #fafafa;
      padding: 12px 16px;
      font-weight: 500;
      white-space: nowrap;
    }

    .ant-table-tbody > tr > td {
      padding: 12px 16px;
      white-space: nowrap;
    }

    .ant-tag {
      margin-right: 0;
    }
  }
}

.mt-4 {
  margin-top: 24px;
}

// Responsive
@media (max-width: 768px) {
  .container {
    padding: 16px;
  }

  .header {
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }

  .button-group {
    width: 100%;
    flex-wrap: wrap;
    
    button {
      width: 100%;
      margin-bottom: 8px;
      justify-content: center;
    }
  }
}
````

## File: WebApp.Client/src/app/ke-khai/lich-su-ke-khai/lich-su-ke-khai.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzDatePickerModule } from 'ng-zorro-antd/date-picker';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzCardModule } from 'ng-zorro-antd/card';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzTabsModule } from 'ng-zorro-antd/tabs';
import { LichSuKeKhaiService, KeKhaiBHYT, KeKhaiBHXH } from '../../services/lich-su-ke-khai.service';

@Component({
  selector: 'app-lich-su-ke-khai',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    NzTableModule,
    NzButtonModule,
    NzIconModule,
    NzTagModule,
    NzDatePickerModule,
    NzSelectModule,
    NzFormModule,
    NzInputModule,
    NzCardModule,
    NzGridModule,
    NzTabsModule
  ],
  templateUrl: './lich-su-ke-khai.component.html',
  styleUrls: ['./lich-su-ke-khai.component.scss']
})
export class LichSuKeKhaiComponent implements OnInit {
  keKhaiBHYTs: KeKhaiBHYT[] = [];
  keKhaiBHXHs: KeKhaiBHXH[] = [];
  loading = false;
  selectedTab = 'bhyt';
  selectedTabIndex = 0;
  searchForm = {
    maSoBHXH: '',
    cccd: '',
    hoTen: '',
    tuNgay: null as Date | null,
    denNgay: null as Date | null
  };

  constructor(
    private lichSuKeKhaiService: LichSuKeKhaiService,
    private message: NzMessageService
  ) {}

  ngOnInit(): void {
    this.loadData();
  }

  loadData(): void {
    this.loading = true;
    if (this.selectedTab === 'bhyt') {
      this.loadKeKhaiBHYT();
    } else {
      this.loadKeKhaiBHXH();
    }
  }

  loadKeKhaiBHYT(): void {
    this.lichSuKeKhaiService.getAllKeKhaiBHYT(this.searchForm).subscribe({
      next: (data) => {
        this.keKhaiBHYTs = data.map(item => ({
          ...item,
          dotKeKhaiInfo: `Đợt ${item.dotKeKhai?.so_dot} tháng ${item.dotKeKhai?.thang} năm ${item.dotKeKhai?.nam}`
        }));
        this.loading = false;
      },
      error: (error: Error) => {
        console.error('Lỗi khi tải dữ liệu BHYT:', error);
        this.message.error('Có lỗi xảy ra khi tải dữ liệu BHYT');
        this.loading = false;
      }
    });
  }

  loadKeKhaiBHXH(): void {
    this.lichSuKeKhaiService.getAllKeKhaiBHXH(this.searchForm).subscribe({
      next: (data) => {
        this.keKhaiBHXHs = data.map(item => ({
          ...item,
          dotKeKhaiInfo: `Đợt ${item.dotKeKhai?.so_dot} tháng ${item.dotKeKhai?.thang} năm ${item.dotKeKhai?.nam}`
        }));
        this.loading = false;
      },
      error: (error: Error) => {
        console.error('Lỗi khi tải dữ liệu BHXH:', error);
        this.message.error('Có lỗi xảy ra khi tải dữ liệu BHXH');
        this.loading = false;
      }
    });
  }

  onTabChange(index: number): void {
    this.selectedTab = index === 0 ? 'bhyt' : 'bhxh';
    this.loadData();
  }

  search(): void {
    this.loadData();
  }

  resetForm(): void {
    this.searchForm = {
      maSoBHXH: '',
      cccd: '',
      hoTen: '',
      tuNgay: null,
      denNgay: null
    };
    this.loadData();
  }

  getPhuongAnDongText(phuongAnDong: string): string {
    const map: { [key: string]: string } = {
      'dao_han': 'Đáo hạn',
      'tang_moi': 'Tăng mới',
      'dung_dong': 'Dừng đóng'
    };
    return map[phuongAnDong] || phuongAnDong;
  }

  exportToExcel(): void {
    this.loading = true;
    const exportService = this.selectedTab === 'bhyt' 
      ? this.lichSuKeKhaiService.exportBHYTToExcel(this.searchForm)
      : this.lichSuKeKhaiService.exportBHXHToExcel(this.searchForm);

    exportService.subscribe({
      next: (blob: Blob) => {
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `lich-su-ke-khai-${this.selectedTab}-${new Date().getTime()}.xlsx`;
        link.click();
        window.URL.revokeObjectURL(url);
        this.loading = false;
      },
      error: (error: Error) => {
        console.error('Lỗi khi xuất Excel:', error);
        this.message.error('Có lỗi xảy ra khi xuất Excel');
        this.loading = false;
      }
    });
  }
}
````

## File: WebApp.Client/src/app/ke-khai/quet-cccd/quet-cccd.component.html
````html
<div class="quet-cccd-container">
  <nz-card [nzTitle]="'Quét thông tin CCCD'">
    <div nz-row [nzGutter]="16">
      <div nz-col [nzSpan]="12">
        <nz-upload
          class="avatar-uploader"
          [nzShowUploadList]="false"
          [nzBeforeUpload]="beforeUpload"
          (nzChange)="handleChange($event)"
        >
          <ng-container *ngIf="!avatarUrl">
            <i class="upload-icon" nz-icon [nzType]="loading ? 'loading' : 'plus'"></i>
            <div class="ant-upload-text">Tải ảnh lên</div>
          </ng-container>
          <img *ngIf="avatarUrl" [src]="avatarUrl" class="avatar" />
        </nz-upload>
      </div>
      <div nz-col [nzSpan]="12">
        <nz-spin [nzSpinning]="loading">
          <nz-descriptions [nzTitle]="'Thông tin CCCD'" [nzBordered]="true" *ngIf="thongTinCCCD">
            <nz-descriptions-item [nzSpan]="3" [nzLabel]="'Số CCCD'">
              {{ thongTinCCCD.id }}
            </nz-descriptions-item>
            <nz-descriptions-item [nzSpan]="3" [nzLabel]="'Họ và tên'">
              {{ thongTinCCCD.name }}
            </nz-descriptions-item>
            <nz-descriptions-item [nzSpan]="3" [nzLabel]="'Ngày sinh'">
              {{ thongTinCCCD.dob }}
            </nz-descriptions-item>
            <nz-descriptions-item [nzSpan]="3" [nzLabel]="'Giới tính'">
              {{ thongTinCCCD.sex }}
            </nz-descriptions-item>
            <nz-descriptions-item [nzSpan]="3" [nzLabel]="'Địa chỉ'">
              {{ thongTinCCCD.address }}
            </nz-descriptions-item>
          </nz-descriptions>
        </nz-spin>
      </div>
    </div>
  </nz-card>
</div>
````

## File: WebApp.Client/src/app/ke-khai/quet-cccd/quet-cccd.component.scss
````scss
.quet-cccd-container {
  padding: 24px;

  .avatar-uploader {
    width: 100%;
    height: 300px;
    border: 1px dashed #d9d9d9;
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    background: #fafafa;
    transition: border-color 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;

    &:hover {
      border-color: #1890ff;
    }
  }

  .upload-icon {
    font-size: 32px;
    color: #999;
  }

  .ant-upload-text {
    margin-top: 8px;
    color: #666;
  }

  .avatar {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  nz-descriptions {
    margin-top: 16px;
  }
}
````

## File: WebApp.Client/src/app/ke-khai/quet-cccd/quet-cccd.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzUploadFile } from 'ng-zorro-antd/upload';
import { CCCDService } from '../../services/cccd.service';

@Component({
  selector: 'app-quet-cccd',
  templateUrl: './quet-cccd.component.html',
  styleUrls: ['./quet-cccd.component.scss']
})
export class QuetCCCDComponent implements OnInit {
  loading = false;
  avatarUrl?: string;
  thongTinCCCD: any;

  constructor(
    private msg: NzMessageService,
    private cccdService: CCCDService
  ) { }

  ngOnInit(): void { }

  beforeUpload = (file: NzUploadFile): boolean => {
    const isJpgOrPng = file.type === 'image/jpeg' || file.type === 'image/png';
    if (!isJpgOrPng) {
      this.msg.error('Bạn chỉ có thể tải lên file JPG/PNG!');
      return false;
    }
    const isLt2M = (file.size || 0) / 1024 / 1024 < 2;
    if (!isLt2M) {
      this.msg.error('Ảnh phải nhỏ hơn 2MB!');
      return false;
    }
    this.quetCCCD(file as any);
    return false;
  };

  private getBase64(img: File, callback: (img: string) => void): void {
    const reader = new FileReader();
    reader.addEventListener('load', () => callback(reader.result!.toString()));
    reader.readAsDataURL(img);
  }

  handleChange(info: { file: NzUploadFile }): void {
    switch (info.file.status) {
      case 'uploading':
        this.loading = true;
        break;
      case 'done':
        this.getBase64(info.file.originFileObj!, (img: string) => {
          this.loading = false;
          this.avatarUrl = img;
        });
        break;
      case 'error':
        this.msg.error('Tải ảnh lên thất bại!');
        this.loading = false;
        break;
    }
  }

  quetCCCD(file: File): void {
    this.loading = true;
    this.cccdService.quetCCCD(file).subscribe({
      next: (response) => {
        this.thongTinCCCD = response.data[0];
        this.loading = false;
        this.msg.success('Quét CCCD thành công!');
      },
      error: (error) => {
        this.loading = false;
        this.msg.error('Quét CCCD thất bại!');
        console.error('Lỗi khi quét CCCD:', error);
      }
    });
  }
}
````

## File: WebApp.Client/src/app/layout/main-layout/main-layout.component.html
````html
<nz-layout class="app-layout">
  <nz-sider class="menu-sidebar"
            nzCollapsible
            nzWidth="256px"
            [(nzCollapsed)]="isCollapsed"
            [nzTrigger]="null">
    <div class="sidebar-logo">
      <a href="/">
        <div class="logo-text" [class.collapsed]="isCollapsed">
          <ng-container *ngIf="!isCollapsed">
            <div>Hệ thống kê khai</div>
            <div>BHYT-BHXH</div>
          </ng-container>
          <div *ngIf="isCollapsed" class="collapsed-text">HP</div>
        </div>
      </a>
    </div>
    <ul nz-menu nzTheme="dark" nzMode="inline" [nzInlineCollapsed]="isCollapsed">
      <li nz-menu-item nzMatchRouter routerLink="/dashboard" *ngIf="false">
        <span nz-icon nzType="dashboard"></span>
        <span>Trang chủ</span>
      </li>
      <li nz-submenu nzTitle="Kê khai" nzIcon="form">
        <ul>
          <li nz-menu-item nzMatchRouter routerLink="/dot-ke-khai">
            <span nz-icon nzType="profile"></span>
            <span>Danh sách kê khai</span>
          </li>
          <li nz-menu-item nzMatchRouter>
            <a routerLink="/lich-su-ke-khai">
              <span nz-icon nzType="history"></span>
              <span>Lịch sử kê khai</span>
            </a>
          </li>
          <li nz-menu-item nzMatchRouter routerLink="/admin-danh-sach-ke-khai" *ngIf="isAdmin">
            <span nz-icon nzType="audit"></span>
            <span>Quản lý kê khai</span>
          </li>
        </ul>
      </li>
      <li nz-submenu nzTitle="Quản lý" nzIcon="appstore" *ngIf="isAdmin">
        <ul>
          <li nz-menu-item nzMatchRouter routerLink="/don-vi">
            <span nz-icon nzType="shop"></span>
            <span>Đơn vị</span>
          </li>
          <li nz-menu-item nzMatchRouter routerLink="/dai-ly">
            <span nz-icon nzType="team"></span>
            <span>Đại lý</span>
          </li>
          <li nz-menu-item nzMatchRouter routerLink="/users">
            <span nz-icon nzType="user"></span>
            <span>Người dùng</span>
          </li>
        </ul>
      </li>
      <li nz-submenu nzTitle="Biên lai" nzIcon="file-text">
        <ul>
          <li nz-menu-item nzMatchRouter>
            <a routerLink="/bien-lai/bang-ke">Bảng kê biên lai</a>
          </li>
          <li nz-menu-item nzMatchRouter>
            <a routerLink="/bien-lai/bao-cao">Báo cáo biên lai</a>
          </li>
          <li nz-menu-item nzMatchRouter *ngIf="isAdmin">
            <a routerLink="/bien-lai/quyen-bien-lai">Quyển biên lai</a>
          </li>
          <li nz-menu-item nzMatchRouter *ngIf="isAdmin">
            <a routerLink="/bien-lai/dien-tu/quan-ly">Quản lý biên lai điện tử</a>
          </li>
          <li nz-menu-item nzMatchRouter *ngIf="isAdmin">
            <a routerLink="/bien-lai/dien-tu/quyen-bien-lai">Quyển biên lai điện tử</a>
          </li>
        </ul>
      </li>
      <li nz-submenu nzTitle="Tra cứu" nzIcon="search">
        <ul>
          <li nz-menu-item nzMatchRouter>
            <a routerLink="/tra-cuu/ma-so-bhxh">
              <span nz-icon nzType="idcard"></span>
              <span>Mã số BHXH</span>
            </a>
          </li>
          <li nz-menu-item nzMatchRouter>
            <a routerLink="/tra-cuu/ho-gia-dinh">
              <span nz-icon nzType="team"></span>
              <span>Hộ gia đình</span>
            </a>
          </li>
          <li nz-menu-item nzMatchRouter>
            <a routerLink="/tra-cuu/thong-tin-bhxh">
              <span nz-icon nzType="medicine-box"></span>
              <span>Thông tin BHXH</span>
            </a>
          </li>
          <li nz-menu-item nzMatchRouter>
            <a routerLink="/tra-cuu/thong-tin-bhyt">
              <span nz-icon nzType="medicine-box"></span>
              <span>Thông tin BHYT</span>
            </a>
          </li>
        </ul>
      </li>
      <li nz-submenu nzTitle="Báo cáo" nzIcon="bar-chart" *ngIf="false">
        <ul>
          <li nz-menu-item nzMatchRouter routerLink="/reports/monthly">
            <span nz-icon nzType="file-text"></span>
            <span>Báo cáo tháng</span>
          </li>
          <li nz-menu-item nzMatchRouter routerLink="/reports/statistics">
            <span nz-icon nzType="fund"></span>
            <span>Thống kê</span>
          </li>
        </ul>
      </li>
      <li nz-menu-item nzMatchRouter routerLink="/settings" *ngIf="false">
        <span nz-icon nzType="setting"></span>
        <span>Cài đặt</span>
      </li>
      <li nz-menu-item (click)="logout()" class="logout-item">
        <span nz-icon nzType="logout"></span>
        <span>Đăng xuất</span>
      </li>
    </ul>
  </nz-sider>
  <nz-layout>
    <nz-header>
      <div class="app-header">
        <div class="header-left">
          <span class="header-trigger" (click)="toggleCollapsed()">
            <span nz-icon [nzType]="isCollapsed ? 'menu-unfold' : 'menu-fold'"></span>
          </span>
        </div>
        <div class="header-right">
          <span class="header-item">
            <span nz-icon nzType="bell" nzTheme="outline"></span>
          </span>
          <nz-divider nzType="vertical"></nz-divider>
          <a class="header-item" nz-dropdown [nzDropdownMenu]="userMenu">
            <span class="username">{{ currentUser?.hoTen || currentUser?.username }}</span>
          </a>
          <nz-dropdown-menu #userMenu="nzDropdownMenu">
            <ul nz-menu>
              <li nz-menu-item>
                <span nz-icon nzType="user"></span>
                Thông tin cá nhân
              </li>
              <li nz-menu-item>
                <span nz-icon nzType="lock"></span>
                Đổi mật khẩu
              </li>
              <li nz-menu-item (click)="logout()">
                <span nz-icon nzType="logout"></span>
                Đăng xuất
              </li>
            </ul>
          </nz-dropdown-menu>
        </div>
      </div>
    </nz-header>
    <nz-content>
      <div class="inner-content">
        <router-outlet></router-outlet>
      </div>
    </nz-content>
  </nz-layout>
</nz-layout>
````

## File: WebApp.Client/src/app/layout/main-layout/main-layout.component.scss
````scss
@import "src/styles/variables.scss";

.app-layout {
  height: 100vh;
}

.menu-sidebar {
  position: relative;
  z-index: 10;
  min-height: 100vh;
  background: $menu-dark-bg !important;
  box-shadow: 2px 0 6px rgba(0,51,102,.35);
}

::ng-deep {
  .ant-layout-sider,
  .ant-layout-sider-dark {
    background: $menu-dark-bg !important;
  }

  .ant-layout-sider-children {
    background: $menu-dark-bg !important;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .ant-menu-root.ant-menu-dark,
  .ant-menu-sub.ant-menu-dark,
  .ant-menu.ant-menu-dark,
  .ant-menu-dark .ant-menu-sub,
  .ant-menu.ant-menu-dark .ant-menu-sub {
    background: $menu-dark-bg !important;
    color: rgba(255, 255, 255, 0.85);
  }

  .ant-menu-dark.ant-menu-dark:not(.ant-menu-horizontal) .ant-menu-item-selected {
    background-color: $menu-dark-item-active-bg !important;
  }

  .ant-menu-dark .ant-menu-item:hover,
  .ant-menu-dark .ant-menu-item-active,
  .ant-menu-dark .ant-menu-submenu-active,
  .ant-menu-dark .ant-menu-submenu-open,
  .ant-menu-dark .ant-menu-submenu-selected,
  .ant-menu-dark .ant-menu-submenu-title:hover {
    background-color: $menu-dark-item-hover-bg !important;
  }

  .ant-menu-dark .ant-menu-inline.ant-menu-sub {
    background: $menu-dark-submenu-bg !important;
  }

  .ant-menu {
    flex: 1;
    background: $menu-dark-bg !important;
  }

  .ant-menu-inline {
    border-right: none;
  }

  .logout-item {
    margin-top: auto;
    border-top: 1px solid rgba(255,255,255,.15);
    
    &:hover {
      background: rgba(255,77,79,.15);
      color: $danger-color !important;
    }
  }

  // Button styles
  .ant-btn-primary {
    background: $primary-color-dark !important;
    border-color: $primary-color-dark !important;

    &:hover, &:focus {
      background: $primary-color !important;
      border-color: $primary-color !important;
    }
  }

  .ant-btn-default {
    &:hover, &:focus {
      color: $primary-color-dark !important;
      border-color: $primary-color-dark !important;
    }
  }

  .ant-btn-link {
    color: $primary-color-dark !important;

    &:hover, &:focus {
      color: $primary-color !important;
    }
  }
}

.sidebar-logo {
  position: relative;
  height: 64px;
  padding: 0 16px;
  overflow: hidden;
  background: rgba(255,255,255,.02);
  border-bottom: 1px solid rgba(255,255,255,.05);
  transition: all .3s;

  a {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-decoration: none;

    .logo-text {
      color: $layout-trigger-color;
      font-size: 20px;
      font-weight: 600;
      text-align: center;
      line-height: 1.2;
      
      &.collapsed {
        .collapsed-text {
          font-size: 20px;
          color: $layout-trigger-color;
          font-weight: bold;
        }
      }
      
      div:first-child {
        margin-bottom: 4px;
        color: $layout-trigger-color;
      }
      
      div:last-child {
        color: $layout-trigger-color;
      }
    }

    &:hover .logo-text div {
      color: $layout-trigger-color;
    }
  }
}

nz-header {
  padding: 0;
  width: 100%;
  z-index: 2;
}

.app-header {
  position: relative;
  height: 64px;
  padding: 0;
  background: $background-color;
  box-shadow: 0 2px 8px rgba(0,21,41,.08);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left {
  display: flex;
  align-items: center;
}

.header-trigger {
  height: 64px;
  width: 64px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  transition: all .3s ease;
  color: $text-color-light;

  &:hover {
    color: $primary-color-light;
    background-color: $item-hover-bg;
  }
}

.header-right {
  margin-right: 24px;
  display: flex;
  align-items: center;
  gap: 8px;

  .header-item {
    padding: 0 12px;
    height: 40px;
    cursor: pointer;
    display: flex;
    align-items: center;
    border-radius: 4px;
    transition: all .3s ease;
    color: $text-color-light;
    
    &:hover {
      color: $primary-color-light;
      background-color: $item-hover-bg;
    }
  }

  nz-divider {
    height: 24px;
    margin: 0 8px;
  }

  .username {
    margin: 0 8px;
    font-size: 14px;
    font-weight: 500;
    color: $text-color;
  }
}

nz-content {
  height: calc(100vh - 64px);
  overflow-y: auto;
  background: $background-color-light;
}

.inner-content {
  margin: 24px;
  min-height: calc(100% - 48px);
  background: transparent;
}

nz-footer {
  text-align: center;
  color: $text-color-disabled;
  font-size: 14px;
  padding: 24px 50px;
}

// Responsive styles
@media (max-width: 768px) {
  .sidebar-logo {
    padding-left: 16px;
    
    h1 {
      display: none;
    }
  }

  nz-content {
    margin: 12px;
  }

  .inner-content {
    padding: 16px;
  }

  .header-right {
    margin-right: 16px;
    gap: 4px;

    .header-item {
      padding: 0 8px;
    }

    nz-divider {
      margin: 0 4px;
    }

    .username {
      display: none;
    }
  }

  .header-left {
    nz-breadcrumb {
      margin-left: 8px;
      font-size: 13px;
    }
  }
}
````

## File: WebApp.Client/src/app/layout/main-layout/main-layout.component.spec.ts
````typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';

import { MainLayoutComponent } from './main-layout.component';

describe('MainLayoutComponent', () => {
  let component: MainLayoutComponent;
  let fixture: ComponentFixture<MainLayoutComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [MainLayoutComponent]
    })
    .compileComponents();

    fixture = TestBed.createComponent(MainLayoutComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});
````

## File: WebApp.Client/src/app/layout/main-layout/main-layout.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterOutlet, RouterLink, Router } from '@angular/router';
import { NzLayoutModule } from 'ng-zorro-antd/layout';
import { NzMenuModule } from 'ng-zorro-antd/menu';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzDropDownModule } from 'ng-zorro-antd/dropdown';
import { NzBreadCrumbModule } from 'ng-zorro-antd/breadcrumb';
import { NzAvatarModule } from 'ng-zorro-antd/avatar';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { AuthService } from '../../services/auth.service';
import { ShopOutline } from '@ant-design/icons-angular/icons';
import { NzIconService } from 'ng-zorro-antd/icon';

@Component({
  selector: 'app-main-layout',
  standalone: true,
  imports: [
    CommonModule,
    RouterOutlet,
    RouterLink,
    NzLayoutModule,
    NzMenuModule,
    NzIconModule,
    NzButtonModule,
    NzDropDownModule,
    NzBreadCrumbModule,
    NzAvatarModule,
    NzDividerModule
  ],
  templateUrl: './main-layout.component.html',
  styleUrls: ['./main-layout.component.scss']
})
export class MainLayoutComponent implements OnInit {
  isCollapsed = false;
  currentUser: any;
  isAdmin = false;

  constructor(
    private router: Router,
    private authService: AuthService,
    private iconService: NzIconService
  ) {
    this.iconService.addIcon(ShopOutline);
    this.currentUser = this.authService.getCurrentUser();
  }

  ngOnInit() {
    const savedState = localStorage.getItem('sidebarCollapsed');
    if (savedState !== null) {
      this.isCollapsed = savedState === 'true';
    }

    this.isAdmin = this.currentUser?.roles?.some((role: string) => 
      ['admin', 'super_admin'].includes(role)
    ) || this.currentUser?.isSuperAdmin;
  }

  toggleCollapsed(): void {
    this.isCollapsed = !this.isCollapsed;
    localStorage.setItem('sidebarCollapsed', this.isCollapsed.toString());
  }

  logout(): void {
    this.authService.logout();
    this.router.navigate(['/login']);
  }
}
````

## File: WebApp.Client/src/app/login/login.component.html
````html
<div class="login-container">
  <div class="left-panel">
    <div class="content">
      <h1>Hệ thống kê khai<br/>BHYT-BHXH</h1>
      <p>Chào mừng bạn quay trở lại với hệ thống quản lý bảo hiểm xã hội</p>
      <div class="features">
        <div class="feature-item">
          <i class="fas fa-shield-alt"></i>
          <span>Bảo mật thông tin</span>
        </div>
        <div class="feature-item">
          <i class="fas fa-sync-alt"></i>
          <span>Cập nhật liên tục</span>
        </div>
        <div class="feature-item">
          <i class="fas fa-headset"></i>
          <span>Hỗ trợ 24/7</span>
        </div>
      </div>
    </div>
  </div>

  <div class="right-panel">
    <div class="login-box">
      <div class="logo-container">
        <img src="assets/images/logo.png" alt="Logo" class="logo" *ngIf="false">
      </div>
      <h2>Đăng nhập</h2>
      <p class="subtitle">Vui lòng đăng nhập để tiếp tục</p>

      <form (ngSubmit)="onSubmit()" #loginForm="ngForm" class="login-form">
        <div class="form-group">
          <label for="username">Tên đăng nhập</label>
          <div class="input-group">
            <i class="fas fa-user"></i>
            <input 
              type="text" 
              id="username"
              name="username"
              [(ngModel)]="loginData.username"
              required
              placeholder="Nhập tên đăng nhập"
              class="form-control">
          </div>
        </div>

        <div class="form-group">
          <label for="password">Mật khẩu</label>
          <div class="input-group">
            <i class="fas fa-lock"></i>
            <input 
              [type]="showPassword ? 'text' : 'password'" 
              id="password"
              name="password"
              [(ngModel)]="loginData.password"
              required
              placeholder="Nhập mật khẩu"
              class="form-control">
            <i class="fas" [ngClass]="showPassword ? 'fa-eye-slash' : 'fa-eye'" (click)="togglePassword()"></i>
          </div>
        </div>

        <div class="form-options">
          <div class="remember-me">
            <input type="checkbox" id="remember" name="remember" [(ngModel)]="loginData.remember">
            <label for="remember">Ghi nhớ đăng nhập</label>
          </div>
          <a href="#" class="forgot-password">Quên mật khẩu?</a>
        </div>

        <button type="submit" 
          [disabled]="!loginForm.form.valid || isLoading" 
          class="btn-login">
          <span *ngIf="!isLoading">Đăng nhập</span>
          <div class="spinner" *ngIf="isLoading"></div>
        </button>

        <div class="error-message" *ngIf="errorMessage">
          <i class="fas fa-exclamation-circle"></i>
          {{ errorMessage }}
        </div>
      </form>

      <div class="login-footer">
        <p>© {{ currentYear }} CTY TNHH MTV TMDV HUY PHÚC. Tất cả các quyền được bảo lưu.</p>
      </div>
    </div>
  </div>
</div>
````

## File: WebApp.Client/src/app/login/login.component.scss
````scss
@import "src/styles/variables.scss";

.login-container {
  display: flex;
  min-height: 100vh;
  background-color: $background-color;
}

.left-panel {
  flex: 1;
  background-color: $primary-color;
  background-image: linear-gradient(135deg, $primary-color 0%, $primary-color-dark 100%);
  padding: 3rem;
  display: flex;
  flex-direction: column;
  justify-content: center;
  color: white;
  position: relative;
  overflow: hidden;

  &::before {
    content: '';
    position: absolute;
    width: 600px;
    height: 600px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    top: -200px;
    right: -200px;
  }

  &::after {
    content: '';
    position: absolute;
    width: 400px;
    height: 400px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    bottom: -100px;
    left: -100px;
  }

  .content {
    position: relative;
    z-index: 1;
  }

  h1 {
    font-size: 2.5rem;
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: 1rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  p {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-bottom: 2rem;
  }

  .features {
    margin-top: 3rem;

    .feature-item {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      
      i {
        font-size: 1.2rem;
        margin-right: 1rem;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      span {
        font-size: 1rem;
      }
    }
  }
}

.right-panel {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  background-color: #f8f9fa;
}

.login-box {
  width: 100%;
  max-width: 400px;
  padding: 2.5rem;
  background-color: $background-color;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.logo-container {
  text-align: center;
  margin-bottom: 1.5rem;

  .logo {
    height: 60px;
    width: auto;
  }
}

h2 {
  color: $primary-color;
  font-size: 1.75rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.subtitle {
  color: $text-color-secondary;
  margin-bottom: 2rem;
}

.login-form {
  .form-group {
    margin-bottom: 1.5rem;

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: $text-color;
      font-size: 0.9rem;
    }
  }

  .input-group {
    position: relative;
    
    i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: $text-color-secondary;
      font-size: 1.1rem;
    }

    .fa-eye, .fa-eye-slash {
      left: auto;
      right: 1rem;
      cursor: pointer;
      
      &:hover {
        color: $primary-color;
      }
    }

    .form-control {
      width: 100%;
      padding: 0.875rem 1rem 0.875rem 2.75rem;
      border: 1px solid $border-color;
      border-radius: 6px;
      font-size: 1rem;
      transition: all 0.3s ease;

      &:focus {
        outline: none;
        border-color: $primary-color;
        box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
      }

      &::placeholder {
        color: $text-color-disabled;
      }
    }
  }

  .form-options {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    
    .remember-me {
      display: flex;
      align-items: center;
      
      input[type="checkbox"] {
        margin-right: 0.5rem;
        cursor: pointer;
      }
      
      label {
        font-size: 0.9rem;
        color: $text-color-secondary;
        cursor: pointer;
      }
    }
    
    .forgot-password {
      font-size: 0.9rem;
      color: $primary-color;
      text-decoration: none;
      
      &:hover {
        text-decoration: underline;
      }
    }
  }
}

.btn-login {
  width: 100%;
  padding: 0.875rem;
  background-color: $primary-color;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

  &:hover:not(:disabled) {
    background-color: $primary-color-light;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
  }

  &:active:not(:disabled) {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  &:disabled {
    background-color: $border-color;
    cursor: not-allowed;
    box-shadow: none;
  }
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 0.8s linear infinite;
}

.error-message {
  margin-top: 16px;
  padding: 12px 16px;
  background-color: $login-error-bg;
  color: $login-error;
  border-radius: 6px;
  font-size: 14px;
  display: flex;
  align-items: center;
  border: 1px solid rgba(217, 48, 37, 0.2);
  
  i {
    margin-right: 8px;
    font-size: 16px;
  }
}

.login-footer {
  margin-top: 2rem;
  text-align: center;
  
  p {
    font-size: 0.8rem;
    color: $text-color-disabled;
  }
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

@media (max-width: 768px) {
  .login-container {
    flex-direction: column;
  }

  .left-panel {
    padding: 2rem;
    text-align: center;
    min-height: 200px;

    h1 {
      font-size: 2rem;
    }

    &::before,
    &::after {
      display: none;
    }
    
    .features {
      display: none;
    }
  }

  .right-panel {
    padding: 1.5rem;
  }

  .login-box {
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }
  
  .form-options {
    flex-direction: column;
    align-items: flex-start !important;
    
    .remember-me {
      margin-bottom: 0.5rem;
    }
  }
}
````

## File: WebApp.Client/src/app/login/login.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { Router } from '@angular/router';
import { FormsModule } from '@angular/forms';
import { CommonModule } from '@angular/common';
import { AuthService } from '../services/auth.service';
import { HttpErrorResponse } from '@angular/common/http';
import { IpService } from '../services/ip.service';

@Component({
  selector: 'app-login',
  templateUrl: './login.component.html',
  styleUrls: ['./login.component.scss'],
  standalone: true,
  imports: [FormsModule, CommonModule]
})
export class LoginComponent implements OnInit {
  loginData = {
    username: '',
    password: '',
    remember: false
  };
  errorMessage = '';
  isLoading = false;
  showPassword = false;
  currentYear = new Date().getFullYear();

  constructor(
    private authService: AuthService,
    private router: Router,
    private ipService: IpService
  ) { }

  togglePassword(): void {
    this.showPassword = !this.showPassword;
  }

  onSubmit(): void {
    if (this.isLoading) return;

    // Validate input
    if (!this.loginData.username.trim()) {
      this.errorMessage = 'Vui lòng nhập tên đăng nhập';
      return;
    }
    if (!this.loginData.password) {
      this.errorMessage = 'Vui lòng nhập mật khẩu';
      return;
    }

    this.isLoading = true;
    this.errorMessage = '';

    this.ipService.getIpAddress().subscribe({
      next: (ip) => {
        this.authService.login(this.loginData.username, this.loginData.password, ip).subscribe({
          next: (response) => {
            if (this.loginData.remember) {
              localStorage.setItem('remember_username', this.loginData.username);
            } else {
              localStorage.removeItem('remember_username');
            }
            localStorage.setItem('user', JSON.stringify({
              ...response.user,
              token: response.token
            }));
            this.authService.setSession(response);
            this.isLoading = false;
            this.router.navigate(['/dot-ke-khai']);
          },
          error: (error: HttpErrorResponse) => {
            this.isLoading = false;
            if (error.status === 401) {
              this.errorMessage = 'Tên đăng nhập hoặc mật khẩu không đúng';
            } else {
              this.errorMessage = 'Có lỗi xảy ra, vui lòng thử lại sau';
            }
          }
        });
      },
      error: () => {
        // Nếu không lấy được IP, vẫn tiếp tục login
        this.authService.login(this.loginData.username, this.loginData.password).subscribe({
          next: (response) => {
            if (this.loginData.remember) {
              localStorage.setItem('remember_username', this.loginData.username);
            } else {
              localStorage.removeItem('remember_username');
            }
            localStorage.setItem('user', JSON.stringify({
              ...response.user,
              token: response.token
            }));
            this.authService.setSession(response);
            this.isLoading = false;
            this.router.navigate(['/dot-ke-khai']);
          },
          error: (error: HttpErrorResponse) => {
            this.isLoading = false;
            if (error.status === 401) {
              this.errorMessage = 'Tên đăng nhập hoặc mật khẩu không đúng';
            } else {
              this.errorMessage = 'Có lỗi xảy ra, vui lòng thử lại sau';
            }
          }
        });
      }
    });
  }

  forgotPassword(): void {
    // Xử lý quên mật khẩu
    alert('Tính năng đang được phát triển');
  }

  ngOnInit(): void {
    // Kiểm tra xem có thông tin đăng nhập đã lưu không
    const savedUsername = localStorage.getItem('remember_username');
    if (savedUsername) {
      this.loginData.username = savedUsername;
      this.loginData.remember = true;
    }
  }
}
````

## File: WebApp.Client/src/app/services/auth.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';

interface LoginResponse {
  token: string;
  user: {
    id: number;
    username: string;
    ma_nhan_vien: string;
    hoTen: string;
    roles: string[];
    donViCongTac: string;
    chucDanh: string;
    clientId: string;
    email: string | null;
    soDienThoai: string | null;
    status: number;
    isSuperAdmin: boolean;
    typeMangLuoi: string | null;
  }
}

interface LoginRequest {
  username: string;
  password: string;
  ip?: string;
}

@Injectable({
  providedIn: 'root'
})
export class AuthService {
  constructor(private http: HttpClient) {}

  login(username: string, password: string, ip?: string): Observable<LoginResponse> {
    const loginData: LoginRequest = {
      username,
      password,
      ip
    };
    return this.http.post<LoginResponse>(`${environment.apiUrl}/auth/login`, loginData);
  }

  logout(): void {
    localStorage.removeItem('user');
    localStorage.removeItem('token');
  }

  setSession(authResult: any): void {
    if (!authResult) return;

    // Lưu token vào localStorage
    localStorage.setItem('token', authResult.token);
    
    // Lưu thông tin user riêng
    const userData = {
      ...authResult.user,
      token: authResult.token, // Thêm token vào object user
      ma_nhan_vien: authResult.user.username // Sử dụng username làm mã nhân viên
    };
    localStorage.setItem('user', JSON.stringify(userData));

    console.log('Saved auth data:', {
      token: authResult.token,
      user: userData
    });
  }

  isLoggedIn(): boolean {
    const token = localStorage.getItem('token');
    return !!token;
  }

  getCurrentUser(): any {
    const userStr = localStorage.getItem('user');
    if (!userStr) return null;
    try {
      return JSON.parse(userStr);
    } catch {
      return null;
    }
  }

  getToken(): string | null {
    return localStorage.getItem('token');
  }
}
````

## File: WebApp.Client/src/app/services/bien-lai-dien-tu.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';
import {
  BienLaiDienTu,
  BienLaiDienTuResponse,
  QuyenBienLaiDienTu,
  QuyenBienLaiDienTuResponse
} from '../bien-lai/models/bien-lai-dien-tu.model';

@Injectable({
  providedIn: 'root'
})
export class BienLaiDienTuService {
  private apiUrl = environment.apiUrl;

  constructor(private http: HttpClient) { }

  // Quyển biên lai điện tử
  getQuyenBienLais(): Observable<QuyenBienLaiDienTu[]> {
    return this.http.get<QuyenBienLaiDienTu[]>(`${this.apiUrl}/quyen-bien-lai-dien-tu`);
  }

  getQuyenBienLaiById(id: number): Observable<QuyenBienLaiDienTu> {
    return this.http.get<QuyenBienLaiDienTu>(`${this.apiUrl}/quyen-bien-lai-dien-tu/${id}`);
  }

  createQuyenBienLai(quyenBienLai: QuyenBienLaiDienTu): Observable<QuyenBienLaiDienTuResponse> {
    return this.http.post<QuyenBienLaiDienTuResponse>(`${this.apiUrl}/quyen-bien-lai-dien-tu`, quyenBienLai);
  }

  updateQuyenBienLai(id: number, quyenBienLai: QuyenBienLaiDienTu): Observable<any> {
    return this.http.put(`${this.apiUrl}/quyen-bien-lai-dien-tu/${id}`, quyenBienLai);
  }

  deleteQuyenBienLai(id: number): Observable<any> {
    return this.http.delete(`${this.apiUrl}/quyen-bien-lai-dien-tu/${id}`);
  }

  // Biên lai điện tử
  getBienLais(): Observable<BienLaiDienTu[]> {
    return this.http.get<BienLaiDienTu[]>(`${this.apiUrl}/bien-lai-dien-tu`);
  }

  getBienLaiById(id: number): Observable<BienLaiDienTu> {
    return this.http.get<BienLaiDienTu>(`${this.apiUrl}/bien-lai-dien-tu/${id}`);
  }

  createBienLai(bienLai: BienLaiDienTu): Observable<BienLaiDienTuResponse> {
    return this.http.post<BienLaiDienTuResponse>(`${this.apiUrl}/bien-lai-dien-tu`, bienLai);
  }

  updateBienLai(id: number, bienLai: BienLaiDienTu): Observable<any> {
    return this.http.put(`${this.apiUrl}/bien-lai-dien-tu/${id}`, bienLai);
  }

  deleteBienLai(id: number): Observable<any> {
    return this.http.delete(`${this.apiUrl}/bien-lai-dien-tu/${id}`);
  }
}
````

## File: WebApp.Client/src/app/services/bien-lai.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';

export interface BienLai {
  id: number;
  quyen_so: string;
  so_bien_lai: string;
  ten_nguoi_dong: string;
  so_tien: number;
  ghi_chu?: string;
  trang_thai: string;
  ngay_tao: Date;
  ke_khai_bhyt_id: number;
}

export interface BangKeBienLaiSearchParams {
  tuNgay?: Date | null;
  denNgay?: Date | null;
  quyenSo?: string | null | undefined;
  maNhanVien?: string | null | undefined;
  trangThai?: string | null | undefined;
  donVi?: string | null | undefined;
  tinhChat?: string | null | undefined;
  maHoSo?: string | null | undefined;
  mauBaoCao?: string;
}

export interface BangKeBienLai {
  quyen_so: string;
  so_bien_lai: string;
  ten_nguoi_dong: string;
  ma_so_bhxh: string;
  so_tien: number;
  ngay_bien_lai: Date;
  ma_nhan_vien: string;
  ten_nhan_vien?: string;
  ghi_chu?: string;
  trang_thai: string;
  tinh_chat: string;
  don_vi?: string;
  ma_ho_so?: string;
  so_thang_dong?: number;
  nguoi_thu?: number;
}

@Injectable({
  providedIn: 'root'
})
export class BienLaiService {
  private apiUrl = `${environment.apiUrl}/bien-lai`;

  constructor(private http: HttpClient) {}

  getBienLaiByKeKhai(keKhaiId: number): Observable<BienLai> {
    return this.http.get<BienLai>(`${this.apiUrl}/ke-khai/${keKhaiId}`);
  }

  inBienLai(bienLaiId: number): Observable<any> {
    return this.http.get(`${this.apiUrl}/${bienLaiId}/print`, {
      responseType: 'blob'
    });
  }

  getBangKeBienLai(params?: BangKeBienLaiSearchParams): Observable<BangKeBienLai[]> {
    let queryParams = new HttpParams();
    
    if (params) {
      Object.keys(params).forEach(key => {
        const value = params[key as keyof BangKeBienLaiSearchParams];
        if (value !== null && value !== undefined && value !== '') {
          if (key === 'tuNgay' || key === 'denNgay') {
            queryParams = queryParams.append(key, (value as Date).toISOString());
          } else {
            queryParams = queryParams.append(key, value.toString());
          }
        }
      });
    }
    
    return this.http.get<BangKeBienLai[]>(`${this.apiUrl}/bang-ke`, { params: queryParams });
  }

  exportBangKeBienLai(params?: BangKeBienLaiSearchParams): Observable<Blob> {
    let queryParams = new HttpParams();
    
    if (params) {
      Object.keys(params).forEach(key => {
        const value = params[key as keyof BangKeBienLaiSearchParams];
        if (value !== null && value !== undefined && value !== '') {
          if (key === 'tuNgay' || key === 'denNgay') {
            queryParams = queryParams.append(key, (value as Date).toISOString());
          } else {
            queryParams = queryParams.append(key, value.toString());
          }
        }
      });
    }

    return this.http.get(`${this.apiUrl}/bang-ke/export`, {
      params: queryParams,
      responseType: 'blob'
    });
  }

  exportBaoCaoBC01(params?: BangKeBienLaiSearchParams): Observable<Blob> {
    let queryParams = new HttpParams();
    
    if (params) {
      Object.keys(params).forEach(key => {
        const value = params[key as keyof BangKeBienLaiSearchParams];
        if (value !== null && value !== undefined && value !== '') {
          if (key === 'tuNgay' || key === 'denNgay') {
            queryParams = queryParams.append(key, (value as Date).toISOString());
          } else {
            queryParams = queryParams.append(key, value.toString());
          }
        }
      });
    }

    return this.http.get(`${this.apiUrl}/bang-ke/bao-cao/bc01`, {
      params: queryParams,
      responseType: 'blob'
    });
  }
}
````

## File: WebApp.Client/src/app/services/cccd.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Observable } from 'rxjs';
import { tap, catchError } from 'rxjs/operators';
import { throwError } from 'rxjs';

@Injectable({
  providedIn: 'root'
})
export class CCCDService {
  private apiKey = 'hdBg9sGAqA9mYwis25KLLkOA7j8AwvSx';
  private apiUrl = 'https://api.fpt.ai/vision/idr/vnm';

  constructor(private http: HttpClient) { }

  quetCCCD(file: File): Observable<any> {
    const formData = new FormData();
    formData.append('image', file);

    const headers = new HttpHeaders()
      .set('api-key', this.apiKey);

    console.log('Sending request to FPT.AI with file:', file);

    return this.http.post(this.apiUrl, formData, { headers }).pipe(
      tap(response => {
        console.log('FPT.AI Response:', response);
      }),
      catchError(error => {
        console.error('FPT.AI Error:', error);
        return throwError(() => error);
      })
    );
  }
}
````

## File: WebApp.Client/src/app/services/cloudinary.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { map } from 'rxjs/operators';
import { environment } from '../../environments/environment';

export interface CloudinaryResponse {
  secure_url: string;
  public_id: string;
}

@Injectable({
  providedIn: 'root'
})
export class CloudinaryService {
  private cloudName = environment.cloudinary.cloudName;
  private uploadPreset = environment.cloudinary.uploadPreset;
  private apiUrl = `https://api.cloudinary.com/v1_1/${this.cloudName}/image/upload`;

  constructor(private http: HttpClient) { }

  uploadImage(file: File, fileName: string): Observable<CloudinaryResponse> {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', this.uploadPreset);
    formData.append('public_id', fileName);
    formData.append('folder', 'bills');

    return this.http.post<any>(this.apiUrl, formData).pipe(
      map(response => {
        if (response.error) {
          throw new Error(response.error.message);
        }
        return {
          secure_url: response.secure_url,
          public_id: response.public_id
        };
      })
    );
  }
}
````

## File: WebApp.Client/src/app/services/dai-ly-don-vi.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';
import { DonVi } from './don-vi.service';
import { DaiLy } from './user.service';

export interface DaiLyDonVi {
  id?: number;
  daiLyId: number;
  donViId: number;
  trangThai: boolean;
  nguoiTao: string;
  ngayTao?: Date;
}

@Injectable({
  providedIn: 'root'
})
export class DaiLyDonViService {
  private apiUrl = `${environment.apiUrl}/dai-ly-don-vi`;

  constructor(private http: HttpClient) { }

  createDaiLyDonVi(data: DaiLyDonVi): Observable<DaiLyDonVi> {
    return this.http.post<DaiLyDonVi>(this.apiUrl, data);
  }

  getDaiLysByDonVi(donViId: number): Observable<any[]> {
    return this.http.get<any[]>(`${this.apiUrl}/don-vi/${donViId}/dai-lys`);
  }

  getDonVisByDaiLy(daiLyId: number): Observable<any[]> {
    return this.http.get<any[]>(`${this.apiUrl}/dai-ly/${daiLyId}/don-vis`);
  }

  addDaiLyDonVi(daiLyId: number, donViId: number, nguoiTao: string): Observable<any> {
    return this.http.post(this.apiUrl, { daiLyId, donViId, nguoiTao });
  }

  deleteDaiLyDonVi(id: number): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`);
  }
}
````

## File: WebApp.Client/src/app/services/dai-ly.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';
import { AuthService } from '../services/auth.service';

export interface DaiLy {
  id: number;
  ma: string;
  ten: string;
  diaChi: string;
  soDienThoai: string;
  email: string;
  nguoiDaiDien: string;
  trangThai: boolean;
  ngayTao?: Date;
  nguoiTao?: string;
  loading?: boolean;
}

@Injectable({
  providedIn: 'root'
})
export class DaiLyService {
  private apiUrl = `${environment.apiUrl}/dai-ly`;

  constructor(
    private http: HttpClient,
    private authService: AuthService
  ) { }

  getDaiLys(): Observable<DaiLy[]> {
    return this.http.get<DaiLy[]>(this.apiUrl);
  }

  createDaiLy(daiLy: Partial<DaiLy>): Observable<DaiLy> {
    const currentUser = this.authService.getCurrentUser();
    const data = {
      ...daiLy,
      nguoiTao: currentUser?.username || 'system',
      ngayTao: new Date()
    };
    return this.http.post<DaiLy>(this.apiUrl, data);
  }

  updateDaiLy(id: number, daiLy: Partial<DaiLy>): Observable<DaiLy> {
    const data = {
      id: id,
      ma: daiLy.ma,
      ten: daiLy.ten,
      dia_chi: daiLy.diaChi || '',
      so_dien_thoai: daiLy.soDienThoai || '',
      email: daiLy.email || '',
      nguoi_dai_dien: daiLy.nguoiDaiDien || '',
      trang_thai: daiLy.trangThai,
      nguoi_tao: daiLy.nguoiTao || '',
      ngay_tao: daiLy.ngayTao
    };

    return this.http.put<DaiLy>(`${this.apiUrl}/${id}`, data);
  }

  deleteDaiLy(id: number): Observable<any> {
    return this.http.delete<any>(`${this.apiUrl}/${id}`);
  }

  updateStatus(id: number, daiLy: DaiLy): Observable<DaiLy> {
    const data = {
      id: id,
      ma: daiLy.ma,
      ten: daiLy.ten,
      dia_chi: daiLy.diaChi || '',
      so_dien_thoai: daiLy.soDienThoai || '',
      email: daiLy.email || '',
      nguoi_dai_dien: daiLy.nguoiDaiDien || '',
      trang_thai: daiLy.trangThai,
      nguoi_tao: daiLy.nguoiTao || '',
      ngay_tao: daiLy.ngayTao
    };

    return this.http.put<DaiLy>(`${this.apiUrl}/${id}`, data);
  }
}
````

## File: WebApp.Client/src/app/services/dia-chi.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';

export interface DanhMucTinh {
  id: number;
  ma: string; 
  ten: string;
  text: string;
  created_at: Date;
}

export interface DanhMucHuyen {
  id: number;
  ma: string;
  ten: string;
  text: string;
  ma_tinh: string;
  created_at: Date;
}

export interface DanhMucXa {
  id: number;
  ma: string;
  ten: string;
  text: string;
  ma_huyen: string;
  created_at: Date;
}

@Injectable({
  providedIn: 'root'
})
export class DiaChiService {
  private baseUrl = environment.apiUrl;

  constructor(private http: HttpClient) { }

  getDanhMucTinh(): Observable<DanhMucTinh[]> {
    return this.http.get<DanhMucTinh[]>(`${this.baseUrl}/danh-muc-tinh`);
  }

  getDanhMucTinhByMa(ma: string): Observable<DanhMucTinh> {
    return this.http.get<DanhMucTinh>(`${this.baseUrl}/danh-muc-tinh/ma/${ma}`);
  }

  getDanhMucHuyen(): Observable<DanhMucHuyen[]> {
    return this.http.get<DanhMucHuyen[]>(`${this.baseUrl}/danh-muc-huyen`);
  }

  getDanhMucHuyenByMaTinh(maTinh: string): Observable<DanhMucHuyen[]> {
    return this.http.get<DanhMucHuyen[]>(`${this.baseUrl}/danh-muc-huyen/ma-tinh/${maTinh}`);
  }

  getDanhMucHuyenByMa(ma: string): Observable<DanhMucHuyen> {
    return this.http.get<DanhMucHuyen>(`${this.baseUrl}/danh-muc-huyen/ma/${ma}`);
  }

  getDanhMucXa(): Observable<DanhMucXa[]> {
    return this.http.get<DanhMucXa[]>(`${this.baseUrl}/danh-muc-xa`);
  }

  getDanhMucXaByMaHuyen(maHuyen: string): Observable<DanhMucXa[]> {
    return this.http.get<DanhMucXa[]>(`${this.baseUrl}/danh-muc-xa/ma-huyen/${maHuyen}`);
  }

  getDanhMucXaByMa(ma: string): Observable<DanhMucXa> {
    return this.http.get<DanhMucXa>(`${this.baseUrl}/danh-muc-xa/ma/${ma}`);
  }
}
````

## File: WebApp.Client/src/app/services/don-vi.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable, of } from 'rxjs';
import { environment } from '../../environments/environment';
import { catchError, shareReplay, tap } from 'rxjs/operators';

export interface DonVi {
  id: number;
  maCoQuanBHXH: string;
  maSoBHXH: string;
  tenDonVi: string;
  isBHXHTN: boolean;
  isBHYT: boolean;
  dmKhoiKcbId?: number;
  type: number;
  trangThai: boolean;
  createdAt: string;
  updatedAt: string;
  daiLyId: number;
  daiLy?: any;
  loading?: boolean;
  isActive?: boolean;
  ma_co_quan_bhxh?: string;
  ma_so_bhxh?: string;
  ten_don_vi?: string;
  is_bhxhtn?: boolean;
  is_bhyt?: boolean;
}

// Interface cho cache item
interface CacheItem<T> {
  data: T;
  expiry: number;
}

@Injectable({
  providedIn: 'root'
})
export class DonViService {
  private apiUrl = `${environment.apiUrl}/don-vi`;
  
  // Cache cho dữ liệu của service
  private cache: Map<string, CacheItem<any>> = new Map();
  // Thời gian cache mặc định (5 phút)
  private DEFAULT_CACHE_TTL = 5 * 60 * 1000;

  constructor(private http: HttpClient) { }

  // Hàm kiểm tra cache và lấy dữ liệu
  private getFromCache<T>(key: string): T | null {
    if (this.cache.has(key)) {
      const cacheItem = this.cache.get(key) as CacheItem<T>;
      // Kiểm tra xem cache còn hạn không
      if (cacheItem.expiry > Date.now()) {
        return cacheItem.data;
      } else {
        // Xóa cache hết hạn
        this.cache.delete(key);
      }
    }
    return null;
  }

  // Hàm lưu dữ liệu vào cache
  private saveToCache<T>(key: string, data: T, ttl: number = this.DEFAULT_CACHE_TTL): void {
    const expiry = Date.now() + ttl;
    this.cache.set(key, { data, expiry });
  }

  // Xóa cache
  clearCache(): void {
    this.cache.clear();
  }

  // Xóa cache theo tiền tố
  private clearCacheByPrefix(prefix: string): void {
    for (const key of this.cache.keys()) {
      if (key.startsWith(prefix)) {
        this.cache.delete(key);
      }
    }
  }

  getDonVis(): Observable<DonVi[]> {
    const cacheKey = 'donVis';
    
    // Kiểm tra cache
    const cachedData = this.getFromCache<DonVi[]>(cacheKey);
    if (cachedData) {
      return of(cachedData);
    }
    
    return this.http.get<DonVi[]>(this.apiUrl).pipe(
      tap(data => {
        // Lưu vào cache
        this.saveToCache(cacheKey, data);
      }),
      shareReplay(1),
      catchError(error => {
        console.error('Lỗi khi tải danh sách đơn vị:', error);
        return of([]);
      })
    );
  }

  getDonVi(id: number): Observable<DonVi> {
    const cacheKey = `donVi_${id}`;
    
    // Kiểm tra cache
    const cachedData = this.getFromCache<DonVi>(cacheKey);
    if (cachedData) {
      return of(cachedData);
    }
    
    return this.http.get<DonVi>(`${this.apiUrl}/${id}`).pipe(
      tap(data => {
        // Lưu vào cache
        this.saveToCache(cacheKey, data);
      }),
      catchError(error => {
        console.error(`Lỗi khi tải đơn vị id=${id}:`, error);
        throw error;
      })
    );
  }

  getDonVisByDaiLy(daiLyId: number): Observable<DonVi[]> {
    const cacheKey = `donVisByDaiLy_${daiLyId}`;
    
    // Kiểm tra cache
    const cachedData = this.getFromCache<DonVi[]>(cacheKey);
    if (cachedData) {
      console.log(`[Cache] Sử dụng dữ liệu cache cho donVisByDaiLy_${daiLyId}`);
      return of(cachedData);
    }
    
    return this.http.get<DonVi[]>(`${this.apiUrl}/by-dai-ly/${daiLyId}`).pipe(
      tap(data => {
        // Lưu vào cache
        this.saveToCache(cacheKey, data);
        console.log(`[API] Lưu dữ liệu vào cache cho donVisByDaiLy_${daiLyId}`);
      }),
      shareReplay(1),
      catchError(error => {
        console.error(`Lỗi khi tải danh sách đơn vị theo điểm thu id=${daiLyId}:`, error);
        return of([]);
      })
    );
  }

  createDonVi(donVi: Partial<DonVi>): Observable<DonVi> {
    // Xóa tất cả cache liên quan
    this.clearCacheByPrefix('donVi');
    
    return this.http.post<DonVi>(this.apiUrl, donVi).pipe(
      tap(() => {
        // Xóa cache danh sách đơn vị
        this.cache.delete('donVis');
      }),
      catchError(error => {
        console.error('Lỗi khi tạo đơn vị mới:', error);
        throw error;
      })
    );
  }

  updateDonVi(id: number, donVi: Partial<DonVi>): Observable<void> {
    // Xóa tất cả cache liên quan
    this.clearCacheByPrefix('donVi');
    
    return this.http.put<void>(`${this.apiUrl}/${id}`, donVi).pipe(
      tap(() => {
        // Xóa cache danh sách đơn vị và đơn vị cụ thể
        this.cache.delete('donVis');
        this.cache.delete(`donVi_${id}`);
      }),
      catchError(error => {
        console.error(`Lỗi khi cập nhật đơn vị id=${id}:`, error);
        throw error;
      })
    );
  }

  deleteDonVi(id: number): Observable<void> {
    // Xóa tất cả cache liên quan
    this.clearCacheByPrefix('donVi');
    
    return this.http.delete<void>(`${this.apiUrl}/${id}`).pipe(
      tap(() => {
        // Xóa cache danh sách đơn vị và đơn vị cụ thể
        this.cache.delete('donVis');
        this.cache.delete(`donVi_${id}`);
      }),
      catchError(error => {
        console.error(`Lỗi khi xóa đơn vị id=${id}:`, error);
        throw error;
      })
    );
  }

  updateStatus(id: number, trangThai: boolean): Observable<DonVi> {
    return this.http.patch<DonVi>(`${this.apiUrl}/${id}/status`, { trangThai });
  }
}
````

## File: WebApp.Client/src/app/services/dot-ke-khai.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Observable, BehaviorSubject, of } from 'rxjs';
import { tap, map, catchError, shareReplay } from 'rxjs/operators';
import { environment } from '../../environments/environment';

export interface KeKhaiBHYT {
  ho_ten: string;
  cccd: string;
  ngay_sinh: Date;
  gioi_tinh: string;
  dia_chi: string;
  so_dien_thoai: string;
  email: string;
  so_tien: number;
  ghi_chu?: string;
  so_the_bhyt: string;
  ma_so_bhxh?: string;
  nguoi_thu: number;
  phuong_an_dong?: string;
  ngay_bien_lai?: Date;
  ma_tinh_nkq?: string;
}

// Interface cho việc tạo mới
export interface CreateDotKeKhai {
  ten_dot: string;
  so_dot: number;
  thang: number;
  nam: number;
  dich_vu?: string;
  ghi_chu: string;
  trang_thai: string;
  nguoi_tao: string;
  don_vi_id: number;
  ma_ho_so?: string;
  is_bien_lai_dien_tu?: boolean;
  dai_ly_id: number;
  KeKhaiBHYTs?: any[];
}

// Interface cho việc cập nhật
export interface UpdateDotKeKhai extends CreateDotKeKhai {
  id: number; // id bắt buộc phải có khi cập nhật
}

// Interface chung
export interface DotKeKhai {
  id?: number;
  ten_dot: string;
  so_dot: number;
  thang: number;
  nam: number;
  dich_vu: string;
  ghi_chu: string;
  trang_thai: string;
  nguoi_tao: string;
  don_vi_id: number;
  ngay_tao?: Date;
  ngay_gui?: Date;
  checked?: boolean;
  tong_so_tien?: number;
  tong_so_the?: number;
  ma_ho_so?: string;
  bien_lai_dien_tu?: boolean;
  is_bien_lai_dien_tu?: boolean;
  url_bill?: string;
  dai_ly_id: number;
  KeKhaiBHYTs?: any[];
  DonVi?: {
    id: number;
    tenDonVi: string;
    maCoQuanBHXH: string;
    maSoBHXH: string;
  };
  // Thêm các thuộc tính thay thế để tương thích với dữ liệu API
  donVi?: {
    id: number;
    tenDonVi: string;
    maCoQuanBHXH: string;
    maSoBHXH: string;
  };
  don_vi?: {
    id: number;
    tenDonVi: string;
    maCoQuanBHXH: string;
    maSoBHXH: string;
  };
}

// Tạo interface cho cache item
interface CacheItem<T> {
  data: T;
  expiry: number;
}

@Injectable({
  providedIn: 'root'
})
export class DotKeKhaiService {
  private apiUrl = `${environment.apiUrl}/DotKeKhai`;
  private dotKeKhaisSubject = new BehaviorSubject<DotKeKhai[]>([]);
  dotKeKhais$ = this.dotKeKhaisSubject.asObservable();
  
  // Cache cho dữ liệu của service
  private cache: Map<string, CacheItem<any>> = new Map();
  // Thời gian cache mặc định (5 phút)
  private DEFAULT_CACHE_TTL = 5 * 60 * 1000;

  constructor(private http: HttpClient) { }

  // Lấy username hiện tại
  private getCurrentUsername(): string {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    return user.username || '';
  }

  // Hàm kiểm tra cache và lấy dữ liệu
  private getFromCache<T>(key: string): T | null {
    if (this.cache.has(key)) {
      const cacheItem = this.cache.get(key) as CacheItem<T>;
      // Kiểm tra xem cache còn hạn không
      if (cacheItem.expiry > Date.now()) {
        return cacheItem.data;
      } else {
        // Xóa cache hết hạn
        this.cache.delete(key);
      }
    }
    return null;
  }

  // Hàm lưu dữ liệu vào cache
  private saveToCache<T>(key: string, data: T, ttl: number = this.DEFAULT_CACHE_TTL): void {
    const expiry = Date.now() + ttl;
    this.cache.set(key, { data, expiry });
  }

  // Xóa cache
  clearCache(): void {
    this.cache.clear();
  }

  getDotKeKhais(): Observable<DotKeKhai[]> {
    const username = this.getCurrentUsername();
    const cacheKey = `dotKeKhais_${username}`;
    
    // Kiểm tra cache
    const cachedData = this.getFromCache<DotKeKhai[]>(cacheKey);
    if (cachedData) {
      return of(cachedData);
    }
    
    // Thêm query params bằng HttpParams để tránh vấn đề mã hóa URL
    const params = new HttpParams()
      .set('includeTongSoTien', 'true')
      .set('includeTongSoThe', 'true')
      .set('includeDonVi', 'true')
      .set('nguoi_tao', username);
    
    return this.http.get<DotKeKhai[]>(this.apiUrl, { params }).pipe(
      tap(data => {
        // Lưu vào cache
        this.saveToCache(cacheKey, data);
        // Cập nhật BehaviorSubject
        this.dotKeKhaisSubject.next(data);
      }),
      shareReplay(1),
      catchError(error => {
        console.error('Lỗi khi tải danh sách đợt kê khai:', error);
        return of([]);
      })
    );
  }

  getDotKeKhai(id: number): Observable<DotKeKhai> {
    const cacheKey = `dotKeKhai_${id}`;
    
    // Kiểm tra cache
    const cachedData = this.getFromCache<DotKeKhai>(cacheKey);
    if (cachedData) {
      return of(cachedData);
    }
    
    const params = new HttpParams()
      .set('includeTongSoTien', 'true')
      .set('includeTongSoThe', 'true')
      .set('includeDonVi', 'true');
    
    return this.http.get<DotKeKhai>(`${this.apiUrl}/${id}`, { params }).pipe(
      tap(data => {
        // Lưu vào cache với thời gian ngắn hơn (2 phút)
        this.saveToCache(cacheKey, data, 2 * 60 * 1000);
      }),
      shareReplay(1),
      catchError(error => {
        console.error(`Lỗi khi tải đợt kê khai id=${id}:`, error);
        throw error;
      })
    );
  }

  createDotKeKhai(dotKeKhai: CreateDotKeKhai): Observable<DotKeKhai> {
    return this.http.post<DotKeKhai>(this.apiUrl, dotKeKhai).pipe(
      tap(newDotKeKhai => {
        // Xóa cache để đảm bảo dữ liệu mới nhất
        this.clearCacheByPrefix('dotKeKhais_');
        
        const username = this.getCurrentUsername();
        const currentData = this.dotKeKhaisSubject.value;
        // Chỉ cập nhật dữ liệu của người dùng hiện tại
        const filteredData = currentData.filter(item => item.nguoi_tao === username);
        this.dotKeKhaisSubject.next([...filteredData, newDotKeKhai]);
      }),
      catchError(error => {
        console.error('Lỗi khi tạo đợt kê khai mới:', error);
        throw error;
      })
    );
  }

  updateDotKeKhai(id: number, dotKeKhai: UpdateDotKeKhai): Observable<void> {
    return this.http.put<void>(`${this.apiUrl}/${id}`, dotKeKhai).pipe(
      tap(() => {
        // Xóa cache liên quan
        this.clearCacheByPrefix('dotKeKhais_');
        this.cache.delete(`dotKeKhai_${id}`);
        
        const username = this.getCurrentUsername();
        const currentData = this.dotKeKhaisSubject.value;
        // Chỉ cập nhật dữ liệu của người dùng hiện tại
        const filteredData = currentData.filter(item => item.nguoi_tao === username);
        const updatedData = filteredData.map(item => 
          item.id === id ? { ...item, ...dotKeKhai } : item
        );
        this.dotKeKhaisSubject.next(updatedData);
      }),
      catchError(error => {
        console.error(`Lỗi khi cập nhật đợt kê khai id=${id}:`, error);
        throw error;
      })
    );
  }

  deleteDotKeKhai(id: number): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`).pipe(
      tap(() => {
        // Xóa cache liên quan
        this.clearCacheByPrefix('dotKeKhais_');
        this.cache.delete(`dotKeKhai_${id}`);
        
        const username = this.getCurrentUsername();
        const currentData = this.dotKeKhaisSubject.value;
        // Chỉ cập nhật dữ liệu của người dùng hiện tại
        const filteredData = currentData
          .filter(item => item.nguoi_tao === username)
          .filter(item => item.id !== id);
        this.dotKeKhaisSubject.next(filteredData);
      }),
      catchError(error => {
        console.error(`Lỗi khi xóa đợt kê khai id=${id}:`, error);
        throw error;
      })
    );
  }

  getNextSoDot(donViId: number, thang: number, nam: number): Observable<number> {
    const cacheKey = `nextSoDot_${donViId}_${thang}_${nam}`;
    
    // Cache thấp hơn vì số đợt có thể thay đổi nhanh
    const cachedData = this.getFromCache<number>(cacheKey);
    if (cachedData) {
      return of(cachedData);
    }
    
    const params = new HttpParams()
      .set('donViId', donViId.toString())
      .set('thang', thang.toString())
      .set('nam', nam.toString());
    
    return this.http.get<number>(`${this.apiUrl}/next-so-dot`, { params }).pipe(
      tap(data => {
        // Lưu vào cache với thời gian ngắn hơn (1 phút)
        this.saveToCache(cacheKey, data, 60 * 1000);
      }),
      catchError(error => {
        console.error('Lỗi khi lấy số đợt tiếp theo:', error);
        throw error;
      })
    );
  }

  updateTongSoTien(id: number): Observable<DotKeKhai> {
    // Xóa cache cho đợt kê khai này
    this.cache.delete(`dotKeKhai_${id}`);
    
    return this.http.get<DotKeKhai>(`${this.apiUrl}/${id}`).pipe(
      tap(dotKeKhai => {
        const username = this.getCurrentUsername();
        const currentData = this.dotKeKhaisSubject.value;
        // Chỉ cập nhật dữ liệu của người dùng hiện tại
        const updatedData = currentData
          .filter(item => item.nguoi_tao === username)
          .map(item => item.id === id ? { ...item, tong_so_tien: dotKeKhai.tong_so_tien } : item);
        this.dotKeKhaisSubject.next(updatedData);
      }),
      catchError(error => {
        console.error(`Lỗi khi cập nhật tổng số tiền cho đợt kê khai id=${id}:`, error);
        throw error;
      })
    );
  }

  getKeKhaiBHYTsByDotKeKhaiId(dotKeKhaiId: number): Observable<KeKhaiBHYT[]> {
    const cacheKey = `keKhaiBHYTs_${dotKeKhaiId}`;
    
    // Kiểm tra cache
    const cachedData = this.getFromCache<KeKhaiBHYT[]>(cacheKey);
    if (cachedData) {
      return of(cachedData);
    }
    
    return this.http.get<KeKhaiBHYT[]>(`${this.apiUrl}/${dotKeKhaiId}/ke-khai-bhyt`).pipe(
      tap(data => {
        // Lưu vào cache
        this.saveToCache(cacheKey, data);
      }),
      shareReplay(1),
      catchError(error => {
        console.error(`Lỗi khi lấy danh sách kê khai BHYT cho đợt id=${dotKeKhaiId}:`, error);
        throw error;
      })
    );
  }

  updateTrangThai(id: number, trangThai: string): Observable<any> {
    // Xóa tất cả cache liên quan
    this.clearCacheByPrefix('dotKeKhai');
    
    return this.http.patch(`${this.apiUrl}/${id}/trang-thai`, { trang_thai: trangThai })
      .pipe(
        tap(() => {
          // Cập nhật lại danh sách đợt kê khai
          const username = this.getCurrentUsername();
          this.getDotKeKhais().subscribe({
            next: (data) => {
              // Lọc dữ liệu theo người dùng hiện tại trước khi cập nhật dotKeKhaisSubject
              const filteredData = data.filter(dot => dot.nguoi_tao === username);
              this.dotKeKhaisSubject.next(filteredData);
            },
            error: (error) => {
              console.error('Lỗi khi cập nhật trạng thái đợt kê khai:', error);
            }
          });
        }),
        catchError(error => {
          console.error(`Lỗi khi cập nhật trạng thái đợt kê khai id=${id}:`, error);
          throw error;
        })
      );
  }

  guiDotKeKhai(id: number, bienLaiDienTu: boolean = false): Observable<any> {
    // Xóa tất cả cache liên quan
    this.clearCacheByPrefix('dotKeKhai');
    
    console.log(`Gửi đợt kê khai ${id} với biên lai điện tử:`, bienLaiDienTu);
    
    // Cập nhật trạng thái đợt kê khai và các kê khai BHYT sang chờ thanh toán
    return this.http.patch(`${this.apiUrl}/${id}/gui`, { bien_lai_dien_tu: bienLaiDienTu }).pipe(
      tap((response) => {
        console.log('Kết quả gửi đợt kê khai:', response);
        // Cập nhật lại danh sách đợt kê khai
        const username = this.getCurrentUsername();
        this.getDotKeKhais().subscribe({
          next: (data) => {
            // Lọc dữ liệu theo người dùng hiện tại trước khi cập nhật dotKeKhaisSubject
            const filteredData = data.filter(dot => dot.nguoi_tao === username);
            this.dotKeKhaisSubject.next(filteredData);
          },
          error: (error) => {
            console.error('Lỗi khi cập nhật sau khi gửi đợt kê khai:', error);
          }
        });
      }),
      catchError(error => {
        console.error(`Lỗi khi gửi đợt kê khai id=${id}:`, error);
        throw error;
      })
    );
  }

  // Phương thức duyệt đợt kê khai
  duyetDotKeKhai(id: number): Observable<any> {
    // Xóa tất cả cache liên quan
    this.clearCacheByPrefix('dotKeKhai');
    
    return this.http.patch(`${this.apiUrl}/${id}/trang-thai`, { trang_thai: 'cho_thanh_toan' }).pipe(
      tap(() => {
        // Cập nhật lại danh sách đợt kê khai
        const username = this.getCurrentUsername();
        this.getDotKeKhais().subscribe({
          next: (data) => {
            // Lọc dữ liệu theo người dùng hiện tại trước khi cập nhật dotKeKhaisSubject
            const filteredData = data.filter(dot => dot.nguoi_tao === username);
            this.dotKeKhaisSubject.next(filteredData);
          },
          error: (error) => {
            console.error('Lỗi khi cập nhật sau khi duyệt đợt kê khai:', error);
          }
        });
      }),
      catchError(error => {
        console.error(`Lỗi khi duyệt đợt kê khai id=${id}:`, error);
        throw error;
      })
    );
  }
  
  // Hàm xóa cache theo tiền tố
  private clearCacheByPrefix(prefix: string): void {
    for (const key of this.cache.keys()) {
      if (key.startsWith(prefix)) {
        this.cache.delete(key);
      }
    }
  }
}
````

## File: WebApp.Client/src/app/services/export-vnpt.service.ts
````typescript
import { Injectable } from '@angular/core';
import * as XLSX from 'xlsx';
import { DotKeKhai } from './dot-ke-khai.service';
import { DotKeKhaiService } from './dot-ke-khai.service';
import { UserService } from './user.service';
import { NzMessageService } from 'ng-zorro-antd/message';
import { Observable, of, forkJoin } from 'rxjs';
import { catchError, map, switchMap } from 'rxjs/operators';

@Injectable({
  providedIn: 'root'
})
export class ExportVnptService {

  constructor(
    private dotKeKhaiService: DotKeKhaiService,
    private userService: UserService,
    private message: NzMessageService
  ) { }

  // Hàm chuyển đổi giới tính
  getGioiTinhValue(gioiTinh: string): string {
    return gioiTinh?.toLowerCase() === 'nam' ? '1' : '0';
  }

  // Hàm kiểm tra tuổi
  isUnder18(ngaySinh: string | Date | null | undefined): boolean {
    if (!ngaySinh) return false;
    
    const birthDate = new Date(ngaySinh);
    const today = new Date();
    
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    // Nếu chưa tới tháng sinh nhật hoặc tới tháng sinh nhật nhưng chưa tới ngày sinh nhật
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    
    return age < 18;
  }

  // Lấy text cho phương án đóng BHYT
  getPhuongAnDongText(phuongAnDong: string): string {
    const phuongAnDongMap: Record<string, string> = {
      'dao_han': 'ON',
      'tang_moi': 'TM',
      'dung_dong': 'GH'
    };
    return phuongAnDongMap[phuongAnDong] || '';
  }

  // Xuất file VNPT cho nhiều đợt kê khai
  xuatVNPTNhieuDot(dotKeKhaiList: DotKeKhai[]): Observable<boolean> {
    if (!dotKeKhaiList || dotKeKhaiList.length === 0) {
      this.message.warning('Không có dữ liệu để xuất');
      return of(false);
    }

    // Chỉ chọn các đợt kê khai BHYT
    const dotKeKhaiBHYTList = dotKeKhaiList.filter(d => d.dich_vu === 'BHYT');
    
    if (dotKeKhaiBHYTList.length === 0) {
      this.message.warning('Không có dữ liệu BHYT để xuất');
      return of(false);
    }

    // Lấy thông tin user từ service
    return this.userService.getCurrentUserInfo().pipe(
      switchMap((user) => {
        console.log('Thông tin người dùng hiện tại:', user);
        // Lấy mã nhân viên từ user hiện tại, sẽ được sử dụng nếu đợt kê khai không có mã
        const maNhanVienFromCurrentUser = user?.ma_nhan_vien || '';
        console.log('Mã nhân viên từ người dùng hiện tại:', maNhanVienFromCurrentUser);

        // Tạo mảng Observables cho mỗi đợt kê khai
        const observables = dotKeKhaiBHYTList
          .filter(dotKeKhai => dotKeKhai.id !== undefined) // Lọc bỏ các đợt kê khai không có id
          .map(dotKeKhai => {
            // Lấy mã nhân viên từ đợt kê khai hiện tại
            const maNhanVienFromDotKeKhai = dotKeKhai.nguoi_tao || '';
            console.log(`Đợt kê khai ${dotKeKhai.ten_dot} - Mã nhân viên: ${maNhanVienFromDotKeKhai}`);

            return this.dotKeKhaiService.getKeKhaiBHYTsByDotKeKhaiId(dotKeKhai.id!).pipe(
              map((keKhaiBHYTs: any[]) => {
                // Sắp xếp dữ liệu theo số biên lai tăng dần
                keKhaiBHYTs.sort((a, b) => {
                  // Nếu một trong hai bản ghi không có số biên lai, đặt nó ở cuối
                  if (!a.so_bien_lai && !b.so_bien_lai) return 0;
                  if (!a.so_bien_lai) return 1;
                  if (!b.so_bien_lai) return -1;
                  
                  // Nếu cùng quyển biên lai, so sánh số biên lai
                  if (a.QuyenBienLai?.quyen_so === b.QuyenBienLai?.quyen_so) {
                    const soBienLaiA = parseInt(a.so_bien_lai || '0');
                    const soBienLaiB = parseInt(b.so_bien_lai || '0');
                    return soBienLaiA - soBienLaiB;
                  }
                  
                  // Nếu khác quyển biên lai, so sánh quyển biên lai
                  return (a.QuyenBienLai?.quyen_so || '').localeCompare(b.QuyenBienLai?.quyen_so || '');
                });
                
                // Cập nhật lại STT sau khi sắp xếp và thêm mã nhân viên
                keKhaiBHYTs = keKhaiBHYTs.map((item, index) => {
                  // Ưu tiên lấy mã nhân viên theo thứ tự:
                  // 1. Từ item.nguoi_tao (nếu có)
                  // 2. Từ đợt kê khai (nguoi_tao)
                  // 3. Từ user hiện tại
                  const maNhanVienThu = item.nguoi_tao || maNhanVienFromDotKeKhai || maNhanVienFromCurrentUser || '';
                  
                  console.log(`Người tham gia ${item.ho_ten} - Mã nhân viên: ${maNhanVienThu}`);
                  
                  return {
                    ...item,
                    stt: index + 1,
                    tenDotKeKhai: dotKeKhai.ten_dot, // Thêm tên đợt kê khai vào mỗi bản ghi
                    maNhanVienThu: maNhanVienThu // Gán mã nhân viên thu
                  };
                });
                
                return {
                  dotKeKhai,
                  keKhaiBHYTs
                };
              }),
              catchError(error => {
                console.error(`Lỗi khi lấy dữ liệu cho đợt kê khai ${dotKeKhai.ten_dot}:`, error);
                return of({ 
                  dotKeKhai, 
                  keKhaiBHYTs: []
                });
              })
            );
          });
        
        // Kết hợp tất cả kết quả
        return observables.length > 0 ? 
          forkJoin(observables) : 
          of([]);
      }),
      map((results: any[]) => {
        // Ghép tất cả dữ liệu từ nhiều đợt kê khai
        let allData: any[] = [];
        let stt = 1;
        
        results.forEach(result => {
          if (result && result.keKhaiBHYTs && result.keKhaiBHYTs.length > 0) {
            // Cập nhật lại STT cho toàn bộ dữ liệu
            const updatedItems = result.keKhaiBHYTs.map((item: any) => ({
              ...item,
              stt: stt++
            }));
            
            allData = [...allData, ...updatedItems];
          }
        });
        
        if (allData.length === 0) {
          this.message.warning('Không có dữ liệu chi tiết để xuất');
          return false;
        }
        
        // Tạo workbook
        const wb = XLSX.utils.book_new();
        
        // Thêm 2 dòng trống
        const emptyRows = [
          Array(13).fill(''),  // Dòng 1 trống với 13 cột
          Array(13).fill('')   // Dòng 2 trống với 13 cột
        ];
        
        // Chuẩn bị dữ liệu cho sheet
        const keKhaiHeaders = [
          'STT', // Cột A - Số thứ tự
          'HoTen', // Cột B - Họ tên người tham gia
          'MasoBHXH', // Cột C - Mã số BHXH
          'MaPhongBan', // Cột D - Mã phòng ban (để trống)
          'Loai', // Cột E - Loại (mặc định là 1)
          'PA', // Cột F - Phương án đóng (ON/TM/GH)
          'TyleNSDP', // Cột G - Tỷ lệ NSDP (để trống)
          'NgayBienLai', // Cột H - Ngày biên lai
          'SoBienLai', // Cột I - Số biên lai (để trống)
          'NguoiThamGiaThu', // Cột J - Người thu
          'Tiendong', // Cột K - Tiền đóng (mặc định 2,340,000)
          'TienDongThucTe', // Cột L - Tiền đóng thực tế (để trống)
          'MucHuong', // Cột M - Mức hưởng (mặc định là 4)
          'TuNgay', // Cột N - Từ ngày (để trống)
          'NgayChet', // Cột O - Ngày chết (để trống)
          'HotroKhac', // Cột P - Hỗ trợ khác (để trống)
          'TenTinhDangSS', // Cột Q - Tên tỉnh đăng ký (để trống)
          'Matinh_DangSS', // Cột R - Mã tỉnh đăng ký
          'Tenhuyen_DangSS', // Cột S - Tên huyện đăng ký
          'Mahuyen_DangSS', // Cột T - Mã huyện đăng ký
          'TenxaDangSS', // Cột U - Tên xã đăng ký
          'Maxa_DangSS', // Cột V - Mã xã đăng ký
          'Diachi_DangSS', // Cột W - Địa chỉ đăng ký
          'Sothang', // Cột X - Số tháng đóng
          'Ghichu', // Cột Y - Ghi chú (để trống)
          'NgaySinh', // Cột Z - Ngày sinh
          'GioiTinh', // Cột AA - Giới tính
          'TenTinhBenhVien', // Cột AB - Tên tỉnh bệnh viện (để trống)
          'MaTinhBenhVien', // Cột AC - Mã tỉnh nơi khám quyết định
          'TenBenhVien', // Cột AD - Tên bệnh viện (để trống)
          'MaBenhVien', // Cột AE - Mã bệnh viện
          'MavungSS', // Cột AF - Mã vùng (để trống)
          'Tk1_Save', // Cột AG - TK1 Save (để trống)
          'CMND', // Cột AH - CCCD
          'Maho_Giadinh', // Cột AI - Mã hộ gia đình
          'TenDotKeKhai', // Cột AJ - Tên đợt kê khai
          'QuocTich', // Cột AK - Quốc tịch
          '', // Cột AL - Để trống
          '', // Cột AM - Để trống
          'TenTinhKS', // Cột AN - Tên tỉnh khai sinh (để trống)
          'MaTinh_KS', // Cột AO - Mã tỉnh khai sinh
          'TenHuyenKS', // Cột AP - Tên huyện khai sinh (để trống)
          'MaHuyen_KS', // Cột AQ - Mã huyện khai sinh
          'TenXaKS', // Cột AR - Tên xã khai sinh (để trống)
          'MaXa_KS', // Cột AS - Mã xã khai sinh
          'TenTinhNN', // Cột AT - Tên tỉnh nơi khám (để trống)
          'Matinh_NN', // Cột AU - Mã tỉnh nơi khám quyết định
          'TenHuyenNN', // Cột AV - Tên huyện nơi khám (để trống)
          'Mahuyen_NN', // Cột AW - Mã huyện nơi khám quyết định
          'TenXaNN', // Cột AX - Tên xã nơi khám (để trống)
          'Maxa_NN', // Cột AY - Mã xã nơi khám quyết định
          'Diachi_NN', // Cột AZ - Địa chỉ nơi khám quyết định
          '', // Cột BA - Để trống
          '', // Cột BB - Để trống
          '', // Cột BC - Để trống
          '', // Cột BD - Để trống
          '', // Cột BE - Để trống
          '', // Cột BF - Để trống
          '', // Cột BG - Để trống
          '', // Cột BH - Để trống
          'SoCCCD', // Cột BI - Số CCCD
          'SoBienLai', // Cột BJ - Số biên lai
          'NgayBienLai', // Cột BK - Ngày biên lai
          'MaNhanvienThu', // Cột BL - Mã nhân viên thu
        ];
        
        const keKhaiData = allData.map((item: any) => {
          // Sử dụng mã nhân viên đã được gán trong bước xử lý dữ liệu
          const maNhanVienThu = item.maNhanVienThu || '';
          console.log(`Xuất Excel: ${item.ho_ten} - Mã nhân viên: ${maNhanVienThu}`);
          
          return [
            item.stt, // Sử dụng STT từ API
            item.ho_ten,
            item.ma_so_bhxh || '', 
            '', // Để trống cột D (MaPhongBan)
            '1', // Cột E giá trị mặc định là 1
            this.getPhuongAnDongText(item.phuong_an_dong || ''),
            '', // Cột G trống
            item.ngay_bien_lai ? new Date(item.ngay_bien_lai).toLocaleDateString('vi-VN', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            }) : '',
            item.so_bien_lai ? (item.QuyenBienLai ? 
              `${item.QuyenBienLai.quyen_so}${item.so_bien_lai.padStart(5, '0')}` : 
              item.so_bien_lai
            ) : '',
            typeof item.nguoi_thu !== 'undefined' ? item.nguoi_thu.toString() : '',
            '2340000', // Cột K - Tiendong - giá trị mặc định không có dấu phẩy
            '0', // Cột L - giá trị mặc định là 0
            '4', // Cột M giá trị mặc định là 4
            item.han_the_moi_tu ? new Date(item.han_the_moi_tu).toLocaleDateString('vi-VN', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            }) : '', // Cột N hiển thị Hạn thẻ mới từ
            '', // Cột O trống
            '', // Cột P trống
            '', // Cột Q trống
            item.ma_tinh_nkq || '', // Cột R - Mã tỉnh
            '', // Cột S - Tên huyện (trống)
            item.ma_huyen_nkq || '', // Cột T - Mã huyện
            '', // Cột U - Tên xã (trống)
            item.ma_xa_nkq || '', // Cột V - Mã xã
            item.dia_chi_nkq || '', // Cột W - Địa chỉ
            item.so_thang_dong?.toString() || '', // Cột X hiển thị số tháng đóng
            // Cột Y - Thêm "nghỉ học" nếu người tham gia có tuổi nhỏ hơn 18
            this.isUnder18(item.ngay_sinh) ? 'Nghỉ học' : (item.is_urgent ? 'Thẻ Gấp' : ''),
            item.ngay_sinh ? new Date(item.ngay_sinh).toLocaleDateString('vi-VN', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            }) : '', // Cột Z hiển thị ngày sinh
            this.getGioiTinhValue(item.gioi_tinh), // Cột AA hiển thị giới tính
            '', // Cột AB trống
            item.ma_tinh_nkq || '', // Cột AC hiển thị mã tỉnh nơi khám quyết định
            '', // Cột AD trống
            item.ma_benh_vien || '', // Cột AE hiển thị mã bệnh viện
            '', // Cột AF trống
            'x', // Cột AG giá trị mặc định là x
            item.cccd || '', // Cột AH hiển thị CCCD
            item.ma_hgd || '', // Cột AI hiển thị mã hộ gia đình
            item.tenDotKeKhai || '', // Cột AJ hiển thị tên đợt kê khai
            item.quoc_tich || 'VN', // Cột AK hiển thị quốc tịch, mặc định là VN
            '', // Cột AL trống
            '', // Cột AM trống
            '', // Cột AN trống
            item.ma_tinh_ks || '', // Cột AO hiển thị mã tỉnh khai sinh
            '', // Cột AP trống
            item.ma_huyen_ks || '', // Cột AQ hiển thị mã huyện khai sinh
            '', // Cột AR trống
            item.ma_xa_ks || '', // Cột AS hiển thị mã xã khai sinh
            '', // Cột AT trống
            item.ma_tinh_nkq || '', // Cột AU hiển thị mã tỉnh nơi khám quyết định
            '', // Cột AV trống
            item.ma_huyen_nkq || '', // Cột AW hiển thị mã huyện nơi khám quyết định
            '', // Cột AX trống
            item.ma_xa_nkq || '', // Cột AY hiển thị mã xã nơi khám quyết định
            item.dia_chi_nkq || '', // Cột AZ hiển thị địa chỉ nơi khám quyết định
            '', // Cột BA trống
            '', // Cột BB trống
            '', // Cột BC trống
            '', // Cột BD trống
            '', // Cột BE trống
            '', // Cột BF trống
            '', // Cột BG trống
            '', // Cột BH trống
            item.cccd || '', // Cột BI hiển thị CCCD
            item.so_bien_lai ? (item.QuyenBienLai ? 
              `${item.QuyenBienLai.quyen_so}${item.so_bien_lai.padStart(5, '0')}` : 
              item.so_bien_lai
            ) : '', // Cột BJ - Số biên lai
            item.ngay_bien_lai ? new Date(item.ngay_bien_lai).toLocaleDateString('vi-VN', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            }) : '', // Cột BK - Ngày biên lai
            maNhanVienThu, // Cột BL - Mã nhân viên thu
          ];
        });
        
        // Tạo worksheet từ dữ liệu
        const ws = XLSX.utils.aoa_to_sheet([...emptyRows, keKhaiHeaders, ...keKhaiData]);
        
        // Thiết lập độ rộng cột
        const maxWidth = 120;
        const colWidths = Array(keKhaiHeaders.length).fill({ wch: 15 });
        
        // Cột STT hẹp hơn
        colWidths[0] = { wch: 5 };
        
        // Cột họ tên rộng hơn
        colWidths[1] = { wch: 30 };
        
        // Cột địa chỉ rộng hơn
        colWidths[22] = { wch: 40 };
        colWidths[38] = { wch: 40 };
        
        ws['!cols'] = colWidths;
        
        // Thêm worksheet vào workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Dữ Liệu');
        
        // Tạo tên file với timestamp
        const now = new Date();
        const fileName = `VNPT_BHYT_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}.xlsx`;
        
        // Xuất file Excel
        XLSX.writeFile(wb, fileName);
        
        this.message.success(`Xuất dữ liệu thành công! Đã xuất ${allData.length} bản ghi từ ${results.length} đợt kê khai.`);
        return true;
      }),
      catchError(error => {
        console.error('Lỗi khi xuất dữ liệu VNPT:', error);
        this.message.error('Có lỗi xảy ra khi xuất dữ liệu. Vui lòng thử lại sau.');
        return of(false);
      })
    );
  }

  // Xuất Excel cho một đợt kê khai
  xuatExcelDotKeKhai(dotKeKhai: DotKeKhai): Observable<boolean> {
    if (!dotKeKhai || !dotKeKhai.id) {
      this.message.warning('Không tìm thấy thông tin đợt kê khai');
      return of(false);
    }

    if (dotKeKhai.dich_vu !== 'BHYT') {
      this.message.warning('Chỉ hỗ trợ xuất dữ liệu kê khai BHYT');
      return of(false);
    }

    const dotKeKhaiId = dotKeKhai.id;

    // Lấy thông tin user từ service
    return this.userService.getCurrentUserInfo().pipe(
      switchMap((user) => {
        const maNhanVien = user.maNhanVien || '';
        
        // Gọi service để lấy dữ liệu kê khai
        return this.dotKeKhaiService.getKeKhaiBHYTsByDotKeKhaiId(dotKeKhaiId).pipe(
          map((keKhaiBHYTs: any[]) => {
            // Sắp xếp dữ liệu theo số biên lai tăng dần
            keKhaiBHYTs.sort((a, b) => {
              // Nếu một trong hai bản ghi không có số biên lai, đặt nó ở cuối
              if (!a.so_bien_lai && !b.so_bien_lai) return 0;
              if (!a.so_bien_lai) return 1;
              if (!b.so_bien_lai) return -1;
              
              // Nếu cùng quyển biên lai, so sánh số biên lai
              if (a.QuyenBienLai?.quyen_so === b.QuyenBienLai?.quyen_so) {
                return parseInt(a.so_bien_lai) - parseInt(b.so_bien_lai);
              }
              
              // Nếu khác quyển biên lai, so sánh quyển biên lai
              return (a.QuyenBienLai?.quyen_so || '').localeCompare(b.QuyenBienLai?.quyen_so || '');
            });
            
            // Cập nhật lại STT sau khi sắp xếp
            keKhaiBHYTs = keKhaiBHYTs.map((item, index) => ({
              ...item,
              stt: index + 1
            }));

            // Chuẩn bị dữ liệu cho sheet danh sách kê khai
            const keKhaiHeaders = [
              'STT', // Cột A - Số thứ tự
              'HoTen', // Cột B - Họ tên người tham gia
              'MasoBHXH', // Cột C - Mã số BHXH
              'MaPhongBan', // Cột D - Mã phòng ban (để trống)
              'Loai', // Cột E - Loại (mặc định là 1)
              'PA', // Cột F - Phương án đóng (ON/TM/GH)
              'TyleNSDP', // Cột G - Tỷ lệ NSDP (để trống)
              'NgayBienLai', // Cột H - Ngày biên lai
              'SoBienLai', // Cột I - Số biên lai (để trống)
              'NguoiThamGiaThu', // Cột J - Người thu
              'Tiendong', // Cột K - Tiền đóng (mặc định 2,340,000)
              'TienDongThucTe', // Cột L - Tiền đóng thực tế (để trống)
              'MucHuong', // Cột M - Mức hưởng (mặc định là 4)
              'TuNgay', // Cột N - Từ ngày (để trống)
              'NgayChet', // Cột O - Ngày chết (để trống)
              'HotroKhac', // Cột P - Hỗ trợ khác (để trống)
              'TenTinhDangSS', // Cột Q - Tên tỉnh đăng ký (để trống)
              'Matinh_DangSS', // Cột R - Mã tỉnh đăng ký
              'Tenhuyen_DangSS', // Cột S - Tên huyện đăng ký
              'Mahuyen_DangSS', // Cột T - Mã huyện đăng ký
              'TenxaDangSS', // Cột U - Tên xã đăng ký
              'Maxa_DangSS', // Cột V - Mã xã đăng ký
              'Diachi_DangSS', // Cột W - Địa chỉ đăng ký
              'Sothang', // Cột X - Số tháng đóng
              'Ghichu', // Cột Y - Ghi chú (để trống)
              'NgaySinh', // Cột Z - Ngày sinh
              'GioiTinh', // Cột AA - Giới tính
              'TenTinhBenhVien', // Cột AB - Tên tỉnh bệnh viện (để trống)
              'MaTinhBenhVien', // Cột AC - Mã tỉnh nơi khám quyết định
              'TenBenhVien', // Cột AD - Tên bệnh viện (để trống)
              'MaBenhVien', // Cột AE - Mã bệnh viện
              'MavungSS', // Cột AF - Mã vùng (để trống)
              'Tk1_Save', // Cột AG - TK1 Save (để trống)
              'CMND', // Cột AH - CCCD
              'Maho_Giadinh', // Cột AI - Mã hộ gia đình
              '', // Cột AJ - Để trống
              'QuocTich', // Cột AK - Quốc tịch
              '', // Cột AL - Để trống
              '', // Cột AM - Để trống
              'TenTinhKS', // Cột AN - Tên tỉnh khai sinh (để trống)
              'MaTinh_KS', // Cột AO - Mã tỉnh khai sinh
              'TenHuyenKS', // Cột AP - Tên huyện khai sinh (để trống)
              'MaHuyen_KS', // Cột AQ - Mã huyện khai sinh
              'TenXaKS', // Cột AR - Tên xã khai sinh (để trống)
              'MaXa_KS', // Cột AS - Mã xã khai sinh
              'TenTinhNN', // Cột AT - Tên tỉnh nơi khám (để trống)
              'Matinh_NN', // Cột AU - Mã tỉnh nơi khám quyết định
              'TenHuyenNN', // Cột AV - Tên huyện nơi khám (để trống)
              'Mahuyen_NN', // Cột AW - Mã huyện nơi khám quyết định
              'TenXaNN', // Cột AX - Tên xã nơi khám (để trống)
              'Maxa_NN', // Cột AY - Mã xã nơi khám quyết định
              'Diachi_NN', // Cột AZ - Địa chỉ nơi khám quyết định
              '', // Cột BA - Để trống
              '', // Cột BB - Để trống
              '', // Cột BC - Để trống
              '', // Cột BD - Để trống
              '', // Cột BE - Để trống
              '', // Cột BF - Để trống
              '', // Cột BG - Để trống
              '', // Cột BH - Để trống
              'SoCCCD', // Cột BI - Số CCCD
              'SoBienLai', // Cột BJ - Số biên lai
              'NgayBienLai', // Cột BK - Ngày biên lai
              'MaNhanvienThu', // Cột BL - Mã nhân viên thu
            ];

            // Thêm 2 dòng trống trước header
            const emptyRows = [
              Array(13).fill(''),  // Dòng 1 trống với 13 cột
              Array(13).fill('')   // Dòng 2 trống với 13 cột
            ];
            
            const keKhaiData = keKhaiBHYTs.map((item: any) => {
              // Lấy mã nhân viên từ người tạo đợt kê khai
              const maNhanVienThu = dotKeKhai.nguoi_tao || maNhanVien || '12345';
              
              return [
                item.stt, // Sử dụng STT từ API
                item.ho_ten,
                item.ma_so_bhxh || '', 
                '', // Để trống cột D (MaPhongBan)
                '1', // Cột E giá trị mặc định là 1
                this.getPhuongAnDongText(item.phuong_an_dong || ''),
                '', // Cột G trống
                item.ngay_bien_lai ? new Date(item.ngay_bien_lai).toLocaleDateString('vi-VN', {
                  day: '2-digit',
                  month: '2-digit',
                  year: 'numeric'
                }) : '',
                item.so_bien_lai ? (item.QuyenBienLai ? 
                  `${item.QuyenBienLai.quyen_so}${item.so_bien_lai.padStart(5, '0')}` : 
                  item.so_bien_lai
                ) : '',
                typeof item.nguoi_thu !== 'undefined' ? item.nguoi_thu.toString() : '',
                '2340000', // Cột K - Tiendong - giá trị mặc định không có dấu phẩy
                '0', // Cột L - giá trị mặc định là 0
                '4', // Cột M giá trị mặc định là 4
                item.han_the_moi_tu ? new Date(item.han_the_moi_tu).toLocaleDateString('vi-VN', {
                  day: '2-digit',
                  month: '2-digit',
                  year: 'numeric'
                }) : '', // Cột N hiển thị Hạn thẻ mới từ
                '', // Cột O trống
                '', // Cột P trống
                '', // Cột Q trống
                item.ma_tinh_nkq || '', // Cột R - Mã tỉnh
                '', // Cột S - Tên huyện (trống)
                item.ma_huyen_nkq || '', // Cột T - Mã huyện
                '', // Cột U - Tên xã (trống)
                item.ma_xa_nkq || '', // Cột V - Mã xã
                item.dia_chi_nkq || '', // Cột W - Địa chỉ
                item.so_thang_dong?.toString() || '', // Cột X hiển thị số tháng đóng
                // Cột Y - Thêm "nghỉ học" nếu người tham gia có tuổi nhỏ hơn 18
                this.isUnder18(item.ngay_sinh) ? 'Nghỉ học' : (item.is_urgent ? 'Thẻ Gấp' : ''),
                item.ngay_sinh ? new Date(item.ngay_sinh).toLocaleDateString('vi-VN', {
                  day: '2-digit',
                  month: '2-digit',
                  year: 'numeric'
                }) : '', // Cột Z hiển thị ngày sinh
                this.getGioiTinhValue(item.gioi_tinh), // Cột AA hiển thị giới tính
                '', // Cột AB trống
                item.ma_tinh_nkq || '', // Cột AC hiển thị mã tỉnh nơi khám quyết định
                '', // Cột AD trống
                item.ma_benh_vien || '', // Cột AE hiển thị mã bệnh viện
                '', // Cột AF trống
                'x', // Cột AG giá trị mặc định là x
                item.cccd || '', // Cột AH hiển thị CCCD
                item.ma_hgd || '', // Cột AI hiển thị mã hộ gia đình
                '', // Cột AJ trống
                item.quoc_tich || 'VN', // Cột AK hiển thị quốc tịch, mặc định là VN
                '', // Cột AL trống
                '', // Cột AM trống
                '', // Cột AN trống
                item.ma_tinh_ks || '', // Cột AO hiển thị mã tỉnh khai sinh
                '', // Cột AP trống
                item.ma_huyen_ks || '', // Cột AQ hiển thị mã huyện khai sinh
                '', // Cột AR trống
                item.ma_xa_ks || '', // Cột AS hiển thị mã xã khai sinh
                '', // Cột AT trống
                item.ma_tinh_nkq || '', // Cột AU hiển thị mã tỉnh nơi khám quyết định
                '', // Cột AV trống
                item.ma_huyen_nkq || '', // Cột AW hiển thị mã huyện nơi khám quyết định
                '', // Cột AX trống
                item.ma_xa_nkq || '', // Cột AY hiển thị mã xã nơi khám quyết định
                item.dia_chi_nkq || '', // Cột AZ hiển thị địa chỉ nơi khám quyết định
                '', // Cột BA trống
                '', // Cột BB trống
                '', // Cột BC trống
                '', // Cột BD trống
                '', // Cột BE trống
                '', // Cột BF trống
                '', // Cột BG trống
                '', // Cột BH trống
                item.cccd || '', // Cột BI hiển thị CCCD
                item.so_bien_lai ? (item.QuyenBienLai ? 
                  `${item.QuyenBienLai.quyen_so}${item.so_bien_lai.padStart(5, '0')}` : 
                  item.so_bien_lai
                ) : '', // Cột BJ - Số biên lai
                item.ngay_bien_lai ? new Date(item.ngay_bien_lai).toLocaleDateString('vi-VN', {
                  day: '2-digit',
                  month: '2-digit',
                  year: 'numeric'
                }) : '', // Cột BK - Ngày biên lai
                maNhanVienThu, // Cột BL - Mã nhân viên thu
              ];
            });

            // Tạo workbook và thêm sheet danh sách kê khai
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([...emptyRows, keKhaiHeaders, ...keKhaiData]);
            XLSX.utils.book_append_sheet(wb, ws, 'Dữ Liệu');

            // Tạo style cho sheet
            ws['!cols'] = [
              { wch: 8 },  // STT
              { wch: 30 }, // HoTen  
              { wch: 15 }, // Mã số BHXH
              { wch: 10 }, // Cột D trống
              { wch: 10 }, // Cột E trống
              { wch: 15 }, // Phương án đóng
              { wch: 10 }, // Cột G trống 
              { wch: 15 }, // Ngày biên lai
              { wch: 10 }, // Cột I trống
              { wch: 15 }, // Người thứ
              { wch: 15 }, // Cột K
              { wch: 10 }, // Cột L
              { wch: 10 }, // Cột M
              { wch: 10 }, // Cột N trống
              { wch: 10 }, // Cột O trống
              { wch: 10 }, // Cột P trống
              { wch: 10 }, // Cột Q trống
              { wch: 15 }, // Cột R trống
              { wch: 10 }, // Cột S trống
              { wch: 15 }, // Cột T trống
              { wch: 10 }, // Cột U trống
              { wch: 50 }, // Cột V Diachi_DangSS
              { wch: 10 }, // Cột W trống
              { wch: 15 }, // Cột X Sothang
              { wch: 10 }, // Cột Y trống
              { wch: 15 }, // Cột Z NgaySinh
              { wch: 10 }, // Cột AA GioiTinh
              { wch: 10 }, // Cột AB trống
              { wch: 15 }, // Cột AC trống
              { wch: 10 }, // Cột AD trống
              { wch: 15 }, // Cột AE trống
              { wch: 10 }, // Cột AF trống
              { wch: 10 }, // Cột AG trống
              { wch: 15 }, // Cột AH trống
              { wch: 15 }, // Cột AI trống
              { wch: 15 }, // Cột AK trống
              { wch: 10 }, // Cột AL trống
              { wch: 10 }, // Cột AM trống
              { wch: 10 }, // Cột AN trống
              { wch: 15 }, // Cột AO trống
              { wch: 10 }, // Cột AP trống
              { wch: 15 }, // Cột AQ trống
              { wch: 10 }, // Cột AR trống
              { wch: 15 }, // Cột AS trống
              { wch: 10 }, // Cột AT trống
              { wch: 15 }, // Cột AU trống
              { wch: 10 }, // Cột AV trống
              { wch: 15 }, // Cột AW trống
              { wch: 10 }, // Cột AX trống
              { wch: 15 }, // Cột AY trống
              { wch: 50 }, // Cột AZ DiaChi_DangSS
              { wch: 10 }, // Cột BA trống
              { wch: 10 }, // Cột BB trống
              { wch: 10 }, // Cột BC trống
              { wch: 10 }, // Cột BD trống
              { wch: 10 }, // Cột BE trống
              { wch: 10 }, // Cột BF trống
              { wch: 10 }, // Cột BG trống
              { wch: 10 }, // Cột BH trống
              { wch: 15 }, // Cột BI trống
              { wch: 15 }, // Cột BJ trống
              { wch: 15 }, // Cột BK trống
              { wch: 15 }, // Cột BL - MaNhanvienThu
            ];

            // Xuất file Excel
            XLSX.writeFile(wb, `ke-khai-bhyt-${dotKeKhai.ten_dot.toLowerCase().replace(/\s+/g, '-')}.xlsx`);
            
            this.message.success('Xuất dữ liệu kê khai BHYT thành công');
            return true;
          })
        );
      }),
      catchError((error) => {
        console.error('Lỗi khi xuất Excel:', error);
        if (error.status === 404) {
          this.message.error(`Không tìm thấy đợt kê khai có ID: ${dotKeKhai.id}`);
        } else {
          this.message.error('Có lỗi xảy ra khi xuất dữ liệu kê khai BHYT');
        }
        return of(false);
      })
    );
  }

  // Xuất Excel cho nhiều đợt kê khai
  xuatExcelNhieuDotKeKhai(dotKeKhaiList: DotKeKhai[]): boolean {
    if (dotKeKhaiList.length === 0) {
      this.message.warning('Không có dữ liệu để xuất');
      return false;
    }
    
    // Chuẩn bị dữ liệu
    const headers = [
      'STT', 
      'Tên đợt kê khai', 
      'Loại dịch vụ', 
      'Đơn vị', 
      'Số thẻ', 
      'Tổng tiền', 
      'Ngày tạo', 
      'Ngày gửi', 
      'Trạng thái',
      'Người tạo',
      'Mã hồ sơ'
    ];
    
    const data = dotKeKhaiList.map((item, index) => [
      index + 1,
      item.ten_dot,
      item.dich_vu,
      this.getDonViName(item),
      item.tong_so_the || 0,
      item.tong_so_tien ? item.tong_so_tien.toLocaleString('vi-VN') + ' đ' : '0 đ',
      item.ngay_tao ? new Date(item.ngay_tao).toLocaleDateString('vi-VN') : '',
      item.ngay_gui ? new Date(item.ngay_gui).toLocaleDateString('vi-VN') : '',
      this.getTrangThaiText(item.trang_thai),
      item.nguoi_tao || '',
      item.ma_ho_so || ''
    ]);
    
    // Tạo workbook và worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    
    // Thiết lập độ rộng cột
    ws['!cols'] = [
      { wch: 5 },   // STT
      { wch: 40 },  // Tên đợt kê khai
      { wch: 15 },  // Loại dịch vụ
      { wch: 30 },  // Đơn vị
      { wch: 10 },  // Số thẻ
      { wch: 15 },  // Tổng tiền
      { wch: 15 },  // Ngày tạo
      { wch: 15 },  // Ngày gửi
      { wch: 15 },  // Trạng thái
      { wch: 15 },  // Người tạo
      { wch: 15 }   // Mã hồ sơ
    ];
    
    // Thêm worksheet vào workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Danh sách kê khai');
    
    // Tên file và xuất Excel
    const fileName = `danh-sach-ke-khai-${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    this.message.success('Xuất Excel thành công');
    return true;
  }

  // Phương thức hỗ trợ - lấy tên đơn vị
  getDonViName(data: DotKeKhai): string {
    if (!data) {
      return 'Không có';
    }
    
    // Kiểm tra DonVi với tên khác nhau
    if (data.DonVi?.tenDonVi) {
      return data.DonVi.tenDonVi;
    }
    
    if (data.donVi?.tenDonVi) {
      return data.donVi.tenDonVi;
    }
    
    if (data.don_vi?.tenDonVi) {
      return data.don_vi.tenDonVi;
    }
    
    // Kiểm tra thông qua cách tiếp cận any
    const anyData = data as any;
    
    if (anyData.DonVi?.ten_don_vi) {
      return anyData.DonVi.ten_don_vi;
    }
    
    // Kiểm tra các trường hợp khác nhau
    if (anyData['don_vi']?.tenDonVi) {
      return anyData['don_vi'].tenDonVi;
    }
    
    if (anyData['don_vi']?.ten_don_vi) {
      return anyData['don_vi'].ten_don_vi;
    }
    
    if (anyData['DonVi']?.tenDonVi) {
      return anyData['DonVi'].tenDonVi;
    }
    
    if (anyData['donvi']?.tenDonVi) {
      return anyData['donvi'].tenDonVi;
    }
    
    // Hiển thị đơn vị ID nếu có
    if (data.don_vi_id) {
      return `ID: ${data.don_vi_id}`;
    }
    
    // Khi không có thông tin đơn vị
    return 'Không có';
  }

  // Phương thức hỗ trợ - lấy trạng thái text
  getTrangThaiText(trangThai: string): string {
    switch (trangThai) {
      case 'chua_gui':
        return 'Chưa gửi';
      case 'da_gui':
        return 'Đã gửi';
      case 'da_duyet':
        return 'Đã duyệt';
      case 'da_tu_choi':
        return 'Đã từ chối';
      case 'cho_thanh_toan':
        return 'Chờ thanh toán';
      case 'hoan_thanh':
        return 'Hoàn thành';
      case 'tu_choi':
        return 'Từ chối';
      case 'dang_xu_ly':
        return 'Đang xử lý';
      default:
        return 'Không xác định';
    }
  }

  // Xuất file VNPT với mã nhân viên được chỉ định từ ngoài
  xuatVNPTNhieuDotVoiMaNhanVien(dotKeKhaiList: DotKeKhai[], maNhanVienThuFromUser: string): Observable<boolean> {
    if (!dotKeKhaiList || dotKeKhaiList.length === 0) {
      this.message.warning('Không có dữ liệu để xuất');
      return of(false);
    }

    // Chỉ chọn các đợt kê khai BHYT
    const dotKeKhaiBHYTList = dotKeKhaiList.filter(d => d.dich_vu === 'BHYT');
    
    if (dotKeKhaiBHYTList.length === 0) {
      this.message.warning('Không có dữ liệu BHYT để xuất');
      return of(false);
    }

    console.log('Sử dụng mã nhân viên từ người dùng:', maNhanVienThuFromUser);

    // Lấy thông tin user từ service
    return this.userService.getCurrentUserInfo().pipe(
      switchMap((user) => {
        // Tạo mảng Observables cho mỗi đợt kê khai
        const observables = dotKeKhaiBHYTList
          .filter(dotKeKhai => dotKeKhai.id !== undefined) // Lọc bỏ các đợt kê khai không có id
          .map(dotKeKhai => {
            return this.dotKeKhaiService.getKeKhaiBHYTsByDotKeKhaiId(dotKeKhai.id!).pipe(
              map((keKhaiBHYTs: any[]) => {
                // Sắp xếp dữ liệu theo số biên lai tăng dần
                keKhaiBHYTs.sort((a, b) => {
                  // Nếu một trong hai bản ghi không có số biên lai, đặt nó ở cuối
                  if (!a.so_bien_lai && !b.so_bien_lai) return 0;
                  if (!a.so_bien_lai) return 1;
                  if (!b.so_bien_lai) return -1;
                  
                  // Nếu cùng quyển biên lai, so sánh số biên lai
                  if (a.QuyenBienLai?.quyen_so === b.QuyenBienLai?.quyen_so) {
                    const soBienLaiA = parseInt(a.so_bien_lai || '0');
                    const soBienLaiB = parseInt(b.so_bien_lai || '0');
                    return soBienLaiA - soBienLaiB;
                  }
                  
                  // Nếu khác quyển biên lai, so sánh quyển biên lai
                  return (a.QuyenBienLai?.quyen_so || '').localeCompare(b.QuyenBienLai?.quyen_so || '');
                });
                
                // Cập nhật lại STT sau khi sắp xếp
                keKhaiBHYTs = keKhaiBHYTs.map((item, index) => ({
                  ...item,
                  stt: index + 1,
                  tenDotKeKhai: dotKeKhai.ten_dot, // Thêm tên đợt kê khai vào mỗi bản ghi
                  maNhanVienThu: maNhanVienThuFromUser // Thêm mã nhân viên thu từ người dùng
                }));
                
                return {
                  dotKeKhai,
                  keKhaiBHYTs
                };
              }),
              catchError(error => {
                console.error(`Lỗi khi lấy dữ liệu cho đợt kê khai ${dotKeKhai.ten_dot}:`, error);
                return of({ 
                  dotKeKhai, 
                  keKhaiBHYTs: []
                });
              })
            );
          });
        
        // Kết hợp tất cả kết quả
        return observables.length > 0 ? 
          forkJoin(observables) : 
          of([]);
      }),
      map((results: any[]) => {
        // Ghép tất cả dữ liệu từ nhiều đợt kê khai
        let allData: any[] = [];
        let stt = 1;
        
        results.forEach(result => {
          if (result && result.keKhaiBHYTs && result.keKhaiBHYTs.length > 0) {
            // Cập nhật lại STT cho toàn bộ dữ liệu
            const updatedItems = result.keKhaiBHYTs.map((item: any) => ({
              ...item,
              stt: stt++
            }));
            
            allData = [...allData, ...updatedItems];
          }
        });
        
        if (allData.length === 0) {
          this.message.warning('Không có dữ liệu chi tiết để xuất');
          return false;
        }
        
        // Tạo workbook
        const wb = XLSX.utils.book_new();
        
        // Thêm 2 dòng trống
        const emptyRows = [
          Array(13).fill(''),  // Dòng 1 trống với 13 cột
          Array(13).fill('')   // Dòng 2 trống với 13 cột
        ];
        
        // Chuẩn bị dữ liệu cho sheet
        const keKhaiHeaders = [
          'STT', // Cột A - Số thứ tự
          'HoTen', // Cột B - Họ tên người tham gia
          'MasoBHXH', // Cột C - Mã số BHXH
          'MaPhongBan', // Cột D - Mã phòng ban (để trống)
          'Loai', // Cột E - Loại (mặc định là 1)
          'PA', // Cột F - Phương án đóng (ON/TM/GH)
          'TyleNSDP', // Cột G - Tỷ lệ NSDP (để trống)
          'NgayBienLai', // Cột H - Ngày biên lai
          'SoBienLai', // Cột I - Số biên lai (để trống)
          'NguoiThamGiaThu', // Cột J - Người thu
          'Tiendong', // Cột K - Tiền đóng (mặc định 2,340,000)
          'TienDongThucTe', // Cột L - Tiền đóng thực tế (để trống)
          'MucHuong', // Cột M - Mức hưởng (mặc định là 4)
          'TuNgay', // Cột N - Từ ngày (để trống)
          'NgayChet', // Cột O - Ngày chết (để trống)
          'HotroKhac', // Cột P - Hỗ trợ khác (để trống)
          'TenTinhDangSS', // Cột Q - Tên tỉnh đăng ký (để trống)
          'Matinh_DangSS', // Cột R - Mã tỉnh đăng ký
          'Tenhuyen_DangSS', // Cột S - Tên huyện đăng ký
          'Mahuyen_DangSS', // Cột T - Mã huyện đăng ký
          'TenxaDangSS', // Cột U - Tên xã đăng ký
          'Maxa_DangSS', // Cột V - Mã xã đăng ký
          'Diachi_DangSS', // Cột W - Địa chỉ đăng ký
          'Sothang', // Cột X - Số tháng đóng
          'Ghichu', // Cột Y - Ghi chú (để trống)
          'NgaySinh', // Cột Z - Ngày sinh
          'GioiTinh', // Cột AA - Giới tính
          'TenTinhBenhVien', // Cột AB - Tên tỉnh bệnh viện (để trống)
          'MaTinhBenhVien', // Cột AC - Mã tỉnh nơi khám quyết định
          'TenBenhVien', // Cột AD - Tên bệnh viện (để trống)
          'MaBenhVien', // Cột AE - Mã bệnh viện
          'MavungSS', // Cột AF - Mã vùng (để trống)
          'Tk1_Save', // Cột AG - TK1 Save (để trống)
          'CMND', // Cột AH - CCCD
          'Maho_Giadinh', // Cột AI - Mã hộ gia đình
          'TenDotKeKhai', // Cột AJ - Tên đợt kê khai
          'QuocTich', // Cột AK - Quốc tịch
          '', // Cột AL - Để trống
          '', // Cột AM - Để trống
          'TenTinhKS', // Cột AN - Tên tỉnh khai sinh (để trống)
          'MaTinh_KS', // Cột AO - Mã tỉnh khai sinh
          'TenHuyenKS', // Cột AP - Tên huyện khai sinh (để trống)
          'MaHuyen_KS', // Cột AQ - Mã huyện khai sinh
          'TenXaKS', // Cột AR - Tên xã khai sinh (để trống)
          'MaXa_KS', // Cột AS - Mã xã khai sinh
          'TenTinhNN', // Cột AT - Tên tỉnh nơi khám (để trống)
          'Matinh_NN', // Cột AU - Mã tỉnh nơi khám quyết định
          'TenHuyenNN', // Cột AV - Tên huyện nơi khám (để trống)
          'Mahuyen_NN', // Cột AW - Mã huyện nơi khám quyết định
          'TenXaNN', // Cột AX - Tên xã nơi khám (để trống)
          'Maxa_NN', // Cột AY - Mã xã nơi khám quyết định
          'Diachi_NN', // Cột AZ - Địa chỉ nơi khám quyết định
          '', // Cột BA - Để trống
          '', // Cột BB - Để trống
          '', // Cột BC - Để trống
          '', // Cột BD - Để trống
          '', // Cột BE - Để trống
          '', // Cột BF - Để trống
          '', // Cột BG - Để trống
          '', // Cột BH - Để trống
          'SoCCCD', // Cột BI - Số CCCD
          'SoBienLai', // Cột BJ - Số biên lai
          'NgayBienLai', // Cột BK - Ngày biên lai
          'MaNhanvienThu', // Cột BL - Mã nhân viên thu
        ];
        
        const keKhaiData = allData.map((item: any) => {
          // Sử dụng mã nhân viên từ người dùng
          const maNhanVienThu = item.maNhanVienThu || maNhanVienThuFromUser;
          console.log(`Sử dụng mã nhân viên cho ${item.ho_ten}: ${maNhanVienThu}`);
          
          return [
            item.stt, // Sử dụng STT từ API
            item.ho_ten,
            item.ma_so_bhxh || '', 
            '', // Để trống cột D (MaPhongBan)
            '1', // Cột E giá trị mặc định là 1
            this.getPhuongAnDongText(item.phuong_an_dong || ''),
            '', // Cột G trống
            item.ngay_bien_lai ? new Date(item.ngay_bien_lai).toLocaleDateString('vi-VN', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            }) : '',
            item.so_bien_lai ? (item.QuyenBienLai ? 
              `${item.QuyenBienLai.quyen_so}${item.so_bien_lai.padStart(5, '0')}` : 
              item.so_bien_lai
            ) : '',
            typeof item.nguoi_thu !== 'undefined' ? item.nguoi_thu.toString() : '',
            '2340000', // Cột K - Tiendong - giá trị mặc định không có dấu phẩy
            '0', // Cột L - giá trị mặc định là 0
            '4', // Cột M giá trị mặc định là 4
            item.han_the_moi_tu ? new Date(item.han_the_moi_tu).toLocaleDateString('vi-VN', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            }) : '', // Cột N hiển thị Hạn thẻ mới từ
            '', // Cột O trống
            '', // Cột P trống
            '', // Cột Q trống
            item.ma_tinh_nkq || '', // Cột R - Mã tỉnh
            '', // Cột S - Tên huyện (trống)
            item.ma_huyen_nkq || '', // Cột T - Mã huyện
            '', // Cột U - Tên xã (trống)
            item.ma_xa_nkq || '', // Cột V - Mã xã
            item.dia_chi_nkq || '', // Cột W - Địa chỉ
            item.so_thang_dong?.toString() || '', // Cột X hiển thị số tháng đóng
            // Cột Y - Thêm "nghỉ học" nếu người tham gia có tuổi nhỏ hơn 18
            this.isUnder18(item.ngay_sinh) ? 'Nghỉ học' : (item.is_urgent ? 'Thẻ Gấp' : ''),
            item.ngay_sinh ? new Date(item.ngay_sinh).toLocaleDateString('vi-VN', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            }) : '', // Cột Z hiển thị ngày sinh
            this.getGioiTinhValue(item.gioi_tinh), // Cột AA hiển thị giới tính
            '', // Cột AB trống
            item.ma_tinh_nkq || '', // Cột AC hiển thị mã tỉnh nơi khám quyết định
            '', // Cột AD trống
            item.ma_benh_vien || '', // Cột AE hiển thị mã bệnh viện
            '', // Cột AF trống
            'x', // Cột AG giá trị mặc định là x
            item.cccd || '', // Cột AH hiển thị CCCD
            item.ma_hgd || '', // Cột AI hiển thị mã hộ gia đình
            '', // Cột AJ trống
            item.quoc_tich || 'VN', // Cột AK hiển thị quốc tịch, mặc định là VN
            '', // Cột AL trống
            '', // Cột AM trống
            '', // Cột AN trống
            item.ma_tinh_ks || '', // Cột AO hiển thị mã tỉnh khai sinh
            '', // Cột AP trống
            item.ma_huyen_ks || '', // Cột AQ hiển thị mã huyện khai sinh
            '', // Cột AR trống
            item.ma_xa_ks || '', // Cột AS hiển thị mã xã khai sinh
            '', // Cột AT trống
            item.ma_tinh_nkq || '', // Cột AU hiển thị mã tỉnh nơi khám quyết định
            '', // Cột AV trống
            item.ma_huyen_nkq || '', // Cột AW hiển thị mã huyện nơi khám quyết định
            '', // Cột AX trống
            item.ma_xa_nkq || '', // Cột AY hiển thị mã xã nơi khám quyết định
            item.dia_chi_nkq || '', // Cột AZ hiển thị địa chỉ nơi khám quyết định
            '', // Cột BA trống
            '', // Cột BB trống
            '', // Cột BC trống
            '', // Cột BD trống
            '', // Cột BE trống
            '', // Cột BF trống
            '', // Cột BG trống
            '', // Cột BH trống
            item.cccd || '', // Cột BI hiển thị CCCD
            item.so_bien_lai ? (item.QuyenBienLai ? 
              `${item.QuyenBienLai.quyen_so}${item.so_bien_lai.padStart(5, '0')}` : 
              item.so_bien_lai
            ) : '', // Cột BJ - Số biên lai
            item.ngay_bien_lai ? new Date(item.ngay_bien_lai).toLocaleDateString('vi-VN', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            }) : '', // Cột BK - Ngày biên lai
            maNhanVienThu, // Cột BL - Mã nhân viên thu - sử dụng mã được chỉ định từ ngoài
          ];
        });
        
        // Tạo worksheet từ dữ liệu
        const ws = XLSX.utils.aoa_to_sheet([...emptyRows, keKhaiHeaders, ...keKhaiData]);
        
        // Thiết lập độ rộng cột
        const maxWidth = 120;
        const colWidths = Array(keKhaiHeaders.length).fill({ wch: 15 });
        
        // Cột STT hẹp hơn
        colWidths[0] = { wch: 5 };
        
        // Cột họ tên rộng hơn
        colWidths[1] = { wch: 30 };
        
        // Cột địa chỉ rộng hơn
        colWidths[22] = { wch: 40 };
        colWidths[38] = { wch: 40 };
        
        ws['!cols'] = colWidths;
        
        // Thêm worksheet vào workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Dữ Liệu');
        
        // Tạo tên file với timestamp
        const now = new Date();
        const fileName = `VNPT_BHYT_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}.xlsx`;
        
        // Xuất file Excel
        XLSX.writeFile(wb, fileName);
        
        this.message.success(`Xuất dữ liệu thành công! Đã xuất ${allData.length} bản ghi từ ${results.length} đợt kê khai.`);
        return true;
      }),
      catchError(error => {
        console.error('Lỗi khi xuất dữ liệu VNPT:', error);
        this.message.error('Có lỗi xảy ra khi xuất dữ liệu. Vui lòng thử lại sau.');
        return of(false);
      })
    );
  }
}
````

## File: WebApp.Client/src/app/services/hoa-don-thanh-toan.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';

export interface HoaDonThanhToan {
  id?: number;
  dot_ke_khai_id: number;
  ngay_thanh_toan?: Date;
  so_tien: number;
  noi_dung_thanh_toan: string;
  url_bill: string;
  public_id: string;
  trang_thai: string;
  nguoi_tao: string;
  ngay_tao?: Date;
  ghi_chu?: string;
}

@Injectable({
  providedIn: 'root'
})
export class HoaDonThanhToanService {
  private apiUrl = `${environment.apiUrl}/HoaDonThanhToan`;

  constructor(private http: HttpClient) { }

  create(hoaDon: HoaDonThanhToan): Observable<HoaDonThanhToan> {
    return this.http.post<HoaDonThanhToan>(this.apiUrl, hoaDon);
  }
}
````

## File: WebApp.Client/src/app/services/ip.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable, of } from 'rxjs';
import { catchError } from 'rxjs/operators';
import { environment } from '../../environments/environment';

@Injectable({
  providedIn: 'root'
})
export class IpService {
  constructor(private http: HttpClient) {}

  getIpAddress(): Observable<string> {
    // Sửa lại đường dẫn API, bỏ /api dư thừa
    return this.http.get<string>(`${environment.apiUrl}/ip`).pipe(
      catchError(() => of('unknown')) // Trả về 'unknown' nếu có lỗi
    );
  }
}
````

## File: WebApp.Client/src/app/services/ke-khai-bhxh.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Observable, throwError } from 'rxjs';
import { environment } from '../../environments/environment';
import { SSMV2Service } from './ssmv2.service';
import { map, catchError } from 'rxjs/operators';

@Injectable({
  providedIn: 'root'
})
export class KeKhaiBHXHService {
  private apiUrl = `${environment.apiUrl}/dot-ke-khai`;
  private baseUrl = 'https://ssmv2.vnpost.vn/connect/tracuu';

  constructor(
    private http: HttpClient,
    private ssmv2Service: SSMV2Service
  ) { }

  create(keKhaiBHXH: any): Observable<any> {
    console.log('Gọi API tạo kê khai BHXH:', this.apiUrl);
    console.log('Dữ liệu gửi đi:', keKhaiBHXH);
    return this.http.post<any>(`${this.apiUrl}/ke-khai-bhxh`, keKhaiBHXH);
  }

  update(id: number, keKhaiBHXH: any): Observable<any> {
    return this.http.put<any>(`${this.apiUrl}/${id}`, keKhaiBHXH);
  }

  getById(id: number): Observable<any> {
    return this.http.get<any>(`${this.apiUrl}/${id}`);
  }

  getByDotKeKhaiId(dotKeKhaiId: number): Observable<any[]> {
    return this.http.get<any[]>(`${this.apiUrl}/${dotKeKhaiId}/ke-khai-bhxh`);
  }

  delete(dotKeKhaiId: number, id: number): Observable<any> {
    return this.http.delete<any>(`${this.apiUrl}/${dotKeKhaiId}/ke-khai-bhxh/${id}`);
  }

  searchBHXH(maSoBHXH: string): Observable<any> {
    // Kiểm tra token từ SSMV2Service
    const token = this.ssmv2Service.getToken();
    console.log('Current SSMV2 token:', token);

    if (!token) {
      console.log('Không tìm thấy token SSMV2 khi tìm kiếm BHXH');
      return throwError(() => ({
        error: 'Lỗi xác thực',
        error_description: 'Không tìm thấy thông tin phiên đăng nhập trong token.',
        type: 'default'
      }));
    }

    // Đảm bảo token có prefix Bearer
    const bearerToken = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
    console.log('Bearer token SSMV2 được tạo:', bearerToken.substring(0, 50) + '...');

    // Tạo XMLHttpRequest thay vì dùng HttpClient
    return new Observable(observer => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', `${this.baseUrl}/thongtinbhxhtnforkekhai`, true);
      
      // Set only safe headers
      xhr.setRequestHeader('Accept', 'application/json, text/plain, */*');
      xhr.setRequestHeader('Accept-Language', 'vi-VN,vi;q=0.9,fr;q=0.7,en-US;q=0.6,en;q=0.5');
      xhr.setRequestHeader('Authorization', bearerToken);
      xhr.setRequestHeader('Cache-Control', 'no-cache');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('Pragma', 'no-cache');

      xhr.withCredentials = true;

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const response = JSON.parse(xhr.responseText);
            console.log('Response success:', response);
            observer.next(response);
            observer.complete();
          } catch (error) {
            observer.error({
              error: 'Lỗi xử lý dữ liệu',
              error_description: 'Không thể xử lý dữ liệu phản hồi từ server.',
              type: 'default'
            });
          }
        } else {
          console.error('API Error details:', {
            status: xhr.status,
            statusText: xhr.statusText,
            response: xhr.responseText,
            token: bearerToken.substring(0, 50) + '...'
          });

          if (xhr.status === 406) {
            observer.error({
              error: 'Lỗi định dạng request',
              error_description: 'Không thể xử lý yêu cầu, vui lòng thử lại.',
              type: 'default'
            });
          } else if (xhr.status === 401 || xhr.status === 403) {
            this.ssmv2Service.clearToken();
            observer.error({
              error: 'Lỗi xác thực',
              error_description: 'Phiên làm việc đã hết hạn, vui lòng đăng nhập lại.',
              type: 'default'
            });
          } else {
            observer.error({
              error: 'Lỗi không xác định',
              error_description: 'Có lỗi xảy ra, vui lòng thử lại.',
              type: 'default'
            });
          }
        }
      };

      xhr.onerror = () => {
        observer.error({
          error: 'Lỗi kết nối',
          error_description: 'Không thể kết nối đến server.',
          type: 'default'
        });
      };

      const requestBody = {
        maSoBHXH: maSoBHXH
      };

      console.log('Request URL:', `${this.baseUrl}/thongtinbhxhtnforkekhai`);
      console.log('Request Headers:', {
        'Accept': 'application/json, text/plain, */*',
        'Accept-Language': 'vi-VN,vi;q=0.9,fr;q=0.7,en-US;q=0.6,en;q=0.5',
        'Authorization': bearerToken,
        'Cache-Control': 'no-cache',
        'Content-Type': 'application/json',
        'Pragma': 'no-cache'
      });
      console.log('Request Body:', requestBody);

      xhr.send(JSON.stringify(requestBody));
    });
  }
}
````

## File: WebApp.Client/src/app/services/ke-khai-bhyt.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';
import { map } from 'rxjs/operators';
import { SSMV2Service } from './ssmv2.service';

export interface NoiNhanHoSo {
  tinh: string;
  huyen: string;
  xa: string;
  diaChi: string;
}

export interface ThongTinThe {
  id?: number;
  ma_so_bhxh: string;
  cccd: string;
  ho_ten: string;
  ngay_sinh: Date;
  gioi_tinh: 'Nam' | 'Nữ';
  so_dien_thoai: string;
  ma_hgd?: string;
  ma_tinh_ks?: string;
  ma_huyen_ks?: string;
  ma_xa_ks?: string;
  ma_tinh_nkq?: string;
  ma_huyen_nkq?: string;
  ma_xa_nkq?: string;
  dia_chi_nkq?: string;
  benh_vien_kcb?: string;
  ma_benh_vien?: string;
  so_the_bhyt?: string;
  ma_dan_toc?: string;
  quoc_tich: string;
  nguoi_tao: string;
  ngay_tao?: Date;
  noiNhanHoSo?: NoiNhanHoSo;
  ngaySinhFormatted?: string;
  ngaySinh?: Date;
}

export interface DotKeKhai {
  id?: number;
  ten_dot: string;
  so_dot: number;
  thang: number;
  nam: number;
  dich_vu: string;
  ghi_chu: string;
  trang_thai: string;
  nguoi_tao: string;
  ngay_tao?: Date;
}

export interface KeKhaiBHYT {
  id?: number;
  dot_ke_khai_id: number;
  thong_tin_the_id: number;
  dotKeKhai?: DotKeKhai;
  thongTinThe: ThongTinThe;
  nguoi_thu: number;
  so_thang_dong: number;
  phuong_an_dong: string;
  han_the_cu?: Date | null;
  han_the_moi_tu: Date;
  han_the_moi_den: Date;
  tinh_nkq: string;
  huyen_nkq: string;
  xa_nkq: string;
  dia_chi_nkq: string;
  benh_vien_kcb: string;
  ma_benh_vien: string;
  nguoi_tao: string;
  ngay_tao: Date;
  ngay_bien_lai?: Date | null;
  so_tien_can_dong: number;
  is_urgent: boolean;
  so_bien_lai?: string;
  quyen_bien_lai_id?: number;
  ma_ho_so?: string;
  trang_thai?: string;
}

export interface ThongTinBHYTResponse {
  data: {
    maSoBHXH: string;
    hoTen: string;
    soDienThoai: string;
    ccns: string;
    ngaySinh: string;
    gioiTinh: number;
    quocTich: string;
    danToc: string;
    cmnd: string;
    maTinhKS: string;
    maHuyenKS: string;
    maXaKS: string;
    maTinhNkq: string;
    maHuyenNkq: string;
    maXaNkq: string;
    tinhKCB: string;
    noiNhanHoSo: string;
    maBenhVien: string;
    maHoGiaDinh: string;
    soTheBHYT: string;
    tuNgayTheCu: string;
    denNgayTheCu: string;
    ngayBienLai?: string;
    typeId: string | null;
    phuongAn: string;
    mucLuongNsTw: number;
    tyLeNsdp: number;
    tienNsdp: number;
    tyLeNsKhac: number;
    tienNsKhac: number;
    tyLeNsnn: number;
    tyLeNsTw: number;
    trangThai: string;
    maLoi: string;
    moTa: string;
    giaHanThe: number;
    isThamGiaBb: number;
  };
  success: boolean;
  message: string | null;
  errors: any | null;
  status: number;
  traceId: string;
}

export interface DanhMucCSKCB {
  id: number;
  value: string;  // Mã bệnh viện
  text: string;
  ten: string;    // Tên bệnh viện
  ma: string | null;
  created_at: Date;
  ma_tinh_kcb: string;
}

export interface BHYTSearchResponse {
  success: boolean;
  message?: string;
  data?: {
    maSoBHXH: string;
    hoTen: string;
    soDienThoai: string;
    ccns: string;
    ngaySinh: string;
    gioiTinh: number;
    quocTich: string;
    danToc: string;
    cmnd: string;
    maTinhKS: string;
    maHuyenKS: string;
    maXaKS: string;
    maTinhNkq: string;
    maHuyenNkq: string;
    maXaNkq: string;
    noiNhanHoSo: string | NoiNhanHoSo;
    maHoGiaDinh: string;
    maBenhVien: string;
    soTheBHYT: string;
    tuNgayTheCu: string;
    denNgayTheCu: string;
    ngayBienLai?: string;
    isThamGiaBb: number;
  };
}

interface BienLai {
  id: number;
  quyen_so: string;
  so_bien_lai: string; 
  ten_nguoi_dong: string;
  so_tien: number;
  ghi_chu?: string;
  trang_thai: string;
  ngay_tao: Date;
}

@Injectable({
  providedIn: 'root'
})
export class KeKhaiBHYTService {
  private apiUrl = `${environment.apiUrl}/dot-ke-khai`;
  private thongTinTheUrl = `${environment.apiUrl}/thong-tin-the`;
  private danhMucCSKCBUrl = `${environment.apiUrl}/danh-muc-cskcb`;
  private currentUser: any = {};
  private apiToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiODg0MDAwX3hhX3RsaV9waHVvY2x0IiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjoidXNlciIsInN1YiI6IjEwMDkxNyIsInNpZCI6Im5NemstdmRPa2xhcE1oeE9PQ1JrR3NjZGZGME5wTkU2NUVNTU9XcFpXcmsiLCJuYW1lIjoiTMOqIFRo4buLIFBoxrDhu5tjIiwibmlja25hbWUiOiI4ODQwMDBfeGFfdGxpX3BodW9jbHQiLCJjbGllbnRfaWQiOiJaalJpWW1JNVpUZ3RaRGN5T0MwME9EUmtMVGt5T1RZdE1ETmpZbVV6TTJVNFlqYzUiLCJtYW5nTHVvaSI6Ijc2MjU1IiwiZG9uVmlDb25nVGFjIjoixJBp4buDbSB0aHUgeMOjIFTDom4gTOG7o2kiLCJjaHVjRGFuaCI6IkPhu5luZyB0w6FjIHZpw6puIHRodSIsImVtYWlsIjoibmd1eWVudGFuZHVuZzI3MTE4OUBnbWFpbC5jb20iLCJzb0RpZW5UaG9haSI6IiIsImlzU3VwZXJBZG1pbiI6IkZhbHNlIiwiaXNDYXMiOiJGYWxzZSIsIm5iZiI6MTczNzkzODE0NywiZXhwIjoxNzM3OTU2MTQ3LCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjUwMDAiLCJhdWQiOiJodHRwOi8vbG9jYWxob3N0OjQyMDAifQ.bmD-4c3M8BUCQ_ovcJdnwDBCNMGaZ6qcu_A_Z4P39Oc';
  private baseUrl = 'https://ssmv2.vnpost.vn/connect/tracuu';

  constructor(
    private http: HttpClient,
    private ssmv2Service: SSMV2Service
  ) {
    // Lấy thông tin user từ localStorage khi service được khởi tạo
    const userStr = localStorage.getItem('user');
    if (userStr) {
      this.currentUser = JSON.parse(userStr);
      console.log('currentUser trong service:', this.currentUser);
    }
  }

  getByDotKeKhai(dotKeKhaiId: number): Observable<KeKhaiBHYT[]> {
    return this.http.get<KeKhaiBHYT[]>(`${this.apiUrl}/${dotKeKhaiId}/ke-khai-bhyt`).pipe(
      map(data => {
        return data.map(item => ({
          ...item,
          thongTinThe: {
            ...item.thongTinThe,
            ngay_sinh: new Date(item.thongTinThe.ngay_sinh),
            ngay_tao: item.thongTinThe.ngay_tao ? new Date(item.thongTinThe.ngay_tao) : undefined
          },
          dotKeKhai: item.dotKeKhai ? {
            ...item.dotKeKhai,
            ngay_tao: item.dotKeKhai.ngay_tao ? new Date(item.dotKeKhai.ngay_tao) : undefined
          } : undefined,
          han_the_cu: item.han_the_cu ? new Date(item.han_the_cu) : null,
          han_the_moi_tu: new Date(item.han_the_moi_tu),
          han_the_moi_den: new Date(item.han_the_moi_den),
          ngay_tao: item.ngay_tao ? new Date(item.ngay_tao) : undefined
        })) as KeKhaiBHYT[];
      })
    );
  }

  getById(dotKeKhaiId: number, id: number): Observable<KeKhaiBHYT> {
    return this.http.get<KeKhaiBHYT>(`${this.apiUrl}/${dotKeKhaiId}/ke-khai-bhyt/${id}`);
  }

  private formatDate(date: Date): string {
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  private formatDateISO(date: Date | string | null): string {
    if (!date) return '';
    
    let dateObj: Date;
    
    // Kiểm tra nếu date là chuỗi
    if (typeof date === 'string') {
      // Xử lý chuỗi ngày tháng theo định dạng dd/MM/yyyy
      if (date.includes('/')) {
        const parts = date.split('/');
        if (parts.length === 3) {
          dateObj = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        } else {
          dateObj = new Date(date);
        }
      } else {
        // Thử parse trực tiếp
        dateObj = new Date(date);
      }
    } else if (date instanceof Date) {
      dateObj = date;
    } else {
      console.error('Kiểu dữ liệu không hợp lệ cho ngày tháng:', date);
      return '';
    }
    
    // Kiểm tra tính hợp lệ của đối tượng Date
    if (isNaN(dateObj.getTime())) {
      console.error('Ngày tháng không hợp lệ:', date);
      return '';
    }
    
    return dateObj.toISOString().split('T')[0];
  }

  create(dotKeKhaiId: number, data: KeKhaiBHYT): Observable<KeKhaiBHYT> {
    // Tạo bản sao của dữ liệu để tránh thay đổi dữ liệu gốc
    console.log('Dữ liệu gốc trước khi format:', JSON.stringify(data));
    console.log('currentUser:', JSON.stringify(this.currentUser));
    
    // Xử lý trường hợp userName không tồn tại
    const userName = this.currentUser.userName || this.currentUser.name || 'unknown_user';
    console.log('userName được sử dụng:', userName);
    
    const formattedData = {
      ...data,
      nguoi_tao: data.nguoi_tao || userName,
      thongTinThe: {
        ...data.thongTinThe,
        nguoi_tao: data.thongTinThe.nguoi_tao || userName,
        ngay_sinh: this.formatDateISO(data.thongTinThe.ngay_sinh)
      },
      han_the_cu: data.han_the_cu ? this.formatDateISO(data.han_the_cu) : null,
      han_the_moi_tu: this.formatDateISO(data.han_the_moi_tu),
      han_the_moi_den: this.formatDateISO(data.han_the_moi_den),
      ngay_tao: this.formatDateISO(data.ngay_tao),
      ngay_bien_lai: data.ngay_bien_lai ? this.formatDateISO(data.ngay_bien_lai) : null
    };
    
    console.log('Dữ liệu đã format trước khi gửi:', JSON.stringify(formattedData));
    
    return this.http.post<KeKhaiBHYT>(`${this.apiUrl}/${dotKeKhaiId}/ke-khai-bhyt`, formattedData);
  }

  update(dotKeKhaiId: number, id: number, data: KeKhaiBHYT): Observable<KeKhaiBHYT> {
    // Xử lý trường hợp userName không tồn tại
    const userName = this.currentUser.userName || this.currentUser.name || 'unknown_user';
    
    const formattedData = {
      ...data,
      nguoi_tao: data.nguoi_tao || userName,
      thongTinThe: {
        ...data.thongTinThe,
        nguoi_tao: data.thongTinThe.nguoi_tao || userName,
        ngay_sinh: this.formatDateISO(data.thongTinThe.ngay_sinh)
      },
      han_the_cu: data.han_the_cu ? this.formatDateISO(data.han_the_cu) : null,
      han_the_moi_tu: this.formatDateISO(data.han_the_moi_tu),
      han_the_moi_den: this.formatDateISO(data.han_the_moi_den),
      ngay_tao: this.formatDateISO(data.ngay_tao),
      ngay_bien_lai: data.ngay_bien_lai ? this.formatDateISO(data.ngay_bien_lai) : null
    };
    return this.http.put<KeKhaiBHYT>(`${this.apiUrl}/${dotKeKhaiId}/ke-khai-bhyt/${id}`, formattedData);
  }

  delete(dotKeKhaiId: number, id: number): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${dotKeKhaiId}/ke-khai-bhyt/${id}`);
  }

  deleteMultiple(dotKeKhaiId: number, ids: number[]): Observable<void> {
    return this.http.post<void>(`${this.apiUrl}/${dotKeKhaiId}/ke-khai-bhyt/delete-multiple`, { ids });
  }

  // Thêm các phương thức cho ThongTinThe
  getAllThongTinThe(): Observable<ThongTinThe[]> {
    return this.http.get<ThongTinThe[]>(this.thongTinTheUrl);
  }

  getThongTinTheById(id: number): Observable<ThongTinThe> {
    return this.http.get<ThongTinThe>(`${this.thongTinTheUrl}/${id}`);
  }

  getThongTinTheByCCCD(cccd: string): Observable<ThongTinThe> {
    return this.http.get<ThongTinThe>(`${this.thongTinTheUrl}/cccd/${cccd}`);
  }

  getThongTinTheByMaSoBHXH(maSoBHXH: string): Observable<ThongTinThe> {
    return this.http.get<ThongTinThe>(`${this.thongTinTheUrl}/ma-so-bhxh/${maSoBHXH}`);
  }

  createThongTinThe(data: ThongTinThe): Observable<ThongTinThe> {
    // Xử lý trường hợp userName không tồn tại
    const userName = this.currentUser.userName || this.currentUser.name || 'unknown_user';
    
    const formattedData = {
      ...data,
      nguoi_tao: data.nguoi_tao || userName
    };
    return this.http.post<ThongTinThe>(this.thongTinTheUrl, formattedData);
  }

  updateThongTinThe(id: number, data: ThongTinThe): Observable<ThongTinThe> {
    // Xử lý trường hợp userName không tồn tại
    const userName = this.currentUser.userName || this.currentUser.name || 'unknown_user';
    
    const formattedData = {
      ...data,
      nguoi_tao: data.nguoi_tao || userName
    };
    return this.http.put<ThongTinThe>(`${this.thongTinTheUrl}/${id}`, formattedData);
  }

  // Thêm method để lấy thông tin đợt kê khai
  getDotKeKhai(id: number): Observable<DotKeKhai> {
    return this.http.get<DotKeKhai>(`${this.apiUrl}/${id}`);
  }

  traCuuThongTinBHYT(maSoBHXH: string): Observable<any> {
    const token = this.ssmv2Service.getToken();
    if (!token) {
      throw new Error('Chưa có token SSMV2');
    }

    const headers = new HttpHeaders({
      'Accept': 'application/json',
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`,
      'Origin': 'https://ssmv2.vnpost.vn',
      'Referer': 'https://ssmv2.vnpost.vn/',
      'Host': 'ssmv2.vnpost.vn'
    });

    // Tạo body request theo yêu cầu API
    const body = {
      maSoBHXH: maSoBHXH,
      mangLuoiId: 76255,
      ma: 'BI0110G',
      maCoQuanBHXH: '08907'
    };

    // Sửa lại URL và method thành POST
    return this.http.post(
      'https://ssmv2.vnpost.vn/connect/tracuu/thongtinbhytforkekhai', 
      body,
      { headers }
    );
  }

  // Thêm method để lấy danh sách bệnh viện
  getDanhMucCSKCB(): Observable<DanhMucCSKCB[]> {
    return this.http.get<DanhMucCSKCB[]>(this.danhMucCSKCBUrl);
  }

  toggleUrgent(dotKeKhaiId: number, id: number): Observable<{success: boolean; is_urgent: boolean}> {
    return this.http.patch<{success: boolean; is_urgent: boolean}>(
      `${this.apiUrl}/${dotKeKhaiId}/ke-khai-bhyt/${id}/toggle-urgent`, 
      {}
    );
  }
}

@Injectable({
  providedIn: 'root'
})
export class BienLaiService {
  constructor(private http: HttpClient) {}

  // Tạo biên lai mới
  createBienLai(data: Partial<BienLai>): Observable<BienLai> {
    return this.http.post<BienLai>('/api/bien-lai', data);
  }

  // Lấy thông tin biên lai
  getBienLai(id: number): Observable<BienLai> {
    return this.http.get<BienLai>(`/api/bien-lai/${id}`);
  }
}
````

## File: WebApp.Client/src/app/services/lich-su-ke-khai.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';
import { map } from 'rxjs/operators';

export interface LichSuKeKhaiSearchParams {
  maSoBHXH?: string;
  cccd?: string;
  hoTen?: string;
  tuNgay?: Date | null;
  denNgay?: Date | null;
}

export interface DotKeKhai {
  so_dot: number;
  thang: number;
  nam: number;
  trang_thai: string;
  ngay_tao?: Date;
}

export interface ThongTinThe {
  ma_so_bhxh: string;
  ho_ten: string;
  cccd: string;
  ngay_sinh: Date;
  gioi_tinh: string;
  ngay_tao?: Date;
}

export interface KeKhaiBHYT {
  id: number;
  dotKeKhai?: DotKeKhai;
  thongTinThe: ThongTinThe;
  nguoi_thu: number;
  phuong_an_dong: string;
  so_thang_dong: number;
  so_tien_can_dong: number;
  ngay_tao: Date;
  han_the_cu?: Date | null;
  han_the_moi_tu: Date;
  han_the_moi_den: Date;
  ngay_bien_lai?: Date | null;
  dotKeKhaiInfo?: string;
  ma_ho_so?: string;
}

export interface KeKhaiBHXH {
  id: number;
  dotKeKhai?: DotKeKhai;
  thongTinThe: ThongTinThe;
  muc_luong: number;
  phuong_an_dong: string;
  so_thang_dong: number;
  so_tien_can_dong: number;
  ngay_tao: Date;
  dotKeKhaiInfo?: string;
  ma_ho_so?: string;
}

@Injectable({
  providedIn: 'root'
})
export class LichSuKeKhaiService {
  private apiUrl = `${environment.apiUrl}/ke-khai-bhyt`;

  constructor(private http: HttpClient) {}

  private formatParams(params?: LichSuKeKhaiSearchParams): HttpParams {
    let queryParams = new HttpParams();
    
    if (params) {
      Object.keys(params).forEach(key => {
        const value = params[key as keyof LichSuKeKhaiSearchParams];
        if (value !== null && value !== undefined && value !== '') {
          if (key === 'tuNgay' || key === 'denNgay') {
            queryParams = queryParams.append(key, (value as Date).toISOString());
          } else {
            queryParams = queryParams.append(key, value.toString());
          }
        }
      });
    }

    return queryParams;
  }

  private convertDates(item: any): any {
    return {
      ...item,
      thongTinThe: {
        ...item.thongTinThe,
        ngay_sinh: new Date(item.thongTinThe.ngay_sinh),
        ngay_tao: item.thongTinThe.ngay_tao ? new Date(item.thongTinThe.ngay_tao) : undefined
      },
      dotKeKhai: item.dotKeKhai ? {
        ...item.dotKeKhai,
        ngay_tao: item.dotKeKhai.ngay_tao ? new Date(item.dotKeKhai.ngay_tao) : undefined
      } : undefined,
      han_the_cu: item.han_the_cu ? new Date(item.han_the_cu) : null,
      han_the_moi_tu: item.han_the_moi_tu ? new Date(item.han_the_moi_tu) : undefined,
      han_the_moi_den: item.han_the_moi_den ? new Date(item.han_the_moi_den) : undefined,
      ngay_tao: new Date(item.ngay_tao),
      ngay_bien_lai: item.ngay_bien_lai ? new Date(item.ngay_bien_lai) : null
    };
  }

  getAllKeKhaiBHYT(params?: LichSuKeKhaiSearchParams): Observable<KeKhaiBHYT[]> {
    const queryParams = this.formatParams(params);
    return this.http.get<KeKhaiBHYT[]>(`${this.apiUrl}/lich-su`, { params: queryParams }).pipe(
      map(data => data.map(item => this.convertDates(item)))
    );
  }

  getKeKhaiBHYTDetail(id: number): Observable<KeKhaiBHYT> {
    return this.http.get<KeKhaiBHYT>(`${this.apiUrl}/${id}`).pipe(
      map(item => this.convertDates(item))
    );
  }

  getAllKeKhaiBHXH(params?: LichSuKeKhaiSearchParams): Observable<KeKhaiBHXH[]> {
    const queryParams = this.formatParams(params);
    return this.http.get<KeKhaiBHXH[]>(`${this.apiUrl}/lich-su-bhxh`, { params: queryParams }).pipe(
      map(data => data.map(item => this.convertDates(item)))
    );
  }

  exportBHYTToExcel(params?: LichSuKeKhaiSearchParams): Observable<Blob> {
    const queryParams = this.formatParams(params);
    return this.http.get(`${this.apiUrl}/export`, {
      params: queryParams,
      responseType: 'blob'
    });
  }

  exportBHXHToExcel(params?: LichSuKeKhaiSearchParams): Observable<Blob> {
    const queryParams = this.formatParams(params);
    return this.http.get(`${this.apiUrl}/lich-su-bhxh/export`, {
      params: queryParams,
      responseType: 'blob'
    });
  }
}
````

## File: WebApp.Client/src/app/services/location.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';

export interface Province {
  id: number;
  ma: string;
  ten: string;
  text: string;
}

export interface District {
  id: number;
  ma: string;
  ten: string;
  ma_tinh: string;
}

export interface Commune {
  id: number;
  ma: string;
  ten: string;
  text: string;
  ma_huyen: string;
}

export interface ApiResponse<T> {
  data: T;
  success: boolean;
  message: string | null;
  errors: any | null;
  status: number;
  traceId: string;
}

@Injectable({
  providedIn: 'root'
})
export class LocationService {
  private apiUrl = `${environment.apiUrl}/locations`;

  constructor(private http: HttpClient) { }

  getProvinces(): Observable<Province[]> {
    return this.http.get<Province[]>(`${this.apiUrl}/provinces`);
  }

  getDistricts(provinceCode: string): Observable<District[]> {
    return this.http.get<District[]>(`${this.apiUrl}/districts/${provinceCode}`);
  }

  getCommunes(districtCode: string): Observable<ApiResponse<Commune[]>> {
    return this.http.get<ApiResponse<Commune[]>>(`${this.apiUrl}/communes/${districtCode}`);
  }
}
````

## File: WebApp.Client/src/app/services/quyen-bien-lai.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';

export interface QuyenBienLai {
  id?: number;
  quyen_so: string;
  tu_so: string;
  den_so: string;
  so_hien_tai?: string;
  nhan_vien_thu: number;
  nguoi_cap: string;
  ngay_cap?: Date;
  trang_thai: string;
  NguoiThu?: any;
}

@Injectable({
  providedIn: 'root'
})
export class QuyenBienLaiService {
  private apiUrl = `${environment.apiUrl}/quyen-bien-lai`;

  constructor(private http: HttpClient) { }

  getQuyenBienLais(): Observable<QuyenBienLai[]> {
    return this.http.get<QuyenBienLai[]>(this.apiUrl);
  }

  createQuyenBienLai(quyenBienLai: Partial<QuyenBienLai>): Observable<QuyenBienLai> {
    return this.http.post<QuyenBienLai>(this.apiUrl, quyenBienLai);
  }

  updateQuyenBienLai(id: number, quyenBienLai: Partial<QuyenBienLai>): Observable<QuyenBienLai> {
    return this.http.put<QuyenBienLai>(`${this.apiUrl}/${id}`, quyenBienLai);
  }

  deleteQuyenBienLai(id: number): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`);
  }

  getNextSoBienLai(nguoiThuId: number): Observable<any> {
    return this.http.get<any>(`${this.apiUrl}/next-so-bien-lai/${nguoiThuId}`);
  }

  capNhatSoBienLai(quyenBienLaiId: number, soBienLai: string): Observable<QuyenBienLai> {
    return this.http.patch<QuyenBienLai>(`${this.apiUrl}/${quyenBienLaiId}/cap-nhat-so-bien-lai`, {
      so_hien_tai: soBienLai
    });
  }

  kiemTraSoBienLaiHopLe(quyenBienLaiId: number, soBienLai: string): Observable<any> {
    return this.http.post<any>(`${this.apiUrl}/kiem-tra-so-bien-lai`, {
      quyen_bien_lai_id: quyenBienLaiId,
      so_bien_lai: soBienLai
    });
  }
}
````

## File: WebApp.Client/src/app/services/ssmv2.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Observable, throwError, BehaviorSubject } from 'rxjs';
import { catchError, tap, switchMap } from 'rxjs/operators';

// Thêm interface cho response
interface AuthResponse {
  access_token: string;
  expires_in: number;
  as_client_id: string;
  userName: string;
  name: string;
  mangLuoi: string;
  donViCongTac: string;
  chucDanh: string;
  email: string;
  soDienThoai: string | null;
  isSuperAdmin: boolean;
  cap: string | null;
  typeMangLuoi: number;
  userId: number;
  status: number;
  expires_at: number;
  roles: string[];
}

@Injectable({
  providedIn: 'root'
})
export class SSMV2Service {
  private baseUrl = 'https://ssmv2.vnpost.vn';
  private tokenKey = 'ssmv2_token';
  private tokenExpireKey = 'ssmv2_token_expire';
  private refreshingToken = false;
  private tokenSubject = new BehaviorSubject<string | null>(null);

  constructor(private http: HttpClient) {
    // Khôi phục token từ localStorage khi khởi tạo service
    const token = localStorage.getItem(this.tokenKey);
    if (token) {
      this.tokenSubject.next(token);
    }
  }

  getCaptcha(): Observable<any> {
    const headers = new HttpHeaders({
      'Accept': '*/*',
      'Accept-Language': 'en-US,en;q=0.9,vi;q=0.8',
      'Content-Type': 'application/json',
      'Origin': 'https://ssmv2.vnpost.vn',
      'Referer': 'https://ssmv2.vnpost.vn/',
      'Host': 'ssmv2.vnpost.vn'
    });

    return this.http.get(`${this.baseUrl}/oauth2/Captcha`, { headers })
      .pipe(
        catchError(error => {
          console.error('Lỗi khi lấy captcha:', error);
          return throwError(() => new Error('Không thể kết nối đến máy chủ. Vui lòng thử lại sau.'));
        }),
        tap(response => {
          console.log('Captcha response raw:', response);
        })
      );
  }

  authenticate(data: {
    grant_type: string;
    userName: string;
    password: string;
    text: string;
    code: string;
    clientId: string;
    isWeb: boolean;
  }): Observable<any> {
    // Chuyển đổi data thành x-www-form-urlencoded format
    const body = new URLSearchParams();
    for (const key in data) {
      body.set(key, data[key as keyof typeof data].toString());
    }

    const headers = new HttpHeaders({
      'Accept': '*/*', 
      'Content-Type': 'application/x-www-form-urlencoded',
      'Origin': 'https://ssmv2.vnpost.vn',
      'Referer': 'https://ssmv2.vnpost.vn/',
      'Host': 'ssmv2.vnpost.vn'
    });

    return this.http.post<AuthResponse>(`${this.baseUrl}/oauth2/Authenticate`, body.toString(), {
      headers,
      observe: 'response'
    }).pipe(
      tap(response => {
        if (response.body) {
          // Lưu token với thời gian hết hạn ngắn hơn một chút để đảm bảo an toàn
          const safeExpiresIn = Math.max(0, (response.body.expires_in || 0) - 60); // Trừ đi 60 giây
          this.saveToken(response.body.access_token, safeExpiresIn);
          
          // Lưu thông tin user nếu có
          if (response.body.userName) {
            const userInfo = {
              userName: response.body.userName,
              name: response.body.name,
              mangLuoi: response.body.mangLuoi,
              donViCongTac: response.body.donViCongTac,
              chucDanh: response.body.chucDanh
            };
            localStorage.setItem('ssmv2_user_info', JSON.stringify(userInfo));
          }
        }
      })
    );
  }

  // Lưu token và thời gian hết hạn
  private saveToken(token: string, expiresIn: number): void {
    try {
      // Tính thời gian hết hạn
      const expiresAt = new Date().getTime() + (expiresIn * 1000);
      
      // Lưu token và thời gian hết hạn
      localStorage.setItem(this.tokenKey, token);
      localStorage.setItem(this.tokenExpireKey, expiresAt.toString());
      
      // Lưu thời gian tạo token
      localStorage.setItem('ssmv2_token_created', new Date().getTime().toString());
      
      console.log('Token đã được lưu:', {
        token: token.substring(0, 20) + '...',
        expiresIn: `${expiresIn} giây`,
        expiresAt: new Date(expiresAt).toLocaleString()
      });
      
      this.tokenSubject.next(token);
    } catch (error) {
      console.error('Lỗi khi lưu token:', error);
      this.clearToken();
    }
  }

  // Kiểm tra token có hết hạn không
  isTokenExpired(): boolean {
    try {
      const expireTime = localStorage.getItem(this.tokenExpireKey);
      const createdTime = localStorage.getItem('ssmv2_token_created');
      
      if (!expireTime || !createdTime) {
        console.log('Không tìm thấy thông tin token');
        return true;
      }

      const now = new Date().getTime();
      const expireTimeNum = parseInt(expireTime);
      const createdTimeNum = parseInt(createdTime);
      
      // Kiểm tra xem token đã tồn tại quá lâu chưa (ví dụ: 4 tiếng)
      const maxTokenAge = 4 * 60 * 60 * 1000; // 4 tiếng
      const tokenAge = now - createdTimeNum;
      
      if (tokenAge > maxTokenAge) {
        console.log('Token đã tồn tại quá lâu:', Math.round(tokenAge / (60 * 1000)), 'phút');
        return true;
      }
      
      // Thêm buffer 5 phút để tránh token hết hạn đột ngột
      const bufferTime = 5 * 60 * 1000; // 5 phút
      const isExpired = now >= (expireTimeNum - bufferTime);
      
      if (isExpired) {
        console.log('Token sẽ hết hạn vào:', new Date(expireTimeNum).toLocaleString());
      }
      
      return isExpired;
    } catch (error) {
      console.error('Lỗi khi kiểm tra hạn token:', error);
      return true;
    }
  }

  // Lấy token hiện tại
  getToken(): string | null {
    try {
      const token = localStorage.getItem(this.tokenKey);
      
      if (!token) {
        console.log('Không tìm thấy token trong localStorage');
        return null;
      }
      
      // Kiểm tra thời gian hết hạn
      const expireTime = localStorage.getItem(this.tokenExpireKey);
      if (!expireTime) {
        console.log('Không tìm thấy thời gian hết hạn token');
        return token; // Vẫn trả về token nếu không tìm thấy thời gian hết hạn
      }

      const now = new Date().getTime();
      const expireTimeNum = parseInt(expireTime);
      
      // Chỉ xóa token khi đã thực sự hết hạn (không tính buffer time)
      if (now >= expireTimeNum) {
        console.log('Token đã hết hạn hoàn toàn, xóa token');
        this.clearToken();
        return null;
      }
      
      // Log thông tin token
      const timeLeft = Math.round((expireTimeNum - now) / 1000);
      console.log('Thông tin token:', {
        expiresAt: new Date(expireTimeNum).toLocaleString(),
        timeLeft: `${timeLeft} giây`
      });
      
      return token;
    } catch (error) {
      console.error('Lỗi khi lấy token:', error);
      return null;
    }
  }

  // Xóa token
  clearToken(): void {
    localStorage.removeItem(this.tokenKey);
    localStorage.removeItem(this.tokenExpireKey);
    this.tokenSubject.next(null);
  }

  // Thêm token vào header
  addTokenToHeader(headers: HttpHeaders): HttpHeaders {
    const token = this.getToken();
    if (token) {
      return headers.set('Authorization', `Bearer ${token}`);
    }
    return headers;
  }
}
````

## File: WebApp.Client/src/app/services/tra-cuu-ma-so-bhxh.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable, throwError } from 'rxjs';

export interface TraCuuBHXHRequest {
  maTinh: string;
  maHuyen: string;
  maXa: string;
  hoTen: string;
  isCoDau: boolean;
  ngaySinh: string;
  soCMND: string;
}

export interface TraCuuBHXHResponse {
  success: boolean;
  message?: string;
  data?: any;
  error?: string;
  type?: string;
}

export interface TraCuuVNPostRequest {
  maTinh: string;
  maHuyen: string;
  maXa: string;
  hoTen: string;
  isCoDau?: boolean;
  ngaySinh: string;
  soCMND: string;
}

export interface TraCuuVNPostResponse {
  success: boolean;
  message?: string;
  data?: any;
}

export interface TraCuuMaSoBHXHByInfoRequest {
  maTinh: string;
  maHuyen: string;
  maXa: string;
  hoTen: string;
  isCoDau: boolean;
  ngaySinh: string;
  soCMND: string;
}

export interface TraCuuHoGiaDinhRequest {
  maTinh: string;
  maHuyen: string;
  maXa?: string;
  maHo?: string;
  tenChuHo?: string;
}

export interface TraCuuHoGiaDinhResponse {
  success: boolean;
  message?: string;
  data?: any;
}

export interface TraCuuThongTinBHXHRequest {
  maSoBHXH: string;
}

export interface TraCuuThongTinBHXHResponse {
  success: boolean;
  message?: string;
  data?: any;
  error?: string;
  type?: string;
}

@Injectable({
  providedIn: 'root'
})
export class BHXHService {
  constructor(private http: HttpClient) { }

  traCuuBHXH(request: TraCuuBHXHRequest): Observable<TraCuuBHXHResponse> {
    const token = localStorage.getItem('ssmv2_token');
    if (!token) {
      return throwError(() => ({
        error: 'Lỗi xác thực',
        error_description: 'Không tìm thấy thông tin phiên đăng nhập trong token.',
        type: 'default'
      }));
    }

    // Đảm bảo token có prefix Bearer
    const bearerToken = token.startsWith('Bearer ') ? token : `Bearer ${token}`;

    return new Observable(observer => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://ssmv2.vnpost.vn/connect/tracuu/masobhxh', true);
      
      // Set headers theo request mẫu chính xác
      xhr.setRequestHeader('Host', 'ssmv2.vnpost.vn');
      xhr.setRequestHeader('sec-ch-ua-platform', '"Windows"');
      xhr.setRequestHeader('Authorization', bearerToken);
      xhr.setRequestHeader('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36');
      xhr.setRequestHeader('Accept', 'application/json, text/plain, */*');
      xhr.setRequestHeader('sec-ch-ua', '"Not(A:Brand";v="99", "Google Chrome";v="133", "Chromium";v="133"');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('sec-ch-ua-mobile', '?0');
      xhr.setRequestHeader('Sec-Fetch-Site', 'same-origin');
      xhr.setRequestHeader('Sec-Fetch-Mode', 'cors');
      xhr.setRequestHeader('Sec-Fetch-Dest', 'empty');

      xhr.withCredentials = true;

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const response = JSON.parse(xhr.responseText);
            console.log('Response success:', response);
            observer.next(response);
            observer.complete();
          } catch (error) {
            observer.error({
              error: 'Lỗi xử lý dữ liệu',
              error_description: 'Không thể xử lý dữ liệu phản hồi từ server.',
              type: 'default'
            });
          }
        } else {
          let errorResponse;
          try {
            errorResponse = JSON.parse(xhr.responseText);
            console.error('API Error details:', {
              status: xhr.status,
              statusText: xhr.statusText,
              response: errorResponse
            });
          } catch (e) {
            errorResponse = {
              error: 'Lỗi không xác định',
              type: 'default'
            };
          }

          switch (xhr.status) {
            case 406:
              observer.error({
                error: 'Lỗi định dạng request',
                error_description: 'Không thể xử lý yêu cầu, vui lòng thử lại.',
                type: 'default'
              });
              break;
            case 401:
            case 403:
              observer.error({
                error: 'Lỗi xác thực',
                error_description: 'Phiên làm việc đã hết hạn, vui lòng đăng nhập lại.',
                type: 'default'
              });
              break;
            case 500:
              observer.error({
                error: errorResponse.error || 'Lỗi server',
                error_description: errorResponse.error || 'Có lỗi xảy ra từ phía server.',
                type: errorResponse.type || 'default'
              });
              break;
            default:
              observer.error({
                error: errorResponse.error || 'Lỗi không xác định',
                error_description: errorResponse.error || 'Có lỗi xảy ra, vui lòng thử lại.',
                type: errorResponse.type || 'default'
              });
          }
        }
      };

      xhr.onerror = () => {
        observer.error({
          error: 'Lỗi kết nối',
          error_description: 'Không thể kết nối đến server.',
          type: 'default'
        });
      };

      // Log thông tin request
      console.log('Request URL:', 'https://ssmv2.vnpost.vn/connect/tracuu/masobhxh');
      console.log('Request Headers:', {
        'Host': 'ssmv2.vnpost.vn',
        'sec-ch-ua-platform': '"Windows"',
        'Authorization': `${bearerToken.substring(0, 50)}...`,
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36',
        'Accept': 'application/json, text/plain, */*',
        'sec-ch-ua': '"Not(A:Brand";v="99", "Google Chrome";v="133", "Chromium";v="133"',
        'Content-Type': 'application/json',
        'sec-ch-ua-mobile': '?0',
        'Sec-Fetch-Site': 'same-origin',
        'Sec-Fetch-Mode': 'cors',
        'Sec-Fetch-Dest': 'empty'
      });
      console.log('Request Body:', request);

      xhr.send(JSON.stringify(request));
    });
  }

  traCuuMaSoBHXHVNPost(request: TraCuuVNPostRequest): Observable<TraCuuVNPostResponse> {
    const token = localStorage.getItem('ssmv2_token');
    if (!token) {
      return throwError(() => ({
        error: 'Lỗi xác thực',
        error_description: 'Không tìm thấy thông tin phiên đăng nhập trong token.',
        type: 'default'
      }));
    }

    // Đảm bảo token có prefix Bearer
    const bearerToken = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
    console.log('Bearer token SSMV2 được tạo:', bearerToken.substring(0, 50) + '...');

    // Tạo XMLHttpRequest thay vì dùng HttpClient
    return new Observable(observer => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://ssmv2.vnpost.vn/connect/tracuu/masobhxh', true);
      
      // Set only safe headers
      xhr.setRequestHeader('Accept', 'application/json, text/plain, */*');
      xhr.setRequestHeader('Accept-Language', 'vi-VN,vi;q=0.9,fr;q=0.7,en-US;q=0.6,en;q=0.5');
      xhr.setRequestHeader('Authorization', bearerToken);
      xhr.setRequestHeader('Cache-Control', 'no-cache');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('Pragma', 'no-cache');

      xhr.withCredentials = true;

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const response = JSON.parse(xhr.responseText);
            console.log('Response success:', response);
            observer.next(response);
            observer.complete();
          } catch (error) {
            observer.error({
              error: 'Lỗi xử lý dữ liệu',
              error_description: 'Không thể xử lý dữ liệu phản hồi từ server.',
              type: 'default'
            });
          }
        } else {
          console.error('API Error details:', {
            status: xhr.status,
            statusText: xhr.statusText,
            response: xhr.responseText,
            token: bearerToken.substring(0, 50) + '...'
          });

          if (xhr.status === 406) {
            observer.error({
              error: 'Lỗi định dạng request',
              error_description: 'Không thể xử lý yêu cầu, vui lòng thử lại.',
              type: 'default'
            });
          } else if (xhr.status === 401 || xhr.status === 403) {
            observer.error({
              error: 'Lỗi xác thực',
              error_description: 'Phiên làm việc đã hết hạn, vui lòng đăng nhập lại.',
              type: 'default'
            });
          } else {
            observer.error({
              error: 'Lỗi không xác định',
              error_description: 'Có lỗi xảy ra, vui lòng thử lại.',
              type: 'default'
            });
          }
        }
      };

      xhr.onerror = () => {
        observer.error({
          error: 'Lỗi kết nối',
          error_description: 'Không thể kết nối đến server.',
          type: 'default'
        });
      };

      console.log('Request URL:', 'https://ssmv2.vnpost.vn/connect/tracuu/masobhxh');
      console.log('Request Headers:', {
        'Accept': 'application/json, text/plain, */*',
        'Accept-Language': 'vi-VN,vi;q=0.9,fr;q=0.7,en-US;q=0.6,en;q=0.5',
        'Authorization': bearerToken.substring(0, 50) + '...',
        'Cache-Control': 'no-cache',
        'Content-Type': 'application/json',
        'Pragma': 'no-cache'
      });
      console.log('Request Body:', request);

      xhr.send(JSON.stringify(request));
    });
  }

  traCuuMaSoBHXHVNPostByInfo(request: TraCuuMaSoBHXHByInfoRequest): Observable<TraCuuVNPostResponse> {
    const token = localStorage.getItem('ssmv2_token');
    if (!token) {
      return throwError(() => ({
        error: 'Lỗi xác thực',
        error_description: 'Không tìm thấy thông tin phiên đăng nhập trong token.',
        type: 'default'
      }));
    }

    // Đảm bảo token có prefix Bearer
    const bearerToken = token.startsWith('Bearer ') ? token : `Bearer ${token}`;

    return new Observable(observer => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://ssmv2.vnpost.vn/connect/tracuu/masobhxh', true);
      
      // Set headers theo request mẫu chính xác
      xhr.setRequestHeader('Host', 'ssmv2.vnpost.vn');
      xhr.setRequestHeader('sec-ch-ua-platform', '"Windows"');
      xhr.setRequestHeader('Authorization', bearerToken);
      xhr.setRequestHeader('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36');
      xhr.setRequestHeader('Accept', 'application/json, text/plain, */*');
      xhr.setRequestHeader('sec-ch-ua', '"Not(A:Brand";v="99", "Google Chrome";v="133", "Chromium";v="133"');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('sec-ch-ua-mobile', '?0');
      xhr.setRequestHeader('Sec-Fetch-Site', 'same-origin');
      xhr.setRequestHeader('Sec-Fetch-Mode', 'cors');
      xhr.setRequestHeader('Sec-Fetch-Dest', 'empty');

      xhr.withCredentials = true;

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const response = JSON.parse(xhr.responseText);
            console.log('Response success:', response);
            observer.next(response);
            observer.complete();
          } catch (error) {
            observer.error({
              error: 'Lỗi xử lý dữ liệu',
              error_description: 'Không thể xử lý dữ liệu phản hồi từ server.',
              type: 'default'
            });
          }
        } else {
          console.error('API Error details:', {
            status: xhr.status,
            statusText: xhr.statusText,
            response: xhr.responseText
          });

          if (xhr.status === 406) {
            observer.error({
              error: 'Lỗi định dạng request',
              error_description: 'Không thể xử lý yêu cầu, vui lòng thử lại.',
              type: 'default'
            });
          } else if (xhr.status === 401 || xhr.status === 403) {
            observer.error({
              error: 'Lỗi xác thực',
              error_description: 'Phiên làm việc đã hết hạn, vui lòng đăng nhập lại.',
              type: 'default'
            });
          } else {
            observer.error({
              error: 'Lỗi không xác định',
              error_description: 'Có lỗi xảy ra, vui lòng thử lại.',
              type: 'default'
            });
          }
        }
      };

      xhr.onerror = () => {
        observer.error({
          error: 'Lỗi kết nối',
          error_description: 'Không thể kết nối đến server.',
          type: 'default'
        });
      };

      // Log thông tin request
      console.log('Request URL:', 'https://ssmv2.vnpost.vn/connect/tracuu/masobhxh');
      console.log('Request Headers:', {
        'Host': 'ssmv2.vnpost.vn',
        'sec-ch-ua-platform': '"Windows"',
        'Authorization': `${bearerToken.substring(0, 50)}...`,
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36',
        'Accept': 'application/json, text/plain, */*',
        'sec-ch-ua': '"Not(A:Brand";v="99", "Google Chrome";v="133", "Chromium";v="133"',
        'Content-Type': 'application/json',
        'sec-ch-ua-mobile': '?0',
        'Sec-Fetch-Site': 'same-origin',
        'Sec-Fetch-Mode': 'cors',
        'Sec-Fetch-Dest': 'empty'
      });
      console.log('Request Body:', request);

      xhr.send(JSON.stringify(request));
    });
  }

  traCuuHoGiaDinh(request: TraCuuHoGiaDinhRequest): Observable<TraCuuHoGiaDinhResponse> {
    const token = localStorage.getItem('ssmv2_token');
    if (!token) {
      return throwError(() => ({
        error: 'Lỗi xác thực',
        error_description: 'Không tìm thấy thông tin phiên đăng nhập trong token.',
        type: 'default'
      }));
    }

    // Đảm bảo token có prefix Bearer
    const bearerToken = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
    console.log('Bearer token SSMV2 được tạo:', bearerToken.substring(0, 50) + '...');

    // Tạo XMLHttpRequest thay vì dùng HttpClient
    return new Observable(observer => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://ssmv2.vnpost.vn/connect/tracuu/getthongtinhgd', true);
      
      // Set only safe headers
      xhr.setRequestHeader('Accept', 'application/json, text/plain, */*');
      xhr.setRequestHeader('Accept-Language', 'vi-VN,vi;q=0.9,fr;q=0.7,en-US;q=0.6,en;q=0.5');
      xhr.setRequestHeader('Authorization', bearerToken);
      xhr.setRequestHeader('Cache-Control', 'no-cache');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('Pragma', 'no-cache');

      xhr.withCredentials = true;

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const response = JSON.parse(xhr.responseText);
            console.log('Response success:', response);
            observer.next(response);
            observer.complete();
          } catch (error) {
            observer.error({
              error: 'Lỗi xử lý dữ liệu',
              error_description: 'Không thể xử lý dữ liệu phản hồi từ server.',
              type: 'default'
            });
          }
        } else {
          console.error('API Error details:', {
            status: xhr.status,
            statusText: xhr.statusText,
            response: xhr.responseText,
            token: bearerToken.substring(0, 50) + '...'
          });

          if (xhr.status === 406) {
            observer.error({
              error: 'Lỗi định dạng request',
              error_description: 'Không thể xử lý yêu cầu, vui lòng thử lại.',
              type: 'default'
            });
          } else if (xhr.status === 401 || xhr.status === 403) {
            observer.error({
              error: 'Lỗi xác thực',
              error_description: 'Phiên làm việc đã hết hạn, vui lòng đăng nhập lại.',
              type: 'default'
            });
          } else {
            observer.error({
              error: 'Lỗi không xác định',
              error_description: 'Có lỗi xảy ra, vui lòng thử lại.',
              type: 'default'
            });
          }
        }
      };

      xhr.onerror = () => {
        observer.error({
          error: 'Lỗi kết nối',
          error_description: 'Không thể kết nối đến server.',
          type: 'default'
        });
      };

      // Log thông tin request
      console.log('Request URL:', 'https://ssmv2.vnpost.vn/connect/tracuu/getthongtinhgd');
      console.log('Request Body:', request);

      xhr.send(JSON.stringify(request));
    });
  }

  traCuuThongTinBHXH(request: TraCuuThongTinBHXHRequest): Observable<TraCuuThongTinBHXHResponse> {
    const token = localStorage.getItem('ssmv2_token');
    if (!token) {
      return throwError(() => ({
        error: 'Lỗi xác thực',
        error_description: 'Không tìm thấy thông tin phiên đăng nhập trong token.',
        type: 'default'
      }));
    }

    // Đảm bảo token có prefix Bearer
    const bearerToken = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
    console.log('Bearer token SSMV2 được tạo:', bearerToken.substring(0, 50) + '...');

    // Tạo XMLHttpRequest thay vì dùng HttpClient
    return new Observable(observer => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://ssmv2.vnpost.vn/connect/tracuu/thongtinbhxh', true);
      
      // Set only safe headers
      xhr.setRequestHeader('Accept', 'application/json, text/plain, */*');
      xhr.setRequestHeader('Accept-Language', 'vi-VN,vi;q=0.9,fr;q=0.7,en-US;q=0.6,en;q=0.5');
      xhr.setRequestHeader('Authorization', bearerToken);
      xhr.setRequestHeader('Cache-Control', 'no-cache');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('Pragma', 'no-cache');

      xhr.withCredentials = true;

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const response = JSON.parse(xhr.responseText);
            console.log('Response success:', response);
            observer.next(response);
            observer.complete();
          } catch (error) {
            observer.error({
              error: 'Lỗi xử lý dữ liệu',
              error_description: 'Không thể xử lý dữ liệu phản hồi từ server.',
              type: 'default'
            });
          }
        } else {
          console.error('API Error details:', {
            status: xhr.status,
            statusText: xhr.statusText,
            response: xhr.responseText,
            token: bearerToken.substring(0, 50) + '...'
          });

          if (xhr.status === 406) {
            observer.error({
              error: 'Lỗi định dạng request',
              error_description: 'Không thể xử lý yêu cầu, vui lòng thử lại.',
              type: 'default'
            });
          } else if (xhr.status === 401 || xhr.status === 403) {
            observer.error({
              error: 'Lỗi xác thực',
              error_description: 'Phiên làm việc đã hết hạn, vui lòng đăng nhập lại.',
              type: 'default'
            });
          } else {
            observer.error({
              error: 'Lỗi không xác định',
              error_description: 'Có lỗi xảy ra, vui lòng thử lại.',
              type: 'default'
            });
          }
        }
      };

      xhr.onerror = () => {
        observer.error({
          error: 'Lỗi kết nối',
          error_description: 'Không thể kết nối đến server.',
          type: 'default'
        });
      };

      console.log('Request URL:', 'https://ssmv2.vnpost.vn/connect/tracuu/thongtinbhxh');
      console.log('Request Headers:', {
        'Accept': 'application/json, text/plain, */*',
        'Accept-Language': 'vi-VN,vi;q=0.9,fr;q=0.7,en-US;q=0.6,en;q=0.5',
        'Authorization': bearerToken.substring(0, 50) + '...',
        'Cache-Control': 'no-cache',
        'Content-Type': 'application/json',
        'Pragma': 'no-cache'
      });
      console.log('Request Body:', request);

      xhr.send(JSON.stringify(request));
    });
  }
}
````

## File: WebApp.Client/src/app/services/tra-cuu-thong-tin-bhyt.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable, throwError } from 'rxjs';

export interface TraCuuThongTinBHYTRequest {
  maSoBHXH: string;
}

export interface TraCuuThongTinBHYTResponse {
  success: boolean;
  message?: string;
  data?: any;
  error?: string;
  type?: string;
}

@Injectable({
  providedIn: 'root'
})
export class BHYTService {
  constructor(private http: HttpClient) { }

  traCuuThongTinBHYT(request: TraCuuThongTinBHYTRequest): Observable<TraCuuThongTinBHYTResponse> {
    const token = localStorage.getItem('ssmv2_token');
    if (!token) {
      return throwError(() => ({
        error: 'Lỗi xác thực',
        error_description: 'Không tìm thấy thông tin phiên đăng nhập trong token.',
        type: 'default'
      }));
    }

    const bearerToken = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
    return new Observable(observer => {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', `https://ssmv2.vnpost.vn/connect/tracuu/thongtinthe?maSoBHXH=${request.maSoBHXH}`, true);
      xhr.setRequestHeader('Accept', 'application/json, text/plain, */*');
      xhr.setRequestHeader('Authorization', bearerToken);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.withCredentials = true;

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const response = JSON.parse(xhr.responseText);
            observer.next(response);
            observer.complete();
          } catch (error) {
            observer.error({ error: 'Lỗi xử lý dữ liệu' });
          }
        } else {
          observer.error({ error: 'Lỗi không xác định' });
        }
      };

      xhr.onerror = () => {
        observer.error({ error: 'Lỗi kết nối' });
      };

      xhr.send();
    });
  }
}
````

## File: WebApp.Client/src/app/services/user.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';
import { tap, catchError } from 'rxjs/operators';
import { throwError } from 'rxjs';

export interface NguoiDung {
  id: number;
  user_name: string;
  username?: string;
  userName?: string;
  ho_ten?: string;
  hoTen?: string;
  email?: string;
  so_dien_thoai?: string;
  soDienThoai?: string;
  sdt?: string;
  don_vi_cong_tac?: string;
  donViCongTac?: string;
  chuc_danh?: string;
  chucDanh?: string;
  roles?: string[];
  status?: number;
  trang_thai?: boolean;
  ma_nhan_vien?: string;
  maNhanVien?: string;
  isSuperAdmin?: boolean;
  typeMangLuoi?: number;
  created_at?: Date;
  updated_at?: Date;
  isStatusLoading?: boolean;
}

export interface DaiLy {
  id: number;
  ma: string;
  ten: string;
  diaChi: string;
  soDienThoai?: string;
  email?: string;
  nguoiDaiDien?: string;
  trangThai: boolean;
  ngayTao: string;
  nguoiTao: string;
  loading?: boolean;
}

@Injectable({
  providedIn: 'root'
})
export class UserService {
  private apiUrl = `${environment.apiUrl}/nguoi-dung`;

  constructor(private http: HttpClient) { }

  getIpAddress(): Observable<{ip: string}> {
    return this.http.get<{ip: string}>('https://api.ipify.org/?format=json');
  }

  getUsers(): Observable<NguoiDung[]> {
    return this.http.get<NguoiDung[]>(this.apiUrl);
  }

  getNguoiDungs(): Observable<NguoiDung[]> {
    return this.getUsers();
  }

  getNguoiDung(id: number): Observable<NguoiDung> {
    return this.http.get<NguoiDung>(`${this.apiUrl}/${id}`);
  }

  createNguoiDung(nguoiDung: Partial<NguoiDung>): Observable<NguoiDung> {
    return this.http.post<NguoiDung>(this.apiUrl, nguoiDung);
  }

  updateNguoiDung(id: number, nguoiDung: any): Observable<any> {
    console.log(`Updating user ${id}:`, nguoiDung);
    
    return this.http.put(`${this.apiUrl}/${id}`, nguoiDung).pipe(
      tap(response => console.log('Update response:', response)),
      catchError(error => {
        console.error('Update error:', error);
        return throwError(() => error);
      })
    );
  }

  deleteNguoiDung(id: number): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`);
  }

  toggleStatus(id: number): Observable<NguoiDung> {
    return this.http.patch<NguoiDung>(`${this.apiUrl}/${id}/toggle-status`, {});
  }

  resetPassword(id: number): Observable<any> {
    return this.http.post(`${this.apiUrl}/${id}/reset-password`, {});
  }

  getCurrentUserInfo(): Observable<NguoiDung> {
    const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
    if (!currentUser.id) {
      return throwError(() => new Error('Không tìm thấy thông tin người dùng'));
    }
    
    return this.http.get<NguoiDung>(`${this.apiUrl}/info/${currentUser.id}`).pipe(
      tap(user => {
        console.log('Thông tin người dùng từ API:', user);
      }),
      catchError(error => {
        console.error('Lỗi khi lấy thông tin người dùng:', error);
        return throwError(() => error);
      })
    );
  }

  getDaiLys(): Observable<DaiLy[]> {
    return this.http.get<DaiLy[]>(`${environment.apiUrl}/dai-ly`);
  }

  createDaiLy(daiLy: Partial<DaiLy>): Observable<DaiLy> {
    return this.http.post<DaiLy>(`${environment.apiUrl}/dai-ly`, daiLy);
  }

  updateDaiLy(id: number, daiLy: Partial<DaiLy>): Observable<DaiLy> {
    return this.http.put<DaiLy>(`${environment.apiUrl}/dai-ly/${id}`, daiLy);
  }

  deleteDaiLy(id: number): Observable<void> {
    return this.http.delete<void>(`${environment.apiUrl}/dai-ly/${id}`);
  }
}
````

## File: WebApp.Client/src/app/services/users.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';

export interface User {
  id: number;
  username: string;
  ho_ten: string;
  email: string;
  role: string;
}

@Injectable({
  providedIn: 'root'
})
export class UsersService {
  private apiUrl = environment.apiUrl;

  constructor(private http: HttpClient) { }

  getUsers(): Observable<User[]> {
    return this.http.get<User[]>(`${this.apiUrl}/nguoi-dung`);
  }

  getUserById(id: number): Observable<User> {
    return this.http.get<User>(`${this.apiUrl}/nguoi-dung/${id}`);
  }

  createUser(user: User): Observable<any> {
    return this.http.post(`${this.apiUrl}/nguoi-dung`, user);
  }

  updateUser(id: number, user: User): Observable<any> {
    return this.http.put(`${this.apiUrl}/nguoi-dung/${id}`, user);
  }

  deleteUser(id: number): Observable<any> {
    return this.http.delete(`${this.apiUrl}/nguoi-dung/${id}`);
  }
}
````

## File: WebApp.Client/src/app/services/viet-qr.service.ts
````typescript
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';

export interface VietQRRequest {
  accountNo: string;
  accountName: string;
  acqId: number;
  amount: number;
  addInfo: string;
  format?: string;
  template?: string;
  bankName?: string;
  displayAmount?: boolean;
}

export interface VietQRResponse {
  code: string;
  desc: string;
  data: {
    qrCode: string;
    qrDataURL?: string;
  }
}

export interface PaymentConfirmResponse {
  code: string;
  desc: string;
  data: {
    status: 'success' | 'failed';
    message?: string;
  }
}

@Injectable({
  providedIn: 'root'
})
export class VietQRService {
  private apiUrl = 'https://api.vietqr.io/v2/generate';
  private baseUrl = environment.apiUrl;

  constructor(private http: HttpClient) { }

  generateQR(request: VietQRRequest): Observable<VietQRResponse> {
    const headers = new HttpHeaders({
      'x-client-id': environment.vietQR.clientId,
      'x-api-key': environment.vietQR.apiKey
    });

    const body = {
      ...request,
      format: request.format || 'text',
      template: request.template || 'compact'
    };

    return this.http.post<VietQRResponse>(this.apiUrl, body, { headers });
  }

  confirmPayment(dotKeKhaiId: number, billUrl?: string, publicId?: string): Observable<PaymentConfirmResponse> {
    const body = {
      billUrl,
      publicId
    };
    return this.http.post<PaymentConfirmResponse>(`${this.baseUrl}/api/viet-qr/confirm-payment/${dotKeKhaiId}`, body);
  }
}
````

## File: WebApp.Client/src/app/shared/components/xem-hoa-don-modal/xem-hoa-don-modal.component.html
````html
<nz-modal
  [(nzVisible)]="isVisible"
  [nzTitle]="modalTitle"
  [nzContent]="modalContent"
  [nzFooter]="modalFooter"
  (nzOnCancel)="handleCancel()"
  [nzWidth]="900"
  [nzBodyStyle]="{ padding: '0' }"
  [nzClassName]="'bill-modal'"
  [nzMaskClosable]="!isFullscreen"
  [nzStyle]="{ top: '20px' }"
>
  <ng-template #modalTitle>
    <div class="modal-title">
      <span>Xem hóa đơn</span>
      <span *ngIf="dotKeKhai" class="bill-subtitle">{{ dotKeKhai.ten_dot }}</span>
    </div>
  </ng-template>
  
  <ng-template #modalContent>
    <div class="bill-modal-content" [class.fullscreen-mode]="isFullscreen">
      <!-- Phần xem ảnh -->
      <div class="bill-image-wrapper">
        <!-- Loading spinner -->
        <div *ngIf="isImageLoading" class="loading-container">
          <nz-spin nzTip="Đang tải ảnh..."></nz-spin>
        </div>
        
        <!-- Container ảnh -->
        <div class="bill-image-container">
          <!-- Thanh công cụ -->
          <div class="bill-toolbar">
            <button nz-button nzType="text" nzShape="circle" (click)="zoomIn()" nz-tooltip nzTooltipTitle="Phóng to">
              <span nz-icon nzType="zoom-in" nzTheme="outline"></span>
            </button>
            <button nz-button nzType="text" nzShape="circle" (click)="zoomOut()" nz-tooltip nzTooltipTitle="Thu nhỏ">
              <span nz-icon nzType="zoom-out" nzTheme="outline"></span>
            </button>
            <button nz-button nzType="text" nzShape="circle" (click)="rotateImage()" nz-tooltip nzTooltipTitle="Xoay ảnh">
              <span nz-icon nzType="redo" nzTheme="outline"></span>
            </button>
            <button nz-button nzType="text" nzShape="circle" (click)="resetImage()" nz-tooltip nzTooltipTitle="Khôi phục">
              <span nz-icon nzType="sync" nzTheme="outline"></span>
            </button>
            <button nz-button nzType="text" nzShape="circle" (click)="toggleFullscreen()" nz-tooltip [nzTooltipTitle]="isFullscreen ? 'Thu nhỏ' : 'Toàn màn hình'">
              <span nz-icon [nzType]="isFullscreen ? 'fullscreen-exit' : 'fullscreen'" nzTheme="outline"></span>
            </button>
          </div>
          
          <!-- Thông báo kéo ảnh -->
          <div class="drag-instruction" *ngIf="imageZoom > 1">
            <span nz-icon nzType="drag" nzTheme="outline"></span>
            <span>Kéo để di chuyển ảnh</span>
          </div>
          
          <!-- Ảnh hóa đơn -->
          <img *ngIf="selectedHoaDon"
            [src]="selectedHoaDon" 
            alt="Hóa đơn" 
            class="bill-image" 
            [style.transform]="getImageTransform()"
            (wheel)="handleMouseWheel($event)"
            (mousedown)="startDrag($event)"
            (mousemove)="onDrag($event)"
            (mouseup)="endDrag()"
            (mouseleave)="endDrag()"
            (touchstart)="startTouchDrag($event)"
            (touchmove)="onTouchDrag($event)"
            (touchend)="endTouchDrag()"
            (touchcancel)="endTouchDrag()"
            (dblclick)="imageZoom === 1 ? zoomIn() : resetImage()"
            loading="lazy"
            (load)="isImageLoading = false"
            [class.hidden]="isImageLoading"
          />
          
          <!-- Thông báo khi không có ảnh -->
          <div *ngIf="!selectedHoaDon && !isImageLoading" class="no-bill-message">
            <span nz-icon nzType="file-image" nzTheme="outline" class="empty-icon"></span>
            <span>Không tìm thấy ảnh hóa đơn</span>
          </div>
        </div>
      </div>
      
      <!-- Phần thông tin bên phải -->
      <div class="bill-info">
        <div *ngIf="dotKeKhai" class="bill-info-content">
          <h3>Thông tin hóa đơn</h3>
          <nz-descriptions nzBordered [nzColumn]="1" nzSize="small">
            <nz-descriptions-item nzTitle="Tên đợt kê khai">{{ dotKeKhai.ten_dot }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Mã hồ sơ">{{ dotKeKhai.ma_ho_so || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Loại dịch vụ">{{ dotKeKhai.dich_vu }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Tổng số tiền">{{ dotKeKhai.tong_so_tien | number }} đ</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Trạng thái">
              <nz-tag [nzColor]="getTrangThaiType(dotKeKhai.trang_thai)">
                {{ getTrangThaiText(dotKeKhai.trang_thai) }}
              </nz-tag>
            </nz-descriptions-item>
            <nz-descriptions-item nzTitle="Tên file">{{ getFileName() }}</nz-descriptions-item>
          </nz-descriptions>
          
          <div class="action-buttons">
            <button nz-button nzType="primary" (click)="taiHoaDon()">
              <span nz-icon nzType="download" nzTheme="outline"></span>
              Tải xuống
            </button>
            <button nz-button nzType="default"
              *ngIf="dotKeKhai.trang_thai === 'chua_gui' || dotKeKhai.trang_thai === 'da_tu_choi'"
              (click)="uploadThayThe()">
              <span nz-icon nzType="upload" nzTheme="outline"></span>
              Tải lại hóa đơn
            </button>
          </div>
        </div>
        
        <nz-alert *ngIf="isFullscreen" 
          nzType="info" 
          nzMessage="Nhấn ESC hoặc click nút thu nhỏ để thoát chế độ toàn màn hình" 
          class="fullscreen-note">
        </nz-alert>
      </div>
    </div>
  </ng-template>
  
  <ng-template #modalFooter>
    <div class="modal-footer">
      <button nz-button nzType="default" 
        (click)="xemKeKhaiBHYT()" 
        *ngIf="dotKeKhai?.id">
        <span nz-icon nzType="solution" nzTheme="outline"></span>
        Xem bản kê
      </button>
      <button nz-button nzType="default" (click)="handleCancel()">Đóng</button>
    </div>
  </ng-template>
</nz-modal>
````

## File: WebApp.Client/src/app/shared/components/xem-hoa-don-modal/xem-hoa-don-modal.component.scss
````scss
/* CSS cho body khi ở chế độ toàn màn hình */
:host ::ng-deep {
  .overflow-hidden {
    overflow: hidden !important;
  }
  
  // Đảm bảo modal hiển thị đúng
  .bill-modal {
    .ant-modal {
      width: 85vw !important;
      max-width: 900px !important;
      
      .ant-modal-content {
        overflow: hidden;
        max-height: 85vh;
        border-radius: 8px;
      }
      
      .ant-modal-body {
        max-height: calc(85vh - 110px);
        overflow: auto;
        padding: 0 !important;
      }
      
      .ant-modal-header {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
      }
      
      .ant-modal-title {
        font-size: 16px;
      }
      
      .ant-modal-close {
        top: 12px;
        right: 16px;
      }
      
      .ant-modal-footer {
        padding: 10px 16px;
        border-top: 1px solid #f0f0f0;
      }
    }
  }
}

/* CSS cho modal xem hóa đơn */
.bill-modal-content {
  display: flex;
  flex-direction: row;
  height: 550px;
  max-height: 80vh;
  
  &.fullscreen-mode {
    .bill-image-wrapper {
      background-color: rgba(0, 0, 0, 0.9);
    }
  }
  
  @media (max-width: 767px) {
    flex-direction: column;
    height: auto;
    
    .bill-image-wrapper {
      min-height: 300px;
    }
  }
}

.bill-image-wrapper {
  flex: 1;
  position: relative;
  background-color: #f5f5f5;
  border-right: 1px solid #f0f0f0;
  min-height: 280px;
  max-height: 65vh;
  
  @media (max-width: 767px) {
    border-right: none;
    border-bottom: 1px solid #f0f0f0;
  }
  
  @media (min-width: 768px) {
    max-height: 500px;
    min-width: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
}

.loading-container {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: rgba(255, 255, 255, 0.8);
  z-index: 50;
}

.bill-image-container {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  overflow: hidden;
  padding: 16px;
  transition: background-color 0.3s ease;
}

.bill-toolbar {
  position: absolute;
  top: 10px;
  right: 10px;
  background-color: rgba(255, 255, 255, 0.8);
  border-radius: 4px;
  padding: 4px 8px;
  display: flex;
  gap: 4px;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  transition: opacity 0.3s ease;
  
  button {
    transition: transform 0.2s ease;
    
    &:hover {
      transform: scale(1.1);
    }
  }
}

.drag-instruction {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.6);
  color: white;
  border-radius: 4px;
  padding: 4px 12px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  z-index: 100;
  animation: fadeIn 0.5s ease-in-out;
  
  span[nz-icon] {
    font-size: 16px;
  }
}

.bill-image {
  max-width: 100%;
  max-height: calc(65vh - 32px);
  width: auto;
  height: auto;
  border: 1px solid #e8e8e8;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  transition: transform 0.3s ease;
  transform-origin: center center;
  cursor: move;
  user-select: none;
  -webkit-user-drag: none;
  object-fit: contain;
  
  &.hidden {
    opacity: 0;
  }
}

.bill-info {
  width: 300px;
  padding: 16px;
  flex: 1;
  max-height: 500px;
  overflow: auto;
  
  @media (max-width: 767px) {
    width: 100%;
  }
  
  @media (min-width: 768px) {
    width: 300px;
    min-width: 300px;
  }
}

.bill-info-content {
  h3 {
    margin-top: 0;
    margin-bottom: 16px;
    font-size: 16px;
    font-weight: 500;
  }
  
  .action-buttons {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    flex-wrap: wrap;
  }
}

.fullscreen-note {
  margin-top: 16px;
}

.no-bill-message {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 40px;
  height: 100%;
  color: #999;
  font-size: 14px;
  
  .empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    color: #d9d9d9;
  }
}

.modal-title {
  display: flex;
  flex-direction: column;
  
  .bill-subtitle {
    font-size: 12px;
    color: rgba(0, 0, 0, 0.45);
  }
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translate(-50%, 10px);
  }
  to {
    opacity: 1;
    transform: translate(-50%, 0);
  }
}
````

## File: WebApp.Client/src/app/shared/components/xem-hoa-don-modal/xem-hoa-don-modal.component.ts
````typescript
import { Component, Input, Output, EventEmitter, OnInit, HostListener } from '@angular/core';
import { CommonModule } from '@angular/common';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzSpinModule } from 'ng-zorro-antd/spin';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzDescriptionsModule } from 'ng-zorro-antd/descriptions';
import { NzAlertModule } from 'ng-zorro-antd/alert';
import { NzToolTipModule } from 'ng-zorro-antd/tooltip';
import { NzMessageService } from 'ng-zorro-antd/message';
import { environment } from '../../../../environments/environment';

@Component({
  selector: 'app-xem-hoa-don-modal',
  standalone: true,
  imports: [
    CommonModule,
    NzModalModule,
    NzButtonModule,
    NzIconModule,
    NzSpinModule,
    NzTagModule,
    NzDescriptionsModule,
    NzAlertModule,
    NzToolTipModule
  ],
  templateUrl: './xem-hoa-don-modal.component.html',
  styleUrls: ['./xem-hoa-don-modal.component.scss']
})
export class XemHoaDonModalComponent implements OnInit {
  @Input() isVisible = false;
  @Input() dotKeKhai: any = null;
  @Input() urlBill: string | null = null;
  @Output() closeModal = new EventEmitter<void>();
  @Output() viewKeKhaiBHYT = new EventEmitter<number>();
  @Output() uploadBill = new EventEmitter<void>();
  @Output() downloadBill = new EventEmitter<void>();

  // Biến cho trạng thái ảnh
  isImageLoading = true; 
  selectedHoaDon: string | null = null;
  
  // Biến cho các tính năng của ảnh hóa đơn
  imageZoom = 1;
  imageRotation = 0;
  isFullscreen = false;
  
  // Biến cho chức năng kéo ảnh
  isDragging = false;
  startX = 0;
  startY = 0;
  translateX = 0;
  translateY = 0;
  
  // Cache hóa đơn đã tải
  private imageCache: Map<string, string> = new Map();

  constructor(private message: NzMessageService) {}

  ngOnInit(): void {
    // Khởi tạo modal
  }

  ngOnChanges(): void {
    if (this.isVisible && this.urlBill) {
      this.loadImage();
    }
  }

  loadImage(): void {
    // Reset các biến
    this.imageZoom = 1;
    this.imageRotation = 0;
    this.isFullscreen = false;
    this.translateX = 0;
    this.translateY = 0;
    this.isImageLoading = true;
    
    // Xử lý URL ảnh
    let imageUrl = this.urlBill as string;
    if (!imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
      try {
        const baseUrl = environment.apiUrl.replace('/api', '');
        imageUrl = `${baseUrl}/${imageUrl}`;
      } catch (error) {
        console.error('Lỗi khi xử lý URL:', error);
      }
    }
    
    // Tải ảnh
    const img = new Image();
    img.onload = () => {
      // Cập nhật URL ảnh sau khi tải thành công
      this.selectedHoaDon = imageUrl;
      this.isImageLoading = false;
      
      // Điều chỉnh kích thước zoom nếu cần
      if (img.naturalWidth > 1200 || img.naturalHeight > 800) {
        this.imageZoom = 0.9;
      }
      
      // Lưu vào cache
      this.imageCache.set(imageUrl, imageUrl);
    };
    
    img.onerror = () => {
      this.isImageLoading = false;
      this.message.error('Không thể tải ảnh hóa đơn');
      console.error('Lỗi tải ảnh:', imageUrl);
    };
    
    img.src = imageUrl;
  }

  // Xử lý đóng modal
  handleCancel(): void {
    // Thoát chế độ toàn màn hình nếu đang ở chế độ đó
    if (this.isFullscreen) {
      this.toggleFullscreen();
    }
    
    this.closeModal.emit();
    this.selectedHoaDon = null;
    this.imageZoom = 1;
    this.imageRotation = 0;
    this.translateX = 0;
    this.translateY = 0;
  }

  // Các phương thức cho ảnh
  zoomIn(): void {
    if (this.imageZoom < 3) {
      this.imageZoom += 0.2;
    }
  }

  zoomOut(): void {
    if (this.imageZoom > 0.5) {
      this.imageZoom -= 0.2;
    }
  }

  rotateImage(): void {
    this.imageRotation = (this.imageRotation + 90) % 360;
    
    // Reset vị trí khi xoay ảnh
    this.translateX = 0;
    this.translateY = 0;
  }

  resetImage(): void {
    this.imageZoom = 1;
    this.imageRotation = 0;
    this.translateX = 0;
    this.translateY = 0;
  }
  
  // Các phương thức xử lý kéo thả ảnh
  startDrag(event: MouseEvent): void {
    if (this.imageZoom > 1) {
      this.isDragging = true;
      this.startX = event.clientX - this.translateX;
      this.startY = event.clientY - this.translateY;
      event.preventDefault();
    }
  }
  
  onDrag(event: MouseEvent): void {
    if (!this.isDragging) return;
    
    this.translateX = event.clientX - this.startX;
    this.translateY = event.clientY - this.startY;
    event.preventDefault();
  }
  
  endDrag(): void {
    this.isDragging = false;
  }
  
  // Xử lý touch events cho thiết bị di động
  startTouchDrag(event: TouchEvent): void {
    if (this.imageZoom > 1 && event.touches.length === 1) {
      this.isDragging = true;
      this.startX = event.touches[0].clientX - this.translateX;
      this.startY = event.touches[0].clientY - this.translateY;
    }
  }
  
  onTouchDrag(event: TouchEvent): void {
    if (!this.isDragging || event.touches.length !== 1) return;
    
    this.translateX = event.touches[0].clientX - this.startX;
    this.translateY = event.touches[0].clientY - this.startY;
    event.preventDefault();
  }
  
  endTouchDrag(): void {
    this.isDragging = false;
  }

  // Xác định transform tổng hợp cho ảnh
  getImageTransform(): string {
    // Điều chỉnh vị trí dựa trên zoom
    const posX = this.translateX / this.imageZoom;
    const posY = this.translateY / this.imageZoom;
    
    return `scale(${this.imageZoom}) rotate(${this.imageRotation}deg) translate(${posX}px, ${posY}px)`;
  }

  toggleFullscreen(): void {
    this.isFullscreen = !this.isFullscreen;
    
    // Thêm hoặc xóa class cho body để ngăn cuộn khi ở chế độ toàn màn hình
    if (this.isFullscreen) {
      document.body.classList.add('overflow-hidden');
    } else {
      document.body.classList.remove('overflow-hidden');
    }
  }

  // Xử lý sự kiện lăn chuột để zoom
  handleMouseWheel(event: WheelEvent): void {
    event.preventDefault();
    
    if (event.deltaY < 0) {
      // Lăn lên: phóng to
      this.zoomIn();
    } else {
      // Lăn xuống: thu nhỏ
      this.zoomOut();
    }
  }

  // Phương thức lấy tên file từ URL
  getFileName(): string {
    if (!this.selectedHoaDon) return 'Không có file';
    
    try {
      const url = new URL(this.selectedHoaDon);
      const pathSegments = url.pathname.split('/');
      return pathSegments[pathSegments.length - 1] || 'hoa-don.jpg';
    } catch (e) {
      const pathSegments = this.selectedHoaDon.split('/');
      return pathSegments[pathSegments.length - 1] || 'hoa-don.jpg';
    }
  }

  // Tải hóa đơn
  taiHoaDon(): void {
    this.downloadBill.emit();
  }

  // Xem thông tin kê khai BHYT
  xemKeKhaiBHYT(): void {
    if (this.dotKeKhai && this.dotKeKhai.id) {
      this.viewKeKhaiBHYT.emit(this.dotKeKhai.id);
    }
  }
  
  // Upload thay thế hóa đơn
  uploadThayThe(): void {
    this.uploadBill.emit();
  }
  
  // Xử lý sự kiện phím ESC để thoát chế độ toàn màn hình
  @HostListener('document:keydown.escape', ['$event'])
  handleEscKey(event: KeyboardEvent): void {
    if (this.isFullscreen) {
      this.toggleFullscreen();
      event.preventDefault();
    }
  }
  
  // Lấy màu tag dựa trên trạng thái
  getTrangThaiType(trangThai: string): string {
    switch (trangThai) {
      case 'chua_gui':
        return 'default';
      case 'da_gui':
        return 'processing';
      case 'da_duyet':
        return 'success';
      case 'da_tu_choi':
        return 'error';
      default:
        return 'default';
    }
  }
  
  // Lấy text hiển thị cho trạng thái
  getTrangThaiText(trangThai: string): string {
    switch (trangThai) {
      case 'chua_gui':
        return 'Chưa gửi';
      case 'da_gui':
        return 'Đã gửi';
      case 'da_duyet':
        return 'Đã duyệt';
      case 'da_tu_choi':
        return 'Đã từ chối';
      default:
        return 'Không xác định';
    }
  }
}
````

## File: WebApp.Client/src/app/statistics/statistics.component.html
````html
<div class="statistics-container">
  <h2>Thống kê hệ thống</h2>
  
  <div class="statistics-grid">
    <div class="stat-card">
      <div class="stat-title">Tổng số người dùng</div>
      <div class="stat-value">{{totalUsers}}</div>
    </div>

    <div class="stat-card">
      <div class="stat-title">Người dùng đang hoạt động</div>
      <div class="stat-value">{{activeUsers}}</div>
    </div>

    <div class="stat-card">
      <div class="stat-title">Tổng số giao dịch</div>
      <div class="stat-value">{{totalTransactions}}</div>
    </div>
  </div>
</div>
````

## File: WebApp.Client/src/app/statistics/statistics.component.scss
````scss
.statistics-container {
  padding: 20px;

  h2 {
    margin-bottom: 30px;
    color: #333;
  }
}

.statistics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: transform 0.2s ease;

  &:hover {
    transform: translateY(-5px);
  }

  .stat-title {
    color: #666;
    font-size: 14px;
    margin-bottom: 10px;
  }

  .stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #2196f3;
  }
}
````

## File: WebApp.Client/src/app/statistics/statistics.component.spec.ts
````typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';

import { StatisticsComponent } from './statistics.component';

describe('StatisticsComponent', () => {
  let component: StatisticsComponent;
  let fixture: ComponentFixture<StatisticsComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [StatisticsComponent]
    })
    .compileComponents();

    fixture = TestBed.createComponent(StatisticsComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});
````

## File: WebApp.Client/src/app/statistics/statistics.component.ts
````typescript
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';

@Component({
  selector: 'app-statistics',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './statistics.component.html',
  styleUrls: ['./statistics.component.scss']
})
export class StatisticsComponent {
  // Thêm các thuộc tính thống kê ở đây
  totalUsers: number = 0;
  activeUsers: number = 0;
  totalTransactions: number = 0;

  constructor() {
    // TODO: Thêm logic lấy dữ liệu thống kê từ service
  }
}
````

## File: WebApp.Client/src/app/tra-cuu/tra-cuu-ho-gia-dinh/tra-cuu-ho-gia-dinh.component.html
````html
<div class="container">
  <nz-card nzTitle="Tra cứu thông tin hộ gia đình" [nzExtra]="extraTemplate">
    <form nz-form [formGroup]="traCuuHoGiaDinhForm" (ngSubmit)="submitHoGiaDinhForm()">
      
      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Tỉnh/Thành phố</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng chọn Tỉnh/Thành phố">
          <nz-select 
            formControlName="maTinh" 
            (ngModelChange)="onTinhChange($event)" 
            nzPlaceHolder="Chọn Tỉnh/Thành phố" 
            [nzLoading]="isLoadingData"
            nzShowSearch
            [nzAllowClear]="true"
            [nzFilterOption]="filterOption">
            <nz-option *ngFor="let tinh of danhSachTinh" [nzValue]="tinh.ma" [nzLabel]="tinh.ten"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Quận/Huyện</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng chọn Quận/Huyện">
          <nz-select 
            formControlName="maHuyen" 
            (ngModelChange)="onHuyenChange($event)" 
            nzPlaceHolder="Chọn Quận/Huyện" 
            [nzLoading]="isLoadingData"
            nzShowSearch
            [nzAllowClear]="true"
            [nzFilterOption]="filterOption">
            <nz-option *ngFor="let huyen of huyenTheoTinh" [nzValue]="huyen.ma" [nzLabel]="huyen.ten"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Xã/Phường</nz-form-label>
        <nz-form-control [nzSpan]="14">
          <nz-select 
            formControlName="maXa" 
            nzPlaceHolder="Chọn Xã/Phường" 
            [nzLoading]="isLoadingData"
            nzShowSearch
            [nzAllowClear]="true"
            [nzFilterOption]="filterOption">
            <nz-option *ngFor="let xa of xaTheoHuyen" [nzValue]="xa.ma" [nzLabel]="xa.ten"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Mã hộ</nz-form-label>
        <nz-form-control [nzSpan]="14">
          <input nz-input formControlName="maHo" placeholder="Nhập mã hộ" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Tên chủ hộ</nz-form-label>
        <nz-form-control [nzSpan]="14">
          <input nz-input formControlName="tenChuHo" placeholder="Nhập tên chủ hộ" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-control [nzOffset]="6" [nzSpan]="14">
          <button nz-button nzType="primary" [disabled]="isLoading">
            <i nz-icon nzType="search" *ngIf="!isLoading"></i>
            <i nz-icon nzType="loading" *ngIf="isLoading"></i>
            Tra cứu
          </button>
          <button nz-button (click)="resetForm()" style="margin-left: 8px;">
            <i nz-icon nzType="clear"></i>
            Xóa
          </button>
        </nz-form-control>
      </nz-form-item>
    </form>

    <ng-container *ngIf="daTimKiem">
      <nz-divider></nz-divider>
      
      <div *ngIf="isLoading" class="loading-container">
        <nz-spin nzTip="Đang tra cứu..."></nz-spin>
      </div>

      <div *ngIf="!isLoading && loiTraCuu" class="error-container">
        <nz-alert nzType="error" [nzMessage]="loiTraCuu" nzShowIcon></nz-alert>
      </div>

      <div *ngIf="!isLoading && !loiTraCuu && ketQuaTraCuu.length > 0" class="result-container">
        <h3>Kết quả tra cứu (Tìm thấy {{ ketQuaTraCuu.length }} hộ gia đình)</h3>
        
        <nz-table #basicTable [nzData]="ketQuaTraCuu" [nzPageSize]="5" [nzShowPagination]="ketQuaTraCuu.length > 5">
          <thead>
            <tr>
              <th>Mã hộ</th>
              <th>Tên chủ hộ</th>
              <th>Địa chỉ</th>
              <th>Số thành viên</th>
              <th>Chi tiết</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of basicTable.data">
              <td>{{ item.maHo }}</td>
              <td>{{ item.tenChuHo }}</td>
              <td>{{ item.diaChi || 'Không có' }}</td>
              <td>{{ item.soLuongThanhVien }}</td>
              <td>
                <button nz-button nzType="primary" nzSize="small" (click)="xemChiTiet(item)">
                  <i nz-icon nzType="eye"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </nz-table>
      </div>

      <!-- Modal xem chi tiết -->
      <nz-modal [(nzVisible)]="isModalVisible" nzTitle="Chi tiết hộ gia đình" (nzOnCancel)="closeModal()" [nzFooter]="null" [nzWidth]="800">
        <ng-container *nzModalContent>
          <nz-descriptions *ngIf="chiTietItem" nzBordered [nzColumn]="{ xxl: 2, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }">
            <nz-descriptions-item nzTitle="Mã hộ">{{ chiTietItem.maHo }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Tên chủ hộ">{{ chiTietItem.tenChuHo }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Số sổ hộ khẩu">{{ chiTietItem.soSoHoKhau || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Loại giấy tờ">{{ chiTietItem.loaiGiayTo || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Số điện thoại">{{ chiTietItem.dienThoai || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Trạng thái">{{ chiTietItem.trangThai || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Ngày kê khai">{{ chiTietItem.ngayKeKhai | date:'dd/MM/yyyy' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Số thành viên">{{ chiTietItem.soLuongThanhVien }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Địa chỉ" [nzSpan]="2">{{ chiTietItem.diaChi || 'Không có' }}</nz-descriptions-item>
          </nz-descriptions>

          <nz-divider></nz-divider>
          <h3>Danh sách thành viên trong hộ</h3>

          <nz-table #thanhVienTable [nzData]="thanhVienHo" [nzPageSize]="5" [nzShowPagination]="thanhVienHo.length > 5">
            <thead>
              <tr>
                <th>STT</th>
                <th>Mã số BHXH</th>
                <th>Họ và tên</th>
                <th>Ngày sinh</th>
                <th>Giới tính</th>
                <th>Mối quan hệ với chủ hộ</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let thanhVien of thanhVienTable.data; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ thanhVien.maSoBhxh }}</td>
                <td>{{ thanhVien.hoTen }}</td>
                <td>{{ thanhVien.ngaySinh | date:'dd/MM/yyyy' }}</td>
                <td>{{ thanhVien.gioiTinh }}</td>
                <td>{{ thanhVien.quanHeVoiChuHo || 'Không có' }}</td>
                <td>
                  <a nz-button nzType="link" nzSize="small" (click)="xemChiTietThanhVien(thanhVien)">
                    Chi tiết
                  </a>
                </td>
              </tr>
            </tbody>
          </nz-table>
        </ng-container>
      </nz-modal>

      <!-- Modal xem chi tiết thành viên -->
      <nz-modal [(nzVisible)]="isModalThanhVienVisible" nzTitle="Chi tiết thành viên" (nzOnCancel)="closeModalThanhVien()" [nzFooter]="null" [nzWidth]="700">
        <ng-container *nzModalContent>
          <nz-descriptions *ngIf="chiTietThanhVien" nzBordered [nzColumn]="{ xxl: 2, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }">
            <nz-descriptions-item nzTitle="Mã số BHXH">{{ chiTietThanhVien.maSoBhxh || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Họ và tên">{{ chiTietThanhVien.hoTen }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Ngày sinh">{{ chiTietThanhVien.ngaySinh | date:'dd/MM/yyyy' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Giới tính">{{ chiTietThanhVien.gioiTinh }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Số CCCD/CMND">{{ chiTietThanhVien.soCCCD || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Quan hệ với chủ hộ">{{ chiTietThanhVien.quanHeVoiChuHo }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Nơi sinh" [nzSpan]="2">{{ chiTietThanhVien.noiSinh || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Dân tộc">{{ chiTietThanhVien.danToc || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Quốc tịch">{{ chiTietThanhVien.quocTich || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Địa chỉ" [nzSpan]="2">{{ chiTietThanhVien.diaChi || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Số điện thoại">{{ chiTietThanhVien.dienThoai || 'Không có' }}</nz-descriptions-item>
          </nz-descriptions>
        </ng-container>
      </nz-modal>
    </ng-container>
  </nz-card>
</div>

<ng-template #extraTemplate>
  <button nz-button nzType="link">
    <i nz-icon nzType="question-circle" nzTheme="outline"></i>
    Hướng dẫn
  </button>
</ng-template>

<!-- Modal đăng nhập VNPost -->
<nz-modal
  [(nzVisible)]="isVNPostLoginVisible"
  [nzTitle]="'Xác thực captcha'"
  (nzOnCancel)="closeVNPostLogin()"
  (nzOnOk)="handleLogin()"
  [nzOkText]="'Xác nhận'"
  [nzCancelText]="'Hủy'"
  [nzOkLoading]="isLoadingLogin"
  nzWidth="400px">
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="vnpostLoginForm">
      <!-- Ẩn input tài khoản và mật khẩu -->
      <input type="hidden" formControlName="userName">
      <input type="hidden" formControlName="password">

      <nz-form-item>
        <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mã xác nhận">
          <div class="captcha-container">
            <img [src]="'data:image/png;base64,' + captchaImage" alt="captcha" 
              style="margin-bottom: 8px; max-width: 100%;" />
            <div class="input-with-button">
              <input nz-input 
                formControlName="text" 
                placeholder="Nhập mã xác nhận"
                (input)="convertToUpperCase($event)"
                maxlength="4" />
              <button 
                nz-button 
                nzType="default"
                class="refresh-button"
                (click)="getCaptcha(); $event.preventDefault()">
                <i nz-icon nzType="reload"></i>
              </button>
            </div>
          </div>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<style>
  .login-info {
    margin-bottom: 20px;
  }
  
  .captcha-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .input-with-button {
    display: flex;
    width: 100%;
    margin-top: 10px;
  }
  
  .input-with-button input {
    flex: 1;
  }
  
  .refresh-button {
    margin-left: 8px;
  }
  
  .login-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
  }
  
  .vnpost-login-button {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .login-status {
    margin-left: 10px;
    color: #52c41a;
  }

  .loading-container {
    display: flex;
    justify-content: center;
    margin: 20px 0;
  }

  .error-container {
    margin: 20px 0;
  }

  .result-container {
    margin-top: 20px;
  }
</style>
````

## File: WebApp.Client/src/app/tra-cuu/tra-cuu-ho-gia-dinh/tra-cuu-ho-gia-dinh.component.spec.ts
````typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';

import { TraCuuHoGiaDinhComponent } from './tra-cuu-ho-gia-dinh.component';

describe('TraCuuHoGiaDinhComponent', () => {
  let component: TraCuuHoGiaDinhComponent;
  let fixture: ComponentFixture<TraCuuHoGiaDinhComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [TraCuuHoGiaDinhComponent]
    })
    .compileComponents();

    fixture = TestBed.createComponent(TraCuuHoGiaDinhComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});
````

## File: WebApp.Client/src/app/tra-cuu/tra-cuu-ho-gia-dinh/tra-cuu-ho-gia-dinh.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { HttpClient } from '@angular/common/http';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzCardModule } from 'ng-zorro-antd/card';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzSpinModule } from 'ng-zorro-antd/spin';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzAlertModule } from 'ng-zorro-antd/alert';
import { NzDescriptionsModule } from 'ng-zorro-antd/descriptions';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzSelectModule, NzSelectItemInterface } from 'ng-zorro-antd/select';
import { NzTabsModule } from 'ng-zorro-antd/tabs';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzTableModule } from 'ng-zorro-antd/table';
import { BHXHService, TraCuuHoGiaDinhRequest } from '../../services/tra-cuu-ma-so-bhxh.service';
import { LocationService } from '../../services/location.service';
import { finalize } from 'rxjs/operators';
import { SSMV2Service } from '../../services/ssmv2.service';

interface TinhThanh {
  ma: string;
  ten: string;
}

interface QuanHuyen {
  ma: string;
  ten: string;
  maTinh: string;
}

interface XaPhuong {
  ma: string;
  ten: string;
  maHuyen: string;
}

@Component({
  selector: 'app-tra-cuu-ho-gia-dinh',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    NzFormModule,
    NzInputModule,
    NzButtonModule,
    NzCardModule,
    NzGridModule,
    NzSpinModule,
    NzAlertModule,
    NzDescriptionsModule,
    NzDividerModule,
    NzIconModule,
    NzTagModule,
    NzSelectModule,
    NzTabsModule,
    NzModalModule,
    NzTableModule
  ],
  templateUrl: './tra-cuu-ho-gia-dinh.component.html',
  styleUrls: ['./tra-cuu-ho-gia-dinh.component.scss']
})
export class TraCuuHoGiaDinhComponent implements OnInit {
  traCuuHoGiaDinhForm!: FormGroup;
  isLoading = false;
  isLoadingData = false;
  ketQuaTraCuu: any[] = [];
  daTimKiem = false;
  loiTraCuu = '';

  danhSachTinh: TinhThanh[] = [];
  danhSachHuyen: QuanHuyen[] = [];
  danhSachXa: XaPhuong[] = [];

  huyenTheoTinh: QuanHuyen[] = [];
  xaTheoHuyen: XaPhuong[] = [];

  // Thêm thuộc tính SSMV2
  isVNPostLoginVisible = false;
  captchaImage = '';
  captchaCode = '';
  vnpostLoginForm!: FormGroup;
  isLoadingLogin = false;

  // Thêm thuộc tính cho modal chi tiết
  isModalVisible = false;
  chiTietItem: any = null;
  thanhVienHo: any[] = [];
  
  // Thêm thuộc tính cho modal chi tiết thành viên
  isModalThanhVienVisible = false;
  chiTietThanhVien: any = null;

  constructor(
    private fb: FormBuilder,
    private bhxhService: BHXHService,
    private locationService: LocationService,
    private message: NzMessageService,
    private ssmv2Service: SSMV2Service
  ) {}

  ngOnInit(): void {
    this.traCuuHoGiaDinhForm = this.fb.group({
      maTinh: [null, [Validators.required]],
      maHuyen: [null, [Validators.required]],
      maXa: [null],
      maHo: [null],
      tenChuHo: [null]
    });

    this.loadDanhSachTinh();

    // Khởi tạo form đăng nhập VNPost
    this.vnpostLoginForm = this.fb.group({
      userName: ['884000_xa_tli_phuoclt', [Validators.required]],
      password: ['123456d@D', [Validators.required]],
      text: ['', [
        Validators.required,
        Validators.minLength(4),
        Validators.maxLength(4)
      ]]
    });

    // Kiểm tra và tự động đăng nhập VNPost nếu chưa có token
    if (!this.ssmv2Service.getToken()) {
      setTimeout(() => {
        this.autoLoginVNPost();
      }, 500);
    }
  }

  loadDanhSachTinh(): void {
    this.isLoadingData = true;
    this.locationService.getProvinces()
      .pipe(finalize(() => this.isLoadingData = false))
      .subscribe({
        next: (provinces) => {
          this.danhSachTinh = provinces.map(province => ({
            ma: province.ma,
            ten: province.ten
          }));
        },
        error: (err) => {
          console.error('Lỗi khi lấy danh sách tỉnh/thành phố:', err);
          this.message.error('Không thể tải danh sách tỉnh/thành phố. Vui lòng thử lại sau.');
        }
      });
  }

  onTinhChange(maTinh: string): void {
    if (!maTinh) {
      this.huyenTheoTinh = [];
      this.traCuuHoGiaDinhForm.patchValue({ maHuyen: null, maXa: null });
      this.xaTheoHuyen = [];
      return;
    }

    this.isLoadingData = true;
    this.locationService.getDistricts(maTinh)
      .pipe(finalize(() => this.isLoadingData = false))
      .subscribe({
        next: (districts) => {
          this.danhSachHuyen = districts.map(district => ({
            ma: district.ma,
            ten: district.ten,
            maTinh: district.ma_tinh
          }));
          this.huyenTheoTinh = this.danhSachHuyen;
          this.traCuuHoGiaDinhForm.patchValue({ maHuyen: null, maXa: null });
          this.xaTheoHuyen = [];
        },
        error: (err) => {
          console.error(`Lỗi khi lấy danh sách quận/huyện cho tỉnh ${maTinh}:`, err);
          this.message.error('Không thể tải danh sách quận/huyện. Vui lòng thử lại sau.');
          this.huyenTheoTinh = [];
        }
      });
  }

  onHuyenChange(maHuyen: string): void {
    if (!maHuyen) {
      this.xaTheoHuyen = [];
      this.traCuuHoGiaDinhForm.patchValue({ maXa: null });
      return;
    }

    this.isLoadingData = true;
    this.locationService.getCommunes(maHuyen)
      .pipe(finalize(() => this.isLoadingData = false))
      .subscribe({
        next: (response) => {
          if (response && response.success && response.data) {
            this.danhSachXa = response.data.map(commune => ({
              ma: commune.ma,
              ten: commune.ten,
              maHuyen: commune.ma_huyen
            }));
            this.xaTheoHuyen = this.danhSachXa;
          } else {
            this.xaTheoHuyen = [];
          }
          this.traCuuHoGiaDinhForm.patchValue({ maXa: null });
        },
        error: (err) => {
          console.error(`Lỗi khi lấy danh sách xã/phường cho huyện ${maHuyen}:`, err);
          this.message.error('Không thể tải danh sách xã/phường. Vui lòng thử lại sau.');
          this.xaTheoHuyen = [];
        }
      });
  }

  submitHoGiaDinhForm(): void {
    if (this.traCuuHoGiaDinhForm.valid) {
      this.isLoading = true;
      this.daTimKiem = true;
      this.loiTraCuu = '';
      
      // Kiểm tra token VNPost
      const token = this.ssmv2Service.getToken();
      if (!token) {
        // Tự động đăng nhập VNPost
        this.autoLoginVNPost(true);
        return;
      }
      
      // Lấy dữ liệu từ form
      const formData: TraCuuHoGiaDinhRequest = {
        maTinh: this.traCuuHoGiaDinhForm.value.maTinh,
        maHuyen: this.traCuuHoGiaDinhForm.value.maHuyen,
        maXa: this.traCuuHoGiaDinhForm.value.maXa || '',
        maHo: this.traCuuHoGiaDinhForm.value.maHo || '',
        tenChuHo: this.traCuuHoGiaDinhForm.value.tenChuHo || ''
      };
      
      console.log('Dữ liệu gửi đi:', formData);
      
      // Gọi API tra cứu hộ gia đình
      this.bhxhService.traCuuHoGiaDinh(formData)
        .subscribe({
          next: (res: any) => {
            this.isLoading = false;
            
            // Log response để debug
            console.log('Response từ API Hộ Gia Đình:', res);
            
            // Kiểm tra nếu response có chứa thông báo lỗi xác thực
            if (res && res.error === 'Lỗi xác thực') {
              this.ketQuaTraCuu = [];
              this.loiTraCuu = 'Lỗi xác thực: ' + (res.error_description || 'Không tìm thấy thông tin phiên đăng nhập');
              this.message.error(this.loiTraCuu);
              
              // Hiển thị form đăng nhập lại
              this.ssmv2Service.clearToken();
              this.message.warning('Vui lòng đăng nhập lại để tiếp tục');
              this.showVNPostLogin();
              return;
            }
            
            // Kiểm tra nếu response có status khác 200
            if (res && res.status && res.status !== 200) {
              this.ketQuaTraCuu = [];
              this.loiTraCuu = res.message || 'Có lỗi xảy ra khi tra cứu';
              this.message.error(this.loiTraCuu);
              return;
            }
            
            // Xử lý dữ liệu trả về
            if (res && res.success && res.data && res.data.length > 0) {
              // Xử lý tất cả kết quả
              this.ketQuaTraCuu = res.data.map((data: any) => ({
                maHo: data.maHo,
                tenChuHo: data.tenChuHo,
                diaChi: data.diaChi,
                soSoHoKhau: data.soSoHoKhau,
                loaiGiayTo: data.loaiGiayTo,
                dienThoai: data.dienThoai,
                trangThai: data.trangThai,
                ngayKeKhai: this.parseDate(data.ngayKeKhai, data.ngayKeKhaiDt),
                soLuongThanhVien: data.dsThanhVien ? data.dsThanhVien.length : 0,
                danhSachThanhVien: data.dsThanhVien ? data.dsThanhVien.map((tv: any) => ({
                  maSoBhxh: tv.soSoBhxh,
                  hoTen: tv.hoTen,
                  ngaySinh: tv.ngaySinhHienThi ? this.parseDateDisplay(tv.ngaySinhHienThi) : this.parseNgaySinh(tv.ngaySinh),
                  gioiTinh: tv.gioiTinhHienThi || (tv.gioiTinh === '1' ? 'Nam' : 'Nữ'),
                  soCCCD: tv.soCmnd || 'Không có',
                  mqhChuHo: tv.mqhChuHo || 'Không có',
                  quanHeVoiChuHo: tv.mqhChuHo || 'Không có',
                  noiSinh: `${tv.tenXaKs || ''}, ${tv.tenHuyenKs || ''}, ${tv.tenTinhKs || ''}`,
                  danToc: tv.danToc,
                  quocTich: tv.quocTich,
                  diaChi: tv.diaChiLh || 'Không có',
                  dienThoai: tv.soDienThoai || 'Không có'
                })) : []
              }));
              
              this.message.success(`Tra cứu thành công: Tìm thấy ${this.ketQuaTraCuu.length} hộ gia đình`);
            } else {
              this.ketQuaTraCuu = [];
              this.loiTraCuu = 'Không tìm thấy thông tin hộ gia đình';
              this.message.warning(this.loiTraCuu);
            }
          },
          error: (err: any) => {
            this.isLoading = false;
            this.ketQuaTraCuu = [];
            
            console.error('Lỗi khi tra cứu:', err);
            
            if (err.error === 'Lỗi xác thực') {
              this.loiTraCuu = 'Lỗi xác thực: ' + (err.error_description || 'Phiên làm việc đã hết hạn');
              this.message.error(this.loiTraCuu);
              this.ssmv2Service.clearToken();
              this.showVNPostLogin();
            } else {
              this.loiTraCuu = 'Đã xảy ra lỗi khi tra cứu: ' + (err.error?.message || err.message || 'Vui lòng thử lại sau');
              this.message.error(this.loiTraCuu);
            }
          }
        });
    } else {
      Object.values(this.traCuuHoGiaDinhForm.controls).forEach(control => {
        if (control.invalid) {
          control.markAsDirty();
          control.updateValueAndValidity();
        }
      });
    }
  }

  resetForm(): void {
    this.traCuuHoGiaDinhForm.reset();
    this.huyenTheoTinh = [];
    this.xaTheoHuyen = [];
    this.ketQuaTraCuu = [];
    this.daTimKiem = false;
    this.loiTraCuu = '';
  }

  filterOption = (input: string, option: NzSelectItemInterface): boolean => {
    const label = (option.nzLabel?.toString() || '').toLowerCase();
    const searchText = input.toLowerCase();
    return (
      label.includes(searchText) || 
      this.removeVietnameseTones(label).includes(this.removeVietnameseTones(searchText))
    );
  };

  private removeVietnameseTones(str: string): string {
    if (!str) return '';
    str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g, 'a');
    str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g, 'e');
    str = str.replace(/ì|í|ị|ỉ|ĩ/g, 'i');
    str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g, 'o');
    str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g, 'u');
    str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g, 'y');
    str = str.replace(/đ/g, 'd');
    str = str.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g, 'A');
    str = str.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g, 'E');
    str = str.replace(/Ì|Í|Ị|Ỉ|Ĩ/g, 'I');
    str = str.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g, 'O');
    str = str.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g, 'U');
    str = str.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g, 'Y');
    str = str.replace(/Đ/g, 'D');
    return str;
  }

  // Hiển thị form đăng nhập VNPost
  showVNPostLogin(): void {
    this.isVNPostLoginVisible = true;
    this.getCaptcha();
  }
  
  // Đóng form đăng nhập VNPost
  closeVNPostLogin(): void {
    this.isVNPostLoginVisible = false;
  }
  
  // Tải captcha
  getCaptcha(): void {
    this.ssmv2Service.getCaptcha().subscribe({
      next: (res) => {
        console.log('Captcha response:', res);
        if (res && res.data) {
          this.captchaImage = res.data.image;
          this.captchaCode = res.data.code;
        } else {
          this.message.error('Không nhận được dữ liệu captcha');
        }
      },
      error: (err) => {
        console.error('Captcha error:', err);
        this.message.error('Lỗi khi lấy captcha: ' + err.message);
      }
    });
  }
  
  // Đăng nhập VNPost
  handleLogin(): void {
    if (this.vnpostLoginForm.valid) {
      this.isLoadingLogin = true;
      
      const data = {
        grant_type: 'password',
        userName: this.vnpostLoginForm.get('userName')?.value,
        password: this.vnpostLoginForm.get('password')?.value,
        text: this.vnpostLoginForm.get('text')?.value,
        code: this.captchaCode,
        clientId: 'ZjRiYmI5ZTgtZDcyOC00ODRkLTkyOTYtMDNjYmUzM2U4Yjc5',
        isWeb: true
      };

      console.log('Gửi request đăng nhập với data:', { ...data, password: '***' });

      this.ssmv2Service.authenticate(data).subscribe({
        next: (response) => {
          this.isLoadingLogin = false;
          
          if (response.body?.access_token) {
            console.log('Xác thực thành công, token hết hạn sau:', response.body.expires_in, 'giây');
            this.message.success('Xác thực thành công');
            this.isVNPostLoginVisible = false;
            
            // Đảm bảo token đã được lưu trước khi tìm kiếm
            setTimeout(() => {
              this.submitHoGiaDinhForm();
            }, 1000);
          } else {
            this.message.error('Không nhận được token');
            this.getCaptcha();
          }
        },
        error: (err) => {
          console.error('Login error:', err);
          this.isLoadingLogin = false;
          this.vnpostLoginForm.patchValue({ text: '' });

          if (err.error?.error === 'invalid_captcha') {
            this.message.error('Mã xác thực sai');
          } else if (err.error?.error_description?.includes('xác thực')) {
            this.message.error('Mã xác thực sai');
          } else if (err.error?.message) {
            this.message.error(err.error.message);
          } else {
            this.message.error('Xác thực thất bại, vui lòng thử lại');
          }

          setTimeout(() => {
            this.getCaptcha();
          }, 100);
        }
      });
    } else {
      Object.values(this.vnpostLoginForm.controls).forEach(control => {
        if (control.invalid) {
          control.markAsTouched();
          control.updateValueAndValidity();
        }
      });
    }
  }

  // Chuyển đổi chữ thành chữ hoa
  convertToUpperCase(event: Event): void {
    const input = event.target as HTMLInputElement;
    input.value = input.value.toUpperCase();
    this.vnpostLoginForm.get('text')?.setValue(input.value);
  }

  // Kiểm tra trạng thái đăng nhập VNPost
  isVNPostLoggedIn(): boolean {
    return !!this.ssmv2Service.getToken();
  }

  // Xem chi tiết hộ gia đình
  xemChiTiet(item: any): void {
    this.chiTietItem = item;
    this.thanhVienHo = item.danhSachThanhVien || [];
    this.isModalVisible = true;
  }

  // Đóng modal chi tiết
  closeModal(): void {
    this.isModalVisible = false;
  }

  // Thêm phương thức tự động đăng nhập VNPost
  autoLoginVNPost(fromSubmit: boolean = false): void {
    // Lấy captcha
    this.ssmv2Service.getCaptcha().subscribe({
      next: (res) => {
        if (res && res.data) {
          this.captchaImage = res.data.image;
          this.captchaCode = res.data.code;
          
          // Thực hiện đăng nhập tự động
          const data = {
            grant_type: 'password',
            userName: this.vnpostLoginForm.get('userName')?.value,
            password: this.vnpostLoginForm.get('password')?.value,
            text: this.captchaCode, // Sử dụng mã captcha làm text
            code: this.captchaCode,
            clientId: 'ZjRiYmI5ZTgtZDcyOC00ODRkLTkyOTYtMDNjYmUzM2U4Yjc5',
            isWeb: true
          };

          this.ssmv2Service.authenticate(data).subscribe({
            next: (response) => {
              if (response.body?.access_token) {
                console.log('Tự động xác thực thành công');
                
                // Chỉ thực hiện tìm kiếm nếu đăng nhập từ quá trình submit form
                if (fromSubmit) {
                  setTimeout(() => {
                    this.submitHoGiaDinhForm();
                  }, 1000);
                }
              } else {
                if (fromSubmit) {
                  this.isLoading = false;
                }
              }
            },
            error: (err) => {
              console.error('Lỗi tự động đăng nhập:', err);
              if (fromSubmit) {
                this.isLoading = false;
                this.showVNPostLogin(); // Hiển thị form đăng nhập nếu tự động đăng nhập thất bại
              }
            }
          });
        } else {
          if (fromSubmit) {
            this.isLoading = false;
          }
        }
      },
      error: (err) => {
        console.error('Lỗi khi lấy captcha:', err);
        if (fromSubmit) {
          this.isLoading = false;
          this.showVNPostLogin(); // Hiển thị form đăng nhập nếu không lấy được captcha
        }
      }
    });
  }

  // Thêm phương thức để xử lý ngày tháng
  private parseDate(dateStr: string, dateDt: string): Date {
    if (dateDt) {
      return new Date(dateDt);
    }
    
    if (dateStr && dateStr.length === 8) {
      const year = parseInt(dateStr.substring(0, 4), 10);
      const month = parseInt(dateStr.substring(4, 6), 10) - 1; // Tháng trong JS bắt đầu từ 0
      const day = parseInt(dateStr.substring(6, 8), 10);
      return new Date(year, month, day);
    }
    
    return new Date();
  }

  // Thêm phương thức để xử lý ngày tháng hiển thị
  private parseDateDisplay(dateDisplayStr: string): Date {
    if (!dateDisplayStr) return new Date();
    
    const parts = dateDisplayStr.split('/');
    if (parts.length === 3) {
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1; // Tháng trong JS bắt đầu từ 0
      const year = parseInt(parts[2], 10);
      return new Date(year, month, day);
    }
    
    return new Date();
  }

  // Thêm phương thức để xử lý ngày sinh từ định dạng YYYYMMDD
  private parseNgaySinh(ngaySinhStr: string): Date {
    if (ngaySinhStr && ngaySinhStr.length === 8) {
      const year = parseInt(ngaySinhStr.substring(0, 4), 10);
      const month = parseInt(ngaySinhStr.substring(4, 6), 10) - 1; // Tháng trong JS bắt đầu từ 0
      const day = parseInt(ngaySinhStr.substring(6, 8), 10);
      return new Date(year, month, day);
    }
    
    return new Date();
  }

  // Xem chi tiết thành viên
  xemChiTietThanhVien(thanhVien: any): void {
    this.chiTietThanhVien = thanhVien;
    this.isModalThanhVienVisible = true;
  }

  // Đóng modal chi tiết thành viên
  closeModalThanhVien(): void {
    this.isModalThanhVienVisible = false;
  }
}
````

## File: WebApp.Client/src/app/tra-cuu/tra-cuu-ma-so-bhxh/tra-cuu-ma-so-bhxh.component.html
````html
<div class="container">
  <nz-card nzTitle="Tra cứu mã số BHXH" [nzExtra]="extraTemplate">
    <form nz-form [formGroup]="traCuuVNPostForm" (ngSubmit)="submitVNPostForm()">
      
      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Tỉnh/Thành phố</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng chọn Tỉnh/Thành phố">
          <nz-select 
            formControlName="maTinh" 
            (ngModelChange)="onTinhChange($event)" 
            nzPlaceHolder="Chọn Tỉnh/Thành phố" 
            [nzLoading]="isLoadingData"
            nzShowSearch
            [nzAllowClear]="true"
            [nzFilterOption]="filterOption">
            <nz-option *ngFor="let tinh of danhSachTinh" [nzValue]="tinh.ma" [nzLabel]="tinh.ten"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Quận/Huyện</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng chọn Quận/Huyện">
          <nz-select 
            formControlName="maHuyen" 
            (ngModelChange)="onHuyenChange($event)" 
            nzPlaceHolder="Chọn Quận/Huyện" 
            [nzLoading]="isLoadingData"
            nzShowSearch
            [nzAllowClear]="true"
            [nzFilterOption]="filterOption">
            <nz-option *ngFor="let huyen of huyenTheoTinh" [nzValue]="huyen.ma" [nzLabel]="huyen.ten"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Xã/Phường</nz-form-label>
        <nz-form-control [nzSpan]="14">
          <nz-select 
            formControlName="maXa" 
            nzPlaceHolder="Chọn Xã/Phường" 
            [nzLoading]="isLoadingData"
            nzShowSearch
            [nzAllowClear]="true"
            [nzFilterOption]="filterOption">
            <nz-option *ngFor="let xa of xaTheoHuyen" [nzValue]="xa.ma" [nzLabel]="xa.ten"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Họ và tên</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng nhập họ và tên">
          <input nz-input formControlName="hoTen" placeholder="Nhập họ và tên" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Ngày sinh</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng chọn hoặc nhập ngày sinh" nzTooltip="Nhập theo định dạng dd/MM/yyyy, ví dụ: 01/01/1990">
          <nz-date-picker 
            formControlName="ngaySinh" 
            nzFormat="dd/MM/yyyy" 
            style="width: 100%"
            nzPlaceHolder="Nhập hoặc chọn ngày sinh"
            [nzInputReadOnly]="false"
            (input)="onDateInputChange($event)"
            nzAllowClear></nz-date-picker>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Số CCCD/CMND</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng nhập số CCCD/CMND">
          <input nz-input formControlName="soCMND" placeholder="Nhập số CCCD/CMND" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-control [nzOffset]="6" [nzSpan]="14">
          <button nz-button nzType="primary" [disabled]="isLoading">
            <i nz-icon nzType="search" *ngIf="!isLoading"></i>
            <i nz-icon nzType="loading" *ngIf="isLoading"></i>
            Tra cứu
          </button>
          <button nz-button (click)="resetForm()" style="margin-left: 8px;">
            <i nz-icon nzType="clear"></i>
            Xóa
          </button>
        </nz-form-control>
      </nz-form-item>
    </form>

    <ng-container *ngIf="daTimKiem">
      <nz-divider></nz-divider>
      
      <div *ngIf="isLoading" class="loading-container">
        <nz-spin nzTip="Đang tra cứu..."></nz-spin>
      </div>

      <div *ngIf="!isLoading && loiTraCuu" class="error-container">
        <nz-alert nzType="error" [nzMessage]="loiTraCuu" nzShowIcon></nz-alert>
      </div>

      <div *ngIf="!isLoading && !loiTraCuu && ketQuaTraCuu.length > 0" class="result-container">
        <h3>Kết quả tra cứu (Tìm thấy {{ ketQuaTraCuu.length }} kết quả)</h3>
        
        <nz-table #basicTable [nzData]="ketQuaTraCuu" [nzPageSize]="5" [nzShowPagination]="ketQuaTraCuu.length > 5">
          <thead>
            <tr>
              <th>Mã số BHXH</th>
              <th>Họ và tên</th>
              <th>Ngày sinh</th>
              <th>Giới tính</th>
              <th>Số CCCD/CMND</th>
              <th>Địa chỉ</th>
              <th>Trạng thái</th>
              <th>Chi tiết</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of basicTable.data">
              <td>{{ item.maSoBHXH }}</td>
              <td>{{ item.hoTen }}</td>
              <td>{{ item.ngaySinh | date:'dd/MM/yyyy' }}</td>
              <td>{{ item.gioiTinh }}</td>
              <td>{{ item.soCCCD || 'Không có' }}</td>
              <td>{{ item.diaChi || 'Không có' }}</td>
              <td>
                <nz-tag [nzColor]="item.trangThai === 'Đã duyệt' ? 'green' : 'red'">
                  {{ item.trangThai }}
                </nz-tag>
              </td>
              <td>
                <button nz-button nzType="primary" nzSize="small" (click)="xemChiTiet(item)">
                  <i nz-icon nzType="eye"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </nz-table>
      </div>

      <!-- Modal xem chi tiết -->
      <nz-modal [(nzVisible)]="isModalVisible" nzTitle="Chi tiết mã số BHXH" (nzOnCancel)="closeModal()" [nzFooter]="null">
        <ng-container *nzModalContent>
          <nz-descriptions *ngIf="chiTietItem" nzBordered [nzColumn]="{ xxl: 1, xl: 1, lg: 1, md: 1, sm: 1, xs: 1 }">
            <nz-descriptions-item nzTitle="Mã số BHXH">{{ chiTietItem.maSoBHXH }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Họ và tên">{{ chiTietItem.hoTen }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Ngày sinh">{{ chiTietItem.ngaySinh | date:'dd/MM/yyyy' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Giới tính">{{ chiTietItem.gioiTinh }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Số CCCD/CMND">{{ chiTietItem.soCCCD || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Địa chỉ">{{ chiTietItem.diaChi || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Mã hộ" *ngIf="chiTietItem.maHo">{{ chiTietItem.maHo }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Trạng thái">
              <nz-tag [nzColor]="chiTietItem.trangThai === 'Đã duyệt' ? 'green' : 'red'">
                {{ chiTietItem.trangThai }}
              </nz-tag>
            </nz-descriptions-item>
          </nz-descriptions>
        </ng-container>
      </nz-modal>
    </ng-container>
  </nz-card>
</div>

<ng-template #extraTemplate>
  <button nz-button nzType="link">
    <i nz-icon nzType="question-circle" nzTheme="outline"></i>
    Hướng dẫn
  </button>
</ng-template>

<!-- Modal đăng nhập VNPost -->
<nz-modal
  [(nzVisible)]="isVNPostLoginVisible"
  [nzTitle]="'Xác thực captcha'"
  (nzOnCancel)="closeVNPostLogin()"
  (nzOnOk)="handleLogin()"
  [nzOkText]="'Xác nhận'"
  [nzCancelText]="'Hủy'"
  [nzOkLoading]="isLoadingLogin"
  nzWidth="400px">
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="vnpostLoginForm">
      <!-- Ẩn input tài khoản và mật khẩu -->
      <input type="hidden" formControlName="userName">
      <input type="hidden" formControlName="password">

      <nz-form-item>
        <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mã xác nhận">
          <div class="captcha-container">
            <img [src]="'data:image/png;base64,' + captchaImage" alt="captcha" 
              style="margin-bottom: 8px; max-width: 100%;" />
            <div class="input-with-button">
              <input nz-input 
                formControlName="text" 
                placeholder="Nhập mã xác nhận"
                (input)="convertToUpperCase($event)"
                maxlength="4" />
              <button 
                nz-button 
                nzType="default"
                class="refresh-button"
                (click)="getCaptcha(); $event.preventDefault()">
                <i nz-icon nzType="reload"></i>
              </button>
            </div>
          </div>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<style>
  .login-info {
    margin-bottom: 20px;
  }
  
  .captcha-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .input-with-button {
    display: flex;
    width: 100%;
    margin-top: 10px;
  }
  
  .input-with-button input {
    flex: 1;
  }
  
  .refresh-button {
    margin-left: 8px;
  }
  
  .login-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
  }
  
  .vnpost-login-button {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .login-status {
    margin-left: 10px;
    color: #52c41a;
  }
</style>
````

## File: WebApp.Client/src/app/tra-cuu/tra-cuu-ma-so-bhxh/tra-cuu-ma-so-bhxh.component.scss
````scss
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.loading-container {
  display: flex;
  justify-content: center;
  margin: 20px 0;
}

.error-container {
  margin: 20px 0;
}

.result-container {
  margin-top: 20px;
}

.login-info {
  margin-bottom: 20px;
}

.captcha-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 10px;
}

.input-with-button {
  display: flex;
  width: 100%;
  margin-top: 10px;
}

.input-with-button input {
  flex: 1;
}

.refresh-button {
  margin-left: 8px;
}

.login-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
}

.vnpost-login-button {
  display: flex;
  align-items: center;
  margin-bottom: 15px;
}

.login-status {
  margin-left: 10px;
  color: #52c41a;
}

/* Cải thiện giao diện nhập ngày sinh */
::ng-deep .ant-picker-input > input {
  cursor: text !important;
}

::ng-deep .ant-tooltip {
  max-width: 300px;
}

::ng-deep .ant-tooltip-inner {
  text-align: left;
}

::ng-deep {
  .ant-descriptions-bordered .ant-descriptions-item-label {
    background-color: #fafafa;
    font-weight: 500;
  }
}

@media (max-width: 768px) {
  .container {
    padding: 10px;
  }
  
  ::ng-deep {
    .ant-form-item-label {
      text-align: left !important;
    }
  }
}

.date-input-hint {
  font-size: 12px;
  color: #8c8c8c;
  margin-top: 4px;
  font-style: italic;
}
````

## File: WebApp.Client/src/app/tra-cuu/tra-cuu-ma-so-bhxh/tra-cuu-ma-so-bhxh.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { HttpClient } from '@angular/common/http';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzCardModule } from 'ng-zorro-antd/card';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzSpinModule } from 'ng-zorro-antd/spin';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzAlertModule } from 'ng-zorro-antd/alert';
import { NzDescriptionsModule } from 'ng-zorro-antd/descriptions';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzSelectModule, NzSelectItemInterface } from 'ng-zorro-antd/select';
import { NzDatePickerModule } from 'ng-zorro-antd/date-picker';
import { NzTabsModule } from 'ng-zorro-antd/tabs';
import { NzCheckboxModule } from 'ng-zorro-antd/checkbox';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzTableModule } from 'ng-zorro-antd/table';
import { BHXHService, TraCuuVNPostRequest } from '../../services/tra-cuu-ma-so-bhxh.service';
import { LocationService, Province, District, Commune } from '../../services/location.service';
import { finalize } from 'rxjs/operators';
import { SSMV2Service } from '../../services/ssmv2.service';

interface TinhThanh {
  ma: string;
  ten: string;
}

interface QuanHuyen {
  ma: string;
  ten: string;
  maTinh: string;
}

interface XaPhuong {
  ma: string;
  ten: string;
  maHuyen: string;
}

@Component({
  selector: 'app-tra-cuu-ma-so-bhxh',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    NzFormModule,
    NzInputModule,
    NzButtonModule,
    NzCardModule,
    NzGridModule,
    NzSpinModule,
    NzAlertModule,
    NzDescriptionsModule,
    NzDividerModule,
    NzIconModule,
    NzTagModule,
    NzSelectModule,
    NzDatePickerModule,
    NzTabsModule,
    NzCheckboxModule,
    NzModalModule,
    NzTableModule
  ],
  templateUrl: './tra-cuu-ma-so-bhxh.component.html',
  styleUrls: ['./tra-cuu-ma-so-bhxh.component.scss']
})
export class TraCuuMaSoBhxhComponent implements OnInit {
  traCuuVNPostForm!: FormGroup;
  isLoading = false;
  isLoadingData = false;
  ketQuaTraCuu: any[] = [];
  daTimKiem = false;
  loiTraCuu = '';

  danhSachTinh: TinhThanh[] = [];
  danhSachHuyen: QuanHuyen[] = [];
  danhSachXa: XaPhuong[] = [];

  huyenTheoTinh: QuanHuyen[] = [];
  xaTheoHuyen: XaPhuong[] = [];

  // Thêm các thuộc tính SSMV2
  isVNPostLoginVisible = false;
  captchaImage = '';
  captchaCode = '';
  vnpostLoginForm!: FormGroup;
  isLoadingLogin = false;

  // Thêm thuộc tính cho modal chi tiết
  isModalVisible = false;
  chiTietItem: any = null;

  constructor(
    private fb: FormBuilder,
    private bhxhService: BHXHService,
    private locationService: LocationService,
    private message: NzMessageService,
    private ssmv2Service: SSMV2Service
  ) {}

  ngOnInit(): void {
    this.traCuuVNPostForm = this.fb.group({
      maTinh: [null, [Validators.required]],
      maHuyen: [null, [Validators.required]],
      maXa: [null],
      hoTen: [null],
      ngaySinh: [null],
      soCMND: [null]
    });

    this.loadDanhSachTinh();

    // Khởi tạo form đăng nhập VNPost
    this.vnpostLoginForm = this.fb.group({
      userName: ['884000_xa_tli_phuoclt', [Validators.required]],
      password: ['123456d@D', [Validators.required]],
      text: ['', [
        Validators.required,
        Validators.minLength(4),
        Validators.maxLength(4)
      ]]
    });

    // Kiểm tra và tự động đăng nhập VNPost nếu chưa có token
    if (!this.ssmv2Service.getToken()) {
      setTimeout(() => {
        this.autoLoginVNPost();
      }, 500);
    }
  }

  loadDanhSachTinh(): void {
    this.isLoadingData = true;
    this.locationService.getProvinces()
      .pipe(finalize(() => this.isLoadingData = false))
      .subscribe({
        next: (provinces) => {
          this.danhSachTinh = provinces.map(province => ({
            ma: province.ma,
            ten: province.ten
          }));
        },
        error: (err) => {
          console.error('Lỗi khi lấy danh sách tỉnh/thành phố:', err);
          this.message.error('Không thể tải danh sách tỉnh/thành phố. Vui lòng thử lại sau.');
        }
      });
  }

  onTinhChange(maTinh: string): void {
    if (!maTinh) {
      this.huyenTheoTinh = [];
      this.traCuuVNPostForm.patchValue({ maHuyen: null, maXa: null });
      this.xaTheoHuyen = [];
      return;
    }

    this.isLoadingData = true;
    this.locationService.getDistricts(maTinh)
      .pipe(finalize(() => this.isLoadingData = false))
      .subscribe({
        next: (districts) => {
          this.danhSachHuyen = districts.map(district => ({
            ma: district.ma,
            ten: district.ten,
            maTinh: district.ma_tinh
          }));
          this.huyenTheoTinh = this.danhSachHuyen;
          this.traCuuVNPostForm.patchValue({ maHuyen: null, maXa: null });
          this.xaTheoHuyen = [];
        },
        error: (err) => {
          console.error(`Lỗi khi lấy danh sách quận/huyện cho tỉnh ${maTinh}:`, err);
          this.message.error('Không thể tải danh sách quận/huyện. Vui lòng thử lại sau.');
          this.huyenTheoTinh = [];
        }
      });
  }

  onHuyenChange(maHuyen: string): void {
    if (!maHuyen) {
      this.xaTheoHuyen = [];
      this.traCuuVNPostForm.patchValue({ maXa: null });
      return;
    }

    this.isLoadingData = true;
    this.locationService.getCommunes(maHuyen)
      .pipe(finalize(() => this.isLoadingData = false))
      .subscribe({
        next: (response) => {
          if (response && response.success && response.data) {
            this.danhSachXa = response.data.map(commune => ({
              ma: commune.ma,
              ten: commune.ten,
              maHuyen: commune.ma_huyen
            }));
            this.xaTheoHuyen = this.danhSachXa;
          } else {
            this.xaTheoHuyen = [];
          }
          this.traCuuVNPostForm.patchValue({ maXa: null });
        },
        error: (err) => {
          console.error(`Lỗi khi lấy danh sách xã/phường cho huyện ${maHuyen}:`, err);
          this.message.error('Không thể tải danh sách xã/phường. Vui lòng thử lại sau.');
          this.xaTheoHuyen = [];
        }
      });
  }

  submitVNPostForm(): void {
    if (this.traCuuVNPostForm.valid) {
      this.isLoading = true;
      this.daTimKiem = true;
      this.loiTraCuu = '';
      
      // Kiểm tra token VNPost
      const token = this.ssmv2Service.getToken();
      if (!token) {
        // Tự động đăng nhập VNPost thay vì hiển thị thông báo
        this.autoLoginVNPost(true);
        return;
      }
      
      // Lấy dữ liệu từ form
      const formData: TraCuuVNPostRequest = {
        maTinh: this.traCuuVNPostForm.value.maTinh,
        maHuyen: this.traCuuVNPostForm.value.maHuyen,
        maXa: this.traCuuVNPostForm.value.maXa || '',
        hoTen: this.traCuuVNPostForm.value.hoTen || '',
        ngaySinh: this.traCuuVNPostForm.value.ngaySinh ? this.formatDate(this.traCuuVNPostForm.value.ngaySinh) : '',
        soCMND: this.traCuuVNPostForm.value.soCMND || ''
      };
      
      console.log('Dữ liệu gửi đi:', formData);
      console.log('Ngày sinh gốc:', this.traCuuVNPostForm.value.ngaySinh);
      console.log('Ngày sinh đã format:', formData.ngaySinh);
      
      // Gọi API tra cứu VNPost
      this.bhxhService.traCuuMaSoBHXHVNPost(formData)
        .subscribe({
          next: (res: any) => {
            this.isLoading = false;
            
            // Log response để debug
            console.log('Response từ API VNPost:', res);
            
            // Kiểm tra nếu response có chứa thông báo lỗi xác thực
            if (res && res.error === 'Lỗi xác thực') {
              this.ketQuaTraCuu = [];
              this.loiTraCuu = 'Lỗi xác thực: ' + (res.error_description || 'Không tìm thấy thông tin phiên đăng nhập');
              this.message.error(this.loiTraCuu);
              
              // Hiển thị form đăng nhập lại
              this.ssmv2Service.clearToken();
              this.message.warning('Vui lòng đăng nhập lại để tiếp tục');
              this.showVNPostLogin();
              return;
            }
            
            // Kiểm tra nếu response có status khác 200
            if (res && res.status && res.status !== 200) {
              this.ketQuaTraCuu = [];
              this.loiTraCuu = res.message || 'Có lỗi xảy ra khi tra cứu';
              this.message.error(this.loiTraCuu);
              return;
            }
            
            // Xử lý dữ liệu trả về
            if (res && res.success && res.data && res.data.length > 0) {
              // Xử lý tất cả kết quả thay vì chỉ kết quả đầu tiên
              this.ketQuaTraCuu = res.data.map((data: any) => ({
                maSoBHXH: data.maSoBhxh,
                hoTen: data.hoTen,
                ngaySinh: this.parseNgaySinh(data.ngaySinh, data.ngaySinhDt),
                gioiTinh: data.gioiTinh,
                soCCCD: data.soCmnd,
                diaChi: data.diaChi,
                trangThai: data.trangThai,
                maHo: data.maHo
              }));
              
              this.message.success(`Tra cứu thành công: Tìm thấy ${this.ketQuaTraCuu.length} kết quả`);
            } else {
              this.ketQuaTraCuu = [];
              this.loiTraCuu = 'Không tìm thấy thông tin mã số BHXH';
              this.message.warning(this.loiTraCuu);
            }
          },
          error: (err: any) => {
            this.isLoading = false;
            this.ketQuaTraCuu = [];
            
            console.error('Lỗi khi tra cứu:', err);
            
            if (err.error === 'Lỗi xác thực') {
              this.loiTraCuu = 'Lỗi xác thực: ' + (err.error_description || 'Phiên làm việc đã hết hạn');
              this.message.error(this.loiTraCuu);
              this.ssmv2Service.clearToken();
              this.showVNPostLogin();
            } else {
              this.loiTraCuu = 'Đã xảy ra lỗi khi tra cứu: ' + (err.error?.message || err.message || 'Vui lòng thử lại sau');
              this.message.error(this.loiTraCuu);
            }
          }
        });
    } else {
      Object.values(this.traCuuVNPostForm.controls).forEach(control => {
        if (control.invalid) {
          control.markAsDirty();
          control.updateValueAndValidity();
        }
      });
    }
  }

  resetForm(): void {
    this.traCuuVNPostForm.reset();
    this.huyenTheoTinh = [];
    this.xaTheoHuyen = [];
    this.ketQuaTraCuu = [];
    this.daTimKiem = false;
    this.loiTraCuu = '';
  }

  private formatDate(date: Date | string): string {
    if (!date) return '';
    
    // Nếu là chuỗi có định dạng dd/MM/yyyy
    if (typeof date === 'string' && date.includes('/')) {
      // Chuyển đổi từ dd/MM/yyyy sang yyyy-MM-dd
      const datePattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
      const match = date.match(datePattern);
      if (match) {
        const [_, day, month, year] = match;
        return `${year}-${month}-${day}`;
      }
    }
    
    // Nếu là đối tượng Date
    const dateObj = typeof date === 'string' ? new Date(date) : date;
    if (isNaN(dateObj.getTime())) return '';
    
    const day = dateObj.getDate().toString().padStart(2, '0');
    const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
    const year = dateObj.getFullYear();
    
    // Trả về định dạng yyyy-MM-dd
    return `${year}-${month}-${day}`;
  }

  private mapVNPostResponseToData(data: any): any {
    if (!data) return null;
    
    // Ánh xạ dữ liệu từ API VNPost sang định dạng dữ liệu của ứng dụng
    return {
      maSoBHXH: data.maSoBHXH || '',
      hoTen: data.hoTen || '',
      ngaySinh: data.ngaySinh || '',
      gioiTinh: data.gioiTinh || '',
      soCCCD: data.soCMND || '',
      diaChi: data.diaChi || '',
      trangThai: data.trangThai || 'active',
      ngayCap: data.ngayCap || new Date().toISOString()
    };
  }

  filterOption = (input: string, option: NzSelectItemInterface): boolean => {
    const label = (option.nzLabel?.toString() || '').toLowerCase();
    const searchText = input.toLowerCase();
    return (
      label.includes(searchText) || 
      this.removeVietnameseTones(label).includes(this.removeVietnameseTones(searchText))
    );
  };

  private removeVietnameseTones(str: string): string {
    if (!str) return '';
    str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g, 'a');
    str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g, 'e');
    str = str.replace(/ì|í|ị|ỉ|ĩ/g, 'i');
    str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g, 'o');
    str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g, 'u');
    str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g, 'y');
    str = str.replace(/đ/g, 'd');
    str = str.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g, 'A');
    str = str.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g, 'E');
    str = str.replace(/Ì|Í|Ị|Ỉ|Ĩ/g, 'I');
    str = str.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g, 'O');
    str = str.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g, 'U');
    str = str.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g, 'Y');
    str = str.replace(/Đ/g, 'D');
    return str;
  }

  // Hiển thị form đăng nhập VNPost
  showVNPostLogin(): void {
    this.isVNPostLoginVisible = true;
    this.getCaptcha();
  }
  
  // Đóng form đăng nhập VNPost
  closeVNPostLogin(): void {
    this.isVNPostLoginVisible = false;
  }
  
  // Tải captcha
  getCaptcha(): void {
    this.ssmv2Service.getCaptcha().subscribe({
      next: (res) => {
        console.log('Captcha response:', res);
        if (res && res.data) {
          this.captchaImage = res.data.image;
          this.captchaCode = res.data.code;
        } else {
          this.message.error('Không nhận được dữ liệu captcha');
        }
      },
      error: (err) => {
        console.error('Captcha error:', err);
        this.message.error('Lỗi khi lấy captcha: ' + err.message);
      }
    });
  }
  
  // Đăng nhập VNPost
  handleLogin(): void {
    if (this.vnpostLoginForm.valid) {
      this.isLoadingLogin = true;
      
      const data = {
        grant_type: 'password',
        userName: this.vnpostLoginForm.get('userName')?.value,
        password: this.vnpostLoginForm.get('password')?.value,
        text: this.vnpostLoginForm.get('text')?.value,
        code: this.captchaCode,
        clientId: 'ZjRiYmI5ZTgtZDcyOC00ODRkLTkyOTYtMDNjYmUzM2U4Yjc5',
        isWeb: true
      };

      console.log('Gửi request đăng nhập với data:', { ...data, password: '***' });

      this.ssmv2Service.authenticate(data).subscribe({
        next: (response) => {
          this.isLoadingLogin = false;
          
          if (response.body?.access_token) {
            console.log('Xác thực thành công, token hết hạn sau:', response.body.expires_in, 'giây');
            this.message.success('Xác thực thành công');
            this.isVNPostLoginVisible = false;
            
            // Đảm bảo token đã được lưu trước khi tìm kiếm
            setTimeout(() => {
              this.submitVNPostForm();
            }, 1000);
          } else {
            this.message.error('Không nhận được token');
            this.getCaptcha();
          }
        },
        error: (err) => {
          console.error('Login error:', err);
          this.isLoadingLogin = false;
          this.vnpostLoginForm.patchValue({ text: '' });

          if (err.error?.error === 'invalid_captcha') {
            this.message.error('Mã xác thực sai');
          } else if (err.error?.error_description?.includes('xác thực')) {
            this.message.error('Mã xác thực sai');
          } else if (err.error?.message) {
            this.message.error(err.error.message);
          } else {
            this.message.error('Xác thực thất bại, vui lòng thử lại');
          }

          setTimeout(() => {
            this.getCaptcha();
          }, 100);
        }
      });
    } else {
      Object.values(this.vnpostLoginForm.controls).forEach(control => {
        if (control.invalid) {
          control.markAsTouched();
          control.updateValueAndValidity();
        }
      });
    }
  }

  // Chuyển đổi chữ thành chữ hoa
  convertToUpperCase(event: Event): void {
    const input = event.target as HTMLInputElement;
    input.value = input.value.toUpperCase();
    this.vnpostLoginForm.get('text')?.setValue(input.value);
  }

  // Thêm phương thức để xử lý ngày sinh
  private parseNgaySinh(ngaySinhStr: string, ngaySinhDt: string): Date {
    if (ngaySinhDt) {
      return new Date(ngaySinhDt);
    }
    
    if (ngaySinhStr) {
      // Chuyển đổi chuỗi ngày sinh dạng 'YYYYMMDD' thành Date
      const year = parseInt(ngaySinhStr.substring(0, 4));
      const month = parseInt(ngaySinhStr.substring(4, 6)) - 1; // Tháng trong JS bắt đầu từ 0
      const day = parseInt(ngaySinhStr.substring(6, 8));
      return new Date(year, month, day);
    }
    
    return new Date();
  }

  // Kiểm tra trạng thái đăng nhập VNPost
  isVNPostLoggedIn(): boolean {
    return !!this.ssmv2Service.getToken();
  }

  // Xử lý nhập ngày sinh trực tiếp
  onDateInputChange(event: Event): void {
    const input = event.target as HTMLInputElement;
    const value = input.value;
    
    // Nếu người dùng đang nhập, không làm gì cả
    if (value.length < 10) return;
    
    // Kiểm tra định dạng dd/MM/yyyy
    const datePattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
    const match = value.match(datePattern);
    
    if (match) {
      const day = parseInt(match[1], 10);
      const month = parseInt(match[2], 10) - 1; // Tháng trong JS bắt đầu từ 0
      const year = parseInt(match[3], 10);
      
      const date = new Date(year, month, day);
      
      // Kiểm tra tính hợp lệ của ngày
      if (
        date.getDate() === day &&
        date.getMonth() === month &&
        date.getFullYear() === year
      ) {
        // Ngày hợp lệ, cập nhật giá trị form
        this.traCuuVNPostForm.patchValue({ ngaySinh: date });
      } else {
        // Ngày không hợp lệ
        this.message.warning('Ngày sinh không hợp lệ. Vui lòng nhập theo định dạng dd/MM/yyyy');
      }
    } else {
      // Định dạng không đúng
      this.message.warning('Vui lòng nhập ngày sinh theo định dạng dd/MM/yyyy');
    }
  }

  // Thêm phương thức xem chi tiết
  xemChiTiet(item: any): void {
    this.chiTietItem = item;
    this.isModalVisible = true;
  }

  // Đóng modal chi tiết
  closeModal(): void {
    this.isModalVisible = false;
  }

  // Thêm phương thức tự động đăng nhập VNPost
  autoLoginVNPost(fromSubmit: boolean = false): void {
    // Lấy captcha
    this.ssmv2Service.getCaptcha().subscribe({
      next: (res) => {
        if (res && res.data) {
          this.captchaImage = res.data.image;
          this.captchaCode = res.data.code;
          
          // Thực hiện đăng nhập tự động
          const data = {
            grant_type: 'password',
            userName: this.vnpostLoginForm.get('userName')?.value,
            password: this.vnpostLoginForm.get('password')?.value,
            text: this.captchaCode, // Sử dụng mã captcha làm text
            code: this.captchaCode,
            clientId: 'ZjRiYmI5ZTgtZDcyOC00ODRkLTkyOTYtMDNjYmUzM2U4Yjc5',
            isWeb: true
          };

          this.ssmv2Service.authenticate(data).subscribe({
            next: (response) => {
              if (response.body?.access_token) {
                console.log('Tự động xác thực thành công');
                
                // Chỉ thực hiện tìm kiếm nếu đăng nhập từ quá trình submit form
                if (fromSubmit) {
                  setTimeout(() => {
                    this.submitVNPostForm();
                  }, 1000);
                }
              } else {
                if (fromSubmit) {
                  this.isLoading = false;
                }
              }
            },
            error: (err) => {
              console.error('Lỗi tự động đăng nhập:', err);
              if (fromSubmit) {
                this.isLoading = false;
                this.showVNPostLogin(); // Hiển thị form đăng nhập nếu tự động đăng nhập thất bại
              }
            }
          });
        } else {
          if (fromSubmit) {
            this.isLoading = false;
          }
        }
      },
      error: (err) => {
        console.error('Lỗi khi lấy captcha:', err);
        if (fromSubmit) {
          this.isLoading = false;
          this.showVNPostLogin(); // Hiển thị form đăng nhập nếu không lấy được captcha
        }
      }
    });
  }
}
````

## File: WebApp.Client/src/app/tra-cuu/tra-cuu-thong-tin-bhxh/tra-cuu-thong-tin-bhxh.component.html
````html
<div class="container">
  <nz-card nzTitle="Tra cứu thông tin BHXH" [nzExtra]="extraTemplate">
    <form nz-form [formGroup]="traCuuBHXHForm" (ngSubmit)="submitBHXHForm()">
      
      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Mã số BHXH</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng nhập mã số BHXH (phải có 10 chữ số)">
          <div class="input-with-button">
            <input 
              nz-input 
              formControlName="maSoBHXH" 
              placeholder="Nhập mã số BHXH (10 chữ số)" 
              (input)="formatMaSoBHXH($event)" 
              maxlength="10" 
            />
          </div>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-control [nzOffset]="6" [nzSpan]="14">
          <button nz-button nzType="primary" [disabled]="isLoading">
            <i nz-icon nzType="search" *ngIf="!isLoading"></i>
            <i nz-icon nzType="loading" *ngIf="isLoading"></i>
            Tra cứu
          </button>
          <button nz-button (click)="resetForm()" style="margin-left: 8px;">
            <i nz-icon nzType="clear"></i>
            Xóa
          </button>
        </nz-form-control>
      </nz-form-item>
    </form>

    <ng-container *ngIf="daTimKiem">
      <nz-divider></nz-divider>
      
      <div *ngIf="isLoading" class="loading-container">
        <nz-spin nzTip="Đang tra cứu..."></nz-spin>
      </div>

      <div *ngIf="!isLoading && loiTraCuu" class="error-container">
        <nz-alert nzType="error" [nzMessage]="loiTraCuu" nzShowIcon></nz-alert>
      </div>

      <div *ngIf="!isLoading && !loiTraCuu && ketQuaTraCuu" class="result-container">
        <h3>Thông tin BHXH</h3>
        
        <!-- Thông tin cá nhân -->
        <div class="info-section bhxh-info">
          <h4>Thông tin cá nhân</h4>
          <nz-descriptions [nzColumn]="{ xxl: 2, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }">
            <nz-descriptions-item nzTitle="Mã số BHXH">{{ ketQuaTraCuu.maSoBHXH }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Họ và tên">{{ ketQuaTraCuu.hoTen }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Ngày sinh">{{ ketQuaTraCuu.ngaySinh | date:'dd/MM/yyyy' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Giới tính">{{ ketQuaTraCuu.gioiTinh || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Số điện thoại">{{ ketQuaTraCuu.dienThoai || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Mã hộ gia đình">{{ ketQuaTraCuu.maHo || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Dân tộc">{{ ketQuaTraCuu.danToc || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Quốc tịch">{{ ketQuaTraCuu.quocTich || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Nơi đăng ký khai sinh" *ngIf="ketQuaTraCuu.noiDangKyKhaiSinh" [nzSpan]="2">{{ ketQuaTraCuu.noiDangKyKhaiSinh }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Nơi cư trú" *ngIf="ketQuaTraCuu.noiCuTru" [nzSpan]="2">{{ ketQuaTraCuu.noiCuTru }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Tham gia BHXH bắt buộc">
              <span [ngClass]="ketQuaTraCuu.thamGiaBB === 'Có' ? 'status-active' : 'status-inactive'">
                {{ ketQuaTraCuu.thamGiaBB || 'Không' }}
              </span>
            </nz-descriptions-item>
            <nz-descriptions-item nzTitle="Trạng thái" *ngIf="ketQuaTraCuu.trangThai">
              <nz-tag [nzColor]="ketQuaTraCuu.trangThai === 'Đã duyệt' ? 'green' : 'red'">
                {{ ketQuaTraCuu.trangThai || 'Chưa xác định' }}
              </nz-tag>
            </nz-descriptions-item>
          </nz-descriptions>
        </div>
        
        <!-- Thông tin đóng BHXH tự nguyện -->
        <div *ngIf="ketQuaTraCuu.phuongAn" class="info-section bhxh-info mt-15">
          <h4>Thông tin đóng BHXH tự nguyện</h4>
          <nz-descriptions [nzColumn]="{ xxl: 2, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }">
            <nz-descriptions-item nzTitle="Đơn vị BHXH">{{ ketQuaTraCuu.tenDonViBHXH || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Mã đơn vị BHXH">{{ ketQuaTraCuu.maDonViBHXH || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Đơn vị thu">{{ ketQuaTraCuu.tenDonViThu || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Mã đơn vị thu">{{ ketQuaTraCuu.maDonViThu || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Ngày đăng ký">{{ ketQuaTraCuu.ngayDangKy || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Tháng bắt đầu">{{ ketQuaTraCuu.thangBatDau || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Phương thức đóng">{{ ketQuaTraCuu.phuongThucDong || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Phương án đóng">{{ ketQuaTraCuu.phuongAn || 'Không có' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Mức đóng">{{ ketQuaTraCuu.mucDong || '0 VND' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Số phải thu">{{ ketQuaTraCuu.soPhaiThu || '0 VND' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Người LĐ phải nộp">{{ ketQuaTraCuu.tienNLDPhaiNop || '0 VND' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="NSNN hỗ trợ">{{ ketQuaTraCuu.tienNSNNHoTro || '0 VND' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Tiền lãi">{{ ketQuaTraCuu.tienLai || '0 VND' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Tiền thừa">{{ ketQuaTraCuu.tienThua || '0 VND' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Tiền nộp">{{ ketQuaTraCuu.tienNop || '0 VND' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Loại tiền">{{ ketQuaTraCuu.loaiTien || 'VND' }}</nz-descriptions-item>
            <nz-descriptions-item nzTitle="Tái tục">{{ ketQuaTraCuu.taiTuc || 'Không' }}</nz-descriptions-item>
          </nz-descriptions>
        </div>
        
        <!-- Nút xem chi tiết BHXH -->
        <button nz-button nzType="primary" (click)="xemChiTietBHXH()" style="margin-top: 15px;">
          <i nz-icon nzType="file-search"></i>
          Xem chi tiết BHXH
        </button>
      </div>
    </ng-container>
  </nz-card>
</div>

<ng-template #extraTemplate>
  <button nz-button nzType="link">
    <i nz-icon nzType="question-circle" nzTheme="outline"></i>
    Hướng dẫn
  </button>
</ng-template>

<!-- Modal xem chi tiết BHXH -->
<nz-modal [(nzVisible)]="isModalVisible" nzTitle="Chi tiết thông tin BHXH" (nzOnCancel)="closeModal()" [nzFooter]="null" [nzWidth]="800">
  <ng-container *nzModalContent>
    <nz-tabset>
      <nz-tab nzTitle="Thông tin cá nhân">
        <nz-descriptions *ngIf="chiTietItem" nzBordered [nzColumn]="{ xxl: 2, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }">
          <nz-descriptions-item nzTitle="Mã số BHXH">{{ chiTietItem.maSoBHXH }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Họ và tên">{{ chiTietItem.hoTen }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Ngày sinh">{{ chiTietItem.ngaySinh | date:'dd/MM/yyyy' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Giới tính">{{ chiTietItem.gioiTinh || 'Không có' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Số CCCD/CMND" *ngIf="chiTietItem.soCCCD">{{ chiTietItem.soCCCD }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Số điện thoại">{{ chiTietItem.dienThoai || 'Không có' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Dân tộc">{{ chiTietItem.danToc || 'Không có' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Quốc tịch">{{ chiTietItem.quocTich || 'Không có' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Tham gia BHXH bắt buộc">
            <span [ngClass]="chiTietItem.thamGiaBB === 'Có' ? 'status-active' : 'status-inactive'">
              {{ chiTietItem.thamGiaBB || 'Không' }}
            </span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Trạng thái" *ngIf="chiTietItem.trangThai">
            <nz-tag [nzColor]="chiTietItem.trangThai === 'Đã duyệt' ? 'green' : 'red'">
              {{ chiTietItem.trangThai || 'Chưa xác định' }}
            </nz-tag>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Mã hộ gia đình" *ngIf="chiTietItem.maHo">{{ chiTietItem.maHo }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Nơi làm việc" *ngIf="chiTietItem.noiLamViec">{{ chiTietItem.noiLamViec }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Chức vụ" *ngIf="chiTietItem.chucVu">{{ chiTietItem.chucVu }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Nơi đăng ký khai sinh" *ngIf="chiTietItem.noiDangKyKhaiSinh" [nzSpan]="2">{{ chiTietItem.noiDangKyKhaiSinh }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Nơi cư trú" *ngIf="chiTietItem.noiCuTru" [nzSpan]="2">{{ chiTietItem.noiCuTru }}</nz-descriptions-item>
        </nz-descriptions>
      </nz-tab>
      
      <nz-tab nzTitle="Thông tin đóng BHXH" *ngIf="chiTietItem && chiTietItem.phuongAn">
        <nz-descriptions *ngIf="chiTietItem" nzBordered [nzColumn]="{ xxl: 2, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }">
          <nz-descriptions-item nzTitle="Đơn vị BHXH">{{ chiTietItem.tenDonViBHXH || 'Không có' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Mã đơn vị BHXH">{{ chiTietItem.maDonViBHXH || 'Không có' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Đơn vị thu">{{ chiTietItem.tenDonViThu || 'Không có' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Mã đơn vị thu">{{ chiTietItem.maDonViThu || 'Không có' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Ngày đăng ký">{{ chiTietItem.ngayDangKy || 'Không có' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Tháng bắt đầu">{{ chiTietItem.thangBatDau || 'Không có' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Phương thức đóng">{{ chiTietItem.phuongThucDong || 'Không có' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Phương án đóng">{{ chiTietItem.phuongAn || 'Không có' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Mức đóng">{{ chiTietItem.mucDong || '0 VND' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Số phải thu">{{ chiTietItem.soPhaiThu || '0 VND' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Người LĐ phải nộp">{{ chiTietItem.tienNLDPhaiNop || '0 VND' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="NSNN hỗ trợ">{{ chiTietItem.tienNSNNHoTro || '0 VND' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Tiền lãi">{{ chiTietItem.tienLai || '0 VND' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Tiền thừa">{{ chiTietItem.tienThua || '0 VND' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Tiền nộp">{{ chiTietItem.tienNop || '0 VND' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Loại tiền">{{ chiTietItem.loaiTien || 'VND' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Tái tục">{{ chiTietItem.taiTuc || 'Không' }}</nz-descriptions-item>
        </nz-descriptions>
      </nz-tab>
      
      <nz-tab nzTitle="Dữ liệu gốc">
        <pre>{{ chiTietItem.raw | json }}</pre>
      </nz-tab>
    </nz-tabset>
  </ng-container>
</nz-modal>

<!-- Modal đăng nhập VNPost -->
<nz-modal
  [(nzVisible)]="isVNPostLoginVisible"
  [nzTitle]="'Xác thực captcha'"
  (nzOnCancel)="closeVNPostLogin()"
  (nzOnOk)="handleLogin()"
  [nzOkText]="'Xác nhận'"
  [nzCancelText]="'Hủy'"
  [nzOkLoading]="isLoadingLogin"
  nzWidth="400px">
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="vnpostLoginForm">
      <!-- Ẩn input tài khoản và mật khẩu -->
      <input type="hidden" formControlName="userName">
      <input type="hidden" formControlName="password">

      <nz-form-item>
        <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mã xác nhận">
          <div class="captcha-container">
            <img [src]="'data:image/png;base64,' + captchaImage" alt="captcha" 
              style="margin-bottom: 8px; max-width: 100%;" />
            <div class="input-with-button">
              <input nz-input 
                formControlName="text" 
                placeholder="Nhập mã xác nhận"
                (input)="convertToUpperCase($event)"
                maxlength="4" />
              <button 
                nz-button 
                nzType="default"
                class="refresh-button"
                (click)="getCaptcha(); $event.preventDefault()">
                <i nz-icon nzType="reload"></i>
              </button>
            </div>
          </div>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>
````

## File: WebApp.Client/src/app/tra-cuu/tra-cuu-thong-tin-bhxh/tra-cuu-thong-tin-bhxh.component.scss
````scss
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

:host ::ng-deep {
  .ant-card {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.09);
    border-radius: 8px;
  }

  .ant-btn-primary {
    background-color: #1890ff;
  }

  .ant-descriptions-item-label {
    font-weight: bold;
    color: #333;
  }

  .ant-select {
    width: 100%;
  }

  .ant-form-item-label > label {
    color: #333;
  }
}

.section-title {
  margin-top: 20px;
  margin-bottom: 10px;
  color: #1890ff;
  font-weight: 500;
  font-size: 18px;
}

.result-container {
  margin-top: 20px;
}

.result-card {
  margin-bottom: 20px;
  border-radius: 8px;
}

.loading-container {
  display: flex;
  justify-content: center;
  margin: 40px 0;
}

.error-container {
  margin: 20px 0;
}

.action-button {
  margin-right: 8px;
}

.detail-buttons {
  display: flex;
  justify-content: center;
  margin-top: 20px;
  margin-bottom: 20px;
}

.detail-button {
  margin: 0 10px;
}

.info-section {
  padding: 16px;
  background-color: #f9f9f9;
  border-radius: 8px;
  margin-bottom: 20px;
}

.the-bhyt-info {
  background-color: #f6ffed;
  border: 1px solid #b7eb8f;
}

.bhxh-info {
  background-color: #e6f7ff;
  border: 1px solid #91d5ff;
}

.status-tag {
  margin-left: 8px;
}

.valid-tag {
  color: #52c41a;
  background-color: #f6ffed;
  border-color: #b7eb8f;
}

.expired-tag {
  color: #f5222d;
  background-color: #fff1f0;
  border-color: #ffa39e;
}

.info-meta {
  margin-bottom: 4px;
  color: rgba(0, 0, 0, 0.45);
}

.input-with-button {
  display: flex;
  align-items: center;
  
  input {
    flex: 1;
  }
  
  button {
    margin-left: 8px;
  }
}

.captcha-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 10px;
}

.refresh-button {
  margin-left: 8px;
}

@media (max-width: 768px) {
  .container {
    padding: 10px;
  }
  
  .detail-buttons {
    flex-direction: column;
    
    .detail-button {
      margin: 5px 0;
    }
  }
}

.mt-15 {
  margin-top: 15px;
}

.status-active {
  color: #52c41a;
  font-weight: 500;
  padding: 2px 8px;
  background-color: #f6ffed;
  border-radius: 4px;
  border: 1px solid #b7eb8f;
}

.status-inactive {
  color: #595959;
  font-weight: 500;
  padding: 2px 8px;
  background-color: #f5f5f5;
  border-radius: 4px;
  border: 1px solid #d9d9d9;
}

h4 {
  font-size: 16px;
  color: #1890ff;
  margin-bottom: 10px;
  font-weight: 500;
  position: relative;
  padding-left: 10px;
  
  &::before {
    content: '';
    width: 4px;
    height: 16px;
    background-color: #1890ff;
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    border-radius: 2px;
  }
}
````

## File: WebApp.Client/src/app/tra-cuu/tra-cuu-thong-tin-bhxh/tra-cuu-thong-tin-bhxh.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { HttpClient } from '@angular/common/http';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzCardModule } from 'ng-zorro-antd/card';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzSpinModule } from 'ng-zorro-antd/spin';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzAlertModule } from 'ng-zorro-antd/alert';
import { NzDescriptionsModule } from 'ng-zorro-antd/descriptions';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { NzTabsModule } from 'ng-zorro-antd/tabs';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzTableModule } from 'ng-zorro-antd/table';
import { BHXHService, TraCuuThongTinBHXHRequest } from '../../services/tra-cuu-ma-so-bhxh.service';
import { finalize } from 'rxjs/operators';
import { SSMV2Service } from '../../services/ssmv2.service';

@Component({
  selector: 'app-tra-cuu-thong-tin-bhxh',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    NzFormModule,
    NzInputModule,
    NzButtonModule,
    NzCardModule,
    NzGridModule,
    NzSpinModule,
    NzAlertModule,
    NzDescriptionsModule,
    NzDividerModule,
    NzIconModule,
    NzTagModule,
    NzSelectModule,
    NzTabsModule,
    NzModalModule,
    NzTableModule
  ],
  templateUrl: './tra-cuu-thong-tin-bhxh.component.html',
  styleUrls: ['./tra-cuu-thong-tin-bhxh.component.scss']
})
export class TraCuuThongTinBHXHComponent implements OnInit {
  traCuuBHXHForm!: FormGroup;
  isLoading = false;
  daTimKiem = false;
  loiTraCuu = '';
  ketQuaTraCuu: any = null; // Kết quả tra cứu sẽ là một đối tượng 
  today: Date = new Date(); // Ngày hiện tại

  // Thêm thuộc tính SSMV2
  isVNPostLoginVisible = false;
  captchaImage = '';
  captchaCode = '';
  vnpostLoginForm!: FormGroup;
  isLoadingLogin = false;

  // Thêm thuộc tính cho modal chi tiết
  isModalVisible = false;
  chiTietItem: any = null;

  constructor(
    private fb: FormBuilder,
    private bhxhService: BHXHService,
    private message: NzMessageService,
    private ssmv2Service: SSMV2Service
  ) {}

  ngOnInit(): void {
    this.traCuuBHXHForm = this.fb.group({
      maSoBHXH: [null, [Validators.required, Validators.pattern(/^\d{10}$/)]]
    });

    // Khởi tạo form đăng nhập VNPost
    this.vnpostLoginForm = this.fb.group({
      userName: ['884000_xa_tli_phuoclt', [Validators.required]],
      password: ['123456d@D', [Validators.required]],
      text: ['', [
        Validators.required,
        Validators.minLength(4),
        Validators.maxLength(4)
      ]]
    });

    // Kiểm tra và tự động đăng nhập VNPost nếu chưa có token
    if (!this.ssmv2Service.getToken()) {
      setTimeout(() => {
        this.autoLoginVNPost();
      }, 500);
    }
  }

  submitBHXHForm(): void {
    if (this.traCuuBHXHForm.valid) {
      this.isLoading = true;
      this.daTimKiem = true;
      this.loiTraCuu = '';
      this.ketQuaTraCuu = null;
      
      // Kiểm tra token VNPost
      const token = this.ssmv2Service.getToken();
      if (!token) {
        // Tự động đăng nhập VNPost
        this.autoLoginVNPost(true);
        return;
      }
      
      // Lấy dữ liệu từ form
      const formData: TraCuuThongTinBHXHRequest = {
        maSoBHXH: this.traCuuBHXHForm.value.maSoBHXH
      };
      
      console.log('Dữ liệu gửi đi:', formData);
      
      // Gọi API tra cứu thông tin BHXH
      this.bhxhService.traCuuThongTinBHXH(formData)
        .subscribe({
          next: (res: any) => {
            console.log('Response từ API BHXH:', res);
            
            // Kiểm tra nếu response có chứa thông báo lỗi xác thực
            if (res && res.error === 'Lỗi xác thực') {
              this.ketQuaTraCuu = null;
              this.loiTraCuu = 'Lỗi xác thực: ' + (res.error_description || 'Không tìm thấy thông tin phiên đăng nhập');
              this.message.error(this.loiTraCuu);
              
              // Hiển thị form đăng nhập lại
              this.ssmv2Service.clearToken();
              this.message.warning('Vui lòng đăng nhập lại để tiếp tục');
              this.showVNPostLogin();
              this.isLoading = false;
              return;
            }
            
            // Kiểm tra nếu response có status khác 200
            if (res && res.status && res.status !== 200) {
              this.ketQuaTraCuu = null;
              this.loiTraCuu = res.message || 'Có lỗi xảy ra khi tra cứu';
              this.message.error(this.loiTraCuu);
              this.isLoading = false;
              return;
            }
            
            // Xử lý dữ liệu trả về
            if (res && res.success && res.data) {
              this.ketQuaTraCuu = this.formatThongTinBHXH(res.data);
              // Không gọi API thông tin thẻ nữa
              this.isLoading = false;
              this.message.success('Tra cứu thành công thông tin BHXH');
            } else {
              this.ketQuaTraCuu = null;
              this.loiTraCuu = 'Không tìm thấy thông tin BHXH';
              this.message.warning(this.loiTraCuu);
              this.isLoading = false;
            }
          },
          error: (err: any) => {
            this.isLoading = false;
            this.ketQuaTraCuu = null;
            
            console.error('Lỗi khi tra cứu:', err);
            
            if (err.error === 'Lỗi xác thực') {
              this.loiTraCuu = 'Lỗi xác thực: ' + (err.error_description || 'Phiên làm việc đã hết hạn');
              this.message.error(this.loiTraCuu);
              this.ssmv2Service.clearToken();
              this.showVNPostLogin();
            } else {
              this.loiTraCuu = 'Đã xảy ra lỗi khi tra cứu: ' + (err.error?.message || err.message || 'Vui lòng thử lại sau');
              this.message.error(this.loiTraCuu);
            }
          }
        });
    } else {
      Object.values(this.traCuuBHXHForm.controls).forEach(control => {
        if (control.invalid) {
          control.markAsDirty();
          control.updateValueAndValidity();
        }
      });
    }
  }

  // Xử lý định dạng dữ liệu thông tin BHXH
  private formatThongTinBHXH(data: any): any {
    return {
      maSoBHXH: data.maSoBhxh || data.maSoBHXH || '',
      hoTen: data.hoTen || '',
      ngaySinh: data.ngaySinhHienThi ? this.parseNgaySinhFromString(data.ngaySinhHienThi) : (data.ngaySinh ? this.parseNgaySinhFromNumber(data.ngaySinh) : null),
      gioiTinh: data.gioiTinhHienThi || (data.gioiTinh === 1 ? 'Nam' : (data.gioiTinh === 0 ? 'Nữ' : '')),
      soCCCD: data.cmnd || '',
      noiDangKyKhaiSinh: this.formatDiaChi(data.tenXaKs, data.tenHuyenKs, data.tenTinhKs),
      noiCuTru: this.formatDiaChi(data.tenXaNkq, data.tenHuyenNkq, data.tenTinhNkq),
      danToc: data.danTocHienThi || data.danToc || '',
      quocTich: data.quocTichHienThi || data.quocTich || 'Việt Nam',
      dienThoai: data.soDienThoai || '',
      trangThai: data.trangThai || '',
      maHo: data.maHoGiaDinh || '',
      noiLamViec: data.noiLamViec || '',
      chucVu: data.chucVu || '',
      
      // Thông tin đăng ký BHXH tự nguyện
      thangBatDau: data.thangBatDau || data.thangBd || '',
      ngayDangKy: data.ngayDk || (data.ngayDangKyDt ? this.formatDate(new Date(data.ngayDangKyDt)) : ''),
      phuongThucDong: data.phuongThucDong || '',
      phuongAn: data.phuongAn || '',
      mucDong: data.mucDong ? this.formatCurrency(data.mucDong) : '',
      soPhaiThu: data.soPhaiThu ? this.formatCurrency(data.soPhaiThu) : '',
      tienNLDPhaiNop: data.tienNldPhaiNop ? this.formatCurrency(data.tienNldPhaiNop) : '',
      tienNSNNHoTro: data.tienNsnnHoTro ? this.formatCurrency(data.tienNsnnHoTro) : '',
      tienLai: data.tienLai ? this.formatCurrency(data.tienLai) : '',
      tienThua: data.tienThua ? this.formatCurrency(data.tienThua) : '',
      tienNop: data.tienNop ? this.formatCurrency(data.tienNop) : '',
      loaiTien: data.loaiTien || 'VND',
      taiTuc: data.taiTuc === 'true' || data.taiTuc === true ? 'Có' : 'Không',
      
      // Thông tin đơn vị BHXH
      maDonViBHXH: data.maDmBhxh || '',
      tenDonViBHXH: data.tenDmBhxh || '',
      
      // Thông tin đơn vị thu
      maDonViThu: data.maDonVi || '',
      tenDonViThu: data.tenDonVi || '',
      
      // Thông tin tham gia BHXH bắt buộc
      isThamGiaBB: data.isThamGiaBB || false,
      thamGiaBB: data.thamGiaBB || 'Không',
      
      // Dữ liệu gốc
      raw: data
    };
  }

  // Tạo chuỗi địa chỉ từ xã, huyện, tỉnh
  private formatDiaChi(xa?: string, huyen?: string, tinh?: string): string {
    const parts = [xa, huyen, tinh].filter(Boolean);
    return parts.length > 0 ? parts.join(', ') : 'Không có';
  }

  resetForm(): void {
    this.traCuuBHXHForm.reset();
    this.ketQuaTraCuu = null;
    this.daTimKiem = false;
    this.loiTraCuu = '';
  }

  // Hiển thị form đăng nhập VNPost
  showVNPostLogin(): void {
    this.isVNPostLoginVisible = true;
    this.getCaptcha();
  }
  
  // Đóng form đăng nhập VNPost
  closeVNPostLogin(): void {
    this.isVNPostLoginVisible = false;
  }
  
  // Tải captcha
  getCaptcha(): void {
    this.ssmv2Service.getCaptcha().subscribe({
      next: (res) => {
        console.log('Captcha response:', res);
        if (res && res.data) {
          this.captchaImage = res.data.image;
          this.captchaCode = res.data.code;
        } else {
          this.message.error('Không nhận được dữ liệu captcha');
        }
      },
      error: (err) => {
        console.error('Captcha error:', err);
        this.message.error('Lỗi khi lấy captcha: ' + err.message);
      }
    });
  }
  
  // Đăng nhập VNPost
  handleLogin(): void {
    if (this.vnpostLoginForm.valid) {
      this.isLoadingLogin = true;
      
      const data = {
        grant_type: 'password',
        userName: this.vnpostLoginForm.get('userName')?.value,
        password: this.vnpostLoginForm.get('password')?.value,
        text: this.vnpostLoginForm.get('text')?.value,
        code: this.captchaCode,
        clientId: 'ZjRiYmI5ZTgtZDcyOC00ODRkLTkyOTYtMDNjYmUzM2U4Yjc5',
        isWeb: true
      };

      console.log('Gửi request đăng nhập với data:', { ...data, password: '***' });

      this.ssmv2Service.authenticate(data).subscribe({
        next: (response) => {
          this.isLoadingLogin = false;
          
          if (response.body?.access_token) {
            console.log('Xác thực thành công, token hết hạn sau:', response.body.expires_in, 'giây');
            this.message.success('Xác thực thành công');
            this.isVNPostLoginVisible = false;
            
            // Đảm bảo token đã được lưu trước khi tìm kiếm
            setTimeout(() => {
              this.submitBHXHForm();
            }, 1000);
          } else {
            this.message.error('Không nhận được token');
            this.getCaptcha();
          }
        },
        error: (err) => {
          console.error('Login error:', err);
          this.isLoadingLogin = false;
          this.vnpostLoginForm.patchValue({ text: '' });

          if (err.error?.error === 'invalid_captcha') {
            this.message.error('Mã xác thực sai');
          } else if (err.error?.error_description?.includes('xác thực')) {
            this.message.error('Mã xác thực sai');
          } else if (err.error?.message) {
            this.message.error(err.error.message);
          } else {
            this.message.error('Xác thực thất bại, vui lòng thử lại');
          }

          setTimeout(() => {
            this.getCaptcha();
          }, 100);
        }
      });
    } else {
      Object.values(this.vnpostLoginForm.controls).forEach(control => {
        if (control.invalid) {
          control.markAsTouched();
          control.updateValueAndValidity();
        }
      });
    }
  }

  // Chuyển đổi chữ thành chữ hoa
  convertToUpperCase(event: Event): void {
    const input = event.target as HTMLInputElement;
    input.value = input.value.toUpperCase();
    this.vnpostLoginForm.get('text')?.setValue(input.value);
  }

  // Kiểm tra trạng thái đăng nhập VNPost
  isVNPostLoggedIn(): boolean {
    return !!this.ssmv2Service.getToken();
  }

  // Xem chi tiết BHXH
  xemChiTietBHXH(): void {
    this.chiTietItem = this.ketQuaTraCuu;
    this.isModalVisible = true;
  }

  // Đóng modal chi tiết
  closeModal(): void {
    this.isModalVisible = false;
  }

  // Thêm phương thức tự động đăng nhập VNPost
  autoLoginVNPost(fromSubmit: boolean = false): void {
    // Lấy captcha
    this.ssmv2Service.getCaptcha().subscribe({
      next: (res) => {
        if (res && res.data) {
          this.captchaImage = res.data.image;
          this.captchaCode = res.data.code;
          
          // Thực hiện đăng nhập tự động
          const data = {
            grant_type: 'password',
            userName: this.vnpostLoginForm.get('userName')?.value,
            password: this.vnpostLoginForm.get('password')?.value,
            text: this.captchaCode, // Sử dụng mã captcha làm text
            code: this.captchaCode,
            clientId: 'ZjRiYmI5ZTgtZDcyOC00ODRkLTkyOTYtMDNjYmUzM2U4Yjc5',
            isWeb: true
          };

          this.ssmv2Service.authenticate(data).subscribe({
            next: (response) => {
              if (response.body?.access_token) {
                console.log('Tự động xác thực thành công');
                
                // Chỉ thực hiện tìm kiếm nếu đăng nhập từ quá trình submit form
                if (fromSubmit) {
                  setTimeout(() => {
                    this.submitBHXHForm();
                  }, 1000);
                }
              } else {
                if (fromSubmit) {
                  this.isLoading = false;
                }
              }
            },
            error: (err) => {
              console.error('Lỗi tự động đăng nhập:', err);
              if (fromSubmit) {
                this.isLoading = false;
                this.showVNPostLogin(); // Hiển thị form đăng nhập nếu tự động đăng nhập thất bại
              }
            }
          });
        } else {
          if (fromSubmit) {
            this.isLoading = false;
          }
        }
      },
      error: (err) => {
        console.error('Lỗi khi lấy captcha:', err);
        if (fromSubmit) {
          this.isLoading = false;
          this.showVNPostLogin(); // Hiển thị form đăng nhập nếu không lấy được captcha
        }
      }
    });
  }

  // Kiểm tra và định dạng số BHXH
  formatMaSoBHXH(event: Event): void {
    const input = event.target as HTMLInputElement;
    let value = input.value.replace(/\D/g, ''); // Chỉ giữ lại các chữ số
    
    if (value.length > 10) {
      value = value.substring(0, 10); // Giới hạn 10 chữ số
    }
    
    input.value = value;
    this.traCuuBHXHForm.get('maSoBHXH')?.setValue(value);
  }

  // Kiểm tra thẻ còn hạn hay không
  isTheConHan(denNgay: Date | null | undefined): boolean {
    if (!denNgay) return false;
    
    try {
      // Chuyển về cùng định dạng để so sánh
      const expireDate = new Date(denNgay);
      const today = new Date();
      
      // Reset giờ, phút, giây để chỉ so sánh ngày
      expireDate.setHours(0, 0, 0, 0);
      today.setHours(0, 0, 0, 0);
      
      return expireDate > today;
    } catch (error) {
      return false;
    }
  }

  // Phân tích chuỗi ngày sinh dạng dd/MM/yyyy
  private parseNgaySinhFromString(dateString: string): Date | null {
    if (!dateString) return null;
    
    const parts = dateString.split('/');
    if (parts.length !== 3) return null;
    
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10) - 1; // Tháng trong JavaScript bắt đầu từ 0
    const year = parseInt(parts[2], 10);
    
    return new Date(year, month, day);
  }
  
  // Phân tích chuỗi ngày sinh dạng yyyyMMdd
  private parseNgaySinhFromNumber(dateNumber: string): Date | null {
    if (!dateNumber || dateNumber.length !== 8) return null;
    
    const year = parseInt(dateNumber.substring(0, 4), 10);
    const month = parseInt(dateNumber.substring(4, 6), 10) - 1;
    const day = parseInt(dateNumber.substring(6, 8), 10);
    
    return new Date(year, month, day);
  }
  
  // Định dạng số tiền
  private formatCurrency(value: number): string {
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
  }
  
  // Định dạng ngày tháng
  private formatDate(date: Date): string {
    return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
  }
}
````

## File: WebApp.Client/src/app/tra-cuu/tra-cuu-thong-tin-bhyt/tra-cuu-thong-tin-bhyt.component.html
````html
<div class="container">
  <nz-card nzTitle="Tra cứu thông tin BHYT" [nzExtra]="extraTemplate">
    <form nz-form [formGroup]="traCuuBHYTForm" (ngSubmit)="submitBHYTForm()">
      
      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Mã số BHXH</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng nhập mã số BHXH (phải có 10 chữ số)">
          <div class="input-with-button">
            <input 
              nz-input 
              formControlName="maSoBHXH" 
              placeholder="Nhập mã số BHXH (10 chữ số)" 
              (input)="formatMaSoBHXH($event)" 
              maxlength="10" 
            />
          </div>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-control [nzOffset]="6" [nzSpan]="14">
          <button nz-button nzType="primary" [disabled]="isLoading">
            <i nz-icon nzType="search" *ngIf="!isLoading"></i>
            <i nz-icon nzType="loading" *ngIf="isLoading"></i>
            Tra cứu
          </button>
          <button nz-button (click)="resetForm()" style="margin-left: 8px;">
            <i nz-icon nzType="clear"></i>
            Xóa
          </button>
        </nz-form-control>
      </nz-form-item>
    </form>

    <ng-container *ngIf="daTimKiem">
      <nz-divider></nz-divider>
      
      <div *ngIf="isLoading" class="loading-container">
        <nz-spin nzTip="Đang tra cứu..."></nz-spin>
      </div>

      <div *ngIf="!isLoading && loiTraCuu" class="error-container">
        <nz-alert nzType="error" [nzMessage]="loiTraCuu" nzShowIcon></nz-alert>
      </div>

      <div *ngIf="!isLoading && !loiTraCuu && ketQuaTraCuu" class="result-container">
        <h3>Thông tin BHYT</h3>
        
        <div class="custom-tabs">
          <div class="tab-headers">
            <div class="tab-header active" (click)="activateTab('tab1')">Thông tin chung</div>
            <div class="tab-header" (click)="activateTab('tab2')">Thông tin đóng BHYT</div>
            <div class="tab-header" (click)="activateTab('tab3')">Thông tin khác</div>
          </div>
          
          <div class="tab-content">
            <!-- Tab 1: Thông tin chung -->
            <div class="tab-pane active" id="tab1">
              <div class="info-section bhyt-info">
                <h4>Thông tin thẻ BHYT</h4>
                <nz-descriptions [nzColumn]="{ xxl: 3, xl: 3, lg: 2, md: 2, sm: 1, xs: 1 }">
                  <nz-descriptions-item nzTitle="Số thẻ BHYT">{{ ketQuaTraCuu.soTheBhyt }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Mã số BHXH">{{ ketQuaTraCuu.maSoBhxh }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Họ và tên">{{ ketQuaTraCuu.hoTen }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Ngày sinh">{{ ketQuaTraCuu.ngaySinhHienThi }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Giới tính">{{ ketQuaTraCuu.gioiTinhHienThi }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Dân tộc/Quốc tịch">{{ ketQuaTraCuu.danTocHienThi }} / {{ ketQuaTraCuu.quocTichHienThi }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Số điện thoại">{{ ketQuaTraCuu.soDienThoai || 'Không có' }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Số CMND/CCCD">{{ ketQuaTraCuu.soCmnd || 'Không có' }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Trạng thái thẻ">
                    <nz-tag [nzColor]="ketQuaTraCuu.trangThaiThe === 'Thẻ hợp lệ' ? 'success' : 'error'">
                      {{ ketQuaTraCuu.trangThaiThe }}
                    </nz-tag>
                  </nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Thời hạn sử dụng">
                    {{ ketQuaTraCuu.tuNgayDt | date:'dd/MM/yyyy' }} - {{ ketQuaTraCuu.denNgayDt | date:'dd/MM/yyyy' }}
                    <nz-tag class="status-tag" 
                      [ngClass]="isTheConHan(ketQuaTraCuu.denNgay) ? 'valid-tag' : 'expired-tag'">
                      {{ isTheConHan(ketQuaTraCuu.denNgay) ? 'Còn hạn' : 'Hết hạn' }}
                    </nz-tag>
                  </nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Nơi đăng ký KCB">{{ ketQuaTraCuu.tenBenhVien }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Mã/Tên tỉnh KCB">{{ ketQuaTraCuu.tenTinhKCB }}</nz-descriptions-item>
                </nz-descriptions>
              </div>
            </div>

            <!-- Tab 2: Thông tin đóng BHYT -->
            <div class="tab-pane" id="tab2">
              <div class="info-section bhyt-rates">
                <h4>Thông tin đóng BHYT</h4>
                <nz-descriptions [nzColumn]="{ xxl: 3, xl: 3, lg: 2, md: 2, sm: 1, xs: 1 }">
                  <nz-descriptions-item nzTitle="Tỷ lệ đóng BHYT">{{ ketQuaTraCuu.tyLeBhyt }}%</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Tỷ lệ NSTW">{{ ketQuaTraCuu.tyLeNstw }}%</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Tỷ lệ NSNN">{{ ketQuaTraCuu.tyLeNsnn }}%</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Tỷ lệ NSDP">{{ ketQuaTraCuu.tyLeNsdp }}%</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Tỷ lệ khác">{{ ketQuaTraCuu.tyLeKhac }}%</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Mức lương TT">{{ ketQuaTraCuu.mucLuongTt | number:'1.0-0' }} VNĐ</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Mã đơn vị">{{ ketQuaTraCuu.maDvi }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Tên đơn vị">{{ ketQuaTraCuu.tenDvi }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Tên CQBH">{{ ketQuaTraCuu.tenCqbh }}</nz-descriptions-item>
                </nz-descriptions>
              </div>
            </div>

            <!-- Tab 3: Thông tin khác -->
            <div class="tab-pane" id="tab3">
              <div class="info-section bhyt-extra">
                <h4>Thông tin bổ sung</h4>
                <nz-descriptions [nzColumn]="{ xxl: 3, xl: 3, lg: 2, md: 2, sm: 1, xs: 1 }">
                  <nz-descriptions-item nzTitle="Phương án">{{ ketQuaTraCuu.phuongAn }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Ngày 5 năm">{{ ketQuaTraCuu.ngay5NamDt | date:'dd/MM/yyyy' }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Địa chỉ liên hệ">{{ ketQuaTraCuu.diaChiLh || 'Không có' }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Mã tỉnh LH">{{ ketQuaTraCuu.maTinhLh || 'Không có' }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Mã huyện LH">{{ ketQuaTraCuu.maHuyenLh || 'Không có' }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Mã xã LH">{{ ketQuaTraCuu.maXaLh || 'Không có' }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Ngày thẻ mới">{{ ketQuaTraCuu.tuNgayTheMoiDt | date:'dd/MM/yyyy' }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Mã bệnh viện">{{ ketQuaTraCuu.maBenhVien }}</nz-descriptions-item>
                  <nz-descriptions-item nzTitle="Mã BHXH">{{ ketQuaTraCuu.maBhxh }}</nz-descriptions-item>
                </nz-descriptions>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Nút xem chi tiết BHYT -->
        <button nz-button nzType="primary" (click)="xemChiTietBHYT()" style="margin-top: 15px;">
          <i nz-icon nzType="medicine-box"></i>
          Xem chi tiết BHYT
        </button>
      </div>
    </ng-container>
  </nz-card>
</div>

<ng-template #extraTemplate>
  <button nz-button nzType="link">
    <i nz-icon nzType="question-circle" nzTheme="outline"></i>
    Hướng dẫn
  </button>
</ng-template>

<!-- Modal xem chi tiết BHYT -->
<nz-modal [(nzVisible)]="isModalVisible" nzTitle="Chi tiết thông tin BHYT" (nzOnCancel)="closeModal()" [nzFooter]="null" [nzWidth]="800">
  <ng-container *nzModalContent>
    <nz-descriptions *ngIf="chiTietItem" nzBordered [nzColumn]="{ xxl: 2, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }">
      <nz-descriptions-item nzTitle="Số thẻ BHYT" [nzSpan]="1">{{ chiTietItem.soTheBhyt }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Mã số BHXH" [nzSpan]="1">{{ chiTietItem.maSoBhxh }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Họ và tên" [nzSpan]="1">{{ chiTietItem.hoTen }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Ngày sinh" [nzSpan]="1">{{ chiTietItem.ngaySinhHienThi }}</nz-descriptions-item>
      
      <nz-descriptions-item nzTitle="Giới tính" [nzSpan]="1">{{ chiTietItem.gioiTinhHienThi }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Dân tộc/Quốc tịch" [nzSpan]="1">{{ chiTietItem.danTocHienThi }} / {{ chiTietItem.quocTichHienThi }}</nz-descriptions-item>
      
      <nz-descriptions-item nzTitle="Số CMND/CCCD" [nzSpan]="1">{{ chiTietItem.soCmnd || 'Không có' }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Số điện thoại" [nzSpan]="1">{{ chiTietItem.soDienThoai || 'Không có' }}</nz-descriptions-item>
      
      <nz-descriptions-item nzTitle="Thời hạn sử dụng" [nzSpan]="2">
        {{ chiTietItem.tuNgayDt | date:'dd/MM/yyyy' }} - {{ chiTietItem.denNgayDt | date:'dd/MM/yyyy' }}
        <nz-tag [nzColor]="isTheConHan(chiTietItem.denNgay) ? 'success' : 'error'">
          {{ isTheConHan(chiTietItem.denNgay) ? 'Còn hạn' : 'Hết hạn' }}
        </nz-tag>
      </nz-descriptions-item>
      
      <nz-descriptions-item nzTitle="Ngày thẻ mới" [nzSpan]="1">{{ chiTietItem.tuNgayTheMoiDt | date:'dd/MM/yyyy' }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="Ngày 5 năm" [nzSpan]="1">{{ chiTietItem.ngay5NamDt | date:'dd/MM/yyyy' }}</nz-descriptions-item>
      
      <nz-descriptions-item nzTitle="Nơi đăng ký KCB" [nzSpan]="2">{{ chiTietItem.tenBenhVien }}</nz-descriptions-item>
      
      <nz-descriptions-item nzTitle="Địa chỉ liên hệ" [nzSpan]="2">{{ chiTietItem.diaChiLh || 'Không có' }}</nz-descriptions-item>
      
      <nz-descriptions-item nzTitle="Đơn vị" [nzSpan]="2">{{ chiTietItem.tenDvi }}</nz-descriptions-item>
      
      <nz-descriptions-item nzTitle="Cơ quan BHXH" [nzSpan]="2">{{ chiTietItem.tenCqbh }}</nz-descriptions-item>
      
      <nz-descriptions-item nzTitle="Tỷ lệ đóng BHYT" [nzSpan]="2">
        <div *ngIf="chiTietItem.tyLeBhyt > 0">BHYT: {{ chiTietItem.tyLeBhyt }}%</div>
        <div *ngIf="chiTietItem.tyLeNstw > 0">NSTW: {{ chiTietItem.tyLeNstw }}%</div>
        <div *ngIf="chiTietItem.tyLeNsnn > 0">NSNN: {{ chiTietItem.tyLeNsnn }}%</div>
        <div *ngIf="chiTietItem.tyLeNsdp > 0">NSDP: {{ chiTietItem.tyLeNsdp }}%</div>
        <div *ngIf="chiTietItem.tyLeKhac > 0">Khác: {{ chiTietItem.tyLeKhac }}%</div>
      </nz-descriptions-item>
      
      <nz-descriptions-item nzTitle="Trạng thái thẻ" [nzSpan]="2">
        <nz-tag [nzColor]="chiTietItem.trangThaiThe === 'Thẻ hợp lệ' ? 'success' : 'error'">
          {{ chiTietItem.trangThaiThe }}
        </nz-tag>
      </nz-descriptions-item>
    </nz-descriptions>
  </ng-container>
</nz-modal>

<!-- Modal đăng nhập VNPost -->
<nz-modal
  [(nzVisible)]="isVNPostLoginVisible"
  [nzTitle]="'Xác thực captcha'"
  (nzOnCancel)="closeVNPostLogin()"
  (nzOnOk)="handleLogin()"
  [nzOkText]="'Xác nhận'"
  [nzCancelText]="'Hủy'"
  [nzOkLoading]="isLoadingLogin"
  nzWidth="400px">
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="vnpostLoginForm">
      <!-- Ẩn input tài khoản và mật khẩu -->
      <input type="hidden" formControlName="userName">
      <input type="hidden" formControlName="password">

      <nz-form-item>
        <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mã xác nhận">
          <div class="captcha-container">
            <img [src]="'data:image/png;base64,' + captchaImage" alt="captcha" 
              style="margin-bottom: 8px; max-width: 100%;" />
            <div class="input-with-button">
              <input nz-input 
                formControlName="text" 
                placeholder="Nhập mã xác nhận"
                (input)="convertToUpperCase($event)"
                maxlength="4" />
              <button 
                nz-button 
                nzType="default"
                class="refresh-button"
                (click)="getCaptcha(); $event.preventDefault()">
                <i nz-icon nzType="reload"></i>
              </button>
            </div>
          </div>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>
````

## File: WebApp.Client/src/app/tra-cuu/tra-cuu-thong-tin-bhyt/tra-cuu-thong-tin-bhyt.component.scss
````scss
.container {
  padding: 24px;
  max-width: 1200px;
  margin: 0 auto;
}

.loading-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 200px;
}

.error-container {
  margin: 16px 0;
}

.result-container {
  margin-top: 24px;

  h3 {
    margin-bottom: 16px;
    color: #1890ff;
    font-weight: 500;
  }

  .info-section {
    margin-bottom: 24px;
    padding: 16px;
    background: #fafafa;
    border-radius: 4px;

    h4 {
      margin-bottom: 16px;
      color: #262626;
      font-weight: 500;
    }
  }

  .bhyt-info {
    border: 1px solid #e8e8e8;
  }
  
  .bhyt-rates {
    border: 1px solid #e8e8e8;
    background-color: #f6ffed;
  }
  
  .bhyt-extra {
    border: 1px solid #e8e8e8;
    background-color: #f9f0ff;
  }
}

.input-with-button {
  display: flex;
  gap: 8px;
  align-items: center;

  input {
    flex: 1;
  }

  .refresh-button {
    min-width: 40px;
  }
}

.captcha-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.status-tag {
  margin-left: 8px;
  
  &.valid-tag {
    background-color: #f6ffed;
    border-color: #b7eb8f;
    color: #52c41a;
  }
  
  &.expired-tag {
    background-color: #fff2f0;
    border-color: #ffccc7;
    color: #ff4d4f;
  }
}

/* Custom Tabs Styles */
.custom-tabs {
  margin-bottom: 24px;
  
  .tab-headers {
    display: flex;
    border-bottom: 1px solid #e8e8e8;
    margin-bottom: 16px;
    
    .tab-header {
      padding: 12px 16px;
      margin-right: 8px;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 2px solid transparent;
      
      &.active {
        color: #1890ff;
        border-bottom: 2px solid #1890ff;
        font-weight: 500;
      }
      
      &:hover:not(.active) {
        color: #40a9ff;
      }
    }
  }
  
  .tab-content {
    .tab-pane {
      display: none;
      
      &.active {
        display: block;
      }
    }
  }
}

:host ::ng-deep {
  .ant-descriptions-item-label {
    font-weight: 500;
  }

  .ant-modal-body {
    max-height: 70vh;
    overflow-y: auto;
  }
  
  .ant-tabs-tab {
    font-weight: 500;
  }
  
  .ant-tabs-content {
    padding-top: 16px;
  }
  
  nz-descriptions {
    margin-bottom: 16px;
  }
  
  .ant-tag {
    margin-right: 0;
  }
}
````

## File: WebApp.Client/src/app/tra-cuu/tra-cuu-thong-tin-bhyt/tra-cuu-thong-tin-bhyt.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzCardModule } from 'ng-zorro-antd/card';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzSpinModule } from 'ng-zorro-antd/spin';
import { NzMessageService } from 'ng-zorro-antd/message';
import { NzAlertModule } from 'ng-zorro-antd/alert';
import { NzDescriptionsModule } from 'ng-zorro-antd/descriptions';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzTabsModule } from 'ng-zorro-antd/tabs';
import { BHYTService, TraCuuThongTinBHYTRequest, TraCuuThongTinBHYTResponse } from '../../services/tra-cuu-thong-tin-bhyt.service';
import { SSMV2Service } from '../../services/ssmv2.service';

@Component({
  selector: 'app-tra-cuu-thong-tin-bhyt',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    NzFormModule,
    NzInputModule,
    NzButtonModule,
    NzCardModule,
    NzGridModule,
    NzSpinModule,
    NzAlertModule,
    NzDescriptionsModule,
    NzDividerModule,
    NzIconModule,
    NzTagModule,
    NzModalModule,
    NzTabsModule
  ],
  templateUrl: './tra-cuu-thong-tin-bhyt.component.html',
  styleUrls: ['./tra-cuu-thong-tin-bhyt.component.scss']
})
export class TraCuuThongTinBHYTComponent implements OnInit {
  traCuuBHYTForm!: FormGroup;
  isLoading = false;
  daTimKiem = false;
  loiTraCuu = '';
  ketQuaTraCuu: any = null;

  // Additional properties for SSMV2
  isVNPostLoginVisible = false;
  captchaImage = '';
  captchaCode = '';
  vnpostLoginForm!: FormGroup;
  isLoadingLogin = false;

  // Additional properties for detail modal
  isModalVisible = false;
  chiTietItem: any = null;

  constructor(
    private fb: FormBuilder,
    private bhytService: BHYTService,
    private message: NzMessageService,
    private ssmv2Service: SSMV2Service
  ) {}

  ngOnInit(): void {
    this.traCuuBHYTForm = this.fb.group({
      maSoBHXH: ['', [Validators.required, Validators.pattern(/^\d{10}$/)]]
    });

    this.vnpostLoginForm = this.fb.group({
      userName: ['ssmv2'],
      password: ['ssmv2@123'],
      text: ['', Validators.required]
    });

    // Kiểm tra và tự động đăng nhập VNPost nếu chưa có token
    if (!this.ssmv2Service.getToken()) {
      setTimeout(() => {
        this.autoLoginVNPost();
      }, 500);
    }
  }

  submitBHYTForm(): void {
    if (this.traCuuBHYTForm.invalid) {
      Object.values(this.traCuuBHYTForm.controls).forEach(control => {
        if (control.invalid) {
          control.markAsDirty();
          control.updateValueAndValidity({ onlySelf: true });
        }
      });
      return;
    }

    this.isLoading = true;
    this.daTimKiem = true;
    this.loiTraCuu = '';
    this.ketQuaTraCuu = null;

    const formData: TraCuuThongTinBHYTRequest = {
      maSoBHXH: this.traCuuBHYTForm.value.maSoBHXH
    };

    this.bhytService.traCuuThongTinBHYT(formData).subscribe({
      next: (response: TraCuuThongTinBHYTResponse) => {
        this.isLoading = false;
        if (response.success && response.data) {
          this.ketQuaTraCuu = response.data;
          this.message.success('Tra cứu thông tin BHYT thành công');
        } else {
          if (response.error && response.error.toString().includes('authenticat')) {
            this.getCaptcha();
            this.isVNPostLoginVisible = true;
          } else {
            this.loiTraCuu = response.message || 'Không tìm thấy thông tin thẻ BHYT';
          }
        }
      },
      error: (error: any) => {
        this.isLoading = false;
        if (error && error.error && error.error.includes('xác thực')) {
          this.getCaptcha();
          this.isVNPostLoginVisible = true;
        } else {
          this.loiTraCuu = error.error || 'Có lỗi xảy ra khi tra cứu thông tin BHYT';
        }
      }
    });
  }

  resetForm(): void {
    this.traCuuBHYTForm.reset();
    this.daTimKiem = false;
    this.loiTraCuu = '';
    this.ketQuaTraCuu = null;
  }

  formatMaSoBHXH(event: any): void {
    const input = event.target;
    let value = input.value.replace(/\D/g, '');
    if (value.length > 10) {
      value = value.substring(0, 10);
    }
    input.value = value;
    this.traCuuBHYTForm.controls['maSoBHXH'].setValue(value);
  }

  xemChiTietBHYT(): void {
    this.chiTietItem = this.ketQuaTraCuu;
    this.isModalVisible = true;
  }

  closeModal(): void {
    this.isModalVisible = false;
  }

  // SSMV2 login handlers
  getCaptcha(): void {
    this.ssmv2Service.getCaptcha().subscribe({
      next: (data: any) => {
        this.captchaImage = data.captchaBase64;
        this.captchaCode = data.captchaCode;
        this.vnpostLoginForm.get('text')?.setValue('');
      },
      error: (err: any) => {
        this.message.error('Không thể tải mã xác nhận');
      }
    });
  }

  handleLogin(): void {
    if (this.vnpostLoginForm.invalid) {
      Object.values(this.vnpostLoginForm.controls).forEach(control => {
        if (control.invalid) {
          control.markAsDirty();
          control.updateValueAndValidity({ onlySelf: true });
        }
      });
      return;
    }

    this.isLoadingLogin = true;
    this.ssmv2Service.authenticate(this.vnpostLoginForm.value).subscribe({
      next: (data: any) => {
        if (data && data.access_token) {
          localStorage.setItem('ssmv2_token', `Bearer ${data.access_token}`);
          this.isLoadingLogin = false;
          this.isVNPostLoginVisible = false;
          this.message.success('Đăng nhập thành công');
          // Retry search after login
          this.submitBHYTForm();
        } else {
          this.isLoadingLogin = false;
          this.message.error('Đăng nhập không thành công');
          this.getCaptcha();
        }
      },
      error: (err: any) => {
        this.isLoadingLogin = false;
        this.message.error('Đăng nhập không thành công');
        this.getCaptcha();
      }
    });
  }

  closeVNPostLogin(): void {
    this.isVNPostLoginVisible = false;
  }

  // Thêm phương thức hiển thị form đăng nhập VNPost
  showVNPostLogin(): void {
    this.isVNPostLoginVisible = true;
    this.getCaptcha();
  }

  // Phương thức kích hoạt tab
  activateTab(tabId: string): void {
    // Ẩn tất cả các tab và bỏ active
    document.querySelectorAll('.tab-pane').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-header').forEach(header => {
      header.classList.remove('active');
    });

    // Kích hoạt tab được chọn
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
      selectedTab.classList.add('active');
    }

    // Kích hoạt header tương ứng
    const tabIndex = tabId.replace('tab', '');
    const tabHeaders = document.querySelectorAll('.tab-header');
    if (tabHeaders.length >= parseInt(tabIndex)) {
      tabHeaders[parseInt(tabIndex) - 1].classList.add('active');
    }
  }

  convertToUpperCase(event: any): void {
    const value = event.target.value;
    this.vnpostLoginForm.get('text')?.setValue(value.toUpperCase());
  }

  // Helpers for display
  isTheConHan(denNgay: string): boolean {
    if (!denNgay) return false;

    // Xử lý chuỗi dạng yyyy-MM-dd
    if (denNgay.includes('-')) {
      return new Date(denNgay) > new Date();
    }

    // Xử lý chuỗi dạng yyyyMMdd
    if (denNgay.length === 8) {
      const year = parseInt(denNgay.substring(0, 4));
      const month = parseInt(denNgay.substring(4, 6)) - 1;
      const day = parseInt(denNgay.substring(6, 8));
      return new Date(year, month, day) > new Date();
    }

    return false;
  }

  formatTyLeDong(): string {
    const ketQua = this.ketQuaTraCuu;
    if (!ketQua) return 'Không có';

    let tyLe = '';
    if (ketQua.tyLeBhyt > 0) tyLe += `BHYT: ${ketQua.tyLeBhyt}%. `;
    if (ketQua.tyLeNstw > 0) tyLe += `NSTW: ${ketQua.tyLeNstw}%. `;
    if (ketQua.tyLeNsnn > 0) tyLe += `NSNN: ${ketQua.tyLeNsnn}%. `;
    if (ketQua.tyLeNsdp > 0) tyLe += `NSDP: ${ketQua.tyLeNsdp}%. `;
    if (ketQua.tyLeKhac > 0) tyLe += `Khác: ${ketQua.tyLeKhac}%.`;

    return tyLe || 'Không có';
  }

  // Thêm phương thức tự động đăng nhập VNPost
  autoLoginVNPost(fromSubmit: boolean = false): void {
    // Lấy captcha
    this.ssmv2Service.getCaptcha().subscribe({
      next: (res) => {
        if (res && res.data) {
          this.captchaImage = res.data.image;
          this.captchaCode = res.data.code;
          
          // Thực hiện đăng nhập tự động
          const data = {
            grant_type: 'password',
            userName: this.vnpostLoginForm.get('userName')?.value,
            password: this.vnpostLoginForm.get('password')?.value,
            text: this.captchaCode, // Sử dụng mã captcha làm text
            code: this.captchaCode,
            clientId: 'ZjRiYmI5ZTgtZDcyOC00ODRkLTkyOTYtMDNjYmUzM2U4Yjc5',
            isWeb: true
          };

          this.ssmv2Service.authenticate(data).subscribe({
            next: (response) => {
              if (response.body?.access_token) {
                console.log('Tự động xác thực thành công');
                
                // Chỉ thực hiện tìm kiếm nếu đăng nhập từ quá trình submit form
                if (fromSubmit) {
                  setTimeout(() => {
                    this.submitBHYTForm();
                  }, 1000);
                }
              } else {
                if (fromSubmit) {
                  this.isLoading = false;
                }
              }
            },
            error: (err) => {
              console.error('Lỗi tự động đăng nhập:', err);
              if (fromSubmit) {
                this.isLoading = false;
                this.showVNPostLogin(); // Hiển thị form đăng nhập nếu tự động đăng nhập thất bại
              }
            }
          });
        } else {
          if (fromSubmit) {
            this.isLoading = false;
          }
        }
      },
      error: (err) => {
        console.error('Lỗi khi lấy captcha:', err);
        if (fromSubmit) {
          this.isLoading = false;
          this.showVNPostLogin(); // Hiển thị form đăng nhập nếu không lấy được captcha
        }
      }
    });
  }
}
````

## File: WebApp.Client/src/app/tra-cuu/tra-cuu.routes.ts
````typescript
import { Routes } from '@angular/router';
import { TraCuuMaSoBhxhComponent } from './tra-cuu-ma-so-bhxh/tra-cuu-ma-so-bhxh.component';
import { TraCuuHoGiaDinhComponent } from './tra-cuu-ho-gia-dinh/tra-cuu-ho-gia-dinh.component';
import { TraCuuThongTinBHXHComponent } from './tra-cuu-thong-tin-bhxh/tra-cuu-thong-tin-bhxh.component';
import { TraCuuThongTinBHYTComponent } from './tra-cuu-thong-tin-bhyt/tra-cuu-thong-tin-bhyt.component';

export const traCuuRoutes: Routes = [
  {
    path: 'ma-so-bhxh',
    component: TraCuuMaSoBhxhComponent,
    title: 'Tra cứu mã số BHXH'
  },
  {
    path: 'ho-gia-dinh',
    component: TraCuuHoGiaDinhComponent,
    title: 'Tra cứu hộ gia đình'
  },
  {
    path: 'thong-tin-bhxh',
    component: TraCuuThongTinBHXHComponent,
    title: 'Tra cứu thông tin BHXH'
  },
  {
    path: 'thong-tin-bhyt',
    component: TraCuuThongTinBHYTComponent,
    title: 'Tra cứu thông tin BHYT'
  }
];
````

## File: WebApp.Client/src/app/users/users.component.html
````html
<div class="users-container">
  <div class="users-header">
    <h1>Quản lý người dùng</h1>
    <div class="header-actions">
      <button nz-button nzType="primary" nzDanger *ngIf="setOfCheckedId.size > 0" (click)="deleteSelectedNguoiDungs()">
        <span nz-icon nzType="delete"></span>
        Xóa {{ setOfCheckedId.size }} người dùng
      </button>
      <button nz-button (click)="loadNguoiDungs()" class="action-button">
        <span nz-icon nzType="reload"></span>
        Làm mới
      </button>
      <button nz-button nzType="primary" (click)="showAddModal()">
        <span nz-icon nzType="plus"></span>
        Thêm mới
      </button>
    </div>
  </div>

  <div class="filters-container">
    <div nz-row [nzGutter]="16" nzAlign="middle">
      <div nz-col [nzSpan]="8">
        <nz-input-group [nzSuffix]="searchIcon">
          <input nz-input placeholder="Tìm kiếm theo tên đăng nhập hoặc họ tên" [(ngModel)]="searchValue" (ngModelChange)="onSearch()" />
        </nz-input-group>
        <ng-template #searchIcon>
          <span nz-icon nzType="search"></span>
        </ng-template>
      </div>
      <div nz-col [nzSpan]="4">
        <nz-select [(ngModel)]="selectedRole" (ngModelChange)="onSearch()" nzPlaceHolder="Lọc theo vai trò" [nzAllowClear]="true" style="width: 100%">
          <nz-option *ngFor="let opt of roleOptions" [nzValue]="opt.value" [nzLabel]="opt.label"></nz-option>
        </nz-select>
      </div>
      <div nz-col [nzSpan]="4">
        <nz-select [(ngModel)]="selectedStatus" (ngModelChange)="onSearch()" nzPlaceHolder="Lọc theo trạng thái" [nzAllowClear]="true" style="width: 100%">
          <nz-option *ngFor="let opt of statusOptions" [nzValue]="opt.value" [nzLabel]="opt.label"></nz-option>
        </nz-select>
      </div>
    </div>
  </div>

  <nz-table #basicTable [nzData]="displayData" [nzLoading]="isLoading">
    <thead>
      <tr>
        <th [nzChecked]="checked"
            [nzIndeterminate]="indeterminate"
            (nzCheckedChange)="onAllChecked($event)"></th>
        <th>Tên đăng nhập</th>
        <th>Họ tên</th>
        <th>Email</th>
        <th>Số điện thoại</th>
        <th>Vai trò</th>
        <th>Đơn vị</th>
        <th>Trạng thái</th>
        <th>Thao tác</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let data of basicTable.data">
        <td [nzChecked]="setOfCheckedId.has(data.id)" 
            (nzCheckedChange)="onItemChecked(data.id, $event)"></td>
        <td>{{ data.userName }}</td>
        <td>{{ data.hoTen }}</td>
        <td>{{ data.email }}</td>
        <td>{{ data.soDienThoai }}</td>
        <td>
          <nz-tag *ngFor="let role of data.roles" [nzColor]="'blue'">
            {{ role | titlecase }}
          </nz-tag>
        </td>
        <td>{{ data.donViCongTac }}</td>
        <td>
          <nz-switch
            [ngModel]="data.status === 1"
            (ngModelChange)="onStatusChange(data.id, $event)"
            [nzLoading]="data.isStatusLoading"
            [nzDisabled]="data.isStatusLoading">
          </nz-switch>
        </td>
        <td>
          <button nz-button nzType="link" (click)="showEditModal(data)">
            <span nz-icon nzType="edit"></span>
          </button>
          <button nz-button nzType="link" nzDanger (click)="deleteNguoiDung(data)">
            <span nz-icon nzType="delete"></span>
          </button>
          <button nz-button nzType="link" (click)="resetPassword(data)">
            <span nz-icon nzType="key"></span>
          </button>
        </td>
      </tr>
    </tbody>
  </nz-table>

  <nz-modal
    [nzTitle]="editingNguoiDung ? 'Cập nhật người dùng' : 'Thêm người dùng'"
    [(nzVisible)]="isModalVisible"
    [nzWidth]="900"
    (nzOnCancel)="handleCancel()"
    [nzOkText]="editingNguoiDung ? 'Cập nhật' : 'Thêm mới'"
    nzCancelText="Hủy"
    (nzOnOk)="handleOk()"
    [nzOkLoading]="isLoading">
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="userForm" nzLayout="vertical">
        <input type="text" style="display:none">
        <input type="password" style="display:none">

        <div nz-row [nzGutter]="16">
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label nzRequired>Tên đăng nhập</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng nhập tên đăng nhập!">
                <nz-input-group [nzPrefix]="userIcon">
                  <input nz-input 
                         formControlName="userName" 
                         placeholder="Nhập tên đăng nhập"/>
                </nz-input-group>
                <ng-template #userIcon>
                  <span nz-icon nzType="user"></span>
                </ng-template>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label nzRequired>Họ và tên</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng nhập họ và tên!">
                <input nz-input formControlName="hoTen" placeholder="Nhập họ và tên" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Đơn vị công tác</nz-form-label>
              <nz-form-control>
                <nz-select formControlName="donViCongTac" nzShowSearch nzAllowClear style="width: 100%" nzPlaceHolder="Chọn đại lý">
                  <nz-option *ngFor="let daiLy of daiLys" [nzValue]="daiLy.ten" [nzLabel]="daiLy.ten"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Chức danh</nz-form-label>
              <nz-form-control>
                <nz-select formControlName="chucDanh" style="width: 100%" nzPlaceHolder="Chọn chức danh">
                  <nz-option *ngFor="let opt of chucDanhOptions" 
                            [nzValue]="opt.value" 
                            [nzLabel]="opt.label">
                  </nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Email</nz-form-label>
              <nz-form-control nzErrorTip="Email không hợp lệ!">
                <nz-input-group [nzPrefix]="emailIcon">
                  <input nz-input 
                         formControlName="email" 
                         placeholder="Nhập email"
                         type="email"
                         autocomplete="off" />
                </nz-input-group>
                <ng-template #emailIcon>
                  <span nz-icon nzType="mail"></span>
                </ng-template>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Số điện thoại</nz-form-label>
              <nz-form-control>
                <nz-input-group [nzPrefix]="phoneIcon">
                  <input nz-input formControlName="soDienThoai" placeholder="Nhập số điện thoại" />
                </nz-input-group>
                <ng-template #phoneIcon>
                  <span nz-icon nzType="phone"></span>
                </ng-template>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Super Admin</nz-form-label>
              <nz-form-control>
                <nz-switch formControlName="isSuperAdmin" *ngIf="isSuperAdmin"></nz-switch>
                <span *ngIf="!isSuperAdmin">Không có quyền</span>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Trạng thái</nz-form-label>
              <nz-form-control>
                <nz-select formControlName="status" style="width: 100%">
                  <nz-option [nzValue]="1" nzLabel="Hoạt động"></nz-option>
                  <nz-option [nzValue]="0" nzLabel="Không hoạt động"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Mã nhân viên</nz-form-label>
              <nz-form-control>
                <nz-input-group [nzPrefix]="userIcon">
                  <input nz-input formControlName="maNhanVien" placeholder="Nhập mã nhân viên"/>
                </nz-input-group>
                <ng-template #userIcon>
                  <span nz-icon nzType="idcard"></span>
                </ng-template>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label [nzRequired]="!editingNguoiDung">Mật khẩu</nz-form-label>
              <nz-form-control [nzErrorTip]="passwordErrorTpl">
                <nz-input-group [nzPrefix]="lockIcon" [nzSuffix]="suffixIcon">
                  <input nz-input
                         [type]="passwordVisible ? 'text' : 'password'"
                         formControlName="password"
                         placeholder="Nhập mật khẩu"
                         autocomplete="new-password" />
                </nz-input-group>
                <ng-template #lockIcon>
                  <span nz-icon nzType="lock"></span>
                </ng-template>
                <ng-template #suffixIcon>
                  <span nz-icon 
                        [nzType]="passwordVisible ? 'eye' : 'eye-invisible'"
                        (click)="passwordVisible = !passwordVisible">
                  </span>
                </ng-template>
              </nz-form-control>
              <ng-template #passwordErrorTpl let-control>
                <ng-container *ngIf="control.hasError('required')">
                  Vui lòng nhập mật khẩu!
                </ng-container>
                <ng-container *ngIf="control.hasError('minlength')">
                  Mật khẩu phải có ít nhất 6 ký tự!
                </ng-container>
              </ng-template>
            </nz-form-item>
          </div>
        </div>
      </form>
    </ng-container>
  </nz-modal>
</div>
````

## File: WebApp.Client/src/app/users/users.component.scss
````scss
.users-container {
  background: white;
  border-radius: 4px;
  padding: 24px;
  min-height: 100%;

  .users-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;

    h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 500;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
  }

  .filters-container {
    margin-bottom: 24px;
    padding: 16px;
    background: #fafafa;
    border-radius: 4px;
  }

  .action-button {
    margin: 0 4px;
  }

  .active {
    color: #52c41a;
  }

  .inactive {
    color: #ff4d4f;
  }

  .deleted {
    color: #d9d9d9;
  }

  .location-cell {
    max-width: 200px;
    span {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }

  nz-table {
    ::ng-deep {
      .ant-table-wrapper {
        padding: 0;
      }
      
      .ant-table {
        background: white;
      }
      
      .ant-pagination {
        margin: 16px 0 0;
      }

      .ant-table-thead > tr > th {
        white-space: nowrap;
      }

      .ant-table-tbody > tr > td {
        white-space: nowrap;
      }

      .ant-table-body {
        overflow-x: auto !important;
      }
    }
  }
}

/* Override browser autofill styles */
input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus,
input:-webkit-autofill:active {
    -webkit-box-shadow: 0 0 0 30px white inset !important;
    -webkit-text-fill-color: rgba(0, 0, 0, 0.88) !important;
    transition: background-color 5000s ease-in-out 0s;
}

/* For Firefox */
input:autofill {
    background-color: white !important;
    color: rgba(0, 0, 0, 0.88) !important;
}

// Form styles
:host ::ng-deep {
  .ant-form-item {
    margin-bottom: 16px;
  }

  .ant-form-item-label {
    padding-bottom: 4px;
    
    > label {
      font-weight: 500;
      height: 32px;
      
      &.ant-form-item-required:not(.ant-form-item-required-mark-optional)::before {
        color: #ff4d4f;
      }
    }
  }

  .ant-input-group-addon {
    background-color: transparent;
  }

  .ant-form-item-control-input {
    min-height: 32px;
  }

  .ant-input, 
  .ant-select-selector,
  .ant-input-affix-wrapper {
    height: 32px;
    border-radius: 4px;
  }

  .ant-select-selector {
    display: flex;
    align-items: center;
  }

  .ant-input-affix-wrapper {
    padding: 0 11px;
    
    .ant-input {
      height: 30px;
    }
  }

  nz-form-label {
    text-align: left !important;
  }
}

// Modal styles
.ant-modal-body {
  padding: 24px;
  
  form {
    .ant-row {
      margin-bottom: -16px;
      
      [nz-col] {
        padding-bottom: 16px;
      }
    }
  }
}
````

## File: WebApp.Client/src/app/users/users.component.spec.ts
````typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';

import { UsersComponent } from './users.component';

describe('UsersComponent', () => {
  let component: UsersComponent;
  let fixture: ComponentFixture<UsersComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [UsersComponent]
    })
    .compileComponents();

    fixture = TestBed.createComponent(UsersComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});
````

## File: WebApp.Client/src/app/users/users.component.ts
````typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule, FormBuilder, FormGroup, Validators } from '@angular/forms';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzModalModule, NzModalService } from 'ng-zorro-antd/modal';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzMessageModule, NzMessageService } from 'ng-zorro-antd/message';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzToolTipModule } from 'ng-zorro-antd/tooltip';
import { NzTabsModule } from 'ng-zorro-antd/tabs';
import { NzSpinModule } from 'ng-zorro-antd/spin';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzInputNumberModule } from 'ng-zorro-antd/input-number';
import { NzSwitchModule } from 'ng-zorro-antd/switch';
import { NguoiDung, UserService } from '../services/user.service';
import { DaiLy, DaiLyService } from '../services/dai-ly.service';
import { 
  LockOutline,
  UnlockOutline,
  DeleteOutline,
  EditOutline,
  PlusOutline,
  SearchOutline,
  CloseOutline,
  UserOutline,
  MailOutline,
  PhoneOutline,
  TeamOutline,
  ApartmentOutline,
  EnvironmentOutline
} from '@ant-design/icons-angular/icons';
import { forkJoin } from 'rxjs';
import { LocationService, Province, District, Commune } from '../services/location.service';
import { AuthService } from '../services/auth.service';

@Component({
  selector: 'app-users',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ReactiveFormsModule,
    NzTableModule,
    NzButtonModule,
    NzIconModule,
    NzModalModule,
    NzFormModule,
    NzInputModule,
    NzMessageModule,
    NzSelectModule,
    NzGridModule,
    NzToolTipModule,
    NzTabsModule,
    NzSpinModule,
    NzTagModule,
    NzInputNumberModule,
    NzSwitchModule
  ],
  templateUrl: './users.component.html',
  styleUrls: ['./users.component.scss']
})
export class UsersComponent implements OnInit {
  nguoiDungs: NguoiDung[] = [];
  daiLys: DaiLy[] = [];
  displayData: NguoiDung[] = [];
  filteredNguoiDungs: NguoiDung[] = [];
  isModalVisible = false;
  editingNguoiDung: NguoiDung | null = null;
  isLoading = false;
  userForm!: FormGroup;
  searchValue = '';
  selectedRole: string | null = null;
  selectedStatus: number | null = null;
  checked = false;
  indeterminate = false;
  setOfCheckedId = new Set<number>();
  showDaiLySelect = false;
  filterStatus: number | null = null;
  isSuperAdmin = false;
  daiLyMap = new Map<string, string>();
  passwordVisible = false;

  chucDanhOptions = [
    { value: 'super_admin', label: 'Super Admin' },
    { value: 'admin', label: 'Admin' },
    { value: 'nhan_vien_thu', label: 'Nhân viên thu' },
    { value: 'user', label: 'User' }
  ];

  chucDanhMap = new Map<string, string>();

  roleOptions = [
    { label: 'Super Admin', value: 'super_admin' },
    { label: 'Admin', value: 'admin' },
    { label: 'Nhân viên thu', value: 'nhan_vien_thu' },
    { label: 'User', value: 'user' }
  ];

  statusOptions = [
    { label: 'Hoạt động', value: 1 },
    { label: 'Không hoạt động', value: 0 }
  ];

  constructor(
    private userService: UserService,
    private daiLyService: DaiLyService,
    private message: NzMessageService,
    private modal: NzModalService,
    private fb: FormBuilder,
    private authService: AuthService
  ) {
    this.initForm();
    this.chucDanhMap = new Map(this.chucDanhOptions.map(opt => [opt.value, opt.label]));
    const currentUser = this.authService.getCurrentUser();
    this.isSuperAdmin = currentUser?.isSuperAdmin || currentUser?.roles?.includes('super_admin');
  }

  initForm(): void {
    this.userForm = this.fb.group({
      userName: ['', [Validators.required, Validators.minLength(3)]],
      hoTen: ['', [Validators.required]],
      password: ['', this.editingNguoiDung ? [] : [Validators.required, Validators.minLength(6)]],
      donViCongTac: [''],
      chucDanh: [''],
      email: ['', [Validators.email]],
      soDienThoai: [''],
      isSuperAdmin: [false],
      typeMangLuoi: [null],
      status: [1],
      roles: [[]],
      maNhanVien: ['']
    });

    this.userForm.get('chucDanh')?.valueChanges.subscribe(chucDanh => {
      this.showDaiLySelect = chucDanh === 'nhan_vien_thu';
      if (!this.showDaiLySelect) {
        this.userForm.patchValue({ donViCongTac: '' });
      }
    });
  }

  ngOnInit(): void {
    this.loadNguoiDungs();
    this.loadDaiLys();
  }

  loadNguoiDungs(): void {
    this.isLoading = true;
    this.userService.getNguoiDungs().subscribe({
      next: (nguoiDungs) => {
        this.nguoiDungs = nguoiDungs;
        
        if (!this.isSuperAdmin) {
          this.nguoiDungs = this.nguoiDungs.filter(user => 
            !user.isSuperAdmin && !user.roles?.includes('super_admin')
          );
        }
        
        this.displayData = [...this.nguoiDungs];
        this.applyFilters();
        this.refreshCheckedStatus();
        this.isLoading = false;
      },
      error: (error) => {
        this.message.error('Không thể tải danh sách người dùng');
        this.isLoading = false;
        console.error('Error loading users:', error);
      }
    });
  }

  loadDaiLys(): void {
    this.daiLyService.getDaiLys().subscribe({
      next: (daiLys) => {
        this.daiLys = daiLys;
      },
      error: (error) => {
        console.error('Lỗi khi tải danh sách đại lý:', error);
      }
    });
  }

  applyFilters(): void {
    if (!this.nguoiDungs) return;

    this.displayData = this.nguoiDungs.filter((nguoiDung: NguoiDung) => {
      const matchSearch = !this.searchValue || 
        (nguoiDung.userName?.toLowerCase().includes(this.searchValue.toLowerCase()) || 
         nguoiDung.hoTen?.toLowerCase().includes(this.searchValue.toLowerCase()) ||
         nguoiDung.username?.toLowerCase().includes(this.searchValue.toLowerCase()) ||
         nguoiDung.ho_ten?.toLowerCase().includes(this.searchValue.toLowerCase()));

      const matchRole = !this.selectedRole || 
        (nguoiDung.roles && nguoiDung.roles.includes(this.selectedRole));

      const userStatus = nguoiDung.status ?? (nguoiDung.trang_thai ? 1 : 0);
      const matchStatus = this.filterStatus === null || userStatus === this.filterStatus;

      return matchSearch && matchRole && matchStatus;
    });
  }

  onSearch(): void {
    this.applyFilters();
  }

  onRoleChange(): void {
    this.applyFilters();
  }

  onStatusChange(id: number, checked: boolean): void {
    const user = this.nguoiDungs.find(u => u.id === id);
    if (!user) return;

    user.isStatusLoading = true;

    this.userService.toggleStatus(id).subscribe({
      next: (response) => {
        if (response) {
          user.status = response.status;
          
          const displayUser = this.displayData.find(u => u.id === id);
          if (displayUser) {
            displayUser.status = response.status;
          }
          
          this.message.success('Cập nhật trạng thái thành công');
        }
      },
      error: (error) => {
        console.error('Toggle error:', error);
        this.message.error('Lỗi khi cập nhật trạng thái');
      },
      complete: () => {
        user.isStatusLoading = false;
      }
    });
  }

  showAddModal(): void {
    this.editingNguoiDung = null;
    
    const userNameControl = this.userForm.get('userName');
    if (userNameControl) {
      userNameControl.enable();
    }

    const passwordControl = this.userForm.get('password');
    if (passwordControl) {
      passwordControl.setValidators([Validators.required, Validators.minLength(6)]);
      passwordControl.updateValueAndValidity();
    }

    this.userForm.reset({ status: 1, isSuperAdmin: false });

    this.chucDanhOptions = this.isSuperAdmin ? [
      { value: 'super_admin', label: 'Super Admin' },
      { value: 'admin', label: 'Admin' },
      { value: 'nhan_vien_thu', label: 'Nhân viên thu' },
      { value: 'user', label: 'User' }
    ] : [
      { value: 'admin', label: 'Admin' },
      { value: 'nhan_vien_thu', label: 'Nhân viên thu' },
      { value: 'user', label: 'User' }
    ];

    this.isModalVisible = true;
  }

  showEditModal(nguoiDung: NguoiDung): void {
    this.editingNguoiDung = nguoiDung;
    
    const userNameControl = this.userForm.get('userName');
    if (userNameControl) {
      userNameControl.disable();
    }

    const passwordControl = this.userForm.get('password');
    if (passwordControl) {
      passwordControl.clearValidators();
      passwordControl.updateValueAndValidity();
    }

    const chucDanh = nguoiDung.roles && nguoiDung.roles.length > 0 ? nguoiDung.roles[0] : '';

    this.userForm.patchValue({
      userName: nguoiDung.userName,
      hoTen: nguoiDung.hoTen,
      donViCongTac: nguoiDung.donViCongTac,
      chucDanh: chucDanh,
      email: nguoiDung.email,
      soDienThoai: nguoiDung.soDienThoai,
      isSuperAdmin: nguoiDung.isSuperAdmin,
      typeMangLuoi: nguoiDung.typeMangLuoi,
      status: nguoiDung.status,
      maNhanVien: nguoiDung.maNhanVien,
      password: ''
    });
    this.isModalVisible = true;
  }

  handleCancel(): void {
    this.isModalVisible = false;
    this.userForm.reset();
  }

  handleOk(): void {
    if (this.userForm.valid) {
      this.isLoading = true;
      const formData = {...this.userForm.getRawValue()};

      formData.status = Number(formData.status);
      formData.roles = [formData.chucDanh];

      if (this.editingNguoiDung) {
        console.log('Updating user with data:', formData);
        
        this.userService.updateNguoiDung(this.editingNguoiDung.id, formData).subscribe({
          next: (response) => {
            console.log('Update response:', response);
            this.message.success('Cập nhật người dùng thành công');
            this.isModalVisible = false;
            this.loadNguoiDungs();
          },
          error: (error) => {
            console.error('Error updating user:', error);
            this.message.error(error.error?.message || 'Lỗi khi cập nhật người dùng');
          },
          complete: () => {
            this.isLoading = false;
          }
        });
      } else {
        console.log('Creating new user with data:', formData);
        this.userService.createNguoiDung(formData).subscribe({
          next: (response) => {
            console.log('Create user response:', response);
            this.message.success('Thêm người dùng thành công');
            this.isModalVisible = false;
            this.loadNguoiDungs();
          },
          error: (error) => {
            console.error('Error creating user:', error);
            if (error.error?.errors) {
              Object.keys(error.error.errors).forEach(key => {
                this.message.error(error.error.errors[key][0]);
              });
            } else {
              this.message.error(error.error?.message || 'Lỗi khi thêm người dùng');
            }
            this.isLoading = false;
          },
          complete: () => {
            this.isLoading = false;
          }
        });
      }
    } else {
      Object.keys(this.userForm.controls).forEach(key => {
        const control = this.userForm.get(key);
        if (control?.errors) {
          console.log(`${key} errors:`, control.errors);
        }
      });

      this.message.error('Vui lòng kiểm tra lại thông tin nhập liệu');

      Object.values(this.userForm.controls).forEach(control => {
        if (control.invalid) {
          control.markAsTouched();
          control.updateValueAndValidity();
        }
      });
    }
  }

  deleteNguoiDung(nguoiDung: NguoiDung): void {
    this.modal.confirm({
      nzTitle: 'Xác nhận xóa',
      nzContent: `Bạn có chắc chắn muốn xóa người dùng ${nguoiDung.hoTen || nguoiDung.ho_ten || nguoiDung.username}?`,
      nzOkText: 'Xóa',
      nzOkType: 'primary',
      nzOkDanger: true,
      nzOnOk: () => {
        this.isLoading = true;
        this.userService.deleteNguoiDung(nguoiDung.id).subscribe({
          next: () => {
            this.message.success('Xóa người dùng thành công');
            this.loadNguoiDungs();
          },
          error: (error) => {
            this.message.error('Lỗi khi xóa người dùng');
            console.error('Error deleting user:', error);
            this.isLoading = false;
          }
        });
      }
    });
  }

  copyToClipboard(text: string): void {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      this.message.success('Đã sao chép mật khẩu');
    } catch (err) {
      this.message.error('Không thể sao chép mật khẩu');
    }
    document.body.removeChild(textArea);
  }

  resetPassword(nguoiDung: NguoiDung): void {
    this.modal.confirm({
      nzTitle: 'Xác nhận đặt lại mật khẩu',
      nzContent: `Bạn có chắc chắn muốn đặt lại mật khẩu cho người dùng ${nguoiDung.hoTen}?`,
      nzOkText: 'Đồng ý',
      nzOkType: 'primary',
      nzOnOk: () => {
        this.isLoading = true;
        this.userService.resetPassword(nguoiDung.id).subscribe({
          next: (response) => {
            this.message.success('Đặt lại mật khẩu thành công');
            this.modal.info({
              nzTitle: 'Mật khẩu mới',
              nzContent: `Mật khẩu mới là: ${response.password}`,
              nzOkText: 'Sao chép',
              nzOnOk: () => {
                this.copyToClipboard(response.password);
              }
            });
            this.isLoading = false;
          },
          error: (error) => {
            this.message.error('Lỗi khi đặt lại mật khẩu');
            this.isLoading = false;
          }
        });
      }
    });
  }

  onAllChecked(checked: boolean): void {
    this.filteredNguoiDungs.forEach(({ id }) => this.updateCheckedSet(id, checked));
    this.refreshCheckedStatus();
  }

  onItemChecked(id: number, checked: boolean): void {
    this.updateCheckedSet(id, checked);
    this.refreshCheckedStatus();
  }

  updateCheckedSet(id: number, checked: boolean): void {
    if (checked) {
      this.setOfCheckedId.add(id);
    } else {
      this.setOfCheckedId.delete(id);
    }
  }

  refreshCheckedStatus(): void {
    const listOfEnabledData = this.filteredNguoiDungs.filter(({ id }) => !this.setOfCheckedId.has(id));
    this.checked = this.filteredNguoiDungs.length > 0 && listOfEnabledData.length === 0;
    this.indeterminate = listOfEnabledData.length > 0 && listOfEnabledData.length < this.filteredNguoiDungs.length;
  }

  deleteSelectedNguoiDungs(): void {
    this.modal.confirm({
      nzTitle: 'Xác nhận xóa',
      nzContent: `Bạn có chắc chắn muốn xóa ${this.setOfCheckedId.size} người dùng đã chọn?`,
      nzOkText: 'Xóa',
      nzOkType: 'primary',
      nzOkDanger: true,
      nzOnOk: () => {
        const deleteObservables = Array.from(this.setOfCheckedId).map(id =>
          this.userService.deleteNguoiDung(id)
        );

        this.isLoading = true;
        forkJoin(deleteObservables).subscribe({
          next: () => {
            this.message.success(`Đã xóa ${this.setOfCheckedId.size} người dùng`);
            this.setOfCheckedId.clear();
            this.loadNguoiDungs();
          },
          error: (error) => {
            this.message.error('Lỗi khi xóa người dùng');
            console.error('Error deleting users:', error);
            this.isLoading = false;
          }
        });
      }
    });
  }
}
````

## File: WebApp.Client/src/app/app.component.html
````html
<router-outlet></router-outlet>
````

## File: WebApp.Client/src/app/app.component.spec.ts
````typescript
import { TestBed } from '@angular/core/testing';
import { AppComponent } from './app.component';

describe('AppComponent', () => {
  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [AppComponent],
    }).compileComponents();
  });

  it('should create the app', () => {
    const fixture = TestBed.createComponent(AppComponent);
    const app = fixture.componentInstance;
    expect(app).toBeTruthy();
  });

  it(`should have the 'WebApp.Client' title`, () => {
    const fixture = TestBed.createComponent(AppComponent);
    const app = fixture.componentInstance;
    expect(app.title).toEqual('WebApp.Client');
  });

  it('should render title', () => {
    const fixture = TestBed.createComponent(AppComponent);
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    expect(compiled.querySelector('h1')?.textContent).toContain('Hello, WebApp.Client');
  });
});
````

## File: WebApp.Client/src/app/app.component.ts
````typescript
import { Component } from '@angular/core';
import { RouterOutlet } from '@angular/router';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [RouterOutlet],
  templateUrl: './app.component.html',
  styleUrl: './app.component.scss'
})
export class AppComponent {
  title = 'WebApp.Client';
}
````

## File: WebApp.Client/src/app/app.config.ts
````typescript
import { ApplicationConfig, importProvidersFrom } from '@angular/core';
import { provideRouter } from '@angular/router';
import { routes } from './app.routes';
import { provideHttpClient, withInterceptors, HTTP_INTERCEPTORS, withFetch } from '@angular/common/http';
import { IconsProviderModule } from './icons-provider';
import { vi_VN, provideNzI18n } from 'ng-zorro-antd/i18n';
import { provideAnimations } from '@angular/platform-browser/animations';
import { authInterceptor } from './interceptors/auth.interceptor';
import { ApiTokenInterceptor } from './interceptors/api-token.interceptor';
import { DonViService } from './services/don-vi.service';
import { provideNzIcons } from './icons-provider';
import { registerLocaleData } from '@angular/common';
import vi from '@angular/common/locales/vi';

// Đăng ký locale data cho tiếng Việt
registerLocaleData(vi);

export const appConfig: ApplicationConfig = {
  providers: [
    provideRouter(routes),
    provideHttpClient(withFetch(), withInterceptors([
      authInterceptor
    ])),
    provideNzI18n(vi_VN),
    provideAnimations(),
    importProvidersFrom(IconsProviderModule),
    DonViService,
    provideNzIcons(),
    {
      provide: HTTP_INTERCEPTORS,
      useClass: ApiTokenInterceptor,
      multi: true
    }
  ]
};
````

## File: WebApp.Client/src/app/app.module.ts
````typescript
import { NgModule } from '@angular/core';
import { BrowserModule } from '@angular/platform-browser';
import { HttpClientModule, HTTP_INTERCEPTORS } from '@angular/common/http';
import { AppRoutingModule } from './app-routing.module';
import { AppComponent } from './app.component';
import { ApiTokenInterceptor } from './interceptors/api-token.interceptor';
import { NzUploadModule } from 'ng-zorro-antd/upload';
import { NzMessageModule } from 'ng-zorro-antd/message';
import { NzCardModule } from 'ng-zorro-antd/card';
import { NzDescriptionsModule } from 'ng-zorro-antd/descriptions';
import { NzSpinModule } from 'ng-zorro-antd/spin';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { QuetCCCDComponent } from './ke-khai/quet-cccd/quet-cccd.component';

@NgModule({
  declarations: [
    AppComponent,
    QuetCCCDComponent
  ],
  imports: [
    BrowserModule,
    AppRoutingModule,
    HttpClientModule,
    NzUploadModule,
    NzMessageModule,
    NzCardModule,
    NzDescriptionsModule,
    NzSpinModule,
    NzGridModule,
    NzIconModule
  ],
  providers: [
    { provide: HTTP_INTERCEPTORS, useClass: ApiTokenInterceptor, multi: true }
  ],
  bootstrap: [AppComponent]
})
export class AppModule { }
````

## File: WebApp.Client/src/app/app.routes.ts
````typescript
import { Routes } from '@angular/router';
import { LoginComponent } from './login/login.component';
import { MainLayoutComponent } from './layout/main-layout/main-layout.component';
import { StatisticsComponent } from './statistics/statistics.component';
import { AdminGuard } from './guards/admin.guard';
import { DaiLyComponent } from './dai-ly/dai-ly.component';

export const routes: Routes = [
  { path: 'login', component: LoginComponent },
  {
    path: '',
    component: MainLayoutComponent,
    children: [
      { path: 'dashboard', loadComponent: () => import('./dashboard/dashboard.component').then(m => m.DashboardComponent) },
      {
        path: 'users',
        loadComponent: () => import('./users/users.component').then(m => m.UsersComponent),
        canActivate: [AdminGuard]
      },
      {
        path: 'dai-ly',
        component: DaiLyComponent,
        canActivate: [AdminGuard]
      },
      { path: 'dot-ke-khai', loadComponent: () => import('./ke-khai/dot-ke-khai/dot-ke-khai.component').then(m => m.DotKeKhaiComponent) },
      { path: 'dot-ke-khai/:id/ke-khai-bhyt', loadComponent: () => import('./ke-khai/ke-khai-bhyt/ke-khai-bhyt.component').then(m => m.KeKhaiBHYTComponent) },
      { 
        path: 'dot-ke-khai/:id/ke-khai-bhxh', 
        loadComponent: () => import('./ke-khai/ke-khai-bhxh/ke-khai-bhxh.component').then(m => m.KeKhaiBHXHComponent) 
      },
      {
        path: 'lich-su-ke-khai',
        loadComponent: () => import('./ke-khai/lich-su-ke-khai/lich-su-ke-khai.component').then(m => m.LichSuKeKhaiComponent)
      },
      {
        path: 'admin-danh-sach-ke-khai',
        loadComponent: () => import('./ke-khai/admin-danh-sach-ke-khai/admin-danh-sach-ke-khai.component').then(m => m.AdminDanhSachKeKhaiComponent),
        canActivate: [AdminGuard]
      },
      { 
        path: 'reports',
        children: [
          { path: 'statistics', component: StatisticsComponent }
        ]
      },
      { 
        path: 'don-vi', 
        loadComponent: () => import('./ke-khai/don-vi/don-vi.component').then(m => m.DonViComponent) 
      },
      {
        path: 'bien-lai',
        children: [
          {
            path: 'quyen-bien-lai',
            loadComponent: () => import('./bien-lai/quyen-bien-lai/quyen-bien-lai.component').then(m => m.QuyenBienLaiComponent),
            canActivate: [AdminGuard]
          },
          {
            path: 'danh-sach',
            loadComponent: () => import('./bien-lai/danh-sach-bien-lai/danh-sach-bien-lai.component').then(m => m.DanhSachBienLaiComponent)
          },
          {
            path: 'cap-phat',
            loadComponent: () => import('./bien-lai/cap-phat-bien-lai/cap-phat-bien-lai.component').then(m => m.CapPhatBienLaiComponent),
            canActivate: [AdminGuard]
          },
          {
            path: 'thong-ke',
            loadComponent: () => import('./bien-lai/thong-ke-bien-lai/thong-ke-bien-lai.component').then(m => m.ThongKeBienLaiComponent)
          },
          {
            path: 'bang-ke',
            loadComponent: () => import('./bien-lai/bang-ke-bien-lai/bang-ke-bien-lai.component').then(m => m.BangKeBienLaiComponent)
          },
          {
            path: 'bao-cao',
            loadComponent: () => import('./bien-lai/bao-cao-bien-lai/bao-cao-bien-lai.component').then(m => m.BaoCaoBienLaiComponent)
          },
          {
            path: 'dien-tu',
            loadChildren: () => import('./bien-lai/bien-lai-dien-tu/bien-lai-dien-tu.module').then(m => m.BienLaiDienTuModule),
            canActivate: [AdminGuard]
          },
          { path: '', redirectTo: 'danh-sach', pathMatch: 'full' }
        ]
      },
      {
        path: 'tra-cuu',
        children: [
          {
            path: 'ma-so-bhxh',
            loadComponent: () => import('./tra-cuu/tra-cuu-ma-so-bhxh/tra-cuu-ma-so-bhxh.component').then(m => m.TraCuuMaSoBhxhComponent)
          },
          {
            path: 'ho-gia-dinh',
            loadComponent: () => import('./tra-cuu/tra-cuu-ho-gia-dinh/tra-cuu-ho-gia-dinh.component').then(m => m.TraCuuHoGiaDinhComponent)
          },
          {
            path: 'thong-tin-bhxh',
            loadComponent: () => import('./tra-cuu/tra-cuu-thong-tin-bhxh/tra-cuu-thong-tin-bhxh.component').then(m => m.TraCuuThongTinBHXHComponent)
          },
          {
            path: 'thong-tin-bhyt',
            loadComponent: () => import('./tra-cuu/tra-cuu-thong-tin-bhyt/tra-cuu-thong-tin-bhyt.component').then(m => m.TraCuuThongTinBHYTComponent)
          },
          { path: '', redirectTo: 'ma-so-bhxh', pathMatch: 'full' }
        ]
      },
      { path: '', redirectTo: 'dashboard', pathMatch: 'full' }
    ]
  }
];
````

## File: WebApp.Client/src/app/icons-provider.ts
````typescript
import { Provider } from '@angular/core';
import { NZ_ICONS, NzIconModule } from 'ng-zorro-antd/icon';
import { IconDefinition } from '@ant-design/icons-angular';
import * as AllIcons from '@ant-design/icons-angular/icons';
import { 
  LockOutline,
  UnlockOutline,
  DeleteOutline,
  EditOutline,
  PlusOutline,
  SearchOutline,
  CloseOutline,
  UserOutline,
  MailOutline,
  PhoneOutline,
  TeamOutline,
  ApartmentOutline,
  EnvironmentOutline,
  MenuFoldOutline,
  MenuUnfoldOutline,
  BellOutline,
  LogoutOutline,
  BarChartOutline,
  FileTextOutline,
  FundOutline,
  SettingOutline,
  DashboardOutline,
  SolutionOutline,
  AppstoreOutline,
  ReloadOutline,
  KeyOutline,
  ProfileOutline,
  BookOutline,
  FormOutline
} from '@ant-design/icons-angular/icons';

const antDesignIcons = AllIcons as {
  [key: string]: IconDefinition;
};

const icons: IconDefinition[] = Object.keys(antDesignIcons).map(key => antDesignIcons[key]);

export function provideNzIcons(): Provider[] {
  return [
    { provide: NZ_ICONS, useValue: icons }
  ];
}

export const IconsProviderModule = NzIconModule.forRoot(icons);
````

## File: WebApp.Client/src/environments/environment.prod.ts
````typescript
export const environment = {
  production: true,
  apiUrl: '/api'
};
````

## File: WebApp.Client/src/environments/environment.ts
````typescript
export const environment = {
  production: false,
  apiUrl: 'http://localhost:5182/api',
  vietQR: {
    clientId: 'YOUR_CLIENT_ID',
    apiKey: 'YOUR_API_KEY',
    accountNo: '6706202903085',
    accountName: 'BAO HIEM XA HOI THI XA TINH BIEN',
    acqId: 970405 // Mã ngân hàng Agribank
  },
  cloudinary: {
    cloudName: 'deqi3xijr',
    uploadPreset: 'bills_preset',
    apiKey: '149338892717835',
    apiSecret: '_h_kmBS3w6pKadc5bmxKn4GutEU'
  }
};
````

## File: WebApp.Client/src/styles/README.md
````markdown
# Hướng dẫn sử dụng biến màu sắc trong dự án

## Giới thiệu

File này hướng dẫn cách sử dụng biến màu sắc trong dự án để đảm bảo tính nhất quán và dễ bảo trì. Tất cả các màu sắc trong dự án nên được lấy từ các biến đã được định nghĩa trong file `variables.scss`.

## Cách sử dụng biến màu sắc

### 1. Trong file SCSS

Để sử dụng biến màu sắc trong file SCSS của component, bạn cần import file biến:

```scss
@import "src/styles/variables.scss";

.my-component {
  color: $primary-color;
  background-color: $background-color-light;
  border: 1px solid $border-color;
}
```

### 2. Sử dụng các class tiện ích

Dự án đã định nghĩa sẵn một số class tiện ích trong file `styles.scss`:

```html
<div class="text-primary">Văn bản màu chính</div>
<div class="bg-success">Nền màu thành công</div>
<div class="border-danger">Viền màu cảnh báo</div>
```

### 3. Sử dụng với ng-zorro-antd

Các biến CSS của ng-zorro-antd đã được tùy chỉnh trong file `styles.scss`. Bạn có thể sử dụng các component của ng-zorro-antd mà không cần thêm style:

```html
<button nz-button nzType="primary">Nút với màu chính</button>
<nz-alert nzType="success" nzMessage="Thông báo thành công"></nz-alert>
```

## Danh sách biến màu sắc

### Màu sắc chính
- `$primary-color`: Màu chính của dự án (#004080)
- `$primary-color-light`: Màu chính nhạt (#1890ff)
- `$primary-color-dark`: Màu chính đậm (#003366)

### Màu sắc phụ
- `$secondary-color`: Màu phụ (#52c41a)
- `$danger-color`: Màu nguy hiểm (#ff4d4f)
- `$warning-color`: Màu cảnh báo (#faad14)
- `$success-color`: Màu thành công (#52c41a)
- `$info-color`: Màu thông tin (#1890ff)

### Màu sắc văn bản
- `$text-color`: Màu văn bản chính (rgba(0, 0, 0, 0.85))
- `$text-color-secondary`: Màu văn bản phụ (rgba(0, 0, 0, 0.65))
- `$text-color-disabled`: Màu văn bản bị vô hiệu hóa (rgba(0, 0, 0, 0.45))
- `$text-color-light`: Màu văn bản nhạt (#8c8c8c)

### Màu sắc nền
- `$background-color`: Màu nền chính (#fff)
- `$background-color-light`: Màu nền nhạt (#f0f2f5)
- `$background-color-dark`: Màu nền đậm (#001529)

### Màu sắc viền
- `$border-color`: Màu viền chính (#d9d9d9)
- `$border-color-split`: Màu viền phân tách (#f0f0f0)

## Thay đổi theme

Nếu bạn muốn thay đổi theme của dự án, chỉ cần cập nhật các giá trị trong file `variables.scss`. Tất cả các component sử dụng biến màu sắc sẽ tự động cập nhật.

## Quy tắc sử dụng màu sắc

1. **KHÔNG** sử dụng mã màu cứng (hardcoded) trong các file SCSS
2. Luôn sử dụng biến màu sắc đã được định nghĩa
3. Nếu cần thêm màu mới, hãy thêm vào file `variables.scss`
4. Sử dụng các class tiện ích khi có thể để giảm thiểu việc viết CSS
````

## File: WebApp.Client/src/styles/variables.scss
````scss
// Biến màu sắc chính của dự án - Royal Blue Theme
$primary-color: #0056b3;        // Màu chính - xanh dương đậm
$primary-color-light: #1976d2;   // Màu sáng hơn cho hover
$primary-color-dark: #0056b3;    // Màu đậm hơn cho sidebar - khớp với ảnh

// Màu sắc phụ
$secondary-color: #52c41a;
$danger-color: #ff4d4f;
$warning-color: #faad14;
$success-color: #52c41a;
$info-color: #1890ff;

// Màu sắc văn bản
$text-color: rgba(0, 0, 0, 0.85);
$text-color-secondary: rgba(0, 0, 0, 0.65);
$text-color-disabled: rgba(0, 0, 0, 0.45);
$text-color-light: #8c8c8c;

// Màu sắc nền
$background-color: #fff;
$background-color-light: #f0f2f5;
$background-color-dark: $primary-color-dark;

// Màu sắc viền
$border-color: #d9d9d9;
$border-color-split: #f0f0f0;

// Màu sắc cho hover và active
$item-hover-bg: rgba(0, 86, 179, 0.1);  // Cập nhật để phù hợp với màu chính mới
$item-active-bg: #e3f2fd;  // Màu nền active nhạt hơn cho màu xanh dương

// Màu sắc cho các trạng thái
$status-success: #52c41a;
$status-processing: #1890ff;
$status-error: #ff4d4f;
$status-warning: #faad14;
$status-default: #d9d9d9;

// Màu sắc cho login
$login-primary: #0056b3;  // Cập nhật để phù hợp với màu chính mới
$login-primary-dark: #004494;  // Cập nhật để phù hợp với màu chính đậm mới
$login-text-secondary: #5f6368;
$login-error: #d93025;
$login-error-bg: #fce8e6;
$login-border: #dadce0;

// Màu sắc cho layout
$layout-header-background: $primary-color;
$layout-trigger-background: $primary-color-dark;
$layout-trigger-color: #fff;
$layout-sider-background: $primary-color-dark;

// Màu sắc cho menu
$menu-dark-bg: $primary-color-dark;
$menu-dark-item-active-bg: #1976d2;  // Màu sáng hơn khi chọn menu
$menu-dark-item-hover-bg: #1976d2;  // Màu sáng hơn khi hover menu
$menu-dark-submenu-bg: $primary-color-dark;
````

## File: WebApp.Client/src/index.html
````html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Đăng nhập</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <app-root></app-root>
</body>
</html>
````

## File: WebApp.Client/src/main.ts
````typescript
import { bootstrapApplication } from '@angular/platform-browser';
import { appConfig } from './app/app.config';
import { AppComponent } from './app/app.component';

bootstrapApplication(AppComponent, appConfig)
  .catch((err) => console.error(err));
````

## File: WebApp.Client/src/styles.scss
````scss
/* You can add global styles to this file, and also import other style files */

// Import biến màu sắc
@import "./styles/variables.scss";

// Tùy chỉnh theme của ng-zorro-antd
:root {
  --ant-primary-color: #{$primary-color};
  --ant-primary-color-hover: #{$primary-color-light};
  --ant-primary-color-active: #{$primary-color-dark};
  --ant-primary-color-outline: rgba(#{red($primary-color)}, #{green($primary-color)}, #{blue($primary-color)}, 0.2);
  --ant-primary-1: #{$item-active-bg};
  --ant-primary-2: #{$item-hover-bg};
  --ant-primary-5: #{$primary-color-light};
  --ant-primary-7: #{$primary-color};
  
  --ant-success-color: #{$success-color};
  --ant-warning-color: #{$warning-color};
  --ant-error-color: #{$danger-color};
  --ant-info-color: #{$info-color};
  
  --ant-text-color: #{$text-color};
  --ant-text-color-secondary: #{$text-color-secondary};
  --ant-text-color-disabled: #{$text-color-disabled};
  
  --ant-border-color-base: #{$border-color};
  --ant-border-color-split: #{$border-color-split};
  
  --ant-layout-header-background: #{$layout-header-background};
  --ant-layout-sider-background: #{$layout-sider-background};
  --ant-layout-trigger-background: #{$layout-trigger-background};
  --ant-layout-trigger-color: #{$layout-trigger-color};
  
  // Thêm biến CSS cho menu
  --ant-menu-dark-bg: #{$menu-dark-bg};
  --ant-menu-dark-submenu-bg: #{$menu-dark-submenu-bg};
  --ant-menu-dark-item-active-bg: #{$menu-dark-item-active-bg};
  --ant-menu-dark-item-hover-bg: #{$menu-dark-item-hover-bg};
  --ant-menu-dark-selected-item-icon-color: #fff;
  --ant-menu-dark-selected-item-text-color: #fff;
  --ant-menu-dark-item-hover-icon-color: #fff;
  --ant-menu-dark-item-hover-text-color: #fff;
}

@import "ng-zorro-antd/ng-zorro-antd.min.css";

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
}

// Các class tiện ích cho màu sắc
.text-primary { color: $primary-color; }
.text-success { color: $success-color; }
.text-danger { color: $danger-color; }
.text-warning { color: $warning-color; }
.text-info { color: $info-color; }

.bg-primary { background-color: $primary-color; }
.bg-success { background-color: $success-color; }
.bg-danger { background-color: $danger-color; }
.bg-warning { background-color: $warning-color; }
.bg-info { background-color: $info-color; }
.bg-light { background-color: $background-color-light; }

// Các class tiện ích cho viền
.border-primary { border-color: $primary-color; }
.border-success { border-color: $success-color; }
.border-danger { border-color: $danger-color; }
.border-warning { border-color: $warning-color; }
.border-info { border-color: $info-color; }

// Thêm CSS ghi đè cho menu
.ant-menu-dark.ant-menu-dark:not(.ant-menu-horizontal) .ant-menu-item-selected {
  background-color: $menu-dark-item-active-bg !important;
}

.ant-menu-dark .ant-menu-item:hover,
.ant-menu-dark .ant-menu-item-active,
.ant-menu-dark .ant-menu-submenu-active,
.ant-menu-dark .ant-menu-submenu-open,
.ant-menu-dark .ant-menu-submenu-selected,
.ant-menu-dark .ant-menu-submenu-title:hover {
  background-color: $menu-dark-item-hover-bg !important;
}
````

## File: WebApp.Client/.editorconfig
````
# Editor configuration, see https://editorconfig.org
root = true

[*]
charset = utf-8
indent_style = space
indent_size = 2
insert_final_newline = true
trim_trailing_whitespace = true

[*.ts]
quote_type = single
ij_typescript_use_double_quotes = false

[*.md]
max_line_length = off
trim_trailing_whitespace = false
````

## File: WebApp.Client/.gitignore
````
# See https://docs.github.com/get-started/getting-started-with-git/ignoring-files for more about ignoring files.

# Compiled output
/dist
/tmp
/out-tsc
/bazel-out

# Node
/node_modules
npm-debug.log
yarn-error.log

# IDEs and editors
.idea/
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace

# Visual Studio Code
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
.history/*

# Miscellaneous
/.angular/cache
.sass-cache/
/connect.lock
/coverage
/libpeerconnection.log
testem.log
/typings

# System files
.DS_Store
Thumbs.db
.vercel
````

## File: WebApp.Client/.vercelignore
````
node_modules
.git
.angular
dist
````

## File: WebApp.Client/README.md
````markdown
# WebAppClient

This project was generated using [Angular CLI](https://github.com/angular/angular-cli) version 19.1.2.

## Development server

To start a local development server, run:

```bash
ng serve
```

Once the server is running, open your browser and navigate to `http://localhost:4200/`. The application will automatically reload whenever you modify any of the source files.

## Code scaffolding

Angular CLI includes powerful code scaffolding tools. To generate a new component, run:

```bash
ng generate component component-name
```

For a complete list of available schematics (such as `components`, `directives`, or `pipes`), run:

```bash
ng generate --help
```

## Building

To build the project run:

```bash
ng build
```

This will compile your project and store the build artifacts in the `dist/` directory. By default, the production build optimizes your application for performance and speed.

## Running unit tests

To execute unit tests with the [Karma](https://karma-runner.github.io) test runner, use the following command:

```bash
ng test
```

## Running end-to-end tests

For end-to-end (e2e) testing, run:

```bash
ng e2e
```

Angular CLI does not come with an end-to-end testing framework by default. You can choose one that suits your needs.

## Additional Resources

For more information on using the Angular CLI, including detailed command references, visit the [Angular CLI Overview and Command Reference](https://angular.dev/tools/cli) page.
````

## File: WebApp.Server/Controllers/AuthController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.Server.Models;
using Microsoft.Extensions.Logging;
using System.Text.Json;
using System.Security.Claims;
using Microsoft.IdentityModel.Tokens;
using System.Text;
using System.IdentityModel.Tokens.Jwt;
using BCrypt.Net;
using System.Net.Http;
using WebApp.API.Models;

namespace WebApp.API.Controllers
{
    public class LoginModel
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string? Ip { get; set; }
    }

    [ApiController]
    [Route("api/[controller]")]
    public class AuthController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly IConfiguration _configuration;
        private readonly ILogger<AuthController> _logger;

        public AuthController(
            ApplicationDbContext context,
            IConfiguration configuration,
            ILogger<AuthController> logger)
        {
            _context = context;
            _configuration = configuration;
            _logger = logger;
        }

        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginModel loginDto)
        {
            try
            {
                // Xác thực người dùng và mật khẩu
                var user = await _context.NguoiDungs
                    .Where(u => u.user_name == loginDto.Username && u.status == 1)
                    .FirstOrDefaultAsync();

                if (user == null)
                {
                    _logger.LogWarning($"Đăng nhập thất bại: Không tìm thấy người dùng - {loginDto.Username}");
                    return Unauthorized(new { message = "Tên đăng nhập hoặc mật khẩu không đúng" });
                }

                bool isValidPassword = BCrypt.Net.BCrypt.Verify(loginDto.Password, user.password);

                if (!isValidPassword)
                {
                    _logger.LogWarning($"Đăng nhập thất bại: Mật khẩu không đúng - {loginDto.Username}");
                    return Unauthorized(new { message = "Tên đăng nhập hoặc mật khẩu không đúng" });
                }

                // Sinh token JWT
                var token = GenerateJwtToken(user);

                // Cập nhật thời gian đăng nhập cuối
                user.updated_at = DateTime.UtcNow;
                await _context.SaveChangesAsync();

                _logger.LogInformation($"Đăng nhập thành công: {loginDto.Username}");

                // Trả về thông tin người dùng và token
                return Ok(new
                {
                    token,
                    user = new
                    {
                        id = user.id,
                        username = user.user_name,
                        hoTen = user.ho_ten,
                        roles = user.roles,
                        donViCongTac = user.don_vi_cong_tac,
                        chucDanh = user.chuc_danh,
                        email = user.email,
                        soDienThoai = user.so_dien_thoai,
                        isSuperAdmin = user.is_super_admin,
                        typeMangLuoi = user.type_mang_luoi,
                        status = user.status,
                        clientId = user.client_id
                    }
                });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Lỗi đăng nhập: {ex.Message}");
                return StatusCode(500, new { message = "Đã xảy ra lỗi trong quá trình đăng nhập" });
            }
        }

        [HttpGet("me")]
        public async Task<IActionResult> GetCurrentUser()
        {
            try
            {
                var username = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(username))
                {
                    return Unauthorized(new { message = "Không tìm thấy thông tin người dùng" });
                }

                var user = await _context.NguoiDungs
                    .Where(u => u.user_name == username)
                    .Select(u => new
                    {
                        id = u.id,
                        username = u.user_name,
                        hoTen = u.ho_ten,
                        roles = u.roles,
                        donViCongTac = u.don_vi_cong_tac,
                        chucDanh = u.chuc_danh,
                        email = u.email,
                        soDienThoai = u.so_dien_thoai,
                        isSuperAdmin = u.is_super_admin,
                        typeMangLuoi = u.type_mang_luoi,
                        status = u.status,
                        clientId = u.client_id,
                        maNhanVien = u.ma_nhan_vien
                    })
                    .FirstOrDefaultAsync();

                if (user == null)
                {
                    return NotFound(new { message = "Không tìm thấy thông tin người dùng" });
                }

                return Ok(user);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Lỗi lấy thông tin người dùng: {ex.Message}");
                return StatusCode(500, new { message = "Đã xảy ra lỗi khi lấy thông tin người dùng" });
            }
        }

        private string GenerateJwtToken(NguoiDung user)
        {
            var claims = new List<Claim>
            {
                new Claim(ClaimTypes.Name, user.user_name),
                new Claim(ClaimTypes.NameIdentifier, user.id.ToString()),
                new Claim("hoTen", user.ho_ten)
            };

            // Thêm roles vào claims
            if (user.roles != null)
            {
                foreach (var role in user.roles)
                {
                    claims.Add(new Claim(ClaimTypes.Role, role));
                }
            }

            if (user.is_super_admin)
            {
                claims.Add(new Claim("IsSuperAdmin", "true"));
            }

            // Tạo token
            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_configuration["Jwt:Key"] ?? "your-256-bit-secret"));
            var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);
            var expires = DateTime.Now.AddDays(Convert.ToDouble(_configuration["Jwt:ExpireDays"] ?? "1"));

            var token = new JwtSecurityToken(
                _configuration["Jwt:Issuer"],
                _configuration["Jwt:Audience"],
                claims,
                expires: expires,
                signingCredentials: creds
            );

            return new JwtSecurityTokenHandler().WriteToken(token);
        }

        [HttpGet("check-connection")]
        public async Task<IActionResult> CheckConnection()
        {
            try
            {
                // Kiểm tra kết nối đến database
                var canConnect = await _context.Database.CanConnectAsync();
                if (!canConnect)
                {
                    return StatusCode(503, new { message = "Không thể kết nối đến cơ sở dữ liệu" });
                }

                return Ok(new { message = "Kết nối thành công" });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Lỗi kiểm tra kết nối CSDL: {ex.Message}");
                return StatusCode(503, new { message = "Lỗi khi kiểm tra kết nối đến cơ sở dữ liệu" });
            }
        }
    }

    public class OpenApiLocationResponse
    {
        public string code { get; set; } = string.Empty;
        public OpenApiLocationData data { get; set; } = new OpenApiLocationData();
    }

    public class OpenApiLocationData 
    {
        public string ip { get; set; } = string.Empty;
        public string city { get; set; } = string.Empty;
        public string country { get; set; } = string.Empty;
        public string loc { get; set; } = string.Empty;
        public string org { get; set; } = string.Empty;
        public string postal { get; set; } = string.Empty;
        public string region { get; set; } = string.Empty;
        public string timezone { get; set; } = string.Empty;
    }
}
````

## File: WebApp.Server/Controllers/BangKeBienLaiController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Threading.Tasks;
using WebApp.API.Data;
using WebApp.API.Models;
using System.Security.Claims;
using OfficeOpenXml;
using OfficeOpenXml.Style;
using System.Drawing;

namespace WebApp.API.Controllers
{
    [Route("api/bien-lai/bang-ke")]
    [ApiController]
    public class BangKeBienLaiController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<BangKeBienLaiController> _logger;

        public BangKeBienLaiController(
            ApplicationDbContext context,
            ILogger<BangKeBienLaiController> logger)
        {
            _context = context;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetBangKeBienLai(
            [FromQuery] DateTime? tuNgay,
            [FromQuery] DateTime? denNgay,
            [FromQuery] string? quyenSo = null,
            [FromQuery] string? maNhanVien = null)
        {
            try
            {
                // Lấy thông tin người dùng hiện tại từ token
                var username = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(username))
                {
                    return Unauthorized(new { message = "Không tìm thấy thông tin người dùng" });
                }

                // Lấy thông tin người dùng từ database
                var currentUser = await _context.NguoiDungs
                    .FirstOrDefaultAsync(u => u.user_name == username);

                if (currentUser == null)
                {
                    return Unauthorized(new { message = "Không tìm thấy thông tin người dùng" });
                }

                var query = _context.BienLais
                    .Include(b => b.KeKhaiBHYT)
                        .ThenInclude(k => k.ThongTinThe)
                    .Include(b => b.KeKhaiBHYT)
                        .ThenInclude(k => k.DotKeKhai)
                            .ThenInclude(d => d.DonVi)
                    .AsQueryable();

                // Chỉ lấy biên lai của người dùng hiện tại nếu không phải admin hoặc super admin
                if (!currentUser.roles.Contains("admin") && !currentUser.roles.Contains("super_admin"))
                {
                    query = query.Where(b => b.ma_nhan_vien == currentUser.ma_nhan_vien);
                }

                if (tuNgay.HasValue)
                {
                    query = query.Where(b => b.ngay_bien_lai.Date >= tuNgay.Value.Date);
                }

                if (denNgay.HasValue)
                {
                    query = query.Where(b => b.ngay_bien_lai.Date <= denNgay.Value.Date);
                }

                if (!string.IsNullOrEmpty(quyenSo))
                {
                    query = query.Where(b => b.quyen_so.Contains(quyenSo));
                }

                if (!string.IsNullOrEmpty(maNhanVien))
                {
                    query = query.Where(b => b.ma_nhan_vien.Contains(maNhanVien));
                }

                var result = await query
                    .Select(b => new
                    {
                        quyen_so = b.quyen_so,
                        so_bien_lai = b.so_bien_lai,
                        ten_nguoi_dong = b.ten_nguoi_dong,
                        ma_so_bhxh = b.ma_so_bhxh,
                        so_tien = b.so_tien,
                        ngay_bien_lai = b.ngay_bien_lai.Date,
                        ma_nhan_vien = b.ma_nhan_vien,
                        ten_nhan_vien = _context.NguoiDungs
                            .Where(n => n.ma_nhan_vien == b.ma_nhan_vien)
                            .Select(n => n.ho_ten)
                            .FirstOrDefault(),
                        ghi_chu = b.ghi_chu,
                        trang_thai = b.trang_thai,
                        tinh_chat = b.tinh_chat,
                        ngay_tao = b.ngay_tao,
                        don_vi = b.KeKhaiBHYT != null && b.KeKhaiBHYT.DotKeKhai != null && b.KeKhaiBHYT.DotKeKhai.DonVi != null ? 
                            b.KeKhaiBHYT.DotKeKhai.DonVi.TenDonVi : null,
                        ma_ho_so = b.KeKhaiBHYT != null ? b.KeKhaiBHYT.ma_ho_so : 
                                  (b.KeKhaiBHYT != null && b.KeKhaiBHYT.DotKeKhai != null ? 
                                   b.KeKhaiBHYT.DotKeKhai.ma_ho_so : null),
                        so_thang_dong = b.KeKhaiBHYT != null ? b.KeKhaiBHYT.so_thang_dong : 0,
                        nguoi_thu = b.KeKhaiBHYT != null ? b.KeKhaiBHYT.nguoi_thu : 0
                    })
                    .OrderByDescending(b => b.ngay_tao)
                    .ToListAsync();

                return Ok(result);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting bang ke bien lai: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy dữ liệu bảng kê biên lai" });
            }
        }

        [HttpGet("export")]
        public async Task<IActionResult> ExportBangKeBienLai(
            [FromQuery] DateTime? tuNgay,
            [FromQuery] DateTime? denNgay,
            [FromQuery] string? quyenSo = null,
            [FromQuery] string? maNhanVien = null)
        {
            try
            {
                // Lấy thông tin người dùng hiện tại từ token
                var username = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(username))
                {
                    return Unauthorized(new { message = "Không tìm thấy thông tin người dùng" });
                }

                // Lấy thông tin người dùng từ database
                var currentUser = await _context.NguoiDungs
                    .FirstOrDefaultAsync(u => u.user_name == username);

                if (currentUser == null)
                {
                    return Unauthorized(new { message = "Không tìm thấy thông tin người dùng" });
                }

                var query = _context.BienLais
                    .Include(b => b.KeKhaiBHYT)
                        .ThenInclude(k => k.ThongTinThe)
                    .Include(b => b.KeKhaiBHYT)
                        .ThenInclude(k => k.DotKeKhai)
                            .ThenInclude(d => d.DonVi)
                    .AsQueryable();

                // Chỉ lấy biên lai của người dùng hiện tại nếu không phải admin hoặc super admin
                if (!currentUser.roles.Contains("admin") && !currentUser.roles.Contains("super_admin"))
                {
                    query = query.Where(b => b.ma_nhan_vien == currentUser.ma_nhan_vien);
                }

                if (tuNgay.HasValue)
                {
                    query = query.Where(b => b.ngay_bien_lai.Date >= tuNgay.Value.Date);
                }

                if (denNgay.HasValue)
                {
                    query = query.Where(b => b.ngay_bien_lai.Date <= denNgay.Value.Date);
                }

                if (!string.IsNullOrEmpty(quyenSo))
                {
                    query = query.Where(b => b.quyen_so.Contains(quyenSo));
                }

                if (!string.IsNullOrEmpty(maNhanVien))
                {
                    query = query.Where(b => b.ma_nhan_vien.Contains(maNhanVien));
                }

                var data = await query
                    .Select(b => new
                    {
                        quyen_so = b.quyen_so,
                        so_bien_lai = b.so_bien_lai,
                        ten_nguoi_dong = b.ten_nguoi_dong,
                        ma_so_bhxh = b.ma_so_bhxh,
                        so_tien = b.so_tien,
                        ngay_bien_lai = b.ngay_bien_lai.Date,
                        ma_nhan_vien = b.ma_nhan_vien,
                        ten_nhan_vien = _context.NguoiDungs
                            .Where(n => n.ma_nhan_vien == b.ma_nhan_vien)
                            .Select(n => n.ho_ten)
                            .FirstOrDefault(),
                        ghi_chu = b.ghi_chu,
                        trang_thai = b.trang_thai,
                        tinh_chat = b.tinh_chat,
                        ngay_tao = b.ngay_tao,
                        don_vi = b.KeKhaiBHYT != null && b.KeKhaiBHYT.DotKeKhai != null && b.KeKhaiBHYT.DotKeKhai.DonVi != null ? 
                            b.KeKhaiBHYT.DotKeKhai.DonVi.TenDonVi : null,
                        ma_ho_so = b.KeKhaiBHYT != null ? b.KeKhaiBHYT.ma_ho_so : 
                                  (b.KeKhaiBHYT != null && b.KeKhaiBHYT.DotKeKhai != null ? 
                                   b.KeKhaiBHYT.DotKeKhai.ma_ho_so : null),
                        so_thang_dong = b.KeKhaiBHYT != null ? b.KeKhaiBHYT.so_thang_dong : 0,
                        nguoi_thu = b.KeKhaiBHYT != null ? b.KeKhaiBHYT.nguoi_thu : 0
                    })
                    .OrderByDescending(b => b.ngay_tao)
                    .ToListAsync();

                // Tạo file Excel mới
                using (var package = new ExcelPackage())
                {
                    var worksheet = package.Workbook.Worksheets.Add("Bảng kê biên lai");
                    
                    // Thiết lập tiêu đề
                    worksheet.Cells["A1:J1"].Merge = true;
                    worksheet.Cells["A1"].Value = "BẢNG KÊ BIÊN LAI";
                    worksheet.Cells["A1"].Style.Font.Size = 16;
                    worksheet.Cells["A1"].Style.Font.Bold = true;
                    worksheet.Cells["A1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    // Thiết lập header
                    var headers = new[] { "Quyển số", "Số biên lai", "Tên người đóng", "Mã số BHXH", "Số tiền", "Ngày biên lai", "Mã NV", "Tên nhân viên", "Đơn vị", "Mã hồ sơ", "Số tháng", "Người thứ", "Ghi chú", "Trạng thái", "Tính chất" };
                    for (int i = 0; i < headers.Length; i++)
                    {
                        worksheet.Cells[3, i + 1].Value = headers[i];
                        worksheet.Cells[3, i + 1].Style.Font.Bold = true;
                        worksheet.Cells[3, i + 1].Style.Fill.PatternType = ExcelFillStyle.Solid;
                        worksheet.Cells[3, i + 1].Style.Fill.BackgroundColor.SetColor(Color.LightGray);
                        worksheet.Cells[3, i + 1].Style.Border.BorderAround(ExcelBorderStyle.Thin);
                    }

                    // Điền dữ liệu
                    int row = 4;
                    decimal tongSoTien = 0;
                    foreach (var item in data)
                    {
                        worksheet.Cells[row, 1].Value = item.quyen_so;
                        worksheet.Cells[row, 2].Value = item.so_bien_lai;
                        worksheet.Cells[row, 3].Value = item.ten_nguoi_dong;
                        worksheet.Cells[row, 4].Value = item.ma_so_bhxh;
                        worksheet.Cells[row, 5].Value = item.so_tien;
                        worksheet.Cells[row, 5].Style.Numberformat.Format = "#,##0";
                        worksheet.Cells[row, 6].Value = item.ngay_bien_lai.ToString("dd/MM/yyyy");
                        worksheet.Cells[row, 7].Value = item.ma_nhan_vien;
                        worksheet.Cells[row, 8].Value = item.ten_nhan_vien;
                        worksheet.Cells[row, 9].Value = item.don_vi;
                        worksheet.Cells[row, 10].Value = item.ma_ho_so;
                        worksheet.Cells[row, 11].Value = item.so_thang_dong;
                        worksheet.Cells[row, 12].Value = GetNguoiThuText(item.nguoi_thu);
                        worksheet.Cells[row, 13].Value = item.ghi_chu;
                        worksheet.Cells[row, 14].Value = item.trang_thai;
                        worksheet.Cells[row, 15].Value = item.tinh_chat;

                        // Thêm border cho các ô
                        worksheet.Cells[row, 1, row, 15].Style.Border.BorderAround(ExcelBorderStyle.Thin);

                        tongSoTien += item.so_tien;
                        row++;
                    }

                    // Thêm tổng số tiền
                    worksheet.Cells[row + 1, 4].Value = "Tổng số tiền:";
                    worksheet.Cells[row + 1, 4].Style.Font.Bold = true;
                    worksheet.Cells[row + 1, 5].Value = tongSoTien;
                    worksheet.Cells[row + 1, 5].Style.Font.Bold = true;
                    worksheet.Cells[row + 1, 5].Style.Numberformat.Format = "#,##0";

                    // Tự động điều chỉnh độ rộng cột
                    worksheet.Cells[worksheet.Dimension.Address].AutoFitColumns();

                    // Tạo file Excel
                    var content = package.GetAsByteArray();
                    return File(content, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", 
                        $"bang-ke-bien-lai-{DateTime.Now:yyyyMMddHHmmss}.xlsx");
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error exporting bang ke bien lai: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi xuất bảng kê biên lai" });
            }
        }

        [HttpGet("bao-cao/bc01")]
        public async Task<IActionResult> ExportBC01(
            [FromQuery] DateTime? tuNgay,
            [FromQuery] DateTime? denNgay,
            [FromQuery] string? quyenSo = null,
            [FromQuery] string? maNhanVien = null,
            [FromQuery] string? trangThai = null,
            [FromQuery] string? donVi = null,
            [FromQuery] string? tinhChat = null,
            [FromQuery] string? maHoSo = null)
        {
            try
            {
                // Lấy thông tin người dùng hiện tại từ token
                var username = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(username))
                {
                    return Unauthorized(new { message = "Không tìm thấy thông tin người dùng" });
                }

                // Lấy thông tin người dùng từ database
                var currentUser = await _context.NguoiDungs
                    .FirstOrDefaultAsync(u => u.user_name == username);

                if (currentUser == null)
                {
                    return Unauthorized(new { message = "Không tìm thấy thông tin người dùng" });
                }

                var query = _context.BienLais
                    .Include(b => b.KeKhaiBHYT)
                        .ThenInclude(k => k.ThongTinThe)
                    .Include(b => b.KeKhaiBHYT)
                        .ThenInclude(k => k.DotKeKhai)
                            .ThenInclude(d => d.DonVi)
                    .AsQueryable();

                // Chỉ lấy biên lai của người dùng hiện tại nếu không phải admin hoặc super admin
                if (!currentUser.roles.Contains("admin") && !currentUser.roles.Contains("super_admin"))
                {
                    query = query.Where(b => b.ma_nhan_vien == currentUser.ma_nhan_vien);
                }

                if (tuNgay.HasValue)
                {
                    query = query.Where(b => b.ngay_bien_lai.Date >= tuNgay.Value.Date);
                }

                if (denNgay.HasValue)
                {
                    query = query.Where(b => b.ngay_bien_lai.Date <= denNgay.Value.Date);
                }

                if (!string.IsNullOrEmpty(quyenSo))
                {
                    query = query.Where(b => b.quyen_so.Contains(quyenSo));
                }

                if (!string.IsNullOrEmpty(maNhanVien))
                {
                    query = query.Where(b => b.ma_nhan_vien.Contains(maNhanVien));
                }

                if (!string.IsNullOrEmpty(trangThai))
                {
                    query = query.Where(b => b.trang_thai == trangThai);
                }

                if (!string.IsNullOrEmpty(donVi))
                {
                    query = query.Where(b => b.KeKhaiBHYT != null && 
                                            b.KeKhaiBHYT.DotKeKhai != null && 
                                            b.KeKhaiBHYT.DotKeKhai.DonVi != null && 
                                            b.KeKhaiBHYT.DotKeKhai.DonVi.TenDonVi.Contains(donVi));
                }

                if (!string.IsNullOrEmpty(tinhChat))
                {
                    query = query.Where(b => b.tinh_chat == tinhChat);
                }

                if (!string.IsNullOrEmpty(maHoSo))
                {
                    query = query.Where(b => (b.KeKhaiBHYT != null && b.KeKhaiBHYT.ma_ho_so.Contains(maHoSo)) ||
                                            (b.KeKhaiBHYT != null && b.KeKhaiBHYT.DotKeKhai != null && 
                                             b.KeKhaiBHYT.DotKeKhai.ma_ho_so.Contains(maHoSo)));
                }

                var data = await query
                    .Select(b => new
                    {
                        quyen_so = b.quyen_so,
                        so_bien_lai = b.so_bien_lai,
                        ngay_bien_lai = b.ngay_bien_lai.Date,
                        noi_dung_thu = b.tinh_chat == "bhyt" ? "BHYT tự nguyện" : 
                                      (b.tinh_chat == "bhxh" ? "BHXH tự nguyện" : "BHTN tự nguyện"),
                        so_tien_bhxh = b.tinh_chat == "bhxh" ? b.so_tien : 0,
                        so_tien_bhyt = b.tinh_chat == "bhyt" ? b.so_tien : 0,
                        tong_so = b.so_tien
                    })
                    .OrderBy(b => b.quyen_so)
                    .ThenBy(b => b.so_bien_lai)
                    .ToListAsync();

                // Tạo file Excel mới
                using (var package = new ExcelPackage())
                {
                    var worksheet = package.Workbook.Worksheets.Add("BC01");
                    
                        // Thiết lập cấu hình trang in
                    worksheet.PrinterSettings.PaperSize = ePaperSize.A4;
                    worksheet.PrinterSettings.Orientation = eOrientation.Portrait;
                    worksheet.PrinterSettings.FitToPage = true;
                    worksheet.PrinterSettings.FitToWidth = 1;
                    worksheet.PrinterSettings.FitToHeight = 0;
                    worksheet.PrinterSettings.LeftMargin = 0.5m;
                    worksheet.PrinterSettings.RightMargin = 0.5m;
                    worksheet.PrinterSettings.TopMargin = 0.5m;
                    worksheet.PrinterSettings.BottomMargin = 0.5m;
                    worksheet.PrinterSettings.HorizontalCentered = true;
                    worksheet.PrinterSettings.VerticalCentered = true;
                    
                    // Thiết lập vùng in
                    worksheet.PrinterSettings.RepeatRows = worksheet.Cells["1:16"];
                    
                    // Thiết lập font chữ mặc định cho toàn bộ worksheet
                    worksheet.Cells.Style.Font.Name = "Times New Roman";
                    worksheet.Cells.Style.Font.Size = 12;

                    // Thiết lập tiêu đề và thông tin đơn vị
                    worksheet.Cells["A1:H1"].Merge = true;
                    worksheet.Cells["A1"].Value = "BẢO HIỂM XÃ HỘI TỈNH AN GIANG";
                    worksheet.Cells["A1"].Style.Font.Bold = true;
                    worksheet.Cells["A1"].Style.Font.Size = 12;
                    worksheet.Cells["A1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    
                    worksheet.Cells["H1"].Value = "Mẫu số: BC 01/QTAC";
                    worksheet.Cells["H1"].Style.Font.Bold = true;
                    worksheet.Cells["H1"].Style.Font.Size = 12;
                    worksheet.Cells["H1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                    
                    worksheet.Cells["A2:H2"].Merge = true;
                    worksheet.Cells["A2"].Value = "BẢO HIỂM XÃ HỘI HUYỆN TỊNH BIÊN";
                    worksheet.Cells["A2"].Style.Font.Bold = true;
                    worksheet.Cells["A2"].Style.Font.Size = 12;
                    worksheet.Cells["A2"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;

                    // Thiết lập tiêu đề báo cáo
                    worksheet.Cells["A5:H5"].Merge = true;
                    worksheet.Cells["A5"].Value = "BẢNG KÊ";
                    worksheet.Cells["A5"].Style.Font.Bold = true;
                    worksheet.Cells["A5"].Style.Font.Size = 14;
                    worksheet.Cells["A5"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    
                    worksheet.Cells["A6:H6"].Merge = true;
                    worksheet.Cells["A6"].Value = "SỬ DỤNG BIÊN LAI THU TIỀN BHYT, BHXH TỰ NGUYỆN";
                    worksheet.Cells["A6"].Style.Font.Bold = true;
                    worksheet.Cells["A6"].Style.Font.Size = 14;
                    worksheet.Cells["A6"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    
                    // Thiết lập thời gian báo cáo
                    string thangNam = "Tháng ";
                    if (tuNgay.HasValue)
                    {
                        thangNam += tuNgay.Value.Month.ToString("00") + " năm " + tuNgay.Value.Year;
                    }
                    else
                    {
                        thangNam += DateTime.Now.Month.ToString("00") + " năm " + DateTime.Now.Year;
                    }
                    
                    worksheet.Cells["A7:H7"].Merge = true;
                    worksheet.Cells["A7"].Value = thangNam;
                    worksheet.Cells["A7"].Style.Font.Bold = true;
                    worksheet.Cells["A7"].Style.Font.Size = 14;
                    worksheet.Cells["A7"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    // Thiết lập độ rộng cột trước khi đặt nội dung
                    worksheet.Column(1).Width = 20;     // Cột A - Cho label
                    worksheet.Column(2).Width = 3;      // Cột B - Khoảng cách
                    worksheet.Column(3).Width = 60;     // Cột C - Cho nội dung
                    worksheet.Column(4).Width = 15;     // Cột D
                    worksheet.Column(5).Width = 15;     // Cột E
                    worksheet.Column(6).Width = 15;     // Cột F
                    worksheet.Column(7).Width = 15;     // Cột G
                    worksheet.Column(8).Width = 15;     // Cột H

                    // Thiết lập thông tin đơn vị
                    worksheet.Cells["A10"].Value = "Tên đơn vị, đại lý:";
                    worksheet.Cells["A10"].Style.Font.Bold = true;
                    worksheet.Cells["A10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    worksheet.Cells["A10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    
                    worksheet.Cells["C10:H10"].Merge = true;
                    worksheet.Cells["C10"].Value = "Công ty TNHH MTV TMDV Huy Phúc";
                    worksheet.Cells["C10"].Style.WrapText = true;
                    worksheet.Cells["C10"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    worksheet.Cells["C10"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    worksheet.Row(10).Height = 25;
                    
                    worksheet.Cells["A11"].Value = "Địa chỉ:";
                    worksheet.Cells["A11"].Style.Font.Bold = true;
                    worksheet.Cells["A11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    worksheet.Cells["A11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    
                    worksheet.Cells["C11:H11"].Merge = true;
                    worksheet.Cells["C11"].Value = "Khóm Vĩnh Thành, thị trấn Cái Dầu, huyện Châu Phú, tỉnh An Giang";
                    worksheet.Cells["C11"].Style.WrapText = true;
                    worksheet.Cells["C11"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    worksheet.Cells["C11"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    worksheet.Row(11).Height = 25;

                    // Thêm padding cho nội dung
                    worksheet.Cells["C10:H11"].Style.Indent = 2;

                    // Thiết lập tiêu đề bảng
                    worksheet.Cells["A13:H13"].Merge = true;
                    worksheet.Cells["A13"].Value = "I/. TÌNH HÌNH SỬ DỤNG BIÊN LAI";
                    worksheet.Cells["A13"].Style.Font.Bold = true;
                    worksheet.Cells["A13"].Style.Font.Size = 12;
                    worksheet.Cells["A13"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;

                    // Thiết lập header bảng
                    var headerRange = worksheet.Cells["A14:H16"];
                    headerRange.Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    headerRange.Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    headerRange.Style.Border.Right.Style = ExcelBorderStyle.Thin;
                    headerRange.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;

                    worksheet.Cells["A14:A16"].Merge = true;
                    worksheet.Cells["A14"].Value = "STT";
                    worksheet.Cells["A14"].Style.Font.Bold = true;
                    worksheet.Cells["A14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    worksheet.Cells["A14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["B14:D14"].Merge = true;
                    worksheet.Cells["B14"].Value = "Số biên lai";
                    worksheet.Cells["B14"].Style.Font.Bold = true;
                    worksheet.Cells["B14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["E14:E16"].Merge = true;
                    worksheet.Cells["E14"].Value = "Nội dung thu";
                    worksheet.Cells["E14"].Style.Font.Bold = true;
                    worksheet.Cells["E14"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    worksheet.Cells["E14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["F14:H14"].Merge = true;
                    worksheet.Cells["F14"].Value = "Số Tiền Thu";
                    worksheet.Cells["F14"].Style.Font.Bold = true;
                    worksheet.Cells["F14"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["B15"].Value = "Quyển số";
                    worksheet.Cells["B15"].Style.Font.Bold = true;
                    worksheet.Cells["B15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["C15"].Value = "Số";
                    worksheet.Cells["C15"].Style.Font.Bold = true;
                    worksheet.Cells["C15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["D15"].Value = "Ngày";
                    worksheet.Cells["D15"].Style.Font.Bold = true;
                    worksheet.Cells["D15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["F15"].Value = "BHXH";
                    worksheet.Cells["F15"].Style.Font.Bold = true;
                    worksheet.Cells["F15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["G15"].Value = "BHYT";
                    worksheet.Cells["G15"].Style.Font.Bold = true;
                    worksheet.Cells["G15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["H15"].Value = "Tổng Số";
                    worksheet.Cells["H15"].Style.Font.Bold = true;
                    worksheet.Cells["H15"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["B16"].Value = "2";
                    worksheet.Cells["B16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["C16"].Value = "3";
                    worksheet.Cells["C16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["D16"].Value = "4";
                    worksheet.Cells["D16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["E16"].Value = "5";
                    worksheet.Cells["E16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["F16"].Value = "6";
                    worksheet.Cells["F16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["G16"].Value = "7";
                    worksheet.Cells["G16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells["H16"].Value = "8=6+7";
                    worksheet.Cells["H16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    // Điền dữ liệu
                    int row = 17;
                    int stt = 1;
                    decimal tongSoTienBHXH = 0;
                    decimal tongSoTienBHYT = 0;
                    decimal tongSoTien = 0;

                    foreach (var item in data)
                    {
                        var rowRange = worksheet.Cells[row, 1, row, 8];
                        rowRange.Style.Border.Top.Style = ExcelBorderStyle.Thin;
                        rowRange.Style.Border.Left.Style = ExcelBorderStyle.Thin;
                        rowRange.Style.Border.Right.Style = ExcelBorderStyle.Thin;
                        rowRange.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;

                        worksheet.Cells[row, 1].Value = stt++;
                        worksheet.Cells[row, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                        worksheet.Cells[row, 2].Value = item.quyen_so;
                        worksheet.Cells[row, 2].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                        worksheet.Cells[row, 3].Value = item.so_bien_lai;
                        worksheet.Cells[row, 3].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                        worksheet.Cells[row, 4].Value = item.ngay_bien_lai.ToString("dd/MM/yyyy");
                        worksheet.Cells[row, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                        worksheet.Cells[row, 5].Value = item.noi_dung_thu;
                        worksheet.Cells[row, 5].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;

                        worksheet.Cells[row, 6].Value = item.so_tien_bhxh;
                        worksheet.Cells[row, 6].Style.Numberformat.Format = "#,##0";
                        worksheet.Cells[row, 6].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                        worksheet.Cells[row, 7].Value = item.so_tien_bhyt;
                        worksheet.Cells[row, 7].Style.Numberformat.Format = "#,##0";
                        worksheet.Cells[row, 7].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                        worksheet.Cells[row, 8].Value = item.tong_so;
                        worksheet.Cells[row, 8].Style.Numberformat.Format = "#,##0";
                        worksheet.Cells[row, 8].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                        tongSoTienBHXH += item.so_tien_bhxh;
                        tongSoTienBHYT += item.so_tien_bhyt;
                        tongSoTien += item.tong_so;

                        row++;
                    }

                    // Thêm dòng tổng cộng
                    var tongCongRow = row;
                    var tongCongRange = worksheet.Cells[tongCongRow, 1, tongCongRow, 8];
                    tongCongRange.Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    tongCongRange.Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    tongCongRange.Style.Border.Right.Style = ExcelBorderStyle.Thin;
                    tongCongRange.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;

                    worksheet.Cells[tongCongRow, 1, tongCongRow, 5].Merge = true;
                    worksheet.Cells[tongCongRow, 1].Value = "Tổng cộng:";
                    worksheet.Cells[tongCongRow, 1].Style.Font.Bold = true;
                    worksheet.Cells[tongCongRow, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells[tongCongRow, 6].Value = tongSoTienBHXH;
                    worksheet.Cells[tongCongRow, 6].Style.Numberformat.Format = "#,##0";
                    worksheet.Cells[tongCongRow, 6].Style.Font.Bold = true;
                    worksheet.Cells[tongCongRow, 6].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                    worksheet.Cells[tongCongRow, 7].Value = tongSoTienBHYT;
                    worksheet.Cells[tongCongRow, 7].Style.Numberformat.Format = "#,##0";
                    worksheet.Cells[tongCongRow, 7].Style.Font.Bold = true;
                    worksheet.Cells[tongCongRow, 7].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                    worksheet.Cells[tongCongRow, 8].Value = tongSoTien;
                    worksheet.Cells[tongCongRow, 8].Style.Numberformat.Format = "#,##0";
                    worksheet.Cells[tongCongRow, 8].Style.Font.Bold = true;
                    worksheet.Cells[tongCongRow, 8].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                    // Điều chỉnh độ rộng cột cho phù hợp với khổ dọc
                    worksheet.Column(1).Width = 5;   // STT
                    worksheet.Column(2).Width = 12;   // Quyển số
                    worksheet.Column(3).Width = 8;   // Số
                    worksheet.Column(4).Width = 12;  // Ngày
                    worksheet.Column(5).Width = 18;  // Nội dung thu - Tăng độ rộng lên
                    worksheet.Column(6).Width = 12;  // BHXH
                    worksheet.Column(7).Width = 12;  // BHYT
                    worksheet.Column(8).Width = 12;  // Tổng số

                    // Thiết lập co giãn tự động cho nội dung dài
                    worksheet.Column(5).Style.WrapText = true; // Cho phép xuống dòng ở cột Nội dung thu
                    
                    // Điều chỉnh chiều cao tối thiểu cho các hàng
                    for (int i = 14; i <= row; i++)
                    {
                        worksheet.Row(i).CustomHeight = false;
                        worksheet.Row(i).Height = 25; // Tăng chiều cao mặc định
                    }

                    // Thiết lập căn chỉnh cho cột Nội dung thu
                    var noiDungThuRange = worksheet.Cells[17, 5, row - 1, 5];
                    noiDungThuRange.Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    noiDungThuRange.Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;

                    // Đặt lại định dạng cho header của cột Nội dung thu
                    worksheet.Cells["E14:E16"].Style.WrapText = true;
                    worksheet.Cells["E14:E16"].Style.VerticalAlignment = ExcelVerticalAlignment.Center;
                    worksheet.Cells["E14:E16"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    // Thiết lập vùng in
                    var printArea = worksheet.Cells[1, 1, row + 1, 8];
                    worksheet.PrinterSettings.PrintArea = printArea;

                    // Thiết lập tỷ lệ co giãn và chế độ xem
                    worksheet.View.ZoomScale = 100;
                    worksheet.View.PageLayoutView = false; // Chuyển sang chế độ Normal view
                    
                    // Thiết lập thuộc tính hiển thị lưới
                    worksheet.View.ShowGridLines = true;
                    worksheet.View.ShowHeaders = true;
                    
                    // Đảm bảo nội dung không bị cắt khi in
                    worksheet.PrinterSettings.FitToPage = true;
                    worksheet.PrinterSettings.FitToWidth = 1;
                    worksheet.PrinterSettings.FitToHeight = 0;

                    // Tự động điều chỉnh chiều cao hàng
                    for (int i = 1; i <= row; i++)
                    {
                        worksheet.Row(i).CustomHeight = false;
                        worksheet.Row(i).Height = 20; // Đặt chiều cao cố định cho mỗi hàng
                    }

                    // Tạo file Excel
                    var content = package.GetAsByteArray();
                    return File(content, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", 
                        $"BC01-Bang-Ke-BHYT-BHXH-{DateTime.Now:yyyyMMdd}.xlsx");
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error exporting BC01: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi xuất báo cáo BC01" });
            }
        }

        // Hàm chuyển đổi số người thứ sang text
        private string GetNguoiThuText(int nguoiThu)
        {
            switch (nguoiThu)
            {
                case 1:
                    return "Người thứ 1";
                case 2:
                    return "Người thứ 2";
                case 3:
                    return "Người thứ 3";
                case 4:
                    return "Người thứ 4";
                case 5:
                    return "Người thứ 5 trở đi";
                default:
                    return "";
            }
        }
    }
}
````

## File: WebApp.Server/Controllers/BienLaiDienTuController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Text.Json;
using WebApp.API.Data;
using WebApp.API.Models;
using WebApp.API.Models.BienlaiDienTu;

namespace WebApp.API.Controllers
{
    [ApiController]
    [Route("api/bien-lai-dien-tu")]
    public class BienLaiDienTuController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<BienLaiDienTuController> _logger;

        public BienLaiDienTuController(ApplicationDbContext context, ILogger<BienLaiDienTuController> logger)
        {
            _context = context;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetAll()
        {
            var bienLais = await _context.BienLaiDienTus
                .Include(b => b.KeKhaiBHYT)
                .Include(b => b.QuyenBienLaiDienTu)
                .OrderByDescending(b => b.ngay_tao)
                .ToListAsync();
            return Ok(bienLais);
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetById(int id)
        {
            var bienLai = await _context.BienLaiDienTus
                .Include(b => b.KeKhaiBHYT)
                .Include(b => b.QuyenBienLaiDienTu)
                .FirstOrDefaultAsync(b => b.id == id);

            if (bienLai == null)
                return NotFound();

            return Ok(bienLai);
        }

        [HttpPost]
        public async Task<IActionResult> Create(BienLaiDienTu bienLai)
        {
            try
            {
                _logger.LogInformation($"Received request to create BienLaiDienTu: {JsonSerializer.Serialize(bienLai)}");

                if (bienLai == null)
                {
                    return BadRequest(new { message = "Dữ liệu không hợp lệ" });
                }

                var quyenBienLai = await _context.QuyenBienLaiDienTus.FindAsync(bienLai.quyen_bien_lai_dien_tu_id);
                if (quyenBienLai == null)
                {
                    return BadRequest(new { message = "Quyển biên lai điện tử không tồn tại" });
                }

                if (quyenBienLai.trang_thai == "da_su_dung_het")
                {
                    return BadRequest(new { message = "Quyển biên lai điện tử đã sử dụng hết" });
                }

                if (string.IsNullOrEmpty(quyenBienLai.so_hien_tai))
                {
                    quyenBienLai.so_hien_tai = quyenBienLai.tu_so;
                }

                // Kiểm tra số hiện tại có hợp lệ không
                if (!int.TryParse(quyenBienLai.so_hien_tai, out int soHienTai) || 
                    !int.TryParse(quyenBienLai.den_so, out int denSo))
                {
                    return BadRequest(new { message = "Số biên lai không hợp lệ" });
                }

                if (soHienTai > denSo)
                {
                    quyenBienLai.trang_thai = "da_su_dung_het";
                    await _context.SaveChangesAsync();
                    return BadRequest(new { message = "Quyển biên lai điện tử đã sử dụng hết" });
                }

                // Đảm bảo ký hiệu biên lai đúng định dạng
                bienLai.ky_hieu = "BH25-AG/08907/E";
                
                // Lấy số biên lai hiện tại và cập nhật
                bienLai.so_bien_lai = quyenBienLai.so_hien_tai.PadLeft(7, '0');
                
                // Cập nhật số hiện tại của quyển biên lai
                int nextNumber = soHienTai + 1;
                quyenBienLai.so_hien_tai = nextNumber.ToString();
                
                // Cập nhật trạng thái quyển biên lai nếu đã sử dụng hết
                if (nextNumber > denSo)
                {
                    quyenBienLai.trang_thai = "da_su_dung_het";
                }
                else
                {
                    quyenBienLai.trang_thai = "dang_su_dung";
                }

                // Cập nhật ngày tạo và ngày biên lai
                bienLai.ngay_tao = DateTime.SpecifyKind(DateTime.Now, DateTimeKind.Utc);
                bienLai.ngay_bien_lai = DateTime.SpecifyKind(DateTime.Now, DateTimeKind.Utc);
                
                // Lưu biên lai và cập nhật quyển biên lai
                _context.BienLaiDienTus.Add(bienLai);
                await _context.SaveChangesAsync();

                var createdBienLai = await _context.BienLaiDienTus
                    .Include(b => b.KeKhaiBHYT)
                    .Include(b => b.QuyenBienLaiDienTu)
                    .FirstOrDefaultAsync(b => b.id == bienLai.id);

                return CreatedAtAction(
                    nameof(GetById), 
                    new { id = bienLai.id }, 
                    new { 
                        message = "Thêm biên lai điện tử thành công",
                        data = createdBienLai 
                    }
                );
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Lỗi khi thêm biên lai điện tử");
                return StatusCode(500, new { message = "Lỗi khi thêm biên lai điện tử", error = ex.Message });
            }
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> Update(int id, BienLaiDienTu bienLai)
        {
            if (id != bienLai.id)
                return BadRequest();

            var existingBienLai = await _context.BienLaiDienTus.FindAsync(id);
            if (existingBienLai == null)
                return NotFound();

            // Không cho phép cập nhật số biên lai và ký hiệu
            bienLai.so_bien_lai = existingBienLai.so_bien_lai;
            bienLai.ky_hieu = existingBienLai.ky_hieu;
            
            // Cập nhật các trường khác
            existingBienLai.ten_nguoi_dong = bienLai.ten_nguoi_dong;
            existingBienLai.so_tien = bienLai.so_tien;
            existingBienLai.ghi_chu = bienLai.ghi_chu;
            existingBienLai.trang_thai = bienLai.trang_thai;
            existingBienLai.ma_so_bhxh = bienLai.ma_so_bhxh;
            existingBienLai.ma_nhan_vien = bienLai.ma_nhan_vien;
            existingBienLai.tinh_chat = bienLai.tinh_chat;
            existingBienLai.ma_co_quan_bhxh = bienLai.ma_co_quan_bhxh;
            existingBienLai.ma_so_bhxh_don_vi = bienLai.ma_so_bhxh_don_vi;
            existingBienLai.is_bhyt = bienLai.is_bhyt;
            existingBienLai.is_bhxh = bienLai.is_bhxh;

            try
            {
                await _context.SaveChangesAsync();
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!await BienLaiExists(id))
                    return NotFound();
                throw;
            }

            return NoContent();
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> Delete(int id)
        {
            var bienLai = await _context.BienLaiDienTus.FindAsync(id);
            if (bienLai == null)
                return NotFound();

            // Xóa biên lai
            _context.BienLaiDienTus.Remove(bienLai);
            await _context.SaveChangesAsync();

            return NoContent();
        }

        private async Task<bool> BienLaiExists(int id)
        {
            return await _context.BienLaiDienTus.AnyAsync(e => e.id == id);
        }
    }
}
````

## File: WebApp.Server/Controllers/DaiLyController.cs
````csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.Server.Models;
using WebApp.API.Models;
using Microsoft.Extensions.Logging;

namespace WebApp.API.Controllers
{
    [Route("api/dai-ly")]
    [ApiController]
    public class DaiLyController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<DaiLyController> _logger;

        public DaiLyController(ApplicationDbContext context, ILogger<DaiLyController> logger)
        {
            _context = context;
            _logger = logger;
        }

        // GET: api/dai-ly
        [HttpGet]
        public async Task<ActionResult<IEnumerable<DaiLy>>> GetDaiLys()
        {
            return await _context.DaiLys
                .OrderBy(x => x.Ten)
                .ToListAsync();
        }

        // GET: api/dai-ly/5
        [HttpGet("{id}")]
        public async Task<ActionResult<DaiLy>> GetDaiLy(int id)
        {
            var daiLy = await _context.DaiLys.FindAsync(id);

            if (daiLy == null)
            {
                return NotFound();
            }

            return daiLy;
        }

        // GET: api/dai-ly/5/don-vis
        [HttpGet("{id}/don-vis")]
        public async Task<ActionResult<IEnumerable<DonVi>>> GetDonVisByDaiLy(int id)
        {
            var daiLy = await _context.DaiLys.FindAsync(id);
            if (daiLy == null)
            {
                return NotFound();
            }

            return await _context.DaiLyDonVis
                .Where(dd => dd.DaiLyId == id && dd.TrangThai)
                .Include(dd => dd.DonVi)
                .Select(dd => dd.DonVi)
                .OrderBy(d => d.TenDonVi)
                .ToListAsync();
        }

        // POST: api/dai-ly
        [HttpPost]
        public async Task<ActionResult<DaiLy>> PostDaiLy(DaiLy daiLy)
        {
            _context.DaiLys.Add(daiLy);
            await _context.SaveChangesAsync();

            return CreatedAtAction(nameof(GetDaiLy), new { id = daiLy.Id }, daiLy);
        }

        // PUT: api/dai-ly/5
        [HttpPut("{id}")]
        public async Task<IActionResult> PutDaiLy(int id, DaiLy daiLy)
        {
            if (id != daiLy.Id)
            {
                return BadRequest();
            }

            _context.Entry(daiLy).State = EntityState.Modified;

            try
            {
                await _context.SaveChangesAsync();
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!DaiLyExists(id))
                {
                    return NotFound();
                }
                else
                {
                    throw;
                }
            }

            return NoContent();
        }

        // DELETE: api/dai-ly/5
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteDaiLy(int id)
        {
            try
            {
                var daiLy = await _context.DaiLys.FindAsync(id);
                if (daiLy == null)
                {
                    return NotFound(new { message = "Không tìm thấy đại lý" });
                }

                // Kiểm tra xem đại lý có đơn vị nào không
                var daiLyDonViCount = await _context.Set<DaiLyDonVi>()
                    .Where(x => x.DaiLyId == id && x.TrangThai)
                    .CountAsync();

                if (daiLyDonViCount > 0)
                {
                    return BadRequest(new { 
                        message = "Không thể xóa đại lý này vì đang có đơn vị liên kết",
                        donViCount = daiLyDonViCount
                    });
                }

                // Kiểm tra xem đại lý có đợt kê khai nào không
                var dotKeKhaiCount = await _context.DotKeKhais
                    .Where(x => x.dai_ly_id == id)
                    .CountAsync();

                if (dotKeKhaiCount > 0)
                {
                    return BadRequest(new {
                        message = "Không thể xóa đại lý này vì đang có đợt kê khai liên quan",
                        dotKeKhaiCount = dotKeKhaiCount
                    });
                }

                _context.DaiLys.Remove(daiLy);
                await _context.SaveChangesAsync();

                return Ok(new { message = "Xóa đại lý thành công" });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error deleting dai ly: {ex.Message}");
                return StatusCode(500, new { 
                    message = "Có lỗi xảy ra khi xóa đại lý",
                    error = ex.Message 
                });
            }
        }

        private bool DaiLyExists(int id)
        {
            return _context.DaiLys.Any(e => e.Id == id);
        }
    }
}
````

## File: WebApp.Server/Controllers/DaiLyDonViController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.Server.Models;
using Microsoft.Extensions.Logging;
using WebApp.API.Models;

namespace WebApp.Server.Controllers
{
    public class DaiLyDonViDTO
    {
        public int DaiLyId { get; set; }
        public int DonViId { get; set; }
        public string NguoiTao { get; set; } = string.Empty;
    }

    [ApiController]
    [Route("api/dai-ly-don-vi")]
    public class DaiLyDonViController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<DaiLyDonViController> _logger;

        public DaiLyDonViController(ApplicationDbContext context, ILogger<DaiLyDonViController> logger)
        {
            _context = context;
            _logger = logger;
        }

        [HttpGet("dai-ly/{daiLyId}/don-vis")]
        public async Task<ActionResult<IEnumerable<DonVi>>> GetDonVisByDaiLy(int daiLyId)
        {
            try
            {
                var donVis = await _context.DaiLyDonVis
                    .Where(dd => dd.DaiLyId == daiLyId && dd.TrangThai)
                    .Include(dd => dd.DonVi)
                    .Select(dd => new {
                        dd.DonVi.Id,
                        dd.DonVi.MaCoQuanBHXH,
                        dd.DonVi.MaSoBHXH,
                        dd.DonVi.TenDonVi,
                        dd.DonVi.IsBHXHTN,
                        dd.DonVi.IsBHYT,
                        dd.DonVi.DmKhoiKcbId,
                        dd.DonVi.Type,
                        dd.DonVi.TrangThai
                    })
                    .OrderBy(d => d.TenDonVi)
                    .ToListAsync();

                return Ok(donVis);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting don vis for dai ly {daiLyId}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách đơn vị" });
            }
        }

        [HttpGet("don-vi/{donViId}/dai-lys")]
        public async Task<ActionResult<IEnumerable<DaiLy>>> GetDaiLysByDonVi(int donViId)
        {
            try
            {
                var daiLys = await _context.DaiLyDonVis
                    .Where(dd => dd.DonViId == donViId && dd.TrangThai)
                    .Include(dd => dd.DaiLy)
                    .Select(dd => dd.DaiLy)
                    .ToListAsync();

                return Ok(daiLys);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting dai lys for don vi {donViId}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách đại lý" });
            }
        }

        [HttpPost]
        public async Task<IActionResult> AddDaiLyDonVi(DaiLyDonViDTO dto)
        {
            var exists = await _context.DaiLyDonVis
                .AnyAsync(x => x.DaiLyId == dto.DaiLyId && x.DonViId == dto.DonViId && x.TrangThai);

            if (exists)
            {
                return BadRequest(new { message = "Quan hệ này đã tồn tại" });
            }

            var daiLyDonVi = new DaiLyDonVi
            {
                DaiLyId = dto.DaiLyId,
                DonViId = dto.DonViId,
                NguoiTao = dto.NguoiTao,
                TrangThai = true
            };

            _context.DaiLyDonVis.Add(daiLyDonVi);
            await _context.SaveChangesAsync();

            return Ok(daiLyDonVi);
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteDaiLyDonVi(int id)
        {
            var daiLyDonVi = await _context.DaiLyDonVis.FindAsync(id);
            if (daiLyDonVi == null)
            {
                return NotFound(new { message = "Không tìm thấy quan hệ này" });
            }

            daiLyDonVi.TrangThai = false;
            await _context.SaveChangesAsync();

            return Ok(new { message = "Xóa thành công" });
        }
    }
}
````

## File: WebApp.Server/Controllers/DanhMucCSKCBController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.API.Models;

namespace WebApp.API.Controllers
{
    [Route("api/danh-muc-cskcb")]
    [ApiController]
    public class DanhMucCSKCBController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<DanhMucCSKCBController> _logger;

        public DanhMucCSKCBController(ApplicationDbContext context, ILogger<DanhMucCSKCBController> logger)
        {
            _context = context;
            _logger = logger;
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<DanhMucCSKCB>>> GetAll()
        {
            try
            {
                var danhSach = await _context.DanhMucCSKCBs
                    .OrderBy(x => x.ten)
                    .ToListAsync();

                return Ok(danhSach);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting danh muc CSKCB: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách cơ sở khám chữa bệnh", error = ex.Message });
            }
        }

        [HttpGet("{id}")]
        public async Task<ActionResult<DanhMucCSKCB>> GetById(int id)
        {
            try
            {
                var cskcb = await _context.DanhMucCSKCBs.FindAsync(id);

                if (cskcb == null)
                {
                    return NotFound(new { message = "Không tìm thấy cơ sở khám chữa bệnh" });
                }

                return Ok(cskcb);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting CSKCB {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy thông tin cơ sở khám chữa bệnh", error = ex.Message });
            }
        }
    }
}
````

## File: WebApp.Server/Controllers/DanhMucHuyenController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.API.Models;

namespace WebApp.API.Controllers
{
    [Route("api/danh-muc-huyen")]
    [ApiController]
    public class DanhMucHuyenController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<DanhMucHuyenController> _logger;

        public DanhMucHuyenController(
            ApplicationDbContext context,
            ILogger<DanhMucHuyenController> logger)
        {
            _context = context;
            _logger = logger;
        }

        // GET: api/danh-muc-huyen
        [HttpGet]
        public async Task<ActionResult<IEnumerable<DanhMucHuyen>>> GetDanhMucHuyen()
        {
            try
            {
                _logger.LogInformation("Đang lấy danh sách quận/huyện");
                
                var danhMucHuyens = await _context.DanhMucHuyens
                    .OrderBy(p => p.ten)
                    .ToListAsync();

                if (!danhMucHuyens.Any())
                {
                    _logger.LogWarning("Không tìm thấy dữ liệu quận/huyện");
                    return NotFound("Không tìm thấy dữ liệu quận/huyện");
                }

                _logger.LogInformation($"Đã tìm thấy {danhMucHuyens.Count} quận/huyện");
                return Ok(danhMucHuyens);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Lỗi khi lấy danh sách quận/huyện");
                return StatusCode(500, "Có lỗi xảy ra khi lấy danh sách quận/huyện");
            }
        }

        // GET: api/danh-muc-huyen/ma-tinh/01
        [HttpGet("ma-tinh/{maTinh}")]
        public async Task<ActionResult<IEnumerable<DanhMucHuyen>>> GetDanhMucHuyenByMaTinh(string maTinh)
        {
            try
            {
                if (string.IsNullOrEmpty(maTinh))
                {
                    _logger.LogWarning("Mã tỉnh không được để trống");
                    return BadRequest("Mã tỉnh không được để trống");
                }

                _logger.LogInformation($"Đang lấy danh sách quận/huyện theo mã tỉnh: {maTinh}");
                
                var danhMucHuyens = await _context.DanhMucHuyens
                    .Where(d => d.ma_tinh == maTinh)
                    .OrderBy(d => d.ten)
                    .AsNoTracking()
                    .ToListAsync();

                if (!danhMucHuyens.Any())
                {
                    _logger.LogWarning($"Không tìm thấy quận/huyện cho mã tỉnh: {maTinh}");
                    return Ok(new List<DanhMucHuyen>()); // Trả về mảng rỗng thay vì NotFound
                }

                _logger.LogInformation($"Đã tìm thấy {danhMucHuyens.Count} quận/huyện cho mã tỉnh: {maTinh}");
                return Ok(danhMucHuyens);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"Lỗi khi lấy danh sách quận/huyện cho mã tỉnh: {maTinh}");
                return StatusCode(500, new { message = "Có lỗi xảy ra khi lấy danh sách quận/huyện", error = ex.Message });
            }
        }

        // GET: api/danh-muc-huyen/ma/001
        [HttpGet("ma/{ma}")]
        public async Task<ActionResult<DanhMucHuyen>> GetDanhMucHuyenByMa(string ma)
        {
            try
            {
                _logger.LogInformation($"Đang tìm quận/huyện với mã: {ma}");
                
                var danhMucHuyen = await _context.DanhMucHuyens
                    .FirstOrDefaultAsync(d => d.ma == ma);

                if (danhMucHuyen == null)
                {
                    _logger.LogWarning($"Không tìm thấy quận/huyện với mã: {ma}");
                    return NotFound($"Không tìm thấy quận/huyện với mã: {ma}");
                }

                return Ok(danhMucHuyen);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"Lỗi khi tìm quận/huyện với mã: {ma}");
                return StatusCode(500, "Có lỗi xảy ra khi tìm quận/huyện");
            }
        }
    }
}
````

## File: WebApp.Server/Controllers/DanhMucXaController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.API.Models;

namespace WebApp.API.Controllers
{
    [Route("api/danh-muc-xa")]
    [ApiController]
    public class DanhMucXaController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<DanhMucXaController> _logger;

        public DanhMucXaController(
            ApplicationDbContext context,
            ILogger<DanhMucXaController> logger)
        {
            _context = context;
            _logger = logger;
        }

        // GET: api/danh-muc-xa
        [HttpGet]
        public async Task<ActionResult<IEnumerable<DanhMucXa>>> GetDanhMucXa()
        {
            try
            {
                _logger.LogInformation("Đang lấy danh sách xã/phường");
                
                var danhMucXas = await _context.DanhMucXas
                    .OrderBy(x => x.ten)
                    .ToListAsync();

                if (!danhMucXas.Any())
                {
                    _logger.LogWarning("Không tìm thấy dữ liệu xã/phường");
                    return NotFound("Không tìm thấy dữ liệu xã/phường");
                }

                _logger.LogInformation($"Đã tìm thấy {danhMucXas.Count} xã/phường");
                return Ok(danhMucXas);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Lỗi khi lấy danh sách xã/phường");
                return StatusCode(500, "Có lỗi xảy ra khi lấy danh sách xã/phường");
            }
        }

        // GET: api/danh-muc-xa/ma-huyen/001
        [HttpGet("ma-huyen/{maHuyen}")]
        public async Task<ActionResult<IEnumerable<DanhMucXa>>> GetDanhMucXaByMaHuyen(string maHuyen)
        {
            try
            {
                if (string.IsNullOrEmpty(maHuyen))
                {
                    _logger.LogWarning("Mã huyện không được để trống");
                    return BadRequest("Mã huyện không được để trống");
                }

                _logger.LogInformation($"Đang lấy danh sách xã/phường theo mã huyện: {maHuyen}");
                
                var danhMucXas = await _context.DanhMucXas
                    .Where(x => x.ma_huyen == maHuyen)
                    .OrderBy(x => x.ten)
                    .AsNoTracking()
                    .ToListAsync();

                if (!danhMucXas.Any())
                {
                    _logger.LogWarning($"Không tìm thấy xã/phường cho mã huyện: {maHuyen}");
                    return Ok(new List<DanhMucXa>()); // Trả về mảng rỗng thay vì NotFound
                }

                _logger.LogInformation($"Đã tìm thấy {danhMucXas.Count} xã/phường cho mã huyện: {maHuyen}");
                return Ok(danhMucXas);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"Lỗi khi lấy danh sách xã/phường cho mã huyện: {maHuyen}");
                return StatusCode(500, new { message = "Có lỗi xảy ra khi lấy danh sách xã/phường", error = ex.Message });
            }
        }

        // GET: api/danh-muc-xa/ma/00001
        [HttpGet("ma/{ma}")]
        public async Task<ActionResult<DanhMucXa>> GetDanhMucXaByMa(string ma)
        {
            try
            {
                _logger.LogInformation($"Đang tìm xã/phường với mã: {ma}");
                
                var danhMucXa = await _context.DanhMucXas
                    .FirstOrDefaultAsync(x => x.ma == ma);

                if (danhMucXa == null)
                {
                    _logger.LogWarning($"Không tìm thấy xã/phường với mã: {ma}");
                    return NotFound($"Không tìm thấy xã/phường với mã: {ma}");
                }

                return Ok(danhMucXa);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"Lỗi khi tìm xã/phường với mã: {ma}");
                return StatusCode(500, "Có lỗi xảy ra khi tìm xã/phường");
            }
        }
    }
}
````

## File: WebApp.Server/Controllers/DmTinhController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.API.Models;

namespace WebApp.API.Controllers
{
    [Route("api/danh-muc-tinh")]
    [ApiController]
    public class DanhMucTinhController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<DanhMucTinhController> _logger;

        public DanhMucTinhController(
            ApplicationDbContext context,
            ILogger<DanhMucTinhController> logger)
        {
            _context = context;
            _logger = logger;
        }

        // GET: api/danh-muc-tinh
        [HttpGet]
        public async Task<ActionResult<IEnumerable<DanhMucTinh>>> GetDanhMucTinh()
        {
            try
            {
                _logger.LogInformation("Đang lấy danh sách tỉnh/thành phố");
                
                var danhMucTinhs = await _context.DanhMucTinhs
                    .OrderBy(p => p.ten)
                    .ToListAsync();

                if (!danhMucTinhs.Any())
                {
                    _logger.LogWarning("Không tìm thấy dữ liệu tỉnh/thành phố");
                    return NotFound("Không tìm thấy dữ liệu tỉnh/thành phố");
                }

                _logger.LogInformation($"Đã tìm thấy {danhMucTinhs.Count} tỉnh/thành phố");
                return Ok(danhMucTinhs);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Lỗi khi lấy danh sách tỉnh/thành phố");
                return StatusCode(500, "Có lỗi xảy ra khi lấy danh sách tỉnh/thành phố");
            }
        }

        // GET: api/danh-muc-tinh/5
        [HttpGet("{id}")]
        public async Task<ActionResult<DanhMucTinh>> GetDanhMucTinh(int id)
        {
            try
            {
                _logger.LogInformation($"Đang tìm tỉnh/thành phố với ID: {id}");
                
                var danhMucTinh = await _context.DanhMucTinhs.FindAsync(id);

                if (danhMucTinh == null)
                {
                    _logger.LogWarning($"Không tìm thấy tỉnh/thành phố với ID: {id}");
                    return NotFound($"Không tìm thấy tỉnh/thành phố với ID: {id}");
                }

                return Ok(danhMucTinh);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"Lỗi khi tìm tỉnh/thành phố với ID: {id}");
                return StatusCode(500, "Có lỗi xảy ra khi tìm tỉnh/thành phố");
            }
        }

        // GET: api/danh-muc-tinh/ma/01
        [HttpGet("ma/{ma}")]
        public async Task<ActionResult<DanhMucTinh>> GetDanhMucTinhByMa(string ma)
        {
            try
            {
                _logger.LogInformation($"Đang tìm tỉnh/thành phố với mã: {ma}");
                
                var danhMucTinh = await _context.DanhMucTinhs
                    .FirstOrDefaultAsync(p => p.ma == ma);

                if (danhMucTinh == null)
                {
                    _logger.LogWarning($"Không tìm thấy tỉnh/thành phố với mã: {ma}");
                    return NotFound($"Không tìm thấy tỉnh/thành phố với mã: {ma}");
                }

                return Ok(danhMucTinh);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"Lỗi khi tìm tỉnh/thành phố với mã: {ma}");
                return StatusCode(500, "Có lỗi xảy ra khi tìm tỉnh/thành phố");
            }
        }
    }
}
````

## File: WebApp.Server/Controllers/DonViController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.API.Models;
using WebApp.Server.Models;
using System.ComponentModel.DataAnnotations;

namespace WebApp.API.Controllers
{
    [Route("api/don-vi")]
    [ApiController]
    public class DonViController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<DonViController> _logger;

        public class DonViDTO
        {
            [Required]
            public string MaCoQuanBHXH { get; set; } = string.Empty;
            
            [Required]
            public string MaSoBHXH { get; set; } = string.Empty;
            
            [Required]
            public string TenDonVi { get; set; } = string.Empty;
            
            public bool IsBHXHTN { get; set; }
            public bool IsBHYT { get; set; }
            public int? DmKhoiKcbId { get; set; }
            public bool TrangThai { get; set; }
            
            [Required]
            public List<int> DaiLyIds { get; set; } = new List<int>();
        }

        public DonViController(ApplicationDbContext context, ILogger<DonViController> logger)
        {
            _context = context;
            _logger = logger;
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<DonVi>>> GetDonVis()
        {
            var donVis = await _context.DonVis
                .OrderBy(x => x.TenDonVi)
                .Select(d => new
                {
                    d.Id,
                    d.MaCoQuanBHXH,
                    d.MaSoBHXH,
                    d.TenDonVi,
                    d.IsBHXHTN,
                    d.IsBHYT,
                    d.DmKhoiKcbId,
                    d.Type,
                    d.TrangThai,
                    d.CreatedAt,
                    d.UpdatedAt,
                    DaiLys = _context.DaiLyDonVis
                        .Where(dd => dd.DonViId == d.Id && dd.TrangThai)
                        .Select(dd => new
                        {
                            dd.DaiLy.Id,
                            dd.DaiLy.Ma,
                            dd.DaiLy.Ten,
                            dd.DaiLy.DiaChi,
                            dd.DaiLy.SoDienThoai,
                            dd.DaiLy.Email,
                            dd.DaiLy.NguoiDaiDien,
                            dd.DaiLy.TrangThai
                        }).ToList()
                })
                .ToListAsync();

            return Ok(donVis);
        }

        [HttpGet("{id}")]
        public async Task<ActionResult<DonVi>> GetDonVi(int id)
        {
            var donVi = await _context.DonVis.FindAsync(id);

            if (donVi == null)
            {
                return NotFound();
            }

            return donVi;
        }

        [HttpPost]
        public async Task<ActionResult<DonVi>> CreateDonVi(DonViDTO donViDto)
        {
            using var transaction = _context.Database.BeginTransaction();
            try
            {
                var donVi = new DonVi
                {
                    MaCoQuanBHXH = donViDto.MaCoQuanBHXH,
                    MaSoBHXH = donViDto.MaSoBHXH,
                    TenDonVi = donViDto.TenDonVi,
                    IsBHXHTN = donViDto.IsBHXHTN,
                    IsBHYT = donViDto.IsBHYT,
                    DmKhoiKcbId = donViDto.DmKhoiKcbId,
                    TrangThai = donViDto.TrangThai
                };

                _context.DonVis.Add(donVi);
                await _context.SaveChangesAsync();

                // Thêm quan hệ với các đại lý
                foreach (var daiLyId in donViDto.DaiLyIds)
                {
                    var daiLyDonVi = new DaiLyDonVi
                    {
                        DaiLyId = daiLyId,
                        DonViId = donVi.Id,
                        TrangThai = true,
                        NguoiTao = User.Identity?.Name ?? "system"
                    };
                    _context.DaiLyDonVis.Add(daiLyDonVi);
                }
                await _context.SaveChangesAsync();

                await transaction.CommitAsync();
                return CreatedAtAction(nameof(GetDonVi), new { id = donVi.Id }, donVi);
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError($"Error creating don vi: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi tạo đơn vị", error = ex.Message });
            }
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateDonVi(int id, [FromBody] DonViDTO donViDto)
        {
            using var transaction = _context.Database.BeginTransaction();
            try
            {
                var donVi = await _context.DonVis.FindAsync(id);
                if (donVi == null)
                {
                    return NotFound(new { message = $"Không tìm thấy đơn vị có ID: {id}" });
                }

                // Cập nhật thông tin đơn vị
                donVi.MaCoQuanBHXH = donViDto.MaCoQuanBHXH;
                donVi.MaSoBHXH = donViDto.MaSoBHXH;
                donVi.TenDonVi = donViDto.TenDonVi;
                donVi.IsBHXHTN = donViDto.IsBHXHTN;
                donVi.IsBHYT = donViDto.IsBHYT;
                donVi.DmKhoiKcbId = donViDto.DmKhoiKcbId;
                donVi.TrangThai = donViDto.TrangThai;
                donVi.UpdatedAt = DateTime.UtcNow;

                // Cập nhật quan hệ với đại lý
                var existingRelations = await _context.DaiLyDonVis
                    .Where(dd => dd.DonViId == id)
                    .ToListAsync();

                // Vô hiệu hóa các quan hệ không còn trong danh sách mới
                foreach (var relation in existingRelations)
                {
                    if (!donViDto.DaiLyIds.Contains(relation.DaiLyId))
                    {
                        relation.TrangThai = false;
                    }
                }

                // Thêm các quan hệ mới
                foreach (var daiLyId in donViDto.DaiLyIds)
                {
                    var existingRelation = existingRelations
                        .FirstOrDefault(r => r.DaiLyId == daiLyId);

                    if (existingRelation == null)
                    {
                        // Tạo quan hệ mới
                        var daiLyDonVi = new DaiLyDonVi
                        {
                            DaiLyId = daiLyId,
                            DonViId = id,
                            TrangThai = true,
                            NguoiTao = User.Identity?.Name ?? "system"
                        };
                        _context.DaiLyDonVis.Add(daiLyDonVi);
                    }
                    else if (!existingRelation.TrangThai)
                    {
                        // Kích hoạt lại quan hệ đã bị vô hiệu hóa
                        existingRelation.TrangThai = true;
                    }
                }

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return Ok(new { 
                    message = "Cập nhật đơn vị thành công",
                    data = donVi
                });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError($"Error updating don vi: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi cập nhật đơn vị", error = ex.Message });
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteDonVi(int id)
        {
            try
            {
                var donVi = await _context.DonVis.FindAsync(id);
                if (donVi == null)
                {
                    return NotFound(new { message = "Không tìm thấy đơn vị" });
                }

                // Kiểm tra xem đơn vị có đợt kê khai nào không
                var dotKeKhaiCount = await _context.DotKeKhais
                    .Where(x => x.don_vi_id == id)
                    .CountAsync();

                if (dotKeKhaiCount > 0)
                {
                    return BadRequest(new {
                        message = "Không thể xóa đơn vị này vì đang có đợt kê khai liên quan",
                        dotKeKhaiCount = dotKeKhaiCount
                    });
                }

                // Xóa các bản ghi liên quan trong bảng dai_ly_don_vi trước
                var daiLyDonVis = await _context.DaiLyDonVis
                    .Where(x => x.DonViId == id)
                    .ToListAsync();

                if (daiLyDonVis.Any())
                {
                    _context.DaiLyDonVis.RemoveRange(daiLyDonVis);
                    await _context.SaveChangesAsync();
                }

                // Sau đó mới xóa đơn vị
                _context.DonVis.Remove(donVi);
                await _context.SaveChangesAsync();

                return Ok(new { message = "Xóa đơn vị thành công" });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error deleting don vi: {ex.Message}");
                return StatusCode(500, new { 
                    message = "Có lỗi xảy ra khi xóa đơn vị",
                    error = ex.Message 
                });
            }
        }

        [HttpGet("by-dai-ly/{daiLyId}")]
        public async Task<ActionResult<IEnumerable<DonVi>>> GetDonVisByDaiLy(int daiLyId)
        {
            try
            {
                var donVis = await _context.DaiLyDonVis
                    .Where(dd => dd.DaiLyId == daiLyId && dd.TrangThai)
                    .Select(dd => new
                    {
                        dd.DonVi.Id,
                        dd.DonVi.MaCoQuanBHXH,
                        dd.DonVi.MaSoBHXH, 
                        dd.DonVi.TenDonVi,
                        dd.DonVi.IsBHXHTN,
                        dd.DonVi.IsBHYT,
                        dd.DonVi.DmKhoiKcbId,
                        dd.DonVi.Type,
                        dd.DonVi.TrangThai
                    })
                    .OrderBy(d => d.TenDonVi)
                    .ToListAsync();

                if (!donVis.Any())
                {
                    return Ok(new List<DonVi>()); // Trả về mảng rỗng nếu không có dữ liệu
                }

                return Ok(donVis);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting don vi list by dai ly: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách đơn vị", error = ex.Message });
            }
        }

        [HttpPatch("{id}/status")]
        public async Task<IActionResult> UpdateStatus(int id, [FromBody] Dictionary<string, bool> data)
        {
            try 
            {
                if (!data.ContainsKey("trangThai"))
                {
                    return BadRequest(new { message = "Thiếu thông tin trạng thái" });
                }

                var donVi = await _context.DonVis.FindAsync(id);
                if (donVi == null)
                {
                    return NotFound(new { message = "Không tìm thấy đơn vị" });
                }

                donVi.TrangThai = data["trangThai"];
                donVi.UpdatedAt = DateTime.UtcNow;

                await _context.SaveChangesAsync();

                return Ok(new { 
                    message = "Cập nhật trạng thái thành công",
                    data = donVi
                });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error updating don vi status: {ex.Message}");
                return StatusCode(500, new { 
                    message = "Lỗi khi cập nhật trạng thái đơn vị",
                    error = ex.Message 
                });
            }
        }
    }
}
````

## File: WebApp.Server/Controllers/DotKeKhaiController.cs
````csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.API.Models;
using Microsoft.Extensions.Logging;
using System.Text.Json;
using System.ComponentModel.DataAnnotations;
using WebApp.API.Models.BienlaiDienTu;

namespace WebApp.API.Controllers
{
    [Authorize]
    [ApiController]
    [Route("api/[controller]")]
    public class DotKeKhaiController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<DotKeKhaiController> _logger;

        public DotKeKhaiController(
            ApplicationDbContext context,
            ILogger<DotKeKhaiController> logger)
        {
            _context = context;
            _logger = logger;
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<DotKeKhai>>> GetDotKeKhais()
        {
            try
            {
                var dotKeKhais = await _context.DotKeKhais
                    .Include(d => d.DonVi)
                    .Select(d => new
                    {
                        d.id,
                        d.ten_dot,
                        d.so_dot,
                        d.thang,
                        d.nam,
                        d.dich_vu,
                        d.ghi_chu,
                        d.trang_thai,
                        d.nguoi_tao,
                        d.don_vi_id,
                        d.ngay_tao,
                        d.ma_ho_so,
                        DonVi = d.DonVi,
                        tong_so_tien = _context.KeKhaiBHYTs
                            .Where(k => k.dot_ke_khai_id == d.id)
                            .Sum(k => k.so_tien_can_dong),
                        tong_so_the = _context.KeKhaiBHYTs
                            .Count(k => k.dot_ke_khai_id == d.id),
                        url_bill = _context.HoaDonThanhToans
                            .Where(h => h.dot_ke_khai_id == d.id && h.deleted_at == null)
                            .OrderByDescending(h => h.ngay_tao)
                            .Select(h => h.url_bill)
                            .FirstOrDefault()
                    })
                    .ToListAsync();

                return Ok(dotKeKhais);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting dot ke khai list: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách đợt kê khai", error = ex.Message });
            }
        }

        [HttpGet("{id}")]
        public async Task<ActionResult<DotKeKhai>> GetDotKeKhai(int id)
        {
            try
            {
                var dotKeKhai = await _context.DotKeKhais
                    .Include(d => d.DonVi)
                    .Where(d => d.id == id)
                    .Select(d => new
                    {
                        d.id,
                        d.ten_dot,
                        d.so_dot,
                        d.thang,
                        d.nam,
                        d.dich_vu,
                        d.ghi_chu,
                        d.trang_thai,
                        d.nguoi_tao,
                        d.don_vi_id,
                        d.ngay_tao,
                        d.ma_ho_so,
                        DonVi = d.DonVi,
                        tong_so_tien = _context.KeKhaiBHYTs
                            .Where(k => k.dot_ke_khai_id == d.id)
                            .Sum(k => k.so_tien_can_dong),
                        tong_so_the = _context.KeKhaiBHYTs
                            .Count(k => k.dot_ke_khai_id == d.id),
                        url_bill = _context.HoaDonThanhToans
                            .Where(h => h.dot_ke_khai_id == d.id && h.deleted_at == null)
                            .OrderByDescending(h => h.ngay_tao)
                            .Select(h => h.url_bill)
                            .FirstOrDefault()
                    })
                    .FirstOrDefaultAsync();

                if (dotKeKhai == null)
                {
                    return NotFound(new { message = "Không tìm thấy đợt kê khai" });
                }

                return Ok(dotKeKhai);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting dot ke khai {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy thông tin đợt kê khai", error = ex.Message });
            }
        }

        public class DotKeKhaiDTO
        {
            [Required]
            public int so_dot { get; set; }

            [Required]
            public int thang { get; set; }

            [Required]
            public int nam { get; set; }

            [Required]
            public int don_vi_id { get; set; }

            [Required]
            public int dai_ly_id { get; set; }

            public string? ghi_chu { get; set; }
        }

        [HttpPost]
        public async Task<ActionResult<DotKeKhai>> CreateDotKeKhai(DotKeKhai dotKeKhai)
        {
            try
            {
                // Kiểm tra đơn vị tồn tại và cập nhật dịch vụ
                var donVi = await _context.DonVis.FindAsync(dotKeKhai.don_vi_id);
                if (donVi == null)
                {
                    ModelState.AddModelError("don_vi_id", "Không tìm thấy đơn vị");
                    return BadRequest(new { errors = new[] { "Không tìm thấy đơn vị" } });
                }

                // Tự động xác định dịch vụ từ đơn vị
                dotKeKhai.dich_vu = donVi.IsBHYT ? "BHYT" : "BHXH TN";

                // Kiểm tra dữ liệu đầu vào
                if (!ModelState.IsValid)
                {
                    return BadRequest(ModelState);
                }

                // Tự động tạo tên đợt
                dotKeKhai.GenerateTenDot();
                if (string.IsNullOrEmpty(dotKeKhai.ten_dot))
                {
                    return BadRequest(new { message = "Không thể tạo tên đợt do dữ liệu không hợp lệ" });
                }

                // Kiểm tra trùng lặp
                var existingDot = await _context.DotKeKhais
                    .FirstOrDefaultAsync(d => d.don_vi_id == dotKeKhai.don_vi_id
                                            && d.thang == dotKeKhai.thang
                                            && d.nam == dotKeKhai.nam
                                            && d.dich_vu == dotKeKhai.dich_vu
                                            && d.so_dot == dotKeKhai.so_dot);

                if (existingDot != null)
                {
                    return Conflict(new { message = "Đợt kê khai đã tồn tại", existingId = existingDot.id });
                }

                // Thiết lập thông tin tạo
                dotKeKhai.ngay_tao = DateTime.Now;
                dotKeKhai.nguoi_tao = User.Identity.Name;

                _context.DotKeKhais.Add(dotKeKhai);
                await _context.SaveChangesAsync();

                // Nếu có mã hồ sơ, cập nhật mã hồ sơ cho tất cả các bản ghi KeKhaiBHYT của đợt
                if (!string.IsNullOrEmpty(dotKeKhai.ma_ho_so))
                {
                    var keKhaiBHYTs = await _context.KeKhaiBHYTs
                        .Where(k => k.dot_ke_khai_id == dotKeKhai.id)
                        .ToListAsync();

                    foreach (var keKhai in keKhaiBHYTs)
                    {
                        keKhai.ma_ho_so = dotKeKhai.ma_ho_so;
                    }

                    await _context.SaveChangesAsync();
                }

                return CreatedAtAction("GetDotKeKhai", new { id = dotKeKhai.id }, dotKeKhai);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error creating dot ke khai: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi tạo đợt kê khai", error = ex.Message });
            }
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateDotKeKhai(int id, DotKeKhai dotKeKhai)
        {
            try
            {
                if (id != dotKeKhai.id)
                {
                    return BadRequest(new { message = "ID không khớp" });
                }

                // Kiểm tra đơn vị tồn tại và cập nhật dịch vụ
                var donVi = await _context.DonVis.FindAsync(dotKeKhai.don_vi_id);
                if (donVi == null)
                {
                    ModelState.AddModelError("don_vi_id", "Không tìm thấy đơn vị");
                    return BadRequest(new { errors = new[] { "Không tìm thấy đơn vị" } });
                }

                // Tự động xác định dịch vụ từ đơn vị
                dotKeKhai.dich_vu = donVi.IsBHYT ? "BHYT" : "BHXH TN";

                // Kiểm tra dữ liệu đầu vào
                if (!ModelState.IsValid)
                {
                    return BadRequest(ModelState);
                }

                // Tự động tạo tên đợt
                dotKeKhai.GenerateTenDot();
                if (string.IsNullOrEmpty(dotKeKhai.ten_dot))
                {
                    return BadRequest(new { message = "Không thể tạo tên đợt do dữ liệu không hợp lệ" });
                }

                // Lấy đợt kê khai hiện tại để kiểm tra mã hồ sơ có thay đổi không
                var existingDotKeKhai = await _context.DotKeKhais.FindAsync(id);
                if (existingDotKeKhai == null)
                {
                    return NotFound(new { message = "Không tìm thấy đợt kê khai" });
                }

                // Kiểm tra trùng lặp nếu thông tin thay đổi
                if (existingDotKeKhai.don_vi_id != dotKeKhai.don_vi_id ||
                    existingDotKeKhai.thang != dotKeKhai.thang ||
                    existingDotKeKhai.nam != dotKeKhai.nam ||
                    existingDotKeKhai.dich_vu != dotKeKhai.dich_vu ||
                    existingDotKeKhai.so_dot != dotKeKhai.so_dot)
                {
                    var duplicateDot = await _context.DotKeKhais
                        .FirstOrDefaultAsync(d => d.id != id &&
                                                d.don_vi_id == dotKeKhai.don_vi_id &&
                                                d.thang == dotKeKhai.thang &&
                                                d.nam == dotKeKhai.nam &&
                                                d.dich_vu == dotKeKhai.dich_vu &&
                                                d.so_dot == dotKeKhai.so_dot);

                    if (duplicateDot != null)
                    {
                        return Conflict(new { message = "Đợt kê khai đã tồn tại", existingId = duplicateDot.id });
                    }
                }

                // Kiểm tra xem mã hồ sơ có thay đổi không
                bool maHoSoChanged = existingDotKeKhai.ma_ho_so != dotKeKhai.ma_ho_so;

                // Cập nhật đợt kê khai
                _context.Entry(existingDotKeKhai).CurrentValues.SetValues(dotKeKhai);
                _context.Entry(existingDotKeKhai).Property(x => x.ngay_tao).IsModified = false;
                _context.Entry(existingDotKeKhai).Property(x => x.nguoi_tao).IsModified = false;

                // Nếu mã hồ sơ thay đổi, cập nhật mã hồ sơ cho tất cả các bản ghi KeKhaiBHYT của đợt
                if (maHoSoChanged && !string.IsNullOrEmpty(dotKeKhai.ma_ho_so))
                {
                    var keKhaiBHYTs = await _context.KeKhaiBHYTs
                        .Where(k => k.dot_ke_khai_id == id)
                        .ToListAsync();

                    foreach (var keKhai in keKhaiBHYTs)
                    {
                        keKhai.ma_ho_so = dotKeKhai.ma_ho_so;
                    }
                }

                await _context.SaveChangesAsync();
                
                return NoContent();
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!DotKeKhaiExists(id))
                {
                    return NotFound(new { message = "Không tìm thấy đợt kê khai" });
                }
                throw;
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error updating dot ke khai {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi cập nhật đợt kê khai", error = ex.Message });
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteDotKeKhai(int id)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var dotKeKhai = await _context.DotKeKhais.FindAsync(id);
                if (dotKeKhai == null)
                {
                    return NotFound(new { message = "Không tìm thấy đợt kê khai" });
                }

                // Lấy tất cả các bản ghi kê khai BHYT trong đợt
                var keKhaiBHYTs = await _context.KeKhaiBHYTs
                    .Include(k => k.QuyenBienLai)
                    .Include(k => k.BienLai)
                    .Where(k => k.dot_ke_khai_id == id)
                    .ToListAsync();

                // Xử lý số biên lai cho từng bản ghi trước khi xóa
                foreach (var keKhai in keKhaiBHYTs)
                {
                    if (keKhai.QuyenBienLai != null && !string.IsNullOrEmpty(keKhai.so_bien_lai))
                    {
                        // Reset số hiện tại về số của biên lai bị xóa
                        keKhai.QuyenBienLai.so_hien_tai = keKhai.so_bien_lai;
                        
                        // Nếu trạng thái là đã sử dụng thì chuyển về đang sử dụng
                        if (keKhai.QuyenBienLai.trang_thai == "da_su_dung")
                        {
                            keKhai.QuyenBienLai.trang_thai = "dang_su_dung";
                        }
                        
                        _context.QuyenBienLais.Update(keKhai.QuyenBienLai);
                    }
                }

                await _context.SaveChangesAsync();

                // Xóa đợt kê khai (các bản ghi kê khai sẽ tự động bị xóa do có Cascade)
                _context.DotKeKhais.Remove(dotKeKhai);
                await _context.SaveChangesAsync();
                
                await transaction.CommitAsync();
                return NoContent();
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError($"Error deleting dot ke khai {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi xóa đợt kê khai", error = ex.Message });
            }
        }

        [HttpGet("next-so-dot")]
        public async Task<ActionResult<int>> GetNextSoDot(
            [FromQuery] int donViId, 
            [FromQuery] int thang,
            [FromQuery] int nam)
        {
            try
            {
                var donVi = await _context.DonVis.FindAsync(donViId);
                if (donVi == null)
                {
                    return BadRequest(new { message = "Không tìm thấy đơn vị" });
                }

                var lastDotKeKhai = await _context.DotKeKhais
                    .Where(d => d.don_vi_id == donViId 
                        && d.thang == thang
                        && d.nam == nam)
                    .OrderByDescending(d => d.so_dot)
                    .FirstOrDefaultAsync();

                var nextSoDot = (lastDotKeKhai?.so_dot ?? 0) + 1;

                // Kiểm tra xem số đợt tiếp theo đã tồn tại chưa
                while (await _context.DotKeKhais.AnyAsync(d => 
                    d.don_vi_id == donViId 
                    && d.thang == thang 
                    && d.nam == nam 
                    && d.so_dot == nextSoDot))
                {
                    nextSoDot++;
                }

                return Ok(nextSoDot);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting next so dot: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy số đợt tiếp theo" });
            }
        }

        [HttpGet("{id}/ke-khai-bhyt")]
        public async Task<ActionResult<IEnumerable<KeKhaiBHYT>>> GetKeKhaiBHYTs(int id)
        {
            try
            {
                // Lấy thông tin người dùng hiện tại
                var username = User.Identity?.Name;
                var nguoiDung = await _context.NguoiDungs
                    .FirstOrDefaultAsync(n => n.user_name == username);

                if (nguoiDung == null)
                {
                    return Unauthorized(new { message = "Không tìm thấy thông tin người dùng" });
                }

                _logger.LogInformation($"Bắt đầu lấy danh sách kê khai BHYT cho đợt {id}");

                // Kiểm tra đợt kê khai có tồn tại không
                var dotKeKhai = await _context.DotKeKhais
                    .AsNoTracking()
                    .FirstOrDefaultAsync(d => d.id == id);

                if (dotKeKhai == null)
                {
                    _logger.LogWarning($"Không tìm thấy đợt kê khai ID: {id}");
                    return NotFound(new { message = $"Không tìm thấy đợt kê khai có ID: {id}" });
                }

                _logger.LogInformation($"Tìm thấy đợt kê khai: {JsonSerializer.Serialize(dotKeKhai)}");

                if (dotKeKhai.dich_vu != "BHYT")
                {
                    _logger.LogWarning($"Đợt kê khai {id} không phải loại BHYT. Loại dịch vụ: {dotKeKhai.dich_vu}");
                    return BadRequest(new { message = $"Đợt kê khai này không phải là BHYT (Loại dịch vụ: {dotKeKhai.dich_vu})" });
                }

                // Lấy danh sách kê khai BHYT
                var keKhaiBHYTs = await _context.KeKhaiBHYTs
                    .Include(k => k.ThongTinThe)
                    .Include(k => k.QuyenBienLai)
                    .Where(k => k.dot_ke_khai_id == id)
                    .OrderBy(k => k.ngay_tao)
                    .Select(k => new
                    {
                        ho_ten = k.ThongTinThe.ho_ten,
                        cccd = k.ThongTinThe.cccd,
                        ma_so_bhxh = k.ThongTinThe.ma_so_bhxh,
                        ngay_sinh = k.ThongTinThe.ngay_sinh,
                        gioi_tinh = k.ThongTinThe.gioi_tinh,
                        phuong_an_dong = k.phuong_an_dong,
                        so_dien_thoai = k.ThongTinThe.so_dien_thoai,
                        so_the_bhyt = k.ThongTinThe.so_the_bhyt,
                        so_tien = k.so_tien_can_dong,
                        nguoi_thu = k.nguoi_thu,
                        ngay_bien_lai = k.ngay_bien_lai,
                        ma_tinh_nkq = k.ThongTinThe.ma_tinh_nkq,
                        ma_huyen_nkq = k.ThongTinThe.ma_huyen_nkq,
                        ma_xa_nkq = k.ThongTinThe.ma_xa_nkq,
                        dia_chi_nkq = k.dia_chi_nkq,
                        so_thang_dong = k.so_thang_dong,
                        ma_benh_vien = k.ThongTinThe.ma_benh_vien,
                        ma_hgd = k.ThongTinThe.ma_hgd,
                        quoc_tich = k.ThongTinThe.quoc_tich,
                        ma_tinh_ks = k.ThongTinThe.ma_tinh_ks,
                        ma_huyen_ks = k.ThongTinThe.ma_huyen_ks,
                        ma_xa_ks = k.ThongTinThe.ma_xa_ks,
                        han_the_moi_tu = k.han_the_moi_tu,
                        is_urgent = k.is_urgent,
                        so_bien_lai = k.so_bien_lai,
                        QuyenBienLai = new {
                            quyen_so = k.QuyenBienLai.quyen_so
                        },
                        ma_nhan_vien = nguoiDung.ma_nhan_vien,
                        ngay_tao = k.ngay_tao
                    })
                    .ToListAsync();

                _logger.LogInformation($"Tìm thấy {keKhaiBHYTs.Count} bản ghi kê khai BHYT cho đợt {id}");
                
                // Gán STT theo thứ tự đã sắp xếp
                var keKhaiBHYTsWithSTT = keKhaiBHYTs
                    .Select((k, index) => new {
                        stt = index + 1,
                        ho_ten = k.ho_ten,
                        cccd = k.cccd,
                        ma_so_bhxh = k.ma_so_bhxh,
                        ngay_sinh = k.ngay_sinh,
                        gioi_tinh = k.gioi_tinh,
                        phuong_an_dong = k.phuong_an_dong,
                        so_dien_thoai = k.so_dien_thoai,
                        so_the_bhyt = k.so_the_bhyt,
                        so_tien = k.so_tien,
                        nguoi_thu = k.nguoi_thu,
                        ngay_bien_lai = k.ngay_bien_lai,
                        ma_tinh_nkq = k.ma_tinh_nkq,
                        ma_huyen_nkq = k.ma_huyen_nkq,
                        ma_xa_nkq = k.ma_xa_nkq,
                        dia_chi_nkq = k.dia_chi_nkq,
                        so_thang_dong = k.so_thang_dong,
                        ma_benh_vien = k.ma_benh_vien,
                        ma_hgd = k.ma_hgd,
                        quoc_tich = k.quoc_tich,
                        ma_tinh_ks = k.ma_tinh_ks,
                        ma_huyen_ks = k.ma_huyen_ks,
                        ma_xa_ks = k.ma_xa_ks,
                        han_the_moi_tu = k.han_the_moi_tu,
                        is_urgent = k.is_urgent,
                        so_bien_lai = k.so_bien_lai,
                        QuyenBienLai = k.QuyenBienLai,
                        ma_nhan_vien = k.ma_nhan_vien,
                        ngay_tao = k.ngay_tao
                    })
                    .ToList();
                
                return Ok(keKhaiBHYTsWithSTT);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Lỗi khi lấy danh sách kê khai BHYT cho đợt {id}: {ex.Message}");
                _logger.LogError($"Stack trace: {ex.StackTrace}");
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách kê khai BHYT", error = ex.Message });
            }
        }

        [HttpPatch("{id}/trang-thai")]
        public async Task<IActionResult> UpdateTrangThai(int id, [FromBody] UpdateTrangThaiDto dto)
        {
            try
            {
                var dotKeKhai = await _context.DotKeKhais.FindAsync(id);
                if (dotKeKhai == null)
                {
                    return NotFound(new { message = "Không tìm thấy đợt kê khai" });
                }

                dotKeKhai.trang_thai = dto.trang_thai;
                await _context.SaveChangesAsync();

                return Ok(new { message = "Cập nhật trạng thái thành công" });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error updating dot ke khai status: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi cập nhật trạng thái đợt kê khai", error = ex.Message });
            }
        }

        [HttpPatch("{id}/gui")]
        public async Task<IActionResult> GuiDotKeKhai(int id, [FromBody] GuiDotKeKhaiDto? dto = null)
        {
            // Sử dụng transaction để đảm bảo tính toàn vẹn dữ liệu
            using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                // Kiểm tra đợt kê khai tồn tại
                var dotKeKhai = await _context.DotKeKhais
                    .Include(d => d.DonVi)
                    .FirstOrDefaultAsync(d => d.id == id);
                    
                if (dotKeKhai == null)
                {
                    return NotFound(new { message = "Không tìm thấy đợt kê khai" });
                }
                
                // Log giá trị ban đầu
                _logger.LogInformation($"Trước khi cập nhật: id={id}, is_bien_lai_dien_tu={dotKeKhai.is_bien_lai_dien_tu}");

                // Kiểm tra trạng thái hiện tại
                if (dotKeKhai.trang_thai != "chua_gui")
                {
                    return BadRequest(new { message = "Đợt kê khai không ở trạng thái chưa gửi" });
                }
                
                // Xác định xem có sử dụng biên lai điện tử hay không
                // Kiểm tra is_bien_lai_dien_tu của đợt kê khai trước
                bool useBienLaiDienTu = dotKeKhai.is_bien_lai_dien_tu;

                // Nếu is_bien_lai_dien_tu không true, mới xem xét đến dto
                if (!useBienLaiDienTu && dto != null)
                {
                    useBienLaiDienTu = dto.is_bien_lai_dien_tu;
                }
                
                _logger.LogInformation($"GuiDotKeKhai: id={id}, useBienLaiDienTu={useBienLaiDienTu}, dto={dto != null}, dotKeKhai.is_bien_lai_dien_tu={dotKeKhai.is_bien_lai_dien_tu}");

                // Cập nhật biên lai điện tử 
                dotKeKhai.is_bien_lai_dien_tu = useBienLaiDienTu;
                
                // Log giá trị sau khi cập nhật
                _logger.LogInformation($"Sau khi cập nhật: id={id}, is_bien_lai_dien_tu={dotKeKhai.is_bien_lai_dien_tu}");

                // Lấy thông tin người dùng đăng nhập
                var userName = User.Identity != null ? User.Identity.Name : null;
                if (string.IsNullOrEmpty(userName))
                {
                    return BadRequest(new { message = "Không tìm thấy thông tin người dùng đăng nhập" });
                }

                var nguoiThu = await _context.NguoiDungs
                    .FirstOrDefaultAsync(n => n.user_name == userName);

                if (nguoiThu == null)
                {
                    return BadRequest(new { message = "Không tìm thấy thông tin người thu" });
                }

                // Chỉ kiểm tra biên lai thông thường nếu không sử dụng biên lai điện tử
                QuyenBienLai? quyenBienLai = null;
                if (!useBienLaiDienTu)
                {
                    // Lấy quyển biên lai đang sử dụng
                    quyenBienLai = await _context.QuyenBienLais
                        .Where(q => q.nhan_vien_thu == nguoiThu.id && 
                               q.trang_thai == "dang_su_dung")
                        .OrderBy(q => q.ngay_cap)
                        .FirstOrDefaultAsync();

                    if (quyenBienLai == null)
                    {
                        _logger.LogWarning($"Không tìm thấy quyển biên lai thông thường cho người dùng {userName}. Chuyển sang sử dụng biên lai điện tử.");
                        // Khi không tìm thấy quyển biên lai thông thường, tự động chuyển sang sử dụng biên lai điện tử
                        useBienLaiDienTu = true;
                        dotKeKhai.is_bien_lai_dien_tu = true;
                        _logger.LogInformation($"Đã chuyển sang sử dụng biên lai điện tử do không tìm thấy quyển biên lai thông thường: is_bien_lai_dien_tu={dotKeKhai.is_bien_lai_dien_tu}");
                    }
                }

                // Cập nhật trạng thái đợt kê khai sang chờ thanh toán
                dotKeKhai.trang_thai = "cho_thanh_toan";
                
                // Cập nhật trạng thái các kê khai BHYT trong đợt và cấp số biên lai
                // Nếu đang cập nhật từ không sử dụng biên lai điện tử sang sử dụng, lấy tất cả các kê khai
                // bao gồm cả những kê khai đã có số biên lai (biên lai thông thường)
                var keKhaiBHYTsQuery = _context.KeKhaiBHYTs
                    .Include(k => k.ThongTinThe)
                    .Where(k => k.dot_ke_khai_id == id);
                
                // Nếu không phải chuyển từ biên lai thường sang biên lai điện tử, chỉ lấy các kê khai chưa có số biên lai
                if (!useBienLaiDienTu || !dotKeKhai.is_bien_lai_dien_tu)
                {
                    keKhaiBHYTsQuery = keKhaiBHYTsQuery.Where(k => k.so_bien_lai == null);
                }
                
                var keKhaiBHYTs = await keKhaiBHYTsQuery.OrderBy(k => k.id).ToListAsync();
                
                _logger.LogInformation($"Số lượng kê khai BHYT cần xử lý: {keKhaiBHYTs.Count}, useBienLaiDienTu: {useBienLaiDienTu}");

                foreach (var keKhai in keKhaiBHYTs)
                {
                    // Cập nhật trạng thái
                    keKhai.trang_thai = "cho_thanh_toan";
                    
                    // Chỉ xử lý biên lai thông thường nếu không sử dụng biên lai điện tử
                    if (!useBienLaiDienTu && quyenBienLai != null)
                    {
                        // Gán quyển biên lai cho kê khai
                        keKhai.quyen_bien_lai_id = quyenBienLai.id;

                        if (quyenBienLai.so_hien_tai == null)
                        {
                            await transaction.RollbackAsync();
                            return BadRequest(new { message = "Số hiện tại không hợp lệ" });
                        }

                        try
                        {
                            var soHienTai = int.Parse(quyenBienLai.so_hien_tai);
                            var denSo = int.Parse(quyenBienLai.den_so);
                            
                            _logger.LogInformation($"Số hiện tại: {soHienTai}, Đến số: {denSo}");

                            if (soHienTai > denSo)
                            {
                                quyenBienLai.trang_thai = "da_su_dung";
                                await _context.SaveChangesAsync();
                                
                                // Tìm quyển biên lai mới
                                quyenBienLai = await _context.QuyenBienLais
                                    .Where(q => q.nhan_vien_thu == nguoiThu.id && 
                                           q.trang_thai == "chua_su_dung")
                                    .OrderBy(q => q.ngay_cap)
                                    .FirstOrDefaultAsync();
                                    
                                    if (quyenBienLai == null)
                                    {
                                        await transaction.RollbackAsync();
                                        return BadRequest(new { message = "Đã hết số biên lai, vui lòng cấp thêm quyển biên lai mới" });
                                    }
                                    
                                    // Cập nhật trạng thái quyển mới
                                    quyenBienLai.trang_thai = "dang_su_dung";
                                    quyenBienLai.so_hien_tai = quyenBienLai.tu_so;
                                    await _context.SaveChangesAsync();
                                    
                                    // Cập nhật lại số hiện tại
                                    soHienTai = int.Parse(quyenBienLai.so_hien_tai);
                                    denSo = int.Parse(quyenBienLai.den_so);
                            }

                            keKhai.so_bien_lai = soHienTai.ToString().PadLeft(quyenBienLai.so_hien_tai.Length, '0');
                            quyenBienLai.so_hien_tai = (soHienTai + 1).ToString().PadLeft(quyenBienLai.so_hien_tai.Length, '0');

                            _logger.LogInformation($"Cấp số biên lai: {keKhai.so_bien_lai}, Số tiếp theo: {quyenBienLai.so_hien_tai}");
                            
                            // Tạo biên lai
                            var bienLai = new BienLai
                            {
                                quyen_so = quyenBienLai.quyen_so,
                                so_bien_lai = keKhai.so_bien_lai,
                                ten_nguoi_dong = keKhai.ThongTinThe.ho_ten,
                                so_tien = keKhai.so_tien_can_dong,
                                ke_khai_bhyt_id = keKhai.id,
                                ma_so_bhxh = keKhai.ThongTinThe.ma_so_bhxh,
                                ma_nhan_vien = nguoiThu.ma_nhan_vien,
                                ngay_bien_lai = keKhai.ngay_bien_lai ?? DateTime.Now,
                                ma_co_quan_bhxh = dotKeKhai.DonVi?.MaCoQuanBHXH ?? "",
                                ma_so_bhxh_don_vi = dotKeKhai.DonVi?.MaSoBHXH ?? "",
                                tinh_chat = "bien_lai_goc",
                                is_bhyt = dotKeKhai.dich_vu == "BHYT",
                                is_bhxh = dotKeKhai.dich_vu == "BHXH TN"
                            };

                            _context.BienLais.Add(bienLai);
                        }
                        catch (Exception ex)
                        {
                            _logger.LogError($"Lỗi xử lý số biên lai: {ex.Message}");
                            await transaction.RollbackAsync();
                            throw;
                        }
                    }
                }

                if (useBienLaiDienTu)
                {
                    // Lấy mã cơ quan BHXH từ đơn vị của đợt kê khai
                    string maCoQuanBHXH = dotKeKhai.DonVi?.MaCoQuanBHXH ?? "";
                    
                    // Log thông tin về việc sử dụng biên lai điện tử
                    _logger.LogInformation($"Xử lý biên lai điện tử cho đợt kê khai {id}, mã cơ quan BHXH: {maCoQuanBHXH}");
                    
                    // Lấy quyển biên lai điện tử đang active dựa vào mã cơ quan BHXH
                    var quyenBienLaiDienTu = await _context.QuyenBienLaiDienTus
                        .Where(q => q.trang_thai == "active" && 
                               (string.IsNullOrEmpty(q.ma_co_quan_bhxh) || q.ma_co_quan_bhxh == maCoQuanBHXH))
                        .OrderBy(q => q.id)
                        .FirstOrDefaultAsync();
                        
                    // Nếu không tìm thấy quyển biên lai điện tử với mã cơ quan BHXH cụ thể, tìm quyển mặc định
                    if (quyenBienLaiDienTu == null)
                    {
                        quyenBienLaiDienTu = await _context.QuyenBienLaiDienTus
                            .Where(q => q.trang_thai == "active")
                            .OrderBy(q => q.id)
                            .FirstOrDefaultAsync();
                    }
                        
                    if (quyenBienLaiDienTu == null)
                    {
                        await transaction.RollbackAsync();
                        return BadRequest(new { message = "Không tìm thấy quyển biên lai điện tử khả dụng" });
                    }
                    
                    _logger.LogInformation($"Sử dụng quyển biên lai điện tử ID: {quyenBienLaiDienTu.id}, Mã cơ quan BHXH: {quyenBienLaiDienTu.ma_co_quan_bhxh}");
                    
                    foreach (var keKhai in keKhaiBHYTs)
                    {
                        // Kiểm tra xem kê khai đã có số biên lai điện tử chưa
                        var existingBienLaiDienTu = await _context.BienLaiDienTus
                            .Where(b => b.ke_khai_bhyt_id == keKhai.id)
                            .FirstOrDefaultAsync();
                            
                        // Nếu đã có biên lai điện tử, bỏ qua kê khai này
                        if (existingBienLaiDienTu != null)
                        {
                            _logger.LogInformation($"Kê khai {keKhai.id} đã có biên lai điện tử {existingBienLaiDienTu.so_bien_lai}, bỏ qua");
                            continue;
                        }
                        
                        // Tăng số biên lai điện tử
                        int soHienTai = int.Parse(quyenBienLaiDienTu.so_hien_tai ?? "0000001");
                        int denSo = int.Parse(quyenBienLaiDienTu.den_so);
                        
                        // Kiểm tra nếu vượt quá số cuối cùng
                        if (soHienTai > denSo)
                        {
                            await transaction.RollbackAsync();
                            return BadRequest(new { message = "Quyển biên lai điện tử đã hết" });
                        }
                        
                        string soBienLaiDienTu = soHienTai.ToString("D7");
                        
                        // Tạo biên lai điện tử
                        var bienLaiDienTu = new BienLaiDienTu
                        {
                            quyen_bien_lai_dien_tu_id = quyenBienLaiDienTu.id,
                            ky_hieu = quyenBienLaiDienTu.ky_hieu,
                            so_bien_lai = soBienLaiDienTu,
                            ten_nguoi_dong = keKhai.ThongTinThe.ho_ten,
                            so_tien = keKhai.so_tien_can_dong,
                            ghi_chu = $"Biên lai điện tử cho kê khai id {keKhai.id}",
                            ma_so_bhxh = keKhai.ThongTinThe.ma_so_bhxh ?? "",
                            ma_nhan_vien = nguoiThu.ma_nhan_vien ?? "",
                            // Ưu tiên lấy mã cơ quan BHXH từ đơn vị, nếu không có thì lấy từ quyển biên lai
                            ma_co_quan_bhxh = !string.IsNullOrEmpty(dotKeKhai.DonVi?.MaCoQuanBHXH) 
                                ? dotKeKhai.DonVi.MaCoQuanBHXH 
                                : quyenBienLaiDienTu.ma_co_quan_bhxh,
                            ma_so_bhxh_don_vi = dotKeKhai.DonVi?.MaSoBHXH ?? "",
                            is_bhyt = dotKeKhai.dich_vu == "BHYT",
                            is_bhxh = dotKeKhai.dich_vu != "BHYT",
                            ngay_tao = DateTime.Now,
                            ngay_bien_lai = DateTime.Now,
                            ke_khai_bhyt_id = keKhai.id
                        };
                        
                        _context.BienLaiDienTus.Add(bienLaiDienTu);
                        
                        // Cập nhật số biên lai vào bảng ke_khai_bhyt
                        keKhai.so_bien_lai = soBienLaiDienTu;
                        
                        // Cập nhật số hiện tại trong quyển biên lai
                        quyenBienLaiDienTu.so_hien_tai = (soHienTai + 1).ToString("D7");
                    }
                    
                    await _context.SaveChangesAsync();
                }

                await _context.SaveChangesAsync();
                await transaction.CommitAsync();

                return Ok(new { message = "Gửi đợt kê khai thành công" });
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError($"Error sending dot ke khai {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi gửi đợt kê khai", error = ex.Message });
            }
        }

        [HttpPost("{id}/update-ma-ho-so")]
        public async Task<IActionResult> UpdateMaHoSo(int id, [FromBody] UpdateMaHoSoDto dto)
        {
            try
            {
                // Tìm đợt kê khai theo ID
                var dotKeKhai = await _context.DotKeKhais.FindAsync(id);
                if (dotKeKhai == null)
                {
                    return NotFound($"Không tìm thấy đợt kê khai với ID {id}");
                }

                // Cập nhật chỉ trường ma_ho_so
                dotKeKhai.ma_ho_so = dto.ma_ho_so;
                
                // Lưu thay đổi
                await _context.SaveChangesAsync();

                // Cập nhật mã hồ sơ cho tất cả các bản ghi KeKhaiBHYT của đợt
                if (!string.IsNullOrEmpty(dto.ma_ho_so))
                {
                    var keKhaiBHYTs = await _context.KeKhaiBHYTs
                        .Where(k => k.dot_ke_khai_id == id)
                        .ToListAsync();

                    foreach (var keKhai in keKhaiBHYTs)
                    {
                        keKhai.ma_ho_so = dto.ma_ho_so;
                    }

                    await _context.SaveChangesAsync();
                }
                
                return Ok(new { success = true, message = "Cập nhật mã hồ sơ thành công" });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error updating ma_ho_so for dot ke khai {id}: {ex.Message}");
                return StatusCode(500, new { success = false, message = "Lỗi khi cập nhật mã hồ sơ", error = ex.Message });
            }
        }

        public class UpdateTrangThaiDto
        {
            public string trang_thai { get; set; }
        }

        public class UpdateMaHoSoDto
        {
            public string? ma_ho_so { get; set; }
        }

        public class GuiDotKeKhaiDto
        {
            public bool is_bien_lai_dien_tu { get; set; } = false;
        }

        private bool DotKeKhaiExists(int id)
        {
            return _context.DotKeKhais.Any(e => e.id == id);
        }
    }
}
````

## File: WebApp.Server/Controllers/HoaDonThanhToanController.cs
````csharp
using System;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using WebApp.API.Data;
using WebApp.API.Models;

namespace WebApp.API.Controllers
{
    [Authorize]
    [ApiController]
    [Route("api/[controller]")]
    public class HoaDonThanhToanController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<HoaDonThanhToanController> _logger;

        public HoaDonThanhToanController(
            ApplicationDbContext context,
            ILogger<HoaDonThanhToanController> logger)
        {
            _context = context;
            _logger = logger;
        }

        public class CreateHoaDonRequest
        {
            public int dot_ke_khai_id { get; set; }
            public string noi_dung_thanh_toan { get; set; }
            public string url_bill { get; set; }
            public string public_id { get; set; }
            public string nguoi_tao { get; set; }
            public string? ghi_chu { get; set; }
        }

        [HttpPost]
        public async Task<ActionResult<HoaDonThanhToan>> CreateHoaDon(CreateHoaDonRequest request)
        {
            try
            {
                // Kiểm tra đợt kê khai tồn tại
                var dotKeKhai = await _context.DotKeKhais.FindAsync(request.dot_ke_khai_id);
                if (dotKeKhai == null)
                {
                    return BadRequest(new { message = "Không tìm thấy đợt kê khai" });
                }

                // Lấy tổng số tiền từ đợt kê khai
                var tongSoTien = await _context.KeKhaiBHYTs
                    .Where(k => k.dot_ke_khai_id == request.dot_ke_khai_id)
                    .SumAsync(k => k.so_tien_can_dong);

                // Tạo hóa đơn mới
                var hoaDon = new HoaDonThanhToan
                {
                    dot_ke_khai_id = request.dot_ke_khai_id,
                    noi_dung_thanh_toan = request.noi_dung_thanh_toan,
                    url_bill = request.url_bill,
                    public_id = request.public_id,
                    nguoi_tao = request.nguoi_tao,
                    ghi_chu = request.ghi_chu,
                    so_tien = tongSoTien,
                    trang_thai = "cho_duyet"
                };

                _context.HoaDonThanhToans.Add(hoaDon);

                // Chỉ cập nhật url_bill của đợt kê khai
                await _context.Database.ExecuteSqlRawAsync(
                    "UPDATE dot_ke_khai SET url_bill = {0} WHERE id = {1}",
                    request.url_bill, request.dot_ke_khai_id
                );

                await _context.SaveChangesAsync();

                return CreatedAtAction(nameof(GetHoaDon), new { id = hoaDon.id }, hoaDon);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error creating hoa don: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi tạo hóa đơn", error = ex.Message });
            }
        }

        [HttpGet("{id}")]
        public async Task<ActionResult<HoaDonThanhToan>> GetHoaDon(int id)
        {
            try
            {
                var hoaDon = await _context.HoaDonThanhToans.FindAsync(id);

                if (hoaDon == null)
                {
                    return NotFound(new { message = "Không tìm thấy hóa đơn" });
                }

                return Ok(hoaDon);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting hoa don {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy thông tin hóa đơn", error = ex.Message });
            }
        }
    }
}
````

## File: WebApp.Server/Controllers/IpController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Net;

namespace WebApp.API.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class IpController : ControllerBase
    {
        private readonly ILogger<IpController> _logger;

        public IpController(ILogger<IpController> logger)
        {
            _logger = logger;
        }

        [HttpGet]
        public IActionResult GetIpAddress()
        {
            var ip = HttpContext.Connection.RemoteIpAddress?.ToString() ?? "unknown";
            _logger.LogInformation($"Client IP address: {ip}");
            return Ok(ip);
        }
    }
}
````

## File: WebApp.Server/Controllers/KeKhaiBHXHController.cs
````csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.API.Models;
using Microsoft.Extensions.Logging;
using System.Text.Json;
using System.Text.Json.Serialization;
using Npgsql;
using System.IO;
using OfficeOpenXml;

namespace WebApp.API.Controllers
{
    [Authorize]
    [ApiController]
    [Route("api/dot-ke-khai")]
    public class KeKhaiBHXHController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<KeKhaiBHXHController> _logger;

        public KeKhaiBHXHController(
            ApplicationDbContext context,
            ILogger<KeKhaiBHXHController> logger)
        {
            _context = context;
            _logger = logger;
        }

        // GET: api/dot-ke-khai/{dotKeKhaiId}/ke-khai-bhxh
        [HttpGet("{dotKeKhaiId}/ke-khai-bhxh")]
        public async Task<ActionResult<IEnumerable<object>>> GetKeKhaiBHXHsByDotKeKhaiId(int dotKeKhaiId)
        {
            try
            {
                var keKhaiBHXHs = await _context.KeKhaiBHXHs
                    .Include(k => k.ThongTinThe)
                    .Where(k => k.dot_ke_khai_id == dotKeKhaiId)
                    .Select(k => new {
                        k.id,
                        k.dot_ke_khai_id,
                        k.thong_tin_the_id,
                        ma_so_bhxh = k.ThongTinThe.ma_so_bhxh,
                        ho_ten = k.ThongTinThe.ho_ten,
                        cccd = k.ThongTinThe.cccd,
                        ngay_sinh = k.ThongTinThe.ngay_sinh,
                        gioi_tinh = k.ThongTinThe.gioi_tinh,
                        ma_hgd = k.ThongTinThe.ma_hgd,
                        ma_dan_toc = k.ThongTinThe.ma_dan_toc,
                        so_dien_thoai = k.ThongTinThe.so_dien_thoai,
                        k.muc_thu_nhap,
                        k.ty_le_dong,
                        k.ty_le_nsnn,
                        k.loai_nsnn,
                        k.tien_ho_tro,
                        k.so_tien_can_dong,
                        k.phuong_thuc_dong,
                        k.thang_bat_dau,
                        k.so_thang_dong,
                        k.phuong_an,
                        k.loai_khai_bao,
                        k.ngay_bien_lai,
                        k.so_bien_lai,
                        k.trang_thai,
                        k.nguoi_tao,
                        k.ngay_tao,
                        k.ghi_chu,
                        k.tinh_nkq,
                        k.huyen_nkq,
                        k.xa_nkq
                    })
                    .ToListAsync();

                return Ok(keKhaiBHXHs);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Lỗi khi lấy danh sách kê khai BHXH theo đợt kê khai: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách kê khai BHXH", error = ex.Message });
            }
        }

        // GET: api/dot-ke-khai/{dotKeKhaiId}/ke-khai-bhxh/{id}
        [HttpGet("{dotKeKhaiId}/ke-khai-bhxh/{id}")]
        public async Task<ActionResult<KeKhaiBHXH>> GetKeKhaiBHXH(int dotKeKhaiId, int id)
        {
            try
            {
                var keKhaiBHXH = await _context.KeKhaiBHXHs
                    .Include(k => k.ThongTinThe)
                    .FirstOrDefaultAsync(k => k.dot_ke_khai_id == dotKeKhaiId && k.id == id);

                if (keKhaiBHXH == null)
                {
                    return NotFound(new { message = "Không tìm thấy kê khai BHXH" });
                }

                return Ok(keKhaiBHXH);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Lỗi khi lấy thông tin kê khai BHXH: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy thông tin kê khai BHXH", error = ex.Message });
            }
        }

        // POST: api/dot-ke-khai/ke-khai-bhxh
        [HttpPost("ke-khai-bhxh")]
        public async Task<ActionResult<KeKhaiBHXH>> CreateKeKhaiBHXH([FromBody] JsonElement requestData)
        {
            try
            {
                _logger.LogInformation("Nhận yêu cầu tạo kê khai BHXH");
                
                // Lấy thông tin từ request
                if (!requestData.TryGetProperty("dot_ke_khai_id", out JsonElement dotKeKhaiIdElement))
                {
                    return BadRequest(new { message = "Thiếu thông tin dot_ke_khai_id" });
                }
                
                int dotKeKhaiId = dotKeKhaiIdElement.GetInt32();
                
                // Kiểm tra đợt kê khai tồn tại
                var dotKeKhai = await _context.DotKeKhais.FindAsync(dotKeKhaiId);
                if (dotKeKhai == null)
                {
                    return NotFound(new { message = $"Không tìm thấy đợt kê khai với ID: {dotKeKhaiId}" });
                }
                
                // Lấy thông tin thẻ từ request
                if (!requestData.TryGetProperty("thong_tin_the", out JsonElement thongTinTheElement))
                {
                    return BadRequest(new { message = "Thiếu thông tin thẻ" });
                }
                
                // Xử lý thông tin thẻ
                var thongTinThe = new ThongTinThe
                {
                    ma_so_bhxh = GetStringProperty(thongTinTheElement, "ma_so_bhxh"),
                    cccd = GetStringProperty(thongTinTheElement, "cccd"),
                    ho_ten = GetStringProperty(thongTinTheElement, "ho_ten"),
                    ngay_sinh = GetStringProperty(thongTinTheElement, "ngay_sinh"),
                    gioi_tinh = GetStringProperty(thongTinTheElement, "gioi_tinh"),
                    so_dien_thoai = GetStringProperty(thongTinTheElement, "so_dien_thoai", ""),
                    ma_tinh_nkq = GetStringProperty(thongTinTheElement, "ma_tinh_nkq", ""),
                    ma_huyen_nkq = GetStringProperty(thongTinTheElement, "ma_huyen_nkq", ""),
                    ma_xa_nkq = GetStringProperty(thongTinTheElement, "ma_xa_nkq", ""),
                    ma_tinh_ks = GetStringProperty(thongTinTheElement, "ma_tinh_ks", ""),
                    ma_huyen_ks = GetStringProperty(thongTinTheElement, "ma_huyen_ks", ""),
                    ma_xa_ks = GetStringProperty(thongTinTheElement, "ma_xa_ks", ""),
                    ma_dan_toc = GetStringProperty(thongTinTheElement, "ma_dan_toc", ""),
                    ma_hgd = GetStringProperty(thongTinTheElement, "ma_hgd", ""),
                    quoc_tich = "VN",
                    nguoi_tao = GetStringProperty(requestData, "nguoi_tao"),
                    ngay_tao = DateTime.Now
                };
                
                // Kiểm tra nếu thẻ đã tồn tại (dựa vào mã số BHXH hoặc CCCD)
                var existingThe = await _context.ThongTinThes
                    .FirstOrDefaultAsync(t => t.ma_so_bhxh == thongTinThe.ma_so_bhxh || t.cccd == thongTinThe.cccd);
                
                if (existingThe != null)
                {
                    // Cập nhật thông tin thẻ nếu đã tồn tại
                    existingThe.ho_ten = thongTinThe.ho_ten;
                    existingThe.ngay_sinh = thongTinThe.ngay_sinh;
                    existingThe.gioi_tinh = thongTinThe.gioi_tinh;
                    existingThe.so_dien_thoai = thongTinThe.so_dien_thoai;
                    existingThe.ma_tinh_nkq = thongTinThe.ma_tinh_nkq;
                    existingThe.ma_huyen_nkq = thongTinThe.ma_huyen_nkq;
                    existingThe.ma_xa_nkq = thongTinThe.ma_xa_nkq;
                    existingThe.ma_tinh_ks = thongTinThe.ma_tinh_ks;
                    existingThe.ma_huyen_ks = thongTinThe.ma_huyen_ks;
                    existingThe.ma_xa_ks = thongTinThe.ma_xa_ks;
                    existingThe.ma_dan_toc = thongTinThe.ma_dan_toc;
                    existingThe.ma_hgd = thongTinThe.ma_hgd;
                    
                    _context.ThongTinThes.Update(existingThe);
                    thongTinThe = existingThe;
                }
                else
                {
                    // Thêm mới nếu chưa tồn tại
                    _context.ThongTinThes.Add(thongTinThe);
                }
                
                await _context.SaveChangesAsync();
                
                // Tạo kê khai BHXH
                var keKhaiBHXH = new KeKhaiBHXH
                {
                    dot_ke_khai_id = dotKeKhaiId,
                    thong_tin_the_id = thongTinThe.id,
                    muc_thu_nhap = GetDecimalProperty(requestData, "muc_thu_nhap"),
                    ty_le_dong = GetDecimalProperty(requestData, "ty_le_dong"),
                    ty_le_nsnn = GetDecimalProperty(requestData, "ty_le_nsnn"),
                    loai_nsnn = GetStringProperty(requestData, "loai_nsnn"),
                    tien_ho_tro = GetDecimalProperty(requestData, "tien_ho_tro"),
                    so_tien_can_dong = GetDecimalProperty(requestData, "so_tien_can_dong"),
                    phuong_thuc_dong = GetInt32Property(requestData, "phuong_thuc_dong"),
                    thang_bat_dau = GetStringProperty(requestData, "thang_bat_dau"),
                    phuong_an = GetStringProperty(requestData, "phuong_an"),
                    loai_khai_bao = GetStringProperty(requestData, "loai_khai_bao"),
                    ngay_bien_lai = GetDateTimeProperty(requestData, "ngay_bien_lai"),
                    ghi_chu = GetStringProperty(requestData, "ghi_chu", ""),
                    nguoi_tao = GetStringProperty(requestData, "nguoi_tao"),
                    ngay_tao = DateTime.Now,
                    trang_thai = "chua_gui",
                    so_bien_lai = "",
                    ma_nhan_vien = GetStringProperty(requestData, "ma_nhan_vien", ""),
                    tinh_nkq = GetStringProperty(requestData, "tinh_nkq", ""),
                    huyen_nkq = GetStringProperty(requestData, "huyen_nkq", ""),
                    xa_nkq = GetStringProperty(requestData, "xa_nkq", "")
                };
                
                _context.KeKhaiBHXHs.Add(keKhaiBHXH);
                await _context.SaveChangesAsync();
                
                return CreatedAtAction(nameof(GetKeKhaiBHXH), new { dotKeKhaiId, id = keKhaiBHXH.id }, new { id = keKhaiBHXH.id });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Lỗi khi tạo kê khai BHXH: {ex.Message}");
                _logger.LogError($"Stack trace: {ex.StackTrace}");
                if (ex.InnerException != null)
                {
                    _logger.LogError($"Inner exception: {ex.InnerException.Message}");
                }
                return StatusCode(500, new { message = "Lỗi khi tạo kê khai BHXH", error = ex.Message });
            }
        }

        // Các phương thức hỗ trợ để lấy giá trị từ JsonElement
        private string GetStringProperty(JsonElement element, string propertyName, string defaultValue = "")
        {
            if (element.TryGetProperty(propertyName, out JsonElement property) && 
                property.ValueKind != JsonValueKind.Null && 
                property.ValueKind != JsonValueKind.Undefined)
            {
                return property.GetString() ?? defaultValue;
            }
            return defaultValue;
        }

        private decimal GetDecimalProperty(JsonElement element, string propertyName, decimal defaultValue = 0)
        {
            if (element.TryGetProperty(propertyName, out JsonElement property) && 
                property.ValueKind != JsonValueKind.Null && 
                property.ValueKind != JsonValueKind.Undefined)
            {
                return property.GetDecimal();
            }
            return defaultValue;
        }

        private int GetInt32Property(JsonElement element, string propertyName, int defaultValue = 0)
        {
            if (element.TryGetProperty(propertyName, out JsonElement property) && 
                property.ValueKind != JsonValueKind.Null && 
                property.ValueKind != JsonValueKind.Undefined)
            {
                return property.GetInt32();
            }
            return defaultValue;
        }

        private DateTime GetDateTimeProperty(JsonElement element, string propertyName, DateTime? defaultValue = null)
        {
            if (element.TryGetProperty(propertyName, out JsonElement property) && 
                property.ValueKind != JsonValueKind.Null && 
                property.ValueKind != JsonValueKind.Undefined)
            {
                return DateTime.Parse(property.GetString());
            }
            return defaultValue ?? DateTime.Now;
        }

        // PUT: api/dot-ke-khai/{dotKeKhaiId}/ke-khai-bhxh/{id}
        [HttpPut("{dotKeKhaiId}/ke-khai-bhxh/{id}")]
        public async Task<IActionResult> UpdateKeKhaiBHXH(int dotKeKhaiId, int id, KeKhaiBHXH keKhaiBHXH)
        {
            if (id != keKhaiBHXH.id || dotKeKhaiId != keKhaiBHXH.dot_ke_khai_id)
            {
                return BadRequest(new { message = "ID không khớp" });
            }

            try
            {
                _context.Entry(keKhaiBHXH).State = EntityState.Modified;
                await _context.SaveChangesAsync();
                return NoContent();
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!KeKhaiBHXHExists(id))
                {
                    return NotFound(new { message = "Không tìm thấy kê khai BHXH" });
                }
                else
                {
                    throw;
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"Lỗi khi cập nhật kê khai BHXH: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi cập nhật kê khai BHXH", error = ex.Message });
            }
        }

        // DELETE: api/dot-ke-khai/{dotKeKhaiId}/ke-khai-bhxh/{id}
        [HttpDelete("{dotKeKhaiId}/ke-khai-bhxh/{id}")]
        public async Task<IActionResult> DeleteKeKhaiBHXH(int dotKeKhaiId, int id)
        {
            try
            {
                var keKhaiBHXH = await _context.KeKhaiBHXHs
                    .FirstOrDefaultAsync(k => k.dot_ke_khai_id == dotKeKhaiId && k.id == id);

                if (keKhaiBHXH == null)
                {
                    return NotFound(new { message = "Không tìm thấy kê khai BHXH" });
                }

                _context.KeKhaiBHXHs.Remove(keKhaiBHXH);
                await _context.SaveChangesAsync();

                return NoContent();
            }
            catch (Exception ex)
            {
                _logger.LogError($"Lỗi khi xóa kê khai BHXH: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi xóa kê khai BHXH", error = ex.Message });
            }
        }

        private bool KeKhaiBHXHExists(int id)
        {
            return _context.KeKhaiBHXHs.Any(e => e.id == id);
        }

        // GET: api/dot-ke-khai/{dotKeKhaiId}/ke-khai-bhxh-export-vnpt
        [HttpGet]
        [Route("{dotKeKhaiId}/ke-khai-bhxh-export-vnpt")]
        public async Task<IActionResult> ExportBHXHVNPT(int dotKeKhaiId)
        {
            try
            {
                // Kiểm tra đợt kê khai tồn tại
                var dotKeKhai = await _context.DotKeKhais
                    .Include(d => d.DonVi)
                    .FirstOrDefaultAsync(d => d.id == dotKeKhaiId);
                
                if (dotKeKhai == null)
                {
                    return NotFound(new { message = $"Không tìm thấy đợt kê khai với ID: {dotKeKhaiId}" });
                }

                // Lấy danh sách kê khai BHXH theo đợt kê khai
                var keKhaiBHXHs = await _context.KeKhaiBHXHs
                    .Include(k => k.ThongTinThe)
                    .Where(k => k.dot_ke_khai_id == dotKeKhaiId)
                    .ToListAsync();

                if (keKhaiBHXHs.Count == 0)
                {
                    return NotFound(new { message = "Không có dữ liệu kê khai BHXH trong đợt này" });
                }

                // Tạo bộ nhớ để chứa file Excel
                using (var memoryStream = new MemoryStream())
                {
                    using (var package = new OfficeOpenXml.ExcelPackage(memoryStream))
                    {
                        // Tạo worksheet
                        var worksheet = package.Workbook.Worksheets.Add("Dữ Liệu");

                        // Header
                        var headers = new List<string>
                        {
                            "STT",
                            "HoTen",
                            "MasoBHXH",
                            "Loai",
                            "PA",
                            "MucTien",
                            "Tuthang",
                            "Sothang",
                            "Tyle",
                            "TyleNSNN",
                            "TienHotro",
                            "TyleNSDP",
                            "TienNSDP",
                            "TyleHotroKhac",
                            "TienHotroKhac",
                            "TienTuDong",
                            "TongTien",
                            "TenTinhDangSS",
                            "Matinh_DangSS",
                            "TenhuyenDangSS",
                            "Mahuyen_DangSS",
                            "TenxaDangSS",
                            "Maxa_DangSS",
                            "Diachi_DangSS",
                            "GhiChu",
                            "PhuongPhuc",
                            "Heso",
                            "SoCCCD",
                            "SoBienLai",
                            "NgayBienLai",
                            "MaNhanvienThu",
                            "Tk1_Save",
                            "CMND",
                            "Maho_Giadinh",
                            "NgaySinh",
                            "GioiTinh",
                            "TenQuocTich",
                            "QuocTich",
                            "TenDanToc",
                            "DanToc",
                            "TenTinhBenhVien",
                            "MaTinhBenhVien",
                            "TenBenhVien",
                            "MaBenhVien",
                            "TenTinhKS",
                            "Matinh_KS",
                            "TenHuyenKS",
                            "Mahuyen_KS",
                            "TenXaKS",
                            "Maxa_KS",
                            "TenTinhNN",
                            "Matinh_NN",
                            "TenHuyenNN",
                            "TenXaNN",
                            "Maxa_NN",
                            "Diachi_NN"
                        };

                        // Set header style và nội dung
                        for (int i = 0; i < headers.Count; i++)
                        {
                            worksheet.Cells[1, i + 1].Value = headers[i];
                            worksheet.Cells[1, i + 1].Style.Font.Bold = true;
                            worksheet.Cells[1, i + 1].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                            worksheet.Cells[1, i + 1].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);
                            worksheet.Cells[1, i + 1].Style.Border.BorderAround(OfficeOpenXml.Style.ExcelBorderStyle.Thin);
                        }

                        // Fill data
                        for (int i = 0; i < keKhaiBHXHs.Count; i++)
                        {
                            var item = keKhaiBHXHs[i];
                            int row = i + 2; // Dòng 1 là header
                            
                            // Xác định loại đóng (1 = TM, 2 = DC)
                            int loai = item.phuong_an == "TM" ? 1 : 2;
                            
                            // Phương án
                            string phuongAn = item.phuong_an;
                            
                            // Tính tiền hỗ trợ (NSNN)
                            decimal tienHoTro = Math.Round(item.muc_thu_nhap * (item.ty_le_dong / 100) * ((item.ty_le_nsnn ?? 0) / 100));
                            
                            // Tính tiền tự đóng
                            decimal tienTuDong = item.so_tien_can_dong - tienHoTro;
                            
                            // Định dạng tháng bắt đầu thành mm/yyyy
                            string thangBatDau = "";
                            if (!string.IsNullOrEmpty(item.thang_bat_dau))
                            {
                                try
                                {
                                    // Nếu tháng bắt đầu có định dạng yyyy-MM hoặc yyyy/MM
                                    if (item.thang_bat_dau.Length >= 7 && 
                                        (item.thang_bat_dau.Contains("-") || item.thang_bat_dau.Contains("/")))
                                    {
                                        var parts = item.thang_bat_dau.Split(new char[] { '-', '/' });
                                        if (parts.Length >= 2)
                                        {
                                            // Chuyển từ yyyy-MM hoặc yyyy/MM thành MM/yyyy
                                            thangBatDau = $"{parts[1]}/{parts[0]}";
                                        }
                                    }
                                    else
                                    {
                                        // Nếu là định dạng khác, thử chuyển sang DateTime và định dạng lại
                                        var date = DateTime.Parse(item.thang_bat_dau);
                                        thangBatDau = date.ToString("MM/yyyy");
                                    }
                                }
                                catch
                                {
                                    // Nếu không chuyển đổi được, giữ nguyên giá trị
                                    thangBatDau = item.thang_bat_dau;
                                }
                            }
                            
                            // Lấy thông tin tỉnh, huyện, xã
                            string tenTinh = item.tinh_nkq ?? "";
                            string tenHuyen = item.huyen_nkq ?? "";
                            string tenXa = item.xa_nkq ?? "";
                            
                            // Xác định hệ số từ giá trị phuong_thuc_dong
                            int heSo = item.phuong_thuc_dong;
                            
                            // Định dạng ngày biên lai
                            string ngayBienLai = item.ngay_bien_lai.HasValue ? item.ngay_bien_lai.Value.ToString("dd/MM/yyyy") : "";
                            
                            // Xác định giới tính dạng số (1 = nam, 0 = nữ)
                            int gioiTinh = item.ThongTinThe.gioi_tinh?.ToLower() == "nam" ? 1 : 0;
                            
                            // Định dạng ngày sinh
                            string ngaySinh = "";
                            if (!string.IsNullOrEmpty(item.ThongTinThe.ngay_sinh))
                            {
                                try
                                {
                                    ngaySinh = DateTime.Parse(item.ThongTinThe.ngay_sinh).Year.ToString();
                                }
                                catch
                                {
                                    ngaySinh = item.ThongTinThe.ngay_sinh;
                                }
                            }

                            // Quốc tịch
                            string tenQuocTich = "Việt Nam";
                            string quocTich = item.ThongTinThe.quoc_tich ?? "VN";

                            // Dân tộc
                            string tenDanToc = "";
                            string danToc = item.ThongTinThe.ma_dan_toc ?? "";
                            
                            // Phương phúc - Giá trị cho cột Z
                            string phuongPhuc = item.phuong_an == "TM" ? "TM" : "DC";
                            
                            // Thông tin KCB
                            string maNhanVienThu = item.ma_nhan_vien;
                            string tenTinhKS = "";
                            string maTinhKS = item.ThongTinThe.ma_tinh_ks ?? "";
                            string tenHuyenKS = "";
                            string maHuyenKS = item.ThongTinThe.ma_huyen_ks ?? "";
                            string tenXaKS = "";
                            string maXaKS = item.ThongTinThe.ma_xa_ks ?? "";
                            
                            // Thông tin nơi ở
                            string tenTinhNN = "";
                            string maTinhNN = item.ThongTinThe.ma_tinh_nkq ?? "";
                            string tenHuyenNN = "";
                            string maHuyenNN = item.ThongTinThe.ma_huyen_nkq ?? "";
                            string tenXaNN = "";
                            string maXaNN = item.ThongTinThe.ma_xa_nkq ?? "";
                            string diaChiNN = "";
                            
                            // Thông tin bệnh viện
                            string tenTinhBenhVien = "";
                            string maTinhBenhVien = "";
                            string tenBenhVien = "";
                            string maBenhVien = "";

                            // Các cột cũ
                            worksheet.Cells[row, 1].Value = i + 1; // STT
                            worksheet.Cells[row, 2].Value = item.ThongTinThe.ho_ten; // HoTen
                            worksheet.Cells[row, 3].Value = item.ThongTinThe.ma_so_bhxh; // MaSoBHXH
                            worksheet.Cells[row, 4].Value = loai; // Loai
                            worksheet.Cells[row, 5].Value = phuongAn; // PA
                            worksheet.Cells[row, 6].Value = item.muc_thu_nhap; // MucTien
                            worksheet.Cells[row, 7].Value = thangBatDau; // Tuthang
                            worksheet.Cells[row, 8].Value = item.phuong_thuc_dong; // Sothang
                            worksheet.Cells[row, 9].Value = item.ty_le_dong; // Tyle
                            worksheet.Cells[row, 10].Value = item.ty_le_nsnn; // TyleNSNN
                            worksheet.Cells[row, 11].Value = tienHoTro; // TienHotro
                            worksheet.Cells[row, 12].Value = 0; // TyleNSDP
                            worksheet.Cells[row, 13].Value = 0; // TienNSDP
                            worksheet.Cells[row, 14].Value = 0; // TyleHotroKhac
                            worksheet.Cells[row, 15].Value = 0; // TienHotroKhac
                            worksheet.Cells[row, 16].Value = tienTuDong; // TienTuDong
                            
                            // Các cột vừa thêm
                            worksheet.Cells[row, 17].Value = item.muc_thu_nhap; // TongTien
                            worksheet.Cells[row, 18].Value = tenTinh; // TenTinhDangSS
                            worksheet.Cells[row, 19].Value = maTinhNN; // Matinh_DangSS
                            worksheet.Cells[row, 20].Value = tenHuyen; // TenhuyenDangSS
                            worksheet.Cells[row, 21].Value = maHuyenNN; // Mahuyen_DangSS
                            worksheet.Cells[row, 22].Value = tenXa; // TenxaDangSS
                            worksheet.Cells[row, 23].Value = maXaNN; // Maxa_DangSS
                            worksheet.Cells[row, 24].Value = ""; // Diachi_DangSS
                            worksheet.Cells[row, 25].Value = item.ghi_chu; // GhiChu
                            worksheet.Cells[row, 26].Value = phuongPhuc; // PhuongPhuc
                            worksheet.Cells[row, 27].Value = heSo; // Heso
                            worksheet.Cells[row, 28].Value = item.ThongTinThe.cccd; // SoCCCD
                            worksheet.Cells[row, 29].Value = item.so_bien_lai; // SoBienLai
                            
                            // Các cột mới được thêm theo ảnh trước
                            worksheet.Cells[row, 30].Value = ngayBienLai; // NgayBienLai
                            worksheet.Cells[row, 31].Value = maNhanVienThu; // MaNhanvienThu
                            worksheet.Cells[row, 32].Value = ""; // Tk1_Save
                            worksheet.Cells[row, 33].Value = item.ThongTinThe.cccd; // CMND
                            worksheet.Cells[row, 34].Value = item.ThongTinThe.ma_hgd; // Maho_Giadinh
                            worksheet.Cells[row, 35].Value = ngaySinh; // NgaySinh
                            worksheet.Cells[row, 36].Value = gioiTinh; // GioiTinh
                            worksheet.Cells[row, 37].Value = tenQuocTich; // TenQuocTich
                            worksheet.Cells[row, 38].Value = quocTich; // QuocTich
                            worksheet.Cells[row, 39].Value = tenDanToc; // TenDanToc
                            worksheet.Cells[row, 40].Value = danToc; // DanToc
                            
                            // Các cột mới thêm từ ảnh mới về bệnh viện và KS
                            worksheet.Cells[row, 41].Value = tenTinhBenhVien; // TenTinhBenhVien
                            worksheet.Cells[row, 42].Value = maTinhBenhVien; // MaTinhBenhVien
                            worksheet.Cells[row, 43].Value = tenBenhVien; // TenBenhVien
                            worksheet.Cells[row, 44].Value = maBenhVien; // MaBenhVien
                            worksheet.Cells[row, 45].Value = tenTinhKS; // TenTinhKS
                            worksheet.Cells[row, 46].Value = maTinhKS; // Matinh_KS
                            worksheet.Cells[row, 47].Value = tenHuyenKS; // TenHuyenKS
                            worksheet.Cells[row, 48].Value = maHuyenKS; // Mahuyen_KS
                            worksheet.Cells[row, 49].Value = tenXaKS; // TenXaKS
                            worksheet.Cells[row, 50].Value = maXaKS; // Maxa_KS
                            worksheet.Cells[row, 51].Value = tenTinhNN; // TenTinhNN
                            worksheet.Cells[row, 52].Value = maTinhNN; // Matinh_NN
                            worksheet.Cells[row, 53].Value = tenHuyenNN; // TenHuyenNN
                            
                            // Các cột mới thêm từ ảnh mới nhất về xã nơi ở
                            worksheet.Cells[row, 54].Value = tenXaNN; // TenXaNN
                            worksheet.Cells[row, 55].Value = maXaNN; // Maxa_NN
                            worksheet.Cells[row, 56].Value = diaChiNN; // Diachi_NN

                            // Format các ô số
                            worksheet.Cells[row, 6].Style.Numberformat.Format = "#,##0"; // MucTien
                            worksheet.Cells[row, 11].Style.Numberformat.Format = "#,##0"; // TienHotro
                            worksheet.Cells[row, 13].Style.Numberformat.Format = "#,##0"; // TienNSDP
                            worksheet.Cells[row, 15].Style.Numberformat.Format = "#,##0"; // TienHotroKhac
                            worksheet.Cells[row, 16].Style.Numberformat.Format = "#,##0"; // TienTuDong
                            worksheet.Cells[row, 17].Style.Numberformat.Format = "#,##0"; // TongTien

                            // Thêm border cho các ô
                            for (int j = 1; j <= headers.Count; j++)
                            {
                                worksheet.Cells[row, j].Style.Border.BorderAround(OfficeOpenXml.Style.ExcelBorderStyle.Thin);
                            }
                        }

                        // Tự động điều chỉnh độ rộng cột
                        worksheet.Cells.AutoFitColumns();

                        // Lưu workbook
                        package.Save();
                    }

                    // Trả về file Excel
                    memoryStream.Position = 0;
                    string fileName = $"BHXH_VNPT_{dotKeKhai.ten_dot?.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd}.xlsx";
                    return File(memoryStream.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"Lỗi khi xuất BHXH VNPT: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi xuất dữ liệu BHXH VNPT", error = ex.Message });
            }
        }
    }
}
````

## File: WebApp.Server/Controllers/KeKhaiBHYTController.cs
````csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.API.Models;
using Microsoft.Extensions.Logging;
using System.Text.Json;
using System.ComponentModel.DataAnnotations;

namespace WebApp.API.Controllers
{
    [Authorize]
    [ApiController]
    [Route("api/dot-ke-khai")]
    public class KeKhaiBHYTController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<KeKhaiBHYTController> _logger;

        public KeKhaiBHYTController(
            ApplicationDbContext context,
            ILogger<KeKhaiBHYTController> logger)
        {
            _context = context;
            _logger = logger;
        }

        [HttpGet("{dotKeKhaiId}/ke-khai-bhyt")]
        public async Task<ActionResult<IEnumerable<KeKhaiBHYT>>> GetByDotKeKhai(int dotKeKhaiId)
        {
            try
            {
                var keKhaiBHYTs = await _context.KeKhaiBHYTs
                    .Include(k => k.DotKeKhai)
                    .Include(k => k.ThongTinThe)
                    .Where(k => k.dot_ke_khai_id == dotKeKhaiId)
                    .Select(k => new KeKhaiBHYT
                    {
                        id = k.id,
                        dot_ke_khai_id = k.dot_ke_khai_id,
                        thong_tin_the_id = k.thong_tin_the_id,
                        nguoi_thu = k.nguoi_thu,
                        so_thang_dong = k.so_thang_dong,
                        phuong_an_dong = k.phuong_an_dong,
                        han_the_cu = k.han_the_cu,
                        han_the_moi_tu = k.han_the_moi_tu,
                        han_the_moi_den = k.han_the_moi_den,
                        tinh_nkq = k.tinh_nkq,
                        huyen_nkq = k.huyen_nkq,
                        xa_nkq = k.xa_nkq,
                        dia_chi_nkq = k.dia_chi_nkq,
                        benh_vien_kcb = k.benh_vien_kcb,
                        nguoi_tao = k.nguoi_tao,
                        ngay_tao = k.ngay_tao,
                        ngay_bien_lai = k.ngay_bien_lai,
                        so_tien_can_dong = k.so_tien_can_dong,
                        DotKeKhai = k.DotKeKhai,
                        ThongTinThe = k.ThongTinThe
                    })
                    .ToListAsync();

                return Ok(keKhaiBHYTs);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting ke khai BHYT list by dot ke khai {dotKeKhaiId}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách kê khai BHYT", error = ex.Message });
            }
        }

        [HttpGet("{dotKeKhaiId}/ke-khai-bhyt/{id}")]
        public async Task<ActionResult<KeKhaiBHYT>> GetKeKhaiBHYT(int dotKeKhaiId, int id)
        {
            try
            {
                var keKhaiBHYT = await _context.KeKhaiBHYTs
                    .Include(k => k.ThongTinThe)
                    .Include(k => k.DotKeKhai)
                    .FirstOrDefaultAsync(k => k.dot_ke_khai_id == dotKeKhaiId && k.id == id);

                if (keKhaiBHYT == null)
                {
                    return NotFound(new { message = "Không tìm thấy kê khai BHYT" });
                }

                return Ok(keKhaiBHYT);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting ke khai BHYT {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy thông tin kê khai BHYT", error = ex.Message });
            }
        }

        [HttpPost("{dotKeKhaiId}/ke-khai-bhyt")]
        public async Task<IActionResult> CreateKeKhaiBHYT(int dotKeKhaiId, KeKhaiBHYT keKhaiBHYT)
        {
            // Sử dụng transaction để đảm bảo tính toàn vẹn dữ liệu
            using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                // Kiểm tra đợt kê khai tồn tại
                var dotKeKhai = await _context.DotKeKhais
                    .Include(d => d.DonVi)
                    .FirstOrDefaultAsync(d => d.id == dotKeKhaiId);

                if (dotKeKhai == null)
                {
                    return NotFound(new { message = "Không tìm thấy đợt kê khai" });
                }

                // Kiểm tra trạng thái đợt kê khai
                if (dotKeKhai.trang_thai != "chua_gui")
                {
                    return BadRequest(new { message = "Đợt kê khai đã được gửi, không thể thêm mới" });
                }

                // Gán đợt kê khai cho kê khai BHYT
                keKhaiBHYT.dot_ke_khai_id = dotKeKhaiId;
                keKhaiBHYT.DotKeKhai = dotKeKhai;

                // Gán mã hồ sơ từ đợt kê khai nếu có
                if (!string.IsNullOrEmpty(dotKeKhai.ma_ho_so))
                {
                    keKhaiBHYT.ma_ho_so = dotKeKhai.ma_ho_so;
                }

                // Kiểm tra xem thông tin thẻ đã tồn tại chưa
                if (keKhaiBHYT.ThongTinThe != null && !string.IsNullOrEmpty(keKhaiBHYT.ThongTinThe.ma_so_bhxh))
                {
                    var existingThongTinThe = await _context.ThongTinThes
                        .FirstOrDefaultAsync(t => t.ma_so_bhxh == keKhaiBHYT.ThongTinThe.ma_so_bhxh);

                    if (existingThongTinThe != null)
                    {
                        // Sử dụng thông tin thẻ đã tồn tại
                        keKhaiBHYT.thong_tin_the_id = existingThongTinThe.id;
                        keKhaiBHYT.ThongTinThe = existingThongTinThe;
                        
                        // Cập nhật thông tin thẻ nếu cần
                        _context.Entry(existingThongTinThe).CurrentValues.SetValues(keKhaiBHYT.ThongTinThe);
                    }
                }

                // Lấy thông tin người dùng đăng nhập
                var userName = User.Identity != null ? User.Identity.Name : null;
                if (string.IsNullOrEmpty(userName))
                {
                    _logger.LogWarning("Không tìm thấy thông tin người dùng đăng nhập");
                    return BadRequest(new { message = "Không tìm thấy thông tin người dùng đăng nhập" });
                }

                // Gán thông tin người tạo
                keKhaiBHYT.nguoi_tao = userName;
                keKhaiBHYT.ngay_tao = DateTime.Now;

                // Lưu kê khai BHYT
                _context.KeKhaiBHYTs.Add(keKhaiBHYT);
                await _context.SaveChangesAsync();

                // Nếu mọi thứ OK thì commit transaction
                await transaction.CommitAsync();

                return CreatedAtAction(nameof(GetKeKhaiBHYT), 
                    new { dotKeKhaiId, id = keKhaiBHYT.id }, 
                    new { success = true, message = "Tạo kê khai BHYT thành công", data = keKhaiBHYT }
                );
            }
            catch (Exception ex)
            {
                // Có lỗi thì rollback transaction
                await transaction.RollbackAsync();
                _logger.LogError($"Error creating ke khai BHYT: {ex.Message}");
                return StatusCode(500, new {
                    success = false,
                    message = "Lỗi khi tạo kê khai BHYT",
                    error = ex.Message
                });
            }
        }

        [HttpPut("{dotKeKhaiId}/ke-khai-bhyt/{id}")]
        public async Task<IActionResult> UpdateKeKhaiBHYT(int dotKeKhaiId, int id, KeKhaiBHYT keKhaiBHYT)
        {
            if (id != keKhaiBHYT.id || dotKeKhaiId != keKhaiBHYT.dot_ke_khai_id)
            {
                return BadRequest(new { message = "ID không khớp" });
            }

            try
            {
                var existingKeKhaiBHYT = await _context.KeKhaiBHYTs
                    .Include(k => k.ThongTinThe)
                    .Include(k => k.DotKeKhai)
                    .FirstOrDefaultAsync(k => k.dot_ke_khai_id == dotKeKhaiId && k.id == id);
                    
                if (existingKeKhaiBHYT == null)
                {
                    return NotFound(new { message = "Không tìm thấy kê khai BHYT" });
                }

                // Cập nhật thông tin thẻ
                if (existingKeKhaiBHYT.ThongTinThe != null && keKhaiBHYT.ThongTinThe != null)
                {
                    _context.Entry(existingKeKhaiBHYT.ThongTinThe).CurrentValues.SetValues(keKhaiBHYT.ThongTinThe);
                }

                // Lưu giá trị quyen_bien_lai_id hiện tại nếu không được cung cấp trong request
                if (keKhaiBHYT.quyen_bien_lai_id == null && existingKeKhaiBHYT.quyen_bien_lai_id != null)
                {
                    keKhaiBHYT.quyen_bien_lai_id = existingKeKhaiBHYT.quyen_bien_lai_id;
                }

                // Lưu giá trị trang_thai hiện tại nếu không được cung cấp trong request hoặc là giá trị mặc định
                if (string.IsNullOrEmpty(keKhaiBHYT.trang_thai) || keKhaiBHYT.trang_thai == "chua_gui")
                {
                    keKhaiBHYT.trang_thai = existingKeKhaiBHYT.trang_thai;
                }

                // Cập nhật thông tin kê khai
                _context.Entry(existingKeKhaiBHYT).CurrentValues.SetValues(keKhaiBHYT);

                // Đảm bảo mã hồ sơ được đồng bộ với đợt kê khai
                if (existingKeKhaiBHYT.DotKeKhai != null && !string.IsNullOrEmpty(existingKeKhaiBHYT.DotKeKhai.ma_ho_so))
                {
                    existingKeKhaiBHYT.ma_ho_so = existingKeKhaiBHYT.DotKeKhai.ma_ho_so;
                }

                await _context.SaveChangesAsync();

                return NoContent();
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!KeKhaiBHYTExists(dotKeKhaiId, id))
                {
                    return NotFound(new { message = "Không tìm thấy kê khai BHYT" });
                }
                throw;
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error updating ke khai BHYT {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi cập nhật kê khai BHYT", error = ex.Message });
            }
        }

        [HttpDelete("{dotKeKhaiId}/ke-khai-bhyt/{id}")]
        public async Task<IActionResult> DeleteKeKhaiBHYT(int dotKeKhaiId, int id)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                // Lấy thông tin kê khai và quyển biên lai
                var keKhaiBHYT = await _context.KeKhaiBHYTs
                    .Include(k => k.QuyenBienLai)
                    .FirstOrDefaultAsync(k => k.dot_ke_khai_id == dotKeKhaiId && k.id == id);
                    
                if (keKhaiBHYT == null)
                {
                    return NotFound(new { message = "Không tìm thấy kê khai BHYT" });
                }

                // Lấy biên lai liên quan
                var bienLai = await _context.BienLais
                    .FirstOrDefaultAsync(b => b.ke_khai_bhyt_id == keKhaiBHYT.id);

                if (bienLai != null && keKhaiBHYT.QuyenBienLai != null)
                {
                    // Xóa biên lai
                    _context.BienLais.Remove(bienLai);
                    await _context.SaveChangesAsync();

                    // Reset số hiện tại về số của biên lai bị xóa
                    keKhaiBHYT.QuyenBienLai.so_hien_tai = keKhaiBHYT.so_bien_lai;
                    
                    // Nếu trạng thái là đã sử dụng thì chuyển về đang sử dụng
                    if (keKhaiBHYT.QuyenBienLai.trang_thai == "da_su_dung")
                    {
                        keKhaiBHYT.QuyenBienLai.trang_thai = "dang_su_dung";
                    }
                }

                // Xóa kê khai BHYT
                _context.KeKhaiBHYTs.Remove(keKhaiBHYT);
                await _context.SaveChangesAsync();

                await transaction.CommitAsync();
                return NoContent();
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError($"Error deleting ke khai BHYT {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi xóa kê khai BHYT", error = ex.Message });
            }
        }

        [HttpPost("{dotKeKhaiId}/ke-khai-bhyt/delete-multiple")]
        public async Task<IActionResult> DeleteMultiple(int dotKeKhaiId, [FromBody] DeleteMultipleDto dto)
        {
            using var transaction = await _context.Database.BeginTransactionAsync();
            try
            {
                var keKhaiBHYTs = await _context.KeKhaiBHYTs
                    .Include(k => k.BienLai)
                    .Where(k => k.dot_ke_khai_id == dotKeKhaiId && dto.ids.Contains(k.id))
                    .ToListAsync();

                foreach (var keKhai in keKhaiBHYTs)
                {
                    var quyenBienLai = await _context.QuyenBienLais
                        .FirstOrDefaultAsync(q => q.id == keKhai.quyen_bien_lai_id);

                    if (quyenBienLai != null)
                    {
                        quyenBienLai.so_hien_tai = keKhai.so_bien_lai;
                        if (quyenBienLai.trang_thai == "da_su_dung")
                        {
                            quyenBienLai.trang_thai = "dang_su_dung";
                        }
                        _context.QuyenBienLais.Update(quyenBienLai);
                    }
                }

                _context.KeKhaiBHYTs.RemoveRange(keKhaiBHYTs);
                await _context.SaveChangesAsync();

                await transaction.CommitAsync();
                return NoContent();
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                _logger.LogError($"Error deleting multiple ke khai BHYT: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi xóa nhiều kê khai BHYT", error = ex.Message });
            }
        }

        private bool KeKhaiBHYTExists(int dotKeKhaiId, int id)
        {
            return _context.KeKhaiBHYTs.Any(e => e.dot_ke_khai_id == dotKeKhaiId && e.id == id);
        }

        [HttpPatch("{dotKeKhaiId}/ke-khai-bhyt/{id}/toggle-urgent")]
        public async Task<IActionResult> ToggleUrgent(int dotKeKhaiId, int id)
        {
            try
            {
                var keKhaiBHYT = await _context.KeKhaiBHYTs
                    .FirstOrDefaultAsync(k => k.dot_ke_khai_id == dotKeKhaiId && k.id == id);
                    
                if (keKhaiBHYT == null)
                {
                    return NotFound(new { message = "Không tìm thấy kê khai BHYT" });
                }

                // Toggle trạng thái urgent
                keKhaiBHYT.is_urgent = !keKhaiBHYT.is_urgent;
                await _context.SaveChangesAsync();

                return Ok(new { is_urgent = keKhaiBHYT.is_urgent });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error toggling urgent status for ke khai BHYT {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi cập nhật trạng thái gấp", error = ex.Message });
            }
        }

        [HttpPost("{id}/cap-nhat-so-bien-lai")]
        public async Task<IActionResult> CapNhatSoBienLai(int id, [FromBody] CapNhatSoBienLaiDto dto)
        {
            try
            {
                var keKhai = await _context.KeKhaiBHYTs
                    .Include(k => k.QuyenBienLai)
                    .FirstOrDefaultAsync(k => k.id == id);

                if (keKhai == null)
                {
                    return NotFound(new { message = "Không tìm thấy kê khai BHYT" });
                }

                if (keKhai.QuyenBienLai == null)
                {
                    return BadRequest(new { message = "Kê khai chưa được gán quyển biên lai" });
                }

                // Kiểm tra số biên lai có hợp lệ không
                var quyenBienLai = keKhai.QuyenBienLai;
                var soBienLai = int.Parse(dto.so_bien_lai);
                var tuSo = int.Parse(quyenBienLai.tu_so);
                var denSo = int.Parse(quyenBienLai.den_so);

                if (soBienLai < tuSo || soBienLai > denSo)
                {
                    return BadRequest(new { message = "Số biên lai không nằm trong khoảng cho phép" });
                }

                // Kiểm tra số biên lai đã được sử dụng chưa
                var daCoSoBienLai = await _context.KeKhaiBHYTs
                    .AnyAsync(k => k.id != id && 
                                  k.quyen_bien_lai_id == quyenBienLai.id && 
                                  k.so_bien_lai == dto.so_bien_lai);

                if (daCoSoBienLai)
                {
                    return BadRequest(new { message = "Số biên lai đã được sử dụng" });
                }

                keKhai.so_bien_lai = dto.so_bien_lai;
                quyenBienLai.so_hien_tai = dto.so_bien_lai;

                await _context.SaveChangesAsync();

                return Ok(new { message = "Cập nhật số biên lai thành công" });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error updating so bien lai for ke khai BHYT {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi cập nhật số biên lai", error = ex.Message });
            }
        }

        [HttpPost("create-bien-lai")]
        public async Task<IActionResult> CreateBienLai([FromBody] BienLaiCreateDto dto)
        {
            try
            {
                // Kiểm tra quyển biên lai
                var quyenBienLai = await _context.QuyenBienLais
                    .FirstOrDefaultAsync(q => q.quyen_so == dto.quyen_so);

                if (quyenBienLai == null)
                {
                    return BadRequest(new { message = "Quyển biên lai không tồn tại" });
                }

                // Tạo biên lai mới
                var bienLai = new BienLai
                {
                    quyen_so = dto.quyen_so,
                    so_bien_lai = dto.so_bien_lai,
                    ten_nguoi_dong = dto.ten_nguoi_dong,
                    so_tien = dto.so_tien,
                    ghi_chu = dto.ghi_chu,
                    trang_thai = "active",
                    ngay_tao = DateTime.Now
                };

                _context.BienLais.Add(bienLai);
                await _context.SaveChangesAsync();

                return Ok(bienLai);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Lỗi khi tạo biên lai");
                return StatusCode(500, new { message = "Có lỗi xảy ra khi tạo biên lai" });
            }
        }
    }

    public class DeleteMultipleDto
    {
        [Required]
        public int[] ids { get; set; } = Array.Empty<int>();
    }

    public class CapNhatSoBienLaiDto
    {
        [Required]
        public string so_bien_lai { get; set; }
    }

    public class BienLaiCreateDto
    {
        [Required]
        public string quyen_so { get; set; }
        [Required]
        public string so_bien_lai { get; set; }
        [Required]
        public string ten_nguoi_dong { get; set; }
        [Required]
        public decimal so_tien { get; set; }
        public string ghi_chu { get; set; }
    }
}
````

## File: WebApp.Server/Controllers/LichSuKeKhaiController.cs
````csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.API.Models;
using Microsoft.Extensions.Logging;
using OfficeOpenXml;

namespace WebApp.API.Controllers
{
    [Authorize]
    [ApiController]
    [Route("api/ke-khai-bhyt")]
    public class LichSuKeKhaiController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<LichSuKeKhaiController> _logger;

        public LichSuKeKhaiController(
            ApplicationDbContext context,
            ILogger<LichSuKeKhaiController> logger)
        {
            _context = context;
            _logger = logger;
        }

        [HttpGet("lich-su")]
        public async Task<ActionResult<IEnumerable<KeKhaiBHYT>>> GetLichSuKeKhai(
            [FromQuery] string? maSoBHXH,
            [FromQuery] string? cccd,
            [FromQuery] string? hoTen,
            [FromQuery] DateTime? tuNgay,
            [FromQuery] DateTime? denNgay)
        {
            try
            {
                // Lấy thông tin người dùng hiện tại
                var userName = User.Identity?.Name;
                if (string.IsNullOrEmpty(userName))
                {
                    return Unauthorized(new { success = false, message = "Không tìm thấy thông tin người dùng" });
                }

                // Kiểm tra vai trò của người dùng
                var currentUser = await _context.NguoiDungs.FirstOrDefaultAsync(u => u.user_name == userName);
                if (currentUser == null)
                {
                    return Unauthorized(new { success = false, message = "Không tìm thấy thông tin người dùng" });
                }

                var query = _context.KeKhaiBHYTs
                    .Include(k => k.ThongTinThe)
                    .Include(k => k.DotKeKhai)
                    .AsQueryable();

                // Nếu không phải admin hoặc super_admin, chỉ hiển thị kê khai do người dùng tạo
                if (!currentUser.roles.Contains("admin") && !currentUser.roles.Contains("super_admin"))
                {
                    query = query.Where(k => k.nguoi_tao == userName);
                }

                // Áp dụng các điều kiện tìm kiếm
                if (!string.IsNullOrEmpty(maSoBHXH))
                {
                    query = query.Where(k => k.ThongTinThe.ma_so_bhxh.Contains(maSoBHXH));
                }

                if (!string.IsNullOrEmpty(cccd))
                {
                    query = query.Where(k => k.ThongTinThe.cccd.Contains(cccd));
                }

                if (!string.IsNullOrEmpty(hoTen))
                {
                    query = query.Where(k => k.ThongTinThe.ho_ten.Contains(hoTen));
                }

                if (tuNgay.HasValue)
                {
                    query = query.Where(k => k.ngay_tao >= tuNgay.Value.Date);
                }

                if (denNgay.HasValue)
                {
                    query = query.Where(k => k.ngay_tao <= denNgay.Value.Date.AddDays(1).AddSeconds(-1));
                }

                // Sắp xếp theo ngày tạo mới nhất
                query = query.OrderByDescending(k => k.ngay_tao);

                var keKhaiBHYTs = await query
                    .Select(k => new
                    {
                        k.id,
                        k.dot_ke_khai_id,
                        k.thong_tin_the_id,
                        k.nguoi_thu,
                        k.so_thang_dong,
                        k.phuong_an_dong,
                        k.han_the_cu,
                        k.han_the_moi_tu,
                        k.han_the_moi_den,
                        k.ngay_tao,
                        k.ngay_bien_lai,
                        k.so_tien_can_dong,
                        k.is_urgent,
                        k.ma_ho_so,
                        k.nguoi_tao,
                        ThongTinThe = new
                        {
                            k.ThongTinThe.ma_so_bhxh,
                            k.ThongTinThe.cccd,
                            k.ThongTinThe.ho_ten,
                            k.ThongTinThe.ngay_sinh,
                            k.ThongTinThe.gioi_tinh,
                            k.ThongTinThe.so_dien_thoai
                        },
                        DotKeKhai = new
                        {
                            k.DotKeKhai.so_dot,
                            k.DotKeKhai.thang,
                            k.DotKeKhai.nam,
                            k.DotKeKhai.trang_thai
                        }
                    })
                    .ToListAsync();

                return Ok(keKhaiBHYTs);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting lich su ke khai: {ex.Message}");
                return StatusCode(500, new { success = false, message = "Lỗi khi lấy lịch sử kê khai", error = ex.Message });
            }
        }

        [HttpGet("lich-su/export")]
        public async Task<IActionResult> ExportLichSuKeKhai(
            [FromQuery] string? maSoBHXH,
            [FromQuery] string? cccd,
            [FromQuery] string? hoTen,
            [FromQuery] DateTime? tuNgay,
            [FromQuery] DateTime? denNgay)
        {
            try
            {
                // Lấy thông tin người dùng hiện tại
                var userName = User.Identity?.Name;
                if (string.IsNullOrEmpty(userName))
                {
                    return Unauthorized(new { success = false, message = "Không tìm thấy thông tin người dùng" });
                }

                // Kiểm tra vai trò của người dùng
                var currentUser = await _context.NguoiDungs.FirstOrDefaultAsync(u => u.user_name == userName);
                if (currentUser == null)
                {
                    return Unauthorized(new { success = false, message = "Không tìm thấy thông tin người dùng" });
                }

                var query = _context.KeKhaiBHYTs
                    .Include(k => k.ThongTinThe)
                    .Include(k => k.DotKeKhai)
                    .AsQueryable();

                // Nếu không phải admin hoặc super_admin, chỉ hiển thị kê khai do người dùng tạo
                if (!currentUser.roles.Contains("admin") && !currentUser.roles.Contains("super_admin"))
                {
                    query = query.Where(k => k.nguoi_tao == userName);
                }

                // Áp dụng các điều kiện tìm kiếm
                if (!string.IsNullOrEmpty(maSoBHXH))
                {
                    query = query.Where(k => k.ThongTinThe.ma_so_bhxh.Contains(maSoBHXH));
                }

                if (!string.IsNullOrEmpty(cccd))
                {
                    query = query.Where(k => k.ThongTinThe.cccd.Contains(cccd));
                }

                if (!string.IsNullOrEmpty(hoTen))
                {
                    query = query.Where(k => k.ThongTinThe.ho_ten.Contains(hoTen));
                }

                if (tuNgay.HasValue)
                {
                    query = query.Where(k => k.ngay_tao >= tuNgay.Value.Date);
                }

                if (denNgay.HasValue)
                {
                    query = query.Where(k => k.ngay_tao <= denNgay.Value.Date.AddDays(1).AddSeconds(-1));
                }

                var data = await query.ToListAsync();

                // Tạo file Excel
                using (var package = new ExcelPackage())
                {
                    var worksheet = package.Workbook.Worksheets.Add("Lịch sử kê khai");

                    // Thêm header
                    worksheet.Cells[1, 1].Value = "Đợt kê khai";
                    worksheet.Cells[1, 2].Value = "Mã số BHXH";
                    worksheet.Cells[1, 3].Value = "Họ tên";
                    worksheet.Cells[1, 4].Value = "CCCD";
                    worksheet.Cells[1, 5].Value = "Ngày sinh";
                    worksheet.Cells[1, 6].Value = "Giới tính";
                    worksheet.Cells[1, 7].Value = "Người thứ";
                    worksheet.Cells[1, 8].Value = "Phương án đóng";
                    worksheet.Cells[1, 9].Value = "Số tháng đóng";
                    worksheet.Cells[1, 10].Value = "Số tiền đóng";
                    worksheet.Cells[1, 11].Value = "Ngày tạo";
                    worksheet.Cells[1, 12].Value = "Mã hồ sơ";
                    worksheet.Cells[1, 13].Value = "Trạng thái";

                    // Thêm dữ liệu
                    int row = 2;
                    foreach (var item in data)
                    {
                        worksheet.Cells[row, 1].Value = $"Đợt {item.DotKeKhai.so_dot} tháng {item.DotKeKhai.thang} năm {item.DotKeKhai.nam}";
                        worksheet.Cells[row, 2].Value = item.ThongTinThe.ma_so_bhxh;
                        worksheet.Cells[row, 3].Value = item.ThongTinThe.ho_ten;
                        worksheet.Cells[row, 4].Value = item.ThongTinThe.cccd;
                        worksheet.Cells[row, 5].Value = item.ThongTinThe.ngay_sinh;
                        worksheet.Cells[row, 6].Value = item.ThongTinThe.gioi_tinh;
                        worksheet.Cells[row, 7].Value = item.nguoi_thu;
                        worksheet.Cells[row, 8].Value = item.phuong_an_dong;
                        worksheet.Cells[row, 9].Value = item.so_thang_dong;
                        worksheet.Cells[row, 10].Value = item.so_tien_can_dong;
                        worksheet.Cells[row, 11].Value = item.ngay_tao.ToString("dd/MM/yyyy HH:mm");
                        worksheet.Cells[row, 12].Value = item.ma_ho_so;
                        worksheet.Cells[row, 13].Value = item.DotKeKhai.trang_thai;
                        row++;
                    }

                    // Format các cột
                    worksheet.Cells.AutoFitColumns();

                    // Trả về file Excel
                    var content = package.GetAsByteArray();
                    var fileName = $"lich-su-ke-khai-{DateTime.Now:yyyyMMddHHmmss}.xlsx";

                    return File(content, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error exporting lich su ke khai: {ex.Message}");
                return StatusCode(500, new { success = false, message = "Lỗi khi xuất lịch sử kê khai", error = ex.Message });
            }
        }

        [HttpGet("lich-su-bhxh")]
        public async Task<ActionResult<IEnumerable<object>>> GetLichSuKeKhaiBHXH(
            [FromQuery] string? maSoBHXH,
            [FromQuery] string? cccd,
            [FromQuery] string? hoTen,
            [FromQuery] DateTime? tuNgay,
            [FromQuery] DateTime? denNgay)
        {
            try
            {
                // Lấy thông tin người dùng hiện tại
                var userName = User.Identity?.Name;
                if (string.IsNullOrEmpty(userName))
                {
                    return Unauthorized(new { success = false, message = "Không tìm thấy thông tin người dùng" });
                }

                // Kiểm tra vai trò của người dùng
                var currentUser = await _context.NguoiDungs.FirstOrDefaultAsync(u => u.user_name == userName);
                if (currentUser == null)
                {
                    return Unauthorized(new { success = false, message = "Không tìm thấy thông tin người dùng" });
                }

                var query = _context.KeKhaiBHXHs
                    .Include(k => k.ThongTinThe)
                    .Include(k => k.DotKeKhai)
                    .AsQueryable();

                // Nếu không phải admin hoặc super_admin, chỉ hiển thị kê khai do người dùng tạo
                if (!currentUser.roles.Contains("admin") && !currentUser.roles.Contains("super_admin"))
                {
                    query = query.Where(k => k.nguoi_tao == userName);
                }

                // Áp dụng các điều kiện tìm kiếm
                if (!string.IsNullOrEmpty(maSoBHXH))
                {
                    query = query.Where(k => k.ThongTinThe.ma_so_bhxh.Contains(maSoBHXH));
                }

                if (!string.IsNullOrEmpty(cccd))
                {
                    query = query.Where(k => k.ThongTinThe.cccd.Contains(cccd));
                }

                if (!string.IsNullOrEmpty(hoTen))
                {
                    query = query.Where(k => k.ThongTinThe.ho_ten.Contains(hoTen));
                }

                if (tuNgay.HasValue)
                {
                    query = query.Where(k => k.ngay_tao >= tuNgay.Value.Date);
                }

                if (denNgay.HasValue)
                {
                    query = query.Where(k => k.ngay_tao <= denNgay.Value.Date.AddDays(1).AddSeconds(-1));
                }

                var keKhaiBHXHs = await query
                    .Select(k => new {
                        k.id,
                        k.dot_ke_khai_id,
                        k.thong_tin_the_id,
                        k.muc_thu_nhap,
                        k.ty_le_dong,
                        k.ty_le_nsnn,
                        k.loai_nsnn,
                        k.tien_ho_tro,
                        k.so_tien_can_dong,
                        k.phuong_thuc_dong,
                        k.thang_bat_dau,
                        k.so_thang_dong,
                        k.phuong_an,
                        k.loai_khai_bao,
                        k.ngay_bien_lai,
                        k.so_bien_lai,
                        k.ngay_tao,
                        k.ma_ho_so,
                        k.nguoi_tao,
                        ThongTinThe = new {
                            k.ThongTinThe.ma_so_bhxh,
                            k.ThongTinThe.ho_ten,
                            k.ThongTinThe.cccd,
                            k.ThongTinThe.ngay_sinh,
                            k.ThongTinThe.gioi_tinh
                        },
                        DotKeKhai = new {
                            k.DotKeKhai.so_dot,
                            k.DotKeKhai.thang,
                            k.DotKeKhai.nam,
                            k.DotKeKhai.trang_thai
                        }
                    })
                    .OrderByDescending(k => k.ngay_tao)
                    .ToListAsync();

                return Ok(keKhaiBHXHs);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Lỗi khi lấy danh sách kê khai BHXH: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách kê khai BHXH", error = ex.Message });
            }
        }

        [HttpGet("lich-su-bhxh/export")]
        public async Task<IActionResult> ExportLichSuKeKhaiBHXH(
            [FromQuery] string? maSoBHXH,
            [FromQuery] string? cccd,
            [FromQuery] string? hoTen,
            [FromQuery] DateTime? tuNgay,
            [FromQuery] DateTime? denNgay)
        {
            try
            {
                // Lấy thông tin người dùng hiện tại
                var userName = User.Identity?.Name;
                if (string.IsNullOrEmpty(userName))
                {
                    return Unauthorized(new { success = false, message = "Không tìm thấy thông tin người dùng" });
                }

                // Kiểm tra vai trò của người dùng
                var currentUser = await _context.NguoiDungs.FirstOrDefaultAsync(u => u.user_name == userName);
                if (currentUser == null)
                {
                    return Unauthorized(new { success = false, message = "Không tìm thấy thông tin người dùng" });
                }

                var query = _context.KeKhaiBHXHs
                    .Include(k => k.ThongTinThe)
                    .Include(k => k.DotKeKhai)
                    .AsQueryable();

                // Nếu không phải admin hoặc super_admin, chỉ hiển thị kê khai do người dùng tạo
                if (!currentUser.roles.Contains("admin") && !currentUser.roles.Contains("super_admin"))
                {
                    query = query.Where(k => k.nguoi_tao == userName);
                }

                // Áp dụng các điều kiện tìm kiếm
                if (!string.IsNullOrEmpty(maSoBHXH))
                {
                    query = query.Where(k => k.ThongTinThe.ma_so_bhxh.Contains(maSoBHXH));
                }

                if (!string.IsNullOrEmpty(cccd))
                {
                    query = query.Where(k => k.ThongTinThe.cccd.Contains(cccd));
                }

                if (!string.IsNullOrEmpty(hoTen))
                {
                    query = query.Where(k => k.ThongTinThe.ho_ten.Contains(hoTen));
                }

                if (tuNgay.HasValue)
                {
                    query = query.Where(k => k.ngay_tao >= tuNgay.Value.Date);
                }

                if (denNgay.HasValue)
                {
                    query = query.Where(k => k.ngay_tao <= denNgay.Value.Date.AddDays(1).AddSeconds(-1));
                }

                var data = await query.ToListAsync();

                // Tạo file Excel
                using (var package = new ExcelPackage())
                {
                    var worksheet = package.Workbook.Worksheets.Add("Lịch sử kê khai BHXH");

                    // Thêm header
                    worksheet.Cells[1, 1].Value = "Đợt kê khai";
                    worksheet.Cells[1, 2].Value = "Mã số BHXH";
                    worksheet.Cells[1, 3].Value = "Họ tên";
                    worksheet.Cells[1, 4].Value = "CCCD";
                    worksheet.Cells[1, 5].Value = "Ngày sinh";
                    worksheet.Cells[1, 6].Value = "Giới tính";
                    worksheet.Cells[1, 7].Value = "Mức lương";
                    worksheet.Cells[1, 8].Value = "Phương án đóng";
                    worksheet.Cells[1, 9].Value = "Số tháng đóng";
                    worksheet.Cells[1, 10].Value = "Số tiền đóng";
                    worksheet.Cells[1, 11].Value = "Ngày tạo";
                    worksheet.Cells[1, 12].Value = "Mã hồ sơ";
                    worksheet.Cells[1, 13].Value = "Trạng thái";

                    // Thêm dữ liệu
                    int row = 2;
                    foreach (var item in data)
                    {
                        worksheet.Cells[row, 1].Value = $"Đợt {item.DotKeKhai.so_dot} tháng {item.DotKeKhai.thang} năm {item.DotKeKhai.nam}";
                        worksheet.Cells[row, 2].Value = item.ThongTinThe.ma_so_bhxh;
                        worksheet.Cells[row, 3].Value = item.ThongTinThe.ho_ten;
                        worksheet.Cells[row, 4].Value = item.ThongTinThe.cccd;
                        worksheet.Cells[row, 5].Value = item.ThongTinThe.ngay_sinh;
                        worksheet.Cells[row, 6].Value = item.ThongTinThe.gioi_tinh;
                        worksheet.Cells[row, 7].Value = item.muc_thu_nhap;
                        worksheet.Cells[row, 8].Value = item.phuong_an;
                        worksheet.Cells[row, 9].Value = item.so_thang_dong;
                        worksheet.Cells[row, 10].Value = item.so_tien_can_dong;
                        worksheet.Cells[row, 11].Value = item.ngay_tao.ToString("dd/MM/yyyy HH:mm");
                        worksheet.Cells[row, 12].Value = item.ma_ho_so;
                        worksheet.Cells[row, 13].Value = item.DotKeKhai.trang_thai;
                        row++;
                    }

                    // Format các cột
                    worksheet.Cells.AutoFitColumns();

                    // Trả về file Excel
                    var content = package.GetAsByteArray();
                    var fileName = $"lich-su-ke-khai-bhxh-{DateTime.Now:yyyyMMddHHmmss}.xlsx";

                    return File(content, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileName);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error exporting lich su ke khai BHXH: {ex.Message}");
                return StatusCode(500, new { success = false, message = "Lỗi khi xuất lịch sử kê khai BHXH", error = ex.Message });
            }
        }
    }
}
````

## File: WebApp.Server/Controllers/LocationsController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.API.Models;

namespace WebApp.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class LocationsController : ControllerBase
    {
        private readonly ApplicationDbContext _context;

        public LocationsController(ApplicationDbContext context)
        {
            _context = context;
        }

        [HttpGet("provinces")]
        public async Task<ActionResult<IEnumerable<DanhMucTinh>>> GetProvinces()
        {
            try
            {
                var provinces = await _context.DanhMucTinhs
                    .OrderBy(p => p.ma)
                    .ToListAsync();
                    
                return Ok(provinces);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách tỉnh thành", error = ex.Message });
            }
        }

        [HttpGet("districts/{provinceId}")]
        public async Task<ActionResult<IEnumerable<DanhMucHuyen>>> GetDistricts(string provinceId)
        {
            try
            {
                var districts = await _context.DanhMucHuyens
                    .Where(d => d.ma_tinh == provinceId)
                    .OrderBy(d => d.ma)
                    .ToListAsync();

                if (!districts.Any())
                {
                    return NotFound(new { message = $"Không tìm thấy quận/huyện nào thuộc tỉnh/thành phố có mã {provinceId}" });
                }

                return Ok(districts);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách quận/huyện", error = ex.Message });
            }
        }

        [HttpGet("communes/{districtCode}")]
        public async Task<ActionResult<object>> GetCommunes(string districtCode)
        {
            try
            {
                var communes = await _context.DanhMucXas
                    .Where(c => c.ma_huyen == districtCode)
                    .OrderBy(c => c.ma)
                    .Select(c => new
                    {
                        text = c.text,
                        value = c.ma,
                        ten = c.ten,
                        ma = c.ma
                    })
                    .ToListAsync();

                if (!communes.Any())
                {
                    return NotFound(new { 
                        success = false,
                        message = $"Không tìm thấy xã/phường nào thuộc quận/huyện có mã {districtCode}",
                        data = new List<object>(),
                        errors = new List<string>(),
                        status = 404,
                        traceId = ""
                    });
                }

                return Ok(new
                {
                    success = true,
                    message = "",
                    data = communes,
                    errors = new List<string>(),
                    status = 200,
                    traceId = ""
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new
                {
                    success = false,
                    message = "Lỗi khi lấy danh sách xã/phường",
                    data = new List<object>(),
                    errors = new List<string> { ex.Message },
                    status = 500,
                    traceId = ""
                });
            }
        }
    }
}
````

## File: WebApp.Server/Controllers/NguoiDungController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.API.Models;
using System.ComponentModel.DataAnnotations;
using System.Text.Json.Serialization;
using BCrypt.Net;
using Microsoft.Extensions.Logging;
using System.Text;
using System.Linq;
using System.Security.Cryptography;

namespace WebApp.Server.Controllers
{
    public class NguoiDungDTO
    {
        [Required(ErrorMessage = "Tên đăng nhập không được để trống")]
        [JsonPropertyName("userName")]
        public string UserName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Họ tên không được để trống")]
        [JsonPropertyName("hoTen")]
        public string HoTen { get; set; } = string.Empty;

        [JsonPropertyName("mangLuoi")]
        public string? MangLuoi { get; set; }

        [JsonPropertyName("donViCongTac")]
        public string? DonViCongTac { get; set; }

        [JsonPropertyName("chucDanh")]
        public string? ChucDanh { get; set; }

        [JsonPropertyName("email")]
        public string? Email { get; set; }

        [JsonPropertyName("soDienThoai")]
        public string? SoDienThoai { get; set; }

        [JsonPropertyName("isSuperAdmin")]
        public bool IsSuperAdmin { get; set; }

        [JsonPropertyName("typeMangLuoi")]
        public int? TypeMangLuoi { get; set; }

        [JsonPropertyName("roles")]
        public string[]? Roles { get; set; }

        [JsonPropertyName("password")]
        public string? Password { get; set; }

        [JsonPropertyName("maNhanVien")]
        public string? MaNhanVien { get; set; }

        [JsonPropertyName("status")]
        public int Status { get; set; }
    }

    [Route("api/nguoi-dung")]
    [ApiController]
    public class NguoiDungController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<NguoiDungController> _logger;

        public NguoiDungController(ApplicationDbContext context, ILogger<NguoiDungController> logger)
        {
            _context = context;
            _logger = logger;
        }

        // GET: api/nguoi-dung
        [HttpGet]
        public async Task<ActionResult<IEnumerable<NguoiDung>>> GetNguoiDungs()
        {
            try 
            {
                var nguoiDungs = await _context.NguoiDungs
                    .Select(n => new {
                        id = n.id,
                        userName = n.user_name,
                        hoTen = n.ho_ten,
                        donViCongTac = n.don_vi_cong_tac,
                        chucDanh = n.chuc_danh,
                        email = n.email,
                        soDienThoai = n.so_dien_thoai,
                        roles = n.roles,
                        status = n.status,
                        maNhanVien = n.ma_nhan_vien,
                        isSuperAdmin = n.is_super_admin,
                        typeMangLuoi = n.type_mang_luoi
                    })
                    .ToListAsync();
                    
                return Ok(nguoiDungs);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting users: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách người dùng" });
            }
        }

        // GET: api/nguoi-dung/5
        [HttpGet("{id}")]
        public async Task<ActionResult<NguoiDung>> GetNguoiDung(int id)
        {
            var nguoiDung = await _context.NguoiDungs.FindAsync(id);

            if (nguoiDung == null)
            {
                return NotFound();
            }

            return nguoiDung;
        }

        // POST: api/nguoi-dung
        [HttpPost]
        public async Task<ActionResult<NguoiDung>> CreateNguoiDung(NguoiDungDTO dto)
        {
            // Kiểm tra dữ liệu đầu vào
            if (string.IsNullOrWhiteSpace(dto.UserName))
            {
                ModelState.AddModelError("UserName", "Tên đăng nhập không được để trống");
                return BadRequest(ModelState);
            }

            if (string.IsNullOrWhiteSpace(dto.HoTen))
            {
                ModelState.AddModelError("HoTen", "Họ tên không được để trống");
                return BadRequest(ModelState);
            }

            // Kiểm tra trùng UserName
            if (await _context.NguoiDungs.AnyAsync(x => x.user_name.ToLower() == dto.UserName.ToLower()))
            {
                ModelState.AddModelError("UserName", "Tên đăng nhập đã tồn tại");
                return BadRequest(ModelState);
            }

            // Kiểm tra và mã hóa mật khẩu
            if (string.IsNullOrWhiteSpace(dto.Password))
            {
                ModelState.AddModelError("Password", "Mật khẩu không được để trống");
                return BadRequest(ModelState);
            }

            if (dto.Password.Length < 6)
            {
                ModelState.AddModelError("Password", "Mật khẩu phải có ít nhất 6 ký tự");
                return BadRequest(ModelState);
            }

            string hashedPassword = BCrypt.Net.BCrypt.HashPassword(dto.Password);

            var nguoiDung = new NguoiDung
            {
                user_name = dto.UserName,
                password = hashedPassword,
                ho_ten = dto.HoTen,
                email = dto.Email,
                so_dien_thoai = dto.SoDienThoai,
                don_vi_cong_tac = dto.DonViCongTac,
                chuc_danh = dto.ChucDanh,
                is_super_admin = dto.IsSuperAdmin,
                type_mang_luoi = dto.TypeMangLuoi,
                status = 1,
                roles = dto.Roles,
                ma_nhan_vien = dto.MaNhanVien
            };

            try
            {
                _context.NguoiDungs.Add(nguoiDung);
                await _context.SaveChangesAsync();
                return CreatedAtAction(nameof(GetNguoiDung), new { id = nguoiDung.id }, nguoiDung);
            }
            catch (Exception ex)
            {
                ModelState.AddModelError("", "Có lỗi xảy ra khi tạo người dùng");
                return BadRequest(ModelState);
            }
        }

        // PUT: api/nguoi-dung/5
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateNguoiDung(int id, NguoiDungDTO dto)
        {
            var nguoiDung = await _context.NguoiDungs.FindAsync(id);
            if (nguoiDung == null)
            {
                return NotFound();
            }

            try
            {
                // Log để debug
                _logger.LogInformation($"Updating user {id} with status: {dto.Status}");

                nguoiDung.user_name = dto.UserName;
                nguoiDung.ho_ten = dto.HoTen;
                nguoiDung.don_vi_cong_tac = dto.DonViCongTac;
                nguoiDung.chuc_danh = dto.ChucDanh;
                nguoiDung.email = dto.Email;
                nguoiDung.so_dien_thoai = dto.SoDienThoai;
                nguoiDung.is_super_admin = dto.IsSuperAdmin;
                nguoiDung.type_mang_luoi = dto.TypeMangLuoi;
                nguoiDung.roles = dto.Roles;
                nguoiDung.status = dto.Status; // Đảm bảo status được cập nhật
                nguoiDung.ma_nhan_vien = dto.MaNhanVien;
                nguoiDung.updated_at = DateTime.UtcNow;

                if (!string.IsNullOrEmpty(dto.Password))
                {
                    nguoiDung.password = BCrypt.Net.BCrypt.HashPassword(dto.Password);
                }

                await _context.SaveChangesAsync();

                // Log kết quả
                _logger.LogInformation($"User {id} updated successfully with status: {nguoiDung.status}");

                return Ok(nguoiDung);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error updating user: {ex.Message}");
                return StatusCode(500, new { message = "Có lỗi xảy ra khi cập nhật người dùng" });
            }
        }

        // DELETE: api/nguoi-dung/5
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteNguoiDung(int id)
        {
            var nguoiDung = await _context.NguoiDungs.FindAsync(id);
            if (nguoiDung == null)
            {
                return NotFound();
            }

            _context.NguoiDungs.Remove(nguoiDung);
            await _context.SaveChangesAsync();

            return NoContent();
        }

        // PATCH: api/nguoi-dung/5/toggle-status
        [HttpPatch("{id}/toggle-status")]
        public async Task<IActionResult> ToggleStatus(int id)
        {
            try
            {
                var nguoiDung = await _context.NguoiDungs.FindAsync(id);
                if (nguoiDung == null)
                {
                    return NotFound(new { message = "Không tìm thấy người dùng" });
                }

                // Log trạng thái trước khi thay đổi
                _logger.LogInformation($"Toggling status for user {id} from {nguoiDung.status}");

                nguoiDung.status = nguoiDung.status == 1 ? 0 : 1;
                nguoiDung.updated_at = DateTime.UtcNow;

                await _context.SaveChangesAsync();

                // Log trạng thái sau khi thay đổi
                _logger.LogInformation($"Status changed to {nguoiDung.status}");

                return Ok(nguoiDung);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error toggling status: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi cập nhật trạng thái" });
            }
        }

        private string GenerateRandomPassword()
        {
            // Định nghĩa các ký tự cho mật khẩu
            const string upperCase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const string lowerCase = "abcdefghijklmnopqrstuvwxyz";
            const string digits = "0123456789";
            const string special = "@#$%^&*";

            // Tạo chuỗi ngẫu nhiên từ tất cả các loại ký tự
            var random = new Random();
            var password = new StringBuilder();

            // Thêm ít nhất 1 ký tự hoa
            password.Append(upperCase[random.Next(upperCase.Length)]);
            // Thêm ít nhất 1 ký tự thường  
            password.Append(lowerCase[random.Next(lowerCase.Length)]);
            // Thêm ít nhất 1 số
            password.Append(digits[random.Next(digits.Length)]);
            // Thêm ít nhất 1 ký tự đặc biệt
            password.Append(special[random.Next(special.Length)]);

            // Tạo chuỗi chứa tất cả các ký tự có thể
            var allChars = upperCase + lowerCase + digits + special;

            // Thêm các ký tự ngẫu nhiên cho đủ độ dài mong muốn (8 ký tự)
            for (int i = 4; i < 8; i++)
            {
                password.Append(allChars[random.Next(allChars.Length)]);
            }

            // Trộn ngẫu nhiên các ký tự trong chuỗi mật khẩu
            return new string(password.ToString().ToCharArray().OrderBy(x => random.Next()).ToArray());
        }

        // POST: api/nguoi-dung/5/reset-password
        [HttpPost("{id}/reset-password")]
        public async Task<IActionResult> ResetPassword(int id)
        {
            var nguoiDung = await _context.NguoiDungs.FindAsync(id);
            if (nguoiDung == null)
            {
                return NotFound(new { message = "Không tìm thấy người dùng" });
            }

            try
            {
                // Tạo mật khẩu ngẫu nhiên mới
                string newPassword = GenerateRandomPassword();
                string hashedPassword = BCrypt.Net.BCrypt.HashPassword(newPassword);
                
                nguoiDung.password = hashedPassword;
                nguoiDung.updated_at = DateTime.UtcNow;
                
                await _context.SaveChangesAsync();

                return Ok(new { 
                    message = "Đặt lại mật khẩu thành công",
                    password = newPassword
                });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Reset password error: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi đặt lại mật khẩu" });
            }
        }

        [HttpGet("info/{id}")]
        public async Task<ActionResult<NguoiDung>> GetUserInfo(int id)
        {
            var nguoiDung = await _context.NguoiDungs
                .Where(u => u.id == id)
                .Select(u => new {
                    u.id,
                    u.user_name,
                    u.ho_ten,
                    u.email,
                    u.ma_nhan_vien,
                    u.roles,
                    u.status,
                    u.is_super_admin,
                    u.type_mang_luoi
                })
                .FirstOrDefaultAsync();

            if (nguoiDung == null)
            {
                return NotFound("Không tìm thấy thông tin người dùng");
            }

            return Ok(nguoiDung);
        }

        private bool NguoiDungExists(int id)
        {
            return _context.NguoiDungs.Any(e => e.id == id);
        }
    }
}
````

## File: WebApp.Server/Controllers/ProvinceController.cs
````csharp

````

## File: WebApp.Server/Controllers/QuyenBienLaiController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Threading.Tasks;
using WebApp.API.Data;
using WebApp.API.Models;
using System.Text.Json;
using Microsoft.Extensions.Logging;

namespace WebApp.API.Controllers
{
    [ApiController]
    [Route("api/quyen-bien-lai")]
    public class QuyenBienLaiController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<QuyenBienLaiController> _logger;

        public QuyenBienLaiController(ApplicationDbContext context, ILogger<QuyenBienLaiController> logger)
        {
            _context = context;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetAll()
        {
            var quyenBienLais = await _context.QuyenBienLais
                .Include(q => q.NguoiThu)
                .OrderByDescending(q => q.ngay_cap)
                .ToListAsync();
            return Ok(quyenBienLais);
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetById(int id)
        {
            var quyenBienLai = await _context.QuyenBienLais
                .Include(q => q.NguoiThu)
                .FirstOrDefaultAsync(q => q.id == id);

            if (quyenBienLai == null)
                return NotFound();

            return Ok(quyenBienLai);
        }

        [HttpPost]
        public async Task<IActionResult> Create(QuyenBienLai quyenBienLai)
        {
            try 
            {
                // Log để debug
                _logger.LogInformation($"Received request to create QuyenBienLai: {JsonSerializer.Serialize(quyenBienLai)}");

                // Validate input
                if (quyenBienLai == null)
                {
                    return BadRequest(new { message = "Dữ liệu không hợp lệ" });
                }

                // Kiểm tra người thu có tồn tại không
                var nguoiThu = await _context.NguoiDungs
                    .FirstOrDefaultAsync(n => n.id == quyenBienLai.nhan_vien_thu);

                if (nguoiThu == null)
                {
                    return BadRequest(new { message = $"Không tìm thấy người thu với ID: {quyenBienLai.nhan_vien_thu}" });
                }

                // Kiểm tra số quyển và số biên lai
                if (string.IsNullOrEmpty(quyenBienLai.quyen_so) || 
                    string.IsNullOrEmpty(quyenBienLai.tu_so) || 
                    string.IsNullOrEmpty(quyenBienLai.den_so))
                {
                    return BadRequest(new { message = "Vui lòng nhập đầy đủ thông tin quyển biên lai" });
                }

                // Set các giá trị mặc định
                quyenBienLai.ngay_cap = DateTime.SpecifyKind(DateTime.Now, DateTimeKind.Utc);
                quyenBienLai.so_hien_tai = quyenBienLai.tu_so;
                quyenBienLai.trang_thai = "chua_su_dung";

                // Thêm vào database
                _context.QuyenBienLais.Add(quyenBienLai);
                await _context.SaveChangesAsync();

                // Lấy quyển biên lai vừa tạo kèm thông tin người thu
                var createdQuyenBienLai = await _context.QuyenBienLais
                    .Include(q => q.NguoiThu)
                    .FirstOrDefaultAsync(q => q.id == quyenBienLai.id);

                return CreatedAtAction(
                    nameof(GetById), 
                    new { id = quyenBienLai.id }, 
                    new { 
                        message = "Thêm quyển biên lai thành công",
                        data = createdQuyenBienLai 
                    }
                );
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Lỗi khi thêm quyển biên lai");
                return StatusCode(500, new { message = "Lỗi khi thêm quyển biên lai", error = ex.Message });
            }
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> Update(int id, QuyenBienLai quyenBienLai)
        {
            if (id != quyenBienLai.id)
                return BadRequest();

            var existingQuyenBienLai = await _context.QuyenBienLais.FindAsync(id);
            if (existingQuyenBienLai == null)
                return NotFound();

            // Cập nhật các trường
            existingQuyenBienLai.quyen_so = quyenBienLai.quyen_so;
            existingQuyenBienLai.tu_so = quyenBienLai.tu_so;
            existingQuyenBienLai.den_so = quyenBienLai.den_so;
            existingQuyenBienLai.nhan_vien_thu = quyenBienLai.nhan_vien_thu;
            existingQuyenBienLai.trang_thai = quyenBienLai.trang_thai;
            
            // Cập nhật số hiện tại nếu được cung cấp
            if (!string.IsNullOrEmpty(quyenBienLai.so_hien_tai))
            {
                // Kiểm tra số hiện tại có hợp lệ không (nằm trong khoảng từ số đến số)
                if (int.TryParse(quyenBienLai.so_hien_tai, out int soHienTai) && 
                    int.TryParse(quyenBienLai.tu_so, out int tuSo) && 
                    int.TryParse(quyenBienLai.den_so, out int denSo))
                {
                    if (soHienTai < tuSo || soHienTai > denSo)
                    {
                        return BadRequest(new { message = "Số hiện tại phải nằm trong khoảng từ số đến số" });
                    }
                }
                
                existingQuyenBienLai.so_hien_tai = quyenBienLai.so_hien_tai;
            }

            try
            {
                await _context.SaveChangesAsync();
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!await QuyenBienLaiExists(id))
                    return NotFound();
                throw;
            }

            return NoContent();
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> Delete(int id)
        {
            var quyenBienLai = await _context.QuyenBienLais.FindAsync(id);
            if (quyenBienLai == null)
                return NotFound();

            if (quyenBienLai.trang_thai != "chua_su_dung")
                return BadRequest("Không thể xóa quyển biên lai đã sử dụng");

            _context.QuyenBienLais.Remove(quyenBienLai);
            await _context.SaveChangesAsync();

            return NoContent();
        }

        private async Task<bool> QuyenBienLaiExists(int id)
        {
            return await _context.QuyenBienLais.AnyAsync(e => e.id == id);
        }
    }
}
````

## File: WebApp.Server/Controllers/QuyenBienLaiDienTuController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Text.Json;
using WebApp.API.Data;
using WebApp.API.Models.BienlaiDienTu;
using System.Security.Claims;

namespace WebApp.API.Controllers
{
    [ApiController]
    [Route("api/quyen-bien-lai-dien-tu")]
    public class QuyenBienLaiDienTuController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<QuyenBienLaiDienTuController> _logger;

        public QuyenBienLaiDienTuController(ApplicationDbContext context, ILogger<QuyenBienLaiDienTuController> logger)
        {
            _context = context;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetAll()
        {
            var quyenBienLais = await _context.QuyenBienLaiDienTus
                .OrderByDescending(q => q.ngay_cap)
                .ToListAsync();
            return Ok(quyenBienLais);
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetById(int id)
        {
            var quyenBienLai = await _context.QuyenBienLaiDienTus
                .FirstOrDefaultAsync(q => q.id == id);

            if (quyenBienLai == null)
                return NotFound();

            return Ok(quyenBienLai);
        }

        [HttpPost]
        public async Task<IActionResult> Create(QuyenBienLaiDienTu quyenBienLai)
        {
            try 
            {
                _logger.LogInformation($"Received request to create QuyenBienLaiDienTu: {JsonSerializer.Serialize(quyenBienLai)}");

                if (quyenBienLai == null)
                {
                    return BadRequest(new { message = "Dữ liệu không hợp lệ" });
                }

                // Lấy thông tin người dùng hiện tại từ token JWT
                var username = User.FindFirst(ClaimTypes.Name)?.Value;
                var hoTen = User.FindFirst("hoTen")?.Value;
                
                if (string.IsNullOrEmpty(username))
                {
                    return Unauthorized(new { message = "Không tìm thấy thông tin người dùng" });
                }
                
                // Lấy thông tin người dùng từ database để có thông tin đầy đủ hơn
                var currentUser = await _context.NguoiDungs
                    .FirstOrDefaultAsync(u => u.user_name == username);

                if (currentUser == null)
                {
                    return Unauthorized(new { message = "Không tìm thấy thông tin người dùng" });
                }

                // Luôn thiết lập người cấp, bất kể client có gửi hay không
                quyenBienLai.nguoi_cap = currentUser.ho_ten;

                // Kiểm tra các trường bắt buộc
                if (string.IsNullOrEmpty(quyenBienLai.ky_hieu) ||
                    string.IsNullOrEmpty(quyenBienLai.tu_so) || 
                    string.IsNullOrEmpty(quyenBienLai.den_so))
                {
                    return BadRequest(new { message = "Vui lòng nhập đầy đủ thông tin quyển biên lai điện tử" });
                }

                // Đảm bảo trường ma_co_quan_bhxh không bị null
                if (string.IsNullOrEmpty(quyenBienLai.ma_co_quan_bhxh))
                {
                    quyenBienLai.ma_co_quan_bhxh = "";
                }

                quyenBienLai.ngay_cap = DateTime.SpecifyKind(DateTime.Now, DateTimeKind.Utc);
                quyenBienLai.so_hien_tai = quyenBienLai.tu_so;
                quyenBienLai.trang_thai = "chua_su_dung";

                // Đảm bảo ký hiệu biên lai đúng định dạng
                if (quyenBienLai.ky_hieu != "BH25-AG/08907/E")
                {
                    quyenBienLai.ky_hieu = "BH25-AG/08907/E";
                }

                _context.QuyenBienLaiDienTus.Add(quyenBienLai);
                await _context.SaveChangesAsync();

                var createdQuyenBienLai = await _context.QuyenBienLaiDienTus
                    .FirstOrDefaultAsync(q => q.id == quyenBienLai.id);

                return CreatedAtAction(
                    nameof(GetById), 
                    new { id = quyenBienLai.id }, 
                    new { 
                        message = "Thêm quyển biên lai điện tử thành công",
                        data = createdQuyenBienLai 
                    }
                );
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Lỗi khi thêm quyển biên lai điện tử");
                return StatusCode(500, new { message = "Lỗi khi thêm quyển biên lai điện tử", error = ex.Message });
            }
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> Update(int id, QuyenBienLaiDienTu quyenBienLai)
        {
            try
            {
                _logger.LogInformation($"Received request to update QuyenBienLaiDienTu: {JsonSerializer.Serialize(quyenBienLai)}");
                
                if (id != quyenBienLai.id)
                    return BadRequest(new { message = "ID không khớp với dữ liệu cập nhật" });

                var existingQuyenBienLai = await _context.QuyenBienLaiDienTus.FindAsync(id);
                if (existingQuyenBienLai == null)
                    return NotFound(new { message = "Không tìm thấy quyển biên lai điện tử" });

                existingQuyenBienLai.ky_hieu = "BH25-AG/08907/E"; // Giữ nguyên ký hiệu
                existingQuyenBienLai.tu_so = quyenBienLai.tu_so;
                existingQuyenBienLai.den_so = quyenBienLai.den_so;
                existingQuyenBienLai.trang_thai = quyenBienLai.trang_thai;
                
                // Cập nhật mã cơ quan BHXH
                if (!string.IsNullOrEmpty(quyenBienLai.ma_co_quan_bhxh))
                {
                    existingQuyenBienLai.ma_co_quan_bhxh = quyenBienLai.ma_co_quan_bhxh;
                }
                
                // Không cập nhật người cấp khi chỉnh sửa để giữ nguyên thông tin người đã tạo ban đầu
                
                if (!string.IsNullOrEmpty(quyenBienLai.so_hien_tai))
                {
                    if (int.TryParse(quyenBienLai.so_hien_tai, out int soHienTai) && 
                        int.TryParse(quyenBienLai.tu_so, out int tuSo) && 
                        int.TryParse(quyenBienLai.den_so, out int denSo))
                    {
                        if (soHienTai < tuSo || soHienTai > denSo)
                        {
                            return BadRequest(new { message = "Số hiện tại phải nằm trong khoảng từ số đến số" });
                        }

                        // Kiểm tra đã có biên lai được cấp cho các số trước số hiện tại mới
                        if (int.TryParse(existingQuyenBienLai.so_hien_tai, out int oldSoHienTai) && soHienTai < oldSoHienTai)
                        {
                            // Lấy tất cả biên lai của quyển biên lai này
                            var existingBienLais = await _context.BienLaiDienTus
                                .Where(b => b.quyen_bien_lai_dien_tu_id == id)
                                .ToListAsync();
                                
                            // Kiểm tra có biên lai nào đã được cấp có số nằm giữa số hiện tại mới và số hiện tại cũ
                            bool hasConflictingBienLai = existingBienLais.Any(b => {
                                if (int.TryParse(b.so_bien_lai, out int soBienLai)) {
                                    return soBienLai >= soHienTai && soBienLai < oldSoHienTai;
                                }
                                return false;
                            });
                                
                            if (hasConflictingBienLai)
                            {
                                return BadRequest(new { message = "Không thể giảm số hiện tại xuống thấp hơn vì đã có biên lai được cấp với số này" });
                            }
                            
                            _logger.LogInformation($"Giảm số hiện tại từ {oldSoHienTai} xuống {soHienTai}");
                        }
                    }
                    else
                    {
                        return BadRequest(new { message = "Số hiện tại, từ số hoặc đến số không hợp lệ" });
                    }
                    
                    existingQuyenBienLai.so_hien_tai = quyenBienLai.so_hien_tai;
                }

                await _context.SaveChangesAsync();
                return Ok(new { message = "Cập nhật quyển biên lai điện tử thành công" });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"Lỗi khi cập nhật quyển biên lai điện tử ID {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi cập nhật quyển biên lai điện tử", error = ex.Message });
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> Delete(int id)
        {
            var quyenBienLai = await _context.QuyenBienLaiDienTus.FindAsync(id);
            if (quyenBienLai == null)
                return NotFound();

            if (quyenBienLai.trang_thai != "chua_su_dung")
                return BadRequest(new { message = "Không thể xóa quyển biên lai đã sử dụng" });

            _context.QuyenBienLaiDienTus.Remove(quyenBienLai);
            await _context.SaveChangesAsync();

            return Ok(new { message = "Xóa quyển biên lai điện tử thành công" });
        }

        [HttpGet("by-ma-co-quan/{maCoQuanBHXH}")]
        public async Task<IActionResult> GetByMaCoQuanBHXH(string maCoQuanBHXH)
        {
            try
            {
                // Đảm bảo mã cơ quan BHXH không null
                maCoQuanBHXH = maCoQuanBHXH ?? "";
                
                // Tìm quyển biên lai điện tử đang active với mã cơ quan BHXH cụ thể
                var quyenBienLai = await _context.QuyenBienLaiDienTus
                    .Where(q => q.trang_thai == "active" && 
                           (string.IsNullOrEmpty(q.ma_co_quan_bhxh) || q.ma_co_quan_bhxh == maCoQuanBHXH))
                    .OrderBy(q => q.id)
                    .FirstOrDefaultAsync();
                
                // Nếu không tìm thấy, trả về quyển biên lai mặc định (không có mã cơ quan BHXH)
                if (quyenBienLai == null)
                {
                    quyenBienLai = await _context.QuyenBienLaiDienTus
                        .Where(q => q.trang_thai == "active")
                        .OrderBy(q => q.id)
                        .FirstOrDefaultAsync();
                }

                if (quyenBienLai == null)
                {
                    return NotFound(new { message = "Không tìm thấy quyển biên lai điện tử khả dụng" });
                }

                return Ok(quyenBienLai);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"Lỗi khi tìm quyển biên lai điện tử theo mã cơ quan BHXH '{maCoQuanBHXH}'");
                return StatusCode(500, new { message = "Lỗi khi tìm quyển biên lai điện tử", error = ex.Message });
            }
        }

        [HttpGet("active")]
        public async Task<IActionResult> GetActive()
        {
            try
            {
                var quyenBienLai = await _context.QuyenBienLaiDienTus
                    .Where(q => q.trang_thai == "active")
                    .OrderBy(q => q.id)
                    .ToListAsync();

                if (quyenBienLai == null || !quyenBienLai.Any())
                {
                    return NotFound(new { message = "Không tìm thấy quyển biên lai điện tử đang active" });
                }

                return Ok(quyenBienLai);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Lỗi khi lấy danh sách quyển biên lai điện tử đang active");
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách quyển biên lai điện tử đang active", error = ex.Message });
            }
        }

        [HttpPatch("{id}/active")]
        public async Task<IActionResult> ActivateQuyenBienLai(int id)
        {
            try
            {
                var quyenBienLai = await _context.QuyenBienLaiDienTus.FindAsync(id);
                if (quyenBienLai == null)
                    return NotFound(new { message = "Không tìm thấy quyển biên lai điện tử" });

                // Cập nhật trạng thái
                quyenBienLai.trang_thai = "active";
                
                await _context.SaveChangesAsync();
                
                return Ok(new { message = "Đã kích hoạt quyển biên lai điện tử thành công" });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"Lỗi khi kích hoạt quyển biên lai điện tử ID {id}");
                return StatusCode(500, new { message = "Lỗi khi kích hoạt quyển biên lai điện tử", error = ex.Message });
            }
        }

        [HttpPatch("{id}/inactive")]
        public async Task<IActionResult> DeactivateQuyenBienLai(int id)
        {
            try
            {
                var quyenBienLai = await _context.QuyenBienLaiDienTus.FindAsync(id);
                if (quyenBienLai == null)
                    return NotFound(new { message = "Không tìm thấy quyển biên lai điện tử" });

                // Cập nhật trạng thái
                quyenBienLai.trang_thai = "inactive";
                
                await _context.SaveChangesAsync();
                
                return Ok(new { message = "Đã vô hiệu hóa quyển biên lai điện tử thành công" });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"Lỗi khi vô hiệu hóa quyển biên lai điện tử ID {id}");
                return StatusCode(500, new { message = "Lỗi khi vô hiệu hóa quyển biên lai điện tử", error = ex.Message });
            }
        }

        private async Task<bool> QuyenBienLaiExists(int id)
        {
            return await _context.QuyenBienLaiDienTus.AnyAsync(e => e.id == id);
        }
    }
}
````

## File: WebApp.Server/Controllers/TestController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using Microsoft.Extensions.Logging;
using Npgsql;

namespace WebApp.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class TestController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<TestController> _logger;
        private readonly IConfiguration _configuration;

        public TestController(
            ApplicationDbContext context,
            ILogger<TestController> logger,
            IConfiguration configuration)
        {
            _context = context;
            _logger = logger;
            _configuration = configuration;
        }

        [HttpGet("database")]
        public async Task<IActionResult> TestDatabaseConnection()
        {
            try
            {
                var userCount = await _context.Users.CountAsync();
                var sampleUsers = await _context.Users
                    .Take(5)
                    .Select(u => new { u.username, u.role, u.status })
                    .ToListAsync();

                return Ok(new
                {
                    status = "success",
                    message = "Database connection successful",
                    details = new
                    {
                        userCount,
                        sampleUsers,
                        databaseName = _context.Database.GetDbConnection().Database
                    }
                });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Database connection error: {ex.Message}\nStackTrace: {ex.StackTrace}");
                return StatusCode(500, new { message = "Lỗi kết nối database", error = ex.Message });
            }
        }

        [HttpGet("user/{username}")]
        public async Task<IActionResult> GetUserDetails(string username)
        {
            try
            {
                var user = await _context.Users
                    .AsNoTracking()
                    .Where(u => u.username == username)
                    .Select(u => new
                    {
                        u.username,
                        u.ho_ten,
                        u.role,
                        u.status,
                        u.email,
                        u.so_dien_thoai,
                        u.department_code,
                        u.unit,
                        u.created_at,
                        u.last_login_at
                    })
                    .FirstOrDefaultAsync();

                if (user == null)
                    return NotFound(new { message = "Không tìm thấy user" });

                return Ok(new
                {
                    status = "success",
                    data = user
                });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting user details: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy thông tin user", error = ex.Message });
            }
        }
    }
}
````

## File: WebApp.Server/Controllers/ThongTinTheController.cs
````csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.API.Models;
using Microsoft.Extensions.Logging;
using System.Text.Json;

namespace WebApp.API.Controllers
{
    [Authorize]
    [ApiController]
    [Route("api/thong-tin-the")]
    public class ThongTinTheController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<ThongTinTheController> _logger;

        public ThongTinTheController(
            ApplicationDbContext context,
            ILogger<ThongTinTheController> logger)
        {
            _context = context;
            _logger = logger;
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<ThongTinThe>>> GetAll()
        {
            try
            {
                var result = await _context.ThongTinThes
                    .OrderByDescending(x => x.ngay_tao)
                    .ToListAsync();
                    
                return Ok(result);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting thong tin the list: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách thông tin thẻ", error = ex.Message });
            }
        }

        [HttpGet("{id}")]
        public async Task<ActionResult<ThongTinThe>> GetById(int id)
        {
            try
            {
                var thongTinThe = await _context.ThongTinThes.FindAsync(id);

                if (thongTinThe == null)
                {
                    return NotFound(new { message = "Không tìm thấy thông tin thẻ" });
                }

                return Ok(thongTinThe);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting thong tin the {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy thông tin thẻ", error = ex.Message });
            }
        }

        [HttpGet("cccd/{cccd}")]
        public async Task<ActionResult<ThongTinThe>> GetByCCCD(string cccd)
        {
            try
            {
                var thongTinThe = await _context.ThongTinThes
                    .FirstOrDefaultAsync(x => x.cccd == cccd);

                if (thongTinThe == null)
                {
                    return NotFound(new { message = "Không tìm thấy thông tin thẻ" });
                }

                return Ok(thongTinThe);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting thong tin the by CCCD {cccd}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy thông tin thẻ", error = ex.Message });
            }
        }

        [HttpGet("ma-so-bhxh/{maSoBHXH}")]
        public async Task<ActionResult<ThongTinThe>> GetByMaSoBHXH(string maSoBHXH)
        {
            try
            {
                var thongTinThe = await _context.ThongTinThes
                    .FirstOrDefaultAsync(x => x.ma_so_bhxh == maSoBHXH);

                if (thongTinThe == null)
                {
                    return NotFound(new { message = "Không tìm thấy thông tin thẻ" });
                }

                return Ok(thongTinThe);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting thong tin the by ma so BHXH {maSoBHXH}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy thông tin thẻ", error = ex.Message });
            }
        }

        [HttpPost]
        public async Task<ActionResult<ThongTinThe>> Create(ThongTinThe thongTinThe)
        {
            try
            {
                _logger.LogInformation($"Received data: {JsonSerializer.Serialize(thongTinThe)}");

                if (!ModelState.IsValid)
                {
                    _logger.LogWarning($"Invalid model state: {JsonSerializer.Serialize(ModelState)}");
                    return BadRequest(ModelState);
                }

                // Kiểm tra xem mã số BHXH đã tồn tại chưa
                var existingThongTinThe = await _context.ThongTinThes
                    .FirstOrDefaultAsync(x => x.ma_so_bhxh == thongTinThe.ma_so_bhxh);

                if (existingThongTinThe != null)
                {
                    // Nếu đã tồn tại, trả về thông tin thẻ cũ
                    return Ok(existingThongTinThe);
                }

                // Nếu chưa tồn tại, tạo mới
                thongTinThe.ngay_tao = DateTime.UtcNow;
                _context.ThongTinThes.Add(thongTinThe);
                await _context.SaveChangesAsync();

                return CreatedAtAction(nameof(GetById), new { id = thongTinThe.id }, thongTinThe);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error creating thong tin the: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi tạo thông tin thẻ", error = ex.Message });
            }
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> Update(int id, ThongTinThe thongTinThe)
        {
            if (id != thongTinThe.id)
            {
                return BadRequest(new { message = "ID không khớp" });
            }

            try
            {
                var existingThongTinThe = await _context.ThongTinThes.FindAsync(id);
                if (existingThongTinThe == null)
                {
                    return NotFound(new { message = "Không tìm thấy thông tin thẻ" });
                }

                _context.Entry(existingThongTinThe).CurrentValues.SetValues(thongTinThe);
                await _context.SaveChangesAsync();

                return NoContent();
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!ThongTinTheExists(id))
                {
                    return NotFound(new { message = "Không tìm thấy thông tin thẻ" });
                }
                throw;
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error updating thong tin the {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi cập nhật thông tin thẻ", error = ex.Message });
            }
        }

        private bool ThongTinTheExists(int id)
        {
            return _context.ThongTinThes.Any(e => e.id == id);
        }
    }
}
````

## File: WebApp.Server/Controllers/UsersController.cs
````csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using WebApp.API.Models;
using Microsoft.Extensions.Logging;
using BCrypt.Net;
using System.Text;
using System.Linq;

namespace WebApp.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class UsersController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<UsersController> _logger;

        public UsersController(
            ApplicationDbContext context,
            ILogger<UsersController> logger)
        {
            _context = context;
            _logger = logger;
        }

        [HttpGet]
        public async Task<IActionResult> GetUsers()
        {
            try
            {
                var users = await _context.Users
                    .Select(u => new
                    {
                        u.id,
                        u.username,
                        u.ho_ten,
                        u.email,
                        u.so_dien_thoai,
                        u.role,
                        u.department_code,
                        u.unit,
                        u.unit_id,
                        u.status,
                        u.province,
                        u.district,
                        u.commune,
                        u.hamlet,
                        u.address,
                        u.last_login_at,
                        u.last_login_ip,
                        u.last_login_location,
                        u.first_login,
                        u.password_changed,
                        u.created_at,
                        u.updated_at,
                        u.deleted_at,
                        is_deleted = u.deleted_at != null
                    })
                    .ToListAsync();

                return Ok(users);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting users: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy danh sách người dùng" });
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetUser(int id)
        {
            try
            {
                var user = await _context.Users
                    .Where(u => u.id == id && u.deleted_at == null)
                    .Select(u => new
                    {
                        u.id,
                        u.username,
                        u.ho_ten,
                        u.email,
                        u.so_dien_thoai,
                        u.role,
                        u.department_code,
                        u.unit,
                        u.unit_id,
                        u.status,
                        u.province,
                        u.district,
                        u.commune,
                        u.hamlet,
                        u.address,
                        u.last_login_at,
                        u.last_login_ip,
                        u.last_login_location,
                        u.first_login,
                        u.password_changed,
                        u.created_at,
                        u.updated_at
                    })
                    .FirstOrDefaultAsync();

                if (user == null)
                    return NotFound(new { message = "Không tìm thấy người dùng" });

                return Ok(user);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting user {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi lấy thông tin người dùng" });
            }
        }

        [HttpPost]
        public async Task<IActionResult> CreateUser([FromBody] User model)
        {
            try
            {
                if (string.IsNullOrEmpty(model.username) || string.IsNullOrEmpty(model.password))
                    return BadRequest(new { message = "Tên đăng nhập và mật khẩu không được để trống" });

                var existingUser = await _context.Users
                    .AnyAsync(u => u.username == model.username && u.deleted_at == null);

                if (existingUser)
                    return BadRequest(new { message = "Tên đăng nhập đã tồn tại" });

                model.password = BCrypt.Net.BCrypt.HashPassword(model.password);
                model.created_at = DateTime.UtcNow;
                model.updated_at = DateTime.UtcNow;
                model.status = "active";
                model.first_login = true;
                model.password_changed = false;

                _context.Users.Add(model);
                await _context.SaveChangesAsync();

                return CreatedAtAction(nameof(GetUser), new { id = model.id }, new
                {
                    model.id,
                    model.username,
                    model.ho_ten,
                    model.email,
                    model.so_dien_thoai,
                    model.role,
                    model.department_code,
                    model.unit,
                    model.unit_id,
                    model.status,
                    model.created_at,
                    model.updated_at
                });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error creating user: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi tạo người dùng" });
            }
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateUser(int id, [FromBody] User model)
        {
            try
            {
                var user = await _context.Users.FindAsync(id);
                if (user == null || user.deleted_at != null)
                    return NotFound(new { message = "Không tìm thấy người dùng" });

                // Kiểm tra username mới có bị trùng không
                if (model.username != user.username)
                {
                    var existingUser = await _context.Users
                        .AnyAsync(u => u.username == model.username && u.deleted_at == null);

                    if (existingUser)
                        return BadRequest(new { message = "Tên đăng nhập đã tồn tại" });
                }

                // Cập nhật thông tin
                user.username = model.username;
                user.ho_ten = model.ho_ten;
                user.email = model.email;
                user.so_dien_thoai = model.so_dien_thoai;
                user.role = model.role;
                user.department_code = model.department_code;
                user.unit = model.unit;
                user.unit_id = model.unit_id;
                user.status = model.status;
                user.province = model.province;
                user.district = model.district;
                user.commune = model.commune;
                user.hamlet = model.hamlet;
                user.address = model.address;
                user.updated_at = DateTime.UtcNow;

                // Nếu có mật khẩu mới thì cập nhật
                if (!string.IsNullOrEmpty(model.password))
                {
                    user.password = BCrypt.Net.BCrypt.HashPassword(model.password);
                    user.password_changed = true;
                }

                await _context.SaveChangesAsync();

                return Ok(new
                {
                    user.id,
                    user.username,
                    user.ho_ten,
                    user.email,
                    user.so_dien_thoai,
                    user.role,
                    user.department_code,
                    user.unit,
                    user.unit_id,
                    user.status,
                    user.updated_at
                });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error updating user {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi cập nhật người dùng" });
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteUser(int id)
        {
            try
            {
                var user = await _context.Users.FindAsync(id);
                if (user == null)
                    return NotFound(new { message = "Không tìm thấy người dùng" });

                _context.Users.Remove(user);
                await _context.SaveChangesAsync();

                return Ok(new { message = "Xóa người dùng thành công" });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error deleting user {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi xóa người dùng" });
            }
        }

        [HttpPatch("{id}/status")]
        public async Task<IActionResult> UpdateUserStatus(int id, [FromBody] UpdateStatusModel model)
        {
            try
            {
                var user = await _context.Users.FindAsync(id);
                if (user == null || user.deleted_at != null)
                    return NotFound(new { message = "Không tìm thấy người dùng" });

                if (model.status != "active" && model.status != "inactive")
                    return BadRequest(new { message = "Trạng thái không hợp lệ" });

                user.status = model.status;
                user.updated_at = DateTime.UtcNow;

                await _context.SaveChangesAsync();

                return Ok(new
                {
                    user.id,
                    user.username,
                    user.ho_ten,
                    user.status,
                    user.updated_at
                });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error updating user status {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi cập nhật trạng thái người dùng" });
            }
        }

        [HttpPost("{id}/reset-password")]
        public async Task<IActionResult> ResetPassword(int id)
        {
            try
            {
                var user = await _context.Users.FindAsync(id);
                if (user == null || user.deleted_at != null)
                    return NotFound(new { message = "Không tìm thấy người dùng" });

                // Tạo mật khẩu ngẫu nhiên 8 ký tự
                string newPassword = GenerateRandomPassword();

                // Hash mật khẩu mới
                user.password = BCrypt.Net.BCrypt.HashPassword(newPassword);
                user.password_changed = false;
                user.first_login = true;
                user.updated_at = DateTime.UtcNow;

                await _context.SaveChangesAsync();

                return Ok(new { password = newPassword });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error resetting password for user {id}: {ex.Message}");
                return StatusCode(500, new { message = "Lỗi khi đặt lại mật khẩu" });
            }
        }

        private string GenerateRandomPassword()
        {
            const string upperCase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const string lowerCase = "abcdefghijklmnopqrstuvwxyz";
            const string numbers = "0123456789";
            const string specials = "!@#$%^&*()_+-=[]{}|;:,.<>?";
            
            var random = new Random();
            var password = new StringBuilder();

            // Đảm bảo có ít nhất 1 ký tự từ mỗi loại
            password.Append(upperCase[random.Next(upperCase.Length)]);
            password.Append(lowerCase[random.Next(lowerCase.Length)]);
            password.Append(numbers[random.Next(numbers.Length)]);
            password.Append(specials[random.Next(specials.Length)]);

            // Thêm 8 ký tự ngẫu nhiên nữa để đủ 12 ký tự
            string allChars = upperCase + lowerCase + numbers + specials;
            for (int i = 0; i < 8; i++)
            {
                password.Append(allChars[random.Next(allChars.Length)]);
            }

            // Trộn ngẫu nhiên các ký tự
            return new string(password.ToString().ToCharArray().OrderBy(x => random.Next()).ToArray());
        }
    }

    public class UpdateStatusModel
    {
        public string status { get; set; }
    }
}
````

## File: WebApp.Server/Data/ApplicationDbContext.cs
````csharp
using Microsoft.EntityFrameworkCore;
using WebApp.API.Models;
using System.ComponentModel.DataAnnotations.Schema;
using WebApp.Server.Models;
using WebApp.API.Models.BienlaiDienTu;

namespace WebApp.API.Data
{
    public class ApplicationDbContext : DbContext
    {
        public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
            : base(options)
        {
        }

        public DbSet<User> Users { get; set; }
        public DbSet<PaymentBill> PaymentBills { get; set; }
        public DbSet<DanhMucTinh> DanhMucTinhs { get; set; }
        public DbSet<DanhMucHuyen> DanhMucHuyens { get; set; }
        public DbSet<DanhMucXa> DanhMucXas { get; set; }
        public DbSet<DotKeKhai> DotKeKhais { get; set; }
        public DbSet<KeKhaiBHYT> KeKhaiBHYTs { get; set; }
        public DbSet<ThongTinThe> ThongTinThes { get; set; }
        public DbSet<DanhMucCSKCB> DanhMucCSKCBs { get; set; }
        public DbSet<DonVi> DonVis { get; set; }
        public DbSet<HoaDonThanhToan> HoaDonThanhToans { get; set; }
        public DbSet<NguoiDung> NguoiDungs { get; set; }
        public DbSet<DaiLy> DaiLys { get; set; }
        public DbSet<DaiLyDonVi> DaiLyDonVis { get; set; }
        public DbSet<QuyenBienLai> QuyenBienLais { get; set; }
        public DbSet<BienLai> BienLais { get; set; }
        public DbSet<KeKhaiBHXH> KeKhaiBHXHs { get; set; }
        public DbSet<QuyenBienLaiDienTu> QuyenBienLaiDienTus { get; set; }
        public DbSet<BienLaiDienTu> BienLaiDienTus { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            modelBuilder.Entity<User>(entity =>
            {
                entity.ToTable("users");

                entity.HasIndex(e => e.username).IsUnique();
                entity.Property(e => e.username).IsRequired();
                entity.Property(e => e.password).IsRequired();

                // Đảm bảo các cột không null có giá trị mặc định
                entity.Property(e => e.ho_ten).HasMaxLength(100);
                entity.Property(e => e.email).HasMaxLength(100);
                entity.Property(e => e.so_dien_thoai).HasMaxLength(15);
                entity.Property(e => e.role).HasMaxLength(20);
                entity.Property(e => e.status).HasDefaultValue("active");
                entity.Property(e => e.created_at).HasDefaultValueSql("CURRENT_TIMESTAMP");
                entity.Property(e => e.updated_at).HasDefaultValueSql("CURRENT_TIMESTAMP");
            });

            modelBuilder.Entity<PaymentBill>(entity =>
            {
                entity.ToTable("payment_bills");

                entity.Property(e => e.file_url).HasMaxLength(500);
                entity.Property(e => e.cloudinary_public_id).HasMaxLength(255);
                entity.Property(e => e.uploaded_at).HasDefaultValueSql("CURRENT_TIMESTAMP");

                entity.HasOne<User>()
                    .WithMany()
                    .HasForeignKey(p => p.uploaded_by)
                    .OnDelete(DeleteBehavior.Cascade);
            });

            modelBuilder.Entity<DanhMucHuyen>(entity =>
            {
                entity.ToTable("ds_huyen");
                entity.HasIndex(e => e.ma).IsUnique();
                entity.Property(e => e.ma).IsRequired().HasMaxLength(3);
                entity.Property(e => e.ten).IsRequired().HasMaxLength(100);
                entity.Property(e => e.text).IsRequired().HasMaxLength(100);
                entity.Property(e => e.ma_tinh).IsRequired().HasMaxLength(2);
                entity.Property(e => e.created_at).HasDefaultValueSql("CURRENT_TIMESTAMP");

                entity.HasOne<DanhMucTinh>()
                    .WithMany()
                    .HasForeignKey(d => d.ma_tinh)
                    .HasPrincipalKey(p => p.ma)
                    .OnDelete(DeleteBehavior.Cascade);
            });

            modelBuilder.Entity<DanhMucXa>(entity =>
            {
                entity.ToTable("ds_xa");
                entity.HasIndex(e => e.ma).IsUnique();
                entity.Property(e => e.ma).HasMaxLength(5);
                entity.Property(e => e.ten).IsRequired().HasMaxLength(100);
                entity.Property(e => e.text).IsRequired().HasMaxLength(100);
                entity.Property(e => e.ma_huyen).IsRequired().HasMaxLength(3);
                entity.Property(e => e.created_at).HasDefaultValueSql("CURRENT_TIMESTAMP");

                entity.HasOne<DanhMucHuyen>()
                    .WithMany()
                    .HasForeignKey(c => c.ma_huyen)
                    .HasPrincipalKey(d => d.ma)
                    .OnDelete(DeleteBehavior.Cascade);
            });

            modelBuilder.Entity<DotKeKhai>(entity =>
            {
                entity.ToTable("dot_ke_khai");
                
                entity.HasKey(e => e.id);

                // Cấu hình quan hệ với DaiLy
                entity.HasOne(d => d.DaiLy)
                    .WithMany()
                    .HasForeignKey(d => d.dai_ly_id)
                    .OnDelete(DeleteBehavior.Restrict);

                // Cấu hình quan hệ với DonVi  
                entity.HasOne(d => d.DonVi)
                    .WithMany()
                    .HasForeignKey(d => d.don_vi_id)
                    .OnDelete(DeleteBehavior.Restrict);

                // Các cấu hình khác
                entity.Property(e => e.ten_dot).HasMaxLength(200);
                entity.Property(e => e.dich_vu).HasMaxLength(10);
                entity.Property(e => e.ghi_chu).HasMaxLength(500);
                entity.Property(e => e.trang_thai).HasDefaultValue("chua_gui");
                entity.Property(e => e.ngay_tao).HasDefaultValueSql("CURRENT_TIMESTAMP");
            });

            modelBuilder.Entity<KeKhaiBHYT>(entity =>
            {
                entity.ToTable("ke_khai_bhyt");

                entity.Property(e => e.nguoi_tao).IsRequired().HasMaxLength(50);
                entity.Property(e => e.ngay_tao).HasDefaultValueSql("CURRENT_TIMESTAMP");
                entity.Property(e => e.dot_ke_khai_id).HasColumnName("dot_ke_khai_id");

                entity.HasOne(k => k.DotKeKhai)
                    .WithMany(d => d.KeKhaiBHYTs)
                    .HasForeignKey(k => k.dot_ke_khai_id)
                    .HasConstraintName("FK_KeKhaiBHYT_DotKeKhai")
                    .OnDelete(DeleteBehavior.Cascade);

                entity.HasOne(k => k.ThongTinThe)
                    .WithMany()
                    .HasForeignKey(k => k.thong_tin_the_id)
                    .OnDelete(DeleteBehavior.Cascade);

                entity.HasOne(k => k.QuyenBienLai)
                    .WithMany()
                    .HasForeignKey(k => k.quyen_bien_lai_id);
            });

            modelBuilder.Entity<ThongTinThe>(entity =>
            {
                entity.ToTable("thong_tin_the");

                entity.HasIndex(e => e.ma_so_bhxh).IsUnique();
                entity.HasIndex(e => e.cccd).IsUnique();

                entity.Property(e => e.nguoi_tao).IsRequired().HasMaxLength(50);
                entity.Property(e => e.ngay_tao).HasDefaultValueSql("CURRENT_TIMESTAMP");
                
                // Cấu hình cho ma_tinh_ks không bắt buộc
                entity.Property(e => e.ma_tinh_ks).IsRequired(false);
            });

            modelBuilder.Entity<DanhMucCSKCB>(entity =>
            {
                entity.ToTable("dm_cskcb");
                entity.HasKey(e => e.id);
            });

            modelBuilder.Entity<DonVi>(entity =>
            {
                entity.ToTable("don_vi");
                entity.HasKey(e => e.Id);

                entity.Property(e => e.MaCoQuanBHXH).IsRequired().HasMaxLength(10);
                entity.Property(e => e.MaSoBHXH).IsRequired().HasMaxLength(10);
                entity.Property(e => e.TenDonVi).IsRequired().HasMaxLength(255);
                entity.Property(e => e.TrangThai).HasDefaultValue(true);
                entity.Property(e => e.CreatedAt).HasDefaultValueSql("CURRENT_TIMESTAMP");
                entity.Property(e => e.UpdatedAt).HasDefaultValueSql("CURRENT_TIMESTAMP");
            });

            modelBuilder.Entity<HoaDonThanhToan>(entity =>
            {
                entity.ToTable("hoa_don_thanh_toan");
                entity.HasKey(e => e.id);

                entity.Property(e => e.ghi_chu).IsRequired(false);
                entity.Property(e => e.ngay_tao).HasDefaultValueSql("CURRENT_TIMESTAMP");
                entity.Property(e => e.ngay_thanh_toan).HasDefaultValueSql("CURRENT_TIMESTAMP");
                entity.Property(e => e.trang_thai).HasDefaultValue("cho_duyet");

                entity.HasOne(h => h.DotKeKhai)
                    .WithMany()
                    .HasForeignKey(h => h.dot_ke_khai_id)
                    .OnDelete(DeleteBehavior.Cascade);
            });

            modelBuilder.Entity<NguoiDung>(entity =>
            {
                entity.ToTable("nguoi_dung");
                entity.HasKey(e => e.id);

                entity.HasIndex(e => e.user_name).IsUnique();
                entity.Property(e => e.user_name).IsRequired().HasMaxLength(50);
                entity.Property(e => e.ho_ten).IsRequired().HasMaxLength(100);
                entity.Property(e => e.don_vi_cong_tac).HasMaxLength(200);
                entity.Property(e => e.chuc_danh).HasMaxLength(100);
                entity.Property(e => e.email).HasMaxLength(100);
                entity.Property(e => e.so_dien_thoai).HasMaxLength(20);
                entity.Property(e => e.roles).HasColumnType("text[]");
                entity.Property(e => e.client_id).HasMaxLength(100);
                entity.Property(e => e.status).HasDefaultValue(1);
                entity.Property(e => e.created_at).HasDefaultValueSql("CURRENT_TIMESTAMP");
                entity.Property(e => e.updated_at).HasDefaultValueSql("CURRENT_TIMESTAMP");
            });

            modelBuilder.Entity<DaiLy>(entity =>
            {
                entity.ToTable("dai_ly");
                entity.HasKey(e => e.Id);

                entity.HasIndex(e => e.Ma).IsUnique();
                entity.Property(e => e.Ma).IsRequired().HasMaxLength(20);
                entity.Property(e => e.Ten).IsRequired().HasMaxLength(200);
                entity.Property(e => e.DiaChi).HasMaxLength(500);
                entity.Property(e => e.SoDienThoai).HasMaxLength(15);
                entity.Property(e => e.Email).HasMaxLength(100);
                entity.Property(e => e.NguoiDaiDien).HasMaxLength(100);
                entity.Property(e => e.TrangThai).HasDefaultValue(true);
                entity.Property(e => e.NgayTao).HasDefaultValueSql("CURRENT_TIMESTAMP");
                entity.Property(e => e.NguoiTao).HasMaxLength(50);
            });

            // Cấu hình mối quan hệ nhiều-nhiều
            modelBuilder.Entity<DaiLyDonVi>()
                .HasKey(x => x.Id);

            modelBuilder.Entity<DaiLyDonVi>()
                .HasOne(x => x.DaiLy)
                .WithMany()
                .HasForeignKey(x => x.DaiLyId);

            modelBuilder.Entity<DaiLyDonVi>()
                .HasOne(x => x.DonVi)
                .WithMany()
                .HasForeignKey(x => x.DonViId);

            modelBuilder.Entity<QuyenBienLai>(entity =>
            {
                entity.ToTable("quyen_bien_lai");
                entity.HasKey(e => e.id);

                entity.Property(e => e.quyen_so).IsRequired().HasMaxLength(20);
                entity.Property(e => e.tu_so).IsRequired().HasMaxLength(20);
                entity.Property(e => e.den_so).IsRequired().HasMaxLength(20);
                entity.Property(e => e.nguoi_cap).IsRequired().HasMaxLength(50);
                entity.Property(e => e.trang_thai).HasMaxLength(20);
                entity.Property(e => e.so_hien_tai).HasMaxLength(20);
                
                entity.Property(e => e.ngay_cap)
                    .HasColumnType("timestamp without time zone")
                    .HasDefaultValueSql("CURRENT_TIMESTAMP");

                entity.HasOne(e => e.NguoiThu)
                    .WithMany()
                    .HasForeignKey(e => e.nhan_vien_thu)
                    .OnDelete(DeleteBehavior.Restrict);
            });

            // Configure BienLai
            modelBuilder.Entity<BienLai>(entity =>
            {
                entity.ToTable("bien_lai");
                
                entity.HasOne(b => b.KeKhaiBHYT)
                      .WithOne(k => k.BienLai)
                      .HasForeignKey<BienLai>(b => b.ke_khai_bhyt_id)
                      .OnDelete(DeleteBehavior.Cascade);
            });

            // QuyenBienLaiDienTu configuration
            modelBuilder.Entity<QuyenBienLaiDienTu>(entity =>
            {
                entity.ToTable("quyen_bien_lai_dien_tu");
                entity.HasKey(e => e.id);

                entity.Property(e => e.ky_hieu).IsRequired().HasMaxLength(20);
                entity.Property(e => e.tu_so).IsRequired().HasMaxLength(20);
                entity.Property(e => e.den_so).IsRequired().HasMaxLength(20);
                entity.Property(e => e.nguoi_cap).IsRequired().HasMaxLength(50);
                entity.Property(e => e.trang_thai).IsRequired().HasMaxLength(20);
                entity.Property(e => e.so_hien_tai).HasMaxLength(20);
                entity.Property(e => e.ngay_cap).HasDefaultValueSql("CURRENT_TIMESTAMP");
            });

            // BienLaiDienTu configuration
            modelBuilder.Entity<BienLaiDienTu>(entity =>
            {
                entity.ToTable("bien_lai_dien_tu");
                entity.HasKey(e => e.id);

                entity.Property(e => e.ky_hieu).IsRequired().HasMaxLength(20);
                entity.Property(e => e.so_bien_lai).IsRequired().HasMaxLength(20);
                entity.Property(e => e.ten_nguoi_dong).IsRequired().HasMaxLength(200);
                entity.Property(e => e.so_tien).HasColumnType("decimal(18,2)");
                entity.Property(e => e.ghi_chu).HasMaxLength(500);
                entity.Property(e => e.trang_thai).IsRequired().HasMaxLength(20);
                entity.Property(e => e.ngay_tao).HasDefaultValueSql("CURRENT_TIMESTAMP");
                entity.Property(e => e.ngay_bien_lai).HasDefaultValueSql("CURRENT_TIMESTAMP");
                entity.Property(e => e.ma_so_bhxh).IsRequired().HasMaxLength(10);
                entity.Property(e => e.ma_nhan_vien).IsRequired().HasMaxLength(50);
                entity.Property(e => e.ma_co_quan_bhxh).IsRequired().HasMaxLength(20);
                entity.Property(e => e.ma_so_bhxh_don_vi).IsRequired().HasMaxLength(10);

                entity.HasOne(b => b.KeKhaiBHYT)
                    .WithMany()
                    .HasForeignKey(b => b.ke_khai_bhyt_id)
                    .OnDelete(DeleteBehavior.Restrict);

                entity.HasOne(b => b.QuyenBienLaiDienTu)
                    .WithMany()
                    .HasForeignKey(b => b.quyen_bien_lai_dien_tu_id)
                    .OnDelete(DeleteBehavior.Restrict);
            });
        }
    }
}
````

## File: WebApp.Server/DTOs/LoginDto.cs
````csharp
using System.ComponentModel.DataAnnotations;

namespace WebApp.API.DTOs
{
    public class LoginDto
    {
        [Required]
        public string Username { get; set; } = string.Empty;
        
        [Required]
        public string Password { get; set; } = string.Empty;
    }

    public class LoginResponseDto
    {
        public int Id { get; set; }
        public string Username { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;
        public string Token { get; set; } = string.Empty;
        public bool FirstLogin { get; set; }
        public bool PasswordChanged { get; set; }
    }
}
````

## File: WebApp.Server/Migrations/[Timestamp]_AddDaiLyIdToDonVi.cs
````csharp
using Microsoft.EntityFrameworkCore.Migrations;

namespace WebApp.API.Migrations
{
    public partial class AddDaiLyIdToDonVi : Migration
    {
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.AddColumn<int>(
                name: "dai_ly_id",
                table: "don_vi",
                type: "integer",
                nullable: true);

            migrationBuilder.CreateIndex(
                name: "IX_don_vi_dai_ly_id",
                table: "don_vi",
                column: "dai_ly_id");

            migrationBuilder.AddForeignKey(
                name: "FK_don_vi_dai_ly_dai_ly_id",
                table: "don_vi",
                column: "dai_ly_id",
                principalTable: "dai_ly",
                principalColumn: "id",
                onDelete: ReferentialAction.SetNull);
        }

        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropForeignKey(
                name: "FK_don_vi_dai_ly_dai_ly_id",
                table: "don_vi");

            migrationBuilder.DropIndex(
                name: "IX_don_vi_dai_ly_id",
                table: "don_vi");

            migrationBuilder.DropColumn(
                name: "dai_ly_id",
                table: "don_vi");
        }
    }
}
````

## File: WebApp.Server/Migrations/[Timestamp]_AddTrangThaiToDonVi.cs
````csharp
using Microsoft.EntityFrameworkCore.Migrations;

namespace WebApp.API.Migrations
{
    public partial class AddTrangThaiToDonVi : Migration
    {
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.AddColumn<bool>(
                name: "trang_thai",
                table: "don_vi",
                type: "boolean",
                nullable: false,
                defaultValue: true);
        }

        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropColumn(
                name: "trang_thai",
                table: "don_vi");
        }
    }
}
````

## File: WebApp.Server/Models/BienlaiDienTu/BienLaiDienTu.cs
````csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using WebApp.API.Models;

namespace WebApp.API.Models.BienlaiDienTu
{
    public enum TinhChatBienLaiDienTu
    {
        [Column(TypeName = "text")]
        bien_lai_goc = 0,
        [Column(TypeName = "text")]
        bien_lai_huy_bo = 1
    }

    [Table("bien_lai_dien_tu")]
    public class BienLaiDienTu
    {
        [Key]
        public int id { get; set; }
        
        [Required]
        [StringLength(20)]
        public string ky_hieu { get; set; } = "BH25-AG/08907/E";
        
        [Required]
        [StringLength(20)] 
        public string so_bien_lai { get; set; } = string.Empty;
        
        [Required]
        [StringLength(200)]
        public string ten_nguoi_dong { get; set; } = string.Empty;
        
        [Required]
        [Column(TypeName = "decimal(18,2)")]
        public decimal so_tien { get; set; }
        
        [StringLength(500)]
        public string? ghi_chu { get; set; }
        
        [Required]
        [StringLength(20)]
        public string trang_thai { get; set; } = "active";
        
        [Required]
        public DateTime ngay_tao { get; set; } = DateTime.Now;

        [Required]
        public DateTime ngay_bien_lai { get; set; } = DateTime.Now;

        // Foreign key
        public int? ke_khai_bhyt_id { get; set; }

        [ForeignKey("ke_khai_bhyt_id")]
        public virtual KeKhaiBHYT? KeKhaiBHYT { get; set; }

        // Foreign key to QuyenBienLaiDienTu
        public int quyen_bien_lai_dien_tu_id { get; set; }

        [ForeignKey("quyen_bien_lai_dien_tu_id")]
        public virtual QuyenBienLaiDienTu? QuyenBienLaiDienTu { get; set; }

        [Required]
        [StringLength(10)]
        public string ma_so_bhxh { get; set; } = string.Empty;

        [Required]
        [StringLength(50)]
        public string ma_nhan_vien { get; set; } = string.Empty;

        [Required]
        [Column(TypeName = "text")]
        public string tinh_chat { get; set; } = "bien_lai_goc";

        [Required]
        [StringLength(20)]
        public string ma_co_quan_bhxh { get; set; } = string.Empty;

        [Required]
        [StringLength(10)]
        public string ma_so_bhxh_don_vi { get; set; } = string.Empty;

        [Required] 
        public bool is_bhyt { get; set; }

        [Required] 
        public bool is_bhxh { get; set; }
    }
}
````

## File: WebApp.Server/Models/BienlaiDienTu/QuyenBienLaiDienTu.cs
````csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using WebApp.API.Models;

namespace WebApp.API.Models.BienlaiDienTu
{
    [Table("quyen_bien_lai_dien_tu")]
    public class QuyenBienLaiDienTu
    {
        public QuyenBienLaiDienTu()
        {
            ky_hieu = "BH25-AG/08907/E";
            tu_so = "0000001";
            den_so = "9999999";
            nguoi_cap = "Admin";
            trang_thai = "chua_su_dung";
            ma_co_quan_bhxh = "";
        }

        [Key]
        public int id { get; set; }

        [Required]
        [StringLength(20)]
        public string ky_hieu { get; set; }

        [Required] 
        [StringLength(20)]
        public string tu_so { get; set; }

        [Required]
        [StringLength(20)] 
        public string den_so { get; set; }

        public DateTime ngay_cap { get; set; }

        [StringLength(50)]
        public string nguoi_cap { get; set; }

        [Required]
        [StringLength(20)]
        public string trang_thai { get; set; }

        [StringLength(20)]
        public string? so_hien_tai { get; set; }

        [StringLength(20)]
        public string? ma_co_quan_bhxh { get; set; }
    }
}
````

## File: WebApp.Server/Models/BienLai.cs
````csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using WebApp.API.Models;

namespace WebApp.API.Models
{
    public enum TinhChatBienLai
    {
        [Column(TypeName = "text")]
        bien_lai_goc = 0,
        [Column(TypeName = "text")]
        bien_lai_huy_bo = 1
    }

    public class BienLai
    {
        [Key]
        public int id { get; set; }
        
        [Required]
        [StringLength(50)]
        public string quyen_so { get; set; } = string.Empty;
        
        [Required]
        [StringLength(50)] 
        public string so_bien_lai { get; set; } = string.Empty;
        
        [Required]
        [StringLength(200)]
        public string ten_nguoi_dong { get; set; } = string.Empty;
        
        [Required]
        [Column(TypeName = "decimal(18,2)")]
        public decimal so_tien { get; set; }
        
        [StringLength(500)]
        public string? ghi_chu { get; set; }
        
        [Required]
        [StringLength(20)]
        public string trang_thai { get; set; } = "active";
        
        [Required]
        public DateTime ngay_tao { get; set; } = DateTime.Now;

        [Required]
        public DateTime ngay_bien_lai { get; set; } = DateTime.Now;

        // Foreign key
        public int ke_khai_bhyt_id { get; set; }

        [ForeignKey("ke_khai_bhyt_id")]
        public virtual KeKhaiBHYT? KeKhaiBHYT { get; set; }

        [Required]
        [StringLength(10)]
        public string ma_so_bhxh { get; set; } = string.Empty;

        [Required]
        [StringLength(50)]
        public string ma_nhan_vien { get; set; } = string.Empty;

        [Required]
        [Column(TypeName = "text")]
        public string tinh_chat { get; set; } = "bien_lai_goc";

        [Required]
        [StringLength(20)]
        public string ma_co_quan_bhxh { get; set; } = string.Empty;

        [Required]
        [StringLength(10)]
        public string ma_so_bhxh_don_vi { get; set; } = string.Empty;

        [Required]
        public bool is_bhyt { get; set; }

        [Required] 
        public bool is_bhxh { get; set; }
    }
}
````

## File: WebApp.Server/Models/DaiLy.cs
````csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using System.Collections.Generic;
using WebApp.API.Models;

namespace WebApp.Server.Models
{
    [Table("dai_ly")]
    public class DaiLy
    {
        public DaiLy()
        {
            Ma = string.Empty;
            Ten = string.Empty;
            DiaChi = string.Empty;
            SoDienThoai = string.Empty;
            Email = string.Empty;
            NguoiDaiDien = string.Empty;
            NguoiTao = string.Empty;
            NgayTao = DateTime.UtcNow;
            TrangThai = true;
            DonVis = new List<DonVi>();
        }

        [Key]
        [Column("id")]
        public int Id { get; set; }

        [Column("ma")]
        [Required]
        [StringLength(20)]
        public string Ma { get; set; }

        [Column("ten")]
        [Required]
        [StringLength(200)]
        public string Ten { get; set; }

        [Column("dia_chi")]
        public string DiaChi { get; set; }

        [Column("so_dien_thoai")]
        [StringLength(15)]
        public string SoDienThoai { get; set; }

        [Column("email")]
        [StringLength(100)]
        public string Email { get; set; }

        [Column("nguoi_dai_dien")]
        [StringLength(100)]
        public string NguoiDaiDien { get; set; }

        [Column("trang_thai")]
        public bool TrangThai { get; set; }

        [Column("ngay_tao")]
        public DateTime NgayTao { get; set; }

        [Column("nguoi_tao")]
        [StringLength(50)]
        public string NguoiTao { get; set; }

        public virtual ICollection<DonVi> DonVis { get; set; }
    }
}
````

## File: WebApp.Server/Models/DaiLyDonVi.cs
````csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using WebApp.API.Models;

namespace WebApp.Server.Models
{
    [Table("dai_ly_don_vi")]
    public class DaiLyDonVi
    {
        public DaiLyDonVi()
        {
            NguoiTao = string.Empty;
            TrangThai = true;
            NgayTao = DateTime.UtcNow;
        }

        [Key]
        [Column("id")]
        public int Id { get; set; }

        [Column("dai_ly_id")]
        public int DaiLyId { get; set; }

        [Column("don_vi_id")]
        public int DonViId { get; set; }

        [Column("trang_thai")]
        public bool TrangThai { get; set; }

        [Column("ngay_tao")]
        public DateTime NgayTao { get; set; }

        [Column("nguoi_tao")]
        [StringLength(50)]
        public string NguoiTao { get; set; }

        [ForeignKey("DaiLyId")]
        public virtual DaiLy DaiLy { get; set; }

        [ForeignKey("DonViId")]
        public virtual DonVi DonVi { get; set; }
    }
}
````

## File: WebApp.Server/Models/DanhMucCSKCB.cs
````csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace WebApp.API.Models
{
    [Table("dm_cskcb")]
    public class DanhMucCSKCB
    {
        [Key]
        public int id { get; set; }

        [Required]
        [StringLength(10)]
        public string value { get; set; }

        [Required] 
        [StringLength(200)]
        public string text { get; set; }

        [Required]
        [StringLength(200)]
        public string ten { get; set; }

        [Column("ma_tinh_kcb")]
        [StringLength(10)]
        public string ma_tinh_kcb { get; set; }

        public DateTime created_at { get; set; }
    }
}
````

## File: WebApp.Server/Models/DanhMucHuyen.cs
````csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace WebApp.API.Models
{
    [Table("ds_huyen")]
    public class DanhMucHuyen
    {
        [Key]
        public int id { get; set; }

        [Required]
        [StringLength(3)]
        public string ma { get; set; }

        [Required]
        [StringLength(100)]
        public string ten { get; set; }

        [Required]
        [StringLength(100)]
        public string text { get; set; }

        [Required]
        [StringLength(2)]
        [Column("ma_tinh")]
        public string ma_tinh { get; set; }

        public DateTime created_at { get; set; }
    }
}
````

## File: WebApp.Server/Models/DanhMucTinh.cs
````csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace WebApp.API.Models
{
    [Table("ds_tinh")]
    public class DanhMucTinh
    {
        [Key]
        public int id { get; set; }

        [Required]
        [StringLength(2)]
        public string ma { get; set; }

        [Required]
        [StringLength(100)]
        public string ten { get; set; }

        [Required]
        [StringLength(100)]
        public string text { get; set; }

        public DateTime created_at { get; set; }
    }
}
````

## File: WebApp.Server/Models/DanhMucXa.cs
````csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace WebApp.API.Models
{
    [Table("ds_xa")]
    public class DanhMucXa
    {
        [Key]
        public int id { get; set; }

        [Required]
        [StringLength(5)]
        public string ma { get; set; }

        [Required]
        [StringLength(100)]
        public string ten { get; set; }

        [Required]
        [StringLength(100)]
        public string text { get; set; }

        [Required]
        [StringLength(3)]
        [Column("ma_huyen")]
        public string ma_huyen { get; set; }

        public DateTime created_at { get; set; }
    }
}
````

## File: WebApp.Server/Models/DonVi.cs
````csharp
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using WebApp.Server.Models;

namespace WebApp.API.Models
{
    [Table("don_vi")]
    public class DonVi
    {
        public DonVi()
        {
            MaCoQuanBHXH = string.Empty;
            MaSoBHXH = string.Empty;
            TenDonVi = string.Empty;
            Type = 0;
            TrangThai = true;
            CreatedAt = DateTime.UtcNow;
            UpdatedAt = DateTime.UtcNow;
            DaiLys = new List<DaiLy>();
        }

        [Key]
        [Column("id")]
        public int Id { get; set; }

        [Required]
        [Column("ma_co_quan_bhxh")]
        [StringLength(10)]
        public string MaCoQuanBHXH { get; set; }

        [Required]
        [Column("ma_so_bhxh")]
        [StringLength(10)]
        public string MaSoBHXH { get; set; }

        [Required]
        [Column("ten_don_vi")]
        [StringLength(255)]
        public string TenDonVi { get; set; }

        [Column("is_bhxhtn")]
        public bool IsBHXHTN { get; set; }

        [Column("is_bhyt")]
        public bool IsBHYT { get; set; }

        [Column("dm_khoi_kcb_id")]
        public int? DmKhoiKcbId { get; set; }

        [Column("type")]
        public int Type { get; set; }

        [Column("trang_thai")]
        public bool TrangThai { get; set; }

        [Column("created_at")]
        public DateTime CreatedAt { get; set; }

        [Column("updated_at")]
        public DateTime UpdatedAt { get; set; }

        public virtual ICollection<DaiLy> DaiLys { get; set; }
    }
}
````

## File: WebApp.Server/Models/DotKeKhai.cs
````csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using System.Text.RegularExpressions;
using System.Collections.Generic;
using System.Text.Json.Serialization;
using WebApp.API.Models;
using WebApp.Server.Models;

namespace WebApp.API.Models
{
    /// <summary>
    /// Model quản lý đợt kê khai
    /// </summary>
    [Table("dot_ke_khai")]
    public class DotKeKhai
    {
        /// <summary>
        /// ID đợt kê khai
        /// </summary>
        [Column("id")]
        public int id { get; set; }

        /// <summary>
        /// Tên đợt kê khai (định dạng: Đợt [số đợt] Tháng [tháng] năm [năm])
        /// </summary>
        [Required(ErrorMessage = "Tên đợt kê khai không được để trống")]
        [StringLength(200, ErrorMessage = "Tên đợt kê khai không được vượt quá 200 ký tự")]
        [RegularExpression(@"^Đợt \d+ Tháng \d{1,2} năm \d{4}$", 
            ErrorMessage = "Tên đợt phải có định dạng: Đợt [số đợt] Tháng [tháng] năm [năm]")]
        public string ten_dot { get; set; } = string.Empty;

        /// <summary>
        /// Số đợt trong năm
        /// </summary>
        [Required(ErrorMessage = "Số đợt không được để trống")]
        [Range(1, int.MaxValue, ErrorMessage = "Số đợt phải lớn hơn 0")]
        public int so_dot { get; set; }

        /// <summary>
        /// Tháng kê khai
        /// </summary>
        [Required(ErrorMessage = "Tháng không được để trống")]
        [Range(1, 12, ErrorMessage = "Tháng phải từ 1 đến 12")]
        public int thang { get; set; }

        /// <summary>
        /// Năm kê khai
        /// </summary>
        [Required(ErrorMessage = "Năm không được để trống")]
        [Range(2000, 9999, ErrorMessage = "Năm phải từ 2000 đến 9999")]
        public int nam { get; set; }

        /// <summary>
        /// Loại dịch vụ (BHXH TN, BHYT)
        /// </summary>
        [Required(ErrorMessage = "Loại dịch vụ không được để trống")]
        [StringLength(10)]
        public string dich_vu { get; set; } = "BHXH TN";

        /// <summary>
        /// Ghi chú cho đợt kê khai
        /// </summary>
        [StringLength(500, ErrorMessage = "Ghi chú không được vượt quá 500 ký tự")]
        public string? ghi_chu { get; set; } = string.Empty;

        /// <summary>
        /// Trạng thái đợt kê khai
        /// </summary>
        public string trang_thai { get; set; } = "chua_gui";

        /// <summary>
        /// Ngày tạo đợt kê khai
        /// </summary>
        public DateTime ngay_tao { get; set; } = DateTime.UtcNow;

        /// <summary>
        /// Người tạo đợt kê khai
        /// </summary>
        [Required(ErrorMessage = "Người tạo không được để trống")]
        public string nguoi_tao { get; set; } = string.Empty;

        /// <summary>
        /// Tạo tên đợt tự động theo định dạng: Đợt [số đợt] Tháng [tháng] năm [năm]
        /// </summary>
        public void GenerateTenDot()
        {
            // Đảm bảo số đợt, tháng và năm đều hợp lệ
            if (so_dot > 0 && thang >= 1 && thang <= 12 && nam >= 2000)
            {
                ten_dot = $"Đợt {so_dot} Tháng {thang} năm {nam}";
            }
        }

        [Column("don_vi_id")]
        [ForeignKey("DonVi")]
        [Required(ErrorMessage = "Đơn vị không được để trống")]
        public int don_vi_id { get; set; }
        public virtual DonVi? DonVi { get; set; }

        [Column("tong_so_tien")]
        public decimal? tong_so_tien { get; set; }

        [Column("tong_so_the")]
        public int? tong_so_the { get; set; }

        [Column("url_bill")]
        public string? url_bill { get; set; }

        [Column("ma_ho_so")]
        [StringLength(50)]
        public string? ma_ho_so { get; set; }

        [Column("is_bien_lai_dien_tu")]
        public bool is_bien_lai_dien_tu { get; set; } = false;

        // Navigation property cho KeKhaiBHYT
        [JsonIgnore]
        public virtual ICollection<KeKhaiBHYT> KeKhaiBHYTs { get; set; }

        [Column("dai_ly_id")]
        [Required]
        public int dai_ly_id { get; set; }

        [ForeignKey("dai_ly_id")]
        public virtual DaiLy? DaiLy { get; set; }

        public DotKeKhai()
        {
            ten_dot = string.Empty;
            dich_vu = "BHXH TN";
            trang_thai = "chua_gui";
            nguoi_tao = string.Empty;
            ghi_chu = string.Empty;
            KeKhaiBHYTs = new List<KeKhaiBHYT>();
            ngay_tao = DateTime.UtcNow;
        }
    }
}
````

## File: WebApp.Server/Models/HoaDonThanhToan.cs
````csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace WebApp.API.Models
{
    public class HoaDonThanhToan
    {
        [Key]
        [Column("id")]
        public int id { get; set; }

        [Required]
        [Column("dot_ke_khai_id")]
        public int dot_ke_khai_id { get; set; }

        [Column("ngay_thanh_toan")]
        public DateTime ngay_thanh_toan { get; set; } = DateTime.UtcNow;

        [Column("so_tien")]
        public decimal so_tien { get; set; }

        [Required]
        [Column("noi_dung_thanh_toan")]
        public string noi_dung_thanh_toan { get; set; }

        [Required]
        [Column("url_bill")]
        public string url_bill { get; set; }

        [Column("public_id")]
        public string public_id { get; set; }

        [Required]
        [Column("trang_thai")]
        public string trang_thai { get; set; }

        [Required]
        [Column("nguoi_tao")]
        public string nguoi_tao { get; set; }

        [Column("ngay_tao")]
        public DateTime ngay_tao { get; set; } = DateTime.UtcNow;

        [Column("ghi_chu")]
        public string? ghi_chu { get; set; } = string.Empty;

        [Column("deleted_at")]
        public DateTime? deleted_at { get; set; }

        [Column("deleted_by")]
        public int? deleted_by { get; set; }

        // Navigation property
        [ForeignKey("dot_ke_khai_id")]
        public virtual DotKeKhai? DotKeKhai { get; set; }

        public HoaDonThanhToan()
        {
            noi_dung_thanh_toan = string.Empty;
            url_bill = string.Empty;
            public_id = string.Empty;
            trang_thai = "cho_duyet";
            nguoi_tao = string.Empty;
            ghi_chu = string.Empty;
            ngay_tao = DateTime.UtcNow;
            ngay_thanh_toan = DateTime.UtcNow;
        }
    }
}
````

## File: WebApp.Server/Models/KeKhaiBHXH.cs
````csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace WebApp.API.Models
{
    [Table("ke_khai_bhxh")]
    public class KeKhaiBHXH
    {
        [Key]
        [Column("id")]
        public int id { get; set; }

        [Column("dot_ke_khai_id")]
        public int dot_ke_khai_id { get; set; }

        [Column("thong_tin_the_id")]
        public int thong_tin_the_id { get; set; }

        [Column("muc_thu_nhap")]
        public decimal muc_thu_nhap { get; set; }

        [Column("ty_le_dong")]
        public decimal ty_le_dong { get; set; }

        [Column("ty_le_nsnn")]
        public decimal? ty_le_nsnn { get; set; }

        [Column("loai_nsnn")]
        public string loai_nsnn { get; set; }

        [Column("tien_ho_tro")]
        public decimal tien_ho_tro { get; set; }

        [Column("so_tien_can_dong")]
        public decimal so_tien_can_dong { get; set; }

        [Column("phuong_thuc_dong")]
        public int phuong_thuc_dong { get; set; }

        [Column("thang_bat_dau")]
        public string thang_bat_dau { get; set; }

        [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
        [Column("so_thang_dong")]
        public int so_thang_dong { get; set; }

        [Column("phuong_an")]
        public string phuong_an { get; set; }

        [Column("loai_khai_bao")]
        public string loai_khai_bao { get; set; }

        [Column("ngay_bien_lai")]
        public DateTime? ngay_bien_lai { get; set; }

        [Column("so_bien_lai")]
        public string so_bien_lai { get; set; }

        [Column("quyen_bien_lai_id")]
        public int? quyen_bien_lai_id { get; set; }

        [Column("ghi_chu")]
        public string? ghi_chu { get; set; }

        [Column("nguoi_tao")]
        public string nguoi_tao { get; set; }

        [Column("ngay_tao")]
        public DateTime ngay_tao { get; set; }

        [Column("is_urgent")]
        public bool is_urgent { get; set; }

        [Column("trang_thai")]
        public string trang_thai { get; set; }

        [Column("ma_nhan_vien")]
        [Required(ErrorMessage = "Mã nhân viên không được để trống")]
        public string ma_nhan_vien { get; set; } = "";

        [Column("tinh_nkq")]
        public string? tinh_nkq { get; set; }

        [Column("huyen_nkq")]
        public string? huyen_nkq { get; set; }

        [Column("xa_nkq")]
        public string? xa_nkq { get; set; }

        [Column("ma_ho_so")]
        [StringLength(50)]
        public string? ma_ho_so { get; set; }

        [ForeignKey("thong_tin_the_id")]
        public virtual ThongTinThe? ThongTinThe { get; set; }

        [ForeignKey("dot_ke_khai_id")]
        public virtual DotKeKhai? DotKeKhai { get; set; }
    }
}
````

## File: WebApp.Server/Models/KeKhaiBHYT.cs
````csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using System.Text.Json.Serialization;

namespace WebApp.API.Models
{
    /// <summary>
    /// Model quản lý kê khai BHYT
    /// </summary>
    public class KeKhaiBHYT
    {
        /// <summary>
        /// ID kê khai BHYT
        /// </summary>
        [Key]
        [Column("id")]
        public int id { get; set; }

        /// <summary>
        /// ID đợt kê khai
        /// </summary>
        [Required]
        [Column("dot_ke_khai_id")]
        public int dot_ke_khai_id { get; set; }

        /// <summary>
        /// Navigation property cho đợt kê khai
        /// </summary>
        [JsonIgnore]
        [ForeignKey("dot_ke_khai_id")]
        public virtual DotKeKhai? DotKeKhai { get; set; }

        /// <summary>
        /// ID thông tin thẻ
        /// </summary>
        [Required]
        public int thong_tin_the_id { get; set; }

        /// <summary>
        /// Navigation property cho thông tin thẻ
        /// </summary>
        [ForeignKey("thong_tin_the_id")]
        public virtual ThongTinThe ThongTinThe { get; set; }

        /// <summary>
        /// Người thu
        /// </summary>
        [Required]
        [Range(1, int.MaxValue)]
        public int nguoi_thu { get; set; }

        /// <summary>
        /// Số tháng đóng
        /// </summary>
        [Required]
        [Range(1, int.MaxValue)]
        public int so_thang_dong { get; set; }

        /// <summary>
        /// Phương án đóng
        /// </summary>
        [Required]
        [StringLength(50)]
        public string? phuong_an_dong { get; set; }

        /// <summary>
        /// Hạn thẻ cũ
        /// </summary>
        public DateTime? han_the_cu { get; set; }

        /// <summary>
        /// Hạn thẻ mới từ
        /// </summary>
        [Required]
        public DateTime han_the_moi_tu { get; set; }

        /// <summary>
        /// Hạn thẻ mới đến
        /// </summary>
        [Required]
        public DateTime han_the_moi_den { get; set; }

        /// <summary>
        /// Tỉnh nhận quyết định
        /// </summary>
        [Required]
        [StringLength(20)]
        public string tinh_nkq { get; set; }

        /// <summary>
        /// Huyện nhận quyết định
        /// </summary>
        [Required]
        [StringLength(20)]
        public string huyen_nkq { get; set; }

        /// <summary>
        /// Xã nhận quyết định
        /// </summary>
        [Required]
        [StringLength(20)]
        public string xa_nkq { get; set; }

        /// <summary>
        /// Địa chỉ nhận quyết định
        /// </summary>
        [Required]
        [StringLength(200)]
        public string dia_chi_nkq { get; set; }

        /// <summary>
        /// Bệnh viện khám chữa bệnh (mã)
        /// </summary>
        [Required]
        [StringLength(200)]
        public string benh_vien_kcb { get; set; }

        /// <summary>
        /// Người tạo
        /// </summary>
        [Required]
        [StringLength(50)]
        public string nguoi_tao { get; set; }

        /// <summary>
        /// Ngày tạo
        /// </summary>
        public DateTime ngay_tao { get; set; }

        /// <summary>
        /// Ngày biên lai
        /// </summary>
        public DateTime? ngay_bien_lai { get; set; }

        /// <summary>
        /// Số tiền cần đóng
        /// </summary>
        [Column("so_tien_can_dong")]
        public decimal so_tien_can_dong { get; set; }

        /// <summary>
        /// Đánh dấu kê khai cần xử lý gấp
        /// </summary>
        [Column("is_urgent")]
        public bool is_urgent { get; set; }

        /// <summary>
        /// Trạng thái kê khai
        /// </summary>
        [Column("trang_thai")]
        [Required]
        [StringLength(50)]
        public string trang_thai { get; set; } = "chua_gui";

        /// <summary>
        /// Số biên lai
        /// </summary>
        [StringLength(20)]
        public string? so_bien_lai { get; set; }

        /// <summary>
        /// Mã số hồ sơ của đợt kê khai
        /// </summary>
        [StringLength(50)]
        public string? ma_ho_so { get; set; }

        public int? quyen_bien_lai_id { get; set; }

        [ForeignKey("quyen_bien_lai_id")]
        public virtual QuyenBienLai? QuyenBienLai { get; set; }

        // Navigation property cho BienLai
        [InverseProperty("KeKhaiBHYT")]
        public virtual BienLai? BienLai { get; set; }

        // Thêm constructor để khởi tạo các giá trị mặc định cho non-nullable properties
        public KeKhaiBHYT()
        {
            phuong_an_dong = "";
            tinh_nkq = "";
            huyen_nkq = "";
            xa_nkq = "";
            dia_chi_nkq = "";
            benh_vien_kcb = "";
            nguoi_tao = "";
            trang_thai = "chua_gui";
            ngay_tao = DateTime.Now;
            ThongTinThe = new ThongTinThe(); // Khởi tạo ThongTinThe
        }
    }
}
````

## File: WebApp.Server/Models/LoginModel.cs
````csharp
using System.ComponentModel.DataAnnotations;

namespace WebApp.API.Models
{
    public class LoginModel
    {
        [Required]
        public string Username { get; set; } = string.Empty;

        [Required]
        public string Password { get; set; } = string.Empty;

        public string Ip { get; set; } = string.Empty;
    }
}
````

## File: WebApp.Server/Models/NguoiDung.cs
````csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace WebApp.API.Models
{
    [Table("nguoi_dung")]
    public class NguoiDung
    {
        [Key]
        public int id { get; set; }

        [Required]
        [StringLength(50)]
        public string user_name { get; set; } = string.Empty;

        [Required]
        [StringLength(100)]
        public string ho_ten { get; set; } = string.Empty;

        [StringLength(200)]
        public string? don_vi_cong_tac { get; set; }

        [StringLength(100)]
        public string? chuc_danh { get; set; }

        [StringLength(100)]
        public string? email { get; set; }

        [StringLength(20)]
        public string? so_dien_thoai { get; set; }

        public bool is_super_admin { get; set; } = false;

        public int? type_mang_luoi { get; set; }

        public int? user_id { get; set; }

        public int status { get; set; } = 1;

        [StringLength(100)]
        public string? client_id { get; set; }

        public string[]? roles { get; set; }

        public DateTime? created_at { get; set; }

        public DateTime? updated_at { get; set; }

        [Required]
        [StringLength(100)]
        public string password { get; set; } = string.Empty;

        [StringLength(20)]
        public string? ma_nhan_vien { get; set; }
    }
}
````

## File: WebApp.Server/Models/PaymentBill.cs
````csharp
using System;

namespace WebApp.API.Models
{
    public class PaymentBill
    {
        public int id { get; set; }
        public int? batch_id { get; set; }
        public string file_url { get; set; }
        public string cloudinary_public_id { get; set; }
        public int? uploaded_by { get; set; }
        public DateTime uploaded_at { get; set; }
    }
}
````

## File: WebApp.Server/Models/QuyenBienLai.cs
````csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using WebApp.API.Models;

namespace WebApp.API.Models
{
    [Table("quyen_bien_lai")]
    public class QuyenBienLai
    {
        public QuyenBienLai()
        {
            quyen_so = string.Empty;
            tu_so = string.Empty;
            den_so = string.Empty;
            nguoi_cap = string.Empty;
            trang_thai = "chua_su_dung";
        }

        [Key]
        public int id { get; set; }

        [Required]
        [StringLength(20)]
        public string quyen_so { get; set; }

        [Required] 
        [StringLength(20)]
        public string tu_so { get; set; }

        [Required]
        [StringLength(20)] 
        public string den_so { get; set; }

        [Required]
        [Column("nhan_vien_thu")]
        public int nhan_vien_thu { get; set; }

        [ForeignKey("nhan_vien_thu")]
        public virtual NguoiDung? NguoiThu { get; set; }

        public DateTime ngay_cap { get; set; }

        [Required]
        [StringLength(50)]
        public string nguoi_cap { get; set; }

        [Required]
        [StringLength(20)]
        public string trang_thai { get; set; }

        [StringLength(20)]
        public string? so_hien_tai { get; set; }
    }
}
````

## File: WebApp.Server/Models/ThongTinThe.cs
````csharp
using System;
using System.ComponentModel.DataAnnotations;

namespace WebApp.API.Models
{
    public class ThongTinThe
    {
        [Key]
        public int id { get; set; }

        [Required]
        [StringLength(10)]
        public string ma_so_bhxh { get; set; }

        [Required]
        [StringLength(12)]
        public string cccd { get; set; }

        [Required]
        [StringLength(100)]
        public string ho_ten { get; set; }

        [Required]
        [StringLength(50)]
        public string ngay_sinh { get; set; }

        [Required]
        [StringLength(3)]
        public string gioi_tinh { get; set; }

        [StringLength(15)]
        public string so_dien_thoai { get; set; }

        [StringLength(10)]
        public string? ma_tinh_ks { get; set; }

        [StringLength(20)]
        public string ma_hgd { get; set; }

        [Required]
        [StringLength(50)]
        public string nguoi_tao { get; set; }

        public DateTime ngay_tao { get; set; }

        /// <summary>
        /// Mã huyện KS
        /// </summary>
        [StringLength(50)]
        public string? ma_huyen_ks { get; set; }

        /// <summary>
        /// Mã xã KS
        /// </summary>
        [StringLength(50)]
        public string? ma_xa_ks { get; set; }

        /// <summary>
        /// Mã tỉnh nơi khám, chữa bệnh
        /// </summary>
        [StringLength(50)]
        public string? ma_tinh_nkq { get; set; }

        /// <summary>
        /// Mã huyện nơi khám, chữa bệnh
        /// </summary>
        [StringLength(50)]
        public string? ma_huyen_nkq { get; set; }

        /// <summary>
        /// Mã xã nơi khám, chữa bệnh
        /// </summary>
        [StringLength(50)]
        public string? ma_xa_nkq { get; set; }

        /// <summary>
        /// Số thẻ BHYT
        /// </summary>
        [StringLength(15)]
        public string? so_the_bhyt { get; set; }

        /// <summary>
        /// Mã dân tộc
        /// </summary>
        [StringLength(50)]
        public string? ma_dan_toc { get; set; }

        /// <summary>
        /// Quốc tịch
        /// </summary>
        [Required]
        [StringLength(10)]
        [System.ComponentModel.DefaultValue("VN")]
        public string quoc_tich { get; set; } = "VN";

        /// <summary>
        /// Mã bệnh viện
        /// </summary>
        [StringLength(50)]
        public string? ma_benh_vien { get; set; }
    }
}
````

## File: WebApp.Server/Models/User.cs
````csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace WebApp.API.Models
{
    [Table("users")]
    public class User
    {
        [Key]
        public int id { get; set; }

        [Required]
        [StringLength(50)]
        public string username { get; set; } = string.Empty;

        [Required]
        [StringLength(100)]
        public string password { get; set; } = string.Empty;

        [StringLength(100)]
        public string? ho_ten { get; set; }

        [StringLength(100)]
        [EmailAddress]
        public string? email { get; set; }

        [StringLength(15)]
        public string? so_dien_thoai { get; set; }

        [StringLength(20)]
        public string? role { get; set; }

        [StringLength(50)]
        public string? department_code { get; set; }

        [StringLength(100)]
        public string? unit { get; set; }

        public int? unit_id { get; set; }

        [StringLength(20)]
        public string status { get; set; } = "active";

        public DateTime created_at { get; set; } = DateTime.UtcNow;

        public DateTime updated_at { get; set; } = DateTime.UtcNow;

        [StringLength(50)]
        public string? province { get; set; }

        [StringLength(50)]
        public string? district { get; set; }

        [StringLength(50)]
        public string? commune { get; set; }

        [StringLength(50)]
        public string? hamlet { get; set; }

        public string? address { get; set; }

        public DateTime? last_login_at { get; set; }

        public bool first_login { get; set; } = true;

        public bool password_changed { get; set; } = false;

        public DateTime? deleted_at { get; set; }

        [StringLength(45)]
        public string? last_login_ip { get; set; }

        public string? last_login_location { get; set; }
    }
}
````

## File: WebApp.Server/Program.cs
````csharp
using Microsoft.EntityFrameworkCore;
using WebApp.API.Data;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;
using System.Text;
using Npgsql;
using OfficeOpenXml;

AppContext.SetSwitch("Npgsql.EnableLegacyTimestampBehavior", true);

// Cấu hình giấy phép cho EPPlus
ExcelPackage.LicenseContext = LicenseContext.NonCommercial;

var builder = WebApplication.CreateBuilder(args);

// Thêm cấu hình JSON serialization cho Npgsql
NpgsqlConnection.GlobalTypeMapper.EnableDynamicJson();

// Add services to the container.
// Learn more about configuring OpenAPI at https://aka.ms/aspnet/openapi
builder.Services.AddControllers()
    .AddJsonOptions(options =>
    {
        options.JsonSerializerOptions.ReferenceHandler = System.Text.Json.Serialization.ReferenceHandler.IgnoreCycles;
    });
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddOpenApi();

// Configure JWT Authentication
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = builder.Configuration["Jwt:Issuer"],
            ValidAudience = builder.Configuration["Jwt:Audience"],
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"] ?? throw new InvalidOperationException("JWT Key not found in configuration"))
            )
        };
    });

// Configure CORS
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(builder =>
    {
        builder.AllowAnyOrigin()
               .AllowAnyMethod()
               .AllowAnyHeader();
    });
});

// Add DbContext
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseNpgsql(builder.Configuration.GetConnectionString("DefaultConnection")));

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.MapOpenApi();
}

// Thứ tự middleware QUAN TRỌNG
app.UseRouting();

app.UseCors();

app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

app.Run();

record WeatherForecast(DateOnly Date, int TemperatureC, string? Summary)
{
    public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);
}
````

## File: WebApp.Server/WebApp.API.csproj
````
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="EPPlus" Version="7.7.0" />
    <PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="9.0.1" />
    <PackageReference Include="Microsoft.AspNetCore.OpenApi" Version="9.0.1" />
    <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="8.0.2" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.2" />
    <PackageReference Include="BCrypt.Net-Next" Version="4.0.3" />
  </ItemGroup>

</Project>
````

## File: WebApp.Server/WebApp.API.http
````
@WebApp.API_HostAddress = http://localhost:5182

GET {{WebApp.API_HostAddress}}/weatherforecast/
Accept: application/json

###
````

## File: .gitignore
````
# See https://docs.github.com/get-started/getting-started-with-git/ignoring-files for more about ignoring files.

# Compiled output
/dist
/tmp
/out-tsc
/bazel-out

# Node
/node_modules
npm-debug.log
yarn-error.log

# IDEs and editors
.idea/
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace

# Visual Studio Code
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
.history/*

# Miscellaneous
/.angular/cache
.sass-cache/
/connect.lock
/coverage
/libpeerconnection.log
testem.log
/typings

# System files
.DS_Store
Thumbs.db

# Build output
bin/
obj/
*.dll
*.exe
*.pdb
*.cache
*.json

# Angular build output
/WebApp.Client/dist/
/WebApp.Client/.angular/cache/
/WebApp.Client/angular/cache/

# Angular generated files
*.js.map
*.js
!/WebApp.Client/src/**/*.js
!/WebApp.Client/src/**/*.js.map

# Angular cache & temp files
.angular/
.sass-cache/
connect.lock
coverage/
libpeerconnection.log
npm-debug.log
yarn-error.log
testem.log
typings/

# Dependencies
/WebApp.Client/node_modules/

# IDE files
.idea/
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace
.vscode/*
````

## File: .windsurfrules
````
- When user starts a new conversation:
  1. Read @long_term.md to get the context of the project.
  2. Generate a workflow name (under 10 words, snake case).
  3. Then, create file `memory_bank/wf_{workflow_name}`. The content must have the following sections:
   - Current tasks from user prompt.
   - Plan (simple): your plan & thoughts to solve task(s).
   - Steps: break your plan into small steps.
   - Things done
   - Things not done yet
- In a cycle of current conversation:
  1. Read current `memory_bank/wf_{workflow_name}` file. Don't be lazy, don't omit any content.
  2. Update plan and steps if needed, based on the current state.
  3. After you finish a task, update `Things done` and `Things not done yet` to track your work.
````

## File: build.bat
````
@echo off
chcp 65001 >nul

net session >nul 2>&1
if %errorlevel% neq 0 (
    echo Vui lòng chạy với quyền Administrator!
    pause
    exit /b
)

echo === git update ===
cd /d "%~dp0"
git fetch
git pull origin main

echo === Stop IIS ===
iisreset /stop

echo === Dang cai dat va chay du an ===

REM Kiem tra Node.js
where node >nul 2>nul
if %ERRORLEVEL% neq 0 (
    echo Node.js chua duoc cai dat. Vui long cai dat Node.js tu https://nodejs.org/
    pause
    exit /b 1
)

REM Kiem tra .NET SDK
where dotnet >nul 2>nul
if %ERRORLEVEL% neq 0 (
    echo .NET SDK chua duoc cai dat. Vui long cai dat .NET SDK tu https://dotnet.microsoft.com/download
    pause
    exit /b 1
)

echo === install library angular ===
cd WebApp.Client
call npm i
call npm i xlsx --save
call npm i pizzip --save
call npm i jszip --save
call npm i file-saver --save
call npm i docxtemplater --save
call npm i @types/file-saver --save-dev
call npm i @types/xlsx --save-dev

echo === Dang build du an angular ===
call ng build --configuration production

echo === Copy to folder IIS ===
for /d %%i in ("\\?\C:\inetpub\huyphucweb\*") do rd /s /q "%%i"
for %%i in ("\\?\C:\inetpub\huyphucweb\*") do if /I not "%%~nxi"=="web.config" del "%%i"

xcopy .\dist\webapp.client\*.* C:\inetpub\huyphucweb /E /I /Y

echo === Dang build du an .net ===
cd ..
cd WebApp.Server
dotnet build --configuration Release

echo === Copy to folder IIS ===
for /d %%i in ("\\?\C:\inetpub\huyphucapi\*") do rd /s /q "%%i"
for %%i in ("\\?\C:\inetpub\huyphucapi\*") do if /I not "%%~nxi"=="web.config" del "%%i"

xcopy .\bin\Release\net9.0\*.* C:\inetpub\huyphucapi /E /I /Y

echo === Start IIS ===
iisreset /start

echo build va deploy thanh cong

pause
````

## File: dot-ke-khai.md
````markdown
# Tài liệu tính năng: Quản lý đợt kê khai BHXH

## 1. Tổng quan

Module "Đợt kê khai" là một phần của hệ thống quản lý bảo hiểm xã hội, cho phép người dùng tạo, quản lý và theo dõi các đợt kê khai BHXH/BHYT. Module này cung cấp giao diện trực quan để quản lý toàn bộ quy trình từ tạo đợt kê khai, gửi đợt, thanh toán, đến hoàn thành.

## 2. Các tính năng chính

### 2.1. Quản lý danh sách đợt kê khai

- Hiển thị danh sách tất cả các đợt kê khai với thông tin chi tiết
- Lọc theo trạng thái: Tất cả, Chưa gửi, Chờ thanh toán, Hoàn thành, Từ chối
- Thống kê số liệu tổng quan:
  - Tổng số đợt kê khai
  - Số đợt hoàn thành
  - Số đợt từ chối
  - Tổng số tiền
- Chức năng tìm kiếm và lọc dữ liệu

### 2.2. Thêm mới đợt kê khai

- Tạo đợt kê khai mới với các thông tin cơ bản:
  - Đơn vị (bắt buộc)
  - Đại lý (bắt buộc)
  - Ghi chú
  - Mã hồ sơ
- Tự động sinh tên đợt kê khai theo định dạng: "Đợt {số_đợt} Tháng {tháng} năm {năm}"

### 2.3. Chỉnh sửa đợt kê khai

- Cập nhật thông tin đợt kê khai đã tạo
- Các trường có thể chỉnh sửa tùy thuộc vào trạng thái của đợt kê khai

### 2.4. Quy trình xử lý đợt kê khai

Đợt kê khai có các trạng thái sau:
- **Chưa gửi**: Trạng thái ban đầu khi tạo đợt kê khai
- **Đã gửi**: Sau khi gửi đợt kê khai
- **Đang xử lý**: Đợt kê khai đang được xử lý
- **Chờ thanh toán**: Đợt kê khai đã được duyệt và đang chờ thanh toán
- **Hoàn thành**: Đợt kê khai đã thanh toán và hoàn tất
- **Từ chối**: Đợt kê khai bị từ chối

### 2.5. Thanh toán đợt kê khai

- Tạo mã QR thanh toán liên kết với ngân hàng
- Hiển thị thông tin thanh toán:
  - Tên đợt kê khai
  - Ngân hàng (AGRIBANK)
  - Số tài khoản
  - Tên tài khoản
  - Số tiền
  - Nội dung chuyển khoản
- Tải mã QR để thanh toán
- Xác nhận thanh toán và upload hóa đơn/bill

### 2.6. Upload hóa đơn thanh toán

- Tải lên hình ảnh hóa đơn/bill sau khi thanh toán
- Hỗ trợ định dạng JPG, PNG
- Giới hạn dung lượng file (5MB)
- Lưu trữ hóa đơn trên Cloudinary
- Tự động cập nhật trạng thái đợt kê khai thành "đang xử lý"

### 2.7. Xem hóa đơn thanh toán

- Hiển thị hình ảnh hóa đơn đã upload
- Các tính năng thao tác với hình ảnh:
  - Phóng to/Thu nhỏ
  - Xoay trái/phải
  - Tải về

### 2.8. Xuất dữ liệu

- Xuất dữ liệu đợt kê khai ra file Excel
- Tải tất cả hóa đơn của các đợt kê khai đã chọn

## 3. Cấu trúc dữ liệu

### 3.1. Đợt kê khai (DotKeKhai)

- id: Mã đợt kê khai
- ten_dot: Tên đợt kê khai
- so_dot: Số đợt
- thang: Tháng
- nam: Năm
- ghi_chu: Ghi chú
- trang_thai: Trạng thái
- nguoi_tao: Người tạo
- don_vi_id: Mã đơn vị
- ma_ho_so: Mã hồ sơ
- dai_ly_id: Mã đại lý
- tong_so_the: Tổng số thẻ
- tong_so_tien: Tổng số tiền
- url_bill: URL hóa đơn
- DonVi: Thông tin đơn vị

### 3.2. Kê khai BHYT (KeKhaiBHYT)

- ho_ten: Họ tên
- cccd: Căn cước công dân
- ngay_sinh: Ngày sinh
- gioi_tinh: Giới tính
- dia_chi: Địa chỉ
- so_dien_thoai: Số điện thoại
- email: Email
- so_tien: Số tiền
- ghi_chu: Ghi chú
- so_the_bhyt: Số thẻ BHYT
- ma_so_bhxh: Mã số BHXH
- nguoi_thu: Người thu
- phuong_an_dong: Phương án đóng
- ngay_bien_lai: Ngày biên lai
- ma_tinh_nkq: Mã tỉnh nơi khai quê
- ma_huyen_nkq: Mã huyện nơi khai quê
- ma_xa_nkq: Mã xã nơi khai quê
- dia_chi_nkq: Địa chỉ nơi khai quê
- so_thang_dong: Số tháng đóng
- ma_benh_vien: Mã bệnh viện
- ma_hgd: Mã hộ gia đình
- quoc_tich: Quốc tịch
- ma_tinh_ks: Mã tỉnh khai sinh
- ma_huyen_ks: Mã huyện khai sinh
- ma_xa_ks: Mã xã khai sinh
- so_bien_lai: Số biên lai
- han_the_moi_tu: Hạn thẻ mới từ
- is_urgent: Khẩn cấp
- ma_nhan_vien: Mã nhân viên
- QuyenBienLai: Thông tin quyển biên lai

### 3.3. Quyển biên lai (QuyenBienLai)

- id: Mã quyển biên lai
- quyen_so: Quyển số
- tu_so: Từ số
- den_so: Đến số
- so_hien_tai: Số hiện tại
- nhan_vien_thu: Nhân viên thu
- nguoi_cap: Người cấp
- ngay_cap: Ngày cấp
- trang_thai: Trạng thái

## 4. Các thành phần giao diện

### 4.1. Giao diện chính (dot-ke-khai.component)

- Hiển thị thống kê số liệu
- Hiển thị danh sách đợt kê khai
- Bảng dữ liệu với các cột:
  - Tên đợt
  - Đơn vị
  - Dịch vụ
  - Tổng số thẻ
  - Tổng số tiền
  - Trạng thái
  - Ghi chú
  - Mã hồ sơ
  - Hóa đơn
  - Thao tác

### 4.2. Modal thêm mới/cập nhật đợt kê khai

- Form nhập liệu với các trường:
  - Đơn vị
  - Đại lý
  - Ghi chú
  - Mã hồ sơ

### 4.3. Modal thanh toán (thanh-toan-modal.component)

- Hiển thị mã QR thanh toán
- Thông tin thanh toán
- Nút tải mã QR
- Nút xác nhận thanh toán

### 4.4. Modal upload hóa đơn (upload-bill-modal.component)

- Vùng kéo thả file hoặc nút chọn file
- Danh sách file đã chọn
- Thông tin hướng dẫn upload

## 5. Quy trình sử dụng

1. **Tạo đợt kê khai mới**:
   - Nhấn nút "Thêm mới"
   - Điền thông tin đợt kê khai
   - Nhấn "Thêm mới" để lưu

2. **Gửi đợt kê khai**:
   - Từ danh sách, chọn đợt kê khai có trạng thái "Chưa gửi"
   - Nhấn nút "Gửi đợt kê khai" (biểu tượng gửi)

3. **Thanh toán đợt kê khai**:
   - Từ danh sách, chọn đợt kê khai có trạng thái "Chờ thanh toán"
   - Nhấn "Thanh toán"
   - Quét mã QR và thực hiện thanh toán qua ngân hàng
   - Nhấn "Xác nhận thanh toán"
   - Upload hóa đơn/bill

4. **Xuất dữ liệu**:
   - Từ danh sách, chọn đợt kê khai
   - Nhấn nút "Xuất Excel" (biểu tượng xuất)

5. **Tải hóa đơn**:
   - Chọn các đợt kê khai bằng checkbox
   - Nhấn nút "Tải tất cả hóa đơn"

## 6. Công nghệ sử dụng

- **Frontend**: Angular, ng-zorro-antd
- **Lưu trữ hình ảnh**: Cloudinary
- **Tạo mã QR thanh toán**: VietQR API
- **Xuất dữ liệu**: XLSX
- **Nén file**: JSZip, file-saver
````

## File: ke-khai-bhxh-flow.md
````markdown
# Tài liệu về luồng làm việc của chức năng kê khai BHXH

## Giới thiệu

Tài liệu này mô tả chi tiết luồng làm việc của chức năng kê khai bảo hiểm xã hội tự nguyện trong ứng dụng. Chức năng này cho phép người dùng tìm kiếm, xem, thêm mới, cập nhật và xóa thông tin kê khai BHXH của khách hàng.

## Cấu trúc thành phần

### Các file chính
- **ke-khai-bhxh.component.ts**: Xử lý logic và dữ liệu
- **ke-khai-bhxh.component.html**: Giao diện người dùng
- **ke-khai-bhxh.component.scss**: Định dạng CSS
- **ke-khai-bhxh.service.ts**: Gọi API liên quan đến kê khai BHXH
- **dot-ke-khai.service.ts**: Quản lý thông tin đợt kê khai
- **ssmv2.service.ts**: Xác thực và tương tác với API SSMV2

### Các service được sử dụng

1. **KeKhaiBHXHService**
   - Quản lý các thao tác CRUD với kê khai BHXH
   - Tìm kiếm thông tin BHXH từ hệ thống SSMV2
   - Cung cấp các phương thức gọi API

2. **DotKeKhaiService**
   - Quản lý các đợt kê khai
   - Cung cấp thông tin về các đợt kê khai

3. **DiaChiService**
   - Quản lý thông tin địa chỉ (tỉnh, huyện, xã)
   - Hỗ trợ tìm kiếm và chọn địa chỉ

4. **SSMV2Service**
   - Xác thực với hệ thống SSMV2
   - Quản lý token để truy cập API SSMV2

## Luồng làm việc chính

### 1. Khởi tạo component

```typescript
ngOnInit(): void {
  // Thêm CSS cho modal đăng nhập
  // Khởi tạo form
  this.initForm();
  // Lấy ID đợt kê khai từ route
  this.loadDanhMucTinh();
  // Thiết lập các sự kiện thay đổi giá trị form
  this.setupFormValueChanges();
}
```

### 2. Tìm kiếm thông tin BHXH

- Người dùng nhập mã số BHXH vào form
- Hệ thống gọi API thông qua KeKhaiBHXHService để tìm kiếm thông tin
- Nếu cần, hệ thống hiển thị modal đăng nhập vào SSMV2 và lấy captcha
- Sau khi đăng nhập thành công, hệ thống lấy thông tin BHXH và điền vào form

```typescript
searchBHXH(): void {
  // Kiểm tra mã số BHXH
  // Hiển thị loading
  // Gọi service tìm kiếm
  this.keKhaiBHXHService.searchBHXH(maSoBHXH).subscribe(
    (response) => {
      // Xử lý kết quả
      this.processSearchResult(response.data);
    },
    (error) => {
      // Kiểm tra nếu cần đăng nhập
      if (error.message === 'Unauthorized') {
        this.getCaptcha();
        this.isLoginVisible = true;
      } else {
        this.message.error(error.message || 'Có lỗi xảy ra khi tìm kiếm thông tin BHXH');
      }
    }
  );
}
```

### 3. Đăng nhập vào SSMV2 (nếu cần)

- Hiển thị modal đăng nhập với captcha
- Xác thực thông tin đăng nhập
- Lưu token và gọi lại API tìm kiếm

```typescript
handleLogin(): void {
  // Kiểm tra form
  // Hiển thị loading
  // Gọi API đăng nhập
  this.ssmv2Service.login(loginData).subscribe(
    (response) => {
      // Lưu token
      // Đóng modal
      // Tìm kiếm lại thông tin BHXH
      this.searchBHXH();
    },
    (error) => {
      // Xử lý lỗi
    }
  );
}
```

### 4. Tính toán số tiền phải đóng

- Dựa trên mức thu nhập, tỷ lệ đóng, và thông tin NSNN
- Cập nhật giá trị số tiền phải đóng trên form

```typescript
tinhSoTienPhaiDong(): void {
  // Lấy thông tin từ form
  // Tính toán số tiền phải đóng
  const soThangDong = this.form.get('phuong_thuc_dong')?.value;
  const mucThuNhap = this.form.get('muc_thu_nhap')?.value;
  const tyLeDong = this.form.get('ty_le_dong')?.value / 100;
  const tyLeNSNN = this.form.get('ty_le_nsnn')?.value / 100;
  
  // Tính toán số tiền
  let soTien = mucThuNhap * tyLeDong * soThangDong;
  const soTienHoTro = mucThuNhap * tyLeNSNN * soThangDong;
  soTien = soTien - soTienHoTro;
  
  // Cập nhật form
  this.form.patchValue({
    so_tien_can_dong: soTien
  });
}
```

### 5. Lưu thông tin kê khai

- Thu thập dữ liệu từ form
- Kiểm tra tính hợp lệ
- Gọi API lưu thông tin kê khai

```typescript
saveKeKhaiBHXH(): void {
  // Kiểm tra form
  // Thu thập dữ liệu
  // Kiểm tra trùng lặp
  this.checkDuplicateBHXH(this.form.get('ma_so_bhxh')?.value).subscribe(
    (isDuplicate) => {
      if (isDuplicate) {
        this.message.error('Mã số BHXH đã tồn tại trong đợt kê khai này!');
        return;
      }
      
      // Xử lý và gửi dữ liệu
      this.processKeKhaiBHXH();
    }
  );
}
```

### 6. Xử lý và gửi dữ liệu kê khai

```typescript
processKeKhaiBHXH(): void {
  // Hiển thị loading
  // Chuẩn bị dữ liệu
  const keKhaiBHXH = {
    // Thông tin cá nhân
    // Thông tin kê khai
    // Thông tin địa chỉ
  };
  
  // Gọi API lưu thông tin
  this.keKhaiBHXHService.create(this.dotKeKhaiId, keKhaiBHXH).subscribe(
    (response) => {
      // Hiển thị thông báo thành công
      // Làm mới form
    },
    (error) => {
      // Xử lý lỗi
    }
  );
}
```

### 7. Xóa dữ liệu kê khai

```typescript
deleteKeKhaiBHXH(id: number): void {
  // Hiển thị modal xác nhận
  this.modal.confirm({
    // Thông tin xác nhận
    onOk: () => {
      // Gọi API xóa
      this.keKhaiBHXHService.delete(this.dotKeKhaiId, id).subscribe(
        () => {
          // Hiển thị thông báo thành công
          // Cập nhật danh sách
        },
        (error) => {
          // Xử lý lỗi
        }
      );
    }
  });
}
```

## Các chức năng phụ trợ

### Quản lý địa chỉ
- Tải danh sách tỉnh/thành phố
- Cập nhật danh sách huyện/quận khi chọn tỉnh
- Cập nhật danh sách xã/phường khi chọn huyện

### Định dạng dữ liệu
- Định dạng tiền tệ
- Định dạng phần trăm
- Định dạng ngày tháng

### Kiểm tra dữ liệu
- Kiểm tra mã số BHXH
- Kiểm tra CCCD
- Kiểm tra trùng lặp

## Các lưu ý

1. Chức năng tìm kiếm BHXH yêu cầu xác thực với hệ thống SSMV2
2. Cần xử lý các tình huống mất kết nối hoặc lỗi xác thực
3. Dữ liệu địa chỉ được lưu cache để tối ưu hiệu năng
4. Các tính toán số tiền cần được thực hiện chính xác
5. Cần kiểm tra kỹ dữ liệu trước khi lưu

## Điểm cần cải thiện

1. Tối ưu hóa hiệu suất khi tải danh sách địa chỉ lớn
2. Cải thiện UX khi tìm kiếm và điền thông tin BHXH
3. Tăng cường xác thực dữ liệu nhập
4. Thêm tính năng xuất báo cáo
````

## File: setup-and-run.bat
````
@echo off
echo === Dang cai dat va chay du an ===

REM Kiem tra Node.js
where node >nul 2>nul
if %ERRORLEVEL% neq 0 (
    echo Node.js chua duoc cai dat. Vui long cai dat Node.js tu https://nodejs.org/
    pause
    exit /b 1
)

REM Kiem tra .NET SDK
where dotnet >nul 2>nul
if %ERRORLEVEL% neq 0 (
    echo .NET SDK chua duoc cai dat. Vui long cai dat .NET SDK tu https://dotnet.microsoft.com/download
    pause
    exit /b 1
)

echo === Dang cai dat cac goi npm ===
cd WebApp.Client
call npm install
call npm install xlsx --save
call npm install pizzip --save
call npm install file-saver --save
call npm install docxtemplater --save
call npm install @types/file-saver --save-dev
call npm install @types/xlsx --save-dev

echo === Dang khoi phuc cac goi NuGet ===
cd ..
dotnet restore WebApp.sln

echo === Dang build du an ===
dotnet build WebApp.sln

echo === Khoi dong API ===
start cmd /k "cd WebApp.Server && dotnet run"

echo === Cho API khoi dong (10 giay) ===
timeout /t 10 /nobreak

echo === Khoi dong ung dung Angular ===
cd WebApp.Client
start cmd /k "npm start"

echo === Da hoan tat! ===
echo Ung dung API dang chay tren http://localhost:5000
echo Ung dung Angular dang chay tren http://localhost:4200
pause
````

## File: WebApp.sln
````
Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.0.31903.59
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "WebApp.API", "WebApp.API\WebApp.API.csproj", "{DBF5ACA0-0104-4E25-9C39-01AADFBCE405}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{DBF5ACA0-0104-4E25-9C39-01AADFBCE405}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{DBF5ACA0-0104-4E25-9C39-01AADFBCE405}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{DBF5ACA0-0104-4E25-9C39-01AADFBCE405}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{DBF5ACA0-0104-4E25-9C39-01AADFBCE405}.Release|Any CPU.Build.0 = Release|Any CPU
	EndGlobalSection
EndGlobal
````
